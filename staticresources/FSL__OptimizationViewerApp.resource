"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}String.prototype.endsWith||(String.prototype.endsWith=function(e,t){var i=this.toString(),i=(("number"!=typeof t||!isFinite(t)||Math.floor(t)!==t||t>i.length)&&(t=i.length),t-=e.length,i.lastIndexOf(e,t));return-1!==i&&i===t}),!function(){var e=angular.module("serviceExpert",["uiGmapgoogle-maps","angularMoment","ui.bootstrap","chart.js","MstResolver"]);e.run(["amMoment",function(e){var t=userLocale;-1!=userLocale.indexOf("iw")&&(t=userLocale.replace("iw","he")),e.changeLocale(t)}]),e.config(["$sceDelegateProvider","$compileProvider","MstResolverProvider",function(e,t,i){var n=null,s=_.debounce(window.scheduler.updateView,100).bind(window.scheduler);window.updateViewDebounced=function(){n||0!==document.body.clientWidth?0!==document.body.clientWidth&&(n&&(clearInterval(n),n=null),s()):n=setInterval(window.updateViewDebounced,1e3)},debugMode||t.debugInfoEnabled(!1),i.setConfig({fslOperationRemoteAction:RemoteActions.getFslOperation,getAsyncApexJobRemoteAction:RemoteActions.getAsyncApexJob,apiVersion:"41.0",fieldNames:fieldNames.FslOperation,autoConnect:!1}),e.resourceUrlWhitelist(["self","https://**.force.com"])}])}(),angular.module("serviceExpert").controller("ctrlGantt",["$scope","$rootScope","$q","BundleService","BundleActions","sfdcService","servicesService","utils","calendarsService","userSettingsManager","resourceFilterHelper","monthlyViewHelperService","ResourcesAndTerritoriesService","TimePhasedDataService","StateService","CapacityLightboxService","ResourceSmallMenu","AbsencesService","SkillsService","DeltaService","AbsenceLightboxService","ResourceLightboxService","ServiceAppointmentLightboxService","kpiCalculationsService","ResourceCapacitiesService","ResourceCrewsService","SERVICE_STATUS","SERVICE_CATEGORY","GetSlotsService","bulkScheduleService","GeneralLightbox","StreamingClientResolverService","StreamingAPIService","RegisterService","OptimizationRequestsService","GanttPalettesService",function(g,s,N,v,f,a,S,y,G,i,r,B,c,d,b,H,V,l,n,o,u,U,m,p,z,j,w,W,q,Z,h,K,Y,e,T,L){var A="",I="",C={},k=!0,D=new dhtmlXMenuObject({parent:"contextZone_A",context:!0}),R=new dhtmlXMenuObject({parent:"contextZone_A",context:!0});function t(){g.currentViewOptions.numOfMonths<=2?(scheduler.matrix.LongView.x_unit="day",scheduler.matrix.LongView.x_length=7,scheduler.matrix.LongView.x_size=30*g.currentViewOptions.numOfMonths):(scheduler.matrix.LongView.x_unit="week",scheduler.matrix.LongView.x_size=Math.ceil(4.5*g.currentViewOptions.numOfMonths),scheduler.matrix.LongView.x_length=1)}D.setOverflowHeight(15),R.setOverflowHeight(15),g.selectedGanttServices={},g.resourceFilterHelper=r,g.StateService=b,g.resources=[],g.searchEmployee="",g.resourceFieldToSortyBy="Name",g.successfullyScheduled=0,g.currentSchedulingIndex=0,g.timelineName="",g.nowTimespans=[],g.selectedSkills={},g.pinnedStatusesSF=CustomSettings.pinnedStatusesSF.split(","),g.hasCustomPermission=y.hasCustomPermission,g.crewViewActive=!1,g.crewsFilter=y.crewsFilter,g.useResourceSkillFilter=useResourceSkillFilter,g.numberOfDaysInUtilizationView=14,g.skillsLogicOperator=i.GetUserSettingsProperty("Skills_Logic_Operator__c")||"and",g.locations=i.GetUserSettingsProperty("locations")||[],g.editPalette=y.hasCustomPermission("Gantt_Palettes_Edit"),g.viewPalette=y.hasCustomPermission("Gantt_Palettes_View"),scheduler.attachEvent("onTemplatesReady",function(){scheduler.matrix.MonthlyView&&(scheduler.matrix.MonthlyView.x_size=i.GetUserSettingsProperty("DaysInUtilizationView__c")||14,g.numberOfDaysInUtilizationView=scheduler.matrix.MonthlyView.x_size),t()}),__gantt.ignoreReadonlyGantt226||window.customPermissions.Enable_Gantt_Locker?g.ganttLocked=i.GetUserSettingsProperty("Lock_Gantt__c")||!1:(g.ganttLocked=!0,scheduler.config.readonly=!0),scheduler.config.readonly=g.ganttLocked,g.currentViewOptions={highlightWeekeneds:i.GetUserSettingsProperty("Highlight_Weekeneds__c")||!1,minServiceDuration:void 0===i.GetUserSettingsProperty("Longterm_Min_Service_Duration__c")?8:i.GetUserSettingsProperty("Longterm_Min_Service_Duration__c"),minNaDuration:void 0===i.GetUserSettingsProperty("Longterm_Min_Absence_Duration__c")?8:i.GetUserSettingsProperty("Longterm_Min_Absence_Duration__c"),numOfMonths:i.GetUserSettingsProperty("Longterm_Num_Of_Months__c")||1,showMdt:i.GetUserSettingsProperty("Show_Only_MDT_In_Longterm__c")||!1},window.__currentViewOptions=g.currentViewOptions,g.saveMdtFilterSa=_.debounce(function(){i.SetUserSettingsProperty("Show_Only_MDT_In_Longterm__c",g.currentViewOptions.showMdt),"LongView"===scheduler._mode&&scheduler.setCurrentView(),"LongView"===scheduler._mode&&g.getTimePhasedObjects()},400),g.saveHighlightWeekends=_.debounce(function(){i.SetUserSettingsProperty("Highlight_Weekeneds__c",g.currentViewOptions.highlightWeekeneds),updateViewDebounced()},400),g.saveMinimumLongtermServiceDuration=_.debounce(function(){i.SetUserSettingsProperty("Longterm_Min_Service_Duration__c",g.currentViewOptions.minServiceDuration),"LongView"===scheduler._mode&&scheduler.setCurrentView(),"LongView"===scheduler._mode&&g.getTimePhasedObjects()},400),g.saveMinimumLongtermAbsenceDuration=_.debounce(function(){i.SetUserSettingsProperty("Longterm_Min_Absence_Duration__c",g.currentViewOptions.minNaDuration),"LongView"===scheduler._mode&&scheduler.setCurrentView(),"LongView"===scheduler._mode&&g.getTimePhasedObjects()},400),g.handleLongTermViewSizeChange=_.debounce(function(){var e=i.GetUserSettingsProperty("Longterm_Num_Of_Months__c");g.currentViewOptions.numOfMonths||(g.currentViewOptions.numOfMonths=1),i.SetUserSettingsProperty("Longterm_Num_Of_Months__c",g.currentViewOptions.numOfMonths),t(),"LongView"===scheduler._mode&&scheduler.setCurrentView(),e<g.currentViewOptions.numOfMonths&&g.getTimePhasedObjects()},200),g.shouldShowSkill=function(e,t){return e.toUpperCase().includes(t.toUpperCase())},g.saveUserPropSkillsLogic=function(){i.SetUserSettingsProperty("Skills_Logic_Operator__c",g.skillsLogicOperator)},g.paletteViewActive=!1,g.showPaletteView=function(){window.paletteViewActive=!0,g.paletteViewActive=!0,updateViewDebounced()},g.hidePaletteView=function(){window.paletteViewActive=!1,g.paletteViewActive=!1,updateViewDebounced()},g.$watch("StateService.isLoadingNewLocations",function(e,t){void 0!==t&&!1!==t||1!=e||(g.paletteViewActive=!1)}),s.statusTranslations=y.statusTranslations,s.$on("moveToCrewView",function(){s.crewViewActive=!0,g.crewViewActive=!0,d.isCrewViewActive=!0}),g.$watch("resourceFilterHelper",function(e,t){$("#resourceExplainCrap").html(g.resourceFilterHelper.generateFilterExplanation(g.resourceFilters.showWorkingResource)),angular.equals(e,t)||i.SetUserSettingsProperty("Resource_Filter__c",JSON.stringify({sortBy:g.resourceFilterHelper.resourceFieldToSortyBy,asc:g.resourceFilterHelper.descending,showWorkingResource:g.resourceFilters.showWorkingResource,booleanFields:g.resourceFilterHelper.selectionInfo.resourceFilteringOptions,picklistField:g.resourceFilterHelper.selectionInfo.selectedPicklist,picklistOptions:g.resourceFilterHelper.selectionInfo.picklistOptions,picklistOptionsModel:g.resourceFilterHelper.selectionInfo.picklistOptionsModel,picklistNullValues:g.resourceFilterHelper.selectionInfo.picklistNullValues,crewsOption:g.resourceFilterHelper.selectionInfo.crewsSelectionOptions.selectedPicklist}))},!0),g.absencesTypeLoaded=!1,g.defaultDragNa={selectedNaDuration:JSON.parse(i.GetUserSettingsProperty("Drag_Na_Duration__c"))||60,selectedNaType:i.GetUserSettingsProperty("Drag_Na_Type__c"),selectedNaLabel:i.GetUserSettingsProperty("Drag_Na_Label__c")},g.getEmployeeAbsenceTypes=function(){g.absencesTypeLoaded||l.getEmployeeAbsenceTypes().then(function(e){g.absencesTypeLoaded=!0,g.nonAvailabilityTypes=e,g.defaultDragNa.selectedNaType=i.GetUserSettingsProperty("Drag_Na_Type__c")||g.nonAvailabilityTypes[Object.keys(g.nonAvailabilityTypes)[0]]})},g.businessHoursRange={start:y.ganttSettings.startHour,end:y.ganttSettings.finishHour,includeWeekends:i.GetUserSettingsProperty("Include_Weekends__c")},g.resourceFilters={showWorkingResource:!!JSON.parse(i.GetUserSettingsProperty("Resource_Filter__c"))&&JSON.parse(i.GetUserSettingsProperty("Resource_Filter__c")).showWorkingResource,resourcesWorkingInRange:{}},g.isInConsole=b.isInConsole,g.openConsoleTab=y.openConsoleTab,g.capacityFields=B.capacityCalculationFields,Object.defineProperty(g.selectedGanttServices,"getSelected",{enumrable:!1,value:function(){var e,t=[];for(e in this)this[e]&&t.push(e);return t}}),g.isGanttFilterApplied=function(){return y.crewsFilter||g.skillsFilter||r.isResourceFilterApplied()||g.resourceFilters.showWorkingResource},cachedDomElements.timesDragFix||(cachedDomElements.timesDragFix=$("#timesDragFix"));var O=!0;function J(){var e;O?O=!1:(setHoursToDisplay(g.businessHoursRange.start,g.businessHoursRange.end,g.businessHoursRange.includeWeekends),scheduler.setCurrentView(),y.ganttSettings.startHour=g.businessHoursRange.start,y.ganttSettings.finishHour=g.businessHoursRange.end,(e={}).Gantt_View_Start_Hour__c=y.ganttSettings.startHour,e.Gantt_View_Finish_Hour__c=y.ganttSettings.finishHour,e.Include_Weekends__c=g.businessHoursRange.includeWeekends,i.SetUserSettingProperties(e))}function F(e,t){null!==(t=""===t?prompt(customLabels.msg_to_post_to_chatter,""):t)&&(""===t?alert(customLabels.no_empty_msg_to_chatter):(1===e.length&&(S.recentlyUsed[e[0]]=!0),S.postToChatter(e,t).then(function(e){})))}g.$watchCollection("businessHoursRange",J),c.promises.resources().then(function(){g.resources=c.getResources}),g.saveDragNaDefaults=function(e){switch(e){case"duration":i.SetUserSettingsProperty("Drag_Na_Duration__c",g.defaultDragNa.selectedNaDuration);break;case"type":i.SetUserSettingsProperty("Drag_Na_Type__c",g.defaultDragNa.selectedNaType);break;case"label":i.SetUserSettingsProperty("Drag_Na_Label__c",g.defaultDragNa.selectedNaLabel)}},g.getTimePhasedObjects=function(e){var t=scheduler.getState().min_date,i=scheduler.getState().max_date,n=864e5;return"LongView"===scheduler._mode&&(n*=scheduler.matrix.LongView.x_length),"left"===e?(t.setTime(t.getTime()-n),i.setTime(i.getTime()-n)):"right"===e&&(t.setTime(t.getTime()+n),i.setTime(i.getTime()+n)),d.getTimePhasedObjects(t,i).then(function(e){var t;s.$broadcast("ganttFinishedLoadingServices"),updateViewDebounced(),k&&("Always"!==window.__gantt.checkRulesMode&&p.calculateKpis(),k=!1,updateViewDebounced(),t=null,-1<document.URL.indexOf("service=")&&(t=document.URL.substr(document.URL.indexOf("service=")+8,18)),scheduler._events[t]?(scheduler._select_id=t,scheduler.select(t),setTimeout(function(){y.showOnGantt(t)},0)):t&&alert(customLabels.cant_display_service))})},g.changeDatesByArrows=function(e){updateViewDebounced(),g.getTimePhasedObjects(e)},scheduler.attachEvent("onDblClick",function(e,t){y.safeApply(g,function(){"service"===scheduler.getEvent(e).type?(S.recentlyUsed[e]=!0,m.open(e)):("contractorcapacity"===scheduler.getEvent(e).type?H:u).open(e)})}),scheduler.attachEvent("onBeforeFolderToggle",function(e,t){return folderJustToggled=!0,y.safeApply(g,function(){b.ganttOpenedTerritories[e.key]=t,X()}),!0});var X=_.debounce(function(){i.SetUserSettingsProperty("Toggled_Territories__c",JSON.stringify(b.ganttOpenedTerritories))},800);function M(){for(var e in g.selectedGanttServices)delete g.selectedGanttServices[e]}scheduler.attachEvent("onBeforeViewChange",function(e,t,i,n){return"MonthlyView"===e&&"MonthlyView"!==i&&"__Utilization__"===r.resourceFieldToSortyBy&&(r.resourceFieldToSortyBy="Name"),!0}),scheduler.attachEvent("onViewChange",function(e,t){removeAllHolidayPopovers(),y.safeApply(g,function(){switch(scheduler._mode){case"ZoomLevel2":g.timelineName=customLabels.In_Day;break;case"ZoomLevel3":g.timelineName=customLabels.Daily;break;case"ZoomLevel4":g.timelineName=customLabels.X2_Days;break;case"ZoomLevel5":g.timelineName=customLabels.X3_Days;break;case"ZoomLevel6":g.timelineName=customLabels.Weekly;break;case"ZoomLevel7":g.timelineName=customLabels.TwoWeeks;break;case"MonthlyView":g.timelineName=customLabels.Utilization;break;case"MTDView":g.timelineName=customLabels.MDTVIEW;break;case"LongView":g.timelineName=customLabels.LongView}$("#MonthlyLocationViewTooltip").remove(),E(),updateViewDebounced(),scheduler._old.mode===e&&scheduler._old.date===t||p.calculateKpis()})}),scheduler.attachEvent("onBeforeDrag",function(e,t,i){if(!e||!scheduler._events[e].isDummy&&!window.__lockedServicesIds[e]){var n=void 0,i=i.ctrlKey||i.metaKey;if(!e||"create"===t){if(!i)for(n in g.selectedGanttServices)g.selectedGanttServices[n]=!1,scheduler.getRenderedEvent(n)&&scheduler.updateEvent(n);return!1}if(e&&"service"===scheduler.getEvent(e).type){if(i)return R.hide(),g.selectedGanttServices[e]?g.selectedGanttServices[e]=!1:g.selectedGanttServices[e]=!0,scheduler.updateEvent(e),!1;for(n in g.selectedGanttServices[e]=!0,g.selectedGanttServices)n!==e&&(g.selectedGanttServices[n]=!1,scheduler.getEvent(n)&&scheduler.getSection(scheduler.getEvent(n).resourceId)&&scheduler.updateEvent(n))}else if(!i&&1<=g.selectedGanttServices.getSelected().length)for(n in g.selectedGanttServices)g.selectedGanttServices[n]=!1,scheduler.getRenderedEvent(n)&&scheduler.updateEvent(n);if((window.__gantt.ignoreReadonlyGantt226||window.customPermissions.Enable_Drag_And_Drop||!scheduler._events[e])&&!("service"!==scheduler.getEvent(e).type&&"na"!==scheduler.getEvent(e).type||e&&"service"===scheduler.getEvent(e).type&&scheduler.getEvent(e).pinned&&preventUpdateOfPinned))return!0}}),g.$watchCollection("selectedGanttServices",function(e,t){globalSelectedGanttServices=g.selectedGanttServices}),g.jumpToDate=function(){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"JumpToDate",date:scheduler._date,navigation:!0,handler:function(e,t){scheduler.setCurrentView(e),scheduler.destroyCalendar(),g.changeDatesByArrows()}})};var P=new dhtmlXMenuObject({parent:"contextZone_A",context:!0});P.setOverflowHeight(15),P.addNewChild(P.topId,0,"details",y.getSVGIconHTML(lsdIcons.info)+customLabels.Details,!1),P.attachEvent("onClick",function(e,t,i){switch(e){case"details":y.safeApply(g,function(){u.open(I)});break;case"delete":y.safeApply(g,function(){confirm(customLabels.naDeleteConfirm)&&l.deleteAbsence(I).then(function(e){e?scheduler.deleteEvent(I):alert(customLabels.Failed_To_Delete_Break)})});break;default:if(0===e.indexOf("custom_")){var n=scheduler._events[I].type,s=parseInt(e.split("_")[1]),r=y.getCustomActions(n)[s];if(r.visualforce){var s=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),o=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear();h.open(r.name,r.visualforce+"?id="+I+"&type="+n+"&start="+s+"&end="+o);break}a.callRemoteAction(RemoteActions.runCustomAbsenceAction,r.className,I,n,scheduler._min_date,scheduler._max_date).then(function(e){e&&y.addNotification(r.name,e,null,null)}).catch(function(e){return y.addNotification(r.name,e.message,null,null)});break}}}),D.addNewChild(D.topId,0,"details",y.getSVGIconHTML(lsdIcons.info)+customLabels.Details,!1),D.addNewChild(D.topId,3,"reschedule",y.getSVGIconHTML(lsdIcons.calendar)+customLabels.Reschedule,!1),window.customPermissions.Enable_Check_Rules&&D.addNewChild(D.topId,12,"validate",y.getSVGIconHTML(lsdIcons.violation)+customLabels.check_rules_action_label,!1),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Get_Candidates||window.__gantt.ignoreReadonlyGantt226)&&D.addNewChild(D.topId,4,"candidates",y.getSVGIconHTML(lsdIcons.candidates)+customLabels.Get_Candidates,!1),D.addNewChild(D.topId,10,"reshuffle",y.getSVGIconHTML(lsdIcons.retweet)+customLabels.Reshuffle,!1),D.addNewChild(D.topId,11,"groupNearby",y.getSVGIconHTML(lsdIcons.groupNearby)+customLabels.GroupNearby,!1),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Change_Status||window.__gantt.ignoreReadonlyGantt226)&&D.addNewChild(D.topId,5,"status",y.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1),D.addNewChild(D.topId,6,"map",y.getSVGIconHTML(lsdIcons.world)+customLabels.Map,!1),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Unschedule||window.__gantt.ignoreReadonlyGantt226)&&D.addNewChild(D.topId,8,"unschedule",y.getSVGIconHTML(lsdIcons.na)+customLabels.Unschedule,!1),fieldTrackingEnabled.service&&(D.addNewChild(D.topId,7,"chatter",y.getSVGIconHTML(lsdIcons.chat)+customLabels.Chatter+"<i id='chatterArrowContext' class='fa fa-caret-right chatter-carret'></i>",!1),D.addNewChild("chatter",0,"chatter_welldone",y.getSVGIconHTML(lsdIcons.like)+customLabels.well_done,!1),D.addNewChild("chatter",1,"chatter_hurryup",y.getSVGIconHTML(lsdIcons.hurry)+customLabels.Hurry_up,!1),D.addNewChild("chatter",2,"chatter_requestupdate",y.getSVGIconHTML(lsdIcons.help)+customLabels.Request_update,!1),D.addNewChild("chatter",3,"chatter_custom",y.getSVGIconHTML(lsdIcons.threedots)+customLabels.Custom_message,!1)),y.customActionsPromise.then(function(){y.getCustomActions("gantt").forEach(function(e,t){e.icon?D.addNewChild(D.topId,12+t,"custom_"+t,y.getSVGIconHTML(e.icon)+e.name.encodeHTML(),!1):D.addNewChild(D.topId,12+t,"custom_"+t,e.name.encodeHTML(),!1)})}),v.isActive()&&y.hasCustomPermission("Bundle_Unbundle")&&(D.addNewChild(D.topId,41,"bundler",y.getSVGIconHTML(f.Bundle.icon)+f.Bundle.label,!1),D.addNewChild(D.topId,42,"unbundler",y.getSVGIconHTML(f.Unbundle.icon)+f.Unbundle.label,!1));var x={};function Q(e){for(var t in g.selectedGanttServices)g.selectedGanttServices[t]&&(S.flagged[t]=e);updateViewDebounced()}function ee(e){var e=0<arguments.length&&void 0!==e?e:1,t=Math.abs(scheduler._max_date.getTime()-scheduler._min_date.getTime()),t=Math.ceil(t/864e5)*e,e=new Date(scheduler._min_date);e.setDate(e.getDate()+t),scheduler.setCurrentView(e,scheduler._mode)}function E(){if(scheduler._is_initialized()&&g.datalessMethods){for(var e=0;e<g.nowTimespans.length;e++)scheduler.deleteMarkedTimespan(g.nowTimespans[e]);g.nowTimespans.length=0;for(var t=scheduler.serverList("resources"),i=getMinAndMaxHoursToDisplay(),n=0;n<t.length;n++){var s=new Date,s=new Date(s.valueOf()+6e4*s.getTimezoneOffset());if(useLocationTimezone?s.setMinutes(s.getMinutes()+y.getLocationOffset(s,t[n].key)):s=y.convertDateBetweenTimeZones(s,"GMT",userTimeZone),i.min<=s.getHours()&&s.getHours()<i.max&&!g.datalessMethods.isDateInsideWeekend(s)&&"MonthlyView"!==scheduler._mode){var r={};r[scheduler.getState().mode]=[];for(var o=0;o<t[n].children.length;o++)r[scheduler.getState().mode].push(t[n].children[o].key);g.nowTimespans.push(scheduler.addMarkedTimespan({start_date:s,end_date:scheduler.date.add(s,1,"minute"),css:"dhx_now_time dhx_matrix_now_time",sections:r}))}}}}scheduler.attachEvent("onContextMenu",function(e,t){if(scheduler.config.readonly)return!0;if(e&&"service"!==scheduler.getEvent(e).type&&"break"!==scheduler.getEvent(e).type&&"na"!==scheduler.getEvent(e).type)return!1;var i;if(v.isActive()&&(n=g.selectedGanttServices.getSelected(),i=[],n.map(function(e){i.push(scheduler._events[e])}),y.hasCustomPermission("Bulk_Bundle")&&(R.hideItem("bundler"),f.Bundle.canInvoke(i)&&R.showItem("bundler")),y.hasCustomPermission("Bulk_Unundle")&&(R.hideItem("unbundler"),f.Unbundle.canInvoke(i)&&R.showItem("unbundler"))),e){D.hide(),R.hide(),P.hide(),scheduler.dhtmlXTooltip.hide();var n=0,s=0;if(t.pageX||t.pageY?(n=t.pageX,s=t.pageY):(t.clientX||t.clientY)&&(n=t.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,s=t.clientY+document.body.scrollTop+document.documentElement.scrollTop),g.selectedGanttServices.getSelected().length<2){if("break"===scheduler._events[e].type)return P.removeItem("delete"),y.getCustomActions("na").forEach(function(e,t){P.removeItem("custom_"+t)}),y.getCustomActions("break").forEach(function(e,t){P.removeItem("custom_"+t)}),y.getCustomActions("break").forEach(function(e,t){P.addNewChild(D.topId,t+10,"custom_"+t,y.getSVGIconHTML(e.icon)+e.name.encodeHTML(),!1)}),P.showContextMenu(n,s),I=e,!1;if("na"===scheduler._events[e].type)return P.removeItem("delete"),P.addNewChild(P.topId,1,"delete",y.getSVGIconHTML(lsdIcons.delete)+customLabels.Delete,!1),y.getCustomActions("na").forEach(function(e,t){P.removeItem("custom_"+t)}),y.getCustomActions("break").forEach(function(e,t){P.removeItem("custom_"+t)}),y.getCustomActions("na").forEach(function(e,t){P.addNewChild(D.topId,12+t,"custom_"+t,y.getSVGIconHTML(e.icon)+e.name.encodeHTML(),!1)}),P.showContextMenu(n,s),I=e,!1;for(var r=e,o=!1,a=0;a<g.pinnedStatusesSF.length;a++)scheduler._events[r].status===g.pinnedStatusesSF[a]&&(o=!0);if(v.isActive()&&y.hasCustomPermission("Bundle_Unbundle")&&(f.Bundle.canInvoke([scheduler._events[r]])?D.showItem("bundler"):D.hideItem("bundler"),f.Unbundle.canInvoke([scheduler._events[r]])?D.showItem("unbundler"):D.hideItem("unbundler")),scheduler._events[r].pinned||o?(D.hideItem("reschedule"),D.hideItem("candidates"),D.hideItem("unschedule"),D.hideItem("status"),D.hideItem("reshuffle"),D.hideItem("groupNearby")):(D.showItem("reschedule"),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Get_Candidates||window.__gantt.ignoreReadonlyGantt226)&&D.showItem("candidates"),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Unschedule||window.__gantt.ignoreReadonlyGantt226)&&D.showItem("unschedule"),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Change_Status||window.__gantt.ignoreReadonlyGantt226)&&D.showItem("status"),D.showItem("reshuffle"),D.showItem("groupNearby")),scheduler._events[r].pinned?D.hideItem("status"):(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Change_Status||window.__gantt.ignoreReadonlyGantt226)&&D.showItem("status"),scheduler._events[r].latitude&&scheduler._events[r].longitude&&y.hasCustomPermission("Group_Nearby")?D.showItem("groupNearby"):D.hideItem("groupNearby"),y.hasCustomPermission("Schedule")?scheduler._events[r].relatedService1&&scheduler._events[r].isImmidietlyFollow?(D.hideItem("reschedule"),D.hideItem("candidates")):scheduler._events[r].isImmidietlyFollow||D.showItem("reschedule"):D.hideItem("reschedule"),y.hasCustomPermission("Reshuffle")?D.showItem("reshuffle"):D.hideItem("reshuffle"),D.removeItem("showRelated"),(scheduler._events[r].isServiceInChain||scheduler._events[r].relatedTo||scheduler._events[r].relatedFather)&&D.addNewChild(D.topId,5,"showRelated",y.getSVGIconHTML(lsdIcons.related)+customLabels.Show_related,!1),b.isMapEnabled()&&null!==scheduler._events[r].latitude?D.showItem("map"):D.hideItem("map"),D.removeItem("flag"),S.flagged[r]?D.addNewChild(D.topId,1,"flag","<span class='emptyFlag'>"+y.getSVGIconHTML(lsdIcons.flag)+"</span> "+customLabels.Unflag,!1):D.addNewChild(D.topId,1,"flag","<span class='fullFlag'>"+y.getSVGIconHTML(lsdIcons.flag)+"</span> "+customLabels.Flag,!1),D.removeItem("pin"),scheduler._events[r].pinned?(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Pin_Service||window.__gantt.ignoreReadonlyGantt226)&&D.addNewChild(D.topId,9,"pin","<span class='emptyFlag'>"+y.getSVGIconHTML(lsdIcons.unpin)+"</span> "+customLabels.Unpin,!1):(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Pin_Service||window.__gantt.ignoreReadonlyGantt226)&&D.addNewChild(D.topId,9,"pin","<span class='fullFlag'>"+y.getSVGIconHTML(lsdIcons.pin)+"</span> "+customLabels.Pin,!1),D.removeItem("consoleTab"),g.isInConsole()&&D.addNewChild(D.topId,1,"consoleTab",y.getSVGIconHTML(lsdIcons.external)+customLabels.Open_Tab,!1),!scheduler.getEvent(e).pinned){var l=scheduler.getEvent(e).status,c=void 0,d=0;if(_.isEmpty(y.statusFlow)){if(D.removeItem("status"),!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Change_Status||window.__gantt.ignoreReadonlyGantt226)for(var u in D.addNewChild(D.topId,5,"status",y.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1),y.statuses)c="ContextMenu_"+y.statusTranslations[y.statuses[u]].split(" ").join(""),D.addNewChild("status",d,"status_change_"+d,"<span class='StatusColorChanger "+c+" "+y.getCSSClassForContext(y.statuses[u],w)+"'></span>"+y.statusTranslations[y.statuses[u]],!1),x["status_change_"+d++]=y.statuses[u]}else if(y.statusFlow[l]&&0<y.statusFlow[l].length)for(D.removeItem("status"),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Change_Status||window.__gantt.ignoreReadonlyGantt226)&&D.addNewChild(D.topId,5,"status",y.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1),x={},d=0;d<y.statusFlow[l].length;d++)c="ContextMenu_"+y.statusFlow[l][d].split(" ").join(""),D.addNewChild("status",d,"status_change_"+d,"<span class='StatusColorChanger "+c+" "+y.getCSSClassForContext(y.statusFlow[l][d],w)+"'></span>"+y.statusTranslations[y.statusFlow[l][d]],!1),x["status_change_"+d]=y.statusFlow[l][d];else D.removeItem("status")}return D.showContextMenu(n,s),A=e,!1}if(R.removeItem("selectedNumber"),R.addNewChild(R.topId,0,"selectedNumber","<i class='fa fa-check-square-o'></i> "+customLabels.x_services_selected.replaceAll(g.selectedGanttServices.getSelected().length),!0),R.removeItem("status"),!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Change_Status||window.__gantt.ignoreReadonlyGantt226){R.addNewChild(R.topId,4,"status",y.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1),x={};var m,p=0;for(m in y.statuses){var h="ContextMenu_"+y.statusTranslations[y.statuses[m]].split(" ").join("");R.addNewChild("status",p,"status_change_"+p,"<span class='StatusColorChanger "+h+" "+y.getCSSClassForContext(y.statusTranslations[y.statuses[m]],w)+"'></span>"+y.statusTranslations[y.statuses[m]],!1),x["status_change_"+p++]=y.statuses[m]}}return R.showContextMenu(n,s),!1}return!(I=A="")}),D.attachEvent("onShow",function(e){contextShown=!0}),D.attachEvent("onHide",function(e){contextShown=!1}),P.attachEvent("onShow",function(e){contextShown=!0}),P.attachEvent("onHide",function(e){contextShown=!1}),D.attachEvent("onClick",function(s,e,t){g.$evalAsync(function(){switch(s){case"bundler":f.Bundle.invoke([scheduler._events[A]],b.selectedPolicyId).then(function(e){M()},function(e){});break;case"unbundler":f.Unbundle.invoke([scheduler._events[A]],b.selectedPolicyId).then(function(){M()},function(){M()});break;case"details":y.safeApply(g,function(){m.open(A)});break;case"consoleTab":g.openConsoleTab(null,A);break;case"flag":g.$evalAsync(function(){S.flagged[A]=!S.flagged[A],scheduler.updateEvent(A)});break;case"pin":S.changePin([scheduler._events[A].id],!scheduler._events[A].pinned).then(function(){return updateViewDebounced()});break;case"reschedule":g.$evalAsync(function(){S.autoScheduleService(A).then(function(e){0===e.services.length&&alert(customLabels.NoCandidates),S.drawServicesAndAbsences(e.services,e.absences)}).catch(function(e){var t=d.serviceAppointments()[A].name;y.addNotification(t+" - "+customLabels.Action_Could_Not_Be_Performed,e.message,function(){m.open(A)})})});break;case"reshuffle":g.$evalAsync(function(){a.callRemoteAction(RemoteActions.runReshuffle,A,b.selectedPolicyId).then(function(e){o.updateOptimizationRequest(e)},function(e){y.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message)})});break;case"groupNearby":g.$evalAsync(function(){a.callRemoteAction(RemoteActions.runGroupNearby,A,b.selectedPolicyId).then(function(e){o.updateOptimizationRequest(e)},function(e){y.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message)})});break;case"candidates":q.get(A);break;case"chatter_welldone":F([A],customLabels.Well_done_mate);break;case"chatter_hurryup":F([A],customLabels.hurry_up_with_this_service);break;case"chatter_requestupdate":F([A],customLabels.please_update_service);break;case"chatter_custom":F([A],"");break;case"unschedule":g.$evalAsync(function(){ie([A])});break;case"map":g.showOnMap(A);break;case"showRelated":if(usingNewMstModel||scheduler._events[A].isServiceInChain)return void h.open(customLabels.ComplexRelatedServicesForGanttLB+" "+scheduler._events[A].name,mstPage+"?ingantt=true&id="+A);if(scheduler._events[scheduler._events[A].relatedFather])return void y.showOnGantt(scheduler._events[A].relatedFather);if(scheduler._events[scheduler._events[A].relatedTo])return void y.showOnGantt(scheduler._events[A].relatedTo);scheduler._events[A].relatedFather?alert(customLabels.related_x_not_scheduled_no_display.replaceAll(d.serviceAppointments()[scheduler._events[A].relatedFather].name)):alert(customLabels.related_x_not_scheduled_no_display.replaceAll(d.serviceAppointments()[scheduler._events[A].relatedTo].name));break;case"validate":S.checkRules([A]).then(S.drawViolationsOnGantt);break;default:if(0===s.indexOf("custom_")){var e=parseInt(s.split("_")[1]),t=[A],i=y.getCustomActions("gantt")[e];if(i.visualforce){var e=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),n=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear();h.open(i.name,i.visualforce+"?id="+A+"&start="+e+"&end="+n);break}a.callRemoteAction(RemoteActions.runCustomServiceAction,i.className,t,scheduler._min_date,scheduler._max_date).then(function(e){e&&y.addNotification(i.name,e,null,null)}).catch(function(e){return y.addNotification(i.name,e.message,null,null)});break}g.$evalAsync(function(){ne([A],x[s])})}})}),$(".dhtmlxMenu_dhx_skyblue_SubLevelArea_Polygon").mouseover(function(){scheduler.dhtmlXTooltip.hide()}),R.addNewChild(R.topId,1,"flag",y.getSVGIconHTML(lsdIcons.flag)+customLabels.Flag,!1),R.addNewChild(R.topId,2,"unflag","<span class='emptyFlag'>"+y.getSVGIconHTML(lsdIcons.flag)+"</span>"+customLabels.Unflag,!1),R.addNewChild(R.topId,3,"reschedule",y.getSVGIconHTML(lsdIcons.calendar)+customLabels.Reschedule,!1),window.customPermissions.Enable_Check_Rules&&R.addNewChild(R.topId,12,"validate",y.getSVGIconHTML(lsdIcons.violation)+customLabels.check_rules_action_label,!1),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Unschedule||window.__gantt.ignoreReadonlyGantt226)&&R.addNewChild(R.topId,5,"unschedule",y.getSVGIconHTML(lsdIcons.na)+customLabels.Unschedule,!1),(!window.customPermissions.ignoreReadonlyGantt226&&window.customPermissions.Show_Pin_Service||window.customPermissions.ignoreReadonlyGantt226)&&(R.addNewChild(R.topId,7,"pin",y.getSVGIconHTML(lsdIcons.pin)+customLabels.Pin,!1),R.addNewChild(R.topId,8,"unpin","<span class='emptyFlag'>"+y.getSVGIconHTML(lsdIcons.unpin)+"</span>"+customLabels.Unpin,!1)),y.customActionsPromise.then(function(){y.getCustomActions("gantt").forEach(function(e,t){e.icon?R.addNewChild(R.topId,t+12,"custom_"+t,y.getSVGIconHTML(e.icon)+e.name.encodeHTML(),!1):R.addNewChild(R.topId,t+12,"custom_"+t,e.name.encodeHTML(),!1)})}),v.isActive()&&(y.hasCustomPermission("Bulk_Bundle")&&R.addNewChild(R.topId,41,"bundler",y.getSVGIconHTML(f.Bundle.icon)+f.Bundle.label,!1),y.hasCustomPermission("Bulk_Unbundle")&&R.addNewChild(R.topId,42,"unbundler",y.getSVGIconHTML(f.Unbundle.icon)+f.Unbundle.label,!1)),R.attachEvent("onShow",function(e){contextShown=!0}),R.attachEvent("onHide",function(e){contextShown=!1}),R.attachEvent("onClick",function(s,e,t){g.$evalAsync(function(){switch(s){case"flag":y.safeApply(g,function(){Q(!0)});break;case"unflag":y.safeApply(g,function(){Q(!1)});break;case"bundler":var e=(g.selectedGanttServices.getSelected()||[]).map(function(e){return scheduler._events[e]});f.Bundle.invoke(e,b.selectedPolicyId).then(function(e){M()},function(e){});break;case"unbundler":e=(g.selectedGanttServices.getSelected()||[]).map(function(e){return scheduler._events[e]});f.Unbundle.invoke(e,b.selectedPolicyId).then(function(e){M()},function(e){});break;case"reschedule":Z.schedule(g.selectedGanttServices.getSelected());break;case"pin":S.changePin(g.selectedGanttServices.getSelected(),!0).then(function(){return updateViewDebounced()});break;case"unpin":S.changePin(g.selectedGanttServices.getSelected(),!1).then(function(){return updateViewDebounced()});break;case"unschedule":ie(g.selectedGanttServices.getSelected());break;case"validate":S.checkRules(g.selectedGanttServices.getSelected()).then(S.drawViolationsOnGantt);break;default:if(0===s.indexOf("custom_")){var e=parseInt(s.split("_")[1]),t=g.selectedGanttServices.getSelected(),i=y.getCustomActions("gantt")[e];if(i.visualforce){var e=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),n=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear();h.open(i.name,i.visualforce+"?services="+t.join(",")+"&start="+e+"&end="+n);break}a.callRemoteAction(RemoteActions.runCustomServiceAction,i.className,g.selectedGanttServices.getSelected(),scheduler._min_date,scheduler._max_date).then(function(e){e&&y.addNotification(i.name,e,null,null)}).catch(function(e){return y.addNotification(i.name,e.message,null,null)});break}ne(g.selectedGanttServices.getSelected(),x[s])}})}),g.lockGanttToggle=function(){(window.__gantt.ignoreReadonlyGantt226||window.customPermissions.Enable_Gantt_Locker)&&(scheduler.config.readonly=!scheduler.config.readonly,g.ganttLocked=scheduler.config.readonly,i.SetUserSettingsProperty("Lock_Gantt__c",g.ganttLocked))},g.unSelecteAllSkills=function(){for(var e in g.selectedSkills)g.selectedSkills[e]=!1},g.selectAllSkills=function(){for(var e in g.selectedSkills)g.selectedSkills[e]=!0},g.getSkills=n.getSkills,scheduler.attachEvent("onYScaleClick",function(e,t,i){i.stopPropagation(),i.preventDefault(),window.__lastResourceClicked=t;for(var n=["resourceMenuBtn","resourceMenuIcon"],s=0;s<n.length;s++)if(i.target.classList&&i.target.classList.contains(n[s])||i.target.parentNode&&i.target.parentNode.classList.contains(n[s]))return void V.open(t.resourceId,t.key,i.target);t.children||U.open(t.resourceId,t.key)}),scheduler.attachEvent("onBeforeTooltip",function(e){return setTimeout(function(){var e=$(".dhtmlXTooltip");0!==e.length&&(e.position().top<0?e.css("height",e.height()+e.position().top-15+"px"):15<e.position().top&&e.css("height","initial"))},400),!0}),g.$on("keypress",function(e,t){if($("#MonthlyViewTooltip").remove(),!b.isLightboxOpened()&&!b.isLoadingNewLocations&&!$("*:focus").is("textarea, input"))switch(t.which){case 13:""!==scheduler._select_id&&scheduler._select_id&&"service"===scheduler.getEvent(scheduler._select_id).type&&(S.recentlyUsed[scheduler._selected_id]=!0,m.open(scheduler._select_id));break;case 37:t.shiftKey?(ee(-1),g.changeDatesByArrows()):$(".dhx_cal_prev_button").click();break;case 38:var i=$(".dhx_cal_data").scrollTop();$(".dhx_cal_data").scrollTop(i-30);break;case 39:t.shiftKey?(ee(),g.changeDatesByArrows()):$(".dhx_cal_next_button").click();break;case 40:i=$(".dhx_cal_data").scrollTop(),$(".dhx_cal_data").scrollTop(i+30);break;case 87:""!==scheduler._select_id&&scheduler._select_id&&"service"===scheduler.getEvent(scheduler._select_id).type&&scheduler.getEvent(scheduler._select_id).parentRecord&&(g.isInConsole()?sforce.console.generateConsoleUrl(["/"+scheduler._events[scheduler._select_id].parentRecord],function(e){e.success?sforce.console.openConsoleUrl(null,e.consoleUrl,!0):y.openLightningPrimaryTab(scheduler._events[scheduler._select_id].parentRecord)}):window.open("../"+scheduler._events[scheduler._select_id].parentRecord));break;case 83:""!==scheduler._select_id&&scheduler._select_id&&"service"===scheduler.getEvent(scheduler._select_id).type&&!scheduler.getEvent(scheduler._select_id).isDummy&&(g.isInConsole()?sforce.console.generateConsoleUrl(["/"+scheduler._select_id],function(e){e.success?sforce.console.openConsoleUrl(null,e.consoleUrl,!0):y.openLightningPrimaryTab(scheduler._select_id)}):window.open("../"+scheduler._select_id));break;case 84:g.jumpToToday();break;case 70:1===g.selectedGanttServices.getSelected().length&&""!==scheduler._select_id&&scheduler._select_id&&"service"===scheduler.getEvent(scheduler._select_id).type&&(S.flagged[scheduler._select_id]?S.flagged[scheduler._select_id]=!1:S.flagged[scheduler._select_id]=!0,scheduler.updateEvent(scheduler._select_id));break;case 48:case 96:g.changeTimeline(0);break;case 49:case 97:g.changeTimeline(1);break;case 50:case 98:g.changeTimeline(2);break;case 51:case 99:g.changeTimeline(3);break;case 55:g.changeTimeline(7);break;case 77:y.hasCustomPermission("MDT_View")&&!y.hasCustomPermission("Longterm_View")&&g.changeTimeline(35);break;case 85:y.hasCustomPermission("Monthly_Utilization")&&monthlyViewSettings.isMonthlyAvailable&&g.changeTimeline(30);break;case 103:g.changeTimeline(7)}}),g.changeTimeline=function(e){var t=scheduler._min_date,i=scheduler._max_date,n=void 0;switch(e){case 0:if((n="ZoomLevel2")===scheduler._mode)return;g.timelineName=customLabels.In_Day;break;case 1:if((n="ZoomLevel3")===scheduler._mode)return;g.timelineName=customLabels.Daily;break;case 2:if((n="ZoomLevel4")===scheduler._mode)return;g.timelineName=customLabels.X2_Days;break;case 3:if((n="ZoomLevel5")===scheduler._mode)return;g.timelineName=customLabels.X3_Days;break;case 7:if((n="ZoomLevel6")===scheduler._mode)return;g.timelineName=customLabels.Weekly;break;case 14:if((n="ZoomLevel7")===scheduler._mode)return;g.timelineName=customLabels.TwoWeeks;break;case 30:if((n="MonthlyView")===scheduler._mode)return;g.timelineName=customLabels.Utilization;break;case 35:if((n="MTDView")===scheduler._mode)return;g.timelineName=customLabels.MDTVIEW;break;case 180:if((n="LongView")===scheduler._mode)return;g.timelineName=customLabels.LongView}scheduler.setCurrentView(t,n),g.changeDatesByArrows(i)},setInterval(E,6e5),g.jumpToToday=function(){var e=new Date;e.setHours(0),e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0),scheduler.setCurrentView(e),g.changeDatesByArrows()},s.$on("afterShowEvent",function(){setTimeout(function(){g.changeDatesByArrows(),E(),updateViewDebounced()},800)}),g.showOnMap=function(e){s.$broadcast("showServiceOnMap",e),y.safeApply(g)},scheduler.attachEvent("onBeforeEventChanged",function(e,t,i,n){var s=e.resourceId.split("_"),s=T.isTerritoryHasInDayOptimizationInProgress(e.start_date,e.end_date,s[1]);if(s){if(!1===confirm(customLabels.In_Day_Optimization_In_Progress_Confirm))return!1;"Rollback"===y.getSchedulingPolicyObject(s.policy)[fieldNames.SchedulingPolicy.Commit_Mode__c]&&T.updateProgressStatus(s.id,"Aborted")}var r,o,a;if(t.ctrlKey&&!e.isImmidietlyFollow&&S.handleSnap(e,t),e.resourceId===n.resourceId){if(s=e.start_date.getTime(),r=e.end_date.getTime(),o=n.start_date.getTime(),a=n.end_date.getTime(),Math.abs((s-o)/1e3/60)<minDragMinutes||Math.abs((r-a)/1e3/60)<minDragMinutes)return cachedDomElements.timesDragFix.hide(),!1}else if("na"===e.type)return!1;if(b.areContractorsSupported()&&"service"===e.type&&c.getResources()[e.getGanttResource()].isCapacityBased){for(var l in d.resourceCapacities()){l=d.resourceCapacities()[l];if(l.resource===c.getResources()[e.getGanttResource()].id&&(e.start.getTime()>=l.start_date.getTime()&&e.start.getTime()<=l.end_date.getTime()))return e.resourceBeforeDrag=n.resourceId,e.eventBeforeDrag=n,se(e),!0}return cachedDomElements.timesDragFix.hide(),alert(customLabels.serviceCantBeAssignedWithoutCapacity),!1}return C=GanttService.copy(n),snapTo=t.ctrlKey,se(e),e.resourceBeforeDrag=n.resourceId,e.eventBeforeDrag=n,!0}),g.updateMonthlyKpi=function(){"MonthlyView"===scheduler._mode&&updateViewDebounced(),te()};var te=_.debounce(function(){i.SetUserSettingsProperty("Utilization_Properties__c",JSON.stringify(g.capacityFields))},800);function ie(e){var t,i;confirm(customLabels.are_you_sure_unschedule)&&(t=[],i=[],e.forEach(function(e){i.push(d.serviceAppointments()[e]),t.push(d.serviceAppointments()[e].resource),S.recentlyUsed[e]=!0}),S.unscheduleServices(e,b.selectedPolicyId).then(function(e){M(),S.drawServicesAndAbsences(e.services,e.absences),p.calculateKpis()}).catch(function(e){y.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)}))}function ne(e,t){var i,n;t===w.CANCELED&&!confirm(customLabels.AreYouSureYouWantToCancel)||(i=[],n=[],e.forEach(function(e){n.push(d.serviceAppointments()[e]),i.push(d.serviceAppointments()[e].resource),S.recentlyUsed[e]=!0}),S.changeStatus(e,t).then(function(e){M(),S.drawServicesAndAbsences(e.services)}).catch(function(e){y.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)}))}function se(e){var t=(e.start_date.getMinutes()+e.travelTo/60)%60,i="na"===e.type?e.end-e.start:e.schedEndTime-e.schedStartTime,n=t%serviceJumpsOnGantt,t=serviceJumpsOnGantt-t%serviceJumpsOnGantt;0!=n&&(e.start_date=t<n?new Date(e.start_date.getTime()+60*t*1e3):new Date(e.start_date.getTime()-60*n*1e3),e.end_date=new Date(e.start_date.getTime()+i+1e3*e.travelFrom+1e3*e.travelTo),e.schedStartTime=e.start_date.getTime()+1e3*e.travelTo,e.schedEndTime=e.end_date.getTime()-1e3*e.travelFrom)}g.cancelCrewView=function(){s.crewViewActive=!1,g.crewViewActive=!1,d.isCrewViewActive=!1},s.$on("gotNewTimePhasedObjects",function(e,t){S.drawServicesAndAbsences(t.serviceAppointments,t.resourceAbsences,[],t.resourceCapacities)}),s.$on("timePhasedObjectsCheckRules",function(e,t){S.checkRules(t).then(S.drawViolationsOnGantt)}),a.callRemoteAction(RemoteActions.isStreamingShouldBeActive).then(function(e){"true"===e?b.setStreamingActiveState(!0):(b.setStreamingActiveState(!1),"false"!==e&&y.addNotification(customLabels.GanttLiveRefreshNotSupported,e,null,null)),K.initStreaming()}),e.register("services",function(e){S.drawServicesAndAbsences(e.updated||[],[],e.deleted||[])}),e.register("absences",function(e){S.drawServicesAndAbsences([],e.updated||[],e.deleted||[])}),e.register("capacities",function(e){S.drawServicesAndAbsences([],[],e.deleted||[],e.updated||[])}),e.register("rules",function(e,t){t&&S.checkRules(e).then(S.drawViolationsOnGantt)}),scheduler.attachEvent("onEventChanged",function(e,t){"service"!==t.type&&"na"!==t.type||y.safeApply(g,function(){"na"===t.type?l.saveChangesToAbsence(C,t,b.selectedPolicyId).then(function(e){}).catch(function(e){console.warn("Couldn't update absence"),e[0].message?y.addNotification(customLabels.Action_Could_Not_Be_Performed,e[0].message):y.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.user_is_not_allowed_to_perform_action),scheduler.parse([e[1]],"json")}):S.saveChangesToServiceAppointment(C,t).then(function(e){scheduler._select_id=t.id}).catch(function(e){console.warn("Couldn't update service. "+e[2]),y.addNotification(customLabels.Action_Could_Not_Be_Performed,e[2]||e[0].message.substr(e[0].message.indexOf(",")+1)||customLabels.user_is_not_allowed_to_perform_action),scheduler.parse([e[1]],"json"),d.serviceAppointments()[e[1].id]=e[1]})})}),g.$on("JumpToDate",function(e,t){scheduler.setCurrentView(t),g.changeDatesByArrows()}),g.$on("GotSlots",function(e,t){var i=getMinAndMaxHoursToDisplay();(t.minDateOfCandidate.getHours()<i.min||t.minDateOfCandidate.getHours()>=i.max)&&confirm(customLabels.confirmChangeBusinessHours)&&(t.minDateOfCandidate.getHours()<i.min?g.businessHoursRange.start=t.minDateOfCandidate.getHours():g.businessHoursRange.end=24,J())}),g.changeUtilizaionDays=function(e){-1===e&&1===g.numberOfDaysInUtilizationView||1===e&&30===g.numberOfDaysInUtilizationView||(g.numberOfDaysInUtilizationView+=e,g.daysInUtilizationChanged())},g.daysInUtilizationChanged=function(){scheduler.matrix.MonthlyView.x_size=g.numberOfDaysInUtilizationView,i.SetUserSettingsProperty("DaysInUtilizationView__c",g.numberOfDaysInUtilizationView),"MonthlyView"===scheduler._mode&&(scheduler.updateView(),g.getTimePhasedObjects())},g.getRowSizeClass=function(){return y.ganttSettings.resourceRowHeight+"-css"},g.filterVisibility={hours:!0,resources:!1,skills:!1,utilization:!1,palettes:!1},g.needToLoadSkills=!0,g.needToLoadPalettes=!0,g.werePalettesLoaded=L.werePalettesLoaded,g.changeGanttFilterTab=function(e){for(var t in"skills"===e&&g.needToLoadSkills&&n.getSkillsFromSfdc().then(function(){return g.needToLoadSkills=!1}),"palettes"===e&&g.needToLoadPalettes&&!L.werePalettesLoaded()&&L.getGanttPalettes(!0).then(function(){return g.needToLoadPalettes=!1}),g.filterVisibility)g.filterVisibility[t]=t===e},scheduler.attachEvent("onAfterEventDisplay",function(e){setTimeout(function(){e.showEventPopupEffect=!1,p.calculateKpis(),s.$broadcast("afterShowEvent")},2500)}),g.updateWorkingReosourcesFilter=_.debounce(function(){g.resourceFilterHelper.showWorkingResource=g.resourceFilters.showWorkingResource},300),s.$on("flagService",function(e,t){S.flagged[t]?S.flagged[t]=!S.flagged[t]:S.flagged[t]=!0,scheduler.updateEvent(t)}),scheduler.attachEvent("onBeforeLightbox",function(e){scheduler.updateEvent(e);e=$("#timesDragFix");return e&&e.hide(),!1})}]),angular.module("serviceExpert").controller("ctrlIframeMap",["$scope","sfdcService","$rootScope","MapService","servicesService","TimePhasedDataService",function(i,e,t,n,s,r){i.filter=s.filter,i.$on("showServiceOnMap",function(e,t){n.showServiceOnMap(t,i.floatingMapOn,i.workingState)}),i.$on("gotNewResources",function(e,t){n.initializeGanttMap(!0)}),i.$watch("filter",function(e,t){"map"!==i.workingState&&!i.floatingMapOn||n.updateGanttMapFilter()},!0),i.$watch("floatingMapOn",function(e){e&&n.updateGanttMapFilter()}),i.$watch("workingState",function(e){"map"!==e&&!i.floatingMapOn||n.updateGanttMapFilter()}),t.$on("paletteUpdated",function(){n.updateGanttMapServices(r.serviceAppointments(),{})}),t.$on("updateTimePhaseData",function(e,t){n.updateGanttMapServices(t,{})}),t.$on("deleteTimePhaseData",function(e,t){n.updateGanttMapServices({},t)}),t.$on("gotNewTimePhasedObjects",function(e,t){n.initializeGanttMap(!1),n.updateGanttMapServices(t.serviceAppointments,[],!0),n.updateGanttMapView()}),scheduler.attachEvent("onViewChange",function(){"map"!==i.workingState&&!i.floatingMapOn||(n.updateGanttMapView(),n.updateGanttMapServices(s.filteredServices.servicesArray,[]))})}]),angular.module("serviceExpert").controller("mainController",["$scope","StateService",function(e,t){e.isOSX=t.isOSX,e.lang=t.lang,e.isRtlDirection=t.isRtlDirection(),e.isUserIdle=t.isUserIdle,e.refreshPage=function(){location.reload()},e.focusOnInactiveButton=function(){document.getElementById("ReloadButtonFsl").focus()}}]),angular.module("serviceExpert").controller("ctrlMap",["$scope","sfdcService","$rootScope","$q","userSettingsManager","servicesService","bulkScheduleService","$timeout","$filter","utils","ServiceAppointmentLightboxService","ResourceLightboxService","TimePhasedDataService","FieldSetFieldsService","ResourcesAndTerritoriesService","LastKnownPositionService","DeltaService","SERVICE_STATUS","SERVICE_CATEGORY","DRAWING_STATES","StreamingAPIService","RegisterService","GeneralLightbox",function(A,o,i,d,r,a,l,s,N,I,c,u,C,e,k,D,G,m,n,p,B,t,h){A.SERVICE_STATUS=m,A.invokedActions={},A.allMarkersArray=[],A.reports={},A.reportsData={},A.map=null,A.markersControl={},A.territoriesMarkers=[],A.firstMapShow=!0,A.trafficLayerEnabled=!1,A.mapControl={center:{latitude:0,longitude:0},zoom:19},A.mapOptions={zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},streetViewControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},mapTypeControlOptions:{position:google.maps.ControlPosition.RIGHT_TOP}};var g=JSON.parse(r.GetUserSettingsProperty("Map_Object_Markers__c"))||{services:!0,resources:!0,positions:!0,territories:!0};function v(e){if(A.allMarkersArray=[],A.showResources){var t,i=scheduler.getState().min_date,n=scheduler.getState().max_date,s=C.resourcesByPrimariesAndRelocations();for(t in s){var r,o=s[t];for(r in o){var a=o[r];isIntersect(i,n,a.effectiveStartDate,a.effectiveEndDate)&&!function(e){var t;!e.latitude||(t=k.getResources()[e.serviceResource])&&(A.isEmpty(A.filteredResources)||A.filteredResources[t.id])&&(e={id:e.id,icon:staticResources.homebase_png,type:"resource",resourceId:t.id,serviceTerritory:e.serviceTerritory,coords:{latitude:e.latitude,longitude:e.longitude},item:angular.extend(angular.copy(e),{resourceName:t.name})},A.allMarkersArray.push(e))}(a)}}}if(A.showServices){for(var l=A.filteredServices.servicesArray,c=0;c<l.length;c++){var d=l[c];d.id!=A.currentShowOnMapServiceId&&R(d)}A.currentShowOnMapServiceId&&R(C.serviceAppointments()[A.currentShowOnMapServiceId])}if(A.showLivePositions){var u,m=scheduler.getState().min_date,p=scheduler.getState().max_date,h=C.resourcesAndTerritories(),g=D.lastKnownPositions();for(u in g){var v,f=h[u];for(v in f){var S=f[v];if(isIntersect(m,p,S.effectiveStartDate,S.effectiveEndDate)){!function(e){var t=k.getResources()[e.id];(A.isEmpty(A.filteredResources)||A.filteredResources[t.id])&&((e={id:e.id+"_position",icon:staticResources.livepos_png,type:"lastKnownPosition",resourceId:e.id,coords:{latitude:e.latitude,longitude:e.longitude},item:angular.extend(angular.copy(e),{resourceName:t.name})}).item.lastModifiedDate=I.convertDateBetweenTimeZones(e.item.lastModifiedDate,"UTC",userTimeZone),A.allMarkersArray.push(e))}(g[u]);break}}}}A.showTerritories&&O();var _,y=e,b=maxReportMarkers;for(_ in A.reportsData){var w=A.reportsData[_];if(w.show)for(var T=w.displayCount=0;T<w.data.length;T++){var L=w.data[T];if(0==b){y&&(A.showTooManyReportsAlert=!0);break}(function(e,t){var i;if(e.latitude)return i=staticResources.report,"ServiceAppointment"===e.sObjectType?i=staticResources.service_png:void 0!==staticResources[e.sObjectType.toLowerCase().replace(/ /g,"_")]&&(i=staticResources[e.sObjectType.toLowerCase().replace(/ /g,"_")]),t={id:t,icon:i,type:"report",coords:{latitude:e.latitude,longitude:e.longitude},item:e},A.allMarkersArray.push(t),!0})(L,_+w.displayCount)&&(w.displayCount++,b--)}}}function f(e,t){for(var i=new google.maps.LatLngBounds,n=0;n<e.length;n++){var s=(t?e[n].coords:e[n]).latitude,r=(t?e[n].coords:e[n]).longitude;s&&r&&(s=new google.maps.LatLng(s,r),i.extend(s))}return i}function R(e){var t;e.latitude&&A.showServices&&(t=e.getGanttResource(),(A.isEmpty(A.filteredResources)||null!=t&&A.filteredResources[t])&&(t=staticResources.service_png,e.statusCategory==n.COMPLETED&&(t=staticResources.service_completed_png),t={id:e.id,icon:t,type:"service",animation:2,coords:{latitude:e.latitude,longitude:e.longitude},item:e},A.allMarkersArray.push(t)))}function O(){var e,t=k.territories();for(e in t)t[e].latitude&&A.allMarkersArray.push({id:e,icon:staticResources.territory_map_icon,type:"territory",animation:2,coords:{latitude:t[e].latitude,longitude:t[e].longitude},item:t[e]})}function S(e,t){if(A.polygons[e])A.polygons[e].polygon.setVisible(t),y(e,t);else if(k.territories()[e]||"NoTerritoryPolygon"==e){y(e);for(var i=A.myTreeView.getSubItems(e),n=0;n<i.length;n++)s=i[n],t?A.myTreeView.checkItem(s):A.myTreeView.uncheckItem(s)}var s;r.SetUserSettingsProperty("Invisible_Polygons__c",JSON.stringify(A.InvisiblePolygons))}function y(e,t){for(var i=0;i<A.InvisiblePolygons.length;i++)if(A.InvisiblePolygons[i]==e)return void A.InvisiblePolygons.splice(i,1);t||A.InvisiblePolygons.push(e)}function b(){A.selectedShape&&("marker"!==A.selectedShape.type&&A.selectedShape.setEditable(!1),A.selectedShape.set("strokeWeight",1),A.selectedShape=null,A.currentEditPolygon=null,A.polygonName="",A.polygonTerritory="null"),A.drawState=A.drawState==p.DRAW?p.EDIT:p.NONE}function w(e){if(this&&(e=this),A.drawState==p.INTERSECT)return A.currentIntersectingId==e.id?void 0:(A.selectedIntersectingPolygons[e.id]?delete A.selectedIntersectingPolygons[e.id]:A.selectedIntersectingPolygons[e.id]=!0,void A.$apply());"marker"!==e.type&&(b(),A.selectedColor=A.selectedShapeColor=e.get("fillColor"),A.drawState!=p.EDIT&&(A.drawState=p.SELECTED)),A.polygonName=e.name,A.polygonTerritory=e.territory||"null",A.selectedShape=e,A.selectedShape&&A.selectedShape.set("strokeWeight",3),e.id!=A.myTreeView.getSelectedId()&&(A.shouldBound=!1,A.myTreeView.selectItem(e.id)),A.$apply()}function T(e){A.geoXmlParser.parseKmlString(e[fieldNames.Polygon.KML__c]);for(var t=A.geoXmlParser.docs.length-1,i=0;i<A.geoXmlParser.docs[t].placemarks.length;i++)A.geoXmlParser.docs[t].placemarks[i].id=e.Id,A.geoXmlParser.docs[t].placemarks[i].polygon.id=e.Id,A.geoXmlParser.docs[t].placemarks[i].polygon.name=e.Name,A.geoXmlParser.docs[t].placemarks[i].polygon.territory=e[fieldNames.Polygon.Service_Territory__c],A.geoXmlParser.docs[t].placemarks[i].polygon.addListener("click",function(){A.shouldBound=!1,M.hide(),w(this)}),A.geoXmlParser.docs[t].placemarks[i].polygon.addListener("rightclick",x),A.polygons[e.Id]=e,A.polygons[e.Id].polygon=A.geoXmlParser.docs[t].placemarks[i].polygon}A.showServices=g.services,A.showResources=g.resources,A.showLivePositions=g.positions,A.showTerritories=g.territories,A.showOnMap=!1,A.setMapMarkerUserSettings=function(){r.SetUserSettingsProperty("Map_Object_Markers__c",JSON.stringify({services:A.showServices,resources:A.showResources,positions:A.showLivePositions,territories:A.showTerritories}))},A.showTooManyReportsAlert=!1,A.resourcesFilterList=[],A.filterResourceInputValue="",A.filteredResources={},A.selectedReport="null",A.infoWindowOptions={service:{pixelOffset:new google.maps.Size(0,-38)},resource:{pixelOffset:new google.maps.Size(0,-38)},report:{pixelOffset:new google.maps.Size(0,-38)},livePos:{pixelOffset:new google.maps.Size(0,-38)}},A.serviceInfoWindow={show:!1,control:{}},A.resourceInfoWindow={show:!1,control:{}},A.territoryInfoWindow={show:!1,control:{}},A.reportInfoWindow={show:!1,control:{}},A.livePosInfoWindow={show:!1,control:{}},A.filteredServices=a.filteredServices,A.filter=a.filter,A.currentShowOnMapServiceId=null,A.drawingStates=p,A.drawState=p.NONE,A.selectedShape=null,A.selectedShapeColor=A.selectedColor,A.drawingManager,A.setSelectedShapeColor=function(e){A.selectedShape&&(A.selectedShape.set("fillColor",e),A.selectedShapeColor=e);A.selectedColor=e},A.polygons={},A.polygonName="",A.polygonTerritory="null",A.territories={},A.selectedIntersectingPolygons={},A.shouldBound=!0,A.cancelDrawingShape=!1,A.InvisiblePolygons=null==r.GetUserSettingsProperty("Invisible_Polygons__c")?[]:JSON.parse(r.GetUserSettingsProperty("Invisible_Polygons__c")),A.hasCustomPermission=I.hasCustomPermission,A.getServiceInfoRowClass=I.getServiceInfoRowClass,A.pinnedStatusesSF=CustomSettings.pinnedStatusesSF,A.getReportsError=function(){return A.reportsError},I.getReports().then(function(e){if(e)for(var t=0;t<e.length;t++)A.reports[e[t].Id]=e[t]}).catch(function(e){A.reportsError=!0}),D.getLastKnownPositions(),A.redrawAllMarkers=v,A.$watch("workingState",function(e){"map"==e?(A.map=A.mapControl.getGMap(),s(function(){A.resourcesFilterList=[];var e,t=scheduler.getState().min_date,i=scheduler.getState().max_date,n=C.resourcesAndTerritories(),s=k.getResources();for(e in s){var r,o=n[e],a=s[e];for(r in o){var l=o[r];if(isIntersect(t,i,l.effectiveStartDate,l.effectiveEndDate)){A.resourcesFilterList.push({label:a.name,value:a.id});break}}}if(v(),google.maps.event.trigger(A.mapControl.getGMap(),"resize"),A.firstMapShow){if(!A.showOnMap){var c=new google.maps.LatLng(37.794024,-122.394837),d=f(A.filteredServices.servicesArray);(d=d.isEmpty()?f(_.values(C.serviceAppointments())):d).isEmpty()?A.map.setCenter(c):A.map.fitBounds(d)}var c=A.map.getStreetView(),d={fullscreenControl:!1,addressControlOptions:{position:google.maps.ControlPosition.BOTTOM_CENTER}},u=(c.setOptions(d),{fillOpacity:.5,strokeWeight:1,editable:!0,draggable:!0,fillColor:A.selectedColor});if(A.drawingManager=new google.maps.drawing.DrawingManager({drawingMode:null,drawingControl:!1,drawingControlOptions:{position:google.maps.ControlPosition.BOTTOM_CENTER,drawingModes:["polygon"]},polygonOptions:u,rectangleOptions:u}),A.drawingManager.setMap(A.map),google.maps.event.addListener(A.drawingManager,"overlaycomplete",function(e){var i=e.overlay;if(A.cancelDrawingShape)return A.cancelDrawingShape=!1,void i.setMap(null);i.type=e.type,i.set("fillColor",A.selectedColor),i.set("name",A.polygonName),i.set("territory",A.polygonTerritory),A.drawingManager.setDrawingMode(null),google.maps.event.addListener(i,"click",function(e){var t;void 0!==e.vertex&&i.type===google.maps.drawing.OverlayType.POLYGON&&((t=i.getPaths().getAt(e.path)).removeAt(e.vertex),t.length<3&&i.setMap(null)),w(i)}),w(i)}),"function"!=typeof google.maps.Polygon.prototype.ToWKT&&(google.maps.Polygon.prototype.ToWKT=function(){for(var e="POLYGON(",t=this.getPaths(),i=0;i<t.getLength();i++){var n=t.getAt(i);e+="(";for(var s=0;s<n.getLength();s++)e+=n.getAt(s).lng().toString()+" "+n.getAt(s).lat().toString()+",";e+=n.getAt(0).lng().toString()+" "+n.getAt(0).lat().toString()+"),"}return e=e.substring(0,e.length-1)+")"}),A.geoXmlParser=new geoXML3.parser({map:A.map,suppressInfoWindows:!0,zoom:!1}),!A.isEmpty(A.polygons)){var m=0;try{for(var p in A.polygons){A.geoXmlParser.parseKmlString(A.polygons[p][fieldNames.Polygon.KML__c]);for(var h,g=0;g<A.geoXmlParser.docs[m].placemarks.length;g++)A.geoXmlParser.docs[m].placemarks[g].polygon&&(A.geoXmlParser.docs[m].placemarks[g].id=A.polygons[p].Id,A.geoXmlParser.docs[m].placemarks[g].polygon.id=A.polygons[p].Id,A.geoXmlParser.docs[m].placemarks[g].polygon.name=A.polygons[p].Name,A.geoXmlParser.docs[m].placemarks[g].polygon.territory=A.polygons[p][fieldNames.Polygon.Service_Territory__c],h=-1==A.InvisiblePolygons.indexOf(p),A.geoXmlParser.docs[m].placemarks[g].polygon.setVisible(h),A.geoXmlParser.docs[m].placemarks[g].polygon.addListener("click",function(){A.shouldBound=!1,M.hide(),w(this)}),A.geoXmlParser.docs[m].placemarks[g].polygon.addListener("rightclick",x),A.polygons[p].polygon=A.geoXmlParser.docs[m].placemarks[g].polygon);m++}}catch(e){alert("Problem parsing KML string"),console.error(e)}}google.maps.event.addListener(A.map,"click",function(){A.map.setOptions({draggableCursor:"grab"}),M.hide()}),M=new P(A.map,L),A.firstMapShow=!1,A.showOnMap=!1}},0)):A.currentShowOnMapServiceId=null}),A.$on("resizeMap",function(e,t){google.maps.event.trigger(A.mapControl.getGMap(),"resize")}),A.$on("showServiceOnMap",function(e,t){A.currentShowOnMapServiceId=t,i.$broadcast("changeWorkingState","map"),A.map=A.mapControl.getGMap(),A.showOnMap=!0,s(function(){google.maps.event.trigger(A.mapControl.getGMap(),"resize");var e=C.serviceAppointments()[t],e=new google.maps.LatLng(e.latitude,e.longitude);A.map.setCenter(e),A.map.setZoom(20),s(function(){A.markersControl.getPlurals().get(t)&&A.markersControl.getPlurals().get(t).gObject.setAnimation(google.maps.Animation.BOUNCE),s(function(){var e=A.markersControl.getPlurals().get(t);e&&e.gObject.setAnimation(null)},3500)},150)},0)}),e.fieldsSetFields().then(function(e){A.serviceFields=e.MapInfo}),A.isEmpty=function(e){return!e||_.isEmpty(e)},A.markerCloseClicked=function(){A.serviceInfoWindow.show=!1,A.resourceInfoWindow.show=!1,A.territoryInfoWindow.show=!1,A.reportInfoWindow.show=!1,A.livePosInfoWindow.show=!1,A.$apply()},A.openLink=function(e,t){"Resource__r"==t.APIName?A.openLightbox(e.resourceId,"resource"):I.openLink(e,t)},A.openReportLink=function(e){e.isReference&&("ServiceResource"==e.APIName?A.openLightbox(e.Value,"resource"):"ServiceAppointment"==e.APIName?A.openLightbox(e.Value,"service"):I.openConsoleTab(null,e.Value)||window.open("../"+e.Value,"_blank"))},A.markerClicked=function(e,t,i){var n=i,i=n.type;switch(A.serviceInfoWindow.show=!1,A.resourceInfoWindow.show=!1,A.territoryInfoWindow.show=!1,A.reportInfoWindow.show=!1,A.livePosInfoWindow.show=!1,A.currentMarker=n,i){case"service":A.serviceInfoWindow.show=!0,A.currentMarker.item=C.serviceAppointments()[n.id];break;case"lastKnownPosition":A.livePosInfoWindow.show=!0;break;case"resource":A.resourceInfoWindow.show=!0;break;case"territory":A.territoryInfoWindow.show=!0;break;case"report":A.reportFields=[],A.reportFields.push.apply(A.reportFields,n.item.otherProperties),A.reportInfoWindow.show=!0}s(function(){A.$apply(),I.setMapCloseButtonPosition()},0)},A.openLightbox=function(e,t,i){var n=null;switch(i&&(n=I.generateResourceId(e,i)),t){case"service":a.recentlyUsed[e]=!0,c.open(e);break;case"resource":u.open(e,n);break;case"homeBase":A.$emit("showResourceLightbox",A.resources[e])}},A.$watch("filter",function(e,t){"map"===A.workingState&&v()},!0),A.clearResource=function(e){delete A.filteredResources[e],v()},A.clearAllResources=function(){A.filteredResources={},v()},A.addResourceToFilterList=function(){var e=k.getResources();""!=A.filterResourceInputValue&&e[A.filterResourceInputValue.value]&&(A.filteredResources[A.filterResourceInputValue.value]=e[A.filterResourceInputValue.value],A.filterResourceInputValue="",v())},A.toggleReportMarkers=function(e){e=A.reportsData[e];e.show=!e.show,v()},A.removeReportFromMap=function(e){delete A.reportsData[e],v()},A.removeAllReportsFromMap=function(){A.reportsData={},v()},A.showReportOnMap=function(){"null"!=A.selectedReport&&o.callRemoteAction(RemoteActions.getReportRowsForMap,A.selectedReport).then(function(e){A.reportsData[A.selectedReport]={show:!0,data:e,displayCount:0};v(!0)})},t.register("positions",function(e){v()}),A.isPinnedStatus=function(){if(A.currentMarker){for(var e=A.pinnedStatusesSF.split(","),t=0;t<e.length;t++)if(A.currentMarker.item.status===e[t])return!0;return!1}},A.needToShowScheduleButton=function(){return A.currentMarker&&"service"==A.currentMarker.type&&!A.currentMarker.item.pinned&&!A.isPinnedStatus()&&A.hasCustomPermission("Schedule")},A.needToShowDispatchButton=function(){return A.currentMarker&&"service"==A.currentMarker.type&&A.currentMarker.item.statusCategory!=n.DISPATCHED&&A.currentMarker.item.statusCategory==n.SCHEDULED},A.isServiceCurrentlyDispatching=function(){return A.currentMarker&&"dispatched"==A.invokedActions[A.currentMarker.id]},A.changeStatusToDispatch=function(e){A.invokedActions[e]?alert(customLabels.another_operation_running):(A.invokedActions[A.currentMarker.id]="dispatched",a.changeStatus([e],m.DISPATCHED).then(function(e){0<e.services.length&&(A.currentMarker.item=e.services[0])}).finally(function(){delete A.invokedActions[A.currentMarker.id]}))},A.isServiceCurrentlyScheduling=function(){return A.currentMarker&&"schedule"==A.invokedActions[A.currentMarker.id]},A.autoScheduleService=function(t){t=A.currentMarker.id;A.invokedActions[t]?alert(customLabels.another_operation_running):(a.recentlyUsed[t]=!0,A.invokedActions[t]="schedule",a.autoScheduleService(t).then(function(e){a.drawServicesAndAbsences(e.services,e.absences),delete A.invokedActions[t]}))},A.myTreeView={},A.lastSelectedLeafId=null,d.all([I.getPolygons(),k.promises.territories()]).then(function(e){var t,i=e[0];if(i)for(var n=0;n<i.length;n++)i[n][fieldNames.Polygon.KML__c]&&(A.polygons[i[n].Id]=i[n]);for(t in k.territories())-1!=I.getFilteredLocations().indexOf(t)&&(A.territories[t]=k.territories()[t]);O(),function(){var e,t,i,n=d.defer(),s=k.territories(),r={},o=[],a=(I.getFilteredLocations(),{NoTerritoryPolygon:{id:"NoTerritoryPolygon"}});for(e in A.polygons)r[e]={id:e,parent:A.polygons[e][fieldNames.Polygon.Service_Territory__c]?s[A.polygons[e][fieldNames.Polygon.Service_Territory__c]]:a.NoTerritoryPolygon,text:A.polygons[e].Name,icons:{file:"fa-square"},icon_color:A.polygons[e][fieldNames.Polygon.Color__c],checked:-1==A.InvisiblePolygons.indexOf(e)?1:0,items:[]};for(t in s)r[t]={id:t,parent:k.territories()[t].parentTerritory?k.territories()[t].parentTerritory:0,text:k.territories()[t].name,icons:{file:"fa-building-o"},checked:-1==A.InvisiblePolygons.indexOf(t)?1:0,items:[]};for(i in r.NoTerritoryPolygon={id:"NoTerritoryPolygon",parent:0,text:customLabels.Polygons_without_Service_Territory,icons:{file:"fa-building-o"},checked:-1==A.InvisiblePolygons.indexOf("NoTerritoryPolygon")?1:0,items:[]},r){var l=r[i],c=function e(t){if(!t.id||!t.parent)return;{var i;return r[t.parent.id]?t.parent:(i={},k.allTerritories[t.parent.id]&&(i={id:k.allTerritories[t.parent.id].id,parent:k.allTerritories[t.parent.id].parentTerritory||0}),e(i))}}(l);(0!==l.parent&&c?r[c.id].items:o).push(l)}return n.resolve(o),n.promise}().then(function(e){A.locationsTree=e,A.myTreeView=new dhtmlXTreeView({parent:"polygonsByTerritoriesTree",iconset:"font_awesome",checkboxes:!0,items:A.locationsTree}),A.myTreeView.attachEvent("onSelect",function(e,t){if(A.drawState!=p.NONE&&A.drawState!=p.SELECTED)return!1;A.lastSelectedLeafId||(A.lastSelectedLeafId=e),!A.polygons[e]||null==A.lastSelectedLeafId||A.lastSelectedLeafId==e&&null==A.polygons[e]?b():(t&&(w(A.polygons[e].polygon),A.shouldBound&&A.selectedShape.getVisible()&&A.map.fitBounds(A.selectedShape.bounds),A.shouldBound=!0),A.lastSelectedLeafId=A.polygons[e].Id)}),A.myTreeView.attachEvent("onCheck",S)})}),A.toggleDrawMode=function(){var e,t;A.drawState!=p.INTERSECT&&(A.drawingManager.setDrawingMode("polygon"),b(),e=A.selectedColor,(t=A.drawingManager.get("polygonOptions")).fillColor=e,A.drawingManager.set("polygonOptions",t),A.drawState=p.DRAW)},A.cancelPolygon=function(){null!=A.drawingManager.getDrawingMode()&&(A.cancelDrawingShape=!0,A.drawingManager.setDrawingMode(null)),A.drawState==p.EDIT&&A.selectedShape&&(A.selectedShape.setMap(null),s(function(){A.currentEditPolygon&&T(A.currentEditPolygon),A.polygonName="",A.polygonTerritory="null"},0)),A.drawState=p.NONE,A.selectedIntersectingPolygons={}},A.editPolygon=function(){A.drawState==p.SELECTED&&A.selectedShape.getVisible()&&(A.currentEditPolygon=A.polygons[A.selectedShape.id],A.drawState=p.EDIT,A.selectedShape.setEditable(!0),A.selectedShape.setDraggable(!0))},A.savePolygon=function(){var i,n,e,t,s,r;A.selectedShape&&(i=[],A.selectedShape.getPath().forEach(function(e,t){i.push({lat:e.lat(),lng:e.lng()})}),n=A.selectedShape.id||null,e="null"!=A.polygonTerritory?A.polygonTerritory:null,A.polygonName?(o.callRemoteAction(RemoteActions.savePolygon,(t=i,s=A.selectedShapeColor,'<?xml version="1.0" encoding="UTF-8"?> \n                            <kml xmlns="http://www.opengis.net/kml/2.2">\n                                <Style id="'+(r=A.polygonName).replace(" ","")+'Style"> \n                                    <LineStyle> \n                                        <width>1</width> \n                                    </LineStyle> \n                                    <PolyStyle> \n                                        <color>'+function(e,t){return t+e.substring(5,7)+e.substring(3,5)+e.substring(1,3)}(s,80)+"</color> \n                                    </PolyStyle> \n                                </Style> \n                                <Placemark> \n                                    <name>"+r.replace(" ","")+"</name> \n                                    <styleUrl>#"+r.replace(" ","")+"Style</styleUrl> \n                                    <Polygon> \n                                        <outerBoundaryIs> \n                                            <LinearRing>\n                                                <coordinates>"+function(e){for(var t="",i=0;i<e.length;i++)t+=e[i].lng+","+e[i].lat+",0\n";return t+=e[0].lng+","+e[0].lat+",0"}(t)+"</coordinates> \n                                            </LinearRing> \n                                        </outerBoundaryIs> \n                                    </Polygon> \n                                </Placemark> \n                            </kml>"),A.polygonName,A.selectedShapeColor,e,n).then(function(e){A.selectedShape.setMap(null),T(e);var t=e,i=n;i&&A.myTreeView.deleteItem(i),i=t[fieldNames.Polygon.Service_Territory__c]||"NoTerritoryPolygon",A.myTreeView.addItem(t.Id,t.Name,i),A.myTreeView.checkItem(t.Id),A.myTreeView.setItemIcons(t.Id,{file:"fa-square"}),A.myTreeView.setIconColor(t.Id,t[fieldNames.Polygon.Color__c]),A.selectedShape=A.polygons[e.Id].polygon}),A.drawState=p.NONE):alert(customLabels.Polygon_name_field_is_empty))},A.deletePolygon=function(){var t;A.selectedShape?confirm(customLabels.This_will_delete_the_selected_polygon.replaceAll(A.selectedShape.name))&&(t=A.selectedShape.id||null,o.callRemoteAction(RemoteActions.deletePolygon,t).then(function(e){A.selectedShape.setMap(null),A.myTreeView.deleteItem(t),b()}),A.drawState=p.NONE):A.drawState=p.NONE};var L={},F=[],M=void 0;function P(e,t){t=t||{},this.setMap(e),this.mapDiv=e.getDiv(),this.menuItems=t.menuItems||{},this.isVisible=!1}function x(e){M.hide(),w(this.clickedPolygon_=this);e=M.getProjection().fromLatLngToDivPixel(e.latLng);M.show(e),A.map.setOptions({draggableCursor:"pointer"})}function E(e){for(var t=[],i=0;i<A.filteredServices.servicesArray.length;i++){var n,s=A.filteredServices.servicesArray[i];null!=s.latitude&&null!=s.longitude&&(n=new google.maps.LatLng(s.latitude,s.longitude),google.maps.geometry.poly.containsLocation(n,e)&&t.push(s.id))}return t}(P.prototype=new google.maps.OverlayView).onAdd=function(){$("<div id='cMenu' class='context-menu-polygon'></div>").appendTo($("#map"));for(var e=$("#cMenu").get(0),t=0;t<this.menuItems.length;t++){var i=this.menuItems[t];$('<div id="'+i.id+'" class="truncate context-menu-polygon-item" title="'+i.name+'">'+i.label+"</div>").appendTo(e)}this.div_=e;this.getPanes().overlayMouseTarget.appendChild(this.div_);for(var r=this,t=0;t<this.menuItems.length;t++){i=this.menuItems[t];google.maps.event.addDomListener($("#"+i.id).get(0),"click",$.proxy(function(){r.clickedItem=this.id,google.maps.event.trigger(r,"click")},i))}google.maps.event.addListener(r,"click",function(){var e=r.clickedItem;switch(e){case"menu-edit-polygon":A.mapOptionsToggle=!0,$(".polygonsTab").click(),A.editPolygon();break;case"menu-intersect-polygon":A.mapOptionsToggle=!0,$(".polygonsTab").click(),A.currentIntersectingId=angular.copy(A.selectedShape.id),A.drawState=p.INTERSECT,A.$apply();break;case"menu-delete-polygon":A.deletePolygon();break;case"menu-schedule-polygon":l.schedule(E(A.selectedShape)),A.$apply();break;case"menu-unschedule-polygon":a.unscheduleServices(E(A.selectedShape));break;case"menu-dispatch-polygon":a.changeStatus(E(A.selectedShape),m.DISPATCHED).then(function(e){a.drawServicesAndAbsences(e.services)}).catch(function(e){I.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)});break;case"menu-joepardy-polygon":a.setInJeopardy(E(A.selectedShape));break;default:if(0===e.indexOf("custom_")){var t=parseInt(e.split("_")[1]),i=E(A.selectedShape),n=I.getCustomActions("map")[t];if(n.visualforce){var t=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),s=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear();1===i.length?h.open(n.name,n.visualforce+"?id="+i[0]+"&start="+t+"&end="+s):h.open(n.name,n.visualforce+"?services="+i.join(",")+"&start="+t+"&end="+s);break}o.callRemoteAction(RemoteActions.runCustomServiceAction,n.className,E(A.selectedShape),scheduler._min_date,scheduler._max_date).then(function(e){e&&I.addNotification(n.name,e,null,null)}).catch(function(e){return I.addNotification(n.name,e.message,null,null)});break}}event.stopPropagation(),M.hide()})},P.prototype.draw=function(){},P.prototype.onRemove=function(){this.div_.parentNode.removeChild(this.div_),this.div_=null},P.prototype.hide=function(){this.div_&&(this.div_.style.visibility="hidden")},P.prototype.show=function(e){var t;this.div_&&((t=this.div_).style.left=e.x+5+"px",t.style.top=e.y+10+"px",this.div_.style.visibility="visible")},A.hasCustomPermission("Polygons_create_update")&&F.push({id:"menu-intersect-polygon",className:"context_menu_item",eventName:"intersect",label:I.getSVGIconHTML(lsdIcons.cut)+customLabels.Cut_Intersections,name:customLabels.Cut_Intersections}),A.hasCustomPermission("Bulk_Schedule")&&F.push({id:"menu-schedule-polygon",className:"context_menu_item",eventName:"schedule",label:I.getSVGIconHTML(lsdIcons.calendar)+customLabels.Schedule,name:customLabels.Schedule}),A.hasCustomPermission("Bulk_Unschedule")&&F.push({id:"menu-unschedule-polygon",className:"context_menu_item",eventName:"unschedule",label:I.getSVGIconHTML(lsdIcons.na)+customLabels.Unschedule,name:customLabels.Unschedule}),A.hasCustomPermission("Bulk_Dispatch")&&F.push({id:"menu-dispatch-polygon",className:"context_menu_item",eventName:"dispatch",label:I.getSVGIconHTML(lsdIcons.dispatch)+customLabels.Dispatch,name:customLabels.Dispatch}),F.push({id:"menu-joepardy-polygon",className:"context_menu_item",eventName:"joepardy",label:I.getSVGIconHTML(lsdIcons.jeopardy)+customLabels.In_Jeopardy,name:customLabels.In_Jeopardy}),A.hasCustomPermission("Polygons_create_update")&&F.push({id:"menu-delete-polygon",className:"context_menu_item",eventName:"delete",label:I.getSVGIconHTML(lsdIcons.delete)+customLabels.Delete_polygon,name:customLabels.Delete_polygon}),L.menuItems=F,I.customActionsPromise.then(function(){I.getCustomActions("map").forEach(function(e,t){F.push({id:"custom_"+t,className:"context_menu_item",eventName:"custom_"+t,label:e.icon?I.getSVGIconHTML(e.icon)+e.name:e.name,name:e.name})})}),A.getIntersectionsForPolygons=function(){if(!A.isEmpty(A.selectedIntersectingPolygons))try{var e,t=new jsts.io.WKTReader,i=t.read(A.selectedShape.ToWKT());for(e in A.selectedIntersectingPolygons)var n=t.read(A.polygons[e].polygon.ToWKT()),i=i.difference(n);for(var s=(new jsts.io.WKTWriter).write(i),r=s.slice(9,s.length-2).split(","),o=[],a=0;a<r.length;a++){var l=r[a].split(" ");o.push(new google.maps.LatLng({lat:parseFloat(l[1]),lng:parseFloat(l[0])}))}A.selectedShape.setPath(o),A.savePolygon(),A.selectedIntersectingPolygons={}}catch(e){alert("Problem finding intersections in given polygons."),console.error(e)}}}]),angular.module("serviceExpert").controller("ctrlRightSide",["$q","$scope","$rootScope","$filter","$sce","$injector","sfdcService","MapService","utils","servicesService","kpiCalculationsService","StateService","DeltaService","TimePhasedDataService","StreamingAPIService","RegisterService","OptimizationRequestsService","LeftSideLocationFilteringService","FieldSetFieldsService",function(e,i,t,n,s,r,o,a,l,c,d,u,m,p,h,g,v,f,S){var _={opacity:1,left:null,top:null,height:400,width:600};i.isMapEnabled=u.isMapEnabled(),i.startLoadMap=!0,i.servicesObjects=c.servicesObjects,i.servicesScheduledToCapacity={},i.notifications=l.butlerNotifications,i.unreadNotifications=0,i.showServiceList=l.showServiceList,i.workingState="gantt",i.openConsoleTab=l.openConsoleTab,i.openSObjectLink=l.openSObjectLink,i.activeRequests=o.activeRequests,i.activeRuleCheckRequests=o.activeRuleCheckRequests,i.kpi=d.kpis,i.marginLeftForBox=0,i.mapAvailable=mapMode,i.optimizationRequests=v.optimizationRequests,i.floatingMapOn=!1,i.optRequestPercentage=0,i.OptimizationRequestsProgressStatus=v.OptimizationRequestsProgressStatus,i.generateRequestResultText=v.generateRequestResultText,i.canAbortOR=v.canAbortOR,i.abortOptRequest=v.abortOptRequest,i.isUseEdge=l.isUseEdge,i.isNoTerritoryLoadded=f.isNoTerritoryLoadded,i.reachedMaxRows=p.reachedMaxRows,i.maxResourceRowsOnGantt=window.__gantt.maxResourceRowsOnGantt,i.isLoadingNewLocations=function(){return u.isLoadingNewLocations},window.isOptimizationViewer&&(c=r.get("LoadOptiViewerDataService"),i.isOptimizationLoaded=c.isOptimizationLoaded,i.isShowingOutputJson=c.isShowingOutputJson),i.$watch("workingState",function(e){"gantt"===e&&setTimeout(function(){scheduler._is_initialized()&&updateViewDebounced()},0)}),S.fieldsSetFields().then(function(e){i.serviceFields=e.MapInfo}),i.getServiceInfoRowClass=l.getServiceInfoRowClass,i.openLink=l.openLink,i.order=function(e,t){i.orderByField=e,i.reverse=t},i.$on("changeWorkingState",function(e,t){"gantt"===(i.workingState=t)?setTimeout(function(){updateViewDebounced()},100):$(".dhtmlXTooltip").remove()}),i.showNotifications=function(){i.unreadNotifications=0,l.butlerNotifications().forEach(function(e){return e.unread=!1})},i.calcUnreadNotifications=function(){return i.unreadNotifications=0,l.butlerNotifications().forEach(function(e){e.unread&&i.unreadNotifications++}),i.unreadNotifications},i.numOfNotifications=function(){var t=0;return l.butlerNotifications().forEach(function(e){e.show&&t++}),t},i.formatTravel=function(e){var t=Math.floor(e/60/60),e=Math.floor(e/60%60);return t+customLabels.kpi_h+" "+e+customLabels.kpi_m},i.toggleServiceList=function(){i.showServiceList.show=!0,setTimeout(function(){updateViewDebounced(),t.$broadcast("resizeMap",{})},830)},i.isEmpty=function(e){return Object.keys(e).length},i.getRequestCss=function(e){switch(e){case"Hold":case"Post Processing":case"In Progress":return"smart_in_progress";case"Completed":return"smart_completed";case"Completed First Optimization Day":return"smart_completed_first_day";case"Finalizing":return"smart_finalizing";case"Failed":return"smart_failed";case"Open":return"smart_open";case"Queued":return"smart_queued";case"Aborting":return"smart_in_progress";case"Aborted":return"smart_failed"}},i.moveLocalDtToUserTimezoneDt=function(e){e=new Date(e);return l.convertDateBetweenTimeZones(e,"GMT",userTimeZone)},i.getNumOfRunningRequests=function(){return v.getNumOfActiveOptimizationRequests()},i.openSomethingBox=function(e,t){i.marginLeftForBox="smart"===t?e.target.offsetLeft-227:e.target.offsetLeft-200},i.shouldShowLongTermError=function(){return"LongView"===scheduler._mode&&"gantt"===i.workingState&&(window.__gantt.reachedMaxNumberOfServicesInLongView||window.__gantt.reachedMaxNumberOfAbsencesInLongView)},window.__gantt.shouldShowLongTermError=i.shouldShowLongTermError,i.showFloatingMap=function(e){e.stopPropagation(),i.floatingMapOn=!0;e=$("#MapContainer");e.css("opacity",_.opacity),e.css("height",_.height+"px"),e.css("width",_.width+"px"),_.left&&(e.css("left",_.left+"px"),e.css("top",_.top+"px"),e.css("bottom","auto"))},i.changeWorkingState=function(e){e!==i.workingState&&(i.workingState=e,i.floatingMapOn=!1,"map"===e?$("#MapContainer").removeAttr("style").resizable("disable"):$("#MapContainer").removeAttr("style").resizable("enable"))},i.closeFloatingMap=function(){i.floatingMapOn=!1,$("#MapContainer").removeAttr("style").resizable("disable")},setTimeout(function(){$("#MapContainer").draggable({handle:"#FloatingMapControls",containment:"document",start:function(){},stop:function(e,t){_.left=t.position.left,_.top=t.position.top}}).resizable({maxHeight:window.innerHeight-75,maxWidth:window.innerWidth-75,minHeight:300,minWidth:450,handles:"all",containment:"document",distance:10,start:function(){},stop:function(e,t){_.width=t.size.width,_.height=t.size.height,_.left=t.position.left,_.top=t.position.top}}),$("#FloatingMapOpacity").slider({range:"min",min:40,max:100,value:100,slide:function(e,t){$("#MapContainer").css("opacity",t.value/100),_.opacity=t.value/100}})},2e3)}]),angular.module("serviceExpert").controller("serviceListCtrl",["$scope","$compile","$rootScope","$filter","utils","$timeout","$sce","servicesService","sfdcService","ResourcesAndTerritoriesService","GetSlotsService","userSettingsManager","StateService","TimePhasedDataService","LoadServiceListService","FieldSetFieldsService","ServiceAppointmentLightboxService","ServiceSelectorService","SERVICE_STATUS","SERVICE_CATEGORY","DeltaService","RegisterService","GanttFilterService","GeneralLightbox","LeftSideLocationFilteringService","$q","BundleService","BundleActions","listQuickActionsService",function(r,N,s,n,o,d,G,a,l,c,t,u,m,e,p,B,H,i,h,g,v,f,S,y,b,V,w,T,U){r.bundleService=w,r.bundlerActions=T,r.isRtlDir=m.isRtlDirection(),r.tooltipDirection=r.isRtlDir?"left-bottom":"right";var L=!0;function A(e){delete r.filtersMap[e];for(var t=-1,i=0;i<r.filterOptions.length;i++)if(r.filterOptions[i].Id===e){t=i;break}-1!==t&&r.filterOptions.splice(t,1),r.filter.selectedFilter="All",u.GetUserSettingsProperty("Selected_List_View__c")!==r.filter.selectedFilter&&u.SetUserSettingsProperty("Selected_List_View__c",r.filter.selectedFilter)}angular.element(document).ready(function(){var l=!1,c=r.isRtlDir;function e(){var e,t,i=u.GetUserSettingsProperty("Left_Panel_Width_Percentage__c"),n=400,s=$("#contentWrapper"),r=u.GetUserSettingsProperty("Services_List_Height_Percentage__c"),o=250,a=$("#SmartPanelContainer");0===s.length&&(s=$(window)),0===a.length&&(a=$(window)),0!=!s.width()||l||(l=!0,i=(n=(n=null!=i&&0<i&&i<100?s.width()*i*.01:n)<400?400:n)+3,c?(e=document.getElementById("LeftSideContainer"),t=document.getElementById("RightSideContainer"),e.before(t),$("#LeftSideContainer").width("calc(100% - "+i+"px)"),Split(["#RightSideContainer","#LeftSideContainer"],{sizes:[n+"px"],minSize:[700,400],snapOffset:10,gutterSize:3,onDragEnd:function(){updateViewDebounced();var e=$(c?"#RightSideContainer":"#LeftSideContainer").width()/s.width();u.SetUserSettingsProperty("Left_Panel_Width_Percentage__c",e*=100)}})):($("#RightSideContainer").width("calc(100% - "+i+"px)"),Split(["#LeftSideContainer","#RightSideContainer"],{sizes:[n+"px"],minSize:[400,700],snapOffset:10,gutterSize:3,onDragEnd:function(){updateViewDebounced();var e=$(c?"#RightSideContainer":"#LeftSideContainer").width()/s.width();u.SetUserSettingsProperty("Left_Panel_Width_Percentage__c",e*=100)}}))),d(function(){var e,t;100!==a.height()&&(e=(o=250<(o=null!=r&&0<r&&r<100?a.height()*r*.01:o)?250:o)+5,$("#ServiceListBottomContainer").height("calc(100% - "+e+"px"),e=a.height()-250,(t=a.find(".gutter-vertical")).length&&t.remove(),Split(["#ServiceListTopContainer","#ServiceListBottomContainer"],{direction:"vertical",sizes:[o+"px"],minSize:[5,e],snapOffset:10,gutterSize:5,onDragEnd:function(){var e=$("#ServiceListTopContainer").height()/a.height();u.SetUserSettingsProperty("Services_List_Height_Percentage__c",e*=100)}}))},0)}e(),$(window).bind("resize",e)}),"territories"===u.GetUserSettingsProperty("DefaultLeftPanel__c")&&u.GetUserSettingsProperty("locations").length&&b.open(),useNewFilters&&S.filtersPromise.then(function(e){var n=[];r.filterOptions.forEach(function(e){var t,i={};for(t in e)i[t]=e[t];i.Name=e.name,i.old=!0,i.Id=e.value,n.push(i)}),r.filterOptions=[].concat(n,_toConsumableArray(e)),r.filtersMap={},r.filterOptions.forEach(function(e){return r.filtersMap[e.Id]=e})}).finally(function(){r.filterOptions.sort(function(e,t){return e.Name>t.Name?1:e.Name<t.Name?-1:0}),S.setFilterMap(r.filtersMap)}),window.__closeFilterLightbox=function(t){o.safeApply(r,function(){var e=y.closeLightboxFromOutside();e&&e(),t&&S.getFilterFromSalesforce(t).then(function(e){if(r.filtersMap[e.Id]){for(var t=0;t<r.filterOptions.length;t++)if(r.filterOptions[t].Id===e.Id){r.filterOptions[t]=e;break}}else r.filterOptions.push(e),r.filterOptions.sort(function(e,t){return e.Name>t.Name?1:e.Name<t.Name?-1:0});r.filtersMap[e.Id]=e})})},r.openGanttFilterLightbox=function(e){var t=r.filtersMap[r.filter.selectedFilter];switch(e){case"new":y.open(customLabels.FilterEditor,filterEditorPage);break;case"edit":y.open(customLabels.FilterEditor,filterEditorPage+"?&id="+t.Id);break;case"delete":if(!confirm(customLabels.ConfirmFilterDelete))return;S.deleteFilter(t.Id).then(A);break;case"hide":if(!confirm(customLabels.ConfirmFilterHide))return;S.hideFilter(t.Id).then(A)}},r.showNewFilterButton=function(){return customPermissions.Create_custom_Gantt_filters},r.showEditFilterButton=function(){if(!r.filtersMap)return!1;var e=r.filtersMap[r.filter.selectedFilter];return!(!e||e.old)&&(!(!customPermissions.Create_custom_Gantt_filters||customPermissions.Publish_custom_Gantt_filters||e.CreatedById!==userId)||!!customPermissions.Publish_custom_Gantt_filters)},r.showDeleteFilterButton=function(){if(!r.filtersMap)return!1;var e=r.filtersMap[r.filter.selectedFilter];return!(!e||e.old)&&(customPermissions.Create_custom_Gantt_filters&&e.CreatedById===userId)},r.showHideFilterButton=function(){if(!r.filtersMap)return!1;var e=r.filtersMap[r.filter.selectedFilter];return!(!e||e.old)&&(customPermissions.Publish_custom_Gantt_filters&&customPermissions.Create_custom_Gantt_filters)},r.newFilterChanged=function(){if("SearchOnServer"!==r.filterOptions[r.filterOptions.length-1].Id)if("SearchOnServer"!==r.filter.selectedFilter.Id&&"SearchOnServer"===r.filterOptions[r.filterOptions.length-1].Id&&r.filterOptions.pop(),useNewFilters){if(!r.filtersMap)return!1;var e,t,i=r.filtersMap[r.filter.selectedFilter]||r.filtersMap.All;r.filtersMap[r.filter.selectedFilter]||(r.filter.selectedFilter="All",i.selectedFilter="All"),u.GetUserSettingsProperty("Selected_List_View__c")!==r.filter.selectedFilter&&u.SetUserSettingsProperty("Selected_List_View__c",r.filter.selectedFilter),!i||i.old?r.loadServiceAppointmentsToList():r.filtersMap&&(i=r.filtersMap[r.filter.selectedFilter])&&!i.old&&(e=new Date(r.filter.endDate),t=new Date(r.filter.endDate),"Invalid Date"===r.filter.endDate.toString()&&(e=new Date(scheduler._max_date),t=new Date(scheduler._max_date)),i.List_only_appointments_on_the_gantt?(e=scheduler._min_date,t=scheduler._max_date):(e.setDate(e.getDate()-i.Days_before_horizon-1),t.setDate(t.getDate()+i.Days_after_horizon)),k(t,Math.ceil((t-e)/1e3/60/60/24),[]))}else r.loadServiceAppointmentsToList()},r.fieldsTypes=o.fieldsTypes,r.openConsoleTab=o.openConsoleTab,r.useNewFilters=window.useNewFilters,r.isMapEnabled=m.isMapEnabled(),r.contractorSupport=m.areContractorsSupported(),r.statuses=h,r.statusCategory=g,r.statusTranslations=o.statusTranslations,r.pinnedStatusesSF=CustomSettings.pinnedStatusesSF,r.ganttSettings=o.ganttSettings,r.showServiceList=o.showServiceList,r.hasCustomPermission=o.hasCustomPermission,r.isLightning=o.isLightning,r.loadingServicesToList=0,r.isServicePreviewAvailable=!1,r.isOptimizationEnabled=isOptimizationEnabled,r.bulkActionsOrder=bulkActionsOrder,r.isInConsole=m.isInConsole,r.matchGantt=u.GetUserSettingsProperty("Match_Gantt_Dates__c"),r.fullScreen=!1,window.location.search.match(/[&?]fullScreen=(\d)/)&&(r.fullScreen="1"===window.location.search.match(/[&?]fullScreen=(\d)/)[1]?"0":"1"),r.servicesObjects=e.serviceAppointments,r.selectedServiceId=null,r.lastSelectedServiceId=null,r.servicesListVisitedDays={},r.servicesListInited=!1;var I={},C=[];function k(t,i,n){var e=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;if(null===e&&(k.loadedSoFar=0),k.loadedSoFar>=maxNumberOfServicesToLoad)return o.addNotification(customLabels.Too_Many_Services_Header_Services_List,customLabels.Too_Many_Services_Services_List),void(k.loadedSoFar=0);r.loadingServicesToList++,p.loadServicesInBulk(r.servicesObjects(),r.servicesListVisitedDays,t,i,e).then(function(e){e.totalFetched===numberOfServicesToLoadInEachBulk?(k.loadedSoFar+=e.totalFetched,n.push.apply(n,_toConsumableArray(e.needToCheckRules)),k(t,i,n,e.lastFetchedId)):e.scheduledServices&&(n.push.apply(n,_toConsumableArray(e.needToCheckRules)),0<n.length&&"Always"===window.__gantt.checkRulesMode&&a.checkRules(n).then(a.drawViolationsOnGantt)),window.splunkLoggingFinestFlagEnabled&&L&&(e=k.loadedSoFar+e.totalFetched,L=!1,l.callRemoteAction(RemoteActions.sendDataToSplunk,"serviceListCount",null,null,null,e,null))}).catch(function(e){console.warn("loadServiceAppointmentsToList failed "+e)}).finally(function(){return r.loadingServicesToList--})}function D(){var e=scheduler.getState().max_date;return 0===e.getHours()&&0===e.getMinutes()?e=new Date(e.getTime()-6e4):(e.setHours(23),e.setMinutes(59),e.setSeconds(0)),e}r.flagged=a.flagged,r.loadedTerritories=[],r.selectorService=i,r.servicesSelection=r.selectorService.SelectedServices,r.selectedPolicy=null,r.policyOptions=[],r.showGanttSettings=!1,r.ganttSettingDraft=null,r.hours24=[24,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],r.reallyHideList=!1,r.showAdvancedFilter=!1,r.invokedAction={},r.invokedActionFor={},r.showCustomFilterDropdown=!1,r.storageFilters=null,r.prevEndDate=null,r.sortingColumn="start",r.sortingColumnName={start:customLabels.Start_time,finish:customLabels.Finish_time,accountName:customLabels.Account,serviceTypeName:customLabels.Service_type,priority:customLabels.Priority,resourceName:customLabels.Resource,earlyStart:customLabels.Early_start,dueDate:customLabels.Due_date,locationName:customLabels.Location},r.selectedDates={earlyStart:customLabels.Early_start,dueDate:customLabels.Due_date,appStart:customLabels.Appointment_start,appEnd:customLabels.Appointment_finish,start_date:customLabels.Start,end_date:customLabels.Finish},r.filter=a.filter,r.orderByField=a.filter.orderByField,r.reverse=a.filter.reverse,r.filteredServices=a.filteredServices,r.filterOptions=[],o.hasCustomPermission("Service_List_Todo")&&r.filterOptions.push({name:customLabels.Todo,value:"Todo"}),r.filterOptions.push({name:customLabels.AllServices,value:"All"}),r.filterOptions.push({name:customLabels.Recently_used,value:"Recent"}),o.hasCustomPermission("Service_List_Flagged")&&r.filterOptions.push({name:customLabels.Flagged,value:"Flagged"}),o.hasCustomPermission("Service_List_Selected")&&r.filterOptions.push({name:customLabels.Selected_Capital,value:"Selected"}),o.hasCustomPermission("Service_List_Unscheduled")&&r.filterOptions.push({name:customLabels.UnscheduledCapital,value:"Unscheduled"}),o.hasCustomPermission("Service_List_Scheuled")&&r.filterOptions.push({name:customLabels.Scheduled,value:"Scheduled"}),o.hasCustomPermission("Service_List_In_Jeopardy")&&r.filterOptions.push({name:customLabels.In_Jeopardy,value:"inJeopardy"}),o.hasCustomPermission("Service_List_Rule_Violating")&&r.filterOptions.push({name:customLabels.Rules_violating,value:"Violating"}),o.hasCustomPermission("Service_List_Gantt")&&r.filterOptions.push({name:customLabels.Gantt,value:"Gantt filter"}),o.hasCustomPermission("Service_List_Canceled")&&r.filterOptions.push({name:customLabels.Cancelled,value:"Cancelled filter"}),m.areContractorsSupported()&&o.hasCustomPermission("Service_List_Contractors")&&r.filterOptions.push({name:customLabels.Contractors,value:"Contractors filter"}),m.areCrewsSupported()&&o.hasCustomPermission("Service_List_Crews")&&r.filterOptions.push({name:customLabels.crews,value:"Crews filter"}),w.isActive()&&o.hasCustomPermission("Service_List_Exclude_Bundle_Members")&&r.filterOptions.push({name:customLabels.Exclude_Bundle_Members_Filter,value:"Exclude Bundle Members"}),B.fieldsSetFields().then(function(e){for(var t in I=e,Array.isArray(e.servicePreview)&&0<e.servicePreview.length&&(r.isServicePreviewAvailable=!0),e)e[t].forEach(function(e){C[e.FullAPIName]=e});r.clickedServiceFieldPairs=[];for(var i=0;i<e.ListExpanded.length;){for(var n=i+2,s=[];i<e.ListExpanded.length&&i<n;i++)s.push(e.ListExpanded[i]);r.clickedServiceFieldPairs.push(s)}}),r.getColumnsToDisplay=function(){var t,e=S.getFilterById(r.filter.selectedFilter);return e&&e.Displayed_Fields&&0<e.Displayed_Fields.length?(t=[],e.Displayed_Fields.forEach(function(e){C[e]&&t.push(C[e])}),t):I.ListColumns},r.getSingleTaskColumnClass=function(e){var t={SingleTaskColumn:!0,truncate:!0};return t["Field-"+e.Type]=!0,t},r.getHeaderTaskColumnClass=function(e){var t={SortingTasksListColumn:!0};return t["Field-"+e.Type]=!0,t},r.loadServiceAppointmentsToList=function(){k(r.endDate,o.ganttSettings.backHorizon,[])},r.formatServiceField=function(e,t){var i=e[t.APIName];switch(t.Type){case o.fieldsTypes.DateTime:i=n("amDateFormat")(i,"lll");break;case o.fieldsTypes.Date:i=n("amDateFormat")(i,"L")}return i},r.getRefFieldID=function(e,t){return e[t.JsAPIName.replace("__r","__c")]},r.isFieldEmpty=function(e,t){return void 0===n("displayFieldSetField")(e,t)},r.openCalendarAdvanceFilterStart=function(){r.IsCustomFilterReadonly||(scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"calendarMin",date:new Date(r.filter.endDate),navigation:!0,handler:function(e,t){o.safeApply(r,function(){e>new Date(r.filter.advancedFilter.maxDate)?alert(customLabels.startBeforeEnd):r.filter.advancedFilter.minDate=e}),scheduler.destroyCalendar()}}))},r.openCalendarAdvanceFilterFinish=function(){r.IsCustomFilterReadonly||(scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"calendarMax",date:new Date(r.endDate),navigation:!0,handler:function(e,t){o.safeApply(r,function(){e<new Date(r.filter.advancedFilter.minDate)?alert(customLabels.startBeforeEnd):r.filter.advancedFilter.maxDate=e}),scheduler.destroyCalendar()}}))},r.openCalendarAdvanceFilterStart=function(){r.IsCustomFilterReadonly||(scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"calendarMin",date:new Date(r.filter.endDate),navigation:!0,handler:function(e,t){o.safeApply(r,function(){e>new Date(r.filter.advancedFilter.maxDate)?alert(customLabels.startBeforeEnd):r.filter.advancedFilter.minDate=e}),scheduler.destroyCalendar()}}))},m.promises.policies().then(function(e){r.policyOptions=e;for(var t=!1,i=u.GetUserSettingsProperty("Gantt_Policy__c"),n=0;n<e.length;n++)if(i){if(e[n].Id===i){r.selectedPolicy=e[n],t=!0;break}}else if(e[n].Id===defaultPolicy){r.selectedPolicy=e[n],t=!0;break}t||(r.selectedPolicy=r.policyOptions[0]),m.selectedPolicyId=r.selectedPolicy.Id}).catch(function(e){console.warn(e),cantLoadGantt(customLabels.no_policy_found)}),r.showGlobalCheckRules=function(){return window.customPermissions.Enable_Check_Rules_For_All_Services},r.checkRulesForAllServices=function(){if("Always"!==window.__gantt.checkRulesMode){var e,t=[];for(e in scheduler._events)"service"===scheduler._events[e].type&&t.push(e);0<t.length&&a.checkRules(t).then(a.drawViolationsOnGantt)}},r.changePolicy=function(){if(m.selectedPolicyId=r.selectedPolicy.Id,u.SetUserSettingsProperty("Gantt_Policy__c",r.selectedPolicy.Id),"Always"===window.__gantt.checkRulesMode){var e,t=[];for(e in scheduler._events)"service"===scheduler._events[e].type&&t.push(e);0<t.length&&a.checkRules(t).then(a.drawViolationsOnGantt)}},r.policySelectorDisabled=function(){return!window.__gantt.ignoreReadonlyGantt226&&!window.customPermissions.Enable_Gantt_Policy_Picker||0===r.policyOptions.length},r.order=function(e,t){r.filter.orderByField=e,r.filter.reverse=t},r.selectService=function(e){e===r.selectedServiceId?(r.selectedServiceId=null,r.lastSelectedServiceId=e):(r.lastSelectedServiceId=r.selectedServiceId,r.selectedServiceId=e)},r.violationsTooltip=function(e){if(!e.violations&&!e.jeopardy){if(w.isBundleMember(e))return customLabels.BundleMemberToolTip;if(w.isBundle(e))return customLabels.BundleToolTip;if(e.isMDT)return customLabels.Multi_Day_Service}if(e.violations||e.jeopardy){if(e.jeopardy&&e.jeopardyReason)return e.jeopardyReason;if(e.violations){for(var t="",i=0;i<e.violations.length;i++)t+=e.violations[i].RuleName+"\n";return t=t&&t.substring(0,t.length-1)}}},r.getStatusClass=function(e){return o.getCSSClassForContext(e.statusCategory,g)},r.$on("initCompleted",function(e){r.initEndDate();var t=u.GetUserSettingsProperty("locations");r.territories=[];for(var i=0;i<t.length;i++)void 0!==c.territories()[t[i]]&&r.territories.push(c.territories()[t[i]]);if(!useNewFilters){r.storageFilters=O();for(var n=0;n<r.storageFilters.length;n++)r.filterOptions.push({name:r.storageFilters[n].name,value:r.storageFilters[n].name});0<r.storageFilters.length?M(r.storageFilters[0].name):M(null)}}),r.initEndDate=function(){r.endDate=D(),r.matchGantt||(r.endDate=o.addDaysToDate(r.endDate,1)),r.prevEndDate=r.endDate,r.filter.endDate=r.endDate,r.horizonDateChanged()},r.horizonDateChanged=function(){var e;moment(r.filter.endDate).isValid()&&(e=o.addDaysToDate(r.filter.endDate,-o.ganttSettings.backHorizon),m.setDeltaDates(e,r.filter.endDate))},r.$on("ganttFinishedLoadingServices",function(){!r.matchGantt&&!1!==r.servicesListInited||(r.servicesListInited||null!==r.endDate&&!isNaN(r.endDate.getTime())||r.initEndDate(),r.servicesListInited=!0,r.newFilterChanged())}),scheduler.attachEvent("onBeforeViewChange",function(e,t){return scheduler._old={mode:e,date:t},!0});var R=!0;function O(){return u.GetUserSettingsProperty("Filters__c")?JSON.parse(u.GetUserSettingsProperty("Filters__c")):[]}function F(){u.SetUserSettingsProperty("Filters__c",JSON.stringify(r.storageFilters))}function M(e){if(r.lastSelectedFilter=e){for(var t=0;t<r.storageFilters.length;t++)r.storageFilters[t].name===e&&(r.filter.advancedFilter=angular.copy(r.storageFilters[t].filter));r.customFilterName=e,r.DisplayComboBowArrow=!0,r.IsCustomFilterReadonly=!0,r.displayNew=!0,r.displayEdit=!0,r.displayDelete=!0}else r.filter.advancedFilter=P(),r.customFilterName="",r.DisplayComboBowArrow=!1,r.IsCustomFilterReadonly=!0,r.displayNew=!0,r.displayEdit=!1,r.displayDelete=!1}function P(){var t={statusCheckboxs:{},minDate:new Date,maxDate:new Date,servicePriority:10,unScheduled:!0,violations:!0,jeopardies:!0,noLocation:!0,locationsCheckboxs:{}};if(0<Object.keys(r.statusTranslations).length)for(var e in r.statusTranslations)t.statusCheckboxs[r.statusTranslations[e]]=!0;else s.$on("gotStatuses",function(){for(var e in r.statusTranslations)t.statusCheckboxs[r.statusTranslations[e]]=!0});for(var i=0;i<r.territories.length;i++){var n=r.territories[i];t.locationsCheckboxs[n.name]=!0}return t}scheduler.attachEvent("onViewChange",function(e,t){scheduler._old.mode===e&&t===scheduler._old.date&&"LongView"!==scheduler._mode&&"MonthlyView"!==scheduler._mode||m.isLoadingNewLocations||(m.setDeltaDates(scheduler.getState().min_date,D()),o.safeApply(r,function(){var e;r.matchGantt&&(e=D(),r.filter.endDate=e,r.endDate=e,r.matchGantt&&!R?r.newFilterChanged():R=!1)}))}),r.matchGanttClicked=function(){var e;r.matchGantt?("Invalid Date"===(e=r.prevEndDate).toString()&&(e=scheduler._min_date),r.filter.endDate=e,r.endDate=e,u.SetUserSettingsProperty("Match_Gantt_Dates__c",!1)):(r.prevEndDate=r.endDate,r.filter.endDate=D(),r.endDate=r.filter.endDate,u.SetUserSettingsProperty("Match_Gantt_Dates__c",!0)),r.newFilterChanged()},r.openLightBox=function(e){a.recentlyUsed[e]=!0,H.open(e)},r.flagging=function(e){if(!a.flagged[e])return a.flagged[e]=!0,void scheduler.updateEvent(e);a.flagged[e]&&(a.flagged[e]=!a.flagged[e],scheduler.updateEvent(e))},r.showOnGantt=function(e){var t=!(a.recentlyUsed[e.id]=!0);e&&((e=w.verifyShowSaOnGantt(e))?a.recentlyUsed[e.id]=!0:t=!0),t||!scheduler._events[e.id]?alert(customLabels.location_not_loaded):"none"===$("#GanttMapContainer").css("display")?(s.$broadcast("changeWorkingState","gantt"),d(function(){updateViewDebounced()},20),d(function(){o.showOnGantt(e.id)},120)):o.showOnGantt(e.id)},r.changeStatusToDispatch=function(t){r.invokedActionFor[t]||m.schedulingRunningFor[t]?alert(customLabels.another_operation_running):(a.recentlyUsed[t]=!0,r.invokedAction[t]="dispatch",r.invokedActionFor[t]=!0,a.changeStatus([t],h.DISPATCHED).then(function(e){a.drawServicesAndAbsences(e.services),r.invokedAction[t]=null,r.invokedActionFor[t]=!1}).catch(function(e){o.addNotification(customLabels.Service_Appointment_Update_ErrorMsgTitle,e.message)}).finally(function(){r.invokedAction[t]=null,r.invokedActionFor[t]=!1}))},r.showOnMap=function(e){s.$broadcast("showServiceOnMap",e)},r.shouldShowQuickActionBtn=function(e,t){return U.shouldShowQuickActionBtn(e,t)},r.bundleSA=function(e){T.Bundle.canInvoke([e])&&(r.invokedActionFor[e.id]?alert(customLabels.another_operation_running):(a.recentlyUsed[e.id]=!0,r.invokedAction[e.id]="bundle",r.invokedActionFor[e.id]=!0,T.Bundle.invoke([e]).then(function(){}).catch(function(e){}).finally(function(){r.invokedAction[e.id]=null,r.invokedActionFor[e.id]=!1})))},r.unbundleSA=function(e){T.Unbundle.canInvoke([e])&&(r.invokedActionFor[e.id]?alert(customLabels.another_operation_running):(a.recentlyUsed[e.id]=!0,r.invokedAction[e.id]="unbundle",r.invokedActionFor[e.id]=!0,T.Unbundle.invoke([e]).then(function(){}).catch(function(e){}).finally(function(){r.invokedAction[e.id]=null,r.invokedActionFor[e.id]=!1})))},r.openDateEndCalendar=function(){r.matchGantt||"Recent"==r.filter.selectedFilter||"Flagged"==r.filter.selectedFilter||"Selected"==r.filter.selectedFilter||"Gantt Filter"==r.filter.selectedFilter||(scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"DateStart",date:new Date(r.filter.endDate),navigation:!0,handler:function(e,t){o.safeApply(r,function(){r.endDate=e,r.endDate.setHours(23),r.endDate.setMinutes(59),r.endDate.setSeconds(0),r.filter.endDate=r.endDate,r.horizonDateChanged(),r.newFilterChanged()}),scheduler.destroyCalendar()}}))},r.openFullScreen=function(){var e=window.location.search.match(/[&?]fullScreen=(\d)/);e?(e="1"===e[1]?"0":"1",window.location.search=window.location.search.replace(/[&?]fullScreen=\d/,"&fullScreen="+e)):window.location.search+="&fullScreen=1"},r.getSlots=function(e){a.recentlyUsed[e]=!0,"none"===$("#GanttMapContainer").css("display")&&(s.$broadcast("changeWorkingState","gantt"),setTimeout(function(){updateViewDebounced()},20)),r.invokedActionFor[e]||m.schedulingRunningFor[e]?alert(customLabels.another_operation_running):t.get(e)},r.scheduleAndReshuffle=function(n){r.invokedActionFor[n]?alert(customLabels.another_operation_running):(a.recentlyUsed[n]=!0,r.invokedAction[n]="reshuffle",r.invokedActionFor[n]=!0,l.callRemoteAction(RemoteActions.runReshuffle,n,m.selectedPolicyId).then(function(i){v.updateOptimizationRequest(i),f.register("optimizationRequests",function t(e){e.forEach(function(e){e=new OptimizationRequest(e);e.id!==i.Id||"Completed"!==e.status&&"Failed"!==e.status||(r.invokedAction[n]=null,r.invokedActionFor[n]=!1,f.unRegister("optimizationRequests",t))})})},function(e){o.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message),r.invokedAction[n]=null,r.invokedActionFor[n]=!1}))},r.groupNearby=function(n){r.invokedActionFor[n]?alert(customLabels.another_operation_running):(a.recentlyUsed[n]=!0,r.invokedAction[n]="groupNearby",r.invokedActionFor[n]=!0,l.callRemoteAction(RemoteActions.runGroupNearby,n,m.selectedPolicyId).then(function(i){v.updateOptimizationRequest(i),f.register("optimizationRequests",function t(e){e.forEach(function(e){e=new OptimizationRequest(e);e.id!==i.Id||"Completed"!==e.status&&"Failed"!==e.status||(r.invokedAction[n]=null,r.invokedActionFor[n]=!1,f.unRegister("optimizationRequests",t))})})},function(e){o.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message),r.invokedAction[n]=null,r.invokedActionFor[n]=!1}))},r.autoScheduleService=function(e){r.invokedActionFor[e]||m.schedulingRunningFor[e]?alert(customLabels.another_operation_running):(a.recentlyUsed[e]=!0,r.invokedAction[e]="schedule",r.invokedActionFor[e]=!0,a.autoScheduleService(e).then(function(e){0===e.services.length&&alert(customLabels.NoCandidates),e.mst||a.drawServicesAndAbsences(e.services,e.absences)}).catch(function(e){o.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message)}).finally(function(){r.invokedAction[e]=null,r.invokedActionFor[e]=!1}))},r.$on("autoScheduleServiceFinished",function(e,t){r.invokedAction[t]=null,r.invokedActionFor[t]=!1}),r.openGanttSettings=function(){r.showGanttSettings=!0,o.ganttSettings?r.ganttSettings=o.ganttSettings:(r.ganttSettings.filterCandidates=!0,r.ganttSettings.servicesPerPage=200,r.ganttSettings.backHorizon=14,r.ganttSettings.capacityDuration="Day"),r.ganttSettingDraft=angular.copy(r.ganttSettings),setTimeout(function(){$("#ganttSettingsLightbox").draggable({containment:"document",handle:"#ganttSettingsLightboxHeader"}),$("#ganttSettingsLightbox").children().find("input[type=checkbox]").first().focus()},500)},r.closeSettingsLightbox=function(){r.showGanttSettings=!1,$("#ganttSettingsLightbox").attr("style",""),r.ganttSettingDraft=angular.copy(r.ganttSettings)},r.parseGanttSettingsToUserSetting=function(e){var t={};return t.Gantt_View_Start_Hour__c=e.startHour,t.Gantt_View_Finish_Hour__c=e.finishHour,t.Filter_Candidates__c=e.filterCandidates,t.Services_Per_Page__c=e.servicesPerPage,t.Resource_Row_Height__c=e.resourceRowHeight,t.Scheduling_horizon_limit__c=e.backHorizon,t.View_Capacity_Type__c=e.capacityDuration,t.Load_On_Today__c=e.loadOnToday,t.DefaultLeftPanel__c=e.leftPanel,t.ServiceListColoring__c=e.serviceColoring,t},r.saveGanttSettings=function(){void 0===r.ganttSettingDraft.backHorizon?alert(customLabels.backHorizonInvalid):(schedulerConfig.setRowHeights(r.ganttSettingDraft.resourceRowHeight,!0),setCapacityFilter(r.ganttSettingDraft.capacityDuration,!0),r.ganttSettings=angular.copy(r.ganttSettingDraft),o.ganttSettings=angular.copy(r.ganttSettingDraft),r.filter.servicesPerPage=parseInt(r.ganttSettings.servicesPerPage),u.SetUserSettingProperties(r.parseGanttSettingsToUserSetting(r.ganttSettings)).then(function(){r.loadServiceAppointmentsToList()}),r.showGanttSettings=!1)},r.$on("keypress",function(e,t){27===t.which&&r.closeSettingsLightbox()}),r.createArray=function(e,t){if("number"!=typeof e||isNaN(e))return[];if("number"!=typeof t||isNaN(t))return[];var i=Math.floor(e/t);return 0<e%t&&i++,new Array(i)},r.changePage=function(e){switch(e){case"right":r.filter.totalPages!=r.filter.currentPage&&(r.filter.currentPage=parseInt(r.filter.currentPage)+1,r.filter.currentPage=r.filter.currentPage.toString());break;case"left":1<r.filter.currentPage&&(r.filter.currentPage=parseInt(r.filter.currentPage)-1,r.filter.currentPage=r.filter.currentPage.toString());break;case"first":1<r.filter.currentPage&&(r.filter.currentPage="1");break;case"last":r.filter.totalPages!=r.filter.currentPage&&(r.filter.currentPage=r.filter.totalPages.toString())}},r.hideServiceList=function(){r.showServiceList.show=!1,r.reallyHideList=!0,d(function(){updateViewDebounced(),s.$broadcast("resizeMap",{})},0)},r.$watch("showServiceList.show",function(e,t){e&&(r.reallyHideList=!1)}),r.isDraggable=function(e){if(!window.__gantt.ignoreReadonlyGantt226&&!window.customPermissions.Enable_Drag_And_Drop)return!1;e=r.servicesObjects()[e];return!!e&&(!scheduler._events[e.id+"_dummy"]&&(!e.resourceId&&e.statusCategory===g.NONE&&(!e.pinned||e.pinned&&!preventUpdateOfPinned)&&(!w.isActive()||!w.isBundleMember(e))))},r.isBeingSavedNow=function(e){return!!scheduler._events[e+"_dummy"]},r.showAdvancedFilterFunc=function(){$("#AdvancedFilteringOptions").css("display","block"),d(function(){$("#SmartPanelContainer").find(".gutter-vertical").hide(),r.showAdvancedFilter=!0},100)},r.hideAdvancedFilterFunc=function(){r.showAdvancedFilter=!1,setTimeout(function(){$("#SmartPanelContainer").find(".gutter-vertical").show(),$("#AdvancedFilteringOptions").css("display","none")},700)},r.removeSpaces=function(e){return e?e.split(" ").join("+"):""},r.filterChanged=function(){var e=O(),e=function(e,t){for(var i=0;i<t.length;i++)if(t[i].name==e)return t[i].filter;return!1}(r.filter.selectedFilter,e);e?(r.filter.advancedFilter=e,r.customFilterSelected=!0,r.customFilterName=r.filter.selectedFilter):r.customFilterSelected=!1,u.GetUserSettingsProperty("Selected_List_View__c")!==r.filter.selectedFilter&&u.SetUserSettingsProperty("Selected_List_View__c",r.filter.selectedFilter)},r.$on("gotNewResources",function(e,t){r.territories=[];for(var i=t.show,n=0;n<i.length;n++)void 0!==c.territories()[i[n]]&&r.territories.push(c.territories()[i[n]]);r.servicesListVisitedDays={},r.newFilterChanged()}),r.createCustomFilter=function(){r.isEditMode=!1,r.customFilterName="",r.displayCancel=!0,r.IsCustomFilterReadonly=!1,r.DisplayComboBowArrow=!1,r.displayNew=!1,r.displayEdit=!1,r.displaySave=!0,r.displayDelete=!1,r.filter.advancedFilter=P()},r.CancelSaveOrEditCustomFilter=function(){r.displayNew=!0,r.displayEdit=!0,r.DisplayComboBowArrow=!0,r.displaySave=!1,r.displayDelete=!0,r.displayCancel=!1,r.IsCustomFilterReadonly=!0,M(r.lastSelectedFilter)},r.saveCustomFilter=function(){if(0===r.customFilterName.length)alert(customLabels.Please_give_a_name_to_the_custom_filter);else{for(var e=0;e<r.filterOptions.length;e++)if(!r.isEditMode&&r.filterOptions[e].name===r.customFilterName||r.isEditMode&&r.filterOptions[e].name===r.customFilterName&&r.filterOptions[e].name!==r.lastSelectedFilter)return void alert("Please select another name");if(r.displayNew=!0,r.displayEdit=!0,r.DisplayComboBowArrow=!0,r.displaySave=!1,r.displayDelete=!0,r.displayCancel=!1,r.IsCustomFilterReadonly=!0,r.isEditMode){for(var t=0;t<r.storageFilters.length;t++)if(r.storageFilters[t].name===r.lastSelectedFilter){r.storageFilters[t].filter=r.filter.advancedFilter,r.storageFilters[t].name=r.customFilterName,F();for(var i=0;i<r.filterOptions.length;i++)if(r.filterOptions[i].name===r.lastSelectedFilter){r.filterOptions[i].name=r.customFilterName,r.filterOptions[i].value=r.customFilterName;break}r.filter.selectedFilter===r.lastSelectedFilter&&(r.filter.selectedFilter=r.customFilterName);break}}else r.storageFilters.push({name:angular.copy(r.customFilterName),filter:angular.copy(r.filter.advancedFilter)}),r.filterOptions.push({name:angular.copy(r.customFilterName),value:angular.copy(r.customFilterName)}),F(),r.customFilterSelected=!0,r.filter.selectedFilter=r.customFilterName;r.lastSelectedFilter=r.customFilterName}},r.EditCustomFilter=function(){r.isEditMode=!0,r.displayCancel=!0,r.DisplayComboBowArrow=!1,r.displayNew=!1,r.displayEdit=!1,r.displaySave=!0,r.displayDelete=!1,r.IsCustomFilterReadonly=!1,r.DisplayComboBowArrow=!1,r.filter.advancedFilter=angular.copy(r.filter.advancedFilter)},r.deleteCustomFilter=function(){r.IsCustomFilterReadonly=!0,r.DisplayComboBowArrow=!0,r.displayNew=!0,r.displayEdit=!0,r.displaySave=!1,r.displayDelete=!0;for(var e=0;e<r.storageFilters.length;e++)if(r.storageFilters[e].name===r.customFilterName){r.storageFilters.splice(e,1);break}for(var t=r.customFilterName,i=0;i<r.filterOptions.length;i++)r.filterOptions[i].name===t&&r.filterOptions.splice(i,1);F(),r.filter.selectedFilter===r.customFilterName&&(r.filter.selectedFilter=customPermissions.Service_List_Todo?"Todo":"All"),0<r.storageFilters.length?M(r.storageFilters[0].name):M(null)},r.customFilterChanged=function(e){r.customFilterName=e,M(e)},r.showDropdownCustomFilters=function(e){e.stopPropagation(),0<r.storageFilters.length&&(r.showCustomFilterDropdown=!r.showCustomFilterDropdown)},r.toggleStatus=function(e,t){r.IsCustomFilterReadonly||(r.filter.advancedFilter.statusCheckboxs[t]=!r.filter.advancedFilter.statusCheckboxs[t])},r.toggleLocation=function(e){r.IsCustomFilterReadonly||(e?r.filter.advancedFilter.locationsCheckboxs[e]=!r.filter.advancedFilter.locationsCheckboxs[e]:r.filter.advancedFilter.noLocation=!r.filter.advancedFilter.noLocation)},r.clearRecentlyViewed=function(){for(var e in a.recentlyUsed)delete a.recentlyUsed[e]},r.openLocationFiltering=function(){LeftLocationFilteringService.open()},r.getStyleForServiceInList=function(e){return window.paletteViewActive&&e.ganttPaletteColor?{background:e.ganttPaletteColor.color}:{background:e.ganttColor}};var x=null,z=_.debounce(function(){var e=n("servicesListFilter"),t=n("pagination"),i=e(r.servicesObjects(),r.filter,r.getColumnsToDisplay(),r.filtersMap);x===i.checksum&&!__gantt.inday.isInDayRunning||(x=i.checksum,o.safeApply(r,function(){r.filteredServices.servicesArray=t(i,r.filter.currentPage,r.filter.servicesPerPage)}))},400,{maxWait:2e3}),j=(r.getServiceListFilter=function(){return z(),r.filteredServices.servicesArray},r.searchServiceByIdOrName=function(e){r.notFoundOnServer=!1,a.searchServiceByIdOrName(e).then(function(e){e?("Always"===window.__gantt.checkRulesMode&&a.checkRules([e]).then(a.drawViolationsOnGantt),r.filter.searchOnServer=e,r.filterOptions.find(function(e){return"SearchOnServer"===e.Id})||r.filterOptions.push({Name:customLabels.searchOnServer,name:customLabels.searchOnServer,old:!0,Id:"SearchOnServer",value:"SearchOnServer"}),r.filter.lastSelectedFilter=r.filter.selectedFilter,r.filter.selectedFilter="SearchOnServer"):r.notFoundOnServer=!0}).catch(function(e){console.warn(e)})},r.resetSearchText=function(){r.notFoundOnServer=null,r.filter.SearchText="","SearchOnServer"===r.filter.selectedFilter&&(r.filter.selectedFilter=r.filter.lastSelectedFilter,"SearchOnServer"===r.filterOptions[r.filterOptions.length-1].Id&&r.filterOptions.pop())},r.saveSettingsOfHorizonDates=function(){j()},_.debounce(function(){u.SetUserSettingsProperty("Date_Horizon_Properties__c",JSON.stringify(r.filter.selectedFiled))},800));function E(e){switch(e){case g.NONE:return"#a5e2d6";case g.SCHEDULED:return"#F9D058";case g.DISPATCHED:return"#8DD8FA";case g.IN_PROGRESS:return"#D68EF9";case g.COMPLETED:return"#95d155";case g.COULD_NOT_COMPLETE:return"#f58556";case g.CANCELED:return"#BEBCBA";default:return"#B7C9EA"}}r.customActions=[],o.customActionsPromise.then(function(){var e,t=o.getCustomActions("list");(e=r.customActions).push.apply(e,_toConsumableArray(t))}),r.runCustomServiceAction=function(e,t){var i,e=parseInt($(e.currentTarget).attr("actionId")),t=[t],n=o.getCustomActions("list")[e];n.visualforce?(e=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),i=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear(),1===t.length?y.open(n.name,n.visualforce+"?id="+t[0]+"&start="+e+"&end="+i):y.open(n.name,n.visualforce+"?services="+t.join(",")+"&start="+e+"&end="+i)):l.callRemoteAction(RemoteActions.runCustomServiceAction,n.className,t,scheduler._min_date,scheduler._max_date).then(function(e){e&&o.addNotification(n.name,e,null,null)}).catch(function(e){return o.addNotification(n.name,e.message,null,null)})},r.showTerritoriesFiltering=function(){b.open()},r.getStyleForServiceItem=function(e){var t,i={};return e.violations||e.jeopardy||("gradient"===r.ganttSettings.serviceColoring&&(window.paletteViewActive&&e.ganttPaletteColor?i.background="linear-gradient(to right, "+e.ganttPaletteColor.color+" -85%,#ffffff 65%)":e.ganttColor?i.background="linear-gradient(to right, "+e.ganttColor+" -85%,#ffffff 65%)":(t=E(e.statusCategory),i.background="linear-gradient(to right, "+t+" -85%,#ffffff 65%)")),"full"===r.ganttSettings.serviceColoring&&"full"===r.ganttSettings.serviceColoring&&(window.paletteViewActive&&e.ganttPaletteColor?i.background=e.ganttPaletteColor.color+"70":e.ganttColor?i.background=e.ganttColor+"70":(t=E(e.statusCategory),i.background=t+"70"))),i},r.isRelatedService=function(e){return e.relatedFather||e.relatedTo||e.isServiceInChain},r.highlightOnGantt=function(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];window.__servicesInFilter={applied:e},e&&n("servicesListFilter")(r.servicesObjects(),r.filter,r.getColumnsToDisplay(),r.filtersMap).forEach(function(e){return window.__servicesInFilter[e.id]=!0}),updateViewDebounced()},r.shouldShowClearHighlight=function(){return!!window.__servicesInFilter&&window.__servicesInFilter.applied},r.changeToSelectedServiceList=function(){r.selectorService.countSelectedServices()&&o.hasCustomPermission("Service_List_Selected")&&(r.filter.selectedFilter="Selected")},r.getSelectedClickableClass=function(){return r.selectorService.countSelectedServices()&&o.hasCustomPermission("Service_List_Selected")?"list-selected-blue":""},r.clearSelectedServices=function(){i.unselectAll()},r.openLightboxLabel=function(){return window.__gantt.editOnServiceAppointment?customLabels.Edit:customLabels.Details},r.openLightboxIcon=function(){return window.__gantt.editOnServiceAppointment?lsdIcons.edit:lsdIcons.info},r.searchTermChanges=function(){r.notFoundOnServer=null,"SearchOnServer"===r.filter.selectedFilter&&""===r.filter.SearchText&&r.resetSearchText()},r.isLoadingNewLocations=function(){return m.isLoadingNewLocations}}]),angular.module("serviceExpert").controller("serviceExpertToastCtrl",["$scope","$timeout",function(i,e){i.modes=["SUCCESS","ERROR","INFO"];i.showTast=!1,i.message,i.mode="SUCCESS",i.data={},i.data.renderToast=!1,i.getStatusCssClass=function(){switch(i.mode){case"SUCCESS":return"slds-theme_success";case"ERROR":return"slds-theme_error";case"INFO":return"slds-theme_info"}return"slds-theme_info"},i.startAnimation=function(){e(function(){i.showTast=!0},10)},i.stopAnimation=function(){e(function(){i.showTast=!1},3e3)},i.removeToast=function(){e(function(){i.data.renderToast=!1},4e3)},i.render=function(){i.data.renderToast=!0,i.startAnimation(),i.stopAnimation(),i.removeToast()},i.calFunc=function(){e(function(){i.f&&i.p&&(i.f(i.p),i.f=null)},1500)},i.$on("showServiceExpertToast",function(e,t){i.message=t&&t.message?t.message:"",i.mode=t.status&&-1!=i.modes.indexOf(t.status)?t.status:"INFO",i.f=t.f||!1,i.p=t.p||!1,i.render()})}]),angular.module("serviceExpert").filter("ampmOr24",function(){return function(e,t,i){var n=parseInt(e),i=i?":00":"";return"ampm"==t?12===e?"12PM":0===e||24===e?"12AM":12<n?n-12+"PM":n+"AM":"24"==t?n<10?"0"+n+i:n+i:e}}),angular.module("serviceExpert").filter("displayFieldSetField",["utils","$filter",function(n,s){return function(e,t){if(e&&t){var i=e[t.APIName];if(i)if("Status"===t.APIName)i=n.statusTranslations[e.status]||e.status;else switch(t.Type){case n.fieldsTypes.DateTime:i=s("amDateFormat")(i,"l LT");break;case n.fieldsTypes.Date:i=s("amDateFormat")(i,"L");break;case n.fieldsTypes.Currency:i=s("currency")(i,defaultCurrency);break;case n.fieldsTypes.Picklist:i=e.fields[t.TranslatedToLabel]||i}return i=null==i?void 0:i}}}]).filter("displayReportField",["utils","$filter",function(e,i){return function(e){if(e){var t=e.Label;switch(e.Type){case"DATETIME_DATA":t=i("amDateFormat")(t,"l LT");break;case"DATE_DATA":t=i("amDateFormat")(t,"L")}return t=null==t?void 0:t}}}]),angular.module("serviceExpert").filter("orderObjectBy",function(){return function(e,i,t){var n=[];return angular.forEach(e,function(e){n.push(e)}),n.sort(function(e,t){return e[i]>t[i]?1:-1}),t&&n.reverse(),n}}),angular.module("serviceExpert").filter("pagination",["servicesService",function(r){return function(e,t,i){r.filter.totalServices=e.length,(null==r.filter.currentPage||parseInt(r.filter.currentPage)>r.filter.totalPages)&&(r.filter.currentPage="1",t=1);var n=[],s=(t-1)*i,t=(t-1)*i+i,n=e.length<=i?e:e.slice(s,t);return e.length==r.filter.servicesPerPage?r.filter.totalPages=1:(r.filter.totalPages=Math.floor(e.length/r.filter.servicesPerPage),0<e.length%r.filter.servicesPerPage&&r.filter.totalPages++),r.filter.firstVisibleService=1+s,r.filter.lastVisibleService=t,(e.length<=i||t>e.length)&&(r.filter.lastVisibleService=e.length),n}}]),angular.module("serviceExpert").filter("replaceLabels",function(){return function(e){for(var t=e,i=arguments.length,n=Array(1<i?i-1:0),s=1;s<i;s++)n[s-1]=arguments[s];for(var r=0;r<n.length;r++)t=t.replace("$"+r,n[r]);return t}});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}angular.module("serviceExpert").filter("servicesListFilter",["utils","$filter","servicesService","userSettingsManager","ServiceSelectorService","SERVICE_STATUS","SERVICE_CATEGORY","BundleService",function(w,T,L,A,I,e,C,k){return function(e,t,i,n){var s,r=function(e,t){var i,n,s,r,o=Object.keys(e).length.toString();for(i in t)"object"!==_typeof(t[i])&&("boolean"==typeof t[i]?o+=t[i]?"1":"0":o+=t[i].toString());for(n in o+=t.endDate.getTime(),t.selectedFiled)o+=t.selectedFiled[n]?"1":"0";for(s in t.advancedFilter.selectedFiled)o+=t.advancedFilter.selectedFiled[s]?"1":"0";for(r in t.advancedFilter.statusCheckboxs)o+=t.advancedFilter.statusCheckboxs[r]?"1":"0";return o=(o=(o=(o=(o=(o+=t.advancedFilter.minDate.toString())+t.advancedFilter.maxDate.toString())+t.advancedFilter.servicePriority)+(t.advancedFilter.jeopardies?"1":"0"))+(t.advancedFilter.unScheduled?"1":"0"))+(t.advancedFilter.violations?"1":"0")}(e,t);if("SearchOnServer"===t.selectedFilter)return o=e[t.searchOnServer]?[e[t.searchOnServer]]:[],s=0,o.forEach(function(e){return s+=e.totalModifiedTimes}),o.checksum+=s.toString(),o;var o=n&&n[t.selectedFilter]&&n[t.selectedFilter].old;if(useNewFilters&&!o)return(n=T("servicesListFilterNew")(e,t,i)).checksum=r+n.totalChecksum.toString(),n;var a,l=[],c=new Date(t.endDate),d=w.addDaysToDate(c,-w.ganttSettings.backHorizon),u=scheduler.getState().min_date,m=scheduler.getState().max_date,p=function(e){if(null==A.GetUserSettingsProperty("Filters__c"))return null;for(var t="object"===_typeof(A.GetUserSettingsProperty("Filters__c"))?A.GetUserSettingsProperty("Filters__c"):JSON.parse(A.GetUserSettingsProperty("Filters__c")),i=0;i<t.length;i++)if(t[i].name===e)return t[i].filter;return null}(t.selectedFilter),o=null,h=[],g=(-1<t.SearchText.indexOf(",")&&""===(o=t.SearchText.replace(/, /g,",").split(","))[o.length-1]&&o.length--,o?h=o:h.push(t.SearchText),0);for(a in e)for(var v=0;v<h.length;v++){var f=function(e,t,i){{if(e.name&&-1!=e.name.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.ganttLabel&&-1!=e.ganttLabel.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.accountName&&-1!==e.accountName.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.resourceName&&-1!==e.resourceName.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.id&&-1!==e.id.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.serviceTerritoryName&&-1!==e.serviceTerritoryName.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.status&&-1!==e.status.toLowerCase().indexOf(t.toLowerCase()))return!0}for(var n=0;n<i.length;n++)if((i[n].Type===w.fieldsTypes.String||i[n].Type===w.fieldsTypes.TextArea||i[n].Type===w.fieldsTypes.Reference||i[n].Type===w.fieldsTypes.Picklist)&&e[i[n].APIName]&&-1!==e[i[n].APIName].toLowerCase().indexOf(t.toLowerCase()))return!0;return!1}(e[a],h[v],i),S=function(e,t,i,n){n=new Date(n);{if(void 0!==t.earlyStart&&t.earlyStart&&e.earlyStart&&e.earlyStart>i&&e.earlyStart<=n)return!0;if(void 0!==t.dueDate&&t.dueDate&&e.dueDate&&e.dueDate>i&&e.dueDate<=n)return!0;if(void 0!==t.appStart&&t.appStart&&e.appStart&&e.appStart>i&&e.appStart<=n)return!0;if(void 0!==t.appEnd&&t.appEnd&&e.appEnd&&e.appEnd>i&&e.appEnd<=n)return!0;if(void 0!==t.finish&&t.finish&&e.finish&&e.finish>i&&e.finish<=n)return!0;if(void 0!==t.start&&t.start&&e.start&&e.start>i&&e.start<=n)return!0;if(void 0!==t.display&&t.display&&e.ganttDisplay&&e.ganttDisplay>i&&e.ganttDisplay<=n)return!0}return!1}(e[a],t.selectedFiled,d,c);if("Selected"===t.selectedFilter){if(I.SelectedServices[a]&&I.SelectedServices[a]&&f){g+=e[a].totalModifiedTimes,l.push(e[a]);break}}else if("Flagged"===t.selectedFilter&&f){if(L.flagged[a]){g+=e[a].totalModifiedTimes,l.push(e[a]);break}}else if("Recent"===t.selectedFilter&&f){if(L.recentlyUsed[a]){g+=e[a].totalModifiedTimes,l.push(e[a]);break}}else if("Todo"===t.selectedFilter){if((e[a].statusCategory===C.NONE||e[a].violations||e[a].jeopardy)&&e[a].statusCategory!==C.CANCELED&&e[a].statusCategory!==C.COMPLETED&&S){if(1<h[v].length&&f){g+=e[a].totalModifiedTimes,l.push(e[a]);break}if(h[v].length<=1){g+=e[a].totalModifiedTimes,l.push(e[a]);break}}}else if("All"===t.selectedFilter){if(S){if(1<h[v].length&&f){g+=e[a].totalModifiedTimes,l.push(e[a]);break}if(h[v].length<=1){g+=e[a].totalModifiedTimes,l.push(e[a]);break}}}else if("Unscheduled"===t.selectedFilter){if(!e[a].resource&&e[a].statusCategory!=C.CANCELED&&S){if(1<h[v].length&&f){g+=e[a].totalModifiedTimes,l.push(e[a]);break}if(h[v].length<=1){g+=e[a].totalModifiedTimes,l.push(e[a]);break}}}else if("Violating"===t.selectedFilter){if(e[a].violations&&e[a].statusCategory!=C.CANCELED&&S){if(1<h[v].length&&f){g+=e[a].totalModifiedTimes,l.push(e[a]);break}if(h[v].length<=1){g+=e[a].totalModifiedTimes,l.push(e[a]);break}}}else if("inJeopardy"===t.selectedFilter){if(e[a].jeopardy&&e[a].statusCategory!=C.CANCELED&&S){if(1<h[v].length&&f){g+=e[a].totalModifiedTimes,l.push(e[a]);break}if(h[v].length<=1){g+=e[a].totalModifiedTimes,l.push(e[a]);break}}}else if("Scheduled"===t.selectedFilter){if(e[a].resource&&S){if(1<h[v].length&&f){g+=e[a].totalModifiedTimes,l.push(e[a]);break}if(h[v].length<=1){g+=e[a].totalModifiedTimes,l.push(e[a]);break}}}else if("Gantt filter"===t.selectedFilter){if(e[a].resource&&e[a].start<=m&&e[a].finish>=u){var _,y,b=!0;if("LongView"===scheduler._mode&&(_=(e[a].finish-e[a].start)/1e3/60/60,b=window.__currentViewOptions.showMdt?(y=0===window.mdtBooleanField.indexOf("FSL__")?window.mdtBooleanField.substr(5,window.mdtBooleanField.length-5):window.mdtBooleanField,_>=window.__currentViewOptions.minServiceDuration&&e[a].fields[y]):_>=window.__currentViewOptions.minServiceDuration),1<h[v].length&&f&&b){g+=e[a].totalModifiedTimes,l.push(e[a]);break}if(h[v].length<=1&&b){g+=e[a].totalModifiedTimes,l.push(e[a]);break}}}else if("Contractors filter"===t.selectedFilter){if(e[a].resourceContractor&&S){if(1<h[v].length&&f){g+=e[a].totalModifiedTimes,l.push(e[a]);break}if(h[v].length<=1){g+=e[a].totalModifiedTimes,l.push(e[a]);break}}}else if("Cancelled filter"===t.selectedFilter){if(e[a].statusCategory===C.CANCELED&&S){if(1<h[v].length&&f){g+=e[a].totalModifiedTimes,l.push(e[a]);break}if(h[v].length<=1){g+=e[a].totalModifiedTimes,l.push(e[a]);break}}}else if("Crews filter"===t.selectedFilter){if(e[a].isAssignToCrew){if(1<h[v].length&&f){g+=e[a].totalModifiedTimes,l.push(e[a]);break}if(h[v].length<=1){g+=e[a].totalModifiedTimes,l.push(e[a]);break}}else if(void 0!==e[a].parentFields.MinimumCrewSize||void 0!==e[a].parentFields.RecommendedCrewSize){if(1<h[v].length&&f){g+=e[a].totalModifiedTimes,l.push(e[a]);break}if(h[v].length<=1){g+=e[a].totalModifiedTimes,l.push(e[a]);break}}}else if("Exclude Bundle Members"===t.selectedFilter){if(!k.isBundleMember(e[a])&&S){if(1<h[v].length&&f){g+=e[a].totalModifiedTimes,l.push(e[a]);break}if(h[v].length<=1){g+=e[a].totalModifiedTimes,l.push(e[a]);break}}}else if(p&&p.statusCheckboxs[statusTranslations[e[a].status]]&&function(e,t,i){var n,s=new Date(e.minDate),r=new Date(e.maxDate);for(n in s.setHours(0),s.setMinutes(0),r.setDate(r.getDate()+1),r.setHours(0),r.setMinutes(0),t)if(t[n]&&function(e,t,i,n){return void 0!==e[t]&&(e[t]>=i&&e[t]<=n)}(i,n,s,r))return 1;return}(p,t.selectedFiled,e[a])&&(y=e[a],_=p.servicePriority,y.priority<=_)&&(b=e[a],S=p,(!b.jeopardy||S.jeopardies)&&(!(b.violations&&!S.violations)&&!(null===b.start_date&&!S.unScheduled)))&&function(e,t,i){if(i&&!e.location)return 1;for(var n in t)if(e.serviceTerritoryName===n&&t[n])return 1;return}(e[a],p.locationsCheckboxs,p.noLocation)){if(1<h[v].length&&f){g+=e[a].totalModifiedTimes,l.push(e[a]);break}if(h[v].length<=1){g+=e[a].totalModifiedTimes,l.push(e[a]);break}}}n=T("orderBy")(l,t.orderByField,t.reverse);return n.checksum=r+g.toString(),n}}]),!function(){function e(G,$,B,H,e,V,U,z,j,W,q,t,Z,i,n,K){var Y=(new Date).getTime();return setInterval(function(){return Y+=6e4},6e4),n.register("positions",function(e){var t,i=B.getResources();for(t in e)i[t]&&(i[t].lastKnownLongitude=e[t].longitude,i[t].lastKnownLocationDate=e[t].lastModifiedDate.getTime()-1e3*e[t].lastModifiedDate.getTimezoneOffset()*60,i[t].lastKnownLatitude=e[t].latitude)}),function(E,e,t,i,n,s,r){var o=[],a={},l=[],c=e.replace(/, /g,",").split(","),d=H.resourcesAndTerritories(),u=H.resourceToServiceCrewMembers(),e=H.isOptimizationViewer()?Object.values(B.territories()):$.getTerritoriesSortedByTree(),m=H.isOptimizationViewer()?Object.keys(B.territories()):z.GetUserSettingsProperty("locations");if(__gantt.inday.isInDayRunning=!1,(e=e.filter(function(t){return m.find(function(e){return e===t.id})})).forEach(function(e){o.push(new X(e,B.getOperatingHours()[e.operatingHours],W)),a[e.id]=o.length-1}),t)for(var p in i)i[p]&&l.push(p);var h,g=G.ganttSettings&&G.ganttSettings.filterCandidates;for(h in d){var v=d[h],f=B.getResources()[h];if(f&&(function(e,t){if(0===t.length)return 1;for(var i=0;i<t.length;i++)if(-1<e.toLowerCase().indexOf(t[i].toLowerCase()))return 1;return}(f.name,c)&&(!("and"===n&&0<l.length&&t)||V.doesHaveSkills(h,l,scheduler._min_date,scheduler._max_date))&&(!("or"===n&&0<l.length&&t)||V.doesHaveSomeSkills(h,l,scheduler._min_date,scheduler._max_date)))){var S,_=!1;for(S in r.resourceFilteringOptions)if(r.resourceFilteringOptions[S]&&!f.sobject[S]){_=!0;break}if(!_){if("select_a_field"!==r.selectedPicklist){if(0<r.picklistOptions.length&&-1===r.picklistOptions.indexOf(f.sobject[r.selectedPicklist])){if(!r.picklistNullValues)continue;if(void 0!==f.sobject[r.selectedPicklist])continue}if(0===r.picklistOptions.length&&r.picklistNullValues&&void 0!==f.sobject[r.selectedPicklist])continue}if(H.isCrewViewActive){var y=H.currentCrewToShow;if(void 0===y[h])continue;if(void 0!==y[h].members){var b,w,T,L=!1;for(b in y[h].members)if(useLocationTimezone)for(var A in v)J(scheduler._min_date,scheduler._max_date,v[A].effectiveStartDate,v[A].effectiveEndDate)&&(w=G.convertDateBetweenTimeZones(y[h].members[b].startDate,"GMT",v[A].timezone),T=G.convertDateBetweenTimeZones(y[h].members[b].endDate,"GMT",v[A].timezone),J(scheduler._min_date,scheduler._max_date,w,T)&&(L=!0));else w=G.convertDateBetweenTimeZones(y[h].members[b].startDate,"GMT",userTimeZone),T=G.convertDateBetweenTimeZones(y[h].members[b].endDate,"GMT",userTimeZone),J(scheduler._min_date,scheduler._max_date,w,T)&&(L=!0);if(!1===L)continue}}if(r.crewsSelectionOptions.selectedPicklist!==customLabels.showAll){if(G.crewsFilter=!0,r.crewsSelectionOptions.selectedPicklist===customLabels.hideCrewMembers){if("C"!==f.sobject.ResourceType){var I,C=!1;for(I in u[h])J(scheduler._min_date,scheduler._max_date,u[h][I].startDate,u[h][I].endDate)&&(C=!0);if(!0===C)continue}}else if(r.crewsSelectionOptions.selectedPicklist===customLabels.showCrewsAndCrewMembers){if("C"!==f.sobject.ResourceType){var k,D=!1;for(k in u[h])J(scheduler._min_date,scheduler._max_date,u[h][k].startDate,u[h][k].endDate)&&(D=!0);if(!0!==D)continue}}else if(r.crewsSelectionOptions.selectedPicklist===customLabels.showOnlyCrews){if("C"!==f.sobject.ResourceType)continue}else if(r.crewsSelectionOptions.selectedPicklist===customLabels.hideCrewsAndCrewMembers){if("C"===f.sobject.ResourceType)continue;var R,O=!1;for(R in u[h])J(scheduler._min_date,scheduler._max_date,u[h][R].startDate,u[h][R].endDate)&&(O=!0);if(!0===O)continue}}else G.crewsFilter=!1;if(!g||!j.getCandidatesIds()||j.getCandidatesIds()[h])for(var F in v){var M=G.generateResourceId(v[F].serviceResource,v[F].serviceTerritory);s.showWorkingResource&&!function(e,t,i){var n=new Date(scheduler._min_date),s=t.resourceToWorkingDates[e];if(!s)return;for(;n<scheduler._max_date;){var r=s[i.formatDayToString(n)];if(r&&(0<r.regular||0<r.overtime))return 1;n.setDate(n.getDate()+1)}return}(M,U,G)||m&&-1==m.indexOf(v[F].serviceTerritory)||J(scheduler._min_date,scheduler._max_date,v[F].effectiveStartDate,v[F].effectiveEndDate)&&(M=o[a[v[F].serviceTerritory]],F=new Q(G.generateResourceId,B.getResources()[v[F].serviceResource],v[F].serviceTerritory,function(e){if(window.customPermissions.Hide_Gantt_Last_Seen_Indicator||isLastKnownFieldsNotAllowed)return!1;if(!e.lastKnownLocationDate)return e.online=!1;if(e.lastKnownLocationDate&&e.onlineOffset){var t=moment(Y).tz(window.userTimeZone)._offset;if(e.lastSeen=parseInt((Y-e.lastKnownLocationDate)/1e3/60+t),e.lastKnownLocationDate+60*(e.onlineOffset-t)*1e3>Y&&0<=e.lastSeen)return e.online=!0}return e.online=!1}(B.getResources()[v[F].serviceResource]),!1,"S"===v[F].serviceTerritoryType,Z),M&&-1===M.children.map(function(e){return e.key}).indexOf(F.key)&&M.children.push(F))}}}}var P=[],x=0;return o.forEach(function(e,t){return 0===e.children.length&&P.push(t)}),P.forEach(function(e){return o.splice(e-x++,1)}),o.forEach(function(e){e.children.sort(N);var t=K.isTerritoryHasInDayOptimizationInProgress(scheduler._min_date,scheduler._max_date,e.key);t&&(__gantt.inday.isInDayRunning=!0,e.addInDayOptimizationInProgress(t,K.calculateIndayProgress))}),G.hasCustomPermission("Utilization_on_Service_Territory")&&showDailyUtilization&&"MonthlyView"!==scheduler._mode&&"MTDView"!==scheduler._mode&&"LongView"!==scheduler._mode&&o.forEach(function(e){for(var t=[],i=new Date(scheduler._min_date);i<scheduler._max_date;i.setDate(i.getDate()+1))t.push(Z.calculateLocation(e.children,i));var n=t.reduce(function(e,t){return e.break+=t.break,e.capacity+=t.capacity,e.overtime+=t.overtime,e.service+=t.service,e.travel+=t.travel,e.na+=t.na,e},{break:0,capacity:0,overtime:0,service:0,travel:0,na:0}),n=Z.calculateLocationUtilization(n);e.addUtilizationHtml(n)}),o;function N(e,t){var e=B.getResources()[e.resourceId].sobject[q.resourceFieldToSortyBy],t=B.getResources()[t.resourceId].sobject[q.resourceFieldToSortyBy],i=q.descending?1:-1;return void 0===e&&void 0===t?0:void 0===e&&void 0!==t?-1*i:void 0!==e&&void 0===t||t<e?i:e<t?-1*i:0}}}function J(e,t,i,n){return isIntersect(e,t,i,n)}function X(e,t,i){this.key=e.id,this.name=e.name,this.children=[],this.generateHtml(e,t.timezone),void 0===i.ganttOpenedTerritories[e.id]&&(i.ganttOpenedTerritories[e.id]=!0),this.open=i.ganttOpenedTerritories[e.id]}function Q(e,t,i,n,s,r,o){this.key=e(t.id,i),this.resourceId=t.id,this.name=t.name,this.contractor=t.isCapacityBased,this.online=n,this.lastSeen=t.lastSeen,this.secondary=r,this.isUndestaffOrOverstaff=s,this.utilization=null,this.calculatePeriodUtilization(o,t),t.isUndestaffOrOverstaff=s,this.generateHtml(t)}angular.module("serviceExpert").filter("timelineFilter",e),e.$inject=["utils","LeftSideLocationFilteringService","ResourcesAndTerritoriesService","TimePhasedDataService","ResourceCrewsService","SkillsService","calendarsService","userSettingsManager","GetSlotsService","StateService","resourceFilterHelper","LastKnownPositionService","monthlyViewHelperService","DeltaService","RegisterService","OptimizationRequestsService"],X.prototype.generateHtml=function(e,t){var i,n;e.parentTerritory?this.label='<div class="truncate ParentName" title="'+e.parentTerritory.name.encodeHTML()+'">'+e.parentTerritory.name.encodeHTML()+'</div>\n                          <div class="truncate LocationName" title="'+e.name.encodeHTML()+'">'+e.name.encodeHTML()+"</div>":this.label='<div class="truncate LocationName no-parent-location" title="'+e.name.encodeHTML()+'">'+e.name.encodeHTML()+"</div>","MonthlyView"!==scheduler._mode&&"MTDView"!==scheduler._mode&&(n=new Date,i=e.parentTerritory?"margin-top:-26px;":"",(n=new Date(n.valueOf()+6e4*n.getTimezoneOffset())).setMinutes(n.getMinutes()+utils.getLocationOffset(n,e.id)),this.label+="<div class='timeZoneFolder' style=\""+i+'">'+t+" - "+moment(n).format("llll")+"</div>")},X.prototype.addInDayOptimizationInProgress=function(e,t){var i=this.label.indexOf("</div>"),n=customLabels.PreparingData,s={percent:0},t='<div class="left-territory-info-box" >'+('<div class="inDayOptimizationRunningContainer"><span>'+('<div class="inday-opt-progress">\n                            <span class="opt-progress-preparing">'+(n=null!=e.objectToScheduled?(s=t(e)).text:n)+'</span>\n                                <span class="opt-progress-text">'+s.percent+'%</span>\n\n                                <div class="opt-progress-bar inday-progress-animation" style="width:'+s.percent+'%">\n                            </div>\n\n                        </div>')+"</span></div>")+"</div>";this.label=this.label.slice(0,i+6)+t+this.label.slice(i+6)},X.prototype.addUtilizationHtml=function(e){var t=this.label.indexOf("</div>"),i="green-daily-utlz",n=this.label.indexOf("inDayOptimizationRunningContainer"),s=-1==n&&-1<this.label.indexOf("Parent")?'style="margin-top: -9px"':"",r=(e>=monthlyViewSettings.high&&e<monthlyViewSettings.critical?i="yellow-daily-utlz":e>=monthlyViewSettings.critical&&(i="red-daily-utlz"),"");-1<navigator.userAgent.indexOf("rv:11.0")&&(r="dailyViewUtilizationIE"),null!==e&&(i='<b class="'+i+'">'+e+"%</b>",-1<n?(e='<div class="dailyViewUtilization '+r+' utilizationWithInday"><span>'+customLabels.UtilizationDaily.replace("$0",i)+" </span></div>",this.label=this.label.slice(0,n-12)+e+this.label.slice(n-12)):(e='<div class="dailyViewUtilization '+r+'" '+s+"><span>"+customLabels.UtilizationDaily.replace("$0",i)+"</span> </div>",this.label=this.label.slice(0,t+6)+e+this.label.slice(t+6)))},Q.prototype.calculatePeriodUtilization=function(e,t){if("MonthlyView"===scheduler._mode){for(var i=[],n=new Date(scheduler._min_date);n<scheduler._max_date;n.setDate(n.getDate()+1))i.push(e.calculateDailyResourceCapacity(this,n));var s=i.reduce(function(e,t){return e.break+=t.break,e.capacity+=t.capacity,e.overtime+=t.overtime,e.service+=t.service,e.travel+=t.travel,e.na+=t.na,e},{break:0,capacity:0,overtime:0,service:0,travel:0,na:0});this.utilization=e.calculateLocationUtilization(s),t.sobject.__Utilization__=this.utilization}},Q.prototype.generateHtml=function(e){this.label="";var t,i=this.online?"online-indicator":"online-indicator offline-indicator",n=this.secondary?"<span class='secondaryGanttLabel' title=\""+customLabels.Secondary+'">('+customLabels.Secondary+")</span>":"",i=e.lastKnownLocationDate&&this.lastSeen<1440&&0<=this.lastSeen?'<div class="'+i+'" title="'+utils.hoursMinutes(this.lastSeen,customLabels.SeenXMinsHoursAgo,customLabels.SeenXAgoHours,customLabels.SeenXAgo)+'"></div>':"",s=(void 0!==e.serviceCrew__r?(s=scheduler.matrix.ZoomLevel3.dy<33?"SmallResourceCrewPhoto":"ResourceCrewPhoto",e.pictureLink?this.label+="<img src='"+e.pictureLink+"' title='"+e.description+"' class='"+s+"' />":this.label+="<span class='"+s+'\'><svg aria-hidden="true" class="crew-slds-icon crewContextMenuIcon"><use xlink:href=\''+lsdIcons.crew+"'></use></svg></span>",this.label+=i):e.pictureLink?(s=scheduler.matrix.ZoomLevel3.dy<33?"SmallResourcePhoto":"ResourcePhoto",this.label+="<img src='"+e.pictureLink+"' title='"+e.description+"' class='"+s+"' />"+i):(s=scheduler.matrix.ZoomLevel3.dy<33?"SmallResourcePhotoDefault":"NormalResourcePhotoDefault",this.label+="<div title='"+e.description+"' class=\"ResourcePhotoIcon "+s+'"></div>'+i),this.label+='<div class="resourceMenuBtn">\n                            <svg aria-hidden="true" class="slds-icon resourceMenuIcon">\n                                <use xlink:href="'+lsdIcons.threedots+'"></use>\n                            </svg>\n                        </div>',e.ganttLabel?utils.escapeResourceName(e.ganttLabel):""),i=utils.escapeResourceName(this.name),r=utils.escapeResourceName(this.name);e.description&&(r=this.name+" - "+e.description),"MonthlyView"===scheduler._mode&&null!==this.utilization?(t="resource-utiliz-low",s=customLabels.TotalUtilizationResource,monthlyViewSettings.critical<=this.utilization?t="resource-utiliz-high":monthlyViewSettings.high<=this.utilization&&(t="resource-utiliz-med"),s+=' <span class="'+t+'">'+this.utilization+"%</span>",scheduler.matrix.ZoomLevel3.dy<33?this.label+="<a resource='"+this.resourceId+"' class=\"truncate smallResourceNameField\" title='"+r+"'>"+i+" "+n+"\n                    <div class='smallResourceGanttLabel truncate'>"+s+"</div></a>":this.label+="<a resource='"+this.resourceId+"' class='truncate smallResourceName resourceYup' title='"+r+"'>"+i+" "+n+"\n                    <div class='resourceGanttLabel truncate'>"+s+"</div></a>"):e.ganttLabel?scheduler.matrix.ZoomLevel3.dy<33?this.label+="<a resource='"+this.resourceId+"' class=\"truncate smallResourceNameField\" title='"+r+"'>"+i+" "+n+"\n                        <div class='smallResourceGanttLabel truncate'>"+s+"</div></a>":this.label+="<a resource='"+this.resourceId+"' class='truncate smallResourceName resourceYup' title='"+r+"'>"+i+" "+n+"\n                        <div class='resourceGanttLabel truncate'>"+s+"</div></a>":scheduler.matrix.ZoomLevel3.dy<33?this.label+="<a resource='"+this.resourceId+"' class='truncate smallResourceName resourceYup resource-no-label' style='margin-top:1px;' title='"+r+"'>"+i+" "+n+"</a>":this.label+='<a class="truncate resource-no-label" resource=\''+this.resourceId+"' style='margin-top:1px;' title='"+r+"'>"+i+" "+n+"</a>",this.label='<div class="resourceY-container">'+this.label+"</div>"}}(),angular.module("serviceExpert").filter("toArray",function(){return function(e){var i=[];return angular.forEach(e,function(e,t){i.push(e)}),i}}),!function(){function stringifySingleCondition(e,t,i){if(e[getPropertyName(t.property)]||!1===e[getPropertyName(t.property)]||(e[getPropertyName(t.property)]=""),"FSL__RULE_VIOLATIONS__FSL"===t.property)return e="true"===t.value.toString(),"equals"===t.operator&&e||"not equal to"===t.operator&&!e?"(Array.isArray(__evalRealService.violations) && __evalRealService.violations.length > 0)":"(!__evalRealService.violations || (Array.isArray(__evalRealService.violations) && __evalRealService.violations.length === 0))";var e=evaluateOperator(t.operator);return t.value&&t.value.indexOf&&-1<t.value.indexOf(",")&&(t.value=t.value.replace(/, /g,",").split(",")),Array.isArray(t.value)?(t.value=t.value.map(function(e){return e.toLowerCase?e.toLowerCase():e}),__picklistArrayForFilter[i]=t.value,evaluateArrayValue(t.operator,t.property,i)):(evaluateValue(t.property,t.value,__ganttFilterFieldSet,i),e?"STRING"===(e=__ganttFilterFieldSet[t.property].Type)||"TEXTAREA"===e||"EMAIL"===e||"REFERENCE"===e?"__evalService."+getPropertyName(t.property)+".toLowerCase() "+evaluateOperator(t.operator)+" __evalConditionValue."+t.property+"_"+i+".toLowerCase()":"__evalService."+getPropertyName(t.property)+" "+evaluateOperator(t.operator)+" __evalConditionValue."+t.property+"_"+i:evaluateSepcialOperator(t.operator,t.value,t.property))}function evaluateArrayValue(e,t,i){switch(e){case"contains":return"new RegExp(__picklistArrayForFilter["+i+"].join(\"|\"), 'i').test(__evalService."+getPropertyName(t)+") === true";case"does not contain":return"new RegExp(__picklistArrayForFilter["+i+"].join(\"|\"), 'i').test(__evalService."+getPropertyName(t)+") === false";case"start with":return"new RegExp('^' + __picklistArrayForFilter["+i+"].join(\"|\"), 'i').test(__evalService."+getPropertyName(t)+") === true";case"equals":return"__picklistArrayForFilter["+i+"].indexOf(__evalService."+getPropertyName(t)+".toLowerCase()) > -1";case"not equal to":return"__picklistArrayForFilter["+i+"].indexOf(__evalService."+getPropertyName(t)+".toLowerCase()) === -1";default:return"__picklistArrayForFilter["+i+"].some( element => __evalService."+getPropertyName(t)+" "+evaluateOperator(e)+" element)"}}function getPropertyName(e){return"FSL__RULE_VIOLATIONS__FSL"===e?"FSL__RULE_VIOLATIONS__FSL":removeNamespace(__ganttFilterFieldSet[e].APIName)}function evaluateCondition(service,conditions,logic){var serviceFields=service.fields,stringConditions=(window.__evalService=serviceFields,window.__evalRealService=service,logic?replaceLogicOperators(logic):""),conditionsMapped={},i,_i;for(i in conditions)conditionsMapped[i]=stringifySingleCondition(serviceFields,conditions[i],i-1),logic||(stringConditions+="{"+i.toString()+"} && ");for(_i in logic||(stringConditions=stringConditions.substr(0,stringConditions.length-3)),conditionsMapped)stringConditions=stringConditions.replace("{"+_i+"}",conditionsMapped[_i]);return""===stringConditions?1:eval(stringConditions)}function evaluateValue(e,t,i,n){if(i[e])switch(i[e].Type){case"BOOLEAN":window.__evalConditionValue[e+"_"+n]=!0===t;break;case"DATE":case"DATETIME":window.__evalConditionValue[e+"_"+n]=new Date(t);break;case"STRING":case"EMAIL":case"TEXTAREA":case"REFERENCE":window.__evalConditionValue[e+"_"+n]=t?t.toLowerCase():"";break;default:window.__evalConditionValue[e+"_"+n]=t}else window.__evalConditionValue[e]=null}function evaluateOperator(e){switch(e){case"equals":return"==";case"not equal to":return"!=";case"less than":return"<";case"greater than":return">";case"less or equal":return"<=";case"greater or equal":return">=";default:return null}}function evaluateSepcialOperator(e,t,i){switch(e){case"contains":return"__evalService."+getPropertyName(i)+".toLowerCase().indexOf('"+t.toLowerCase()+"') > -1";case"does not contain":return"__evalService."+getPropertyName(i)+".toLowerCase().indexOf('"+t.toLowerCase()+"') === -1";case"start with":return"__evalService."+getPropertyName(i)+".toLowerCase().indexOf('"+t.toLowerCase()+"') === 0"}}function replaceLogicOperators(e){return e=(e=(e=e.split("AND").join("&&")).split("OR").join("||")).split("NOT").join("!")}function removeNamespace(e){var t;return fslNamespace&&0===e.indexOf(fslNamespace+"__")?(t=fslNamespace.length+2,e.substr(t,e.length-t)):e}function isServiceInDateRange(e,t,i,n){var s=scheduler._min_date,r=scheduler._max_date;return n.List_only_appointments_on_the_gantt?e.end_date&&isIntersectIncludeLimits(s,r,e.end_date,e.end_date)||!(!e.start_date||!isIntersectIncludeLimits(s,r,e.start_date,e.start_date)):(s=new Date(i),r=new Date(i),s.setDate(s.getDate()-n.Days_before_horizon),r.setDate(r.getDate()+n.Days_after_horizon+1),r.setMinutes(r.getMinutes()-1),t.earlyStart&&e.earlyStart&&isIntersectIncludeLimits(s,r,e.earlyStart,e.earlyStart)||(t.dueDate&&e.dueDate&&isIntersectIncludeLimits(s,r,e.dueDate,e.dueDate)||(t.start&&e.start&&isIntersectIncludeLimits(s,r,e.start,e.start)||(t.finish&&e.finish&&isIntersectIncludeLimits(s,r,e.finish,e.finish)||(t.appStart&&e.appStart&&isIntersectIncludeLimits(s,r,e.appStart,e.appStart)||(t.appEnd&&e.appEnd&&isIntersectIncludeLimits(s,r,e.appEnd,e.appEnd)||!!(t.display&&e.ganttDisplay&&isIntersectIncludeLimits(s,r,e.ganttDisplay,e.ganttDisplay))))))))}function searchOnService(e,t,i){if(e.name&&-1!==e.name.toLowerCase().indexOf(t.toLowerCase()))return 1;if(e.ganttLabel&&-1!==e.ganttLabel.toLowerCase().indexOf(t.toLowerCase()))return 1;if(e.accountName&&-1!==e.accountName.toLowerCase().indexOf(t.toLowerCase()))return 1;if(e.resourceName&&-1!==e.resourceName.toLowerCase().indexOf(t.toLowerCase()))return 1;if(e.id&&-1!==e.id.toLowerCase().indexOf(t.toLowerCase()))return 1;if(e.serviceTerritoryName&&-1!==e.serviceTerritoryName.toLowerCase().indexOf(t.toLowerCase()))return 1;if(e.status&&-1!==e.status.toLowerCase().indexOf(t.toLowerCase()))return 1;for(var n=0;n<i.length;n++)if((i[n].Type===utils.fieldsTypes.String||i[n].Type===utils.fieldsTypes.TextArea||i[n].Type===utils.fieldsTypes.Reference||i[n].Type===utils.fieldsTypes.Picklist)&&e[i[n].APIName]&&-1!==e[i[n].APIName].toLowerCase().indexOf(t.toLowerCase()))return 1}window.__ganttFilterFieldSet={},window.__picklistArrayForFilter=[],window.__evalConditionValue={},angular.module("serviceExpert").filter("servicesListFilterNew",["utils","$filter","GanttFilterService","FieldSetFieldsService",function(e,m,p,t){return t.fieldsSetFields().then(function(e){e.ganttFilter.forEach(function(e){return __ganttFilterFieldSet[e.FullAPIName]=e})}),function(e,t,i){var n=0,s=[],r=p.getFilterById(t.selectedFilter);if(r){var o,a=null,l=[];for(o in-1<t.SearchText.indexOf(",")&&""===(a=t.SearchText.replace(/, /g,",").split(","))[a.length-1]&&a.length--,a?l=a:l.push(t.SearchText),e){if(t.SearchText){for(var c=!1,d=0;d<l.length;d++)if(searchOnService(e[o],l[d],i)){c=!0;break}if(!c)continue}t.pivotDate=new Date(t.endDate),t.pivotDate.setHours(0),t.pivotDate.setMinutes(0),isServiceInDateRange(e[o],t.selectedFiled,t.pivotDate,r)&&evaluateCondition(e[o],r.Criterias,r.Logic)&&(n+=e[o].totalModifiedTimes,s.push(e[o]))}}else for(var u in e)n+=e[u].totalModifiedTimes,s.push(e[u]);a=m("orderBy")(s,t.orderByField,t.reverse);return a.totalChecksum=n,a}}])}(),!function(){function e(){function e(i,s,r,o,a,l,c,d,e,u,m,p,h,t){i.bulkActionsOrder=bulkActionsOrder,i.customActions=[],i.actionNames={Schedule:{name:"Schedule",nameLabel:customLabels.Schedule,icon:lsdIcons.calendar},Dispatch:{name:"Dispatch",nameLabel:customLabels.Dispatch,icon:lsdIcons.dispatch},Optimize:{name:"Optimize",nameLabel:customLabels.Optimize,icon:lsdIcons.magicwand},"Flag-Unflag":{name:"Flag-Unflag",nameLabel:customLabels.Flag_Unflag,icon:lsdIcons.flag},Unschedule:{name:"Unschedule",nameLabel:customLabels.Unschedule,icon:lsdIcons.na},"Check Rules":{name:"Check Rules",nameLabel:customLabels.check_rules_action_label,icon:lsdIcons.violation,isAvailable:function(){return window.customPermissions.Enable_Bulk_Check_Rules}},Bundle:{name:"Bundle",nameLabel:h.Bundle.label,icon:h.Bundle.icon,isAvailable:function(){return t.isActive()}},Unbundle:{name:"Unbundle",nameLabel:h.Unbundle.label,icon:h.Unbundle.icon,isAvailable:function(){return t.isActive()}}},r.customActionsPromise.then(function(){var e,t=r.getCustomActions("bulk");(e=i.customActions).push.apply(e,_toConsumableArray(t))}),i.runCustomServiceAction=function(i){var e,t,n=l.getSelected();i.visualforce?(e=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),t=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear(),1===n.length?m.open(i.name,i.visualforce+"?id="+n[0]+"&start="+e+"&end="+t):m.open(i.name,i.visualforce+"?services="+n.join(",")+"&start="+e+"&end="+t)):0!==n.length&&u.callRemoteAction(RemoteActions.runCustomServiceAction,i.className,n,scheduler._min_date,scheduler._max_date).then(function(t){u.callRemoteAction(RemoteActions.getServicesById,n).then(function(e){e=p.updateTimePhaseData(e,"service").services;s.drawServicesAndAbsences(e,[],[],[]),t&&r.addNotification(i.name,t,null,null)})}).catch(function(e){return r.addNotification(i.name,e.message,null,null)})},i.isActionAvailable=function(e){return!i.actionNames[e]||!i.actionNames[e].isAvailable||i.actionNames[e].isAvailable()},i.checkHasCustomPermission=function(e){return null==r.hasCustomPermission("Bulk_"+e)||r.hasCustomPermission("Bulk_"+e)},i.openBulkAction=function(e){switch(e){case"Schedule":d.schedule(l.getSelected());break;case"Dispatch":o.open();break;case"Unschedule":a.open();break;case"Optimize":c.open();break;case"Flag-Unflag":for(var t=l.getSelected(),i=0;i<t.length;i++)s.flagged[t[i]]=!s.flagged[t[i]];updateViewDebounced();break;case"Check Rules":var n=l.getSelected();0<n.length&&s.checkRules(n).then(s.drawViolationsOnGantt);break;case"Bundle":n=l.getSelected().map(function(e){return p.serviceAppointments()[e]});h.Bundle.invoke(n).then(function(){}).catch(function(e){});break;case"Unbundle":n=l.getSelected().map(function(e){return p.serviceAppointments()[e]});h.Unbundle.invoke(n).then(function(){}).catch(function(e){})}}}return e.$inject=["$scope","servicesService","utils","bulkDispatchService","bulkUnscheduleService","ServiceSelectorService","optimizeLightboxService","bulkScheduleService","rdOptimizeLightboxService","sfdcService","GeneralLightbox","TimePhasedDataService","BundleActions","BundleService"],{restrict:"E",template:'<div id="quickActionsButtons">\n\t\t\t                    <div fsl-key-press tabindex="0" id="actionQuickFirst" class="truncate quickActionBtn" ng-show="bulkActionsOrder.first.length && checkHasCustomPermission(actionNames[bulkActionsOrder.first[0].title].name) && isActionAvailable(actionNames[bulkActionsOrder.first[0].title].name)" ng-click="openBulkAction(bulkActionsOrder.first[0].title)" title="{{actionNames[bulkActionsOrder.first[0].title].nameLabel}}">\n\t\t\t\t\t\t\t\t\t{{actionNames[bulkActionsOrder.first[0].title].nameLabel}}\n\t\t\t\t\t\t\t\t</div>\n\t                        \t<div fsl-key-press tabindex="0" id="actionQuickSecond"\n\t\t\t\t\t\t\t\t\t class="truncate quickActionBtn"\n\t\t\t\t\t\t\t\t\t ng-show="bulkActionsOrder.second.length && checkHasCustomPermission(actionNames[bulkActionsOrder.second[0].title].name) && isActionAvailable(actionNames[bulkActionsOrder.second[0].title].name)"\n\t\t\t\t\t\t\t\t\t ng-click="openBulkAction(bulkActionsOrder.second[0].title)"\n                                     title="{{actionNames[bulkActionsOrder.second[0].title].nameLabel}}">\n                                     {{actionNames[bulkActionsOrder.second[0].title].nameLabel}}\n                                </div>\n\t\t                    \t<div fsl-key-press tabindex="0" class="truncate" id="ActionButton" ng-show="bulkActionsOrder.dropdown.length || customActions.length" cs-toggle="MainActionContainer">\n                                    <span ng-show="(!bulkActionsOrder.first.length &&\n                                                   !bulkActionsOrder.second.length) ||\n                                                   ( (!checkHasCustomPermission(actionNames[bulkActionsOrder.first[0].title].name)  || !isActionAvailable(actionNames[bulkActionsOrder.first[0].title].name )) &&\n                                                     (!checkHasCustomPermission(actionNames[bulkActionsOrder.second[0].title].name) || !isActionAvailable(actionNames[bulkActionsOrder.second[0].title].name)) )">\n                                           '+customLabels.Actions+'\n                                    </span>\n                                    <i class="fa fa-caret-down"></i>\n\t\t                    \t</div>\n\t                    \t</div>\n\t                    \t\n\t                        <div id="MainActionContainer">\n\t\t\t                    <div class="truncate BulkActionMenuItem" tabindex="0" role="select" fsl-tab-switch fsl-key-press ng-repeat="action in bulkActionsOrder.dropdown" ng-show="checkHasCustomPermission(actionNames[action.title].name) && isActionAvailable(actionNames[action.title].name)" ng-click="openBulkAction(action.title)">\n\t\t\t\t\t\t\t\t\t<svg aria-hidden="true" class="slds-icon mainActionIcon">\n\t\t\t\t\t\t\t\t\t\t<use xlink:href="{{actionNames[action.title].icon}}"></use>\n\t\t\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t\t\t\t{{actionNames[action.title].nameLabel}}\n                                </div>\n                                \n                                \n                                <div class="truncate BulkActionMenuItem" tabindex="0" role="select" fsl-tab-switch fsl-key-press ng-repeat="action in customActions" ng-click="runCustomServiceAction(action)">\n                                \n                                    <svg aria-hidden="true" class="slds-icon mainCustomActionIcon">\n\t\t\t\t\t\t\t\t\t\t<use xlink:href="{{action.icon}}"></use>\n\t\t\t\t\t\t\t\t\t</svg>\n                                \n\t\t\t\t\t\t\t\t\t{{action.name}}\n                                </div>\n                                                               \n                                \n\t                        </div>',scope:{},controller:e}}angular.module("serviceExpert").directive("bulkActionsButton",e),e.$inject=[]}(),angular.module("serviceExpert").directive("bulkOptimizeOptions",function(){return{template:customLabels.starting_from_x_until_y_including_z_services.replace("$0",'<u id="bulkStartOptimize" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartOptimize\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>').replace("$1",'<u id="bulkFinishOptimize" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishOptimize\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>').replace("$2",'<select class="bulkStatusWidth RightArrowForSelect" ng-model="optimizeAllServices">\n\t\t\t\t\t\t\t\t<option value="all">'+customLabels.All+'</option>\n\t\t\t\t\t\t\t\t<option value="unscheduled">'+customLabels.UnscheduledCapital+"</option>\n\t\t\t\t\t\t\t</select>")}}).directive("bulkOptimizePolicy",function(){return{template:customLabels.Use_the_following_policy_x_and_y.replace("$0",'<select class="bulkStatusWidth RightArrowForSelect" ng-model="selectedPolicy" ng-change="changePolicy()" ng-options="policy.Name for policy in policyOptions"></select>').replace("$1",'<select ng-model="optimizeSelectedFilter" class="bulkStatusWidth RightArrowForSelect">\n\t\t\t\t\t\t\t\t \t<option ng-repeat="(fieldName, fieldLbl) in checkBoxFields" value="{{fieldName}}" ng-bind="fieldLbl"></option>\n\t\t\t\t\t\t\t\t \t<option value="noFilter">'+customLabels.None+"</option>\n\t\t\t\t\t\t\t\t </select>")}}).directive("bulkChangeStatusDates",function(){return{template:customLabels.starting_from_x_until_y.replace("$0",'<u id="bulkStartChangeStatus" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartChangeStatus\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>\n\t\t\t\t\t\t\t<select class="selectOnBulk RightArrowForSelect" ng-change="validateDatesStart()" ng-model="startHour">\n\t\t\t\t\t\t\t    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n\t\t\t\t\t\t\t<select class="minutesSelect selectOnBulk RightArrowForSelect" ng-change="validateDatesStart()" ng-model="startMinutes">\n\t\t\t\t\t\t\t    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n\t\t\t\t\t\t\t</select>').replace("$1",'<u id="bulkFinishChangeStatus" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishChangeStatus\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>\n\t\t\t\t\t\t\t<select class="selectOnBulk RightArrowForSelect" ng-change="validateDatesEnd()" ng-model="endHour">\n\t\t\t\t\t\t\t    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n\t\t\t\t\t\t\t<select class="minutesSelect selectOnBulk RightArrowForSelect" ng-change="validateDatesEnd()" ng-model="endMinutes">\n\t\t\t\t\t\t\t    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n\t\t\t\t\t\t\t</select>')}}).directive("bulkUnscheduleDates",function(){return{template:customLabels.starting_from_x_until_y.replace("$0",'<u id="bulkStartUnschedule" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartUnschedule\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>\n\t\t\t\t\t\t\t<select class="selectOnBulk RightArrowForSelect" ng-change="validateDatesStart()" ng-model="startHour">\n\t\t\t\t\t\t\t    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n\t\t\t\t\t\t\t<select class="minutesSelect selectOnBulk RightArrowForSelect" ng-change="validateDatesStart()" ng-model="startMinutes">\n\t\t\t\t\t\t\t    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n\t\t\t\t\t\t\t</select>').replace("$1",'<u id="bulkFinishUnschedule" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishUnschedule\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>\n\t\t\t\t\t\t\t<select class="selectOnBulk RightArrowForSelect" ng-change="validateDatesEnd()" ng-model="endHour">\n\t\t\t\t\t\t\t    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t<select class="minutesSelect selectOnBulk RightArrowForSelect" ng-change="validateDatesEnd()" ng-model="endMinutes">\n\t\t\t\t\t\t\t    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n\t\t\t\t\t\t\t</select>')}}).directive("bulkChangeStatusPicklist",function(){return{template:customLabels.changeStatusBulkMsg.replace("$0",'<select class="selectChangeStatusBulk bulkStatusWidth" ng-model="bulkStatus">\n\t\t\t\t\t\t\t\t<option ng-repeat="(statusType,statusLabel) in statuses" value="{{statusLabel}}" >{{getStatusTranslations()[statusLabel]}}</option>\n\t\t\t\t\t\t\t</select>')}}),!function(){function e(){function e(n){n.colors=[{Name:"Red",Hex:"#E53935"},{Name:"Pink",Hex:"#D81B60"},{Name:"Purple",Hex:"#8E24AA"},{Name:"Indigo",Hex:"#3949AB"},{Name:"Blue",Hex:"#1E88E5"},{Name:"Cyan",Hex:"#00ACC1"},{Name:"Teal",Hex:"#00897B"},{Name:"Green",Hex:"#43A047"},{Name:"Lime",Hex:"#C0CA33"},{Name:"Yellow",Hex:"#FDD835"},{Name:"Amber",Hex:"#FFB300"},{Name:"Orange",Hex:"#FB8C00"},{Name:"Brown",Hex:"#6D4C41"},{Name:"Grey",Hex:"#757575"},{Name:"Blue Grey",Hex:"#546E7A"},{Name:"Black",Hex:"#000"}],n.selectColor=function(e){n.selectedColor=e.Hex,n.setSelectedShapeColor(e.Hex),n.showColorMenu=!1},n.showMenuClick=function(e){n.drawState!=n.drawingStates.EDIT&&n.drawState!=n.drawingStates.DRAW||(n.showColorMenu=!n.showColorMenu)},n.selectedColor="#546E7A",n.showColorMenu=!1,angular.element("#mapOptionsContainer").on("click",function(e){for(var t=["color-square","color-button"],i=0;i<t.length;i++)if(e.target.classList.contains(t[i])||e.target.parentNode&&e.target.parentNode.classList.contains(t[i]))return;n.showColorMenu&&(n.showColorMenu=!1)})}return e.$inject=["$scope"],{restrict:"E",template:'<div id="select-color-btn" title="'+customLabels.Select_color+'" class="color-button truncate"  ng-click="showMenuClick()" ng-class="{disabledButton: drawState != drawingStates.EDIT && drawState != drawingStates.DRAW}">\n                            <span class="color-square" ng-style="{\'background-color\': selectedColor}"></span><span>'+customLabels.Select_color+'</span>\n                        </div>\n                        <div class="color-menu" id="colorMenu" ng-show="showColorMenu == true">\n                            <span class="color-box" ng-repeat="color in colors" ng-click="selectColor(color)" ng-style="{\'background-color\': color.Hex}"></span>\n                        </div>',scope:!1,controller:e}}angular.module("serviceExpert").directive("csColorPicker",e),e.$inject=[]}(),angular.module("serviceExpert").directive("fieldInCard",["$filter","utils",function(n,s){return{restrict:"E",link:function(i,e,t){i.fieldsTypes=s.fieldsTypes,i.isFieldEmpty=function(e,t){return void 0===n("displayFieldSetField")(i.service,i.field)},i.getRefFieldID=function(e,t){return e[t.JsAPIName.replace("__r","__c")]},i.openConsoleTab=s.openConsoleTab},scope:{service:"=",field:"="},template:'\n            \n                <span>\n                \n                    <div class="extra-info-title" title="{{field.Label}}">{{field.Label}}</div>\n                    <span class="extra-info-content" ng-show="field.Type != fieldsTypes.Reference && field.Type != fieldsTypes.Phone" title="{{service | displayFieldSetField : field}}"><service-list-column service="service" field="field"></service-list-column></span>\n                    <span ng-show="isFieldEmpty(service, field)">-</span>\n                    <a draggable="false" ng-show="field.Type == fieldsTypes.Reference" ng-click="openConsoleTab($event, getRefFieldID(service, field))" target="_blank" href="../{{ getRefFieldID(service, field) }}" title="{{service | displayFieldSetField : field}}">{{service | displayFieldSetField : field}}</a>\n                    <span ng-if="field.Type == fieldsTypes.Phone && !isFieldEmpty(service, field)">\n                        <cs-click-to-dial number="{{service[field.APIName]}}" user-id="\'{!$User.Id}\'" user-first-name="\'{!JSENCODE($User.FirstName)}\'" user-last-name="\'{!JSENCODE($User.LastName)}\'"></cs-click-to-dial>\n                    </span>\n\n                </span>\n            '}}]),!function(){function e(){function e(r,t,i,n,s,o,a){r.isEmpty=t.isEmpty,r.paletteApplied=!1,r.updatePaletteView=function(){var n,s;r.calculatePaletteColors=!1,(r.paletteDataIsValid=!0)===r.paletteApplied&&r.clearPalette(),void 0!==r.GanttPalettes[r.selectedPalette]&&(r.currentPalette=r.GanttPalettes[r.selectedPalette],r.picklistMap={},t.serviceFieldsMap().then(function(e){var t,e=e[r.currentPalette.ServiceProperty];try{e.Type===FieldTypes.PICKLIST&&(n=Object.keys(r.currentPalette.ColorScheme.picklist[e.Name]),s=Object.values(r.currentPalette.ColorScheme.picklist[e.Name])),e.Type===FieldTypes.BOOLEAN&&(n=[customLabels.Selected,customLabels.Deselected],s=[r.currentPalette.ColorScheme.max.color,r.currentPalette.ColorScheme.min.color]),e.Type!==FieldTypes.DATE&&e.Type!==FieldTypes.DATETIME||(t=o.convertMomentDtToDt(moment().tz(userTimeZone)),s=c(r.currentPalette.ColorScheme.min.color,r.currentPalette.ColorScheme.max.color,r.currentPalette.ColorLevel),n=function(e,t,i,n,s,r){for(var n=m(n,t),t=m(s,i),o=e.getTime()+n,a=(e.getTime()+t-o)/r,l=[],c=0;c<r;c++){var d=moment(o+c*a),u=moment(o+(c+1)*a);0===c?l.push(p([customLabels.Earlierthan,u.format("dddd, MMMM Do YYYY, h:mm:ss a")])):c===r-1?l.push(p([customLabels.LaterThan,d.format("dddd, MMMM Do YYYY, h:mm:ss a")])):l.push(customLabels.Between_x_and_y.replaceAll(d.format("dddd, MMMM Do YYYY, h:mm:ss a"),u.format("dddd, MMMM Do YYYY, h:mm:ss a")))}return l}(t,r.currentPalette.ColorScheme.min.value,r.currentPalette.ColorScheme.max.value,r.currentPalette.ColorScheme.min.type,r.currentPalette.ColorScheme.max.type,r.currentPalette.ColorLevel)),e.Type===FieldTypes.DOUBLE&&(s=c(r.currentPalette.ColorScheme.min.color,r.currentPalette.ColorScheme.max.color,r.currentPalette.ColorLevel),n=l(r.currentPalette.ColorScheme.min.value,r.currentPalette.ColorScheme.max.value,r.currentPalette.ColorLevel)),e.Type!==FieldTypes.INTEGER&&e.Type!==FieldTypes.PERCENT||(s=c(r.currentPalette.ColorScheme.min.color,r.currentPalette.ColorScheme.max.color,r.currentPalette.ColorLevel),n=function(e,t,i){e=parseInt(e);for(var n=((t=parseInt(t))-e)/i,s=(n=Math.round(n),[]),r=0;r<i;r++){var o=e+r*n,a=e+(r+1)*n;0===r?s.push(p([a,customLabels.OrLower])):r===i-1?s.push(p([customLabels.HigherThan,o])):s.push(customLabels.Between_x_and_y.replaceAll(o,a))}return s}(r.currentPalette.ColorScheme.min.value,r.currentPalette.ColorScheme.max.value,r.currentPalette.ColorLevel)),e.Type!==FieldTypes.LOCATION&&e.Type!==FieldTypes.ADDRESS||(s=c(r.currentPalette.ColorScheme.min.color,r.currentPalette.ColorScheme.max.color,r.currentPalette.ColorLevel),n=l(r.currentPalette.ColorScheme.min.value,r.currentPalette.ColorScheme.max.value,r.currentPalette.ColorLevel,!0)),r.picklistLength=s.length;for(var i=0;i<s.length;i++)r.picklistMap[n[i]]=s[i]}catch(e){r.paletteDataIsValid=!1}}))},r.clearPalette=function(){r.hidePaletteView(),r.paletteApplied=!1,a.$broadcast("paletteUpdated")},r.applyPalette=function(){var e;r.calculatePaletteColors?alert("Still applying last palette"):(r.calculatePaletteColors=!0,void 0!==(e=r.GanttPalettes[r.selectedPalette])?t.applyNewPaletteForGantt(e,i.serviceAppointments()).then(function(e){r.showPaletteView(),r.paletteApplied=!0,r.calculatePaletteColors=!1,a.$broadcast("paletteUpdated")}):(alert("No palette selected"),r.calculatePaletteColors=!1))},r.openPalettesLightbox=function(e){"edit"===e&&n.open(customLabels.GanttPalettes,GanttPalettePage)},r.calculatePalettePortionStyle=function(e){return{background:e,width:100/r.picklistLength+"%",height:"12px"}},t.getGanttPalettes(!1).then(function(e){r.GanttPalettes=e,r.selectedPalette=s.GetUserSettingsProperty("Gantt_Palette__c")||(null==r.GanttPalettes||r.isEmpty(r.GanttPalettes)?customLabels.NoPalettes:customLabels.None),r.updatePaletteView()}),r.getTranslatedPicklistValue=function(e){return r.GanttPalettes[r.selectedPalette]&&r.GanttPalettes[r.selectedPalette].translations&&r.GanttPalettes[r.selectedPalette].translations[e]||e}}function l(e,t,i,n){e=parseFloat(e);for(var s=((t=parseFloat(t))-e)/i,r=[],o=0;o<i;o++){var a=e+o*s,l=e+(o+1)*s;n?0===o?r.push(p([l,distanceUnit,customLabels.OrLower])):o===i-1?r.push(p([customLabels.HigherThan,a,distanceUnit])):r.push(customLabels.Between_x_and_y.replaceAll(p([a,distanceUnit]),p([l,distanceUnit]))):0===o?r.push(p([l,customLabels.OrLower])):o===i-1?r.push(p([customLabels.HigherThan,a])):r.push(customLabels.Between_x_and_y.replaceAll(a,l))}return r}function m(e,t){var i;switch(e){case"Minutes":i=60*t*1e3;break;case"Hours":i=60*t*60*1e3;break;case"Days":i=24*t*60*60*1e3}return i}function c(e,t,i){for(var n=[],s=e.substr(1,2),r=e.substr(3,4).substr(0,2),e=e.substr(5,6),o=t.substr(1,2),a=t.substr(3,4).substr(0,2),t=t.substr(5,6),l=parseInt(s,16),c=parseInt(r,16),d=parseInt(e,16),u=(parseInt(o,16)-l)/i,m=(parseInt(a,16)-c)/i,p=(parseInt(t,16)-d)/i,h=0;h<i;h++){var g=Math.round(Math.abs(l+u*h))%256,v=Math.round(Math.abs(c+m*h))%256,f=Math.round(Math.abs(d+p*h))%256,g=g.toString(16),v=(1===g.length&&(g="0"+g),v.toString(16)),f=(1===v.length&&(v="0"+v),f.toString(16)),g="#"+g+v+(f=1===f.length?"0"+f:f);n.push(g)}return n}function p(e){for(var t="",i=0;i<e.length;i++)t+=e[i]+" ";return t}return e.$inject=["$scope","GanttPalettesService","TimePhasedDataService","GeneralLightbox","userSettingsManager","utils","$rootScope"],{restrict:"E",template:'<div>\n                            <div class="palette-explain-headline">\n                                <div class="palette-explain">\n                                    '+customLabels.PaletteChangeExplain+'\n                                </div>\n\n                                <button ng-if="showPaletteEdit" class="globalWhiteButton truncate palette-editor-button" title="'+customLabels.OpenPaletteEditor+'" ng-click="openPalettesLightbox(\'edit\')">\n                                    '+customLabels.OpenPaletteEditor+'\n                                </button>\n                            </div>\n\n                            <div>\n                                <span>\n                                    <select class="ganttPaletteSelector" ng-model="selectedPalette" ng-change="updatePaletteView()">\n                                        <option ng-if="isEmpty(GanttPalettes) == true" value="'+customLabels.NoPalettes+'">--- '+customLabels.NoPalettes+' ---</option>\n                                        <option ng-if="isEmpty(GanttPalettes) == false" value="'+customLabels.None+'">--- '+customLabels.None+' ---</option>\n                                        <option ng-repeat="(key,value) in GanttPalettes" value="{{key}}">{{value.Name}}</option>\n                                    </select>\n                                </span>\n                            </div>\n\n                            <div class="palette-details-container" ng-if="GanttPalettes[selectedPalette] !== undefined">\n                                \n                                <div ng-if="paletteDataIsValid">\n\n                                    '+customLabels.HoverPaletteColor+'\n                                \n                                    <div style="padding-top: 10px">\n                                        <div class="paletteBox">\n                                            <span title="{{getTranslatedPicklistValue(key)}}" ng-class="{\'roundBoxRight\': $last, \'roundBoxLeft\': $first}" ng-style="calculatePalettePortionStyle(value)" ng-repeat="(key, value) in picklistMap"></span>\n                                        </div>\n                                    </div>\n\n                                    <div class="palette-description" ng-hide="currentPalette.Description === \'\' || currentPalette.Description === undefined">\n                                        <div class="description-label-heading">\n                                            '+customLabels.Description+'\n                                        </div>\n                                        <div class="palette-description-content">\n                                            {{currentPalette.Description}}\n                                        </div>\n                                    </div>\n                                    \n                                    <div class="apply-palette-button-container">\n                                        <button ng-show="paletteApplied === false" ng-class="{ quickActionBtnForPaletteDisabled : calculatePaletteColors, quickActionBtnForPalette: !calculatePaletteColors}"  class="" ng-click="applyPalette()">'+customLabels.ApplyPalette+'</button>\n                                        <button ng-show="paletteApplied === true" ng-class="{ quickActionBtnForPaletteDisabled : calculatePaletteColors, quickActionBtnForPalette: !calculatePaletteColors}"  class="" ng-click="clearPalette()">'+customLabels.UseDefaultPalette+'</button>\n                                    </div>\n\n                                </div>\n\n                                <div class="palette-details-error" ng-if="paletteDataIsValid == false">\n                                    '+customLabels.PaletteDataIsInvalid+"\n                                </div>\n\n                            </div>\n                        </div>",scope:{showPaletteView:"=",showPaletteEdit:"=",hidePaletteView:"="},controller:e}}angular.module("serviceExpert").directive("ganttPalette",e),e.$inject=[]}(),!function(){function e(){return{restrict:"E",scope:{request:"=",apptCount:"@",progressStatus:"="},template:'<div class="opt-progress">\n                            <span class="opt-progress-preparing"></span>\n\n                            <div class="opt-progress-bar smart_in_progress">\n                                <span class="opt-progress-text"></span>\n                            </div>\n\n                        </div>',link:function(a,i,e){var l,c,n,d,s;function r(){var e,t,i,n,s,r,o;a.progressStatus[a.request.id].progressInterval||(e=a.request.objectToScheduled,t=d.maxRunTimeSingleService*e,i=(new moment).diff(moment(a.request.requestProgressStart),"seconds"),t>=d.maxRuntimeOverall&&(e=d.maxRuntimeOverall/d.maxRunTimeSingleService,t=d.maxRuntimeOverall),n=i/t*100,s=7,r=0,o=90/e,t<=i&&"In Progress"==a.request.status&&(s=7+(i-t)/d.maxRunTimeSingleService*.1,r=90),a.progressStatus[a.request.id].progressInterval=setInterval(function(){"Aborted"!==a.request.status&&"Aborting"!==a.request.status||u(),90<(n+=o)&&(n=90),r<90?r=n:100<=r?(r=100,clearInterval(a.progressStatus[a.request.id].progressInterval),delete a.progressStatus[a.request.id].progressInterval):90<=r&&(s+=.1,r=Math.round(Math.atan(s)/(Math.PI/2)*100*1e3)/1e3),l.css("width",r+"%"),c.text(r.toFixed(2)+"%")},1e3*d.maxRunTimeSingleService))}function u(){clearInterval(a.progressStatus[a.request.id].progressInterval),delete a.progressStatus[a.request.id].progressInterval}"Global Optimization"===a.request.type&&(l=angular.element(i[0].querySelector(".opt-progress-bar")),c=angular.element(i[0].querySelector(".opt-progress-text")),n=angular.element(i[0].querySelector(".opt-progress-preparing")),d=__gantt[e.optType],a.progressStatus[a.request.id]||(a.progressStatus[a.request.id]={status:a.request.status,objectToScheduled:a.request.objectToScheduled}),a.progressStatus[a.request.id].objectToScheduled||(l.css("width","0%"),n.text(customLabels.PreparingData)),s=a.$watchCollection("[request.objectToScheduled, request.status]",function(e,t){""!=e[0]&&null!=e[0]&&e[0]!=a.progressStatus[a.request.id].objectToScheduled?(n.text(""),a.progressStatus[a.request.id].objectToScheduled=e[0],r()):"In Progress"==e[1]&&null!=e[0]&&"In Progress"==a.progressStatus[a.request.id].status&&(n.text(""),r()),"In Progress"!==e[1]&&"In Progress"==a.progressStatus[a.request.id].status?(a.progressStatus[a.request.id].status=e[1],u(),s()):"Completed"==a.progressStatus[a.request.id].status&&(angular.element(i[0].querySelector(".opt-progress")).remove(),s())}))}}}angular.module("serviceExpert").directive("csOptimizationProgress",e),e.$inject=[]}(),angular.module("serviceExpert").directive("csRange",["$filter","utils",function(a,l){return{restrict:"CAE",link:function(i,e,n){var s=$($(e[0]).find(".showingDates")),r=isAMPM?"ampm":"24",o=$($(e[0]).find(".sliderSelector"));i.$watchCollection(n.ngModel,function(e,t){!o.slider("instance")||e.start===t.start&&e.end===t.end||(o.slider("values",[e.start,e.end]),s.text(n.showingText.replace("{1}",a("ampmOr24")(parseInt(e.start),r,!0)).replace("{2}",a("ampmOr24")(parseInt(e.end),r,!0))))}),o.slider({range:!0,min:parseInt(n.min),max:parseInt(n.max),values:[parseInt(n.defaultStart),parseInt(n.defaultEnd)],slide:function(e,t){e.stopPropagation(),s.text(n.showingText.replace("{1}",a("ampmOr24")(parseInt(t.values[0]),r,!0)).replace("{2}",a("ampmOr24")(parseInt(t.values[1]),r,!0)))},stop:function(e,t){e.stopPropagation(),l.safeApply(i,function(){i[n.ngModel].start=t.values[0],i[n.ngModel].end=t.values[1]})}}),s.text(n.showingText.replace("{1}",a("ampmOr24")(parseInt(n.defaultStart),r,!0)).replace("{2}",a("ampmOr24")(parseInt(n.defaultEnd),r,!0)))},scope:!0,template:'<div class="sliderSelector"></div><span class="showingDates"></span>'}}]),angular.module("serviceExpert").directive("safeBinder",[function(){return{restrict:"A",scope:{safeBinder:"="},link:function(e,t,i){$(t[0]).html(e.safeBinder)}}}]),angular.module("serviceExpert").directive("serviceListColumn",["utils",function(n){return{restrict:"E",link:function(e,t,i){e.isFormulaForImage=n.isFormulaForImage,e.getType=function(){return e.field.FullAPIName===window.fieldNames.Service_Appointment.GanttIcon__c?"gantt-icons":"STRING"!==e.field.Type&&"TEXTAREA"!==e.field.Type||!n.isFormulaForImage(e.service[e.field.FullAPIName])?"normal":"url-formula-icon"}},scope:{service:"=",field:"="},template:'\n            \n            <span>\n                <span ng-if="getType() == \'normal\'">{{service | displayFieldSetField : field}}</span>\n                <img ng-if="getType() == \'gantt-icons\'" class="img-on-service-list" ng-repeat="img in service.icons track by $index" ng-src="{{img}}" track by $index/>\n                <img ng-if="getType() == \'url-icon\'" class="img-on-service-list" ng-src="{{service[field.FullAPIName]}}" />\n                <img ng-if="getType() == \'url-formula-icon\'" class="img-on-service-list" ng-src="{{isFormulaForImage(service[field.FullAPIName])}}" />\n            </span>    \n            '}}]),angular.module("serviceExpert").directive("serviceListPreview",["utils","FieldSetFieldsService","StateService",function(e,t,i){var n=[],r=i.isRtlDirection();return t.fieldsSetFields().then(function(e){n=e.servicePreview}),{restrict:"E",link:function(e,s,t){e.fields=function(){return n},e.handleOver=function(e){e.stopPropagation();var e=document.body.getBoundingClientRect(),t=$(s).find(".service-quick-view")[0].getBoundingClientRect(),i=t.x-e.x+37,n=t.top-e.top,e=e.right-t.right+37,t=$(s).find(".service-preview")[0];t.style.display="inline-block",$(s).find(".service-preview-triangle")[0].style.display="inline-block",document.body.clientHeight<t.clientHeight+t.getBoundingClientRect().y&&(n=document.body.clientHeight-t.clientHeight-26),r?t.style.right=e+"px":t.style.left=i+"px",t.style.top=n+"px"},e.handleOut=function(e){$(s).find(".service-preview-triangle")[0].style.display="none",$(s).find(".service-preview")[0].style.display="none"}},scope:{service:"="},template:'\n            \n            <span>\n                <div class="service-quick-view" ng-mouseenter="handleOver($event)" ng-mouseleave="handleOut($event)">\n                    <svg aria-hidden="true" class="slds-icon">\n                        <use xlink:href="'+window.lsdIcons.info+'"></use>\n                    </svg>\n                </div>\n\n                <div class="service-preview-triangle"></div>\n\n                <div class="service-preview"> \n                    <div class="preview-field-container" ng-repeat="field in fields() track by $index">\n                        <b class="label-preview">{{field.Label}}</b>: <span ng-if="!service[field.APIName]">-</span> <service-list-column service="service" field="field"></service-list-column>\n                    </div>                    \n                </div>\n\n                \n            </span>    \n            '}}]),!function(){function e(){function e(e){e.callMe=function(e,t,i,n){i=i+" "+n;return sendCTIMessage("/CLICK_TO_DIAL?DN="+encodeURIComponent(e)+"&amp;ID="+t+"&amp;ENTITY_NAME=User&amp;OBJECT_NAME="+encodeURIComponent(i)+"&amp;DISPLAY_NAME="+encodeURIComponent("User")),!1}}e.$inject=["$scope"];return{restrict:"E",template:'<span class="tel" style="display: none;">\n                                <img src="/img/s.gif" alt="" width="1" height="1" title="" onload="if (self.registerClickToDial) registerClickToDial(this.parentNode, false);"></img>{{number}}\n                                <img src="/img/btn_nodial_inline.gif" alt="Click to dial disabled" width="16" height="10" title="Click to dial disabled"></img>\n                            </span> \n                            <span style="display: block;">\n                                <img src="/img/s.gif" alt="" width="1" height="1" title="" onload="if (self.registerClickToDial) registerClickToDial(this.parentNode, true);"></img>\n                                <a href="javascript:void(0);" onclick="disableClicked(this, \'Click to dial disabled\');" ng-click="callMe(number, userId, userFirstName, userLastName)" title="">{{number}}\n                                    <img src="/img/btn_dial_inline.gif" alt="Click to dial" width="16" height="10" title="Click to dial" style="display: inline;"></img>\n                                    <img src="/img/btn_nodial_inline.gif" alt="Click to dial disabled" width="16" height="10" style="display: none;" title="Click to dial disabled"></img>\n                                </a>\n                            </span>',scope:{number:"@",userId:"@",userFirstName:"@",userLastName:"@"},controller:e}}angular.module("serviceExpert").directive("csClickToDial",e),e.$inject=[]}(),angular.module("serviceExpert").directive("dhxScheduler",["$rootScope","$timeout","userSettingsManager","$q","sfdcService","ResourcesAndTerritoriesService","FieldSetFieldsService","TimePhasedDataService",function(c,d,u,m,e,p,h,g){return{restrict:"C",transclude:!0,template:'<div class="dhx_cal_navline" ng-transclude></div><div class="dhx_cal_header"></div><div class="dhx_cal_data"></div>',link:function(e,t,i){window.utils=angular.element("#serviceExpertApp").injector().get("utils");var n=_.debounce(function(e){scheduler.updateCollection("resources",e)},500),i=(e.$watch(i.resources,function(e){folderJustToggled?folderJustToggled=!1:n(e)},!0),t.addClass("dhx_cal_container"),schedulerConfig.configTimelines(),schedulerConfig.setConfigurations(),u.GetUserSettingsProperty("Gantt_View_Start_Hour__c")),s=u.GetUserSettingsProperty("Gantt_View_Finish_Hour__c"),r=u.GetUserSettingsProperty("Resource_Row_Height__c"),o=u.GetUserSettingsProperty("View_Capacity_Type__c"),a=u.GetUserSettingsProperty("Include_Weekends__c"),l=u.GetUserSettingsProperty("Load_On_Today__c");null!==r&&schedulerConfig.setRowHeights(r,!1),null!==o&&setCapacityFilter(o),null!==i&&null!==s&&setHoursToDisplay(i,s,a),c.policy=defaultPolicy,m.all([p.promises.territories(),p.promises.resources(),h.fieldsSetFields()]).then(function(){scheduler.init(t[0],new Date,"ZoomLevel3"),e.scheduler=scheduler,e.datalessMethods=attchDatalessSchedulerEvents(),d(function(){l&&scheduler.setCurrentView(new Date),g.promises.initialStmsPhasedData.then(function(){$("#FirstTimeLoading").remove()}),e.getTimePhasedObjects().then(function(){}).catch(function(e){bootstrap.handleError(e)}),c.$broadcast("initCompleted")},20)}).catch(function(e){console.log("err:"+e)})}}}]),angular.module("serviceExpert").directive("dragNA",function(){return{restrict:"CAE",scope:{dragService:"="},link:function(e,t,i,n){cachedDomElements.draggedBreak||(cachedDomElements.draggedBreak=$("#draggedBreak")),cachedDomElements.draggedBreakDiv||(cachedDomElements.draggedBreakDiv=$("#draggedBreak div")),t.bind("dragstart",function(e){var t,i=$("#breakDuration").val(),n=(e.originalEvent.dataTransfer.setData("text","absenceNA_"+i),cachedDomElements.draggedBreakDiv.html(i),getMinAndMaxHoursToDisplay()),s=new Date(scheduler._min_date.getTime()+1e3*n.min*60*60),n=new Date(scheduler._min_date.getTime()+1e3*n.min*60*60),i=(n.setMinutes(n.getMinutes()+i),getXPositionOfEvent({start_date:s,end_date:n},!1,scheduler.matrix[scheduler._mode])),s=getXPositionOfEvent({start_date:s,end_date:n},!0,scheduler.matrix[scheduler._mode])-i+4,n=(cachedDomElements.draggedBreak.css("width",s+"px"),document.getElementById("draggedBreak").cloneNode(!0));document.body.appendChild(n),"setDragImage"in window.DataTransfer.prototype&&(t="rtl"===document.querySelector("html").getAttribute("dir")?s:0),e.originalEvent.dataTransfer.setDragImage(n,t,40)})}}}),angular.module("serviceExpert").directive("draggableService",["utils","servicesService","SERVICE_STATUS","SERVICE_CATEGORY","StateService",function(a,e,t,l,c){return{restrict:"CAE",scope:{dragService:"="},link:function(o,e,t,i){cachedDomElements.draggedEvent||(cachedDomElements.draggedEvent=$("#draggedEvent")),cachedDomElements.draggedEventDiv||(cachedDomElements.draggedEventDiv=$("#draggedEvent div")),e.bind("dragstart",function(e){e.originalEvent.dataTransfer.setData("text",o.dragService.id);var t="<b>"+(o.dragService.ganttLabel||o.dragService.name)+"</b><br/>"+o.dragService.estDuration+" "+o.dragService.durationType,t=(cachedDomElements.draggedEventDiv.html(t),getMinAndMaxHoursToDisplay()),i=new Date(scheduler._min_date.getTime()+1e3*t.min*60*60),t=new Date(scheduler._min_date.getTime()+1e3*t.min*60*60),n=(o.dragService.durationType?o.dragService.durationType===a.durationTypes.minutes?t.setMinutes(t.getMinutes()+o.dragService.estDuration):o.dragService.durationType===a.durationTypes.hours?t.setMinutes(t.getMinutes()+Math.floor(60*o.dragService.estDuration)):o.dragService.durationType===a.durationTypes.days&&t.setMinutes(t.getMinutes()+Math.floor(60*o.dragService.estDuration*24)):o.dragService.setMinutes(t.getMinutes()+60),getXPositionOfEvent({start_date:i,end_date:t},!1,scheduler.matrix[scheduler._mode])),i=getXPositionOfEvent({start_date:i,end_date:t},!0,scheduler.matrix[scheduler._mode])-n+4,s="";switch(o.dragService.statusCategory){case l.NONE:s=" eventStatusNew";break;case l.SCHEDULED:s=" eventStatusAssigned";break;case l.DISPATCHED:s="eventStatusDispatched";break;case l.IN_PROGRESS:s=" eventStatusTravel";break;case l.COMPLETED:s=" eventStatusCompleted";break;case l.COULD_NOT_COMPLETE:s=" eventStatusCouldntComplete";break;case l.CANCELED:s=" eventStatusCancelled";break;default:s=" eventCustomStatus"}cachedDomElements.draggedEvent.css("width",i+"px"),cachedDomElements.draggedEvent.removeClass(),cachedDomElements.draggedEvent.addClass(s),o.dragService.ganttColor?cachedDomElements.draggedEvent.css("background",o.dragService.ganttColor):cachedDomElements.draggedEvent.css("background","");var r,t=document.getElementById("draggedEvent").cloneNode(!0);document.body.appendChild(t),"setDragImage"in window.DataTransfer.prototype&&(r=c.isRtlDirection()?i:0),e.originalEvent.dataTransfer.setDragImage(t,r,28)})}}}]).directive("dragTarget",["$rootScope","$filter","utils","servicesService","sfdcService","kpiCalculationsService","ResourcesAndTerritoriesService","AbsencesService","TimePhasedDataService","SERVICE_CATEGORY","StateService","OptimizationRequestsService",function(e,t,S,_,i,y,b,w,T,L,A,I){return{restrict:"CAE",link:function(f,e,t,i){var o=Date.now();e.bind("dragover",function(e){var t,i,n,s,r;cachedDomElements.timesDragFix||(cachedDomElements.timesDragFix=$("#timesDragFix")),e.preventDefault(),scheduler.config.readonly||Date.now()-o<500||(o=Date.now(),n=scheduler.getActionData(e.originalEvent),t=b.getResources()[n.section.split("_")[0]],i=n.section.split("_")[1],t&&i&&(i=S.getLocationOffset(n.date,i)-S.getUserOffset(n.date),(r=new Date(n.date)).setMinutes(r.getMinutes()+i),t.name&&(!t.isCapacityBased||t.isCapacityBased&&!contractorSupport)?(r=new Date(n.date),s=(n=n.date.getMinutes())%serviceJumpsOnGantt,r=(n=serviceJumpsOnGantt-n%serviceJumpsOnGantt)<s?new Date(r.getTime()+60*n*1e3):new Date(r.getTime()-60*s*1e3),n=moment(r).format("lll"),(s=new Date(r)).setMinutes(s.getMinutes()+i),r=moment(s).format("lll"),e.originalEvent.ctrlKey?cachedDomElements.timesDragFix.html("<b>"+t.name.encodeHTML()+"</b> "+customLabels.SnapOn+" "+n+"<br/> "+(useLocationTimezone?"":customLabels.Location_time+" "+r)):cachedDomElements.timesDragFix.html("<b>"+t.name.encodeHTML()+"</b> "+customLabels.on+" "+n+"<br/> "+(useLocationTimezone?"":customLabels.Location_time+" "+r)),cachedDomElements.timesDragFix.show()):cachedDomElements.timesDragFix.hide()))}),e.bind("dragleave",function(e){cachedDomElements.timesDragFix.hide(),e.preventDefault()}),e.bind("drop",function(e){if(e.preventDefault(),void 0!==cachedDomElements.draggedEvent&&cachedDomElements.draggedEvent.removeClass(),cachedDomElements.timesDragFix.hide(),!scheduler.config.readonly){var t=scheduler.getActionData(e.originalEvent),i=new Date(t.date),n=t.date.getMinutes(),s=n%serviceJumpsOnGantt,n=serviceJumpsOnGantt-n%serviceJumpsOnGantt,i=n<s?new Date(i.getTime()+60*n*1e3):new Date(i.getTime()-60*s*1e3),n=(t.date=i,b.getResources()[t.section.split("_")[0]]);b.territories()[t.section.split("_")[1]];if(n&&n.name){var r,o,s=e.originalEvent.dataTransfer.getData("text");if(-1<s.indexOf("absenceNA_"))return $("#naOptionsContainer").hide(),i=s.substr(10,s.length-10),i=parseInt(i),(r=new Date(t.date)).setMinutes(r.getMinutes()+i),o={end_date:r,resource:n.id,start_date:t.date,start:t.date,absenceType:"None"==f.defaultDragNa.selectedNaType?null:f.defaultDragNa.selectedNaType,ganttLabel:f.defaultDragNa.selectedNaLabel},void S.safeApply(f,function(){_.handleSnap(o,e),w.saveNewAbsence(o,A.selectedPolicyId).then(function(e){}).catch(function(e){console.warn("Couldn't update absence"),e.error?S.addNotification(customLabels.Action_Could_Not_Be_Performed,e.error):S.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)})});var a=T.serviceAppointments()[s];if(a){i=new Date(t.date);if(a.durationType?a.durationType==S.durationTypes.minutes?i.setMinutes(i.getMinutes()+a.estDuration):a.durationType==S.durationTypes.hours?i.setMinutes(i.getMinutes()+Math.floor(60*a.estDuration)):a.durationType==S.durationTypes.days&&i.setDate(i.getDate()+Math.floor(a.estDuration)):i.setMinutes(i.getMinutes()+60),!I.isTerritoryHasInDayOptimizationInProgress(t.date,i,t.section.split("_")[1])||!1!==confirm(customLabels.In_Day_Optimization_In_Progress_Confirm)){if(contractorSupport&&n.isCapacityBased){for(var l=!1,c=!0,d=scheduler.getEvents(t.date,i),u=0;u<d.length;u++)-1<d[u].resourceId.indexOf(t.section)&&"contractorcapacity"==d[u].type&&(l=!0,d[u].timePeriod==S.ganttSettings.capacityDuration&&(c=!1));if(!l)return void alert(customLabels.serviceCantBeAssignedWithoutCapacity);c&&alert(customLabels.is_assigned_to_contractor.replaceAll(a.name,n.name)+".\n"+customLabels.This_capacity_duration_is_filtered_out+".\n"+customLabels.To_change_the_capacity_duration)}var m,p,h=angular.copy(a),g=(h.end_date=i,h.resourceId=t.section,h.start_date=new Date(t.date),h.assignedResource=null,{statusCategory:L.SCHEDULED,isDummy:!0,id:h.id+"_dummy"}),v=angular.copy(h);for(p in g)v[p]=g[p];m=scheduler.addEvent(v),S.safeApply(f,function(){_.handleSnap(h,e.originalEvent),_.saveChangesToServiceAppointment(a,h).then(function(e){y.calculateKpis()}).catch(function(e){console.warn("Couldn't update service. "+e[2]),S.addNotification(customLabels.Action_Could_Not_Be_Performed,e[2]||e[0].message||customLabels.user_is_not_allowed_to_perform_action),scheduler.deleteEvent(m)&&scheduler.parse([e[1]],"json")})})}}}}})}}}]),angular.module("serviceExpert").directive("googlePlaces",function(){return{restrict:"E",replace:!0,scope:{myMap:"=",searchMarker:"="},template:'<input id="google_places_ac" name="google_places_ac" type="text" class="input-block-level"/>',link:function(t,e,i){var n=new google.maps.places.Autocomplete($("#google_places_ac")[0],{});google.maps.event.addListener(n,"place_changed",function(){var e=n.getPlace();t.searchMarker?t.searchMarker.setPosition(e.geometry.location):t.searchMarker=new google.maps.Marker({map:t.myMap,position:e.geometry.location}),e.geometry.viewport?t.myMap.fitBounds(e.geometry.viewport):(t.myMap.setCenter(e.geometry.location),t.myMap.setZoom(17))})}}}),angular.module("serviceExpert").directive("csGroupActions",["$compile",function(u){function m(e,t,i){return Math.ceil($(e).offset().top)>=t+i}return{restrict:"A",link:function(a,l){var c=$('<ul class="moreQuickActionsContainer"></ul>'),d=void 0;angular.element(l[0]).on("click",function(e){e.stopPropagation(),$("#MainActionContainer").hide();var t=$(l).parent().parent().children(),e=$(t).last(),i=$(t).first(),n=$(i).offset().top,s=$(i).outerHeight(!0);if(c.hasClass("viewMoreActive"))return c.removeClass("viewMoreActive"),c.empty(),void c.remove();if(m($(e),n,s)){for(var r,o=t.length-1;1<o;o--)d=$(t[o]),m(d,n,s)&&(r=$("<li></li>"),d.find("> div:first-child").clone().removeClass("quickActionGoLeft quickCustomActionGoLeft").addClass("menuQuickAction").css({marginBottom:"0",border:"none",width:"87%"}).appendTo(r),r.css({display:"block"}).appendTo(c),u(r)(a));$(c.children().get().reverse()).appendTo(c),$(l).append(c),c.addClass("viewMoreActive"),c.show();i=c.offset().top,e=c.outerHeight(!0);m($("#TaskListPagination"),i,e)||$("#TaskListItems").animate({scrollTop:$("#TaskListItems").scrollTop()+(180<36*c.children().length?180:36*c.children().length)},500)}angular.element("body").on("mousedown",function(e){for(var t=["moreQuickActionsBtn","menuQuickAction","fa-caret-down"],i=0;i<t.length;i++)if(e.target.classList.contains(t[i])||e.target.parentNode&&e.target.parentNode.classList.contains(t[i]))return;c.hasClass("viewMoreActive")&&(c.removeClass("viewMoreActive"),c.empty(),c.remove(),angular.element("body").off("mousedown"))})})}}}]).directive("csLastAction",["utils","listQuickActionsService",function(s,r){return{restrict:"A",link:function(e,t,i){var t=$(t),e=e.service,i=i.csLastAction,n=s.getCustomActions("list");r.isLastVisibleQuickAction(i,e)&&0===n.length&&((i=t).hide(),i.parent().children()[0].classList.add("lastQuickAction"))}}}]),angular.module("serviceExpert").directive("keypressEvents",["$rootScope","StateService",function(t,i){var n=[13,16,18,27,37,38,39,40,48,49,50,51,55,69,70,73,77,79,83,84,85,87,90,96,97,98,99,103];return{restrict:"C",link:function(){angular.element("body").bind("keydown",function(e){i.isUserIdle()||(-1<n.indexOf(e.which)?t.$broadcast("keypress",e):e.stopPropagation())})}}}]).directive("fslKeyPress",function(){return{restrict:"A",link:function(e,t,i){t.bind("keypress",function(e){e.stopPropagation(),13!==e.keyCode&&32!==e.keyCode||angular.element(e.target).trigger("click")})}}}).directive("fslTabSwitch",function(){var a=37,l=38,c=39,d=40,u={37:-1,38:-1,39:1,40:1};return{restrict:"A",link:function(e,t,o){t.bind("keydown",function(e){if(e.keyCode===a||e.keyCode===c||e.keyCode===l||e.keyCode===d){for(var t=e,i=o.role,n=t.keyCode,s=t.target.parentElement.querySelectorAll('[role="'+i+'"]'),r=0;r<s.length;++r)s[r].index=r;void 0!==u[n]&&void 0!==(i=t.target).index&&(s[i.index+u[n]]?s[i.index+u[n]].focus():n===a||n===l?s[s.length-1]&&s[s.length-1].focus():n!==c&&n!==d||s[0]&&s[0].focus()),e.stopPropagation(),e.preventDefault()}})}}}),!function(){function e(e,o,t){return{restrict:"E",link:function(r){r.optimizationRequests={},r.optRunning=0,r.optQueued=0,r.replaceText=function(e,t){return customLabels[e].replaceAll(t.toString())},t.register("optimizationRequests",function(e){for(var t=0,i=0,n=0;n<e.length;n++){var s=new OptimizationRequest(e[n]);"Queued"==s.status&&i++,"In Progress"==s.status&&t++,r.optimizationRequests[s.id]&&"Completed"==s.status&&"Completed"!=r.optimizationRequests[s.id].status&&o.addNotification(customLabels.Optimization_Completed,customLabels.x_services_were_sched_out_of.replaceAll(s.scheduledAmount,s.objectToScheduled)+".",function(e){o.openSObjectLink("../"+e)},s.id),r.optimizationRequests[s.id]&&"Failed"==s.status&&"Failed"!=r.optimizationRequests[s.id].status&&o.addNotification(customLabels.Optimization_Failed,customLabels.error_in_opt,function(e){o.openSObjectLink("../"+e)},s.id),r.optimizationRequests[s.id]=s}r.optQueued=i,r.optRunning=t})},scope:{},template:'\n                <div id="optInProgress" ng-show="optRunning">\n                    '+customLabels.Optimization_in_progress+"\n\t            \t<span ng-show=\"optRunning > 1\">{{ replaceText('XoptimizationRunning',optRunning) }}</span>\n\t            \t<span ng-show=\"optQueued\">{{ replaceText('XoptimizationQueued',optQueued) }}</span>\n        \t\t</div>"}}e.$inject=["DeltaService","utils","RegisterService"],angular.module("serviceExpert").directive("optimizationIndicator",e)}(),angular.module("serviceExpert").directive("csStopPropagation",[function(){return{restrict:"A",link:function(e,t,i){angular.element(t[0]).on(i.csStopPropagation,function(e){e.stopPropagation()})}}}]),angular.module("serviceExpert").directive("csToggle",[function(){return{restrict:"A",link:function(e,t,i){for(var n=$("#"+i.csToggle),s=$("[cs-toggle]"),r={},o=0;o<s.length;o++){var a=$(s[o]);r[a.attr("id")]=$("#"+a.attr("cs-toggle"))}1===n.length&&(angular.element(t[0]).on("click",function(e){for(var t in e.stopPropagation(),$(".moreQuickActionsContainer").hide(),scheduler.isCalendarVisible()&&scheduler.destroyCalendar(),r)t!==e.currentTarget.id?(r[t].hide(),$(".dhx_mini_calendar").hide()):n.toggle()}),angular.element(t[0]).on("keyup",function(e){13===e.keyCode&&n.children()[0].focus()}),angular.element("body").on("click",function(e){for(var t in r)r[t].hide()}),n.children().on("keydown",function(e){if(27===e.keyCode)for(var t in r)r[t].hide()}))}}}]),angular.module("serviceExpert").directive("csTooltip",[function(){return{restrict:"E",transclude:!0,template:'<div class="gantt-tooltip-info-button">\n                                    <svg aria-hidden="true" class="slds-icon info-tooltip-icon">\n                                        \u2028<use xlink:href="'+lsdIcons.info+'"></use>\n                                    \u2028</svg>\n                                </div>\n                                <span class="gantt-tooltip-wrapper" ng-transclude></span>',link:function(e,n,t){var s=!0;n.find(".gantt-tooltip-info-button").bind("mouseenter mouseleave",function(){var e=n.find(".gantt-tooltip-wrapper"),t=e.outerHeight(),i=n.offset();e.toggleClass("active-tooltip"),s&&(s=!1,e.css("top",i.top-t-10+"px"),e.css("position","fixed"),e.css("bottom","initial"))})}}}]),angular.module("serviceExpert").factory("SERVICE_CATEGORY",function(){return{NONE:"None",SCHEDULED:"Scheduled",DISPATCHED:"Dispatched",IN_PROGRESS:"InProgress",COULD_NOT_COMPLETE:"CannotComplete",COMPLETED:"Completed",CANCELED:"Canceled"}}),angular.module("serviceExpert").factory("SERVICE_STATUS",function(){return serviceStatuses}),angular.module("serviceExpert").constant("PARENT_RECORD_TYPE",{WORKORDER:"WorkOrder",LINEITEM:"WorkOrderLineItem",ACCOUNT:"Account"}),angular.module("serviceExpert").constant("DRAWING_STATES",{NONE:0,EDIT:1,DRAW:2,SELECTED:3,INTERSECT:4}),angular.module("serviceExpert").constant("POST_MESSAGE_TYPE",{INIT:0,SHOW_ON_MAP:1,DRAW_MARKERS:2}),!function(){function e(e,t,c,i,d,n,s){var l={},u={},r={},o={},m={};function a(e){if(e.type===o.IN_DAY){if("In Progress"===e.status||"Completed"===e.status&&m[e.id]&&"Completed"!==m[e.id].status||"In Progress"===e.status&&m[e.id]&&"Aborted"!==m[e.id].status)e.timespan=function(e){var t=[];if(e.territories){for(var i={},n=0;n<e.territories.length;n++)i[e.territories[n].serviceTerritory]=!0;var s,r=d.getGanttSectionsIdsByTerritory(i,e.start);for(s in r){var o,a={start:e.start,end:e.finish};for(o in useLocationTimezone||(a.start=c.convertDateBetweenTimeZones(e.start,userTimeZone,r[s].tz),a.end=c.convertDateBetweenTimeZones(e.finish,userTimeZone,r[s].tz)),u[s]||(u[s]={}),u[s][e.id]=a,r[s].resources){var l=scheduler.addMarkedTimespan({start_date:a.start,end_date:a.end,sections:{ZoomLevel2:o+"_"+s,ZoomLevel3:o+"_"+s,ZoomLevel4:o+"_"+s,ZoomLevel5:o+"_"+s,ZoomLevel6:o+"_"+s,ZoomLevel7:o+"_"+s},css:"smart-on-gantt-inday-body"});t.push(l)}}}return t}(e);else if("Completed"===e.status||"Failed"===e.status||"Aborted"===e.status)for(var t=0;t<e.territories.length;t++)u[e.territories[t].serviceTerritory]&&u[e.territories[t].serviceTerritory][e.id]&&delete u[e.territories[t].serviceTerritory][e.id]}else"Failed"!==e.status&&"Aborted"!==e.status&&"Completed"!==e.status&&"Global Optimization"!==e.type&&e.start&&e.finish&&(e.timespan=[function(e){if(!e.resource)return(new Date).getTime();var t=void 0,i=d.getResoruceGanttIdByDate(e.resource,e.start),n="reshufle-on-gantt",s="";{if(!i)return(new Date).getTime();t=i.split(",")}switch(e.type){case"Fix Overlaps":n="fix-overlaps-on-gantt",s=customLabels.FixOverlaps;break;case"SA Reshuffle":n="reshufle-on-gantt",s=customLabels.Reshuffle;break;case"Fill-In Schedule":n="fillin-on-gantt",s=customLabels.Fill_in_Schedule;break;case"Group Nearby SAs":n="group-near-on-gantt",s=customLabels.GroupNearby;break;case"Resource Schedule Optimization":n="resource-day-on-gantt",s=customLabels.RDOptimize;break;default:n="reshufle-on-gantt"}{var r;window.useLocationTimezone&&e.territories&&e.territories[0]&&"Resource Schedule Optimization"!==e.type?(i=c.getLocationOffset(e.start,e.territories[0].serviceTerritory),r=c.getLocationOffset(e.finish,e.territories[0].serviceTerritory),e.start.setMinutes(e.start.getMinutes()+i),e.finish.setMinutes(e.finish.getMinutes()+r)):e.territories&&e.territories[0]&&"Resource Schedule Optimization"===e.type&&(i=c.getLocationOffset(e.start,e.territories[0].serviceTerritory),r=c.getLocationOffset(e.finish,e.territories[0].serviceTerritory),e.start=new Date(e.start.getTime()-60*i*1e3+60*c.getUserOffset(e.start)*1e3),e.finish=new Date(e.finish.getTime()-60*r*1e3+60*c.getUserOffset(e.finish)*1e3))}return scheduler.addMarkedTimespan({start_date:e.start,end_date:e.finish,sections:{ZoomLevel2:t,ZoomLevel3:t,ZoomLevel4:t,ZoomLevel5:t,ZoomLevel6:t,ZoomLevel7:t},css:"smart-on-gantt "+n,html:"<div><span>"+s+"</span></div>"})}(e)])}function p(e){if(!c.hasCustomPermission("Abort_Optimization_Request"))return!1;if(m[e.id]&&m[e.id].aborting)return!1;if("Completed"===e.status||"Aborted"===e.status||"Failed"===e.status||"Finalizing"===e.status)return!1;for(var t in o)if(e.type==o[t])return!0;return!1}return e.all([d.promises.initialPhasedData,n.promises.policies(),t.getOptimizationRequests(),t.callRemoteAction(RemoteActions.getOptimizationsRequestTypes)]).then(function(e){e[1].forEach(function(e){r[e.Id]=e}),o=e[3],e[2].forEach(function(e){l[e.Id]=new OptimizationRequest(e),m[e.Id]={canAbort:p(l[e.Id]),status:l[e.Id].status,objectToScheduled:l[e.Id].objectToScheduled,aborting:!1,progressInterval:null},a(l[e.Id])})}),i.register("optimizationRequests",function(e){e.forEach(function(e){var t=new OptimizationRequest(e);if(l[e.Id]&&l[e.Id].timespan)for(var i=0;i<l[e.Id].timespan.length;i++)scheduler.deleteMarkedTimespan(l[e.Id].timespan[i]);if(l[e.Id]&&"Global Optimization"===l[e.Id].type)for(var n in t)l[e.Id][n]=t[n];else l[e.Id]=t;m[e.Id]?m[e.Id].canAbort=p(t):m[e.Id]={canAbort:p(t),status:t.status,objectToScheduled:t.objectToScheduled,aborting:!1,progressInterval:null},a(t)}),updateViewDebounced()}),{getNumOfActiveOptimizationRequests:function(){var e,t=0;for(e in l)"Completed"!==l[e].status&&"Failed"!==l[e].status&&"Aborted"!==l[e].status&&t++;return t},optimizationRequests:function(){return l},isTerritoryHasInDayOptimizationInProgress:function(e,t,i){if(u[i])for(var n in u[i])if(isIntersect(u[i][n].start,u[i][n].end,e,t))return l[n];return!1},policies:r,OptimizationRequestsProgressStatus:m,generateRequestResultText:function(e){if(e.failureReason&&0<e.failureReason.length)return"User Aborted"===e.failureReason?e.failureDetails:e.failureReason;if(e.type==o.RSO&&s.getResources()[e.resource])return customLabels.rso_optimization_request_for_name.replaceAll(e.resourceName);if(e.type==o.IN_DAY||e.type==o.BGO){var t=[];if(e.territories.forEach(function(e){t.push(e.serviceTerritoryName)}),t=3<t.length?t.length+" "+customLabels.UTterr:t.join(", "),"In Progress"==e.status)return customLabels.optimization_for_terr_in_progress.replaceAll(e.type,t);if("Completed"==e.status)return(e.scheduledAmount||0===e.scheduledAmount?customLabels.optimization_for_terr_completed:customLabels.o2_optimization_for_terr_completed).replaceAll(e.type,t,e.scheduledAmount)}return e.result},calculateIndayProgress:function(i){var e=void 0;if("Completed"==i.status)return m[i.id].status="Completed",setTimeout(function(){if(l[i.id]&&l[i.id].timespan)for(var e=0;e<l[i.id].timespan.length;e++)scheduler.deleteMarkedTimespan(l[i.id].timespan[e]);for(var t=0;t<i.territories.length;t++)u[i.territories[t].serviceTerritory]&&u[i.territories[t].serviceTerritory][i.id]&&delete u[i.territories[t].serviceTerritory][i.id]},2e3),{percent:100,text:customLabels.In_Day_Optimization_Completed};"In Progress"==i.status&&m[i.id]&&"Aborted"==m[i.id].status?e=customLabels.In_Day_Optimization_Aborting:(e=customLabels.In_Day_Optimization_In_Progress,m[i.id].status="In Progress");var t=__gantt.inday,n=i.objectToScheduled,n=t.maxRunTimeSingleService*n,s=null!=i.requestProgressStart?(new moment).diff(moment(i.requestProgressStart),"seconds"):0,r=(n>=t.maxRuntimeOverall&&(t.maxRuntimeOverall,t.maxRunTimeSingleService,n=t.maxRuntimeOverall),0!==n?s/n*100:0),o=7,a=0;return n<=s&&"In Progress"==i.status&&(o=7+(s-n)/t.maxRunTimeSingleService*.1,a=90),100<=(a=a<90?r:a)&&100<=r?a=100:90<=a&&(o+=.1,a=Math.round(Math.atan(o)/(Math.PI/2)*100*1e3)/1e3),{percent:100!==a?a.toFixed(1):a,text:e}},updateProgressStatus:function(e,t){m[e]?m[e].status=t:m[e]={status:t}},canAbortOR:p,abortOptRequest:function(e){confirm(customLabels.confirm_abort_current_optimization)&&(e.status="Aborting",m[e.id]?(m[e.id].aborting=!0,m[e.id].canAbort=!1):m[e.id]={aborting:!0,canAbort:!1},t.callRemoteAction(RemoteActions.abortOptimizationRequest,e.id).then().catch(function(e){console.warn(e)}))}}}e.$inject=["$q","sfdcService","utils","RegisterService","TimePhasedDataService","StateService","ResourcesAndTerritoriesService"],angular.module("serviceExpert").factory("OptimizationRequestsService",e)}(),angular.module("serviceExpert").factory("listQuickActionsService",["BundleActions","BundleService","utils","SERVICE_STATUS","SERVICE_CATEGORY","StateService",function(t,i,n,s,r,o){var a=[];function l(e){for(var t=CustomSettings.pinnedStatusesSF.split(","),i=0;i<t.length;i++)if(e===t[i])return 1}n.customActionsPromise.then(function(){var e=n.getCustomActions("list");a.push.apply(a,_toConsumableArray(e))});var c={flagUnflag:function(e){return!0},schedule:function(e){return!e.pinned&&e.status!=s.COMPLETED&&e.statusCategory!=r.CANCELED&&!l(e.status)&&n.hasCustomPermission("Schedule")&&(!i.isActive()||!i.isBundleMember(e))},getCandidates:function(e){return!(!(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Get_Candidates||window.__gantt.ignoreReadonlyGantt226)||e.pinned||e.status==s.COMPLETED||e.statusCategory==r.CANCELED||l(e.status)||i.isActive()&&i.isBundleMember(e))},edit:function(e){return!0},reshuffle:function(e){return!e.pinned&&n.hasCustomPermission("Reshuffle")&&(!i.isActive()||!i.isBundleMember(e))},groupNearby:function(e){return e.isScheduled()&&e.latitude&&e.longitude&&n.hasCustomPermission("Group_Nearby")&&(!i.isActive()||!i.isBundleMember(e))},dispatch:function(e){return!(e.pinned||e.status!=s.SCHEDULED||i.isActive()&&i.isBundleMember(e))},gantt:function(e){return!!(e=i.verifyShowSaOnGantt(e))&&e.isScheduled()},map:function(e){return o.isMapEnabled()&&e.latitude&&e.longitude},bundle:function(e){return n.hasCustomPermission("Bundle_Unbundle")&&t.Bundle.canInvoke([e])},unbundle:function(e){return n.hasCustomPermission("Bundle_Unbundle")&&t.Unbundle.canInvoke([e])}},e={shouldShowQuickActionBtn:function(e,t){return!(!t||!c[e])&&c[e](t)},isLastVisibleQuickAction:function(e,t){if(0<a.length)return!1;var i,n=!1;for(i in c)if(n){if(this.shouldShowQuickActionBtn(i,t))return!1}else if(e==i){if(!this.shouldShowQuickActionBtn(e,t))return!1;n=!0}return n}};return e}]),angular.module("serviceExpert").factory("servicesService",["$q","$rootScope","BundleService","sfdcService","utils","userSettingsManager","monthlyViewHelperService","TimePhasedDataService","ServiceAppointmentLightboxService","kpiCalculationsService","bulkResultsService","SERVICE_STATUS","SERVICE_CATEGORY","StateService","MstResolver","DeltaService",function(h,e,m,g,v,a,t,w,f,d,S,i,n,y,b,T){var s=new Date,L=(s.setDate(s.getDate()+3),window.globalStatuses=i,window.globalCategories=n,{servicesObjects:{},recentlyUsed:{},flagged:flaggedServices,filteredServices:{servicesArray:[]},filter:{searchOnServer:null,advancedFilter:{statusCheckboxs:{New:!0,Assigned:!0,Dispatched:!0,Travel:!0,"On Site":!0,Incomplete:!0},selectedDates:{dueDate:!0,appEnd:!0,end_date:!0},minDate:new Date(Date.now()-6048e5),maxDate:new Date(Date.now()+6048e5),servicePriority:10,jeopardies:!0,violations:!0,unScheduled:!0},selectedFiled:{appEnd:!0,appStart:!0,dueDate:!0,earlyStart:!0,finish:!0,start:!0,display:!0},selectedFilter:a.GetUserSettingsProperty("Selected_List_View__c")||(customPermissions.Service_List_Todo?"Todo":"All"),orderByField:"start",reverse:!1,SearchText:"",endDate:s,currentPage:1,servicesPerPage:200,totalServices:0,totalPages:1}});if(a.GetUserSettingsProperty("Date_Horizon_Properties__c")){var r,o=JSON.parse(a.GetUserSettingsProperty("Date_Horizon_Properties__c"));for(r in o)L.filter.selectedFiled[r]=o[r]}function A(e){return e.getDate()+"_"+e.getMonth()+"_"+e.getFullYear()}function l(i,n,s,e){var r=3<arguments.length&&void 0!==e&&e,o={};i.schedulingResult&&Array.isArray(i.schedulingResult)&&i.schedulingResult[0]?(o.partialResults=i.schedulingResult[0].PartialResults||[],0===i.services.length?g.callRemoteAction(RemoteActions.getServicesById,[s]).then(function(e){o.absences=w.updateTimePhaseData(i.na,"na",!r).absences,o.services=w.updateTimePhaseData(i.services,"service",!r).services,(t=o.services).push.apply(t,_toConsumableArray(w.updateTimePhaseData(e,"service",!r).services));var t=a.GetUserSettingsProperty("locations");1===e.length&&-1===t.indexOf(o.services[o.services.length-1].ServiceTerritoryId)&&v.addNotification(customLabels.SchedulingResult,customLabels.WasScheduledToFilteredTeritory.replace("$0",o.services[o.services.length-1].AppointmentNumber)),n.resolve(o),"On Demand"!==window.__gantt.checkRulesMode&&L.checkRules(v.getRelatedServices(s)).then(L.drawViolationsOnGantt)}):(o.absences=w.updateTimePhaseData(i.na,"na",!r).absences,o.services=w.updateTimePhaseData(i.services,"service",!r).services,n.resolve(o),"On Demand"!==window.__gantt.checkRulesMode&&L.checkRules(v.getRelatedServices(s)).then(L.drawViolationsOnGantt))):(o.absences=w.updateTimePhaseData(i.na,"na",!r).absences,o.services=w.updateTimePhaseData(i.services,"service",!r).services,n.resolve(o),"On Demand"!==window.__gantt.checkRulesMode&&L.checkRules(v.getRelatedServices(s)).then(L.drawViolationsOnGantt))}return v.ganttSettings&&(L.filter.servicesPerPage=parseInt(v.ganttSettings.servicesPerPage)),L.checkRules=function(e){var t,s=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:-1;if(-1===r&&(r=window.__gantt.maxIterationsOfCheckRules),0===(e=e.filter(function(e){return w.serviceAppointments()[e]&&w.serviceAppointments()[e].isScheduled()})).length)return(t=h.defer()).resolve([]),t.promise;for(var o=function(e){var t=window.__gantt.maxResourcesForCheckRules,i=window.__gantt.dayRangeForCheckRules,n=window.__gantt.maxServicesForCheckRules,s={},r=[],o=null,a=null,l={},c=0,d=0,u=0,m=0;e.forEach(function(e){var t=w.serviceAppointments()[e],i=A(t.start);(!o||o>t.start)&&(o=t.start),(!a||a<t.start)&&(a=t.start),s[t.resource]=s[t.resource]||{},s[t.resource][i]=s[t.resource][i]||[],s[t.resource][i].push(e)});for(var a=new Date(a.getFullYear(),a.getMonth(),a.getDate()+1),p=new Date(o);p<a;p.setDate(p.getDate()+1)){var h,g=A(p);for(h in++m===i&&(u++,m=c=d=0,l={}),s){if(s[h][g])if(r[u]=r[u]||[],(v=r[u]).push.apply(v,_toConsumableArray(s[h][g])),n<=(d+=s[h][g].length)&&(u++,m=c=d=0,l={}),!l[h]&&(l[h]=!0,++c===t)){if(d<=n){var v=new Date(p),f=(v.setDate(v.getDate()+1),new Date(v));f.setDate(f.getDate()+i-m+1);for(var S=v;S<f;S.setDate(S.getDate()+1)){var _,y,b=A(S);for(_ in l)if(s[_][b]&&((y=r[u]).push.apply(y,_toConsumableArray(s[_][b])),d+=s[_][b].length),delete s[_][b],n<=d)break;if(n<=d)break}}u++,m=c=d=0,l={}}delete s[h][g]}}return r=r.filter(function(e){return e})}(e),a=[],l={},c=h.defer(),i=0;i<o.length;i++)a.push(h.defer()),a[i].promise.then(function(n){g.checkRules(o[n],y.selectedPolicyId).then(function(e){for(var t in r--,o[n].forEach(function(e){return l[e]=!0}),e){delete l[t];var i=w.serviceAppointments()[t];0<e[t].length&&i?(i.violations=e[t],s.push(t)):i&&(i.violations=null)}if(0===r)return d.calculateKpis(),c.resolve(s),void(a[n+1]&&v.addNotification(window.customLabels.ValidateRulesApiExceededTitle,window.customLabels.ValidateRulesApiExceededMessage));a[n+1]?a[n+1].resolve(n+1):0===Object.keys(l).length?(d.calculateKpis(),c.resolve(s)):L.checkRules(Object.keys(l),s,r).then(function(e){d.calculateKpis(),c.resolve([].concat(_toConsumableArray(e),_toConsumableArray(s)))})}).catch(function(e){v.addNotification(customLabels.Rule_validation_failed,e.message),c.reject(e),console.warn("rule checking failed"),console.log(e)})});return a[0].resolve(0),c.promise},L.postToChatter=function(e,t){var i=h.defer();return g.callRemoteAction(RemoteActions.postToChatter,e,t).then(function(e){i.resolve(e)}),i.promise},L.sortServicesByPriority=function(e){var t=h.defer();return g.callRemoteAction(RemoteActions.sortServicesByPriority,e).then(function(e){t.resolve(e)}),t.promise},L.autoScheduleService=function(s){var r=1<arguments.length&&void 0!==arguments[1]&&arguments[1],o=h.defer();return null==window.userHasAdminPermissions&&g.callRemoteAction(RemoteActions.userHasAdminPermissions).then(function(e){window.userHasAdminPermissions=e}),g.autoScheduleService(s,y.selectedPolicyId).then(function(e){var t,i,n;e.schedulingResult&&Array.isArray(e.schedulingResult)&&e.schedulingResult[0]&&(i=e.schedulingResult[0].PartialResults||[],t="",0<i.length&&(window.userHasAdminPermissions?i.forEach(function(e){t+=customLabels.partialResults[e.Operation].replaceAll(e.Processed,e.Total)+"<br/>"}):t+=customLabels.ContactSysAdmin,""!==t&&v.addNotification(customLabels.NotAllResult.replace("$0",e.schedulingResult[0].Service.AppointmentNumber),t))),e.schedulingResult&&Array.isArray(e.schedulingResult)&&e.schedulingResult[0]&&e.schedulingResult[0].LongOperationId?b.getUpdates(e.schedulingResult[0].LongOperationId).then(function(e){e.services&&(e.mst=!0,r?l(e,o,s,!0):o.resolve(e))}).catch(function(e){console.error(e),o.reject("string"==typeof e?{eventType:"exception",message:e}:e)}):(e.services=e.deltaResult.updatedGanttServices,e.na=e.deltaResult.updatedAbsence,i="On Demand"!==window.__gantt.checkRulesMode,T.handleDeltaResponse(e.deltaResult,i),e.schedulingResult&&Array.isArray(e.schedulingResult)&&e.schedulingResult[0]&&(i=e.schedulingResult[0].PartialResults||[],n="",0<i.length&&(window.userHasAdminPermissions?i.forEach(function(e){n+=customLabels.partialResults[e.Operation].replaceAll(e.Processed,e.Total)+"<br/>"}):n+=customLabels.ContactSysAdmin,""!==n&&v.addNotification(customLabels.NotAllResult.replace("$0",e.schedulingResult[0].Service.AppointmentNumber),n))),l(e,o,s))}).catch(function(e){var t;e.message&&(e.message.includes("Too many SOQL queries")||e.message.includes("Apex CPU time limit"))?(t="On Demand"!==window.__gantt.checkRulesMode,T.getDelta(t)):console.log(e),o.reject(e)}),o.promise},L.saveChangesToServiceAppointment=function(o,a){var e,l=h.defer(),c=new Date(a.start_date.getTime()+1e3*a.travelTo),d=new Date(a.end_date.getTime()-1e3*a.travelFrom),t=!!a.savedFromScheduleHereAndConsecutive,i=(useLocationTimezone&&(e=w.getIntersectingSrstOffset(a,a.getGanttResource()),i=v.getUserOffset(c),n=v.getUserOffset(d),c.setMinutes(c.getMinutes()+i-e),d.setMinutes(d.getMinutes()+n-e)),L.recentlyUsed[o.id]=!0,a.snapToId&&a.ServiceAppointmentLastModifiedDate--,null),n=null;if(a.snapToId){var s,r,u=[],m=scheduler._events[a.snapToId].end||scheduler._events[a.snapToId].finish;for(s in scheduler._events)s!==a.id&&((r=scheduler._events[s]).resourceId===a.resourceId&&"break"!==r.type&&r.latitude&&isIntersect(r.start_date,r.end_date,scheduler._min_date,m)&&u.push(s));u.sort(function(e,t){return scheduler._events[e].start>scheduler._events[t].start?-1:scheduler._events[e].start<scheduler._events[t].start?1:0}),0<u.length&&(i=scheduler._events[u[0]].latitude,n=scheduler._events[u[0]].longitude)}var p=null;return a.isImmidietlyFollow&&!window.__lockedServicesIds[a.id]&&(window.__lockedServicesIds[a.id]=!0,p={id:a.relatedService1||a.relatedService2,isFirst:!!a.relatedService1},w.serviceAppointments()[p.id]&&(window.__lockedServicesIds[p.id]=!0)),g.saveChangesToServiceAppointment(a.id,a.getGanttResource(showSecondarySTMs),a.assignedResource,c,d,y.selectedPolicyId,a.scheduleMode,a.snapToId||null,a.snapToType||null,a.snapDirection||null,i,n,t).then(function(t){scheduler._events[a.id+"_dummy"]&&scheduler.deleteEvent(a.id+"_dummy");var i,e,n,s,r="On Demand"!==window.__gantt.checkRulesMode;T.handleDeltaResponse(t,r),t.ValidationError?(window.__lockedServicesIds[a.id]=!1,_.isEmpty(o)?l.reject(["",a.eventBeforeDrag,t.ValidationError]):l.reject(["",o,t.ValidationError])):p&&p.id?(r=w.serviceAppointments()[p.id]||{id:p.id,scheduleMode:a.scheduleMode},i=angular.copy(r),e=scheduler._events[a.id],n=p.isFirst?"left":"right",s=v.getServiceDurationInTheory(r)/1e3/60,i.start_date=new Date(r.start),i.end_date=new Date(r.start),i.start_date.setMinutes(e.start.getMinutes()+1),i.end_date.setMinutes(e.start.getMinutes()+s+1),(d=new Date(c)).setMinutes(d.getMinutes()+s),g.saveChangesToServiceAppointment(i.id,a.getGanttResource(showSecondarySTMs),null,c,d,y.selectedPolicyId,i.scheduleMode,a.id,"service",n,null,null).then(function(){window.__lockedServicesIds[a.id]=!1,window.__lockedServicesIds[i.id]=!1;var e="On Demand"!==window.__gantt.checkRulesMode;T.handleDeltaResponse(t,e),l.resolve({})})):l.resolve({})}).catch(function(e){window.__lockedServicesIds[a.id]=!1,a.relatedService1&&(window.__lockedServicesIds[a.relatedService1]=!1),a.relatedService2&&(window.__lockedServicesIds[a.relatedService2]=!1),_.isEmpty(o)?l.reject([e,a.eventBeforeDrag,e.message]):l.reject([e,o,e.message]),console.warn(e)}),l.promise},L.handleSnap=function(e,t){var i=2<arguments.length&&void 0!==arguments[2]&&arguments[2];if(t.ctrlKey){var n,s=[];for(n in scheduler._events){var r=scheduler._events[n];"service"!==r.type&&"na"!==r.type||-1<r.id.indexOf("dummy")||r.id===e.id||e.resourceId&&-1===r.resourceId.indexOf(e.resourceId)||isIntersect(r.start_date,r.end_date,e.start_date,e.end_date)&&s.push(r)}s.sort(function(e,t){return e.start>t.start?1:e.start<t.start?-1:0}),s.length>(i?1:0)?(t=new Date(e.start_date),i="right",(t=e.travelTo?t.setSeconds(t.getSeconds()+e.travelTo):t)<s[s[0].isDummy?1:0].start&&(i="left"),s[t=s[t=0].isDummy?1:t]?(e.snapToId=s[t].id,e.snapToType=s[t].type,e.snapDirection=i):(e.snapToId=null,e.snapToType=null,e.snapDirection=null)):(e.snapToId=null,e.snapToType=null,e.snapDirection=null)}},L.unscheduleServices=function(c,e,d,u){var m=h.defer(),t=u?g.unscheduleServicesByLocationsId:g.unscheduleServicesByServicesId,p=null;return u||(p=v.getRelatedServices(c)),t(c,e,d,u).then(function(e){var i,l={};e.nothingToUnschedule?m.resolve(e):(i=h.defer(),e.fslOperation?b.getUpdates(e.fslOperation).then(function(t){console.log(t);var e=t.fslOperation.result.services;g.callRemoteAction(RemoteActions.getServicesById,e).then(function(e){w.updateTimePhaseData(e,"service").services,i.resolve({services:e,resourceAbsences:[],resourceCapacities:[],failedResults:t.fslOperation.result.failedResults})})}).catch(function(e){i.reject("string"==typeof e?{eventType:"exception",message:e}:e)}):i.resolve(e),i.promise.then(function(t){l.absences=w.updateTimePhaseData(t.resourceAbsences,"na",!0).absences,l.services=w.updateTimePhaseData(t.services,"service",!0).services,l.capacities=w.updateTimePhaseData(t.resourceCapacities,"capacity").capacities,l.failedResults=t.failedResults,L.drawServicesAndAbsences(l.services,l.absences),u||"On Demand"===window.__gantt.checkRulesMode||L.checkRules(p).then(L.drawViolationsOnGantt),u&&"On Demand"!==window.__gantt.checkRulesMode&&L.checkRules(v.getServicesOfLocations(c,d,u)).then(L.drawViolationsOnGantt);var i,n,s,r,e,o=void 0,a=void 0;1!==c.length||u?(i=[],n=[],u?t.services.forEach(function(e){(t.failedResults[e.Id]&&w.serviceAppointments()[e.Id].isScheduled()?n:i).push(e.Id)}):c.forEach(function(e){(w.serviceAppointments()[e].isScheduled()?n:i).push(e)}),o=customLabels.x_services_were_unscheduled.replaceAll(i.length),a=u?customLabels.x_services_were_unscheduled_out_of_y.replaceAll(i.length,i.length,n.length+i.length):customLabels.x_services_were_unscheduled_out_of_y.replaceAll(i.length,i.length,c.length),0<n.length&&(a+="<div title='"+n.map(function(e){return w.serviceAppointments()[e].name}).join(", ")+"' class='dashedBorder' style='display:inline-block;'> "+customLabels.failed_to_unschedule.replaceAll(n.length)+". "+customLabels.View_services+"</div>"),s=angular.copy(t),r=[],s.services.forEach(function(e){if(u)e.Fields.SchedStartTime||r.push(e);else for(var t=0;t<c.length;t++)e.Id===c[t]&&r.push(e)}),s.services=r,v.addNotification(o,a,function(){var e={success:customLabels.SuccessfullyUnscheduled,fail:customLabels.FailToUnschedule};S.open(s,e)})):(e=w.serviceAppointments()[c[0]].name,a=w.serviceAppointments()[c[0]].isScheduled()?(o=customLabels.Couldnt_unschedule.replaceAll(e),customLabels.Couldnt_unschedule.replaceAll(e)+". "+t.failedResults[c[0]].errorMessage):(o=customLabels.was_unscheduled.replaceAll(e),customLabels.was_unscheduled_successfully.replaceAll(e)),v.addNotification(o,a,function(){L.recentlyUsed[c[0]]=!0,f.open(c[0])})),m.resolve(l)}))}).catch(function(e){m.reject(e),console.warn(e)}),m.promise},L.drawServicesAndAbsences=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[],n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:[];if(0!==e.length||0!==t.length||0!==i.length||0!==n.length){var s,r,o={},a={},l={},c={scheduledServices:[],unscheduledServices:[],deletedIds:i};for(r in Array.isArray(e)?e.forEach(function(e){return o[e.id||e.Id]=e instanceof GanttService?e:new GanttService(e)}):o=e,Array.isArray(t)?t.forEach(function(e){return a[e.id||e.Id]=e}):a=t,Array.isArray(n)?n.forEach(function(e){return l[e.id||e.Id]=e}):l=n,s=angular.extend({},o,a,l)){var d=s[r];(!function(e){if(m.isActive()&&m.isBundleMember(e))return void(scheduler._events[e.id]&&delete scheduler._events[e.id]);if(e.isScheduled())return e.setGanttResource(w.resourcesAndTerritories(),v.generateResourceId),1;scheduler._events[e.id]&&delete scheduler._events[e.id];return}(d)?c.unscheduledServices:c.scheduledServices).push(d)}if(i.forEach(function(e){return delete scheduler._events[e]}),0<c.scheduledServices.length)scheduler.parse(c.scheduledServices,"json");else for(var u in c)if(Array.isArray(c[u])&&0<c[u].length){updateViewDebounced();break}return c}},L.changeStatus=function(a,l,e,c){var d=4<arguments.length&&void 0!==arguments[4]&&arguments[4],u=h.defer();return(c?g.changeStatusServicesByLocationsId:g.changeStatusServicesByServicesId)(a,l,e,c).then(function(e){var i,o={};e.nothingToDispatch?u.resolve(e):(i=h.defer(),e.fslOperation?b.getUpdates(e.fslOperation).then(function(t){console.log(t);var e=t.fslOperation.result.services;g.callRemoteAction(RemoteActions.getServicesById,e).then(function(e){i.resolve({services:e,failedResults:t.fslOperation.result.failedResults})})}).catch(function(e){i.reject("string"==typeof e?{eventType:"exception",message:e}:e)}):i.resolve(e),i.promise.then(function(t){o.services=w.updateTimePhaseData(t.services,"service",d).services,o.failedResults=t.failedResults;var i,n,e,s=void 0,r=void 0;1!==a.length||c?(i=[],n=[],c?t.services.forEach(function(e){(w.serviceAppointments()[e.Id].status!==l?i:n).push(e.Id)}):a.forEach(function(e){(w.serviceAppointments()[e].status===l?n:i).push(e)}),s=customLabels.x_services_were_changed.replaceAll(n.length,v.statusTranslations[l]||l),r=customLabels.x_services_were_changed_out_of_y.replaceAll(n.length,n.length,n.length+i.length,v.statusTranslations[l]||l),0<i.length&&(r+="<div title='"+i.map(function(e){return w.serviceAppointments()[e].name}).join(", ")+"' class='dashedBorder' style='display:inline-block;'> "+customLabels.failed_to_change_status.replaceAll(i.length)+". "+customLabels.View_services+"</div>"),v.addNotification(s,r,function(){var e={success:customLabels.SuccessfullyDispatched,fail:customLabels.FailToDispatch};S.open(t,e)})):(e=w.serviceAppointments()[a[0]].name,w.serviceAppointments()[a[0]].status!==l&&(s=customLabels.could_not_change_title.replaceAll(e),r=t.failedResults&&!v.isEmpty(t.failedResults)?customLabels.could_not_change_status.replaceAll(e,v.statusTranslations[l],t.failedResults[a[0]].errorMessage):customLabels.could_not_change_status.replaceAll(e,v.statusTranslations[l],""),v.addNotification(s,r,function(){f.open(a[0])})),L.recentlyUsed[a[0]]=!0),u.resolve(o)}))}).catch(function(e){u.reject(e),console.warn(e)}),u.promise},L.changePin=function(e,t){var i=h.defer();return g.callRemoteAction(RemoteActions.changePins,e,t).then(function(e){var t=fieldNames.Service_Appointment.pinned;e.forEach(function(e){return w.serviceAppointments()[e.Id].pinned=e[t]}),i.resolve()}).catch(function(e){i.reject(e),console.warn(e)}),i.promise},L.setInJeopardy=function(e){var t=h.defer();return g.callRemoteAction(RemoteActions.setServiceAppointmentsInJeopardy,e).then(function(e){e.forEach(function(e){return w.serviceAppointments()[e.Id].jeopardy=e[fieldNames.Service_Appointment.InJeopardy__c]}),v.addNotification(customLabels.Update_for_service,customLabels.Appointments_marked.replace("$0",customLabels.In_Jeopardy).replace("$1",e.length)),t.resolve()}).catch(function(e){t.reject(e),console.warn(e)}),t.promise},L.drawViolationsOnGantt=function(e){updateViewDebounced()},L.searchServiceByIdOrName=function(e){var i=h.defer();return g.callRemoteAction(RemoteActions.searchServiceByIdOrName,e).then(function(e){var t;null===e?i.resolve(null):((t=w.updateTimePhaseData(e,"service")).services&&0<t.services.length&&scheduler.parse(t.services.filter(function(e){return e.isScheduled()}),"json"),i.resolve(e[0].Id))}).catch(function(e){i.reject(e),console.warn(e)}),i.promise},L}]);var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_slicedToArray=(angular.module("serviceExpert").factory("userSettingsManager",["$q",function(s){function i(e){var t,i=s.defer();for(t in e){var n=e[t];e[t]=n+":"+(void 0===n?"undefined":_typeof(n))}return Visualforce.remoting.Manager.invokeAction(RemoteActions.SetUserSettingsProperties,e,function(e,t){t=JSON.parse(t.result);t.FailedLocations?(bootstrap.loadedUserSettings=t,i.reject(t)):(bootstrap.loadedUserSettings=t,i.resolve())},{buffer:!1,escape:!1,timeout:12e4}),i.promise}return{GetUserSettingsProperty:function(e){return bootstrap.loadedUserSettings[e]},SetUserSettingsProperty:function(e,t){var i=s.defer(),n=void 0===t?"undefined":_typeof(t);return Visualforce.remoting.Manager.invokeAction(RemoteActions.SetUserSettingsProperty,e,t,n,function(e,t){null!==t.result&&(bootstrap.loadedUserSettings=JSON.parse(t.result),i.resolve())},{buffer:!1,escape:!1,timeout:12e4}),i.promise},SetUserSettingProperties:i,SetUserSettingPropertiesPromise:function(e){var t=s.defer();return i(e),bootstrap.loadedUserSettings=JSON.parse(ev.result),t.promise}}}]),function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e)){var i=t,n=[],s=!0,t=!1,r=void 0;try{for(var o,a=e[Symbol.iterator]();!(s=(o=a.next()).done)&&(n.push(o.value),!i||n.length!==i);s=!0);}catch(e){t=!0,r=e}finally{try{!s&&a.return&&a.return()}finally{if(t)throw r}}return n}throw new TypeError("Invalid attempt to destructure non-iterable instance")});function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}!function(){function e(e,t,n,i,s,m,p,r,o,a,l){var c=void 0,d=[],u=[],h=[],g=[],v={},f={},S={},_={},y={DateTime:"DATETIME",Date:"DATE",String:"STRING",TextArea:"TEXTAREA",Picklist:"PICKLIST",Reference:"REFERENCE",Currency:"CURRENCY",Phone:"PHONE"},b={minutes:"Minutes",hours:"Hours",days:"Days"},w=[],T=e.defer(),L=new DOMParser;function A(e){var t;this.name=e[fieldNames.CustomGanttAction.Label],this.className=e[fieldNames.CustomGanttAction.Class],this.order=e[fieldNames.CustomGanttAction.Order],this.permission=e[fieldNames.CustomGanttAction.Permission],this.section=e[fieldNames.CustomGanttAction.Section],this.visualforce=e[fieldNames.CustomGanttAction.Visualforce],e[fieldNames.CustomGanttAction.Icon]&&(this.icon=(e=e[fieldNames.CustomGanttAction.Icon].split(","),t=(e=_slicedToArray(e,2))[0],e=e[1],window.lsdIcons.globalIcon+"/"+t+"-sprite/svg/symbols.svg#"+e))}function I(e,t){t*=864e5;return new Date(e.getTime()+t)}function C(e){k(null,e)||window.open("../"+e,"_blank")}function k(e,t){return!!p.isInConsole()&&(e&&e.preventDefault(),sforce.console.generateConsoleUrl(["/"+t],function(e){e.success?sforce.console.openConsoleUrl(null,e.consoleUrl,!0):D(t)}),!0)}function D(e){sforce.console.openPrimaryTab(null,"/"+e,!0)}function R(e,t){return moment.tz({year:e.getFullYear(),month:e.getMonth(),date:e.getDate(),hours:e.getHours(),minutes:e.getMinutes()},t)}function O(e){return new Date(e.year(),e.month(),e.date(),e.hours(),e.minutes())}function F(e){return customPermissions[e]}return String.prototype.decodeHTML=function(){var e=L.parseFromString(this,"text/html");return""!==e.documentElement.textContent?e.documentElement.textContent:this},String.prototype.encodeHTML=function(){return this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},n.callRemoteAction(RemoteActions.getCustomActions).then(function(e){e.forEach(function(e){var t=e[fieldNames.CustomGanttAction.Permission];window.customPermissions[t]&&w.push(new A(e))}),T.resolve(w)}),n.callRemoteAction(RemoteActions.getAllFormulaFields).then(function(e){c=e}),n.callRemoteAction(RemoteActions.getWorkOrderPriority).then(function(e){d.push.apply(d,_toConsumableArray(e))}),v.startHour=m.GetUserSettingsProperty("Gantt_View_Start_Hour__c"),null===v.startHour&&(v.startHour=0),v.finishHour=m.GetUserSettingsProperty("Gantt_View_Finish_Hour__c"),null===v.finishHour&&(v.finishHour=24),v.filterCandidates=m.GetUserSettingsProperty("Filter_Candidates__c"),null===v.filterCandidates&&(v.filterCandidates=!0),v.servicesPerPage=m.GetUserSettingsProperty("Services_Per_Page__c"),null===v.servicesPerPage&&(v.servicesPerPage="75"),v.resourceRowHeight=m.GetUserSettingsProperty("Resource_Row_Height__c"),null===v.resourceRowHeight&&(v.resourceRowHeight="medium"),v.capacityDuration=m.GetUserSettingsProperty("View_Capacity_Type__c"),null===v.capacityDuration&&(v.capacityDuration="Day"),v.backHorizon=m.GetUserSettingsProperty("Scheduling_horizon_limit__c"),null===v.backHorizon&&(v.backHorizon=14),v.loadOnToday=m.GetUserSettingsProperty("Load_On_Today__c"),null===v.loadOnToday&&(v.loadOnToday=!0),v.leftPanel=m.GetUserSettingsProperty("DefaultLeftPanel__c")||"salist",v.serviceColoring=m.GetUserSettingsProperty("ServiceListColoring__c")||"default",n.callRemoteAction(RemoteActions.getCustomizationFiles).then(function(e){var t;e&&e.CSS&&((t=jQuery("<link>")).attr({rel:"stylesheet",type:"text/css",href:e.CSS}),$("head").append(t)),e&&e.JS&&$.ajax({url:e.JS,dataType:"script"})}),window.openConsoleTabFromModal=function(t){p.isInConsole()&&sforce.console.generateConsoleUrl([t],function(e){e.success?sforce.console.openConsoleUrl(null,e.consoleUrl,!0):D(t)})},String.prototype.replaceAll=function(){for(var e=this,t=arguments.length,i=Array(t),n=0;n<t;n++)i[n]=arguments[n];for(var s=0;s<i.length;s++)e=e.replace("$"+s,i[s]);return e},n.callRemoteAction(RemoteActions.getStatusFlow).then(function(e){if(e)for(var t in angular.merge(f,e),f)f[t]=f[t].sort()}).catch(function(e){console.warn("could not get status flow :("),console.log(e)}),n.callRemoteAction(RemoteActions.getStatusTranslations).then(function(e){angular.merge(S,e),window.statusTranslations=S}).catch(function(e){console.warn("could not get status translations :("),console.log(e)}),n.callRemoteAction(RemoteActions.getStatuses).then(function(e){angular.merge(_,e)}).catch(function(e){console.warn("could not get status :("),console.log(e)}),{getFilteredLocations:function(){var e=m.GetUserSettingsProperty("locations");return e||[]},getSVGIconHTMLCustom:function(e){return'<svg aria-hidden="true" class="slds-icon contextMenuIcon"><use width="17px" height="17px" xlink:href="'+e+'"></use></svg>'},getSVGIconHTML:function(e){return'<svg aria-hidden="true" class="slds-icon contextMenuIcon"><use xlink:href="'+e+'"></use></svg>'},getRelatedServices:function(e,t){var i,n=Array.isArray(e)?e.concat():[e];for(i in t+=n.reduce(function(e,t){return scheduler._events[t]?e+","+scheduler._events[t].resource:e},""),scheduler._events){var s=scheduler._events[i];("service"===s.type&&-1!=t.indexOf(s.resource)||s.relatedService1&&-1!=e.indexOf(s.relatedService1)||s.relatedService2&&-1!=e.indexOf(s.relatedService2))&&(n.push(s.id),s.relatedTo&&n.push(s.relatedTo),s.relatedFather&&n.push(s.relatedFather),s.relatedService2&&n.push(s.relatedService2),s.relatedService1&&n.push(s.relatedService1))}return n},getServicesOfLocations:function(e,t,i){var n,s=[],r=(e=Array.isArray(e)?e:[e]).join(",");for(n in scheduler._events){var o=scheduler._events[n];"service"===o.type&&r.indexOf(o.serviceTerritory)&&isIntersect(o.start_date,o.end_date,t,i)&&(s.push(o.id),o.relatedTo&&s.push(o.relatedTo),o.relatedFather&&s.push(o.relatedFather),o.relatedService2&&s.push(o.relatedService2),o.relatedService1&&s.push(o.relatedService1))}return s},getServicesBetweenDates:function(e,t){var i,n=[];for(i in scheduler._events){var s=scheduler._events[i];"service"===s.type&&isIntersect(s.start_date,s.end_date,e,t)&&(n.push(s.id),s.relatedTo&&n.push(s.relatedTo),s.relatedFather&&n.push(s.relatedFather),s.relatedService2&&n.push(s.relatedService2),s.relatedService1&&n.push(s.relatedService1))}return n},getServiceDuration:function(e){var t=0;if(e.resourceBeforeDrag=e.resourceId,e.eventBeforeDrag=angular.copy(e),e.isScheduled())t=e.finish.getTime()-e.start.getTime();else switch(e.durationType){case b.minutes:t=60*e.estDuration*1e3;break;case b.hours:t=60*e.estDuration*60*1e3;break;case b.days:t=24*e.estDuration*60*60*1e3;break;default:t=6e4}return t},safeApply:function(e,t){var i=e.$root.$$phase;"$apply"===i||"$digest"===i?t&&"function"==typeof t&&t():e.$apply(t)},formatDayToString:function(e){return e.getDate()+"_"+e.getMonth()+"_"+e.getFullYear()},showOnGantt:function(e){if("MonthlyView"===scheduler._mode)alert(customLabels.serviceCantDisplayMonthlyMsg);else{var t=scheduler._events[e],i=getMinAndMaxHoursToDisplay(),n=t.start_date.getHours(),s=t.end_date.getHours();if((scheduler._min_date>t.start||t.start>scheduler._max_date)&&scheduler.setCurrentView(new Date(t.start)),0===t.end_date.getHours()&&t.end_date.getDate()>t.start_date.getDate()&&(s=24),"ZoomLevel2"!==scheduler._mode&&(i.min>s||i.max<=n))alert(customLabels.serviceCantDisplayMsg);else{for(var r=!0,o=scheduler.serverList("resources"),a=0;a<o.length;a++)for(var l=0;l<o[a].children.length;l++)if(-1<t.resourceId.indexOf(o[a].children[l].key)){r=!1;break}if(r)alert(customLabels.resource_filtered_out);else{if(p.areContractorsSupported()){var c=!0;if(t.resourceContractor){for(var d=scheduler.getEvents(t.start,t.finish),u=0;u<d.length;u++)if(d[u].resourceId===t.resourceId&&"contractorcapacity"===d[u].type&&d[u].timePeriod===m.GetUserSettingsProperty("View_Capacity_Type__c")){t=d[u],e=d[u].id,c=!1;break}if(c)return void alert(customLabels.is_assigned_to_contractor.replaceAll(t.name,t.resourceName)+".\n"+customLabels.This_capacity_duration_is_filtered_out+".\n"+customLabels.To_change_the_capacity_duration)}}try{scheduler._els.dhx_cal_data[0].scrollTop=0,t.showEventPopupEffect=!0,scheduler.showEvent(e)}catch(e){scheduler.callEvent("onAfterEventDisplay",[t,scheduler._mode])}}}}},openConsoleTab:k,trust:function(e){return"string"==typeof e?t.trustAsHtml(e):null},openLink:function(e,t){t.Type==y.Reference&&C(e[t.JsAPIName.replace("__r","__c")])},openSObjectLink:C,openLightningSubtab:function(t){sforce.console.getEnclosingPrimaryTabId(function(e){e=e.id;sforce.console.openSubtab(e,"/"+t,!0)})},openLightningPrimaryTab:D,getServiceInfoRowClass:function(e){var t;if(e)return t={},e.Type==y.Reference&&(t.resourceOnServiceTT=!0),t},isEmpty:function(e){return!Object.keys(e).length},generateResourceId:function(t,i){return Array.isArray(t)&&!Array.isArray(i)?t.map(function(e){return e+"_"+i}).join(","):Array.isArray(t)&&Array.isArray(i)?t.map(function(e,t){return e+"_"+i[t]}).join(","):Array.isArray(t)||Array.isArray(i)?!Array.isArray(t)&&Array.isArray(i)?i.map(function(e){return t+"_"+e}).join(","):void 0:t+"_"+i},addNotification:function(e,t,i,n){var s=4<arguments.length&&void 0!==arguments[4]&&arguments[4],r=(void 0===n&&(n=null),new Date);g.push({title:e,text:t,action:function(){i(n),this.show=!s},when:new Date(r.getTime().valueOf()+60*r.getTimezoneOffset()*1e3),unread:!0,param:n,show:!0})},addDaysToDate:I,setDatesByStartAndMode:function(e){var t=new Date(e);switch(scheduler._mode){case"ZoomLevel2":case"ZoomLevel3":t=I(t,1);break;case"ZoomLevel4":t=I(t,2);break;case"ZoomLevel5":t=I(t,3);break;case"ZoomLevel6":t=I(t,7);break;case"ZoomLevel7":t=I(t,14);break;case"MonthlyView":t=I(t,30);break;case"MTDView":t=I(t,35);break;case"LongView":t=I(t,scheduler.matrix.LongView.x_size)}return{start:new Date(e),end:t}},sortByTime:function(e,t){return e.start>t.start?1:e.start.getTime()==t.start.getTime()?0:-1},getReports:function(){var i=e.defer();return n.callRemoteAction(RemoteActions.getReportsWithGeolocationCols).then(function(e){if(e){for(var t=0;t<e.length;t++)u.push(e[t]);i.resolve(u)}else i.resolve(null)}).catch(function(e){return i.reject(e)}),i.promise},getPolygons:function(){var i=e.defer();if(F("Polygons_view"))return n.getPolygons().then(function(e){if(e){for(var t=0;t<e.length;t++)h.push(e[t]);i.resolve(h)}else i.resolve(null)}),i.promise;i.resolve(null)},intersectDates:function(e,t){for(var i={},n=[],s=(e.start>=t.start&&e.start<t.finish?(i.start=e.start,e.finish<t.finish?i.finish=e.finish:(i.finish=t.finish,n.push({start:t.finish,finish:e.finish,isStart:!1}))):e.finish>t.start&&e.finish<=t.finish?(e.start>t.start?i.start=e.start:(i.start=t.start,n.push({start:e.start,finish:t.start,isStart:!0})),i.finish=e.finish):e.start<t.start&&e.finish>t.finish?(i=angular.copy(t),n.push({start:e.start,finish:t.start,isStart:!0}),n.push({start:t.finish,finish:e.finish,isStart:!1})):i=null,[]),r=0;r<n.length;r++){var o=n[r];o.start.getTime()!=o.finish.getTime()&&s.push(o)}return{intersection:i,remainderFrom1:s}},getCSSClassForContext:function(e,t){switch(e){case t.NONE:return"serviceList_new";case t.SCHEDULED:return"serviceList_assigned";case t.DISPATCHED:return"serviceList_dispatched";case t.IN_PROGRESS:return"serviceList_travel";case t.COMPLETED:return"serviceList_completed";case t.COULD_NOT_COMPLETE:return"serviceList_couldnt_complete";case t.CANCELED:return"serviceList_cancelled";default:return"serviceList_other"}},fieldsTypes:y,ganttSettings:v,butlerNotifications:function(){return g},getIdsOfSObjectsAbsence:function(e){for(var t=[],i=0;i<e.length;i++)t.push(e[i]);return t},showServiceList:{show:!0},checkBoxFields:function(){return c},woPriorities:d,durationTypes:b,statusFlow:f,statusTranslations:S,statuses:_,convertDateBetweenTimeZones:function(e,t,i){return O(R(e,t).tz(i))},convertDtToMomentDt:R,convertMomentDtToDt:O,getUserOffset:function(e){return-moment.tz.zone(userTimeZone).utcOffset(R(e,userTimeZone).valueOf())},getLocationOffset:function(e,t){return t?(t=o.territories()[t],t=o.getOperatingHours()[t.operatingHours].timezone,-moment.tz.zone(t).utcOffset(R(e,t).valueOf())):null},setMapCloseButtonPosition:function(){s(function(){var e=$(".gm-style-iw");$($(".gm-ui-hover-effect")[0]).css({right:"0px",top:"0px",opacity:1}),e.next().css({right:"12px",left:"",opacity:1})},0)},getIdsOfSObjects:function(e){for(var t=[],i=0;i<e.length;i++)t.push(e[i].id);return t},hoursMinutes:function(e,t,i,n){return e<60?n.replaceAll([e]):(n=e%60,e=Math.round(e/60),0==n?i.replaceAll([e]):t.replace("$0",e).replace("$1",n))},hasCustomPermission:F,formatDateWithDayOfWeek:function(e){(e=new Date(e)).setHours(12);try{return e.toLocaleDateString(userLocale.replace("_","-"),{weekday:"short",month:"long",day:"numeric",year:"numeric"})}catch(e){return null}},isLightning:function(){return"undefined"!=typeof sforce&&sforce&&!!sforce.one},getCustomActions:function(t){return w.filter(function(e){return e.section===t})},customActionsPromise:T.promise,removeFSLNamespace:function(e){return 0===e.indexOf("FSL__")?e.substr(5,e.length):e},crewsFilter:!1,generateDateKey:function(e){return e.getDate()+"_"+e.getMonth()+"_"+e.getFullYear()},isUseEdge:function(e){return __gantt[e].useEdge},getColorHexByCategory:function(e){switch(e){case l.NONE:return"#a5e2d6";case l.SCHEDULED:return"#F9D058";case l.DISPATCHED:return"#8DD8FA";case l.IN_PROGRESS:return"#D68EF9";case l.COMPLETED:return"#95d155";case l.COULD_NOT_COMPLETE:return"#f58556";case l.CANCELED:return"#BEBCBA";default:return"#B7C9EA"}},getRelevantDataForDraggingService:function(e){var t={},i=(t.label=e.ganttLabel||e.name,t.estimatedDurationText=e.estDuration+" "+e.durationType,getMinAndMaxHoursToDisplay()),n=new Date(scheduler._min_date.getTime()+1e3*i.min*60*60),i=new Date(scheduler._min_date.getTime()+1e3*i.min*60*60),e=(e.durationType?e.durationType===b.minutes?i.setMinutes(i.getMinutes()+e.estDuration):e.durationType===b.hours?i.setMinutes(i.getMinutes()+Math.floor(60*e.estDuration)):e.durationType===b.days&&i.setMinutes(i.getMinutes()+Math.floor(60*e.estDuration*24)):i.setMinutes(i.getMinutes()+60),getXPositionOfEvent({start_date:n,end_date:i},!1,scheduler.matrix[scheduler._mode])),n=getXPositionOfEvent({start_date:n,end_date:i},!0,scheduler.matrix[scheduler._mode]);return t.meetingLengthInPx=n-e+4,t},getSchedulingPolicyObject:function(e){for(var t=0;t<p.policies.length;t++)if(p.policies[t].Id===e)return p.policies[t]},getServiceDurationInTheory:function(e){switch(e.durationType){case b.minutes:return 60*e.estDuration*1e3;case b.hours:return 60*e.estDuration*60*1e3;case b.days:return 24*e.estDuration*60*60*1e3;default:return 6e4}},isUrlImg:function(e){return t=e,!!new RegExp("^(https?:\\/\\/)?((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|((\\d{1,3}\\.){3}\\d{1,3}))(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*(\\?[;&a-z\\d%_.~+=-]*)?(\\#[-a-z\\d_]*)?$","i").test(t)&&null!==e.match(/\.(jpeg|jpg|gif|png|svg)$/);var t},isFormulaForImage:function(e){return e&&e.startsWith("<img")&&(e=e.split(" ")[1]).includes("src=")?e.substr(5,e.length-6):null},escapeResourceName:function(e){return e=(e=(e=e.encodeHTML()).split("'").join("&lsquo;")).split('"').join("&ldquo;")}}}e.$inject=["$q","$sce","sfdcService","$rootScope","$timeout","userSettingsManager","StateService","kpiCalculationsService","ResourcesAndTerritoriesService","$injector","SERVICE_CATEGORY"],angular.module("serviceExpert").factory("utils",e)}(),angular.module("serviceExpert").factory("sfdcService",["$q","$rootScope","userSettingsManager","$injector",function(f,u,s,S){var _={servicesArray:[],servicesObjs:{},activeRequests:{active:0},activeRuleCheckRequests:{active:0},serviceChangesQueue:[],resourceOperationsCounter:{}},l=(window.__isCheckingRules=function(){return!!_.activeRuleCheckRequests.active},{}),c={};function y(){return s.GetUserSettingsProperty("locations")||[]}function o(){return JSON.parse(s.GetUserSettingsProperty("Show_Orphan_Services__c"))}return c[RemoteActions.GetTimePhasedObjects]=!0,c[RemoteActions.GetResourcesAndTerritories]=!0,c[RemoteActions.getDelta]=!0,_.callRemoteAction=function(e){for(var t=arguments.length,i=Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];var s=e===RemoteActions.getDelta,r=e in l,o=!(e in c),a=f.defer(),e=[e].concat(i).concat(function(e,t){s||_.activeRequests.active--,t.status?a.resolve(e):a.reject(t)}).concat({buffer:o,escape:r,timeout:12e4}).map(function(e){return void 0===e?null:e});return s||_.activeRequests.active++,window.Visualforce.remoting.Manager.invokeAction.apply(window.Visualforce.remoting.Manager,e),a.promise},_.checkRules=function(e,t){var i=f.defer();return _.activeRuleCheckRequests.active++,u.policy||(u.policy=null),t=t||u.policy,window.Visualforce.remoting.Manager.invokeAction(RemoteActions.checkRules,e,t,function(e,t){_.activeRuleCheckRequests.active--,t.status?i.resolve(e):i.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),i.promise},_.getOptimiztionRequestsUpdate=function(e){return _.callRemoteAction(RemoteActions.getOptimiztionRequestsUpdate,e,y())},_.getGanttServiceOnAssignedResourceUpdate=function(e){return _.callRemoteAction(RemoteActions.getGanttServiceOnAssignedResourceUpdate,e,y())},_.getUpdatedAbsences=function(e){return _.callRemoteAction(RemoteActions.getUpdatedAbsences,e,y())},_.getDeletedAbsences=function(e){return _.callRemoteAction(RemoteActions.getDeletedAbsences,e,y())},_.getUpdatedServices=function(e,t){return _.callRemoteAction(RemoteActions.getUpdatedServices,e,t,y())},_.getUpdatedResourceCapacities=function(e){return _.callRemoteAction(RemoteActions.getUpdatedResourceCapacities,e,y())},_.getLivePositionsStreaming=function(e){return _.callRemoteAction(RemoteActions.getLivePositionsStreaming,e,y())},_.getLivePositions=function(){return _.callRemoteAction(RemoteActions.getLivePositions,y())},_.getDelta=function(e,t,i){var n;return u.isOptimizationViewer?((n=f.defer()).resolve({updateTime:(new Date).getTime()-15e3,oldTime:null,updatedAbsence:[],deletedAbsence:[],updatedCapacities:[],deletedCapacities:[],updatedGanttServices:[],deletedGanttServices:[],updatedLivePositions:[],optimizationRequests:[]}),n.promise):_.callRemoteAction(RemoteActions.getDelta,e,y(),t,i)},_.getSlots=function(e,t){var n=f.defer();return _.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getSlots,e,t,function(e,t){var i={};i.value=e,i.eventType=t.type,"exception"===t.type&&(i.event=t,n.resolve(i),--_.activeRequests.active),t.status?n.resolve(i):n.reject(t),--_.activeRequests.active},{buffer:!0,escape:!0,timeout:12e4}),n.promise},_.getPolygons=function(){return _.callRemoteAction(RemoteActions.getPolygons,y())},_.autoScheduleService=function(e,t){return _.callRemoteAction(RemoteActions.autoScheduleService,e,t,y())},_.unscheduleServicesByServicesId=function(e,t){return t=t||s.GetUserSettingsProperty("Gantt_Policy__c"),_.callRemoteAction(RemoteActions.unscheduleServicesByServicesId,e,t)},_.unscheduleServicesByLocationsId=function(e,t,i,n){return t=t||s.GetUserSettingsProperty("Gantt_Policy__c"),_.callRemoteAction(RemoteActions.unscheduleServicesByLocationsId,e,t,i,n)},_.GetResourcesAndTerritories=function(e){return _.callRemoteAction(RemoteActions.GetResourcesAndTerritories,e||y(),!0,!1)},_.GetTimePhasedObjects=function(e,t){var i,n=!(2<arguments.length&&void 0!==arguments[2])||arguments[2],s=3<arguments.length&&void 0!==arguments[3]&&arguments[3],r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:null,o=5<arguments.length&&void 0!==arguments[5]?arguments[5]:null,a=6<arguments.length&&void 0!==arguments[6]?arguments[6]:null,l=7<arguments.length&&void 0!==arguments[7]?arguments[7]:null,c=8<arguments.length&&void 0!==arguments[8]?arguments[8]:null,d=9<arguments.length&&void 0!==arguments[9]&&arguments[9];return u.isOptimizationViewer?((i=f.defer()).resolve({services:[],resourceAbsences:[],resourceCapacities:[],serviceCrewMembers:[],shifts:[],holidays:[],resourcesAndTerritories:[]}),i.promise):_.callRemoteAction(RemoteActions.GetTimePhasedObjects,e,t,y(),n,s,r,o,a,maxServicesToLoadEachBulkInGantt,maxAbsencesToLoadEachBulkInGantt,maxShiftsToLoadEachBulkInGantt,l,c,d)},_.loadServicesInBulk=function(e,t,i,n,s){var r;return u.isOptimizationViewer?((r=f.defer()).resolve({ganttServiceAppointments:[],stms:[],remainingCount:0}),r.promise):_.callRemoteAction(RemoteActions.loadServicesInBulk,e,y(),o(),t,i,n,s)},_.saveChangesToAbsence=function(e,t,i,n,s,r){return _.callRemoteAction(RemoteActions.saveChangesToAbsence,e,t,i,n,s,r,6<arguments.length&&void 0!==arguments[6]?arguments[6]:null,7<arguments.length&&void 0!==arguments[7]?arguments[7]:null,8<arguments.length&&void 0!==arguments[8]?arguments[8]:null,9<arguments.length&&void 0!==arguments[9]?arguments[9]:null,y())},_.saveChangesToServiceAppointment=function(e,i,n,t,s,r,o,a,l,c,d,u){var m=12<arguments.length&&void 0!==arguments[12]&&arguments[12],p=(_.resourceOperationsCounter[i]=_.resourceOperationsCounter[i]||0,n&&(_.resourceOperationsCounter[n]=_.resourceOperationsCounter[n]||0),f.defer()),h=f.defer();_.resourceOperationsCounter[i]?_.serviceChangesQueue.push({deferred:h,srcResource:n,destResource:i,valid:!0}):n&&!_.resourceOperationsCounter[n]?(_.resourceOperationsCounter[i]++,_.resourceOperationsCounter[n]++,h.resolve()):n||(_.resourceOperationsCounter[i]++,h.resolve());var g=S.get("TimePhasedDataService").serviceAppointments()[e],v=!1;return g&&(v=!!g.fromGetCandidateFlow),h.promise.then(function(){_.activeRequests.active++,Visualforce.remoting.Manager.invokeAction(RemoteActions.saveChangesToServiceAppointment,e,i,n,t,s,r,o,a,l,c,d,u,y(),m,v,function(e,t){_.activeRequests.active--,n&&_.resourceOperationsCounter[n]--,_.resourceOperationsCounter[i]--,_.serviceChangesQueue.forEach(function(e){!e.valid||_.resourceOperationsCounter[e.destResource]||(!e.srcResource||_.resourceOperationsCounter[e.srcResource])&&e.srcResource||(_.resourceOperationsCounter[e.srcResource]++,_.resourceOperationsCounter[e.destResource]++,e.valid=!1,e.deferred.resolve())}),t.status?p.resolve(e):p.reject(t)},{buffer:!0,escape:!1,timeout:12e4})}),p.promise},_.changeStatusServicesByServicesId=function(e,t){return _.callRemoteAction(RemoteActions.changeStatusServicesByServicesId,e,t)},_.changeStatusServicesByLocationsId=function(e,t,i,n){return _.callRemoteAction(RemoteActions.changeStatusServicesByLocationsId,e,t,i,n)},_.getOptimizationRequests=function(){return _.callRemoteAction(RemoteActions.getOptimizationRequests,y(),o())},_.runFillInSchedule=function(e,t,i){return _.callRemoteAction(RemoteActions.runFillInSchedule,e,t,i)},_.runFixOverlaps=function(e,t,i){return _.callRemoteAction(RemoteActions.runFixOverlaps,e,t,i)},_.getFslOperation=function(e){return _.callRemoteAction(RemoteActions.getFslOperation,e,resourceId,policyId)},_.isOptimizationViewer=function(){return u.isOptimizationViewer},_}]),!function(){function e(i,n,s,r,o,a){var l=null;function c(){a.setLightBoxStatus(!1),l.$destroy()}function d(e){e!==l.selectedTab&&(l.selectedTab=e)}return{open:function(e){(l=i.$new(!0)).lightboxAbsence=n.resourceAbsences()[e],l.selectedTab="details",l.urls={chatter:s.trustAsResourceUrl(customAbsenceChatterPage+"?id="+e).toString(),details:s.trustAsResourceUrl(customAbsencePage+"?id="+e).toString()},l.changeTab=d,l.closeLightbox=c,l.chatterAvailable=fieldTrackingEnabled.absence,l.openConsoleTab=o.openConsoleTab;var t=angular.element('<div class="LightboxBlackContainer">\n                    <div class="LightboxContainer" id="AbsenceLightbox">\n\n                        <div class="lightboxHeaderContainer" id="AbsenceLightboxHeader">\n\n                            <svg fsl-key-press tabindex="0" ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n\n                            <h1 class="lightboxHeader">\n                                <i ng-show="lightboxAbsence.type == \'na\'">'+customLabels.NA+":</i>\n                                <i ng-show=\"lightboxAbsence.type == 'break'\">"+customLabels.Break+':</i>\n                                {{ lightboxAbsence.name }}\n                            </h1>\n\n                            <button fsl-tab-switch role="tab" ng-click="changeTab(\'details\')" ng-class="{lightboxSelectedTab: selectedTab == \'details\'}">\n                                '+customLabels.Details+'\n                            </button>\n\n                            <button fsl-tab-switch role="tab" ng-show="chatterAvailable" ng-click="changeTab(\'chatter\')" ng-class="{lightboxSelectedTab: selectedTab == \'chatter\'}">\n                                '+customLabels.Chatter+'\n                            </button>\n\n                            <div class="ExtendedForm">\n                                <a ng-click="openConsoleTab($event,lightboxAbsence.id)" target="_blank" href="../{{ lightboxAbsence.id }}" title="'+customLabels.ExtandedForm+'">\n                                    <svg aria-hidden="true" class="slds-icon openExternalIcon">\n                                        \u2028<use xlink:href="'+lsdIcons.external+'"></use>\n                                    \u2028</svg>\n                                </a>\n                            </div>\n                        </div>\n\n                        <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'details\'" ng-src="{{ urls.details }}"></iframe>\n                        <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'chatter\'" ng-src="{{ urls.chatter }}" ng-if="chatterAvailable"></iframe>\n                        \n                        <div id="lightbox-loading-cover">\n                            <img src="'+lsdIcons.spinnerGif+'" />\n                            '+customLabels.loading+"\n                        </div>\n\n                    </div>\n                </div>");t.find("#AbsenceLightbox").draggable({containment:"document",handle:"#AbsenceLightboxHeader"}),a.setLightBoxStatus(),l.$on("$destroy",function(){return t.remove()}),l.$on("keypress",function(e,t){27==t.which&&l.$evalAsync(l.closeLightbox)}),r(t)(l),o.safeApply(l,function(){angular.element("body").append(t)})}}}e.$inject=["$rootScope","TimePhasedDataService","$sce","$compile","utils","StateService"],angular.module("serviceExpert").factory("AbsenceLightboxService",e)}(),!function(){function e(c,d,u,m,e,p){return{saveChangesToAbsence:function(i,e,t){var n,s,r,o=c.defer(),a=new Date(e.start_date.getTime()+1e3*e.travelTo),l=new Date(e.end_date.getTime()-1e3*e.travelFrom);return useLocationTimezone&&(n=d.getIntersectingSrstOffset(e,e.getGanttResource()),s=p.getUserOffset(a),r=p.getUserOffset(l),a.setMinutes(a.getMinutes()+s-n),l.setMinutes(l.getMinutes()+r-n)),u.saveChangesToAbsence(e.id,e.getGanttResource(),t,a,l,null,e.ganttLabel,e.snapToId||null,e.snapToType||null,e.snapDirection||null).then(function(e){var t="On Demand"!==window.__gantt.checkRulesMode;m.handleDeltaResponse(e,t),e.error?o.reject([e,i]):o.resolve()}).catch(function(e){o.reject([e,i])}),o.promise},saveNewAbsence:function(e,t){var i,n,s,r=c.defer();return useLocationTimezone&&(i=d.getIntersectingSrstOffset(e,e.resource),n=p.getUserOffset(e.start_date),s=p.getUserOffset(e.end_date),e.start_date.setMinutes(e.start_date.getMinutes()+n-i),e.end_date.setMinutes(e.end_date.getMinutes()+s-i)),u.saveChangesToAbsence(null,e.resource,t,e.start_date,e.end_date,e.absenceType,e.ganttLabel,e.snapToId||null,e.snapToType||null,e.snapDirection||null).then(function(e){var t="On Demand"!==window.__gantt.checkRulesMode;m.handleDeltaResponse(e,t),e.error?r.reject(e):r.resolve()}).catch(function(e){r.reject(e)}),r.promise},deleteAbsence:function(e){var t=c.defer();return u.callRemoteAction(RemoteActions.deleteResourceAbsence,e).then(function(e){e?(e="On Demand"!==window.__gantt.checkRulesMode,m.getDelta(e)):p.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.Failed_To_Delete_Break,null,null)}).catch(function(e){t.reject(e)}),t.promise},getEmployeeAbsenceTypes:function(){var t=c.defer();return u.callRemoteAction(RemoteActions.getEmployeeAbsenceTypes).then(function(e){e&&t.resolve(e)}).catch(function(e){t.reject(e)}),t.promise}}}e.$inject=["$q","TimePhasedDataService","sfdcService","DeltaService","servicesService","utils"],angular.module("serviceExpert").factory("AbsencesService",e)}(),!function(){function e(i,n,s,r,o,a,l,c,d){for(var u=null,m=[],e=0;e<60;e++)m.push(e);var p=a.isRtlDirection();function h(){"running"!==u.bulkState&&(a.setLightBoxStatus(!1),u.$destroy())}function g(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(u.actionFinish),navigation:!0,handler:function(e,t){e=new Date(e);e.setMinutes(parseInt(u.endMinutes)),e.setHours(parseInt(u.endHour)),e<u.actionStart?alert(customLabels.finishAfterStart):u.actionFinish=e,scheduler.destroyCalendar(),u.$apply()}})}function v(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(u.actionStart),navigation:!0,handler:function(e,t){e=new Date(e);e.setMinutes(parseInt(u.startMinutes)),e.setHours(parseInt(u.startHour)),e>u.actionFinish?alert(customLabels.startBeforeEnd):u.actionStart=e,scheduler.destroyCalendar(),u.$apply()}})}function f(){var e=new Date(u.actionStart);e.setMinutes(parseInt(u.startMinutes)),e.setHours(parseInt(u.startHour)),e>=u.actionFinish?(alert(customLabels.startBeforeEnd),u.startMinutes=u.actionStart.getMinutes(),u.startHour=u.actionStart.getHours().toString()):u.actionStart=e}function S(){var e=new Date(u.actionFinish);e.setMinutes(parseInt(u.endMinutes)),e.setHours(parseInt(u.endHour)),e<=u.actionStart?(alert(customLabels.finishAfterStart),u.endMinutes=u.actionFinish.getMinutes().toString(),u.endHour=u.actionFinish.getHours().toString()):u.actionFinish=e}function _(e){l.flagged[e]=!l.flagged[e]}function y(e){return l.flagged[e]}function b(e){return c.serviceAppointments()[e].name}function w(){var i=[],e=void 0,t=void 0;if("locations"===u.targetServices){for(var n in e=u.actionStart,t=u.actionFinish,e.setHours(u.startHour),e.setMinutes(u.startMinutes),t.setHours(u.endHour),t.setMinutes(u.endMinutes),u.selectedLocations)u.selectedLocations[n]&&i.push(n);if(0===i.length)return void alert(customLabels.noLocationWasSelected)}else i=r.getSelected();a.setBulkActionRunning(),u.bulkState="running",l.changeStatus(i,d.DISPATCHED,e,t,!0).then(function(e){if(e.nothingToDispatch)u.nothingToDispatch=!0;else{l.drawServicesAndAbsences(e.services),u.results.dispatched=[],i="locations"===u.targetServices?e.services.map(function(e){return e.id}):i;for(var t=0;t<i.length;t++)c.serviceAppointments()[i[t]].status===d.DISPATCHED&&u.results.dispatched.push(c.serviceAppointments()[i[t]]);u.results.failed=0<Object.keys(e.failedResults).length?e.failedResults:null}}).catch(function(e){console.warn("bulk dispatch failed :("),console.log(e)}).finally(function(){a.setBulkActionRunning(!1),u.bulkState="finished"})}return{open:function(){(u=n.$new(!0)).$on("keypress",function(e,t){27==t.which&&u.$evalAsync(u.closeLightbox)});var e=o.GetUserSettingsProperty("locations"),t=(u.filteredLocations=e.map(function(e){return s.territories()[e]}),u.selectedCount=r.countSelectedServices(),u.contractorSupport=a.areContractorsSupported(),u.minutes=m,u.hours24=[24,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],u.actionStart=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),u.actionFinish=new Date(scheduler.getState().max_date.getFullYear(),scheduler.getState().max_date.getMonth(),scheduler.getState().max_date.getDate(),0,0,0),u.startHour="0",u.endHour="0",u.startMinutes="0",u.endMinutes="0",u.dateSelectFinishWidget=g,u.dateSelectStartWidget=v,u.validateDatesStart=f,u.validateDatesEnd=S,u.targetServices=0==u.selectedCount?"locations":"selectedServices",u.bulkState="form",u.bulkDispatch=w,u.results={},u.toggleFlag=_,u.isFlagged=y,u.getServiceName=b,u.selectedLocations={},u.nothingToDispatch=!1,u.isAmpm=isAMPM?"ampm":"24",u.selectedMashu=customLabels.x_selected,e=customLabels.starting_from_x_until_y.replace("$0",'<u id="bulkStartUnschedule" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartUnschedule\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>\n\t\t\t\t\t\t\t<select class="selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesStart()" ng-model="startHour">\n\t\t\t\t\t\t\t    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n\t\t\t\t\t\t\t<select class="minutesSelect selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesStart()" ng-model="startMinutes">\n\t\t\t\t\t\t\t    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n\t\t\t\t\t\t\t</select>').replace("$1",'<u id="bulkFinishUnschedule" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishUnschedule\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>\n\t\t\t\t\t\t\t<select class="selectOnBulk RightArrowForSelect bulkActionSelectLb bulkActionSelectLb" ng-change="validateDatesEnd()" ng-model="endHour">\n\t\t\t\t\t\t\t    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t<select class="minutesSelect selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesEnd()" ng-model="endMinutes">\n\t\t\t\t\t\t\t    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n\t\t\t\t\t\t\t</select>'),angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer" id="BulkActionsLightbox" ng-class="{\'rtlDirection\': '+p+' }" >\n\n                    <div ng-show="bulkState != \'running\'" class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                        <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox" id="CloseDispatchLightbox" fsl-key-press tabindex="0">\n                            <use xlink:href="'+lsdIcons.close+'"></use>\n                        </svg>\n                        <h1 class="light-box-header">'+customLabels.BulkDispatch+'</h1>\n                    </div>\n\n                    \n                    <div id="bulkDispatchModalCont" ng-show="bulkState == \'finished\'">\n                        <div ng-show="bulkState == \'finished\'">\n    \n                            <div ng-show="nothingToDispatch" class="BulkLightNotFound">'+customLabels.NothingToUnschduleLightbox+'</div>\n    \n                            <div ng-show="results.dispatched.length" class="lightboxResultContainer dispatchResultsContainer1">\n    \n                                <div class="unscheduleTableTitle">'+customLabels.SuccessfullyDispatched+'</div>\n    \n                                <div ng-repeat="dispatced in results.dispatched" class="lightboxTableRow">\n                                    {{ dispatced.name }}\n                                    <div fsl-key-press tabindex="0" ng-click="toggleFlag(dispatced.id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(dispatced.id)" title="'+customLabels.Unflag+'">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(dispatced.id)" title="'+customLabels.Flag+'">'+customLabels.Flag+'</span>\n                                    </div>\n                                </div>\n                            </div>\n    \n                            <div ng-show="results.failed" class="lightboxResultContainer">\n                                <div class="unscheduleTableTitle">'+customLabels.FailToDispatch+'</div>\n                                <div ng-repeat="(id, failedReason) in results.failed" class="lightboxTableRow">\n                                    <span class="BulkLightboxServiceName">{{ getServiceName(id) }}</span>\n                                    <span class="BulkLightboxExplainCell">{{ failedReason.errorMessage }}</span>\n    \n                                    <div fsl-key-press tabindex="0" ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(id)" title="'+customLabels.Unflag+'">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(id)" title="'+customLabels.Flag+'">'+customLabels.Flag+'</span>\n                                    </div>\n    \n                                </div>\n                            </div>\n    \n                        </div>\n                    </div>\n\n                    <div ng-show="bulkState == \'running\'" class="bulkActionRunningContainer">\n                        <img src="'+lsdIcons.spinnerGif+'" />\n                        '+customLabels.DispatchingPleaseWait+'\n                    </div>\n\n\n                    <div ng-show="bulkState == \'form\'">\n\n                        <div class="lightboxContentContainer">\n\n                                <p>'+customLabels.DispatchLightboxText+'</p>\n\n                                <div class="selectedTargetServices" ng-class="{ disabledBulkSection: selectedCount == 0 }">\n                                    <input ng-model="targetServices" type="radio" ng-disabled="selectedCount == 0" name="bulkUnscheduleRadio" id="bulkUnschduleBySelectedRadio" value="selectedServices" />\n                                    <label for="bulkUnschduleBySelectedRadio">'+customLabels.Selected_services+' <span ng-show="selectedCount > 0">({{ selectedMashu | replaceLabels : selectedCount }})</span></label>\n                                </div>\n\n                                <div class="selectedTargetLocations">\n                                    <input ng-model="targetServices" type="radio" name="bulkUnscheduleRadio" id="bulkUnschduleByLocationRadio" value="locations" />\n                                    <label for="bulkUnschduleByLocationRadio">'+customLabels.ChooseLocationsLB+'</label>\n                                </div>\n\n                                <div id="bulkLocationNames" ng-class="{\'disabled-area\': targetServices != \'locations\'}">\n                                    <div ng-repeat="location in filteredLocations track by $index" class="BulkActionLocationName">\n                                        <input ng-model="selectedLocations[location.id]" type="checkbox" ng-disabled="targetServices != \'locations\'" id="bulkLocationUnschedule_{{ location.id }}"/>\n                                        <label title="{{ location.name }}" for="bulkLocationUnschedule_{{ location.id }}">{{location.name}}</label>\n                                    </div>\n                                </div>\n\n                                <div style="margin-top: 10px;" ng-show="!contractorSupport" ng-class="{\'disabled-area\': targetServices != \'locations\'}">\n                                    <input ng-model="includeContractorServices" ng-disabled="targetServices != \'locations\'" type="checkbox" id="BulkUnscheduleContractorServices" name="BulkUnscheduleContractorServices" />\n                                    <label for="BulkUnscheduleContractorServices">'+customLabels.Include_services_assigned_to_contractors+"</label>\n                                </div>\n\n                                <div class=\"bulkOptimizeOptions\" ng-class=\"{'disabled-area': targetServices != 'locations'}\">\n                                    "+e+'\n                                </div>\n                            </div>\n\n                            <div class="lightboxControllers">\n                                <button class="lightboxSaveButton" ng-click="bulkDispatch()">'+customLabels.Dispatch+"</button>\n                            </div>\n\n                        </div>\n                    </div>\n\n                </div>\n            "));t.find("#BulkActionsLightbox").draggable({containment:"document",handle:"#UnschduleLightboxHeader"}),angular.element("body").append(t),u.closeLightbox=h,u.$on("$destroy",function(){return t.remove()}),i(t)(u),t.show(),a.setLightBoxStatus(),t.children().find("input[type=checkbox]").focus()}}}e.$inject=["$compile","$rootScope","ResourcesAndTerritoriesService","ServiceSelectorService","userSettingsManager","StateService","servicesService","TimePhasedDataService","SERVICE_STATUS"],angular.module("serviceExpert").factory("bulkDispatchService",e)}(),!function(){function e(s,r,o,t,a){for(var l=null,c=null,e=[],i=0;i<60;i++)e.push(i);var d=o.isRtlDirection();function u(e){l.flagged[e]=!l.flagged[e]}function m(e){return l.flagged[e]}function p(e){return t.serviceAppointments()[e].name}function h(){o.setLightBoxStatus(!1),c.$destroy()}return{open:function(e,t){l=a.get("servicesService"),(c=r.$new(!0)).getServiceName=p,c.results={success:[],failed:0<Object.keys(e.failedResults).length?e.failedResults:null},c.labels=t,c.toggleFlag=u,c.isFlagged=m;for(var i=0;i<e.services.length;i++)e.failedResults[e.services[i].Id]||c.results.success.push(e.services[i].Id);c.$on("keypress",function(e,t){27==t.which&&c.$evalAsync(c.closeLightbox)});var n=angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer" id="BulkActionsLightbox" ng-class="{\'rtlDirection\': '+d+' }">\n\n                        <div class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                            <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                <use xlink:href="'+lsdIcons.close+'"></use>\n                            </svg>\n                            <h1 class="light-box-header">'+customLabels.BulkActionResults+'</h1>\n                        </div>\n\n                        <div class="resultsContainerOverflow">\n                            <div ng-show="results.success && results.success.length" class="lightboxResultContainer">\n    \n                                <div class="unscheduleTableTitle">{{labels.success}}</div>\n    \n                                <div ng-repeat="id in results.success" class="lightboxTableRow">\n                                    {{ getServiceName(id) }}\n                                    <div ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(id)" title="'+customLabels.Unflag+'">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(id)" title="'+customLabels.Flag+'">'+customLabels.Flag+'</span>\n                                    </div>\n                                </div>\n                            </div>\n    \n                            <div ng-show="results.failed && results.failed" class="lightboxResultContainer">\n                                <div class="unscheduleTableTitle">{{labels.fail}}</div>\n                                <div ng-repeat="(id, failedReason) in results.failed" class="lightboxTableRow">\n                                    <span class="BulkLightboxServiceName">{{ getServiceName(id) }}</span>\n                                    <span class="BulkResultLine">{{ failedReason.errorMessage }}</span>\n    \n                                    <div ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(id)" title="'+customLabels.Unflag+'">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(id)" title="'+customLabels.Flag+'">'+customLabels.Flag+"</span>\n                                    </div>\n    \n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                </div>\n            ");n.find("#BulkActionsLightbox").draggable({containment:"document",handle:"#UnschduleLightboxHeader"}),angular.element("body").append(n),c.closeLightbox=h,c.$on("$destroy",function(){return n.remove()}),s(n)(c),n.show(),o.setLightBoxStatus()}}}e.$inject=["$compile","$rootScope","StateService","TimePhasedDataService","$injector"],angular.module("serviceExpert").factory("bulkResultsService",e)}(),!function(){function e(s,r,o,t,a){var l=null,c=o.isRtlDirection();function d(e){return angular.isObject(e)}function u(e){return t.serviceAppointments()[e]}function m(e){l.flagged[e]=!l.flagged[e]}function p(e){return l.flagged[e]}function h(e){o.setLightBoxStatus(!1),e.$destroy()}return{open:function(e){var t,i=null;for(t in l=a.get("servicesService"),(i=r.$new(!0)).isAdmin=!1,null==window.userHasAdminPermissions?sfdcService.callRemoteAction(RemoteActions.userHasAdminPermissions).then(function(e){window.userHasAdminPermissions=!!e&&(i.isAdmin=!0)}):i.isAdmin=window.userHasAdminPermissions,i.toggleFlag=m,i.isFlagged=p,i.results=e,i.getService=u,i.isError=d,i.successfullyScheduled=0,i.globalSelectedCount=Object.keys(e).length,i.generatePartialResult=function(e){return customLabels.partialResults[e.Operation].replaceAll(e.Processed,e.Total)},i.replaceLabelsForSebas=function(){return customLabels.x_services_scheduled_of_y_here_are_results.replaceAll(i.successfullyScheduled,i.globalSelectedCount)},e)"scheduled"===e[t].textResult&&i.successfullyScheduled++;i.$on("keypress",function(e,t){27==t.which&&i.$evalAsync(i.closeLightbox)}),i.closeLightbox=h,i.$on("$destroy",function(){return n.remove()});var n=angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer" id="BulkActionsLightbox" ng-class="{\'rtlDirection\': '+c+' }">\n\n                        <div class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                            <svg ng-click="closeLightbox(this)" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            <h1 class="light-box-header">'+customLabels.BulkScheduleResults+'</h1>\n                        </div>\n\n                        <div style="padding:0 15px">\n                        \n                            <p>{{ replaceLabelsForSebas() }}</p>\n            \n                            <div id="ResultTableHeader">\n                                <span>'+customLabels.ID+'</span>\n                                <span id="ResultHeaderStart">'+customLabels.Start+"</span>\n                                <span>"+customLabels.Finish+'</span>\n                                <span id="ResultResourceHeader">'+customLabels.Resource+'</span>\n                            </div>\n            \n                            <div id="ScheduledResultsTable">\n                                <div ng-repeat="(id,res) in results" class="ScheduleResultRow">\n                                \n                                    <span class="scheduledResultColName">{{ getService(id).name }}</span>\n                                    <span class="scheduledResultDate" ng-if="res.textResult == \'scheduled\'">{{getService(id).start | amDateFormat:\'lll\'}}</span>\n                                    <span class="scheduledResultDate" ng-if="res.textResult == \'scheduled\'">{{getService(id).finish | amDateFormat:\'lll\'}}</span>\n                                    <span class="scheduledResultDate" ng-if="res.textResult == \'scheduled\'">{{getService(id).resourceName}}</span>\n                                    <span class="ScheduleResultUnscheduled" ng-if="isError(res)">{{ res.msg }}</span>\n                                    \x3c!--<span class="ScheduleResultUnscheduled" ng-if="isError(res)">'+customLabels.NoCandidates+'</span>--\x3e\n                                    <span class="ScheduleResultUnscheduled" ng-if="res.textResult == \'no candidates\'">'+customLabels.NoCandidates+'</span>\n                                    \n                                    <div ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(id)" title="'+customLabels.Unflag+'">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(id)" title="'+customLabels.Flag+'">'+customLabels.Flag+'</span>\n                                    </div>\n                                    \n                                    <div class="PartialResultsBulk" ng-show="res.partialResults.length > 0" ng-init="res.showDetails = false;">\n                                        <div>'+customLabels.particalCouldntProcessAll+' <u ng-show="isAdmin" ng-click="res.showDetails = !res.showDetails">'+customLabels.ShowDetails+'</u></div>\n            \n                                        <div ng-show="res.showDetails">\n                                            <ul>\n                                                <li ng-repeat="partial in res.partialResults">\n                                                    {{ generatePartialResult(partial) }}\n                                                </li>\n                                            </ul>\n                                        </div>\n                                    </div>\n                                    \n                                </div>\n                            </div>\n                            \n                        </div>\n                    </div>\n\n                </div>\n            ');n.find("#BulkActionsLightbox").draggable({containment:"document",handle:"#UnschduleLightboxHeader"}),s(n)(i),angular.element("body").append(n),n.show(),o.setLightBoxStatus()}}}e.$inject=["$compile","$rootScope","StateService","TimePhasedDataService","$injector"],angular.module("serviceExpert").factory("bulkScheduleResultsService",e)}(),!function(){function e(o,t,i,a,l,c,e,n){var d=null;function s(){(d=i.$new(!0)).isInConsole=c.isInConsole(),d.actionName="Schedule",d.currentSchedulingIndex=0,d.successfullyScheduled=0,d.afterSchedulingServiceObjects={},d.close=r,d.showResults=u,d.progressBarStyle=m,d.getLabel=function(e){return customLabels[e]};var e=angular.element('\n            <div id="SchedulingInProgress" class="slideInProgressBox" ng-class="{SchedulingInProgressConsole: isInConsole}">\n\n\t\t\t\t<div ng-show="currentSchedulingIndex != globalSelectedCount">\n\t\t\t\t\t<i class="fa fa-spinner fa-spin"></i> '+customLabels.Scheduling_Services+'\n\t\t\t\t\t<div class="ProgressBar">\n\t\t\t\t\t\t<div ng-style="progressBarStyle()"></div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div ng-cloak class="ProgressBarLabel">{{ getLabel(\'Scheduling_service\') | replaceLabels : (currentSchedulingIndex+1) : globalSelectedCount }}</div>\n\t\t\t\t</div>\n\n\t\t\t\t<div ng-show="currentSchedulingIndex == globalSelectedCount">\n\t\t\t\t\t<i class="fa fa-check"></i> '+customLabels.Scheduling_Complete+'\n\t\t\t\t\t<div ng-cloak class="HowManyWereScheduled">{{  getLabel(\'Scheduled_x_out_of_y\') | replaceLabels : successfullyScheduled : globalSelectedCount }}</div>\n\t\t\t\t\t<span ng-cloak class="InProgressAction" ng-click="close()">'+customLabels.Close+'</span>\n\t\t\t\t\t<span ng-cloak class="InProgressAction" ng-click="showResults()">'+customLabels.View_services+"</span>\n\t\t\t\t</div>\n\n\t\t\t</div>");angular.element("body").append(e),d.$on("$destroy",function(){return e.remove()}),t(e)(d),e.show()}function r(){d.$destroy()}function u(){e.open(d.afterSchedulingServiceObjects),d.$destroy()}function m(){return{width:(d.currentSchedulingIndex+1)/d.globalSelectedCount*100+"%"}}return{schedule:function(e){0===e.length||c.isScheduleRunning||(0===(e=e.filter(function(e){e=l.serviceAppointments()[e];return!(e.relatedService1&&e.isImmidietlyFollow)})).length?alert(window.customLabels.AllServicesAreFollowing):(d&&d.$destroy(),s(),c.isScheduleRunning=!0,d.globalSelectedCount=e.length,a.sortServicesByPriority(e).then(function(e){var n=[],s=[];e.forEach(function(e){s.push(l.serviceAppointments()[e.ServiceId])}),d.globalSelectedServiceObjects=s;for(var t=0;t<d.globalSelectedCount;t++){var i=o.defer();i.promise.then(r),n.push(i)}function r(i){c.schedulingRunningFor[s[i].id]=!0,a.autoScheduleService(s[i].id,!0).then(function(e){a.drawServicesAndAbsences(e.services,e.absences),d.afterSchedulingServiceObjects[s[i].id]={},d.afterSchedulingServiceObjects[s[i].id].partialResults=e.partialResults,d.afterSchedulingServiceObjects[s[i].id].textResult="no candidates",e.services.forEach(function(e){e.id===s[i].id&&(d.afterSchedulingServiceObjects[s[i].id].textResult="scheduled",d.successfullyScheduled++)})}).catch(function(e){var t={};t.msg=e.message,d.afterSchedulingServiceObjects[s[i].id]=t}).finally(function(){if(d.currentSchedulingIndex++,c.schedulingRunningFor[s[i].id]=!1,i+1<d.globalSelectedCount&&n[i+1].resolve(i+1),i+1===d.globalSelectedCount){var e,t=[];for(e in scheduler._events)"service"===scheduler._events[e].type&&t.push(e);0<t.length&&"On Demand"!==window.__gantt.checkRulesMode&&a.checkRules(t).then(a.drawViolationsOnGantt),c.isScheduleRunning=!1}})}n[0].resolve(0)})))}}}e.$inject=["$q","$compile","$rootScope","servicesService","TimePhasedDataService","StateService","bulkScheduleResultsService","utils"],angular.module("serviceExpert").factory("bulkScheduleService",e)}(),!function(){function e(i,n,s,r,o,a,l,c,d){for(var u=null,m=[],e=0;e<60;e++)m.push(e);var p=a.isRtlDirection();function h(){"running"!==u.bulkState&&(a.setLightBoxStatus(!1),u.$destroy())}function g(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(u.actionFinish),navigation:!0,handler:function(e,t){e=new Date(e);e.setMinutes(parseInt(u.endMinutes)),e.setHours(parseInt(u.endHour)),e<u.actionStart?alert(customLabels.finishAfterStart):u.actionFinish=e,scheduler.destroyCalendar(),u.$apply()}})}function v(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(u.actionStart),navigation:!0,handler:function(e,t){e=new Date(e);e.setMinutes(parseInt(u.startMinutes)),e.setHours(parseInt(u.startHour)),e>u.actionFinish?alert(customLabels.startBeforeEnd):u.actionStart=e,scheduler.destroyCalendar(),u.$apply()}})}function f(){var e=new Date(u.actionStart);e.setMinutes(parseInt(u.startMinutes)),e.setHours(parseInt(u.startHour)),e>=u.actionFinish?(alert(customLabels.startBeforeEnd),u.startMinutes=u.actionStart.getMinutes(),u.startHour=u.actionStart.getHours().toString()):u.actionStart=e}function S(){var e=new Date(u.actionFinish);e.setMinutes(parseInt(u.endMinutes)),e.setHours(parseInt(u.endHour)),e<=u.actionStart?(alert(customLabels.finishAfterStart),u.endMinutes=u.actionFinish.getMinutes().toString(),u.endHour=u.actionFinish.getHours().toString()):u.actionFinish=e}function _(e){l.flagged[e]=!l.flagged[e]}function y(e){return l.flagged[e]}function b(e){return c.serviceAppointments()[e].name}function w(){var i=[],e=void 0,t=void 0;if("locations"===u.targetServices){for(var n in e=u.actionStart,t=u.actionFinish,e.setHours(u.startHour),e.setMinutes(u.startMinutes),t.setHours(u.endHour),t.setMinutes(u.endMinutes),u.selectedLocations)u.selectedLocations[n]&&i.push(n);if(0===i.length)return void alert(customLabels.noLocationWasSelected)}else i=r.getSelected();a.setBulkActionRunning(),u.bulkState="running",l.unscheduleServices(i,a.selectedPolicyId,e,t).then(function(e){if(e.nothingToUnschedule)u.nothingToUnschedule=!0;else{l.drawServicesAndAbsences(e.services,e.absences,[],e.capacities),u.results.unscheduled=[],i="locations"===u.targetServices?e.services.map(function(e){return e.id}):i;for(var t=0;t<i.length;t++)c.serviceAppointments()[i[t]].isScheduled()||u.results.unscheduled.push(c.serviceAppointments()[i[t]]);u.results.failed=0<Object.keys(e.failedResults).length?e.failedResults:null}}).catch(function(e){console.warn("bulk unschedule failed :("),console.log(e),u.exception=e}).finally(function(){a.setBulkActionRunning(!1),u.bulkState="finished",d.calculateKpis()})}return{open:function(){(u=n.$new(!0)).$on("keypress",function(e,t){27==t.which&&u.$evalAsync(u.closeLightbox)});var e=o.GetUserSettingsProperty("locations"),t=(u.filteredLocations=e.map(function(e){return s.territories()[e]}),u.selectedCount=r.countSelectedServices(),u.contractorSupport=a.areContractorsSupported(),u.minutes=m,u.hours24=[24,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],u.actionStart=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),u.actionFinish=new Date(scheduler.getState().max_date.getFullYear(),scheduler.getState().max_date.getMonth(),scheduler.getState().max_date.getDate(),0,0,0),u.startHour="0",u.endHour="0",u.startMinutes="0",u.endMinutes="0",u.dateSelectFinishWidget=g,u.dateSelectStartWidget=v,u.validateDatesStart=f,u.validateDatesEnd=S,u.targetServices=0==u.selectedCount?"locations":"selectedServices",u.bulkState="form",u.bulkUnschedule=w,u.results={},u.toggleFlag=_,u.isFlagged=y,u.getServiceName=b,u.selectedLocations={},u.nothingToUnschedule=!1,u.isAmpm=isAMPM?"ampm":"24",u.exception=null,e=customLabels.starting_from_x_until_y.replace("$0",'<u id="bulkStartUnschedule" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartUnschedule\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>\n\t\t\t\t\t\t\t<select class="selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesStart()" ng-model="startHour">\n\t\t\t\t\t\t\t    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n\t\t\t\t\t\t\t<select class="minutesSelect selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesStart()" ng-model="startMinutes">\n\t\t\t\t\t\t\t    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n\t\t\t\t\t\t\t</select>').replace("$1",'<u id="bulkFinishUnschedule" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishUnschedule\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>\n\t\t\t\t\t\t\t<select class="selectOnBulk RightArrowForSelect bulkActionSelectLb bulkActionSelectLb" ng-change="validateDatesEnd()" ng-model="endHour">\n\t\t\t\t\t\t\t    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t<select class="minutesSelect selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesEnd()" ng-model="endMinutes">\n\t\t\t\t\t\t\t    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n\t\t\t\t\t\t\t</select>'),angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer" id="UnschduleLightbox" ng-class="{\'rtlDirection\': '+p+' }">\n\n                    <div ng-show="bulkState != \'running\'" class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                        <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox" fsl-key-press tabindex="0">\n                            <use xlink:href="'+lsdIcons.close+'"></use>\n                        </svg>\n                        <h1 class="light-box-header">'+customLabels.BulkUnschedule+'</h1>\n                    </div>\n\n                    <div ng-show="bulkState == \'finished\'">\n\n\n                        <div ng-show="nothingToUnschedule" class="BulkLightNotFound">'+customLabels.NothingToUnschduleLightbox+'</div>\n\n                        <div class="resultsContainerOverflow class="unschedule_res_thingy_qa_halash">\n                        \n                            <div class="bulk-exception" ng-show="exception">\n                                <svg aria-hidden="true" class="slds-icon kpiIcon">\n                                    <use xlink:href="'+lsdIcons.violation+'"></use>\n                                </svg>\n                                {{ exception.message }} \n                            </div>\n                        \n                            <div ng-show="results.unscheduled.length" class="lightboxResultContainer">\n    \n                                <div class="unscheduleTableTitle">'+customLabels.SuccessfullyUnscheduled+'</div>\n    \n                                <div ng-repeat="unscheduled in results.unscheduled track by $index" class="lightboxTableRow">\n                                    {{ unscheduled.name }}\n                                    <div fsl-key-press tabindex="0" ng-click="toggleFlag(unscheduled.id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(unscheduled.id)" title="'+customLabels.Unflag+'">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(unscheduled.id)" title="'+customLabels.Flag+'">'+customLabels.Flag+'</span>\n                                    </div>\n                                </div>\n                            </div>\n    \n                            <div ng-show="results.failed" class="lightboxResultContainer">\n                                <div class="unscheduleTableTitle">'+customLabels.FailToUnschedule+'</div>\n                                <div ng-repeat="(id, failedReason) in results.failed track by $index" class="lightboxTableRow">\n                                    <span class="BulkLightboxServiceName">{{ getServiceName(id) }}</span>\n                                    <span class="BulkLightboxExplainCell">{{ failedReason.errorMessage }}</span>\n    \n                                    <div fsl-key-press tabindex="0" ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(id)" title="'+customLabels.Unflag+'">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(id)" title="'+customLabels.Flag+'">'+customLabels.Flag+'</span>\n                                    </div>\n    \n                                </div>\n                            </div>\n                        </div>\n\n                    </div>\n\n                    <div ng-show="bulkState == \'running\'" class="bulkActionRunningContainer">\n                        <img src="'+lsdIcons.spinnerGif+'" />\n                        '+customLabels.UnschedulingPleaseWait+'\n                    </div>\n\n                    <div ng-show="bulkState == \'form\'">\n\n                        <div class="lightboxContentContainer">\n\n                                <p>'+customLabels.UnscheduleLightboxText+'</p>\n\n                                <div class="selectedTargetServices" ng-class="{ disabledBulkSection: selectedCount == 0 }">\n                                    <input ng-model="targetServices" type="radio" ng-disabled="selectedCount == 0" name="bulkUnscheduleRadio" id="bulkUnschduleBySelectedRadio" value="selectedServices" />\n                                    <label for="bulkUnschduleBySelectedRadio">'+customLabels.Selected_services+' <span ng-show="selectedCount > 0">({{ getCustomLabel(\'x_selected\') | replaceLabels : selectedCount }})</span></label>\n                                </div>\n\n                                <div class="selectedTargetLocations">\n                                    <input ng-model="targetServices" type="radio" name="bulkUnscheduleRadio" id="bulkUnschduleByLocationRadio" value="locations" />\n                                    <label for="bulkUnschduleByLocationRadio">'+customLabels.ChooseLocationsLB+'</label>\n                                </div>\n\n                                <div id="bulkLocationNames">\n                                    <div ng-repeat="location in filteredLocations track by $index" class="BulkActionLocationName">\n                                        <input ng-model="selectedLocations[location.id]" type="checkbox" ng-disabled="targetServices != \'locations\'" id="bulkLocationUnschedule_{{ location.id }}"/>\n                                        <label title="{{ location.name }}" for="bulkLocationUnschedule_{{ location.id }}">{{location.name}}</label>\n                                    </div>\n                                </div>\n\n                                <div style="margin-top: 10px;" ng-show="!contractorSupport">\n                                    <input ng-model="includeContractorServices" ng-disabled="targetServices != \'locations\'" type="checkbox" id="BulkUnscheduleContractorServices" name="BulkUnscheduleContractorServices" />\n                                    <label for="BulkUnscheduleContractorServices">'+customLabels.Include_services_assigned_to_contractors+'</label>\n                                </div>\n\n                                <div class="bulkOptimizeOptions">\n                                    '+e+'\n                                </div>\n                            </div>\n\n                            <div class="lightboxControllers">\n                                <button class="lightboxSaveButton" ng-click="bulkUnschedule()">'+customLabels.Unschedule+"</button>\n                            </div>\n\n                        </div>\n                    </div>\n\n                </div>\n            "));t.find("#UnschduleLightbox").draggable({containment:"document",handle:"#UnschduleLightboxHeader"}),angular.element("body").append(t),u.closeLightbox=h,u.getCustomLabel=function(e){return customLabels[e]},u.$on("$destroy",function(){return t.remove()}),i(t)(u),t.show(),a.setLightBoxStatus(),t.children().find("input[type=checkbox]").focus()}}}e.$inject=["$compile","$rootScope","ResourcesAndTerritoriesService","ServiceSelectorService","userSettingsManager","StateService","servicesService","TimePhasedDataService","kpiCalculationsService"],angular.module("serviceExpert").factory("bulkUnscheduleService",e)}(),!function(){function e(s,n,r,o){return{Bundle:{label:customLabels.Bundle,icon:lsdIcons.bundleIcons+"#ad_set",canInvoke:function(e){if(!s.isActive()||!e||0===e.length)return!1;if(1<e.length)return!0;for(var t=!0,i=0;i<e.length;i++){if(e[i]&&-1<e[i].id.indexOf("_dummy")){t=!1;break}var n=e[i];if(!n||n.pinned||n.isBundle||n.isBundleMember){t=!1;break}}return t},invoke:function(e,t){var i=r.defer();if(0!==e.length)return n.open(e,t);e={message:customLabels.BundleNotSelected,status:"ERROR"};return o.$broadcast("showServiceExpertToast",e),utils.addNotification(customLabels.BundleCreatedFailedNTitle,customLabels.BundleNotSelected,function(){}),i.reject(),i.promise}},Unbundle:{label:customLabels.UnBundle,icon:lsdIcons.bundleIcons+"#archive",canInvoke:function(e){if(!s.isActive()||!e||0===e.length)return!1;if(1<e.length)return!0;for(var t=!0,i=0;i<e.length;i++){if(e[i]&&-1<e[i].id.indexOf("_dummy")){t=!1;break}var n=e[i];if(!n||n.pinned||!n.isBundle){t=!1;break}}return t},invoke:function(e,t){var i=1<e.length?customLabels.VerifyUnBundleActionMulti:customLabels.VerifyUnBundleAction;if(window.confirm(i))return i=e.map(function(e){return e.id}),s.UndbundleServiceAppointment(i,e,t);i=r.defer();return i.reject(null),i.promise}},UpdateBundle:{label:customLabels.Bundle,icon:lsdIcons.bundleIcons+"#ad_set",canInvoke:function(e){return!0},invoke:function(e,t,i){e=e.map(function(e){return e.id});return s.updateBundleServiceAppointments(e,t,i)}}}}e.$inject=["BundleService","BundlerAddCreateLightboxService","$q","$rootScope","utils"],angular.module("serviceExpert").factory("BundleActions",e)}(),!function(){function e(s,r,d,u,e,t,m,p){function i(){return"0"!==isSchedulingBundlingEnabled&&!!isSchedulingBundlingEnabled}function n(e){return e.isBundleMember}return{isBundleMember:n,isBundle:function(e){return e.isBundle},isActive:i,bundleServiceAppointments:function(e,t,i){var l=s.defer(),c=!1;if(0===(e=Array.isArray(e)?e:[e]).length)return n={message:customLabels.BundleNotSelected,status:"ERROR"},m.$broadcast("showServiceExpertToast",n),l.reject(),l.promise;1===i.length&&(c=i[0].name);var n=window.location.search,i=new URLSearchParams(n).get("token");return r.callRemoteAction(RemoteActions.createBundleManually,e,t,i).then(function(e){var t="",i=e.bundleStatus,n=void 0,s=void 0;if(e&&e.error_msg&&-1<e.error_msg.indexOf("Setup->Security->Remote site settings")){try{var r=e.error_msg.split("/bundleflow"),n=r[0]+" or ask your Salesforce admin for help.",s=r[0].split("endpoint =")[1]}catch(e){n="Ask your Salesforce admin to update the URL in Setup > Security > Remote Site Settings",s="the URL"}alert(n),u.addNotification(customLabels.BundleCreatedFailedNTitle,"Ask your Salesforce admin to update the URL in Setup > Security > Remote Site Settings to "+s,function(){});r={message:customLabels.BundleCreationFailedM,status:"ERROR"};return m.$broadcast("showServiceExpertToast",r),void l.resolve(a)}if(e&&e.debugMode)for(var o in console.log("--createBundleManually--"),console.log(e),e)console.log(o+": "+e[o]);t=e.bundle||(n=e.bundleId,{AppointmentNumber:e.AppointmentNumber,Id:n});var a=e.bundledMembers;if("COMPLETE_BUNDLE"==i)return s=String.format(customLabels.BundleSuccessfullyCreated,t.AppointmentNumber),u.addNotification(customLabels.BundleCreatedNTitle,String.format(customLabels.BundleSuccessfullyCreated,t.AppointmentNumber),function(){p.open(t.Id)}),r={message:s,status:"SUCCESS",f:function(e){p.open(e)},p:t.Id},m.$broadcast("showServiceExpertToast",r),void l.resolve(a);n="",i=n=c?String.format(customLabels.BundleCreationFailedSingle,c):customLabels.BundleCreationFailedM,s={message:i=e.shortMsg&&""!=e.shortMsg?e.shortMsg:i,status:"ERROR"},m.$broadcast("showServiceExpertToast",s),r=n;e.longMsg&&""!=e.longMsg&&(r=e.longMsg),u.addNotification(customLabels.BundleCreatedFailedNTitle,r,function(){}),l.reject(e.bundleStatus)}).catch(function(e){var t="",i=t=c?String.format(customLabels.BundleCreationFailedSingle,c):customLabels.BundleCreationFailedM;m.$broadcast("showServiceExpertToast",{message:i,status:"ERROR"}),u.addNotification(customLabels.BundleCreatedFailedNTitle,t,function(){}),console.warn(e),l.reject(e)}),l.promise},updateBundleServiceAppointments:function(e,t,o,a){var e=Array.isArray(e)?e:[e],l=s.defer();return r.callRemoteAction(RemoteActions.updateBundleManually,e,t,o).then(function(e){var t=void 0,i=void 0;if(e&&e.error_msg&&-1<e.error_msg.indexOf("Setup->Security->Remote site settings")){try{var n=e.error_msg.split("/bundleflow"),t=n[0]+" or ask your Salesforce admin for help.",i=n[0].split("endpoint =")[1]}catch(e){t="Ask your Salesforce admin to update the URL in Setup > Security > Remote Site Settings",i="the URL"}alert(t),u.addNotification(customLabels.BundleUpdateFailedNT,"Ask your Salesforce admin to update the URL in Setup > Security > Remote Site Settings to "+i,function(){});n={message:customLabels.BundleUpdateFailedNT,status:"ERROR"};return m.$broadcast("showServiceExpertToast",n),void l.resolve(r)}if(e&&e.debugMode)for(var s in console.log("+++"),console.log(e),e)console.log(s+": "+e[s]);var t=e.bundleStatus,i=void 0,r=(i=e.bundle||(n=e.bundleId,{AppointmentNumber:e.AppointmentNumber,Id:n}),e.bundledMembers);if("COMPLETE_BUNDLE"==t)return n=String.format(customLabels.BundleUpdateSuccessfully,a),t=customLabels.BundleUpdateSuccessfullyNT,u.addNotification(t,n,function(){p.open(o)}),t={message:n,status:"SUCCESS",f:function(e){p.open(e)},p:i.Id},m.$broadcast("showServiceExpertToast",t),void l.resolve(r);n=String.format(customLabels.BundleUpdateFailed,a),i={message:n=e.shortMsg&&""!=e.shortMsg?e.shortMsg:n,status:"ERROR"},m.$broadcast("showServiceExpertToast",i),t=String.format(customLabels.BundleUpdateFailed,a);e.longMsg&&""!=e.longMsg&&(t=e.longMsg),u.addNotification(customLabels.BundleUpdateFailedNT,t,function(){}),l.reject(e.bundleStatus)}).catch(function(e){var t={message:String.format(customLabels.BundleUpdateFailed,a),status:"ERROR"};m.$broadcast("showServiceExpertToast",t),u.addNotification(customLabels.BundleUpdateFailedNT,String.format(customLabels.BundleUpdateFailed,a),function(){}),l.reject(e)}),l.promise},UndbundleServiceAppointment:function(e,i,t){var n,o=s.defer();if(0===(e=Array.isArray(e)?e:[e]).length)return n={message:customLabels.UnbundledNotSelected,status:"ERROR"},m.$broadcast("showServiceExpertToast",n),u.addNotification(customLabels.FailedUnbundledNT,customLabels.UnbundledNotSelected,function(){}),o.reject(),o.promise;1===i.length&&i[0].name;var a=[],l="",c="";return r.callRemoteAction(RemoteActions.unbundleManually,e,t).then(function(e){var t=void 0,i=void 0;if(e&&e.error_msg&&-1<e.error_msg.indexOf("Setup->Security->Remote site settings")){try{var n=e.error_msg.split("/bundleflow"),t=n[0]+" or ask your Salesforce admin for help.",i=n[0].split("endpoint =")[1]}catch(e){t="Ask your Salesforce admin to update the URL in Setup > Security > Remote Site Settings",i="the URL"}alert(t),u.addNotification(customLabels.FailedUnbundledM,"Ask your Salesforce admin to update the URL in Setup > Security > Remote Site Settings to "+i,function(){});n={message:customLabels.FailedUnbundledM,status:"ERROR"};return m.$broadcast("showServiceExpertToast",n),void o.resolve(resBundledMembers)}if(e&&e.debugMode)for(var s in console.log("--unbundle---"),console.log(e),e)console.log(s+": "+e[s]);var t="On Demand"!==window.__gantt.checkRulesMode,i=(d.getDelta(t),e.unbundleStatus),r=e.unbundle;if("STATUS_MULTI_UNBUNDLE_COMPLETE"==i)return n=customLabels.SuccessfullyUnbundledM,m.$broadcast("showServiceExpertToast",{message:n,status:"SUCCESS"}),t=customLabels.SuccessfullyUnbundledM,u.addNotification(customLabels.SuccessfullyUnbundledNT,t,function(){}),void o.reject(e.bundleStatus);if("STATUS_MULTI_UNBUNDLE_FAILED"==i)return n=customLabels.FailedUnbundledM,m.$broadcast("showServiceExpertToast",{message:n,status:"ERROR"}),t=customLabels.FailedUnbundledM,u.addNotification(customLabels.FailedUnbundledNTM,t,function(){}),void o.reject(e.bundleStatus);if("STATUS_MULTI_UNBUNDLE_PARTIAL"==i)return n=customLabels.PartialUnbundledM,m.$broadcast("showServiceExpertToast",{message:n,status:"ERROR"}),t=customLabels.PartialUnbundledM,u.addNotification(customLabels.FailedUnbundledNT,t,function(){}),void o.reject(e.bundleStatus);if("COMPLETE_UNBUNDLE"==i)return e.AppointmentNumber?a.push(e.AppointmentNumber):Object.keys(r).map(function(e){r[e]&&r[e].AppointmentNumber&&a.push(r[e].AppointmentNumber)}),n={message:l=1<a.length?customLabels.SuccessfullyUnbundledM:(c=a[0],String.format(customLabels.SuccessfullyUnbundled,c)),status:"SUCCESS"},m.$broadcast("showServiceExpertToast",n),u.addNotification(customLabels.SuccessfullyUnbundledNT,l,function(){}),void o.resolve(r);t="",i={message:t=e.shortMsg&&""!=e.shortMsg?e.shortMsg:t,status:"ERROR"},m.$broadcast("showServiceExpertToast",i),n="";e.longMsg&&""!=e.longMsg&&(n=e.longMsg),u.addNotification(customLabels.FailedUnbundledNT,n,function(){}),o.reject(r)}).catch(function(e){console.warn(e),Object.keys(i).map(function(e){i[e]&&i[e].AppointmentNumber&&a.push(i[e].AppointmentNumber)});var t={message:l=1<a.length?customLabels.FailedUnbundledM:(c=a[0],String.format(customLabels.FailedUnbundled,c)),status:"ERROR"};m.$broadcast("showServiceExpertToast",t),u.addNotification(customLabels.FailedUnbundledNT,l,function(){}),o.reject(e)}),o.promise},verifyShowSaOnGantt:function(e){return i()&&e?e=i()&&n(e)?t.serviceAppointments()[e.RelatedBundle]:e:e}}}e.$inject=["$q","sfdcService","DeltaService","utils","$timeout","TimePhasedDataService","$rootScope","ServiceAppointmentLightboxService"],angular.module("serviceExpert").factory("BundleService",e)}(),!function(){function e(o,a,l,t,s,c,d,e,u,i,m){var p=null,h=void 0,n=200,r=1,g=2,v=3,f=4,S=5;function _(e){u.setLightBoxStatus(!1),p.$destroy(),e||p.deffered.reject("closed")}function y(){var t=0;return Object.keys(p.selectedSa).map(function(e){p.selectedSa[e]&&t++}),t}function b(){var e,t;p.errorMode==f&&(p.errorMode=0),p.errorMode||(e=y(),n<e&&(p.errorMode=f,t=(t=customLabels.SelectedServiceAppointmentMax).replace("(0)",n),p.errorMsg=t.replace("(1)",e-n)))}function w(e){p.mode=e}function T(e){t.open(e)}function L(e){p.selectedSa[e]=!p.selectedSa[e],b()}function A(){var t=!0;return Object.keys(p.selectedSa).map(function(e){p.selectedSa[e]||(t=!1)}),t}function I(){var t=!0;return Object.keys(p.selectedSa).map(function(e){p.selectedSa[e]&&(t=!1)}),p.bundlerMap[p.existingBundler]||"UPDATE"!==p.mode||(t=!0),p.selectedBundlePolicy&&p.bundlerPolicyMapLookup[p.selectedBundlePolicy]||"NEW"!==p.mode||(t=!0),t=p.isNativeMode&&"NEW"===p.mode?!1:t}function C(){p.getAllSelected()?p.lightboxServices.forEach(function(e){p.selectedSa[e.id]=!1}):p.lightboxServices.forEach(function(e){p.selectedSa[e.id]=!0}),b()}function k(){p.errorMode!=v&&(p.errorMode=0,b())}function D(){if(p.errorMode!=v&&p.errorMode!=f){if(0==y())return p.errorMode=S,void(p.errorMsg=customLabels.BundleNotSelected);p.errorMsg=customLabels.ReviewBundleErrors,p.errorMode=0;var e=p.isNativeMode?p.selectedPolicyId:p.bundlerPolicyMapLookup[p.selectedBundlePolicy],t=p.bundlerMap[p.existingBundler],i=[],n=[];if(Object.keys(p.selectedSa).map(function(e){p.selectedSa[e]&&(i.push(e),n.push(p.fullSaAll[e]))}),"NEW"==p.mode){if(null==e&&0==p.isNativeMode)return void(p.errorMode=r);s.bundleServiceAppointments(i,e,n).then(function(e){console.log(e),h.resolve(e)},function(){h.reject("closed")})}else{if(null==t)return void(p.errorMode=g);s.updateBundleServiceAppointments(i,e,t,p.existingBundler).then(function(e){h.resolve(e)},function(){h.reject("closed")})}_(!0)}}return{open:function(e,t){(p=c.$new(!0)).deffered=o.defer(),h=p.deffered,p.lightboxServices=e,p.mode="NEW",p.errorMode=0,p.errorMsg=customLabels.ReviewBundleErrors,p.isNativeMode=!0,p.workTypes={},p.fullSaAll={},p.skills={},e.forEach(function(e){e.earlyStartView=a("amDateFormat")(e.earlyStart,"l LT"),e.dueDateView=a("amDateFormat")(e.dueDate,"l LT")}),m.callRemoteAction(RemoteActions.getWorkTypes).then(function(e){e.forEach(function(e){p.workTypes[e.Id]=e.Name}),p.showData2=!0}),m.callRemoteAction(RemoteActions.getWorkOrders).then(function(e){e.forEach(function(e){if(e&&e.SkillRequirements)for(var t=0;t<e.SkillRequirements.length;t++)p.skills[e.Id]=p.skills[e.Id]||[],p.skills[e.Id].push(e.SkillRequirements[t].Skill.MasterLabel)}),p.showData=!0}),m.callRemoteAction(RemoteActions.checkBundleConfig).then(function(e){0==e&&(p.errorMode=v,p.errorMsg=customLabels.NoBundleConfig)}),m.callRemoteAction(RemoteActions.getBundleApexMode).then(function(e){(p.isNativeMode=e)||m.callRemoteAction(RemoteActions.getBundlePolicy).then(function(e){p.bundlerPolicyArr=[],p.bundlerPolicyMap={},0==e.length&&p.errorMode!=v&&(p.errorMode=v,p.errorMsg=customLabels.NoBundlePolicies),e.forEach(function(e){n=36<e.Name.length?e.Name.substring(0,33)+"...":e.Name,p.bundlerPolicyNamesMapLookup[n]=e.Name,p.bundlerPolicyArr.push(n),p.bundlerPolicyMapLookup[n]=e.Id,p.bundlerPolicyMap[e.Id]=n},function(e){console.error(e)})})}),p.selectedValue="cleared",p.cleared=!1,p.fraudulent=!1,p.reviewed=!1,p.selectedPolicyId=t,p.selectedSa={},p.lightboxServices.forEach(function(e){p.selectedSa[e.id]=!0,p.fullSaAll[e.id]=e}),p.$on("keypress",function(e,t){27==t.which&&(p.$evalAsync(p.closeLightbox),h.reject("closed"))}),p.bundlers=[],p.bundlerMap={},p.bundlerFullNameMap={},p.bundlerPolicyMap={},p.bundlerPolicyMapLookup={},p.bundlerPolicyNamesMapLookup={},p.bundlerPolicyArr=[];var i,n="";for(i in d.serviceAppointments()){var s=d.serviceAppointments()[i];s.isBundle&&(p.bundlers.push(s.name),p.bundlerMap[s.name]=s.id,p.bundlerFullNameMap[s.id]=s.name)}var r=angular.element('\n                <div class="LightboxBlackContainer" id="createUpdateBundlePopup" >\n                    <div id="BundlerLightbox" class="LightboxContainer">\n\n                        <div class="lightboxHeaderContainer" id="BundlerLightboxHeader">\n                            <svg ng-click="closeLightbox(false)" aria-hidden="true" class="slds-icon CloseLightbox" fsl-key-press tabindex="0">\n                                <use xlink:href="'+lsdIcons.close+'"></use>\n                            </svg>\n                            <h1 class="light-box-header">'+customLabels.BundleCaption+'</h1>\n                        </div>\n\n                        <div class="lightboxContentContainer">\n\n                       <div  ng-show="errorMode != 0" class=\'slds-theme_error bundle-error\'> \n                            <svg aria-hidden="true" class="slds-icon bundler-error-icon">\n                                        <use xlink:href="'+lsdIcons.violation+'"></use>\n                                    </svg>\n                         {{errorMsg}}\n                        </div> \n                       \n\n                            <p class="saHeader">{{selectedCount()}} '+customLabels.SelectedServiceAppointment+'</p>\n\n                            <div class="tableDiv slds">\n                                \n                                <table id="saTable" class="slds slds-table slds-table_cell-buffer slds-table_bordered" >\n                                        <thead>\n                                        <tr class="slds slds-line-height_reset">\n                                        <th> <input ng-checked="getAllSelected()" ng-click="allSelection()" type="checkbox" > </th>\n                                            <th>'+customLabels.SANumberHeader+"</th>\n                                            <th>"+customLabels.DurationHeader+"</th>\n                                            <th>"+customLabels.AddressHeader+"</th>\n                                            <th>"+customLabels.EarlyStartHeader+"</th>\n                                            <th>"+customLabels.DueDateHeader+"</th>\n                                            <th>"+customLabels.WorkTypeHeader+"</th>\n                                            <th>"+customLabels.AccountHeader+"</th>\n                                            <th>"+customLabels.RequiredSkillsHeader+'</th>\n                                        </tr>\n\n                                        </thead>\n                                        <tbody class=\'slds slds-tbody\'> \n                                        <tr class="slds slds-hint-parent dataRow maxHight30" ng-repeat="sa in lightboxServices | orderBy: \'name\' " >   \n                                        <td class="Width20">\n                                        <input ng-checked="showData && showData2 && selectedSa[sa.id]" ng-click="toggleSelection(sa.id)" type="checkbox" value="{{sa.id}}">\n                                        </td> \n                                            <td class="slds slds-truncate Width80" ng-attr-title="{{sa.name}}">\n                                                <a class="saLink ng-click="" target="_blank" href="../{{ sa.id }}" title="{{sa.name}}">{{showData && showData2 ? sa.name : \'\'}}</a>\n                                            </td>\n                                            <td class="slds slds-truncate Width80" ng-attr-title="{{sa.DurationInMinutes}}">\n                                                <span class="">{{showData && showData2 ? sa.DurationInMinutes : \'\'}}</span>\n                                            </td>\n                                            <td class="slds slds-truncate Width80" ng-attr-title="{{sa.City + \' \' + sa.Street}}">\n                                                <span class="">{{showData && showData2 ? sa.City + \' \' + sa.Street : \'\'}}</span>\n                                            </td>\n                                            <td class="slds slds-truncate Width150" ng-attr-title="{{sa.earlyStartView}}" ng-bind="showData && showData2 ? sa.earlyStartView  : \'\' "> \n                                            </td>\n                                            <td class="slds slds-truncate Width150" ng-attr-title="{{sa.dueDateView}}" ng-bind="showData && showData2 ? sa.dueDateView  : \'\' "> \n                                            </td>\n                                            <td class="slds slds-truncate Width100" ng-attr-title="{{sa.fields[\'WorkTypeId\'] ? workTypes[sa.fields[\'WorkTypeId\']] : \'\'}}">\n                                                <span class="">{{sa.fields[\'WorkTypeId\'] ? workTypes[sa.fields[\'WorkTypeId\']] : \'\'}}</span>\n                                            </td>\n                                            <td class="slds slds-truncate Width100" ng-attr-title="{{sa.accountName}}">\n                                                <span class="">{{showData && showData2 ? sa.accountName : \'\'}}</span>\n                                            </td>\n\n                                            <td class="slds slds-truncate Width100 " ng-attr-title="{{ skills[sa.parentRecord].join(\',\') }}" >\n                                            <span class=""> {{ showData && showData2 ? skills[sa.parentRecord].join(\',\') : \'\' }}</span>\n                                        </td>\n                                           \n                                        </tr>\n                                        </tbody>\n                                </table>\n                                \n                                \n                            </div>\n\n                             <p>\n                                <div>\n                                    <input ng-model="mode" id="createBundleMode" checked="checked" class="modeRadioButton" type="radio" ng-change="clearError()" value="NEW" ng-disabled="errorMode == 3"><label class="radioLables" for="createBundleMode">'+customLabels.CreateNewBundle+'</label></td>\n                                </div>    \n\n                                    <div class="newB">\n                                        <div class="selectBundler" ng-hide="isNativeMode == true">\n                                            <div><span class="required">*</span><span>'+customLabels.BundlePolicy+'</span></div>\n                                            <div>\n                                                <input type="text" ng-class="errorMode == 1  ? \'error-field\' : \'\' " list="bundlerPolicyList" ng-change="clearError()" placeholder="'+customLabels.SelectBundlePolicyDrop+'" ng-model="selectedBundlePolicy"  title="{{bundlerPolicyNamesMapLookup[ selectedBundlePolicy ]}}" class="bundlerInput" ng-disabled="mode === \'UPDATE\' || errorMode == 3">\n                                                \n                                                <datalist id="bundlerPolicyList">\n                                                    <option ng-repeat="(key, value) in bundlerPolicyMap"  [key]="{{value}}">{{value}}</option>\n                                                </datalist>\n                                            </div>\n\n                                            <div ng-class="errorMode == 1 ? \'field-required-lable\' : \'error-hide\' ">'+customLabels.SelectAPolicy+'</div>\n\n                                        </div>\n                                    </div>\n                                <div>\n                                    <p>\n                                        <div>\n                                            <input ng-model="mode" id="updateBundleMode" class="modeRadioButton" type="radio" ng-change="clearError()" value="UPDATE" ng-disabled="errorMode == 3" ><label class="radioLables" for="updateBundleMode">'+customLabels.AddToExistingBundle+'</label> \n                                        </div>\n\n                                        <div class="updateB">\n                                            <div class="selectBundler">\n                                            <div><span class="required">*</span><span>'+customLabels.ExistingBundle+'</span></div>\n                                                <div>\n                                                    <input type="text" ng-class="errorMode == 2 ? \'error-field\' : \'\' " list="bundlerList" placeholder="'+customLabels.SelectBundle+'" title="{{existingBundler}}" ng-model="existingBundler" ng-change="clearError()" class="bundlerInput" ng-disabled="mode === \'NEW\' || errorMode == 3 ">\n                                                    \n                                                    <datalist id="bundlerList">\n                                                        <option ng-repeat="bundlerName in bundlers" value="{{bundlerName}}"/>\n                                                    </datalist>\n                                                </div>\n                                                <div ng-class="errorMode == 2 ? \'field-required-lable\' : \'error-hide\' ">'+customLabels.SelectAnExistingBundle+'</div>\n                                            </div>\n                                        </div>    \n                                    </p>\n                                </div>\n                                    \n                               \n                            </p>\n\n                        </div>\n\n                        <div class="lightboxControllers">\n\n                            <button class="btn cancelButton" ng-click="closeLightbox(false)">'+customLabels.CancelButton+'</button>\n                            <button class="btn apllyButton"  ng-click="apply()" ng-disabled="errorMode == 3" >'+customLabels.SaveButton+'</button> \x3c!-- ng-disabled="nonSelected()"--\x3e\n                        </div>\n\n                    </div>\n                </div>\n            ');return r.find("#BundlerLightbox").draggable({containment:"document",handle:"#BundlerLightboxHeader"}),angular.element("body").append(r),p.closeLightbox=_,p.setMode=w,p.apply=D,p.clearError=k,p.toggleSelection=L,p.allSelection=C,p.nonSelected=I,p.getAllSelected=A,p.editSa=T,p.checkMax=b,p.selectedCount=y,p.$on("$destroy",function(){return r.remove()}),l(r)(p),r.show(),u.setLightBoxStatus(),b(),p.deffered.promise}}}e.$inject=["$q","$filter","$compile","ServiceAppointmentLightboxService","BundleService","$rootScope","TimePhasedDataService","userSettingsManager","StateService","utils","sfdcService"],angular.module("serviceExpert").factory("BundlerAddCreateLightboxService",e)}(),angular.module("serviceExpert").factory("calendarsService",["ResourcesAndTerritoriesService","TimePhasedDataService","HolidayService","$rootScope","utils",function(N,G,$,c,B){var d={},S={},H={},u={};function V(e,t){return B.convertDtToMomentDt(e,t)}function U(e){return B.convertMomentDtToDt(e)}function y(e,t,i,n,s){y(e,t,i,n,s,null,null)}function y(e,t,i,n,s,r){y(e,t,i,n,s,r,null)}function y(e,t,i,n,s,r,o){var a=N.getOperatingHours()[i]||r,l=a.timezone,c=useLocationTimezone?l:userTimeZone;if(s&&useLocationTimezone)for(var d=n.split(","),u=0;u<d.length;u++)var m=d[u].split("_")[1],m=N.territories()[m].operatingHours,c=N.getOperatingHours()[m].timezone;for(var p,r=V(e,c),e=V(t,c),h=(r.clone().tz(l),e.clone().tz(l),U(r)),g=U(e),v=h,f=[r.clone().add(-1,"days"),r.clone(),r.clone().add(1,"days")],S=0;S<f.length;S++){var _=f[S],y=[];if(o){var b=o[B.formatDayToString(U(_))];if(b)for(var w=0;w<b.length;w++)b[w].serviceTerritoryId!=n.split("_")[1]&&b[w].serviceTerritoryId||y.push({slotStart:b[w].startTime,slotFinish:b[w].endTime,type:b[w].timeSlotType,record:"shift",hasTerritory:!!b[w].serviceTerritoryId,isHolidaySlot:!!isHolidayEnabled&&b[w].isHolidayShift,slotColor:b[w].backgroundColor})}if(a)for(var T=a.slots[_.get("day")]||[],L=0;L<T.length;L++){var A=T[L],I=z(_,A,"startHour","startMinute",l,c,s),E=(0==A.startHour&&24==A.endHour&&0!==A.endMinute&&(A.endHour=0),z(_,A,"endHour","endMinute",l,c,s));y.push({slotStart:I,slotFinish:E,type:A.type,record:"timeslot"})}var C=[],C=o&&!a||!o&&a?y:function(e,t){for(var i=[],n=0;n<e.length-1;n++){var s=void 0,r=e[n],o=e[n+1];if(r.getTime()!=o.getTime()){for(var a=0;a<t.length;a++){var l,c=t[a];!B.intersectDates({start:r,finish:o},{start:c.slotStart,finish:c.slotFinish}).intersection||(void 0===(l=s)||"timeslot"==l.record||"shift"==l.record&&(!l.hasTerritory&&c.hasTerritory||!l.isHolidaySlot&&c.isHolidaySlot)||(l.hasTerritory&&c.hasTerritory||!l.hasTerritory&&!c.hasTerritory)&&l.originalSlotStart>c.slotStart)&&(s={slotStart:r,slotFinish:o,type:c.type,record:c.record,hasTerritory:c.hasTerritory,originalSlotStart:c.slotStart,isHolidaySlot:c.isHolidaySlot,slotColor:c.slotColor})}s&&i.push(s)}}return i.reduce(function(e,t){var i;return e.length?(i=e.pop()).slotFinish==t.slotStart&&i.record==t.record&&i.type==t.type&&i.isHolidaySlot==t.isHolidaySlot&&"shift"!=i.record&&"shift"!=t.record?(i.slotFinish=t.slotFinish,e.push(i)):e.push(i,t):e.push(t),e},[])}((p=y)&&p.length?p.reduce(function(e,t){return e.push(t.slotStart,t.slotFinish),e},[]).sort(function(e,t){return e-t}):[],y.sort(function(e,t){return e.slotStart-t.slotStart}));a&&G.operatingHoursAndHolidays()&&!function(){var e=B.formatDayToString(U(_)),e=(G.operatingHoursAndHolidays()[i]||{})[e]||[],t=[];e.forEach(function(e){t.push($.enhanceHoliday(e,n,l,c,i))}),$.addHolidaysIntoCollection(t),C=function(e,t,i,n){e.forEach(function(e){return $.trimHoliday(e,i,n)}),e.sort(function(e,t){return e.start-t.start||e.finish-t.finish});e=$.mergeHolidays(e);return $.excludeHolidaysFromSlots(e,t,"slotStart","slotFinish")}(t,C,h,g)}();for(var k=0;k<C.length;k++){var D,R,O,F,M,P,x=B.intersectDates({start:C[k].slotStart,finish:C[k].slotFinish},{start:h,finish:g}).intersection;x&&(D=x.start,x=x.finish,"shift"==C[k].record&&C[k].slotColor?(j(v,D,n,null),j(D,x,n,C[k].record,C[k].slotColor)):"Extended"==C[k].type?(j(v,D,n,null),j(D,x,n,C[k].type)):j(v,D,n,C[k].type),R=F=P=M=O=void 0,R=D,M=x,O=C[k].type,F=n,M=(M.getTime()-R.getTime())/6e4,(P=H[F])||(P={},H[F]=P),F=B.formatDayToString(R),(R=P[F])||(R={regular:0,overtime:0},P[F]=R),"Extended"==O?R.overtime+=M:R.regular+=M,v=x)}}j(v,g,n,null)}function z(e,t,i,n,s,r,o){e=U(e),e.setHours(t[i]),e.setMinutes(t[n]),i=useLocationTimezone?s:userTimeZone;return o&&useLocationTimezone&&(i=r),U(V(e,s).tz(i))}function j(e,t,i,n,s){if(e.getTime()!=t.getTime()){var r,o={};for(r in scheduler.matrix)"MonthlyView"!==r&&"LongView"!==r&&(o[r]=-1<i.indexOf(",")?i.split(","):[i]);var a="gray_section",l=void 0,s=("shift"===n&&s?(l='<div style="background-color: '+(s+="99").encodeHTML()+'; width:100%; height:100%;"></div>',a=void 0):"Extended"===n&&(a="overtime_section"),o[Object.keys(o)[0]]);"gray_section"===a&&u[s]&&(u[s].start_date<t&&u[s].end_date>e||u[s].start_date==t&&u[s].end_date==e)||(scheduler.addMarkedTimespan({start_date:e,end_date:t,sections:o,css:a,html:l}),u[s]={start_date:e,end_date:t,sections:o,css:a,html:l})}}function b(e){var t,i={},n=e||G.resourcesByPrimariesAndRelocations();for(t in n){var s,r,o=n[t],a={};for(s in i[t]=a,o){var l=o[s],c=a[l.serviceTerritory];c||(a[l.serviceTerritory]=c=[]),c.push({start:l.effectiveStartDate||l.start,finish:l.effectiveEndDate||l.finish,serviceTerritory:l.serviceTerritory,operatingHours:l.operatingHours,type:l.serviceTerritoryType||l.type,id:l.id,ohTerr:l.ohTerr||null,serviceTerritory__r:l.serviceTerritory__r||null})}for(r in a)a[r].sort(B.sortByTime)}return i}c.$on("gotNewTimePhasedSTMsAndShifts",function(e,t){for(var i=t.start,n=t.finish,s=(t.resourceToServiceCrewMembers,new Date(i)),r=null;s<n;){var o=B.formatDayToString(s);if(!d[o]||c.isOptimizationViewer){d[o]=!0,r=r||b(G.resourcesAndTerritories());var a,l=new Date(s);for(a in l.setDate(l.getDate()+1),N.getResources())!function(e,t,i,n,s){var r,o={P:[],R:[],S:[]},a={};for(r in n){for(var l=n[r].slice(),c=B.generateResourceId(i,r),d=e,u=0;u<l.length;u++){var m=l[u],p=B.intersectDates({start:d,finish:t},m);if(o[m.type].push(m),"S"==m.type)a[m.serviceTerritory]=m;else if(p.intersection){for(var h,g=0;g<p.remainderFrom1.length;g++){var v=p.remainderFrom1[g];v.isStart&&j(v.start,v.finish,c)}"R"!=m.type||S[m.id]||s||!function(e,t,i){var n=[];if(showSecondarySTMs)for(var s in t)for(var r=0;r<t[s].length;r++)"S"!=t[s][r].type&&-1==n.indexOf(s)&&n.push(s);else n=Object.keys(t);n.splice(n.indexOf(e.serviceTerritory),1);var o=e.serviceTerritory;{var a;N.territories()[o]&&(o=N.territories()[o].operatingHours,a=N.getOperatingHours()[o].timezone)}for(var l=0;l<n.length;l++){var c=[B.generateResourceId(i,n[l])],d=(S[e.id]=!0,e.start),u=e.finish,m=(useLocationTimezone&&N.territories()[n[l]]&&(m=N.territories()[n[l]].operatingHours,m=N.getOperatingHours()[m].timezone,d=U(V(d,a).tz(m)),u=U(V(u,a).tz(m))),N.territories()[e.serviceTerritory]?N.territories()[e.serviceTerritory].name:null),p=null,h=null;h=m?(p=customLabels.Relocated_to.replace("$0",_.escape(m)),_.escape(customLabels.Relocated_to_many_params.replaceAll(m||customLabels.Relocated_No_Permissions,moment(d).format("llll"),moment(u).format("llll")))):(p=customLabels.Relocated_No_Permissions,_.escape(customLabels.Relocated_to_no_permissions_many_params.replaceAll(moment(d).format("llll"),moment(u).format("llll"))));scheduler.addMarkedTimespan({start_date:d,end_date:u,sections:{ZoomLevel2:c,ZoomLevel3:c,ZoomLevel4:c,ZoomLevel5:c,ZoomLevel6:c,ZoomLevel7:c},html:"<div class='relocatedLabel' title='"+h+"'><svg aria-hidden='true' class='slds-icon relocationIcon'><use xlink:href='"+lsdIcons.relocation+"'></use></svg> "+p+"</div>",css:"relocation"}),scheduler.addMarkedTimespan({start_date:d,end_date:u,sections:{MonthlyView:c,MTDView:c,LongView:c},html:"<div class='relocatedLabel' title='"+h+"'><svg aria-hidden='true' class='slds-icon relocationIcon'><use xlink:href='"+lsdIcons.relocation+"'></use></svg></div>",css:"relocation_monthly"})}}(m,n,i),d=p.intersection.finish,N.allTerritories[r]&&(m=m.operatingHours||N.allTerritories[r].operatingHours,h=G.resourcesAndShifts()[i],m?y(p.intersection.start,p.intersection.finish,m,c,s,null,h):j(p.intersection.start,p.intersection.finish,c))}}d.getTime()==t.getTime()||a[c.split("_")[1]]||j(d,t,c)}{var f;!showSecondarySTMs||B.isEmpty(a)||s||(f=b(function(e,t){var i={};i[t]={};for(var n=0;n<e.P.length;n++){var s=e.P[n];if(0==e.R.length)i[t][s.id]=s;else for(var r=0;r<e.R.length;r++){var o=e.R[r],a=B.intersectDates(s,o);if(a.intersection||(i[t][s.id]=s),0<a.remainderFrom1.length)for(var l=0;l<a.remainderFrom1.length;l++){var c=angular.copy(s);c.start=a.remainderFrom1[l].start,c.finish=a.remainderFrom1[l].finish,i[t][s.id+"_"+l]=c}i[t][o.id]||((o=angular.copy(o)).serviceTerritory=s.serviceTerritory,i[t][o.id]=o)}}var d={};d[t]={};for(var u=0;u<e.S.length;u++){var m,p=e.S[u];for(m in i[t]){var h=i[t][m],g=B.intersectDates(h,p);g.intersection&&((h=angular.copy(h)).start=g.intersection.start,h.finish=g.intersection.finish,window.isShowSecondaryOperatingHours&&p.operatingHours&&(h.operatingHours=p.operatingHours),h.ohTerr=h.serviceTerritory,h.serviceTerritory=p.serviceTerritory,d[t][m+"_"+u]=h)}}return d}(o,i)),function(e,t,i,n,s){for(var r in n){for(var o=n[r].slice(),a=B.generateResourceId(i,r),l=e,c=0;c<o.length;c++){var d=o[c],u=B.intersectDates({start:l,finish:t},d);if(u.intersection){for(var m=0;m<u.remainderFrom1.length;m++){var p=u.remainderFrom1[m];p.isStart&&j(p.start,p.finish,a)}l=u.intersection.finish;var h=void 0;try{h=d.operatingHours||(N.allTerritories[d.ohTerr]?N.allTerritories[d.ohTerr].operatingHours:d.serviceTerritory__r?d.serviceTerritory__r.OperatingHoursId:void 0)}catch(e){h=null}var g,v=G.resourcesAndShifts()[i];h||v.length?(g=void 0,N.getOperatingHours()[h]||(g=d.serviceTerritory__r.OperatingHours),y(u.intersection.start,u.intersection.finish,h,a,s,g,v)):j(u.intersection.start,u.intersection.finish,a)}}l.getTime()!=t.getTime()&&j(l,t,a)}}(e,t,i,f[i],!0))}}(new Date(s),new Date(l),a,r[a])}s.setDate(s.getDate()+1)}});var e={resourceToWorkingDates:H,relocationsOnGantt:S,reset:function(){d={},S={},H={},e.resourceToWorkingDates=H}};return e}]),!function(){function e(i,s,r,e,n,o,a,t,l,c,d){var u=null;function m(){a.setLightBoxStatus(!1),u.$destroy()}function p(e){u.capacityKpi={hoursCapacity:0,hoursInUse:0,completed:0,jeopardy:0,workItemsCapacity:0,workItemsAllocated:0},u.dummyServicesCount=0;var t=scheduler.getEvent(e),i=scheduler.getEvents(t.start_date,t.end_date);u.servicesScheduledToCapacity={},u.capacityKpi.hoursCapacity=t.hoursPerTimePeriod||0,u.capacityKpi.hoursInUse=t.hoursInUse||0,u.capacityKpi.completed=0,u.capacityKpi.jeopardy=0,u.capacityKpi.violations=0,u.capacityKpi.workItemsCapacity=t.workItemsPerTimePeriod||0,u.capacityKpi.workItemsAllocated=t.workItemsAllocated||0;for(var n=u.capacityKpi.total=0;n<i.length;n++)i[n].resourceId===t.resourceId&&"service"===i[n].type&&(i[n].isDummy?u.dummyServicesCount++:("LongView"!==scheduler._mode||scheduler.filter_LongView(i[n].id,i[n],!1))&&i[n].start.getTime()>=t.start_date.getTime()&&i[n].start.getTime()<=t.end_date.getTime()&&(u.capacityKpi.total++,i[n].statusCategory===l.COMPLETED&&u.capacityKpi.completed++,i[n].jeopardy&&u.capacityKpi.jeopardy++,i[n].violations&&u.capacityKpi.violations++,u.servicesScheduledToCapacity[i[n].id]=i[n]))}function h(){return customLabels.KPIsAreCalculatedFromTo.replaceAll(moment(u.kpiStart).format("llll"),moment(u.kpiEnd).format("llll"))}function g(e){return 0<Object.keys(e).length?Object.keys(e):0}function v(e){s.flagged[e]?s.flagged[e]&&(s.flagged[e]=!s.flagged[e]):s.flagged[e]=!0}function f(e,t){""===(t=""===t?prompt(customLabels.msg_to_post_to_chatter,""):t)?alert(customLabels.no_empty_msg_to_chatter):(s.recentlyUsed[e]=!0,s.postToChatter([e],t).then(function(e){}))}function S(t){if(u.unscheduleRunning||!confirm(customLabels.are_you_sure_unschedule))return!0;var i=[],n=[];t.forEach(function(e){u.invokedActionFor[e]=!0,n.push(r.serviceAppointments()[e]),i.push(r.serviceAppointments()[e].resource),s.recentlyUsed[e]=!0}),u.unscheduleRunning=!0,s.unscheduleServices(t).then(function(e){s.drawServicesAndAbsences(e.services,e.absences,[],e.capacities),p(u.lightboxCapacity.id),u.invokedActionFor[t[0]]=!1,u.unscheduleRunning=!1}).catch(function(e){o.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action),u.invokedActionFor[t[0]]=!1,u.unscheduleRunning=!0})}function _(e){if(e.violations){for(var t="",i=0;i<e.violations.length;i++)t+=e.violations[i].RuleName+" - "+e.violations[i].ViolationString+"\n";return t=t&&t.substring(0,t.length-1)}}return{open:function(e){(u=i.$new(!0)).lightboxCapacity=r.resourceCapacities()[e],u.fieldsTypes=o.fieldsTypes,u.selectedTab="details",u.kpiStart=u.lightboxCapacity.start_date,u.kpiEnd=u.lightboxCapacity.end_date,u.servicesScheduledToCapacity={},u.tableSort={orderByField:"",reverse:!1},u.flaggedServices=s.flagged,u.invokedActionFor={},u.SERVICE_CATEGORY=l,u.currentMenu=null,u.dummyServicesCount=0,u.closeLightbox=m,u.openConsoleTab=o.openConsoleTab,u.formatKpitText=h,u.getObjectKeys=g,u.flagService=v,u.unscheduleServices=S,u.postToChatter=f,u.getStatusClass=o.getCSSClassForContext,u.violationsTooltip=_,u.calculateKpisForCapacity=p,u.showLongTermWarning=function(){return"LongView"===scheduler._mode},u.unscheduleRunning=!1,d.fieldsSetFields().then(function(e){u.servicesListFields=e.CapacityServiceColumns,u.tableSort.orderByField=u.servicesListFields[0].FullAPIName}),u.order=function(e,t){u.tableSort.orderByField=e,u.tableSort.reverse=t},u.getRefFieldID=function(e,t){return e[t.FullAPIName.replace("__r","__c")]},u.setCurrentMenu=function(e){u.currentMenu===e?u.currentMenu=null:u.currentMenu=e},u.getStyleForServiceInList=function(e){return window.paletteViewActive&&e.ganttPaletteColor?{background:e.ganttPaletteColor.color}:{background:e.ganttColor}},p(e);var t=angular.element('<div class="LightboxBlackContainer">\n\t\t\t\t<div class="LightboxContainer" id="ContractorCapacityLightbox">\n\n\t\t\t\t\t<div class="lightboxHeaderContainer" id="ContractorCapacityLightboxHeader">\n\n\t\t\t\t\t\t<svg fsl-key-press tabindex="0" ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n\t\t\t\t\t\t\t\u2028<use xlink:href="'+lsdIcons.close+'"></use>\n\t\t\t\t\t\t</svg>\n\n\t\t\t\t\t\t<h1 class="lightboxHeader">\n\t\t\t\t\t\t\t<i>'+customLabels.Capacity+':</i>\n\t\t\t\t\t\t\t{{ lightboxCapacity.name }}\n\t\t\t\t\t\t</h1>\n\n\t\t\t\t\t\t<span class="lightboxSelectedTab">\n\t\t\t\t\t\t\t'+customLabels.Details+'\n\t\t\t\t\t\t</span>\n\n\t\t\t\t\t\t<div class="ExtendedForm">\n\t\t\t\t\t\t\t<a ng-click="openConsoleTab($event,lightboxCapacity.id)" target="_blank" href="../{{ lightboxCapacity.id }}" title="'+customLabels.ExtandedForm+'">\n\t\t\t\t\t\t\t\t<svg aria-hidden="true" class="slds-icon openExternalIcon">\n\t\t\t\t\t\t\t\t\t\u2028<use xlink:href="'+lsdIcons.external+'"></use>\n\t\t\t\t\t\t\t\t\u2028</svg>\n\t\t\t\t\t\t\t</a>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div id="KPIforCapacity" class="KPIforCapacity">\n\t\t\t\t\t\t<div class="kpiIndicator" ng-show="capacityKpi.hoursCapacity > 0">\n\t\t\t\t\t\t\t<div class="kpiResourceValue">\n\t\t\t\t\t\t\t\t<svg aria-hidden="true" class="slds-icon kpiResourceIcon">\n\t\t\t\t\t\t\t\t\t\u2028<use xlink:href="'+lsdIcons.clock+'"></use>\n\t\t\t\t\t\t\t\t\u2028</svg>\n\t\t\t\t\t\t\t\t{{ capacityKpi.hoursInUse }}/{{ capacityKpi.hoursCapacity }}</div>\n\t\t\t\t\t\t\t'+customLabels.Hours_Capacity+'\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="kpiIndicator" ng-show="capacityKpi.workItemsCapacity > 0">\n\t\t\t\t\t\t\t<div class="kpiResourceValue">\n\t\t\t\t\t\t\t\t<svg aria-hidden="true" class="slds-icon kpiResourceIcon">\n\t\t\t\t\t\t\t\t\t\u2028<use xlink:href="'+lsdIcons.standard_objects+'"></use>\n\t\t\t\t\t\t\t\t\u2028</svg>\n\t\t\t\t\t\t\t\t{{ capacityKpi.workItemsAllocated }}/{{ capacityKpi.workItemsCapacity }}</div>\n\t\t\t\t\t\t\t'+customLabels.Services_Capacity+'\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="kpiIndicator">\n\t\t\t\t\t\t\t<div class="kpiResourceValue">\n\t\t\t\t\t\t\t\t<svg aria-hidden="true" class="slds-icon kpiResourceIcon">\n\t\t\t\t\t\t\t\t\t\u2028<use xlink:href="'+lsdIcons.violation+'"></use>\n\t\t\t\t\t\t\t\t\u2028</svg>\n\t\t\t\t\t\t\t\t\x3c!--<i class="fa fa-warning"></i>--\x3e\n\t\t\t\t\t\t\t\t{{ capacityKpi.violations }}</div>\n\t\t\t\t\t\t\t'+customLabels.Violations+'\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="kpiIndicator">\n\t\t\t\t\t\t\t<div class="kpiResourceValue">\n\t\t\t\t\t\t\t\t<svg aria-hidden="true" class="slds-icon kpiResourceIcon">\n\t\t\t\t\t\t\t\t\t\u2028<use xlink:href="'+lsdIcons.jeopardy+'"></use>\n\t\t\t\t\t\t\t\t\u2028</svg>\n\t\t\t\t\t\t\t\t{{ capacityKpi.jeopardy }}</div>\n\t\t\t\t\t\t\t'+customLabels.In_Jeopardy+'\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="kpiIndicator">\n\t\t\t\t\t\t\t<div class="kpiResourceValue">\n\t\t\t\t\t\t\t\t<svg aria-hidden="true" class="slds-icon kpiResourceIcon">\n\t\t\t\t\t\t\t\t\t\u2028<use xlink:href="'+lsdIcons.completed+'"></use>\n\t\t\t\t\t\t\t\t\u2028</svg>\n\n\t\t\t\t\t\t\t\t{{ capacityKpi.completed }}/{{ capacityKpi.total }}</div>\n\t\t\t\t\t\t\t'+customLabels.Completed+'\n\t\t\t\t\t\t</div>\n\n                        <div class="KpiRange">{{formatKpitText()}}</div>\n\t\t\t\t\t\t<div class="KpiRange updateKpiData" ng-if="dummyServicesCount > 0" fsl-key-press tabindex="0" ng-click="calculateKpisForCapacity(lightboxCapacity.id)">\n                            New KPI data is available - click to update\n                        </div>\n\t\t\t\t\t</div>\n                    <div id="ContractorCapacityButtons">\n                    \n                            <span id="LongViewWarning" ng-if="showLongTermWarning()">'+customLabels.LongTermCapacityLBWarning+'</span>\n                    \n                            <button class="capacityServiceUnscheduleAll" ng-disabled="unscheduleRunning" ng-show="getObjectKeys(servicesScheduledToCapacity).length > 0" ng-click="unscheduleServices(getObjectKeys(servicesScheduledToCapacity))">\n                                <i class="fa fa-ban"></i>\n                                 '+customLabels.Unschedule_All+'\n                            </button>\n                        </div>\n\t\t\t\t\t<div id="ContractorCapacityLightboxContent">\n\t\t\t\t\t\n                            <div class="NoServicesFound" ng-show="!getObjectKeys(servicesScheduledToCapacity)">\n                                <i class="fa fa-times"></i>\n                                <div>'+customLabels.No_services+'</div>\n                            </div>\n                        \n                        <table id="CapacityServicesTable" ng-show="getObjectKeys(servicesScheduledToCapacity).length > 0">\n                          <thead>\n                            <tr class="table-header">\n                                <th></th>\n                                <th></th>\n                                <th></th>\n                                <th ng-attr-title="{{field.Label}}" ng-repeat="field in servicesListFields" ng-class="{sortCapacityServicesBy: tableSort.orderByField == field.FullAPIName}" class="truncate capacityServiceColName" ng-click="tableSort.reverse=!tableSort.reverse;order(field.FullAPIName, tableSort.reverse)">\n                                    <span class="">{{field.Label}}</span>\n                                    <span ng-show="tableSort.orderByField == field.FullAPIName">\n                                        <span>\n                                            <svg ng-show ="!tableSort.reverse" aria-hidden="true" class="slds-icon arrowIcon">\n                                              <use xlink:href="'+lsdIcons.arrowup+'"></use>\n                                            </svg>\n                                            <svg ng-show ="tableSort.reverse" aria-hidden="true" class="slds-icon arrowIcon">\n                                              <use xlink:href="'+lsdIcons.arrowdown+'"></use>\n                                            </svg>\n                                        </span>\n                                    </span>\n                                </th>\n                            </tr>\n                          </thead>\n                          <tbody>\n                            <tr ng-repeat="(key, capacityService) in servicesScheduledToCapacity | orderObjectBy:tableSort.orderByField:tableSort.reverse" class="capacityServiceRow">\n                                <td ng-style="getStyleForServiceInList(capacityService)" class="TaskStatusColor {{ getStatusClass(capacityService.statusCategory, SERVICE_CATEGORY) }}" ></td>\n                                <td class="moreOptions">\n                                    <button class="serviceCapacityActionsButton" title="Actions" ng-click="setCurrentMenu($index)">\n                                          <svg class="slds-icon carretDownIcon" aria-hidden="true" ng-show="!invokedActionFor[capacityService.id]">\n                                                <use xlink:href="'+lsdIcons.down+'"></use>\n                                          </svg>\n                                          <img class="capacityServiceLoading"\n                                             src="'+lsdIcons.spinnerGif+'"\n                                             ng-show="invokedActionFor[capacityService.id]"/>\n                                    </button>   \n                                    <div id="actions-menu-{{$index}}" class="serviceCapacityActions" ng-show="currentMenu == $index">\n                                        <a fsl-tab-switch role="select" class="saSingleAction" ng-click="openConsoleTab($event,capacityService.id); setCurrentMenu($index);" target="_blank" href="../{{ capacityService.id }}">'+customLabels.Details+'</a>\n                                        <button fsl-tab-switch role="select" class="saSingleAction" ng-click="flagService(capacityService.id); setCurrentMenu($index);">\n                                            <span ng-show="!flaggedServices[capacityService.id]">'+customLabels.Flag+'</span>\n                                            <span ng-show="flaggedServices[capacityService.id]">'+customLabels.Unflag+'</span>\n                                        </button>\n                                        <button fsl-tab-switch role="select" ng-disabled="unscheduleRunning" class="saSingleAction" ng-click="unscheduleServices([capacityService.id]); setCurrentMenu($index);">'+customLabels.Unschedule+'</button>\n                                        <button fsl-tab-switch role="select" class="saSingleAction" ng-click="postToChatter(capacityService.id, \'\'); setCurrentMenu($index);">'+customLabels.Chatter+'</button>\n                                    </div>\n                                </td>\n                                <td class="iconOnServiceRow"\n                                        title="{{ violationsTooltip(capacityService) }}"\n                                        ng-class="{\'serviceList_jeopardy\': capacityService.jeopardy, \'serviceList_violations\': !capacityService.jeopardy && capacityService.violations}">\n                                        <i class="fa fa-bell" ng-if="capacityService.jeopardy"></i>\n                                        <i class="fa fa-warning" ng-if="capacityService.violations && !capacityService.jeopardy"></i>\n                                </td>\n                                <td ng-attr-title="{{capacityService | displayFieldSetField : field}}" ng-repeat="field in servicesListFields" class="truncate">\n                                    <span ng-show="field.Type != fieldsTypes.Reference" title="{{capacityService | displayFieldSetField : field}}">{{capacityService | displayFieldSetField : field}}</span>\n                                    <a ng-show="field.Type == fieldsTypes.Reference" ng-click="openConsoleTab($event, getRefFieldID(capacityService, field))" target="_blank" href="../{{ getRefFieldID(capacityService, field) }}" title="{{capacityService | displayFieldSetField : field}}">\n                                        {{capacityService | displayFieldSetField : field}}\n                                    </a>\n\n                                </td>\n                            </tr>\n                          </tbody>\n                        </table>\n\n\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>');t.find("#ContractorCapacityLightbox").draggable({containment:"document",handle:"#ContractorCapacityLightboxHeader"}),angular.element("body").append(t),a.setLightBoxStatus(),u.$on("$destroy",function(){return t.remove()}),u.$on("keypress",function(e,t){27==t.which&&u.$evalAsync(u.closeLightbox)}),n(t)(u),o.safeApply(u)}}}e.$inject=["$rootScope","servicesService","TimePhasedDataService","$sce","$compile","utils","StateService","SERVICE_STATUS","SERVICE_CATEGORY","DeltaService","FieldSetFieldsService"],angular.module("serviceExpert").factory("CapacityLightboxService",e)}(),!function(){function e(n,s,e,l,c,d,u,t,r){var i,o,a,m=null,p=deltaInterval||10,h=null,g={services:[],absences:[],capacities:[],positions:[],optimizationRequests:[],rules:[]};function v(e){var i=!(0<arguments.length&&void 0!==e)||e,n=new Date;!1===d.getStreamingActiveState()?(e=d.getDeltaDates(),s.getDelta(m,e.minDate,e.maxDate).then(function(e){var t=1e3*p-(t=n,new Date-t);h=r(f,t<0?0:t),S(e,i)}).catch(function(e){u.addNotification(customLabels.DeltaFailureTitle,customLabels.DeltaFailureMessage,null,null),console.warn(e)})):h=r(f,1e3*p)}function f(){d.isUserIdle()||v(window.__gantt.checkRulesAfterDelta)}function S(t){var i,e,n,s,r,o=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],a=(m=t.updateTime,[]);(t.deletedAbsence&&0<t.deletedAbsence.length||t.updatedAbsence&&0<t.updatedAbsence.length)&&(i={},0<t.updatedAbsence.length&&(e=l.updateTimePhaseData(t.updatedAbsence,"na"),i.updated=e.absences,i.deleted=e.notApprovedAbsencesIds,e=i.updated.map(function(e){return e.resource}).join(","),a.push.apply(a,_toConsumableArray(u.getRelatedServices(u.getIdsOfSObjects(i.updated),e)))),0<t.deletedAbsence.length&&(i.deleted?i.deleted=i.deleted.concat(l.deleteTimePhaseData(t.deletedAbsence,"na").absences):i.deleted=l.deleteTimePhaseData(t.deletedAbsence,"na").absences,a.push.apply(a,_toConsumableArray(u.getRelatedServices(i.deleted)))),(i.updated||i.deleted)&&g.absences.forEach(function(e){return e(i)})),(t.updatedGanttServices&&0<t.updatedGanttServices.length||t.deletedGanttServices&&0<t.deletedGanttServices.length)&&(n={},0<t.deletedGanttServices.length&&(n.deleted=l.deleteTimePhaseData(t.deletedGanttServices,"service").services,a.push.apply(a,_toConsumableArray(u.getRelatedServices(n.deleted)))),0<t.updatedGanttServices.length&&(n.updated=l.updateTimePhaseData(t.updatedGanttServices,"service").services,a.push.apply(a,_toConsumableArray(u.getRelatedServices(u.getIdsOfSObjects(n.updated))))),(n.updated||n.deleted)&&g.services.forEach(function(e){return e(n)})),t.updatedLivePositions&&(s=c.updatePositions(t.updatedLivePositions)).isUpdated&&g.positions.forEach(function(e){return e(s.dic)}),0<a.length&&g.rules.forEach(function(e){return e(a,o)}),d.areContractorsSupported&&(t.deletedCapacities&&0<t.deletedCapacities.length||t.updatedCapacities&&0<t.updatedCapacities.length)&&(r={},0<t.deletedCapacities.length&&(r.deleted=l.deleteTimePhaseData(t.deletedCapacities,"capacity").capacities),0<t.updatedCapacities.length&&(r.updated=l.updateTimePhaseData(t.updatedCapacities,"capacity").capacities),(r.updated||r.deleted)&&g.capacities.forEach(function(e){return e(r)})),d.isOptimizationEnabled&&t.optimizationRequests&&0<t.optimizationRequests.length&&g.optimizationRequests.forEach(function(e){return e(t.optimizationRequests)})}return h=r(f,1e3*p),d.getStreamingActiveState()?console.log("using streaming"):(i=0,document.addEventListener("mousemove",function(){p=deltaInterval||10,300<i&&deltaInterval<60&&!d.isUserIdle()&&(r.cancel(h),h=r(f,1e3*p),console.warn("Delta interval back to normal.")),i=0}),window.Worker&&((o=new Worker(window.__gantt.InactivityMonitorWorker)).onmessage=function(e){300<=(i+=10)&&deltaInterval<60&&p<60&&(p=60,console.warn("Delta interval decreased.")),d.isUserIdle()&&o.terminate()}),a=setInterval(function(){300<=i&&deltaInterval<60&&60!==p&&(p=60,console.warn("Delta interval decreased.")),i>=window.__gantt.maxSecondsOfInactivity&&clearInterval(a)},30010)),{register:function(e,t){return g[e]&&g[e].push(t)},unRegister:function(e,t){g[e].splice(g[e].indexOf(t),1)},getDelta:function(){var e,t=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];!1===d.getStreamingActiveState()&&(e=d.getDeltaDates(),s.getDelta(m,e.minDate,e.maxDate).then(function(e){S(e,t)}).catch(function(e){console.warn(e)}))},getDeltaPromise:function(){var e,t=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],i=n.defer();return!1===d.getStreamingActiveState()?(e=d.getDeltaDates(),s.getDelta(m,e.minDate,e.maxDate).then(function(e){S(e,t),i.resolve(e)}).catch(function(e){console.warn(e),i.reject(res.ex)})):i.resolve(),i.promise},updateOptimizationRequest:function(t){g.optimizationRequests.forEach(function(e){return e([t])})},handleDeltaResponse:S}}e.$inject=["$q","sfdcService","$interval","TimePhasedDataService","LastKnownPositionService","StateService","utils","MstResolver","$timeout"],angular.module("serviceExpert").factory("DeltaService",e)}();var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof=(!function(){function e(e,l){var c,d=e.defer();return e.all([l.callRemoteAction(RemoteActions.getServiceListFields),l.callRemoteAction(RemoteActions.getServiceMiniFormFields),l.callRemoteAction(RemoteActions.getServiceMapInfoWindowFields),l.callRemoteAction(RemoteActions.getServiceGanttTooltipFields),l.callRemoteAction(RemoteActions.getServiceCapacityColumns),l.callRemoteAction(RemoteActions.getGanttFilterFields),l.callRemoteAction(RemoteActions.getServicePreviewFields)]).then(function(e){if(c={ListColumns:e[0],ListExpanded:e[1],MapInfo:e[2],GanttToolTip:e[3],CapacityServiceColumns:e[4],ganttFilter:e[5],servicePreview:e[6]},l.isOptimizationViewer()){if("object"!==_typeof(GanttServiceOptiViewer.prototype.allFieldSets)){GanttServiceOptiViewer.prototype.allFieldSets=c;var t,i={};for(t in GanttServiceOptiViewer.prototype.allFieldSets)for(var n=GanttServiceOptiViewer.prototype.allFieldSets[t],s=0;s<n.length;s++)i[n[s].APIName]=n[s];GanttServiceOptiViewer.prototype.allFieldSetsSet=i}}else if("object"!==_typeof(GanttService.prototype.allFieldSets)){GanttService.prototype.allFieldSets=c;var r,o={};for(r in GanttService.prototype.allFieldSets)for(var a=GanttService.prototype.allFieldSets[r],s=0;s<a.length;s++)o[a[s].APIName]=a[s];GanttService.prototype.allFieldSetsSet=o}d.resolve(c)}).catch(function(e){d.reject(),console.warn("FieldSetFieldsService: unable to get service appointment field sets")}),{fieldsSetFields:function(){return d.promise}}}e.$inject=["$q","sfdcService"],angular.module("serviceExpert").factory("FieldSetFieldsService",e)}(),!function(){function e(t,r,n,e){var i,o=t.defer(),a=[],s={};function l(e){for(var t,i,n=e,s=1;s<=10;s++)1===s&&-1<e.indexOf("1")?(t=n.indexOf(1),i=n.indexOf(10),-1!==t&&t===i&&(t=n.lastIndexOf(1)),n=n.substr(0,t)+"{1} "+n.substr(t+2)):-1!==n.indexOf(s)&&(n=n.replace(s,"{"+s+"}"));return n}function c(t){var e=!1,i=!1;try{t[fieldNames.GanttFilter.Criterias]&&(e=JSON.parse(t[fieldNames.GanttFilter.Criterias]))}catch(e){i=!0,n.addNotification(window.customLabels.CustomFilterInvalidCriteriaButlerMsg,window.customLabels.CustomFilterInvalidCriteriaButlerBody.replace("$0",t[fieldNames.GanttFilter.Name]),null,null)}return{Id:t.Id,Name:t[fieldNames.GanttFilter.Name],Description:t[fieldNames.GanttFilter.Description],Days_after_horizon:t[fieldNames.GanttFilter.Days_after_horizon],Days_before_horizon:t[fieldNames.GanttFilter.Days_before_horizon],Criterias:e,List_only_appointments_on_the_gantt:t[fieldNames.GanttFilter.List_only_appointments_on_the_gantt],Logic:function(e,t){if(e)return l(e);for(var i in e="",t)e+=i+" AND ";return l(e.substr(0,e.length-5))}(t[fieldNames.GanttFilter.Logic],e),Public:t[fieldNames.GanttFilter.Public],Hidden:t[fieldNames.GanttFilter.Hidden],CreatedById:t.CreatedById,Displayed_Fields:t[fieldNames.GanttFilter.Displayed_Fields]?JSON.parse(t[fieldNames.GanttFilter.Displayed_Fields]):null,disabled:i}}return useNewFilters&&(i=r.callRemoteAction(RemoteActions.getGanttFilters),e=e.fieldsSetFields(),t.all([i,e]).then(function(e){var t,i=e[1],e=e[0],n={FSL__RULE_VIOLATIONS__FSL:!0};for(t in i)i[t].forEach(function(e){n[e.FullAPIName]=!0,n[e.APIName]=!0});var s=[];e.forEach(function(e){e=c(e);!function(e,t){if(!e.Criterias)return 1;for(var i in e.Criterias){if(-1<e.Criterias[i].property.indexOf("."))return void console.warn("INVALID FILTER: "+e.Name+" (Id: "+e.Id+")");if(!t[e.Criterias[i].property])return void console.warn("INVALID FILTER: "+e.Name+" (Id: "+e.Id+")")}return 1}(e,n)||s.push(e)}),a=s,o.resolve(s)})),{filtersPromise:o.promise,getFilterById:function(t){var i=null;return a.forEach(function(e){i=e.Id===t?e:i}),i},getFilterFromSalesforce:function(e){var s=t.defer();return r.callRemoteAction(RemoteActions.getFilterById,e).then(function(e){for(var t=c(e),i=!0,n=0;n<a.length;n++)if(a[n].Id===t.Id){a[n]=t,i=!1;break}i&&a.push(t),s.resolve(t)}),s.promise},deleteFilter:function(i){var n=t.defer();return r.callRemoteAction(RemoteActions.deleteFilter,i).then(function(){for(var e=-1,t=0;t<a.length;t++)if(a[t].Id===i){e=t;break}-1!==e&&a.splice(e,1),n.resolve(i)}),n.promise},hideFilter:function(i){var n=t.defer();return r.callRemoteAction(RemoteActions.hideFilter,i).then(function(){for(var e=-1,t=0;t<a.length;t++)if(a[t].Id===i){e=t;break}-1!==e&&a.splice(e,1),n.resolve(i)}),n.promise},setFilterMap:function(e){s=Object.assign(e,{})},getFilterMap:function(){return s}}}e.$inject=["$q","sfdcService","utils","FieldSetFieldsService"],angular.module("serviceExpert").factory("GanttFilterService",e)}(),"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e});function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}!function(){function e(l,t,u,c,m,p){var d=void 0,h=void 0,g=void 0,a=!1,v=l.defer();function f(e,t){for(var i in e)t(e[i])}function S(e){e.ganttPaletteColor&&e.ganttPaletteColor.palleteId===h.Id||(!0===e.fields[h.ServicePropertyNoNamespace]?e.ganttPaletteColor={color:h.ColorScheme.max.color,palleteId:h.Id}:e.ganttPaletteColor={color:h.ColorScheme.min.color,palleteId:h.Id})}function _(e){var t;e.ganttPaletteColor&&e.ganttPaletteColor.palleteId===h.Id||(t=void 0===(t=e.fields[h.ServicePropertyNoNamespace])?h.ColorScheme.empty:h.ColorScheme.picklist[h.ServiceProperty][t],e.ganttPaletteColor={color:t,palleteId:h.Id})}function y(e){if(!e.ganttPaletteColor||e.ganttPaletteColor.palleteId!==h.Id){var t,i=e.fields[h.ServicePropertyNoNamespace],n=(useLocationTimezone&&(t=void 0,e.resourceId?(c=p.getRelevantSTMToGanttService(e))&&c.operatingHours?t=c.operatingHours:c.serviceTerritory&&(t=m.territories()[c.serviceTerritory].operatingHours):e.ServiceTerritoryId&&(t=m.territories()[e.ServiceTerritoryId].operatingHours),c=m.getOperatingHours()[t],t=c?c.timezone:userTimeZone,c=new Date(i),d=userTimeZone,i=u.convertDateBetweenTimeZones(c,t,d).getTime()),void 0),s=void 0,r=void 0,o=void 0,a=void 0;if(void 0===i)n=h.ColorScheme.empty;else{for(var l in g){if(g[l].start<i&&i<=g[l].end){n=l;break}(void 0===s||g[l].start<=s)&&(s=g[l].start,o=l),(void 0===r||g[l].end>r)&&(r=g[l].end,a=l)}void 0===n&&(n=r<i?a:o)}e.ganttPaletteColor={color:n,palleteId:h.Id}}var c,d}function b(e){if(!e.ganttPaletteColor||e.ganttPaletteColor.palleteId!==h.Id){var t=e.fields[h.ServicePropertyNoNamespace],i=void 0,n=void 0,s=void 0,r=void 0,o=void 0;if(void 0===t)i=h.ColorScheme.empty;else{for(var a in g){if(g[a].start<t&&t<=g[a].end){i=a;break}(void 0===n||g[a].start<=n)&&(n=g[a].start,r=a),(void 0===s||g[a].end>s)&&(s=g[a].end,o=a)}void 0===i&&(i=s<t?o:r)}e.ganttPaletteColor={color:i,palleteId:h.Id}}}function w(e){if(!e.ganttPaletteColor||e.ganttPaletteColor.palleteId!==h.Id){var t=e.fields[h.ServicePropertyNoNamespace],i=void 0,n=void 0,s=void 0,r=void 0,o=void 0;if(void 0===h.ColorScheme.geolocation.latitude||void 0===h.ColorScheme.geolocation.longitude)i=h.ColorScheme.empty;else{var a,l=A(h.ColorScheme.geolocation.latitude,h.ColorScheme.geolocation.longitude,t.latitude,t.longitude);for(a in g){if(g[a].start<l&&l<=g[a].end){i=a;break}(void 0===n||g[a].start<=n)&&(n=g[a].start,r=a),(void 0===s||g[a].end>s)&&(s=g[a].end,o=a)}void 0===i&&(i=s<l?o:r)}e.ganttPaletteColor={color:i,palleteId:h.Id}}}function T(e){if(!e.ganttPaletteColor||e.ganttPaletteColor.palleteId!==h.Id){e.fields[h.ServicePropertyNoNamespace];var t=void 0,i=void 0,n=void 0,s=void 0,r=void 0;if(void 0===h.ColorScheme.geolocation.latitude||void 0===h.ColorScheme.geolocation.longitude)t=h.ColorScheme.empty;else{var o,a=A(h.ColorScheme.geolocation.latitude,h.ColorScheme.geolocation.longitude,e.latitude,e.longitude);for(o in g){if(g[o].start<a&&a<=g[o].end){t=o;break}(void 0===i||g[o].start<=i)&&(i=g[o].start,s=o),(void 0===n||g[o].end>n)&&(n=g[o].end,r=o)}void 0===t&&(t=n<a?r:s)}e.ganttPaletteColor={color:t,palleteId:h.Id}}}function L(e,t){var i;switch(e){case"Seconds":i=1e3*t;break;case"Minutes":i=60*t*1e3;break;case"Hours":i=60*t*60*1e3;break;case"Days":i=24*t*60*60*1e3}return i}function A(e,t,i,n){e=Math.PI*e/180,i=Math.PI*i/180,t=Math.PI*(t-n)/180,n=Math.sin(e)*Math.sin(i)+Math.cos(e)*Math.cos(i)*Math.cos(t);return n=60*(180*Math.acos(n)/Math.PI)*1.1515,"km"===distanceUnit?1.609344*n:.8684*n}return{serviceFieldsMap:function(){var i=l.defer();return void 0!==d?setTimeout(function(){i.resolve(d)},0):t.callRemoteAction(RemoteActions.getServiceFieldsMap).then(function(e){for(var t in d={},e)d[t]=JSON.parse(e[t].replace(/&quot;/g,'"'));i.resolve(d)}).catch(function(e){i.reject(e)}),i.promise},applyNewPaletteForGantt:function(e,t){var i=l.defer();if(void 0===h||h.Id!==e.Id){c.SetUserSettingsProperty("Gantt_Palette__c",e.Id);var n,s,e=d[(h=e).ServiceProperty],r=e.Type,o=!1;if(g={},FieldTypes.DATETIME!==r&&FieldTypes.DATE!==r||(s=function(e,t,i,n,s){for(var r=u.convertMomentDtToDt(moment().tz(userTimeZone)),i=L(i,e),e=L(n,t),o=r.getTime()+i,a=(r.getTime()+e-o)/s,l=[],c=0;c<s;c++){var d={start:o+c*a,end:o+(c+1)*a};l.push(d)}return l}(h.ColorScheme.min.value,h.ColorScheme.max.value,h.ColorScheme.min.type,h.ColorScheme.max.type,h.ColorLevel),o=!0),FieldTypes.DOUBLE!==r&&FieldTypes.LOCATION!==r&&FieldTypes.ADDRESS!==r||(s=function(e,t,i){e=parseFloat(e);for(var n=((t=parseFloat(t))-e)/i,s=[],r=0;r<i;r++){var o={start:e+r*n,end:e+(r+1)*n};s.push(o)}return s}(h.ColorScheme.min.value,h.ColorScheme.max.value,h.ColorLevel),o=!0),FieldTypes.INTEGER!==r&&FieldTypes.PERCENT!==r||(s=function(e,t,i){e=parseInt(e);for(var n=((t=parseInt(t))-e)/i,s=(n=Math.round(n),[]),r=0;r<i;r++){var o={start:e+r*n,end:e+(r+1)*n};s.push(o)}return s}(h.ColorScheme.min.value,h.ColorScheme.max.value,h.ColorLevel),o=!0),o){n=function(e,t,i){for(var n=[],s=e.substr(1,2),r=e.substr(3,4).substr(0,2),e=e.substr(5,6),o=t.substr(1,2),a=t.substr(3,4).substr(0,2),t=t.substr(5,6),l=parseInt(s,16),c=parseInt(r,16),d=parseInt(e,16),s=parseInt(o,16),r=parseInt(a,16),e=parseInt(t,16),u=(s-l)/i,m=(r-c)/i,p=(e-d)/i,h=0;h<i;h++){var g=Math.round(Math.abs(l+u*h))%256,v=Math.round(Math.abs(c+m*h))%256,f=Math.round(Math.abs(d+p*h))%256,g=g.toString(16),v=(1===g.length&&(g="0"+g),v.toString(16)),f=(1===v.length&&(v="0"+v),f.toString(16)),g=(1===f.length&&(f="0"+f),"#"+g+v+f);n.push(g)}return n}(h.ColorScheme.min.color,h.ColorScheme.max.color,h.ColorLevel);for(var a=0;a<n.length;a++)g[n[a]]=s[a]}switch(e.Type){case FieldTypes.BOOLEAN:f(t,S);break;case FieldTypes.PICKLIST:f(t,_);break;case FieldTypes.DATETIME:case FieldTypes.DATE:f(t,y);break;case FieldTypes.DOUBLE:case FieldTypes.INTEGER:case FieldTypes.PERCENT:f(t,b);break;case FieldTypes.LOCATION:f(t,w);break;case FieldTypes.ADDRESS:f(t,T);break;default:console.log("Other")}i.resolve()}else i.resolve();return i.promise},getGanttPalettes:function(e){return e&&t.callRemoteAction(RemoteActions.getGanttPalettes).then(function(e){for(var t,i=e.palettes,n=(a=!0,{}),s=0;s<i.length;s++){var r={};if(r.Id=i[s].Id,r.Name=i[s][fieldNames.GanttServicePalette.Name],r.ServiceProperty=i[s][fieldNames.GanttServicePalette.ServiceProperty],r.ServicePropertyNoNamespace=u.removeFSLNamespace(r.ServiceProperty),void 0!==i[s][fieldNames.GanttServicePalette.ColorScheme])try{r.ColorScheme=JSON.parse(i[s][fieldNames.GanttServicePalette.ColorScheme])}catch(e){r.ColorScheme=void 0}else r.ColorScheme=void 0;r.Description=i[s][fieldNames.GanttServicePalette.Description],r.ColorLevel=i[s][fieldNames.GanttServicePalette.ColorLevel],r.Active=i[s][fieldNames.GanttServicePalette.Active],n[r.Id]=r}for(t in n){var o=n[t]&&n[t].ServiceProperty;o&&e.translations[o]&&(n[t].translations=e.translations[o])}v.resolve(n)}).catch(function(e){v.reject(e)}),v.promise},updateGanttServicePaletteColor:function(e){if(void 0!==h)switch(d[h.ServiceProperty].Type){case FieldTypes.BOOLEAN:S(e);break;case FieldTypes.PICKLIST:_(e);break;case FieldTypes.DATETIME:case FieldTypes.DATE:y(e);break;case FieldTypes.DOUBLE:case FieldTypes.INTEGER:case FieldTypes.PERCENT:b(e);break;case FieldTypes.LOCATION:w(e);break;case FieldTypes.ADDRESS:T(e);break;default:console.log("Other")}},resetCurrentPalette:function(){h=void 0,window.paletteViewActive=!1},isEmpty:function(e){if(null==e)return!0;if(0<e.length)return!1;if(0===e.length)return!0;if("object"!==(void 0===e?"undefined":_typeof(e)))return!0;for(var t in e)if(hasOwnProperty.call(e,t))return!1;return!0},werePalettesLoaded:function(){return a}}}e.$inject=["$q","sfdcService","utils","userSettingsManager","ResourcesAndTerritoriesService","TimePhasedDataService"],angular.module("serviceExpert").factory("GanttPalettesService",e)}(),!function(){function e(n,s,r,o,a){var l=null;function t(){return l.closeLightbox()}function c(){l.killWatch&&l.killWatch(),a.setLightBoxStatus(!1),l.$destroy(),l=null}return window.addEventListener("message",function(e){"closeLightbox"===e.data&&t()},!1),{open:function(e,t){var i;l||((l=n.$new(!0)).url=s.trustAsResourceUrl(t).toString(),__gantt.communityNetworkId&&(l.url=l.url.replace("/apex/","")),l.title=e,l.closeLightbox=c,(i=angular.element('<div class="LightboxBlackContainer ng-cloack">\n                    <div class="LightboxContainer ng-cloak" id="ResourceLightbox">\n\n                        <div class="lightboxHeaderContainer lightbox-general" id="ResourceLightboxHeader">\n                            <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            \n                            <h1 class="light-box-header" ng-bind="title"></h1>\n                        </div>\n                        \n                        <iframe onLoad="removeLightboxLoading()" ng-src="{{ url }}" class="resourceLightboxIframe"></iframe>\n                        \n                        <div id="lightbox-loading-cover">\n                            <img src="'+lsdIcons.spinnerGif+'" />\n                            '+customLabels.loading+"\n                        </div>\n\n                    </div>\n                </div>")).find("#ResourceLightbox").draggable({containment:"document",handle:"#ResourceLightboxHeader"}),i.find("#ResourceLightbox").resizable({minHeight:560,minWidth:940,maxWidth:940,handles:"s"}),angular.element("body").append(i),a.setLightBoxStatus(),l.$on("$destroy",function(){return i.remove()}),l.$on("keypress",function(e,t){27==t.which&&l.$evalAsync(l.closeLightbox)}),r(i)(l),o.safeApply(l))},closeLightboxFromOutside:t}}e.$inject=["$rootScope","$sce","$compile","utils","StateService"],angular.module("serviceExpert").factory("GeneralLightbox",e)}(),!function(){function e(C,i,k,l,n,D,R,s,e,c,d,r,u,o){var a=2,O=null,F=null,m=!1,p={STAR:candidatesGrades.ideal,EXCELLENT:candidatesGrades.ideal,GOOD:candidatesGrades.reecommended};function h(e){O&&g(),O=C.$new(!0),window.__servicesInFilter&&(window.__servicesInFilter.applied=!1,updateViewDebounced()),F=null,O.StateService=R,O.wereSlotsAlreadyDrawnOnGantt=!1,O.gettingSlots=!0,O.closePanel=g,O.getResourceField=f,O.generateMstText=V,O.formatDateIntervalFinish=_,O.formatDateInterval=S,O.service=k.serviceAppointments()[e],O.generateResultText=M,O.allSlotsArray=null,O.slotsTimespansIds=[],O.trustHtml=D.trust,O.jumpToDate=T,O.GRADES=p,O.scheduleToSlot=z,O.replaceLabels=L,O.openLightbox=A,O.showOnGantt=N,O.formatDateHeader=y,O.notifyWhenDoneGettingSlots=b,O.shouldNotify=!1,O.scheduledActionInvoked=!1,O.groupSlotsBy="Resource",O.roundGrade=v,O.bestSlot=null,O.gotSlots=!0,O.exception=null,O.isMst=!1,O.mstPromise=null,O.schedulingTakesLong=!1,O.rawTimespans=[],O.partialResults=[],O.showPartialData=!1,O.generateAsyncLabel=H,O.formatTooltipHeader=G,O.formatAsapObjective=B,O.isRelatedSALength=0,O.generateRelatedSAO2Text=U,O.isAdmin=!1,void 0===window.userHasAdminPermissions?l.callRemoteAction(RemoteActions.userHasAdminPermissions).then(function(e){window.userHasAdminPermissions=!!e&&(O.isAdmin=!0)}):O.isAdmin=window.userHasAdminPermissions,O.generatePartialResult=function(e){return customLabels.partialResults[e.Operation].replaceAll(e.Processed,e.Total)},m||l.getSlots(e,R.selectedPolicyId).then(function(e){if(e&&e.value&&e.value.FSLOperationId)return O.isMst=!0,i(function(){return O.schedulingTakesLong=!0},1e3*a),void(O.mstPromise=r.getUpdates(e.value.FSLOperationId).then(function(e){return O.shouldNotify||w({value:e.fslOperation.result}),e}).catch(function(e){console.error(e);e={message:e.message||e};return O.shouldNotify||w({eventType:"exception",event:e}),o.reject({eventType:"exception",event:e})}));w(e)}).catch(function(e){var t={message:e.message||e};console.warn("could not get candidates"),console.log(e),O.shouldNotify||w({eventType:"exception",event:t})}),e='\n                <div id="GetSlotsPanel" xmlns="http://www.w3.org/1999/html">\n\n                    <div class="slots-panel-title-head">\n                        <div class="slots-panel-title">\n                            {{ replaceLabels(\'ShowingCandidatesTo\', [service.name] ) }}\n                        </div>\n                        <div class="clear-slots truncate" ng-click="closePanel()" title="'+customLabels.HideSlots+'">'+customLabels.HideSlots+'</div>\n                    </div>\n\n\n                    <div ng-show="gettingSlots && !wereSlotsAlreadyDrawnOnGantt" class="getting-slots">\n                        <img src="'+lsdIcons.spinnerGif+'" />\n                        '+customLabels.FindingCandidates+'\n                        \n                        <div class="get-slots-mst" ng-show="isMst && schedulingTakesLong">\n                            {{ generateAsyncLabel() }}\n                            <div class="get-slots-mst-button" ng-click="notifyWhenDoneGettingSlots()">'+customLabels.MstNotifyMeWhenDone+'</div>\n                        </div>\n                    </div>\n                    \n                    \n                    <div ng-show="exception" class="get-slots-error">\n                        <svg aria-hidden="true" class="slds-icon">\n                          \u2028<use xlink:href=\''+lsdIcons.violation+"'></use>\n                        \u2028</svg>\n                        {{ exception.message }}\n                        \n                        <div>"+customLabels.ContactSysAdmin+'</div>\n                    </div>\n                    \n                    <div ng-show="!gotSlots && !exception" class="get-slots-error">\n                        <i class="fa fa-frown-o"></i>\n                        \n                        <div>'+customLabels.noCandidatesMessageGantt+'</div>\n                        \n                        <div id="AN-PartialResults" ng-show="partialResults.length > 0">\n                            <div>'+customLabels.particalCouldntProcessAll+' <u ng-show="isAdmin" ng-click="showPartialData = !showPartialData">'+customLabels.ShowDetails+'</u></div>\n\n                            <div ng-show="showPartialData">\n                                <ul>\n                                    <li ng-repeat="partial in partialResults">\n                                        {{ generatePartialResult(partial) }}\n                                    </li>\n\n                                </ul>\n                            </div>\n                        </div>\n                        \n                    </div>\n\n\n\n\n                    <div class="slots-results-recommendations" ng-if="allSlotsArray" ng-show="gotSlots">\n                        <span id="slotsSentence"></span>\n                        <div class="assign-to-recommended" ng-click="scheduleToSlot(bestSlot.Interval.Start, bestSlot.Resource.m_resource.Id, StateService.selectedPolicyId,bestSlot)">'+customLabels.AssignToRecommended+'</div>\n                    </div>\n\n\n\n                    <div class="slots-grouping" ng-show="allSlotsArray" ng-show="gotSlots">\n                        <span class="truncate groupSlotsBy" title="'+customLabels.GroupSlotsBy+'">'+customLabels.GroupSlotsBy+'</span>\n                        <input type="radio" id="groupByResource" name="groupBy" ng-model="groupSlotsBy" value="Resource" checked="checked">\n                        <label class="groupSlotsBy slots-groupByResource truncate" for="groupByResource" title="'+customLabels.Resource+'">'+customLabels.Resource+'</label>\n                        <input type="radio" id="groupByName" name="groupBy" ng-model="groupSlotsBy" value="Date">\n                        <label class="groupSlotsBy truncate slots-groupByName" for="groupByName" title="'+customLabels.Date+'">'+customLabels.Date+'</label>\n\n                        <div class="button-on-grouping" ng-show="service.isScheduled()" ng-click="showOnGantt()" title="'+customLabels.Show_on_gantt+'">\n                            <svg aria-hidden="true" class="slds-icon quickActionIcon">\n                                \u2028<use xlink:href="'+lsdIcons.table+'"></use>\n                            \u2028</svg>\n                        </div>\n\n                        <div class="button-on-grouping" ng-click="openLightbox()" title="'+customLabels.OpenDetailsWindow+'">\n                            <svg aria-hidden="true" class="slds-icon quickActionIcon">\n                                \u2028<use xlink:href="'+lsdIcons.info+'"></use>\n                            \u2028</svg>\n                        </div>\n                    </div>\n\n\n                    <div id="Slots-List-In-Panel" ng-show="gotSlots">\n                    \n                        <div id="AN-PartialResults" ng-show="partialResults.length > 0">\n                            <div>'+customLabels.particalCouldntProcessAll+' <u ng-show="isAdmin" ng-click="showPartialData = !showPartialData">'+customLabels.ShowDetails+'</u></div>\n\n                            <div ng-show="showPartialData">\n                                <ul>\n                                    <li ng-repeat="partial in partialResults">\n                                        {{ generatePartialResult(partial) }}\n                                    </li>\n\n                                </ul>\n                            </div>\n                        </div>\n                        \n                        \n                        \n                    \n                        <div ng-repeat="candidate in allSlotsArray" class="resource-slot-row" ng-init="candidate.showSlots = false" ng-show="groupSlotsBy == \'Resource\'">\n    \n                            <div ng-show="getResourceField(candidate.Resource.m_resource.Id, \'name\')" class="candidates-container-row" ng-click="candidate.showSlots = !candidate.showSlots">\n                                <div ng-show="getResourceField(candidate.Resource.m_resource.Id, \'pictureLink\') == null && getResourceField(candidate.Resource.m_resource.Id, \'serviceCrew\') == undefined" class="ResourcePhotoIcon"></div>\n                                <div ng-show="getResourceField(candidate.Resource.m_resource.Id, \'serviceCrew\') != undefined && getResourceField(candidate.Resource.m_resource.Id, \'pictureLink\') == null" class="ResourcePhotoIcon CrewPhotoIcon"></div>\n                                <img ng-show="getResourceField(candidate.Resource.m_resource.Id, \'pictureLink\') != null" ng-src="{{getResourceField(candidate.Resource.m_resource.Id, \'pictureLink\')}}" class="ResourcePhotoIcon" />\n                                <h1>{{ getResourceField(candidate.Resource.m_resource.Id, \'name\') }}</h1>\n                                {{ replaceLabels(\'Xoptions\', [candidate.SchedulingOptions.length] ) }}\n                                \n                                <div ng-show="candidate.highest.Grade > -1" class="slot-grade slots-highest-grade" ng-class=\'{\n                                                "GS-grade-excellent": candidate.highest.Grade >= GRADES.EXCELLENT,\n                                                "GS-grade-good": candidate.highest.Grade >= GRADES.GOOD && candidate.highest.Grade < GRADES.EXCELLENT,\n                                                "GS-grade-ok": candidate.highest.Grade < GRADES.GOOD}\'>\n    \n                                                {{roundGrade(candidate.highest.Grade)}}/100\n                                </div>\n                            </div>\n    \n                            <div ng-repeat="intervalItem in candidate.SchedulingOptions" class="time-interval" ng-init="intervalItem.showExplain[\'Resource\'] = false; intervalItem.showExplain[\'Date\'] = false;" ng-show="candidate.showSlots">\n                               \n                                <svg class="AN-InfoIcon slds-icon" aria-hidden="true" ng-show="intervalItem.Grades && intervalItem.Grades.length > 0" ng-click="intervalItem.showExplain[groupSlotsBy] = !intervalItem.showExplain[groupSlotsBy]; $event.stopPropagation();">\n                                    <use xlink:href="'+lsdIcons.info+'"></use>\n                                </svg>\n                               \n                                <span class="jump-to-date" title="Jump to date" ng-click="jumpToDate(intervalItem.Interval.Start)">{{ formatDateInterval(intervalItem.Interval.Start) }}</span>\n    \n                                <div class="slot-grade" ng-show="intervalItem.Grade > -1" ng-class=\'{\n                                                "GS-grade-excellent": intervalItem.Grade >= GRADES.EXCELLENT,\n                                                "GS-grade-good": intervalItem.Grade >= GRADES.GOOD && intervalItem.Grade < GRADES.EXCELLENT,\n                                                "GS-grade-ok": intervalItem.Grade < GRADES.GOOD}\'>\n    \n                                                {{roundGrade(intervalItem.Grade)}}/100\n                                </div>\n    \n                                <div ng-click="scheduleToSlot(intervalItem.Interval.Start, candidate.Resource.m_resource.Id, StateService.selectedPolicyId, intervalItem)" class="schedule-to-slot">'+customLabels.Schedule+'</div>\n                                \n                                \n                                <div class="mst-interval-for-tapuhi truncate" ng-show="intervalItem.MSTOptions" title="{{generateMstText(intervalItem.MSTOptions)}}">\n                                    {{generateMstText(intervalItem.MSTOptions)}}\n                                </div>\n                                <div class="mst-interval-for-tapuhi truncate" ng-show="isRelatedSALength" title="{{generateRelatedSAO2Text()}}">\n                                    {{generateRelatedSAO2Text()}}\n                                </div>\n                                \n                                \n                                \n                                <div class="gs-explain-container" ng-show="intervalItem.showExplain[groupSlotsBy] && intervalItem.Grades && intervalItem.Grades.length > 0" >\n                                    <div class="AN-SlotSingleInfo" ng-repeat="info in intervalItem.Grades" ng-if="info.Text">\n                                        <div class="AN-ObjectGrade" ng-class="{\n                                            \'AN-ObjectGradeGood\': info.Grade >= GRADES.EXCELLENT,\n                                            \'AN-ObjectGradeAverage\': info.Grade >= GRADES.GOOD && info.Grade < GRADES.EXCELLENT,\n                                            \'AN-ObjectGradeBad\': info.Grade <= GRADES.GOOD,\n                                        }"></div>\n                                        <b>{{info.HeaderText}}</b><br/>\n                                        <span ng-if="info.ObjectiveRecordTypeName !== \'Objective_Asap\'">{{ info.Text }}</span>\n                                        <span ng-if="info.ObjectiveRecordTypeName === \'Objective_Asap\'">{{ formatAsapObjective(info.Text) }}</span>\n                                    </div>\n                                </div>\n                                \n                               \n                            </div>\n    \n                        </div>\n                        \n                       \n                       \n                        <div ng-repeat="date in dateKeysArray" class="resource-slot-row" ng-init="candidate.showSlots = false" ng-show="groupSlotsBy == \'Date\'">\n                            <div class="candidates-container-row date-title-container" ng-click="slotsByDateObject[date].showDatesSlots = !slotsByDateObject[date].showDatesSlots">\n                                <h1>{{ formatDateHeader(date) }}</h1>\n                                {{ replaceLabels(\'Xoptions\', [slotsByDateObject[date].length] ) }}\n                                \n                                        <div class="slot-grade slots-highest-grade" ng-show="slotsByDateObject[date].highest.Grade > -1" ng-class=\'{\n                                                "GS-grade-excellent": slotsByDateObject[date].highest.Grade >= GRADES.EXCELLENT,\n                                                "GS-grade-good": slotsByDateObject[date].highest.Grade >= GRADES.GOOD && slotsByDateObject[date].highest.Grade < GRADES.EXCELLENT,\n                                                "GS-grade-ok": slotsByDateObject[date].highest.Grade < GRADES.GOOD}\'>\n    \n                                                {{roundGrade(slotsByDateObject[date].highest.Grade)}}/100\n                                        </div>\n                            </div>\n    \n                            <div ng-repeat="intervalItem in slotsByDateObject[date]" class="time-interval" ng-show="slotsByDateObject[date].showDatesSlots">\n                            \n                                <svg class="AN-InfoIcon slds-icon" aria-hidden="true" ng-show="intervalItem.Grades && intervalItem.Grades.length > 0" ng-click="intervalItem.showExplain[groupSlotsBy] = !intervalItem.showExplain[groupSlotsBy]; $event.stopPropagation();">\n                                    <use xlink:href="'+lsdIcons.info+'"></use>\n                                </svg>\n                            \n                                <span class="jump-to-date" title="Jump to date" ng-click="jumpToDate(intervalItem.Interval.Start)">{{ formatDateInterval(intervalItem.Interval.Start, true)}}</span>\n                                <span> ({{intervalItem.Resource.m_resource.Name}})</span>\n    \n                                <div class="slot-grade" ng-show="intervalItem.Grade > -1" ng-class=\'{\n                                                "GS-grade-excellent": intervalItem.Grade >= GRADES.EXCELLENT,\n                                                "GS-grade-good": intervalItem.Grade >= GRADES.GOOD && intervalItem.Grade < GRADES.EXCELLENT,\n                                                "GS-grade-ok": intervalItem.Grade < GRADES.GOOD}\'>\n    \n                                                {{roundGrade(intervalItem.Grade)}}/100\n                                </div>\n    \n                                <div ng-click="scheduleToSlot(intervalItem.Interval.Start, intervalItem.Resource.m_resource.Id, StateService.selectedPolicyId, intervalItem)" class="schedule-to-slot">'+customLabels.Schedule+'</div>\n                                \n                                <div class="mst-interval-for-tapuhi truncate" ng-show="intervalItem.MSTOptions">\n                                    {{generateMstText(intervalItem.MSTOptions)}}\n                                </div>\n                                \n                                \n                                \n                                <div class="gs-explain-container" ng-show="intervalItem.showExplain[groupSlotsBy] && intervalItem.Grades && intervalItem.Grades.length > 0" >\n                                    <div class="AN-SlotSingleInfo" ng-repeat="info in intervalItem.Grades" ng-if="info.Text">\n                                        <div class="AN-ObjectGrade" ng-class="{\n                                            \'AN-ObjectGradeGood\': info.Grade >= GRADES.EXCELLENT,\n                                            \'AN-ObjectGradeAverage\': info.Grade >= GRADES.GOOD && info.Grade < GRADES.EXCELLENT,\n                                            \'AN-ObjectGradeBad\': info.Grade <= GRADES.GOOD,\n                                        }"></div>\n                                        <b>{{info.HeaderText}}</b><br/>\n                                        <span ng-if="info.ObjectiveRecordTypeName !== \'Objective_Asap\'">{{ info.Text }}</span>\n                                        <span ng-if="info.ObjectiveRecordTypeName === \'Objective_Asap\'">{{ formatAsapObjective(info.Text) }}</span>\n                                    </div>\n                                </div>\n                                \n                                \n                                \n                            </div>\n    \n                        </div>\n\n                </div>\n            ';var t=angular.element(e);angular.element("#LeftSideContainer").prepend(t),O.$on("$destroy",function(){return t.remove()}),window.__closeLeftSideTerritories&&window.__closeLeftSideTerritories(),n(t)(O),D.safeApply(O)}function g(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];if(O){F=null,e&&C.$broadcast("GotSlotsEnded"),showCandidates.on=!1,showCandidates.id=null;for(var t=0;t<O.slotsTimespansIds.length;t++)scheduler.deleteMarkedTimespan(O.slotsTimespansIds[t]);updateViewDebounced(),e&&O.$destroy()}}function v(e){return Math.round(e)}function f(e,t){return e&&s.getResources()[e]?s.getResources()[e][t]:null}function S(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],i=60*new Date(e).getTimezoneOffset()*1e3,e=new Date(e+i);return t?moment(e).format("LT"):moment(e).format("llll")}function _(e,t){var i=60*new Date(e).getTimezoneOffset()*1e3,e=new Date(e+i);return new Date(t+i).getDate()!==e.getDate()?moment(e).format("llll"):moment(e).format("LT")}function y(e){e=e.split("_"),e=new Date(e[2],e[1],e[0],0,0,0,0);return moment(e).format("LL")}function M(e){var t,i;if(e)return t=0,i=0,e.forEach(function(e){t++,i+=e.SchedulingOptions.length}),customLabels.getSlotsExpText.replaceAll("<b>"+t+"</b>","<b>"+i+"</b>","<b>"+O.service.name+"</b>","<b>"+S(O.bestSlot.Interval.Start)+"</b>","<b>"+O.bestSlot.Resource.m_resource.Name+"</b>","<b>"+Math.round(O.bestSlot.Grade)+"</b>")}function b(){O.shouldNotify=!0,O.mstPromise.then(function(t){D.addNotification(customLabels.MstFinishedGettingSlots.replace("$0",O.service.AppointmentNumber),customLabels.MstFinishedGettingSlotsMessage,function(){var e;m=!0,h((e=t).fslOperation.result.Service.Id),"exception"===e.eventType&&w(e),w({value:e.fslOperation.result}),m=!1},null,!0)}).catch(function(e){console.error(e),D.addNotification(customLabels.MstFinishedGettingSlots.replace("$0",O.service.AppointmentNumber),e,function(){})}),g(!0)}function w(e){if(O.gettingSlots=!1,"exception"===e.eventType)return O.gotSlots=!1,void(O.exception=e.event);O.partialResults=e.value.PartialResults||[];var t,i,n=e.value,s="",r=null,o=!1;for(t in n.ResourceIDToScheduleData)if(n.ResourceIDToScheduleData[t].SchedulingOptions)for(var a=n.ResourceIDToScheduleData[t].SchedulingOptions,l=0;l<a.length;l++){var c=function(e){var t=60*new Date(e.Start).getTimezoneOffset()*1e3,i=60*new Date(e.Finish).getTimezoneOffset()*1e3;return{startDate:new Date(e.Start+t),endDate:new Date(e.Finish+i)}}(a[l].Interval),d=k.getResoruceGanttIdByDate(t,c.startDate);if(d=showSecondarySTMs&&O.service.ServiceTerritoryId?k.getResoruceGanttIdByDateAndTerritory(t,c.startDate,O.service.ServiceTerritoryId):d)for(var u in 0===l&&(s+=n.ResourceIDToScheduleData[t].Resource.m_resource.Name+", ",o=!0),(c.startDate<r||null===r)&&(r=new Date(c.startDate)),scheduler.matrix){var m={},u=(m[u]=-1<d.indexOf(",")?d.split(","):[d],"");a[l].MSTOptions&&(u=(new Date).getTime()+Math.floor(1e5*Math.random()),window.mstOptions=window.mstOptions||{},window.mstOptions[u]=a[l].MSTOptions);var p="background-color: rgba(118, 226, 164,"+(.11+parseInt(a[l].Grade)/100*.64)+");",h=a[l].Grade<0?"":Math.round(a[l].Grade)+"/100",g=customLabels.CandidateGradeGantt.replaceAll(moment(c.startDate).format("dddd LT"),moment(c.endDate).format("dddd LT"),h),m={start_date:c.startDate,end_date:c.endDate,sections:m,html:"<div oncontextmenu='scheduleSlot(event, \""+O.service.id+'", "'+c.startDate.getTime()+'", "'+d+'", "'+R.selectedPolicyId+'", "'+u+"\")', title='"+g+"' style='"+p+"'><span class='slotText'>"+h+"</span></div>",css:"slotMark"};O.rawTimespans.push(m)}}if(o?((i=D.setDatesByStartAndMode(r)).start.setDate(i.start.getDate()-1),i.end.setDate(i.end.getDate()+1),k.getTimePhasedObjects(i.start,i.end).then(function(){for(var e=0;e<O.rawTimespans.length;e++)O.slotsTimespansIds.push(scheduler.addMarkedTimespan(O.rawTimespans[e]));showCandidates.on=!0,showCandidates.id=O.service.id,D.ganttSettings&&D.ganttSettings.filterCandidates&&(O.service.resourceId&&-1===s.indexOf(O.service.resourceName)&&(s+=O.service.resourceName+", "),s=s.substr(0,s.length-2)),scheduler.setCurrentView(r),C.$broadcast("GotSlots",{resourceToFilter:s,minDateOfCandidate:r})}).finally(function(){return O.wereSlotsAlreadyDrawnOnGantt=!0})):O.gotSlots=!1,O.gotSlots){O.allSlotsArray=[],O.slotsByDateObject={},O.dateKeysArray=[];var v,f=[],S=[];for(v in F={},e.value.ResourceIDToScheduleData){var _=e.value.ResourceIDToScheduleData[v];O.allSlotsArray.push(_);for(var y=0;y<_.SchedulingOptions.length;y++){var b=new Date(_.SchedulingOptions[y].Interval.Start),w=60*new Date(_.SchedulingOptions[y].Interval.Start).getTimezoneOffset()*1e3,w=(F[v]=!0,b.setMilliseconds(b.getMilliseconds()+w),b.getFullYear()+" "+b.getMonth()+" "+b.getDate()),w=(f.includes(w)||(f.push(w),S.push(b)),E(b));O.slotsByDateObject[w]=O.slotsByDateObject[w]||[],_.SchedulingOptions[y].Resource=e.value.ResourceIDToScheduleData[v].Resource,O.slotsByDateObject[w].push(_.SchedulingOptions[y])}}S.sort(function(e,t){return e-t});for(var T=0;T<S.length;T++)O.dateKeysArray[T]=E(S[T]);O.allSlotsArray.sort(function(e,t){return e.Resource.m_resource.Name>t.Resource.m_resource.Name?1:e.Resource.m_resource.Name<t.Resource.m_resource.Name?-1:0});for(var L,A=0;A<O.allSlotsArray.length;A++)O.allSlotsArray[A].highest=P(O.allSlotsArray[A].SchedulingOptions);for(L in O.slotsByDateObject){var I=O.slotsByDateObject[L];I.sort(function(e,t){return e.Interval.Start>t.Interval.Start?1:e.Interval.Start<t.Interval.Start?-1:0}),I.highest=P(I),(!O.bestSlot||O.bestSlot.Grade<I.highest.Grade)&&(O.bestSlot=I.highest)}O.isRelatedSALength=e.value.relatedSACounter,setTimeout(function(){return angular.element("#slotsSentence").html(M(O.allSlotsArray))},100)}}function P(e){for(var t=0,i=e,n=i[0],s=0;s<i.length;s++)i[t].Grade<i[s].Grade&&(n=i[t=s]);return n}function T(e){C.$broadcast("JumpToDate",new Date(e))}function L(e,t){return(e=customLabels[e]).replaceAll.apply(e,_toConsumableArray(t))}function A(){e.open(O.service.id)}function N(){D.showOnGantt(O.service.id)}function G(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:-1,t=0;return O.allSlotsArray.forEach(function(e){return t+=e.SchedulingOptions.length}),customLabels.AB_Explanation_Header.replace("{0}",e).replace("{1}",t)}function B(e){e=parseInt(e);return moment.tz(e,userTimeZone).format("llll")}function H(){return O.service.Use_Async_Logic?customLabels.ServiceUsingAsync:customLabels.MstTakingLongTime}function V(e){var t,i="";for(t in e)i=customLabels.RelatedServiceSchedulingSentence.replace("$0",S(e[t].Interval.Start)).replace("$1",e[t].Resource.m_resource.Name);return i}function U(){return 1<O.isRelatedSALength?customLabels.MultipleRelatedServicesSentence.replace("$0",O.isRelatedSALength):customLabels.SingleRelatedServicesSentence}function I(e,t,i){var n=e.Interval.Start,s=e.Interval.Finish,e=e.Resource.m_resource.Id,r=k.serviceAppointments()[t],o=60*new Date(n).getTimezoneOffset()*1e3,a=k.getResoruceGanttIdByDate(e,n);if(n+=o,s+=o,!r)return n=new Date(n),s=new Date(s),l.saveChangesToServiceAppointment(t,e,null,n,s,R.selectedPolicyId,"AutomaticGetSlots"),void u.getDelta();x(r,n,a||e,i),c.saveChangesToServiceAppointment(r,r).then(function(e){d.calculateKpis()})}function z(t,e,i,n){if(!O.scheduledActionInvoked){if(O.scheduledActionInvoked=!0,!O.service.isImmidietlyFollow&&n.MSTOptions&&0<Object.keys(n.MSTOptions).length)for(var s in n.MSTOptions)I(n.MSTOptions[s],s,i);var r=O.service,o=60*new Date(t).getTimezoneOffset()*1e3,o=(t+=o,r.resourceBeforeDrag=r.resourceId,r.eventBeforeDrag=angular.copy(r),r.fromGetCandidateFlow=!0,k.getResoruceGanttIdByDate(e,t));x(r,t,o||e,i),scheduler._events[r.id]?(scheduler.updateEvent(r.id),scheduler.callEvent("onEventChanged",[r.id,scheduler.getEvent(r.id)]),setTimeout(function(){scheduler.callEvent("onDragEnd")},1200),g()):c.saveChangesToServiceAppointment(r,r).then(function(e){d.calculateKpis(),C.$broadcast("JumpToDate",new Date(parseInt(t)))}).catch(function(e){console.warn("Couldn't update service. "+e[0]+" "+e[2]),D.addNotification(customLabels.Action_Could_Not_Be_Performed,e[2])}).finally(function(){C.$broadcast("JumpToDate",new Date(parseInt(t))),g()}),g()}}function x(e,t,i,n){var s=D.getServiceDuration(e);e.start=new Date(t),e.finish=new Date(t+s),e.start_date=new Date(t),e.end_date=new Date(t+s),e.travelTo=0,e.travelFrom=0,i&&(e.resourceId=i),e.policyUsed=n,e.scheduleMode="AutomaticGetSlots",e.savedFromScheduleHereAndConsecutive=e.isImmidietlyFollow&&e.relatedService2}function E(e){return e.getDate()+"_"+e.getMonth()+"_"+e.getFullYear()}return window.scheduleSlot=function(e,t,s,r,o,a){e.preventDefault(),$("#ScheduleOnSlot").remove(),$('<div id="ScheduleOnSlot">'+customLabels.ScheduleHere+"</div>").css("left",e.clientX-30+"px").css("top",e.clientY+5+"px").on("click",function(){var e=O.service;if(e){if(e.fromGetCandidateFlow=!0,a&&!e.isImmidietlyFollow){var t,i=a,n=o;for(t in mstOptions[i])I(mstOptions[i][t],t,n)}e.resourceBeforeDrag=e.resourceId,e.eventBeforeDrag=angular.copy(e),(!e.start||e.start.getTime()===parseInt(s)&&e.resourceId===r)&&e.start||x(e,parseInt(s),r,o),$("#ScheduleOnSlot").remove(),scheduler._events[e.id]?(scheduler.updateEvent(e.id),scheduler.callEvent("onEventChanged",[e.id,scheduler.getEvent(e.id)]),setTimeout(function(){scheduler.callEvent("onDragEnd")},1200),g()):c.saveChangesToServiceAppointment(e,e).then(function(e){d.calculateKpis(),C.$broadcast("JumpToDate",new Date(parseInt(s)))}).catch(function(e){console.warn("Couldn't update service. "+e[0]+" "+e[2]),D.addNotification(customLabels.Action_Could_Not_Be_Performed,e[2])}).finally(function(){C.$broadcast("JumpToDate",new Date(parseInt(s))),g()})}}).appendTo("body")},$("body").on("click",function(){$("#ScheduleOnSlot").remove()}),{get:h,close:g,getCandidatesIds:function(){return F}}}e.$inject=["$rootScope","$timeout","TimePhasedDataService","sfdcService","$compile","utils","StateService","ResourcesAndTerritoriesService","ServiceAppointmentLightboxService","servicesService","kpiCalculationsService","MstResolver","DeltaService","$q"],angular.module("serviceExpert").factory("GetSlotsService",e)}();var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e)){var i=t,n=[],s=!0,t=!1,r=void 0;try{for(var o,a=e[Symbol.iterator]();!(s=(o=a.next()).done)&&(n.push(o.value),!i||n.length!==i);s=!0);}catch(e){t=!0,r=e}finally{try{!s&&a.return&&a.return()}finally{if(t)throw r}}return n}throw new TypeError("Invalid attempt to destructure non-iterable instance")};function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}!function(){function e(a,l,c){var e=scheduler.serverList("holidays"),e=_slicedToArray(e,2),t=e[0],n=void 0===t?{}:t,t=e[1],s=void 0===t?{}:t;function i(e){var t=moment(e.start).startOf("day").toDate().toISOString(),i=(s[t]=r(e,s[t]||[]),n[t]=n[t]||{},n[t][e.id]);i||(delete(i=Object.assign({territories:{}},e)).territory,delete i.start,delete i.finish,n[t][i.id]=i),e.territory&&e.territory.id&&(i.territories[e.territory.id]=e.territory)}function r(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[];if(e.isAllDay)return[{start:moment(e.start).startOf("day").toDate(),finish:moment(e.finish).endOf("day").toDate()}];for(var i=e.start,n=e.finish,s=0;s<t.length;)if(t[s].finish<i)s++;else{if(t[s].start>n)return t.splice(s,0,{start:i,finish:n}),t;t[s].start<i&&(i=t[s].start),t[s].finish>n&&(n=t[s].finish),t.splice(s,1)}return t.push({start:i,finish:n}),t}return{addHolidaysIntoCollection:function(e){e&&e.length&&(e.forEach(i),scheduler.serverList("holidays",[n,s]))},addHolidayIntoCollection:i,enhanceHoliday:function(e,t,i,n,s){var r=t.split("_")[0],o=t.split("_")[1],r=[(t=r&&Object.values(c.resourcesAndTerritories()[r]||{}).find(function(e){return e.serviceTerritory===o})||{}).operatingHours,(t.serviceTerritory__r||{}).OperatingHoursId].includes(s)?l.territories()[o]:null,t=moment(e.date).startOf("day"),s=(e.isAllDay?t:t.clone().add(e.startTimeInMinutes,"minute")).toDate(),t=(e.isAllDay?t.clone().endOf("day"):t.clone().add(e.endTimeInMinutes,"minute")).toDate();return Object.assign({start:a.convertDateBetweenTimeZones(s,i,n),finish:a.convertDateBetweenTimeZones(t,i,n),territory:r},e)},excludeHolidaysFromSlots:function(t,n,s,r){var o=[];e:for(;n&&n.length;)switch(function(){for(var i=n.shift();t.length&&t[0].finish<=i[s];)t.shift();if(!t.length)return o.push.apply(o,[i].concat(_toConsumableArray(n))),"break";if(i[r]<=t[0].start||i.isHolidaySlot)return o.push(i),"continue";var e=a.intersectDates({start:i[s],finish:i[r]},t[0]);e.remainderFrom1&&e.remainderFrom1.length&&(e=e.remainderFrom1.map(function(e){var t;return Object.assign({},i,(_defineProperty(t={},s,e.start),_defineProperty(t,r,e.finish),t))}),n.unshift.apply(n,_toConsumableArray(e)))}()){case"break":break e;case"continue":continue}return o},mergeHolidayIntoDayIntervals:r,mergeHolidays:function(e){var t=[],i=void 0;return e.forEach(function(e){!i||e.start>i.finish?t.push(i=e):e.finish>i.finish&&(i.finish=e.finish)}),t},trimHoliday:function(e,t,i){e.start<t&&(e.start=t),e.finish>i&&(e.finish=i)},reset:function(){scheduler.serverList("holidays",[]);var e=scheduler.serverList("holidays"),t=(e=_slicedToArray(e,2))[0],t=(n=void 0===t?{}:t,e[1]);s=void 0===t?{}:t}}}e.$inject=["utils","ResourcesAndTerritoriesService","TimePhasedDataService"],angular.module("serviceExpert").factory("HolidayService",e)}(),!function(){function e(e,t,i,o){var a={};return{getLastKnownPositions:function(){return t.getLivePositions().then(function(e){for(var t in e)a[t]=new LastKnownPosition(e[t]);return a})},updatePositions:function(e){var t,i={},n=!1;for(t in e){var s=new LastKnownPosition(e[t]),r=void 0;e[t].ServiceCrewMembers&&e[t].ServiceCrewMembers[0].IsLeader&&(r=o.getCrewToResources()[e[t].ServiceCrewMembers[0].ServiceCrewId]),(!a[s.id]||a[s.id].lastModifiedDate<s.lastModifiedDate)&&(i[t]=s,a[t]=s,n=!0,r&&(i[r.Id]=s,a[r.Id]=s))}return{dic:i,isUpdated:n}},lastKnownPositions:function(){return a}}}e.$inject=["$q","sfdcService","utils","ResourcesAndTerritoriesService"],angular.module("serviceExpert").factory("LastKnownPositionService",e)}(),!function(){function e(e,n,t,p,h,g,v,s,r,o,a,l,c,d,i,u,m){var f=n.$new(!0),S=angular.element('\n                        <div class="LeftSideLocationFiltering" >\n\n                            <div class="leftFilteringContentContainer" ng-if="opened">\n\n                                <div id="TF-loadingTerritories" ng-show="currentlySavingTerritories">\n                                    <img src="'+window.lsdIcons.spinnerGif+'" />\n                                    Loading Service Territories\n                                </div>\n\n                                <div class="territories-list-type-tabs">\n                                    <button tabindex="0" fsl-tab-switch role="tab" ng-click="showTree = true; saveTabDebounced()" ng-class="{\'active-territory-tab\' : showTree}">'+customLabels.TerritoriesTree+'</button>\n                                    <button fsl-tab-switch role="tab" ng-click="showTree = false; saveTabDebounced()" ng-class="{\'active-territory-tab\' : !showTree}">'+customLabels.Favorites+'</button>\n                                </div>\n                                \n                                <div tabindex="0" role="tooltip" id="leftLocationFiltering-tooltip" aria-label="'+(showSecondarySTMs&&useLocationTimezone?customLabels.LocationFilteringParagraph+"\n\n "+customLabels.Stms_with_different_tz:customLabels.LocationFilteringParagraph)+'" tooltip-trigger="focus blur mouseenter mouseleave" tooltip-animation="false" tooltip-class="horizonTooltip tooltip-location-inner" tooltip-append-to-body="true" tooltip-placement="bottom" \n                                    tooltip="'+(showSecondarySTMs&&useLocationTimezone?customLabels.LocationFilteringParagraph+"\n\n "+customLabels.Stms_with_different_tz:customLabels.LocationFilteringParagraph)+'">\n                                    <svg aria-hidden="true" class="slds-icon info-tooltip-icon">\n                                        \u2028<use xlink:href="'+lsdIcons.info+'"></use>\n                                    \u2028</svg>\n                                </div>\n\n                                <div class="leftLocationFilteringConf">\n                                \n\n                                    <div class="addBorderBottom">\n                                        <input type="checkbox" ng-model="$parent.showOrphanServices" id="servicesNoLocations" />\n                                        <label for="servicesNoLocations">'+customLabels.unassosiated_filtering+'</label><br/>\n                                    </div>\n\n                                    <input \n                                        id="locationFilteringSearch" \n                                        ng-show="(!showAutocompleteTerritoryPicker)" \n                                        type="search" ng-model="locationSearchTerm.text" \n                                        placeholder="'+customLabels.Search_location+'" \n                                    />\n                                    \n                                    <span fsl-key-press tabindex="0"\n                                        id="TF-SelectAllTerritoriesButton"\n                                        class="selectAllLocationsWhite truncate" \n                                        ng-click="selectAllLocations(true, filteredLocations, locationFilter, showTree)" \n                                        ng-hide="showAutocompleteTerritoryPicker" \n                                        title="'+customLabels.Select_all+'">\n                                            '+customLabels.Select_all+'\n                                        </span>\n                                        \n                                    <span fsl-key-press tabindex="0"\n                                        id="TF-DeselectAllTerritoriesButton"\n                                        class="selectAllLocationsWhite truncate" \n                                        ng-click="selectAllLocations(false, filteredLocations, locationFilter, showTree)" \n                                        ng-hide="showAutocompleteTerritoryPicker"\n                                        title="'+customLabels.Select_none+'">\n                                            '+customLabels.Select_none+'\n                                    </span>\n                                    \n                                    \n                                    \n                                    <img class="tp-spinner" ng-show="$parent.currentlyLoading && showTree" src="'+window.lsdIcons.spinnerGif+'" />\n                                    \n                                    <svg aria-hidden="true" class="slds-icon tp-clear-territory-search" ng-show="$parent.searchText && !$parent.currentlyLoading && showTree" ng-click="clearAutocompleteSearch()">\n                                        \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                                    \u2028</svg>\n                                    \n                                    \n                                    <input type="text" \n                                        ng-show="showAutocompleteTerritoryPicker && showTree" \n                                        class="tp-search-input"\n                                        placeholder="'+window.customLabels.SearchServiceTerritory+'" \n                                        ng-model="$parent.searchText" \n                                        ng-model-options="{ debounce: 333 }" \n                                        ng-change="searchTerritory(searchText)" \n                                        ng-click="setSearchResultBox($event)" \n                                    />\n                                    \n                                    \n                                    <span fsl-key-press tabindex="0"\n                                        id="TF-SelectAllTerritoriesButton"\n                                        class="selectAllLocationsWhite truncate" \n                                        ng-show="showAutocompleteTerritoryPicker && showTree" \n                                        ng-click="selectTerritoriesWithAutocomplete(true)" \n                                        title="'+customLabels.Select_all+'">\n                                            '+customLabels.Select_all+'\n                                        </span>\n                                        \n                                    <span fsl-key-press tabindex="0"\n                                        id="TF-DeselectAllTerritoriesButton"\n                                        class="selectAllLocationsWhite truncate" \n                                        ng-show="showAutocompleteTerritoryPicker && showTree" \n                                        ng-click="selectTerritoriesWithAutocomplete(false)"\n                                        title="'+customLabels.Select_none+'">\n                                            '+customLabels.Select_none+'\n                                    </span>\n                                    \n                                    \n                               \n                                </div>\n                                \n                                   \n                                   \n                                \x3c!-- Territories tree with auto complete --\x3e\n                                        \n                                <div id="TF-TerritoriesTreeWithAutoComplete" class="LocationsTree" ng-show="showAutocompleteTerritoryPicker && showTree">\n                                \n                                \n                                    \x3c!-- SEARCH RESULTS --\x3e\n                                    \n                                    <div class="tp-territories-found-summary" ng-show="$parent.searchText && !currentlyLoading && !noTerritoriesFoundOnSearch">\n                                        {{ searchResultText.replace(\'$0\', currentResults.length) }}\n                                    </div>\n                                \n                                    <div ng-repeat="territory in currentResults" class="locationFilterRow">\n                                \n                                        <input type="checkbox" ng-model="locationFilter[territory.Id]" id="location_{{ territory.Id }}" ng-change="addToCurrentLoadedTerritories(territory.Id, locationFilter[territory.Id])" />\n                                        \n                                        <svg aria-hidden="true" class="slds-icon favorite-territory" ng-class="{\'territory-is-fav\': isTerritoryInFavorite(territory.Id)}" ng-click="toggleFavorite(territory.Id)">\n                                            \u2028<use xlink:href="'+lsdIcons.favorite+'"></use>\n                                        \u2028</svg>\n                                        \n                                        <label for="location_{{ territory.Id }}" ng-bind="territory.Name"></label>\n                                        <span class="ter-search-parent" ng-if="territory.ParentTerritory">({{ territory.ParentTerritory.Name }})</span>\n                                        \n                                        <span title="'+customLabels.SwitchTerritoryHelp+'" class="switch-location" ng-click="switchToTerritory(territory.Id)">'+customLabels.SwitchTerritory+'</span>\n                                        \n                                    </div>\n                                    \n                                    \n                                    \n                                    \x3c!-- CURRENTLY LOADED --\x3e\n                                    \n                                    <div ng-repeat="territoryId in currentlyLoadedTerritories" ng-show="!$parent.searchText" class="locationFilterRow">\n                                \n                                        <input type="checkbox" ng-model="locationFilter[territoryId]" id="location_{{ territoryId }}" />\n                                        \n                                        <svg aria-hidden="true" class="slds-icon favorite-territory" ng-class="{\'territory-is-fav\': isTerritoryInFavorite(territoryId)}" ng-click="toggleFavorite(territoryId)">\n                                            \u2028<use xlink:href="'+lsdIcons.favorite+'"></use>\n                                        \u2028</svg>\n                                        \n                                        <label for="location_{{ territoryId }}">{{territoriesIdsToNames[territoryId]}}</label>\n                                        <span class="ter-search-parent" ng-if="getParentTerritory(territoryId)">({{ getParentTerritory(territoryId).name }})</span>\n                                        \n                                        <span title="'+customLabels.SwitchTerritoryHelp+'" class="switch-location" ng-click="switchToTerritory(territoryId)">'+customLabels.SwitchTerritory+'</span>\n                                        \n                                    </div>\n                                   \n                                    <div class="tp-no-territories-found" ng-show="noTerritoriesFoundOnSearch && !currentlyLoading">\n                                        '+customLabels.NoServiceTerritoriesWereFound+'\n                                    </div>\n                                    \n                                </div>\n                                   \n                                   \n                                <div id="TF-TerritoriesFavoritesAutoComplete" class="LocationsTree" ng-show="showAutocompleteTerritoryPicker && !showTree">\n                                    \n                                    <div ng-repeat="territoryId in favorites" class="locationFilterRow">\n                                \n                                        <input type="checkbox" ng-model="locationFilter[territoryId]" id="location_{{ territoryId }}" />\n                                        \n                                        <svg aria-hidden="true" class="slds-icon favorite-territory" ng-class="{\'territory-is-fav\': isTerritoryInFavorite(territoryId)}" ng-click="toggleFavorite(territoryId)">\n                                            \u2028<use xlink:href="'+lsdIcons.favorite+'"></use>\n                                        \u2028</svg>\n                                        \n                                        <label for="location_{{ territoryId }}">{{territoriesIdsToNames[territoryId]}}</label>\n                                        \n                                        <span title="'+customLabels.SwitchTerritoryHelp+'" class="switch-location" ng-click="switchToTerritory(territoryId)">'+customLabels.SwitchTerritory+'</span>\n                                        \n                                    </div>\n                                    \n                                </div>      \n                                   \n                                   \n                                   \n                                   \n                                \x3c!-- Territories tree without auto complete --\x3e\n                                        \n                                <div id="TF-TerritoriesTree" class="LocationsTree" ng-show="showTree && !showAutocompleteTerritoryPicker">\n                                    <div ng-repeat="l in filteredLocations = (locationsFlat | filter:locationSearchTerm)" class="locationFilterRow" ng-style="{{ styleForLocationTree(l.depth) }}" ng-click="selectLocation(l.id)">\n                                        <input type="checkbox" ng-model="locationFilter[l.id]" id="location_{{ l.id }}" />\n                                        \n                                        <svg aria-hidden="true" class="slds-icon favorite-territory" ng-class="{\'territory-is-fav\': isTerritoryInFavorite(l.id)}" ng-click="toggleFavorite(l.id)">\n                                            \u2028<use xlink:href="'+lsdIcons.favorite+'"></use>\n                                        \u2028</svg>\n                                        \n                                        <label for="location_{{ l.id }}" ng-bind="l.text"></label>\n                                        \n                                        <span title="'+customLabels.SwitchTerritoryHelp+'" class="switch-location" ng-click="switchToTerritory(l.id)">'+customLabels.SwitchTerritory+'</span>\n                                        \n                                    </div>\n                                </div>\n                                \n                                \n                                \n                                \x3c!-- Territories list without auto complete --\x3e\n                                \n                                <div id="TF-TerritoriesListFavorites" class="LocationsTree" ng-show="!showTree && !showAutocompleteTerritoryPicker">\n                                \n                                    <div ng-repeat="l in filteredLocations = (locationsFlat | filter:locationSearchTerm)" ng-show="isTerritoryInFavorite(l.id)" class="locationFilterRow">\n                                        <input type="checkbox" ng-model="locationFilter[l.id]" id="location_f_{{ l.id }}" />\n                                        \n                                        <svg aria-hidden="true" class="slds-icon favorite-territory" ng-class="{\'territory-is-fav\': isTerritoryInFavorite(l.id)}" ng-click="toggleFavorite(l.id)">\n                                            \u2028<use xlink:href="'+lsdIcons.favorite+'"></use>\n                                        \u2028</svg>\n                                        \n                                        <label for="location_f_{{ l.id }}" ng-bind="l.text"></label>\n                                        \n                                        <span title="'+customLabels.SwitchTerritoryHelp+'" class="switch-location" ng-click="switchToTerritory(l.id)">'+customLabels.SwitchTerritory+'</span>\n                                        \n                                    </div>\n                                </div>\n                                    \n\n                            </div>\n                            \n\n                            <div class="lightboxControllers">\n                                <button class="lightboxSaveButton cancelButtonAndClose" ng-click="closeLightbox()">'+customLabels.Cancel+'</button>\n                                <button class="lightboxSaveButton" ng-click="applyFilterLocationWithRowsCheck()">'+customLabels.Save+"</button>\n                            </div>\n\n                        </div>\n                ").hide(),y=(angular.element("#LeftSideContainer").append(S),i.close(),f.trust=v.trust,f.showOrphanServices=!1,f.locationSearchTerm={text:""},f.showLocationFiltering=!1,f.noLocationsLoad=!1,f.locationFilter={},f.locationFilterCopy={},f.locationsFlat=[],f.territoriesSortedByTree=[],f.showTree=!0,f.showSecondaryTimezoneNotice=showSecondarySTMs&&useLocationTimezone,f.spinnerIcon=window.lsdIcons.spinnerGif,f.showAutocompleteTerritoryPicker=window.__gantt.shouldShowAutoCompleteUi,f.currentResults=[],f.showResults=!1,f.noTerritoriesFoundOnSearch=!1,f.cachedTerritoriesQueryResults={},f.currentlyLoading=!1,f.searchText=null,f.allTerritoriesQueried={},f.territoriesIdsToNames={},f.currentlyLoadedTerritories=[],f.currentlySavingTerritories=!1,f.searchResultText=window.customLabels.TerritoriesFoundInSearch,f.isRTL=r.isRtlDirection(),f.getParentTerritory=function(e){e=p.territories()[e];return e&&e.parentTerritory?p.territories()[e.parentTerritory.id]:null},null!==h.GetUserSettingsProperty("ShowFavoriteTerritoriesTab__c")&&(f.showTree=!h.GetUserSettingsProperty("ShowFavoriteTerritoriesTab__c")),f.favorites=h.GetUserSettingsProperty("FavoriteTerritories__c")?JSON.parse(h.GetUserSettingsProperty("FavoriteTerritories__c")):[],_.debounce(function(){h.SetUserSettingsProperty("FavoriteTerritories__c",JSON.stringify(f.favorites))},800));function b(){var e=0<arguments.length&&void 0!==arguments[0]&&arguments[0];f.opened=!0,f.showTree=!0,f.reload=e,e=h.GetUserSettingsProperty("locations"),f.currentlyLoadedTerritories=e?[].concat(_toConsumableArray(e)):[],null!==h.GetUserSettingsProperty("ShowFavoriteTerritoriesTab__c")&&(f.showTree=!h.GetUserSettingsProperty("ShowFavoriteTerritoriesTab__c")),f.favorites=h.GetUserSettingsProperty("FavoriteTerritories__c")?JSON.parse(h.GetUserSettingsProperty("FavoriteTerritories__c")):[],S.show("fast",function(){$(this).find(".territories-list-type-tabs").children()[0].focus()})}return f.saveTabDebounced=_.debounce(function(){h.SetUserSettingsProperty("ShowFavoriteTerritoriesTab__c",!f.showTree)},800),e(S)(f),window.__openLocationFilteringAndReload=function(){return b(!0)},f.toggleFavorite=function(e){var t=f.favorites.indexOf(e);-1<t?f.favorites.splice(t,1):f.favorites.push(e),y()},f.isTerritoryInFavorite=function(e){return f.favorites.includes(e)},f.$on("keypress",function(e,t){27===t.which&&f.closeLightbox()}),f.closeLightbox=function(){if(!f.noLocationsLoad){for(var e in f.locationFilterCopy)f.locationFilter[e]=f.locationFilterCopy[e];f.showOrphanServices=f.showOrphanServicesOldValue,S.hide(),window.__closeLeftSideTerritories=null,f.opened=!1}},window.__closeLeftSideTerritories=f.closeLightbox,f.styleForLocationTree=function(e){var t={};return t[f.isRTL?"margin-right":"margin-left"]=20*e+"px",t},f.switchToTerritory=function(e){for(var t in f.locationFilter)f.locationFilter[t]=!1;f.locationFilter[e]=!0,f.applyFilterLocation()},p.promises.territories().then(function(){var e,t,n={},i=[],s=[],r=[];for(e in p.territories()){var o=p.territories()[e];o.hasSharing&&(n[e]={id:e,parent:o.parentTerritory||0,text:o.name,items:[]},f.territoriesIdsToNames[o.id]=o.name)}for(t in n){var a=n[t],l=function e(t){if(!t.id||!t.parent)return;{var i;return n[t.parent.id]?t.parent:(i={},p.allTerritories[t.parent.id]&&(i={id:p.allTerritories[t.parent.id].id,parent:p.allTerritories[t.parent.id].parentTerritory||0}),e(i))}}(a);(0!==a.parent&&l?n[l.id].items:i).push(a)}f.locationsTree=i;for(var c,d,u=0;u<i.length;u++)!function e(t,i,n){t.depth=i;n.push(t);if(t.items)for(var s=0,r=t.items.length;s<r;s++)t.items[s].depth=i,e(t.items[s],i+1,n)}(i[u],0,f.locationsFlat);if(f.showOrphanServices=JSON.parse(h.GetUserSettingsProperty("Show_Orphan_Services__c")),f.showOrphanServicesOldValue=f.showOrphanServices,f.territoriesSortedByTree=(c=p.territories(),d=f.locationsFlat,Object.keys(c).map(function(e){return c[e]}).sort(function(i,n){var s=0,r=0;return d.forEach(function(e,t){e.id===i.id&&(s=t),e.id===n.id&&(r=t)}),r<s?1:s<r?-1:0})),null!==h.GetUserSettingsProperty("locations")&&(s=h.GetUserSettingsProperty("locations")),g.callRemoteAction(RemoteActions.getUnPrivilegeUserSettingsFields).then(function(e){if(1<e.length){for(var t,i=customLabels.Unprivileged_Usersettings_Fields_Msg.split("{1}"),n=i[0],s="",r=0;r<e.length&&r<3;++r)s+="<br>"+e[r];3<e.length&&(t=e.length-3,s+="<br>",n+=i[1].replace("{2}",t)),n=n.replace("{0}",s),v.addNotification(customLabels.Unprivileged_Usersettings_Fields,n)}}).catch(function(e){console.warn("GetUserSettingsProperty failed :-("),console.error(e)}),f.showAutocompleteTerritoryPicker&&0===f.locationsFlat.length||0===s.length)return f.showLocationFiltering=!0,f.noLocationsLoad=!0,b(),void(0!==f.locationsFlat.length&&0!==s.length||$("#FirstTimeLoading").remove());for(var m=0;m<f.locationsFlat.length;m++)f.noLocationsLoad=!1,f.locationFilter[f.locationsFlat[m].id]=-1<s.indexOf(f.locationsFlat[m].id),f.locationFilter[f.locationsFlat[m].id]&&r.push(f.locationsFlat[m].id);f.locationFilterCopy=angular.copy(f.locationFilter),h.SetUserSettingsProperty("locations",JSON.stringify(r))}),f.applyFilterLocationWithRowsCheck=function(){var e,t,i,n=[];for(e in f.locationFilter)f.locationFilter[e]&&n.push(e);0===n.length?alert(customLabels.One_loaded_location):(t=new Date(scheduler._min_date),i=new Date(scheduler._max_date),t.setDate(t.getDate()-window.daysToLoadOnGanttInit),i.setDate(i.getDate()+window.daysToLoadOnGanttInit),f.currentlySavingTerritories=!0,g.callRemoteAction(RemoteActions.maximumRowsOnGanttReached,t,i,n).then(function(e){e?(f.currentlySavingTerritories=!1,alert(customLabels.MaxedRowsReachedOnGanttAlert)):f.applyFilterLocation()}))},f.applyFilterLocation=function(){var e,i=[],t=[];for(e in f.locationFilter)(f.locationFilter[e]?i:t).push(e);if(0===i.length)return f.currentlySavingTerritories=!1,void alert(customLabels.One_loaded_location);f.noLocationsLoad=!1,angular.extend(f.locationFilterCopy,f.locationFilter),f.showOrphanServicesOldValue=f.showOrphanServices,r.isLoadingNewLocations=!0,d.resetCurrentPalette(),h.SetUserSettingProperties(f.parseLocationSettings(JSON.stringify(i),f.showOrphanServices)).then(function(){f.reload?window.window.location.reload():p.getResourceAndTerritories(function(){a.reset(),p.reset(),scheduler._events={},scheduler.deleteMarkedTimespan();var e=u.filter.searchOnServer;s.reset(e),o.reset(),l.reset(),c.reset(),m.reset()}).then(function(){s.resetReachedMaxRows();var e=new Date(scheduler.getState().min_date),t=new Date(scheduler.getState().max_date);e.setDate(e.getDate()-1),t.setDate(t.getDate()+1),s.getTimePhasedObjects(e,t).then(function(){u.filter.searchOnServer&&s.serviceAppointments(u.filter.searchOnServer)&&n.$broadcast("gotNewTimePhasedObjects",{start:e,finish:t,serviceAppointments:s.serviceAppointments(u.filter.searchOnServer)}),f.currentlySavingTerritories=!1,updateViewDebounced(),n.$broadcast("gotNewResources",{show:i}),r.isLoadingNewLocations=!1}).catch(function(){f.currentlySavingTerritories=!1})})}).catch(function(e){f.currentlySavingTerritories=!1;for(var t=customLabels.territories_r_failure_msg+"\n",i=JSON.parse(e.FailedLocations),n=0;n<i.length;n++)t+=i[n].Name+"\n";v.addNotification(customLabels.territories_r_failure,t),r.isLoadingNewLocations=!1}),f.closeLightbox()},f.parseLocationSettings=function(e,t){return{locations:e,Show_Orphan_Services__c:t}},f.selectLocation=function(e){var t=!f.locationFilter[e],e=function e(t,i){var n=null;for(var s=0;s<t.length;s++){if(t[s].id===i)return t[s];if(n=e(t[s].items,i))return n}return n}(f.locationsTree,e);e&&!function e(t,i){for(var n=0;n<t.items.length;n++)f.locationFilter[t.items[n].id]=i,e(t.items[n],i)}(e,t)},f.selectAllLocations=function(t,e,i,n){n?angular.forEach(e,function(e){i[e.id]=t}):f.selectAllFavoriteLocations(t,e,i)},f.selectAllFavoriteLocations=function(t,e,i){angular.forEach(e,function(e){f.isTerritoryInFavorite(e.id)&&(i[e.id]=t)})},f.searchTerritory=function(i){return""===i?(f.currentResults=[],f.showResults=!1,void(f.noTerritoriesFoundOnSearch=!1)):f.cachedTerritoriesQueryResults[i.toLocaleLowerCase()]?(f.currentResults=f.cachedTerritoriesQueryResults[i.toLocaleLowerCase()],f.showResults=!0,void(0===f.currentResults.length?f.noTerritoriesFoundOnSearch=!0:f.noTerritoriesFoundOnSearch=!1)):(f.currentlyLoading=!0,void window.Visualforce.remoting.Manager.invokeAction(window.RemoteActions.searchTerritories,i,function(e,t){t.status?v.safeApply(f,function(){f.cachedTerritoriesQueryResults[i.toLocaleLowerCase()]=e,f.showResults=!0,f.searchText===i&&(f.currentlyLoading=!1,0===(f.currentResults=e).length?f.noTerritoriesFoundOnSearch=!0:(f.noTerritoriesFoundOnSearch=!1,e.forEach(function(e){f.allTerritoriesQueried[e.Name]=e,f.territoriesIdsToNames[e.Id]=e.Name})))}):console.warn(t)},{buffer:!0,escape:!1,timeout:12e4}))},f.addToCurrentLoadedTerritories=function(e,t){var i=f.currentlyLoadedTerritories.indexOf(e);t&&-1===i&&f.currentlyLoadedTerritories.push(e),!t&&1<i&&f.currentlyLoadedTerritories.splice(i,1)},f.clearAutocompleteSearch=function(){f.currentResults=[],f.showResults=!1,f.noTerritoriesFoundOnSearch=!1,f.currentlyLoading=!1,f.searchText=""},f.selectTerritoriesWithAutocomplete=function(t){f.searchText?f.currentResults.forEach(function(e){f.locationFilter[e.Id]=t,f.addToCurrentLoadedTerritories(e.Id,t)}):f.currentlyLoadedTerritories.forEach(function(e){f.locationFilter[e]=t})},{isOpen:function(){return f&&f.opened},open:b,getFlatTerritoriesArray:function(){return f.locationsFlat},getTerritoriesSortedByTree:function(){return f.showAutocompleteTerritoryPicker?window._.toArray(p.territories()):f.territoriesSortedByTree},isNoTerritoryLoadded:function(){return f.noLocationsLoad}}}e.$inject=["$compile","$rootScope","$q","ResourcesAndTerritoriesService","userSettingsManager","sfdcService","utils","TimePhasedDataService","StateService","calendarsService","monthlyViewHelperService","ResourceCrewsService","ResourceCapacitiesService","GanttPalettesService","GetSlotsService","servicesService","HolidayService"],angular.module("serviceExpert").factory("LeftSideLocationFilteringService",e)}(),!function(){function e(l,c,d,u,m){function p(e,t,i){var n=void 0,s=void 0,r=d.addDaysToDate(t,1-i),o=t;if(e[r]){for(s=r;s<=o&&e[s];)s=d.addDaysToDate(s,1);return n=(o.getTime()-s.getTime())/864e5,{date:o,horizon:++n}}for(s=o;r<=s&&e[s];)s=d.addDaysToDate(s,-1);return n=(s.getTime()-r.getTime())/864e5,{date:s,horizon:++n}}return{getBackHorizonToFetch:p,loadServicesInBulk:function(e,t,i,n,s){var r=l.defer(),o=p(t,i,n),a=d.addDaysToDate(o.date,1-o.horizon),e=function(e,t,i){var n,s=[];for(n in e)!function(e,t,i){i=d.addDaysToDate(t,-i);if(e.earlyStart&&e.earlyStart>i&&e.earlyStart<=t)return 1;if(e.dueDate&&e.dueDate>i&&e.dueDate<=t)return 1;if(e.appStart&&e.appStart>i&&e.appStart<=t)return 1;if(e.appEnd&&e.appEnd>i&&e.appEnd<=t)return 1;if(e.finish&&e.finish>i&&e.finish<=t)return 1;if(e.start&&e.start>i&&e.start<=t)return 1;return}(e[n],t,i)||s.push(n);return s}(e,i,n);return s&&(e=e.filter(function(e){return s<e})),function(e,t,i){var n=new Date(t),s=!1;for(;i;)e[d.generateDateKey(n)]||(s=!0),e[d.generateDateKey(n)]=!0,n.setDate(n.getDate()-1),i--;return s}(t,i,n)||s?c.loadServicesInBulk(o.date,o.horizon,numberOfServicesToLoadInEachBulk,e,s).then(function(e){var t=[],i=(e.ganttServiceAppointments.forEach(function(e){e.AssignedResource&&!scheduler._events[e.Id]&&t.push(e.Id)}),Array.isArray(e.stms)&&0<e.stms.length&&u.updateTimePhaseData(e.stms,"stm"),u.updateTimePhaseData(e.ganttServiceAppointments,"service")),n=u.resourcesAndTerritories(),s={needToCheckRules:t,scheduledServices:[],unscheduledServices:[],remainingCount:e.remainingCount,fetchedFromDate:a,horizon:o,totalFetched:e.ganttServiceAppointments.length,lastFetchedId:e.ganttServiceAppointments[e.ganttServiceAppointments.length-1]?e.ganttServiceAppointments[e.ganttServiceAppointments.length-1].Id:null};i.services.forEach(function(e){e.isScheduled()?(e.setGanttResource(n,d.generateResourceId),s.scheduledServices.push(e)):(scheduler._events[e.id]&&delete scheduler._events[e.id],s.unscheduledServices.push(e))}),m.drawServicesAndAbsences(s.scheduledServices,[],[],[]),r.resolve(s)}).catch(function(e){r.reject(e),console.warn("loadServicesInBulk: something went wrong"),d.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)}):r.resolve([]),r.promise}}}e.$inject=["$q","sfdcService","utils","TimePhasedDataService","servicesService"],angular.module("serviceExpert").factory("LoadServiceListService",e)}();var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e)){var i=t,n=[],s=!0,t=!1,r=void 0;try{for(var o,a=e[Symbol.iterator]();!(s=(o=a.next()).done)&&(n.push(o.value),!i||n.length!==i);s=!0);}catch(e){t=!0,r=e}finally{try{!s&&a.return&&a.return()}finally{if(t)throw r}}return n}throw new TypeError("Invalid attempt to destructure non-iterable instance")};function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function GanttService(e,t){if(!t){for(var i in this.sfdcType="service",this.fields={},e.Fields)this.fields[i]=e.Fields[i];this.id=e.Fields.Id||null,this.name=e.Fields.AppointmentNumber||null,this.AssignedResourceLastModifiedDate=e.AssignedResourceLastModifiedDate||null,this.ServiceAppointmentLastModifiedDate=e.ServiceAppointmentLastModifiedDate||null,this.accountName=e.Fields["Account.Name"]||null,this.accountId=e.Fields.AccountId||null,this.latitude=e.Fields.Latitude||null,this.longitude=e.Fields.Longitude||null,this.arrivalWindowEndTime=e.Fields.ArrivalWindowEndTime||null,this.arrivalWindowStartTime=e.Fields.ArrivalWindowStartTime||null,this.dueDate=e.Fields.DueDate||null,this.ganttDisplay=e.Fields.Gantt_Display_Date__c||null,this.durationType=e.Fields.DurationType||null,this.earliestStartTime=e.Fields.EarliestStartTime||null,this.estDuration=e.Fields.Duration||null,this.travelTimeFrom=e.Fields.EstimatedTravelTimeFrom__c||null,this.travelTimeTo=e.Fields.EstimatedTravelTime||null,this.ganttLabel=e.Fields.GanttLabel__c||null,this.jeopardy=e.Fields.InJeopardy__c||null,this.jeopardyReason=e.Fields.jeopardyReasonTranslated||e.Fields.InJeopardyReason__c||null,this.parentRecord=e.Fields.ParentRecordId||null,this.parentRecordStatus=e.Fields.ParentRecordStatusCategory||null,this.parentRecordType=e.Fields.ParentRecordType||null,this.pinned=e.Fields.Pinned__c||!1,this.isBundleMember=e.Fields.IsBundleMember||!1,this.isBundle=e.Fields.IsBundle||!1,this.RelatedBundle=e.Fields.RelatedBundleId||!1,this.schedEndTime=e.Fields.SchedEndTime||null,this.schedStartTime=e.Fields.SchedStartTime||null,this.serviceTerritory=e.Fields.ServiceTerritory||null,this.serviceTerritoryName=e.Fields["ServiceTerritory.Name"]||null,this.status=e.Fields.Status||null,this.statusCategory=e.Fields.StatusCategory||null,this.subject=e.Fields.Subject||null,this.ganttColor=e.Fields.GanttColor__c||null,this.resource=e.Resource||null,this.resourceName=e.ResourceName||null,this.resourceContractor=e.ResourceContractor||null,this.isAssignToCrew=e.IsAssignToCrew||null,this.assignedResource=e.AssignedResource||null,this.violations=null,this.relatedTo=e.relatedTo||null,this.relatedFather=null,this.priority=this.minPriority,this.relatedFather=e.relatedFather,this.policyUsed=e.Fields.Scheduling_Policy_Used__c||null,this.scheduleMode=e.Fields.Schedule_Mode__c||null,this.emergency=e.Fields.Emergency__c||!1,this.isServiceInChain=(usingNewMstModel||e.IsInO2Territory)&&e.isServiceInChain,this.relatedService2=e.relatedService2||null,this.relatedService1=e.relatedService1||null,this.relationshipType=e.relationshipType||null,this.isImmidietlyFollow="Immediately Follow"===e.relationshipType,this.ganttPaletteColor=null,this.Use_Async_Logic=e.Fields.Use_Async_Logic__c||!1,this.icons=e.Fields.GanttIcon__c?e.Fields.GanttIcon__c.split(";"):null,this.totalModifiedTimes=this.ServiceAppointmentLastModifiedDate,this.fromGetCandidateFlow=!1,this.AssignedResourceLastModifiedDate&&(this.totalModifiedTimes+=this.AssignedResourceLastModifiedDate),this.icons&&(this.icons=this.icons.map(function(e){return window.encodeURI(e)}));var n,t="WorkOrder"==e.Fields.ParentRecordType?CustomSettings.woPriorityField:CustomSettings.woliPriorityField,t=(t&&e.ParentFields&&e.ParentFields[t]&&(this.priority=e.ParentFields[t]),fslNamespace?mdtBooleanField.replace(fslNamespace+"__",""):mdtBooleanField);for(n in this.isMDT=!!e.Fields[t],e.Fields.MDT_Operational_Time__c?this.calculateMdtTimes(e.Fields.MDT_Operational_Time__c):this.isMDT&&(this.mdtTimes={travel:[],working:[]}),this.parentFields={},e.ParentFields)this.parentFields[n]=e.ParentFields[n];this.setSchedulerProperties(),addFieldSetToServiceObject(GanttService.prototype.allFieldSetsSet,e.Fields,this),this.isMDT&&(this.travelTimeFrom=0,this.travelTimeTo=0)}}function getGanttResourceWithSecondaryStms(e){if(showSecondarySTMs){var t=e.resourceId.split(",");if(e.resourceBeforeDrag&&e.resourceBeforeDrag!=e.resourceId&&1<t.length)for(var i=0;i<t.length;i++)if(e.resourceBeforeDrag.split(",")[i]!=t[i]){e.resourceId=t[i];break}}}function addFieldSetToServiceObject(e,t,i){for(var n in e){var s=null;if((s=t[e[n].APIName])||0==s){switch(e[n].Type){case"DATE":case"DATETIME":if(null===s)continue;s=__setTimeZoneOffsetToDateField(s),i.fields[e[n].APIName]=s.getTime();break;case"REFERENCE":var r=e[n].JsAPIName.replace("__r","__c");i[r]=t[r]}i[e[n].APIName]=s}}}function LastKnownPosition(e){this.id=e.Id,this.latitude=e[fieldNames.ServiceResource.LastKnownLocation__Latitude__s],this.longitude=e[fieldNames.ServiceResource.LastKnownLocation__Longitude__s],this.lastModifiedDate=e[fieldNames.ServiceResource.LastKnownLocationUpdate__c];e=void 0;this.lastModifiedDate&&(e=60*new Date(this.lastModifiedDate).getTimezoneOffset()*1e3),this.lastModifiedDate=this.lastModifiedDate?new Date(this.lastModifiedDate+e):null}function OptimizationRequest(e){var t;if(this.id=e.Id,this.lastModifiedDate=e.LastModifiedDate,this.lastModifiedDate&&(t=60*new Date(this.lastModifiedDate).getTimezoneOffset()*1e3,this.lastModifiedDate=new Date(this.lastModifiedDate.valueOf()+t)),this.name=e.Name,this.scheduledAmount=e[fieldNames.Optimization_Request.Objects_Scheduled__c],this.objectToScheduled=e[fieldNames.Optimization_Request.Objects_To_Schedule__c],this.status=e[fieldNames.Optimization_Request.Status__c]||null,this.statusLabel=e.statusLabel||e[fieldNames.Optimization_Request.Status__c]||null,this.allTasks=e[fieldNames.Optimization_Request.All_Tasks_Mode__c]||null,this.includeEmptyLocations=e[fieldNames.Optimization_Request.Include_Services_With_Empty_Location__c]||null,this.type=e[fieldNames.Optimization_Request.Type__c]||null,this.failureReason=e[fieldNames.Optimization_Request.Failure_Reason__c]||null,this.failureDetails=e[fieldNames.Optimization_Request.Failure_Details__c]||null,this.optimizationData=e[fieldNames.Optimization_Request.Optimization_Data__c]||null,this.orgResourceAbsence=e[fieldNames.Optimization_Request.Originating_Resource_Absence__c]||null,this.orgServiceAppointment=e[fieldNames.Optimization_Request.Originating_Service_Appointment__c]||null,this.policy=e[fieldNames.Optimization_Request.Scheduling_Policy__c]||null,this.serviceAppointment=e[fieldNames.Optimization_Request.Service_Appointment__c]||null,this.resource=e[fieldNames.Optimization_Request.Service_Resource__c]||null,this.result=e[fieldNames.Optimization_Request.Result__c]||null,this.schedulingRecipe=e[fieldNames.Optimization_Request.Scheduling_Recipe__r]||null,this.territories=[],this.resourceName=null,this.resource&&(this.resourceName=e[fieldNames.Optimization_Request.Service_Resource__c.replace("__c","__r")].Name),this.requestProgressStart=e[fieldNames.Optimization_Request.Request_Progress_Start__c]||null,e[territoryOptimizationRequestRelationshipName])for(var i=0;i<e[territoryOptimizationRequestRelationshipName].length;i++)this.territories.push(new TerritoryOptimizationRequest(e[territoryOptimizationRequestRelationshipName][i]));this.timespan=null,this.finish=e[fieldNames.Optimization_Request.Finish__c]||null,this.start=e[fieldNames.Optimization_Request.Start__c]||null,this.start=__setTimeZoneOffsetToDateField(this.start),this.finish=__setTimeZoneOffsetToDateField(this.finish)}function ResourceAbsence(e){this.id=e.Id,this.end=e[fieldNames.ResourceAbsence.End],this.resource=e[fieldNames.ResourceAbsence.Resource],this.start=e[fieldNames.ResourceAbsence.Start],this.absenceType=e.TypeLabel||e[fieldNames.ResourceAbsence.Type]||"",this.reason=e.TypeLabel||e[fieldNames.ResourceAbsence.Type]||"",this.ganttLabel=e[fieldNames.ResourceAbsence.GanttLabel__c]||null,this.lastModifiedDate=e.LastModifiedDate||null,this.name=window.isOptimizationViewer?e.Id:e.AbsenceNumber,this.resourceName=window.isOptimizationViewer?e.ResourceId:e[fieldNames.ResourceAbsence.Resource__r].Name,this.ganttColor=e[fieldNames.ResourceAbsence.Gantt_Color__c],this.approved=e[fieldNames.ResourceAbsence.Approved__c],this.latitude=e.Latitude,this.longitude=e.Longitude,this.travelTo=e[fieldNames.ResourceAbsence.EstTravelTime__c]?60*e[fieldNames.ResourceAbsence.EstTravelTime__c]:0,this.travelFrom=e[fieldNames.ResourceAbsence.EstTravelTimeFrom__c]?60*e[fieldNames.ResourceAbsence.EstTravelTimeFrom__c]:0,this.sfdcType="absence",e.RecordType&&e.RecordType.DeveloperName&&"Non_Availability"==e.RecordType.DeveloperName?this.type="na":this.type="break",this.setSchedulerProperties()}function ResourceCapacity(e){this.sfdcType="capacity",this.id=e.Id,this.end=e[fieldNames.ResourceCapacity.EndDate],this.resource=e[fieldNames.ResourceCapacity.ServiceResource],this.resourceId=e[fieldNames.ResourceCapacity.ServiceResource],this.resourceName=e[fieldNames.ResourceCapacity.ServiceResource__r]?e[fieldNames.ResourceCapacity.ServiceResource__r].Name:null,this.start=e[fieldNames.ResourceCapacity.StartDate],this.hoursInUse=e[fieldNames.ResourceCapacity.HoursInUse__c],this.hoursPerTimePeriod=e[fieldNames.ResourceCapacity.CapacityInHours]||0,this.minutesUsed=e[fieldNames.ResourceCapacity.MinutesUsed__c],this.lastModifiedDate=e.LastModifiedDate||null,this.name=e.CapacityNumber,this.timePeriod=e[fieldNames.ResourceCapacity.TimePeriod],this.workItemsAllocated=e[fieldNames.ResourceCapacity.Work_Items_Allocated__c],this.workItemsPerTimePeriod=e[fieldNames.ResourceCapacity.CapacityInWorkItems]||0,window.isOptimizationViewer&&(this.resourceName=e[fieldNames.ResourceCapacity.ServiceResource]),this.setSchedulerProperties()}function addDaysToDate(e,t){t*=864e5;return new Date(e.getTime()+t)}function calcCapacityPercentage(e,t){return parseFloat((e/t*100).toFixed(2))}function ResourcesAndTerritories(e){this.id=e.Id,this.name=e.MemberNumber,this.effectiveEndDate=e[fieldNames.ServiceTerritoryMember.EffectiveEndDate]||null,this.effectiveStartDate=e[fieldNames.ServiceTerritoryMember.EffectiveStartDate],this.latitude=e[fieldNames.ServiceTerritoryMember.Latitude],this.longitude=e[fieldNames.ServiceTerritoryMember.Longitude],this.serviceResource=e[fieldNames.ServiceTerritoryMember.ServiceResource],this.serviceResource__r=e[fieldNames.ServiceTerritoryMember.ServiceResource__r],this.serviceTerritory=e[fieldNames.ServiceTerritoryMember.ServiceTerritory],this.serviceTerritory__r=e[fieldNames.ServiceTerritoryMember.ServiceTerritory__r],this.serviceTerritoryType=e[fieldNames.ServiceTerritoryMember.TerritoryType],this.operatingHours=e[fieldNames.ServiceTerritoryMember.OperatingHours],this.operatingHours__r=e[fieldNames.ServiceTerritoryMember.OperatingHours__r],this.effectiveStartDate=__setTimeZoneOffsetToDateField(this.effectiveStartDate,!1,!0),this.effectiveEndDate=__setTimeZoneOffsetToDateField(this.effectiveEndDate,!1),this.timezone=e[fieldNames.ServiceTerritoryMember.ServiceTerritory__r][fieldNames.ServiceTerritory.OperatingHours__r][fieldNames.OperatingHours.Timezone]}function ServiceCrewMember(e){this.id=e.Id,this.name=window.isOptimizationViewer?e.Id:e.Name,this.endDate=e[fieldNames.ServiceCrewMember.EndDate]||null,this.startDate=e[fieldNames.ServiceCrewMember.StartDate],this.serviceResource=e[fieldNames.ServiceCrewMember.ServiceResource],this.serviceResource__r=e[fieldNames.ServiceCrewMember.ServiceResource__r],this.serviceCrew=e[fieldNames.ServiceCrewMember.ServiceCrew],this.serviceCrew__r=window.isOptimizationViewer?{Name:this.serviceCrew,Id:this.serviceCrew}:e[fieldNames.ServiceCrewMember.ServiceCrew__r],this.leader=e[fieldNames.ServiceCrewMember.Leader],this.ganttLabel=e[fieldNames.ServiceCrewMember.GanttLabel],this.ganttColor=e.ServiceCrew?e.ServiceCrew[fieldNames.ServiceCrew.GanttColor__c]:null,this.startDate=__setTimeZoneOffsetToDateField(this.startDate,!1,!0),this.endDate=__setTimeZoneOffsetToDateField(this.endDate,!1)}function ServiceResource(e){var t=this;this.id=e.Id,this.online=!1,this.isUndestaffOrOverStaff=!1,this.name=e.Name,this.isCapacityBased=e[fieldNames.ServiceResource.IsCapacityBased],this.description=e[fieldNames.ServiceResource.Description]||"",this.isOptimizationCapable=e[fieldNames.ServiceResource.IsOptimizationCapable],this.relatedRecord=e[fieldNames.ServiceResource.RelatedRecord],this.relatedRecord__r=e[fieldNames.ServiceResource.RelatedRecord__r],this.resourceType=e[fieldNames.ServiceResource.ResourceType],this.ganttLabel=e[fieldNames.ServiceResource.GanttLabel__c],this.lastKnownLongitude=e[fieldNames.ServiceResource.LastKnownLongitude],this.lastKnownLocationDate=e[fieldNames.ServiceResource.LastKnownLocationDate],this.lastKnownLatitude=e[fieldNames.ServiceResource.LastKnownLatitude],this.serviceCrew=e[fieldNames.ServiceResource.ServiceCrew],this.serviceCrew__r=e[fieldNames.ServiceResource.ServiceCrew__r],this.relatedRecord__r&&(this.pictureLink=this.relatedRecord__r.SmallPhotoUrl),this.onlineOffset=e[fieldNames.ServiceResource.Online_Offset__c]||orgOnlineOffset,this.pictureLink&&this.pictureLink.endsWith("profilephoto/005/T")&&(this.pictureLink=null),e[fieldNames.ServiceResource.PictureLink]&&(this.pictureLink=e[fieldNames.ServiceResource.PictureLink]),this.skills={},(this.sobject=e)[fieldNames.ServiceResource.Skills]&&e[fieldNames.ServiceResource.Skills].forEach(function(e){t.skills[e[fieldNames.ServiceResourceSkill.Skill]]?(Array.isArray(t.skills[e[fieldNames.ServiceResourceSkill.Skill]])||(t.skills[e[fieldNames.ServiceResourceSkill.Skill]]=[t.skills[e[fieldNames.ServiceResourceSkill.Skill]]]),t.skills[e[fieldNames.ServiceResourceSkill.Skill]].push(new ServiceResourceSkill(e))):t.skills[e[fieldNames.ServiceResourceSkill.Skill]]=new ServiceResourceSkill(e)})}function ServiceResourceSkill(e){this.id=e.Id,this.name=e.SkillNumber,this.effectiveEndDate=window.isOptimizationViewer?e[fieldNames.ServiceResourceSkill.EffectiveEndDate]&&new Date(e[fieldNames.ServiceResourceSkill.EffectiveEndDate]).getTime():e[fieldNames.ServiceResourceSkill.EffectiveEndDate],this.effectiveStartDate=window.isOptimizationViewer?e[fieldNames.ServiceResourceSkill.EffectiveStartDate]&&new Date(e[fieldNames.ServiceResourceSkill.EffectiveEndDate]).getTime():e[fieldNames.ServiceResourceSkill.EffectiveStartDate],this.level=e[fieldNames.ServiceResourceSkill.SkillLevel],this.serviceResource=e[fieldNames.ServiceResourceSkill.ServiceResource],this.skill=e[fieldNames.ServiceResourceSkill.Skill];var e=void 0,t=void 0;this.effectiveStartDate&&(e=60*new Date(this.effectiveStartDate).getTimezoneOffset()*1e3),this.effectiveEndDate&&(t=60*new Date(this.effectiveEndDate).getTimezoneOffset()*1e3),this.effectiveStartDate=this.effectiveStartDate?new Date(this.effectiveStartDate+e):new Date(0),this.effectiveEndDate=this.effectiveEndDate?new Date(this.effectiveEndDate+t):new Date(864e11)}function ServiceTerritory(e){this.id=e.Id,this.name=e.Name,this.latitude=e[fieldNames.ServiceTerritory.Latitude],this.longitude=e[fieldNames.ServiceTerritory.Longitude],this.operatingHours=e[fieldNames.ServiceTerritory.OperatingHours],this.operatingHours__r=e[fieldNames.ServiceTerritory.OperatingHours__r],this.description=e[fieldNames.ServiceTerritory.Description],this.parentTerritory=e[fieldNames.ServiceTerritory.ParentTerritory__r]?e[fieldNames.ServiceTerritory.ParentTerritory]:void 0,this.isActive=e[fieldNames.ServiceTerritory.IsActive],e[fieldNames.ServiceTerritory.ParentTerritory__r]&&(this.parentTerritory=new ServiceTerritory(e[fieldNames.ServiceTerritory.ParentTerritory__r]))}function TerritoryOptimizationRequest(e){this.id=e.Id,this.optimizationRequest=e[fieldNames.TerritoryOptimizationRequest.OptimizationRequest]||null,this.serviceTerritory=e[fieldNames.TerritoryOptimizationRequest.ServiceTerritory]||null,this.serviceTerritoryName=null,this.serviceTerritory&&(this.serviceTerritoryName=e[fieldNames.TerritoryOptimizationRequest.ServiceTerritory.replace("__c","__r")].Name||null)}!function(){function e(n,o,c,d,a,i,s,r,t,e,l,u,m,p,h,g){function v(e){var t=e;void 0!==(t=y.iframeMapMode===S.IFRAME_TYPE.NORMAL?e.data:t).type&&(t.type.includes(f)?T:w)(t)}var f="[POLYGONS]",S={IFRAME_TYPE:{SECURED:"1",NORMAL:"2"},IFRAME_RECEIVED_MESSAGES_TYPES:{FSL_MAP_LOADED:"FSL_MAP_LOADED",FSL_MAP_INITIALIZATION:"FSL_MAP_INITIALIZATION",FSL_MAP_DATA_UPDATE:"FSL_MAP_DATA_UPDATE",VIEW_DETAILS:"VIEW_DETAILS",FLAG_SA:"FLAG_SA",API_REQUEST:"API_REQUEST",GET_ICON:"GET_ICON"},IFRAME_SEND_MESSAGES_TYPES:{API_REQUEST_SUCCEED:"API_REQUEST_SUCCEED",API_REQUEST_FAILED:"API_REQUEST_FAILED",FSL_MAP_INITIALIZATION:"FSL_MAP_INITIALIZATION",FSL_MAP_SERVICES_UPDATE:"FSL_MAP_SERVICES_UPDATE",SHOW_SERVICE_ON_MAP:"SHOW_SERVICE_ON_MAP",GET_ICON_SUCCEED:"GET_ICON_SUCCEED",GET_ICON_FAILED:"GET_ICON_FAILED",FSL_MAP_LIVE_POSITION:"FSL_MAP_LIVE_POSITION",FSL_MAP_UPDATE_FILTER:"FSL_MAP_UPDATE_FILTER",FSL_MAP_UPDATE_VIEW:"FSL_MAP_UPDATE_VIEW"},POLYGON_MENU_ACTIONS:{SCHEDULE:f+" SCHEDULE",UNSCHEDULE:f+" UNSCHEDULE",DISPATCH:f+" DISPATCH",IN_JEOPARDY:f+" IN_JEOPARDY",DELETE_POLYGON:f+" DELETE_POLYGON",CUSTOM_ACTION:f+" CUSTOM_ACTION"}},y={showServiceOnMapId:void 0,showServiceOnMap:!1,reactDomain:void 0,targetOrigin:void 0,reactMapInitialize:!1,iframeMapMode:window.iframeMapMode,debugMode:window.debugMode,iframeWindow:void 0,serviceFields:[],dynamicIcons:{}},b=(d.getLastKnownPositions(),e.fieldsSetFields().then(function(e){y.serviceFields=e.MapInfo}),setTimeout(function(){var e,t,i;y.iframeMapMode===S.IFRAME_TYPE.SECURED&&(y.debugMode?SfdcApp.iframe.addMessageHandler("GanttReactMapIframeDebug",v):SfdcApp.iframe.addMessageHandler("GanttReactMapIframe",v)),y.iframeMapMode===S.IFRAME_TYPE.NORMAL&&(y.targetOrigin=window.location.origin+window.location.pathname,y.iframeWindow=document.getElementById("GanttReactMapIframeSF").contentWindow,e=window,t="message",i=v,e.addEventListener?e.addEventListener(t,i):e.attachEvent&&e.attachEvent("on"+t,i))},0),function(e){y.iframeMapMode===S.IFRAME_TYPE.SECURED&&(y.debugMode?SfdcApp.iframe.sendMessage("GanttReactMapIframeDebug",e):SfdcApp.iframe.sendMessage("GanttReactMapIframe",e)),y.iframeMapMode===S.IFRAME_TYPE.NORMAL&&y.iframeWindow.postMessage(e,y.targetOrigin)}),w=function(t){switch(t.type){case S.IFRAME_RECEIVED_MESSAGES_TYPES.FSL_MAP_LOADED:break;case S.IFRAME_RECEIVED_MESSAGES_TYPES.FSL_MAP_INITIALIZATION:y.reactMapInitialize=!0,M(),F(),P();break;case S.IFRAME_RECEIVED_MESSAGES_TYPES.FSL_MAP_DATA_UPDATE:y.showServiceOnMap&&y.showServiceOnMapId&&setTimeout(function(){var e={serviceId:y.showServiceOnMapId,type:S.IFRAME_SEND_MESSAGES_TYPES.SHOW_SERVICE_ON_MAP};b(e),y.showServiceOnMap=!1,y.showServiceOnMapId=void 0},7e3);break;case S.IFRAME_RECEIVED_MESSAGES_TYPES.VIEW_DETAILS:H(t.id,t.objectType);break;case S.IFRAME_RECEIVED_MESSAGES_TYPES.FLAG_SA:V(t.serviceAppointmentsId);break;case S.IFRAME_RECEIVED_MESSAGES_TYPES.API_REQUEST:$(t.method,t.filter,t.params).then(function(e){"getCustomActions"===t.method?L(e).then(function(e){e={response:e,feature:t.feature,type:S.IFRAME_SEND_MESSAGES_TYPES.API_REQUEST_SUCCEED};b(e)}).catch(function(e){console.warn(e)}):"getReportRowsForMap"===t.method?I(e).then(function(e){e={response:e,feature:t.feature,type:S.IFRAME_SEND_MESSAGES_TYPES.API_REQUEST_SUCCEED};b(e)}):"getReportsWithGeolocationCols"===t.method?A(e).then(function(e){e={response:e,feature:t.feature,type:S.IFRAME_SEND_MESSAGES_TYPES.API_REQUEST_SUCCEED};b(e)}):"getMapReports"===t.method?N(e).then(function(e){e={response:e,feature:t.feature,type:S.IFRAME_SEND_MESSAGES_TYPES.API_REQUEST_SUCCEED};b(e)}):(e={response:e,feature:t.feature,type:S.IFRAME_SEND_MESSAGES_TYPES.API_REQUEST_SUCCEED},b(e))}).catch(function(e){e={response:e,feature:t.feature,type:S.IFRAME_SEND_MESSAGES_TYPES.API_REQUEST_FAILED};b(e)});break;case S.IFRAME_RECEIVED_MESSAGES_TYPES.GET_ICON:D(t.hex,t.folder,t.icon,t.iconKey).then(function(e){e={response:e,iconKey:t.iconKey,type:S.IFRAME_SEND_MESSAGES_TYPES.GET_ICON_SUCCEED};b(e)}).catch(function(e){e={response:e,iconKey:t.iconKey,type:S.IFRAME_SEND_MESSAGES_TYPES.GET_ICON_FAILED};b(e)})}},T=function(e){switch(e.type){case S.POLYGON_MENU_ACTIONS.CUSTOM_ACTION:B(e.servicesIds,e.action);break;case S.POLYGON_MENU_ACTIONS.DISPATCH:i.changeStatus(e.servicesIds,h.DISPATCHED).then(function(e){i.drawServicesAndAbsences(e.services)}).catch(function(e){a.addNotification(window.customLabels.Action_Could_Not_Be_Performed,e.message||window.customLabels.user_is_not_allowed_to_perform_action)});break;case S.POLYGON_MENU_ACTIONS.UNSCHEDULE:i.unscheduleServices(e.servicesIds);break;case S.POLYGON_MENU_ACTIONS.SCHEDULE:t.schedule(e.servicesIds);break;case S.POLYGON_MENU_ACTIONS.IN_JEOPARDY:i.setInJeopardy(e.servicesIds)}},L=function(e){for(var t=o.defer(),i={},n=0;n<e.length;n++)a.hasCustomPermission(e[n][window.GanttMap.fieldNames.CustomGanttAction.Permission])&&"map"===e[n][window.GanttMap.fieldNames.CustomGanttAction.Section]&&(i[e[n].Id]=function(e){var t=o.defer();try{var i={};i.id=e.Id,i.name=e[window.GanttMap.fieldNames.CustomGanttAction.Label],i.className=e[window.GanttMap.fieldNames.CustomGanttAction.Class],i.order=e[window.GanttMap.fieldNames.CustomGanttAction.Order],i.permission=e[window.GanttMap.fieldNames.CustomGanttAction.Permission],i.section=e[window.GanttMap.fieldNames.CustomGanttAction.Section],i.visualforce=e[window.GanttMap.fieldNames.CustomGanttAction.Visualforce],e[window.GanttMap.fieldNames.CustomGanttAction.Icon]&&C(k(e[window.GanttMap.fieldNames.CustomGanttAction.Icon].split(","))).then(function(e){e=e.replace(/^.+base64,/,"").replace(/\"?\)$/,""),e=window.atob(e).replace(/fill="#[A-Za-z0-9]+"/,'fill="#17325c"'),e=window.btoa(e);i.icon="url('data:image/svg+xml;base64,"+e+"')",t.resolve(i)})}catch(e){t.reject(e)}return t.promise}(e[n]));return o.all(i).then(function(e){t.resolve(e)}).catch(function(e){console.warn(e.message),t.reject()}),t.promise},A=function(n){var e=a.butlerNotifications();if(0===Object.keys(n[0].report).length&&"error"===n[0].color)return 1<=e.filter(function(e){return e.title===window.customLabels.Report_Object_Access_Deny}).length?void 0:void a.addNotification(window.customLabels.Report_Object_Access_Deny,window.customLabels.Report_Object_Access_Error_Message,function(){});var s=o.defer(),t=[];try{for(var i,r=0;r<n.length;r++)n[r].icon&&(i=n[r].icon.split(","),t.push(D("#ffffff",i[0],i[1],"report_"+i[0]+"_"+i[1])))}catch(e){console.warn("failed to add icon to report based on configuration"),s.reject(e)}return o.all(t).then(function(e){for(var t=0,i=0;i<n.length;i++)n[i].icon&&(n[i].icon=e[t],t++);s.resolve(n)}).catch(function(e){s.resolve(reportRows)}),s.promise},N=function(e){for(var t=o.defer(),i=Object.keys(e),n={},s=0;s<i.length;s++)n[i[s]]=I(e[i[s]]);return o.all(n).then(function(e){t.resolve(e)}),t.promise},I=function(i){for(var n=o.defer(),e=[],t=0;t<i.length;t++){var s=i[t],r=s.sObjectType.split(/(?=[A-Z])/).join("_").toLowerCase();"ServiceAppointment"===s.sObjectType&&(r="work_order"),"ServiceResource"===s.sObjectType&&(r="home"),"Asset"===s.sObjectType&&(r="product"),e.push(D("#ffffff","standard",r,"report_"+r))}return o.all(e).then(function(e){for(var t=0;t<i.length;t++)i[t].reportIcon=e[t];n.resolve(i)}).catch(function(e){n.resolve(i)}),n.promise};function C(e){var t=o.defer(),i=new XMLHttpRequest;return i.onload=function(){var e;404==i.status?t.reject():((e=new FileReader).onloadend=function(){t.resolve(e.result)},e.readAsDataURL(i.response))},i.open("GET",e),i.responseType="blob",i.send(),t.promise}function k(e){var e=_slicedToArray(e,2),t=e[0],e=e[1];return window.GanttMap.icons.globalIcon+"/"+t+"/"+e+".svg"}function D(t,i,e,n){var s=o.defer();try{y.dynamicIcons[n]?s.resolve(y.dynamicIcons[n]):C(k([i,e])).then(function(e){e=e.replace(/^.+base64,/,"").replace(/\"?\)$/,""),e=window.atob(e).replace(/fill="#[A-Za-z0-9]+"/,'fill="'+t+'"'),e=window.btoa(e);y.dynamicIcons[n]="data:image/svg+xml;charset=utf-8;base64,"+e,s.resolve(y.dynamicIcons[n])}).catch(function(e){C(k([i,"report"])).then(function(e){e=e.replace(/^.+base64,/,"").replace(/\"?\)$/,""),e=window.atob(e).replace(/fill="#[A-Za-z0-9]+"/,'fill="'+t+'"'),e=window.btoa(e);y.dynamicIcons[n]="data:image/svg+xml;charset=utf-8;base64,"+e,s.resolve(y.dynamicIcons[n])})})}catch(e){s.reject(e.message)}return s.promise}function R(e){var t;!e&&y.reactMapInitialize||(e=j(),t=E(),t={ganttMapDefinitions:window.GanttMap,livePositions:t,territories:e,type:S.IFRAME_SEND_MESSAGES_TYPES.FSL_MAP_INITIALIZATION,ganttDate:scheduler._min_date},b(t))}function O(e,t){var i,n=2<arguments.length&&void 0!==arguments[2]&&arguments[2];y.reactMapInitialize?_.isEmpty(e)&&_.isEmpty(t)||(i={clearServices:!1,services:G(e),deletedServicesIds:t,type:S.IFRAME_SEND_MESSAGES_TYPES.FSL_MAP_SERVICES_UPDATE},b(i)):setTimeout(function(){O(e,t,n)},5e3)}function G(e){var t={};if(Array.isArray(e))for(var i=0;i<e.length;i++)t[e[i].id]=x(e[i]);else for(var n in e)t[e[n].id]=x(e[n]);return t}var $=function(s,r){for(var e=arguments.length,o=Array(2<e?e-2:0),t=2;t<e;t++)o[t-2]=arguments[t];var i={},a=(i[RemoteActions.getReportsWithGeolocationCols]=!0,!(s in i));return new Promise(function(i,n){var e=(e=[RemoteActions[s]]).concat.apply(e,o).concat(function(e,t){t.status?i(e):n(t)}).concat({buffer:a,escape:!1}),t=e,t=r?e.filter(function(e){return!!e}):e.map(function(e){return void 0===e?null:e});Visualforce.remoting.Manager.invokeAction.apply(Visualforce.remoting.Manager,t)})},B=function(e,t){var i,n;t.visualforce?(i=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),n=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear(),1===e.length?l.open(t.name,t.visualforce+"?id="+e[0]+"&start="+i+"&end="+n):l.open(t.name,t.visualforce+"?services="+e.join(",")+"&start="+i+"&end="+n)):p.callRemoteAction(RemoteActions.runCustomServiceAction,t.className,e,scheduler._min_date,scheduler._max_date).then(function(e){e&&a.addNotification(t.name,e,null,null)}).catch(function(e){return a.addNotification(t.name,e.message,null,null)})},H=function(e,t){switch(t){case"service":i.recentlyUsed[e]=!0,s.open(e);break;case"liveposition":case"resource":r.open(e);break;default:a.openSObjectLink(e)}},V=function(e){e.map(function(e){i.flagged[e]=!0,scheduler.updateEvent(e)})},F=function(){var e;y.reactMapInitialize?(e={filteredServices:U(),type:S.IFRAME_SEND_MESSAGES_TYPES.FSL_MAP_UPDATE_FILTER},b(e)):setTimeout(function(){R(!1)},5e3)},M=function e(){var t;y.reactMapInitialize?(t={relevantStms:z(),type:S.IFRAME_SEND_MESSAGES_TYPES.FSL_MAP_UPDATE_VIEW},b(t)):setTimeout(function(){e()},5e3)},P=function e(){var t;y.reactMapInitialize?(t={livePositions:E(),type:S.IFRAME_SEND_MESSAGES_TYPES.FSL_MAP_LIVE_POSITION},b(t)):setTimeout(function(){e(servicesToUpdate,deletedServicesIds,clearServices)},5e3)},e=(g.register("positions",function(e){P()}),_.debounce(F,300,{maxWait:1e3})),g=_.debounce(M,300,{maxWait:1e3}),U=function(){for(var e={},t=0;t<i.filteredServices.servicesArray.length;t++)e[i.filteredServices.servicesArray[t].id]=!0;return e},x=function(e){var t={fields:{}};t.latitude=e.latitude,t.longitude=e.longitude,t.pinned=e.pinned,t.statusCategory=e.statusCategory,t.resourceId=e.resourceId,t.id=e.id,t.Status=e.Status,t.AppointmentNumber=e.AppointmentNumber,t.dragData=e.isScheduled()?null:a.getRelevantDataForDraggingService(e),window.__gantt.ignoreReadonlyGantt226||window.customPermissions.Enable_Drag_And_Drop||(t.dragData=null),t.icons=e.icons,window.paletteViewActive&&e.ganttPaletteColor?t.color=e.ganttPaletteColor.color:e.ganttColor?t.color=e.ganttColor:t.color=a.getColorHexByCategory(e.statusCategory);for(var i=0;i<y.serviceFields.length;i++){var n,s,r=void 0;void 0!==e.fields[y.serviceFields[i].APIName]&&(n=e.fields[y.serviceFields[i].APIName],s=e.fields[y.serviceFields[i].FullAPIName],r=y.serviceFields[i].APIName!==y.serviceFields[i].FullAPIName?{Value:n,Id:s}:{Value:n}),t.fields[y.serviceFields[i].APIName]=r}return t},z=function(){var e,t=scheduler.getState().min_date,i=scheduler.getState().max_date,n={},s=c.resourcesByPrimariesAndRelocations();for(e in s){var r,o=s[e];for(r in o){var a=o[r];isIntersect(t,i,a.effectiveStartDate,a.effectiveEndDate)&&(n[a.id]=a)}}return n},E=function(){var e,t=scheduler.getState().min_date,i=scheduler.getState().max_date,n=c.resourcesAndTerritories(),s={},r={};for(e in s=window.customPermissions.Hide_Live_Locations_Gantt_Map_Layer||isLastKnownFieldsNotAllowed?s:d.lastKnownPositions()){var o,a=n[e];for(o in a){var l=a[o];isIntersect(t,i,l.effectiveStartDate,l.effectiveEndDate)&&(r[s[e].id]={latitude:s[e].latitude,longitude:s[e].longitude,resource:l.serviceResource__r,lastKnowLocation:s[e]})}}return r},j=function(){var t=m.GetUserSettingsProperty("locations"),i=u.territories();return Object.keys(i).filter(function(e){return t.includes(e)}).reduce(function(e,t){return e[t]=i[t],e},{})};return{showServiceOnMap:function(e,t,i){y.showServiceOnMap=!0,y.showServiceOnMapId=e,"map"===i||t||n.$broadcast("changeWorkingState","map"),y.reactMapInitialize?setTimeout(function(){var e={serviceId:y.showServiceOnMapId,type:S.IFRAME_SEND_MESSAGES_TYPES.SHOW_SERVICE_ON_MAP};b(e),y.showServiceOnMap=!1,y.showServiceOnMapId=void 0},150):R(!1)},initializeGanttMap:R,updateGanttMapServices:O,updateGanttMapFilter:e,updateGanttMapView:g,IFRAME_SEND_MESSAGES_TYPES:S.IFRAME_SEND_MESSAGES_TYPES,reactDomain:y.reactDomain}}e.$inject=["$rootScope","$q","TimePhasedDataService","LastKnownPositionService","utils","servicesService","ServiceAppointmentLightboxService","ResourceLightboxService","bulkScheduleService","FieldSetFieldsService","GeneralLightbox","ResourcesAndTerritoriesService","userSettingsManager","sfdcService","SERVICE_STATUS","RegisterService"],angular.module("serviceExpert").factory("MapService",e)}(),!function(){function e(s,r,o,a,l,e,c,d){for(var u=null,t=[],i=0;i<60;i++)t.push(i);function m(){l.setLightBoxStatus(!1),u.$destroy()}function p(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(u.actionFinish),navigation:!0,handler:function(e,t){e=new Date(e);e.setMinutes(parseInt(u.endMinutes)),e.setHours(parseInt(u.endHour)),e<u.actionStart?alert(customLabels.finishAfterStart):u.actionFinish=e,scheduler.destroyCalendar(),u.$apply()}})}function h(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(u.actionStart),navigation:!0,handler:function(e,t){e=new Date(e);e.setMinutes(parseInt(u.startMinutes)),e.setHours(parseInt(u.startHour)),e>u.actionFinish?alert(customLabels.startBeforeEnd):u.actionStart=e,scheduler.destroyCalendar(),u.$apply()}})}function g(){var e=new Date(u.actionStart);e.setMinutes(parseInt(u.startMinutes)),e.setHours(parseInt(u.startHour)),e>=u.actionFinish?(alert(customLabels.startBeforeEnd),u.startMinutes=u.actionStart.getMinutes(),u.startHour=u.actionStart.getHours().toString()):u.actionStart=e}function v(){var e=new Date(u.actionFinish);e.setMinutes(parseInt(u.endMinutes)),e.setHours(parseInt(u.endHour)),e<=u.actionStart?(alert(customLabels.finishAfterStart),u.endMinutes=u.actionFinish.getMinutes().toString(),u.endHour=u.actionFinish.getHours().toString()):u.actionFinish=e}function f(){var e,t,i,n,s=[],r=void 0;for(n in u.selectedLocations)u.selectedLocations[n]&&s.push(n);0===s.length?alert(customLabels.noLocationWasSelected):(e=u.actionStart,(r=u.actionFinish).setDate(r.getDate()+1),t="noFilter"===u.optimizeSelectedFilter?null:u.optimizeSelectedFilter,i="all"===u.optimizeAllServices,l.setBulkActionRunning(),d.callRemoteAction(RemoteActions.runOptimization,e,r,s,i,u.orphanServices,u.selectedPolicy.Id,t).then(function(e){e?d.callRemoteAction(RemoteActions.getRequestObject,e).then(function(e){e[fieldNames.Optimization_Request.Status__c]!=customLabels.failed?c.addNotification(customLabels.Optimization_Request_Sent,customLabels.Optimization_sent_details,function(e){c.openSObjectLink("../"+e)},e.Id):c.addNotification(customLabels.Optimization_Failed,customLabels.error_in_opt,function(e){c.openSObjectLink("../"+e)},e.Id)}):c.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.user_is_not_allowed_to_perform_action)}).catch(function(e){console.warn("runOptimization failed :("),console.log(e),c.addNotification(customLabels.Optimization_Failed,e.message)}).finally(function(){l.setBulkActionRunning(!1)}),u.closeLightbox())}function S(){return u.selectedPolicy[fieldNames.SchedulingPolicy.DailyOptimization]}return{open:function(){(u=r.$new(!0)).$on("keypress",function(e,t){27==t.which&&u.$evalAsync(u.closeLightbox)});var e=a.GetUserSettingsProperty("locations");u.filteredLocations=e.map(function(e){return o.territories()[e]}),u.actionStart=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),u.actionFinish=new Date(scheduler.getState().max_date.getFullYear(),scheduler.getState().max_date.getMonth(),scheduler.getState().max_date.getDate(),0,0,0),u.startHour="0",u.endHour="0",u.startMinutes="0",u.endMinutes="0",u.dateSelectFinishWidget=p,u.dateSelectStartWidget=h,u.validateDatesStart=g,u.validateDatesEnd=v,u.optimizeAllServices="all",u.runOptimizion=f,u.selectedLocations={},u.checkBoxFields=c.checkBoxFields,u.optimizeSelectedFilter="noFilter",u.orphanServices=!1,u.isInDayPolicy=S,u.policyOptions=l.policies,u.selectedPolicy=u.policyOptions[0];for(var t=0;t<l.policies.length;t++)if(l.policies[t].Id===l.selectedPolicyId){u.selectedPolicy=l.policies[t];break}e=customLabels.starting_from_x_until_y_including_z_services.replace("$0",'<u id="bulkStartOptimize" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartOptimize\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>').replace("$1",'<u id="bulkFinishOptimize" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishOptimize\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>').replace("$2",'<select class="bulkStatusWidth RightArrowForSelect" ng-model="optimizeAllServices">\n\t\t\t\t\t\t\t\t<option value="all">'+customLabels.All+'</option>\n\t\t\t\t\t\t\t\t<option value="unscheduled">'+customLabels.UnscheduledCapital+"</option>\n\t\t\t\t\t\t\t</select>"),i='<div id="PolicyInOptimize">'+customLabels.Use_the_following_policy_x_and_y.replace("$0",'<select class="bulkStatusWidth RightArrowForSelect" ng-model="selectedPolicy" title="{{selectedPolicy.Name}}" ng-change="changePolicy()" ng-options="policy.Name for policy in policyOptions"></select>').replace("$1",'<select ng-model="optimizeSelectedFilter" class="bulkStatusWidth RightArrowForSelect">\n\t\t\t\t\t\t\t\t \t<option ng-repeat="(fieldName, fieldLbl) in checkBoxFields()" value="{{fieldName}}" ng-bind="fieldLbl"></option>\n\t\t\t\t\t\t\t\t \t<option value="noFilter">'+customLabels.None+"</option>\n\t\t\t\t\t\t\t\t </select>")+"</div>";var i,n=angular.element('\n                <div class="LightboxBlackContainer">\n                    <div id="BulkActionsLightbox" class="LightboxContainer OptimizationLightbox">\n\n                        <div class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                            <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox" fsl-key-press tabindex="0">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            <h1 class="light-box-header">'+customLabels.Optimize+'</h1>\n                        </div>\n\n\n                        <div class="lightboxContentContainer">\n\n                            <p class="bulkExplain">'+customLabels.SelectServicesOptimize+'</p>\n\n                            <div class="selectedTargetLocations">\n                                <label for="bulkRadioSelectedIds">'+customLabels.ChooseLocationsLB+'</label>\n                            </div>\n\n\n                            <div id="bulkLocationNames">\n                                <div ng-repeat="location in filteredLocations track by $index" class="BulkActionLocationName">\n                                    <input ng-model="selectedLocations[location.id]" type="checkbox" id="bulkLocationUnschedule_{{ location.id }}"/>\n                                    <label title="{{ location.name }}" for="bulkLocationUnschedule_{{ location.id }}">{{location.name}}</label>\n                                </div>\n\n                                <div>\n                                    <input ng-model="orphanServices" type="checkbox" name="orphanLocationsOptimize" id="orphanLocationsOptimize" />\n                                    <label for="orphanLocationsOptimize">'+customLabels.IncludeServicesNoLocations+'</label>\n                                </div>\n                            </div>\n\n\n                            <div class="bulkOptimizeOptions">\n                                '+e+"\n                                "+i+'\n                                <div class="inday-policy-selected" ng-show="isInDayPolicy()">'+customLabels.In_Day_Policy_Selected+'</div>\n                            </div>\n\n                        </div>\n\n                        <div class="lightboxControllers">\n                            <button class="lightboxSaveButton" ng-click="runOptimizion()">'+customLabels.Optimize+"</button>\n                        </div>\n\n\n                    </div>\n                </div>\n            ");n.find("#BulkActionsLightbox").draggable({containment:"document",handle:"#UnschduleLightboxHeader"}),angular.element("body").append(n),u.closeLightbox=m,u.$on("$destroy",function(){return n.remove()}),s(n)(u),n.show(),l.setLightBoxStatus(),n.children().find("input[type=checkbox]").focus()}}}e.$inject=["$compile","$rootScope","ResourcesAndTerritoriesService","userSettingsManager","StateService","servicesService","utils","sfdcService"],angular.module("serviceExpert").factory("optimizeLightboxService",e)}(),!function(){function e(r,o,a,e,l,t,c,d){var u=null;function m(){l.setLightBoxStatus(!1),u.$destroy()}function p(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(u.actionFinish),navigation:!0,handler:function(e,t){e=new Date(e);e.setMinutes(parseInt(u.endMinutes)),e.setHours(parseInt(u.endHour)),e<u.actionStart?alert(customLabels.finishAfterStart):u.actionFinish=e,scheduler.destroyCalendar(),u.$apply()}})}function h(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(u.actionStart),navigation:!0,handler:function(e,t){e=new Date(e);e.setMinutes(parseInt(u.startMinutes)),e.setHours(parseInt(u.startHour)),e>u.actionFinish?alert(customLabels.startBeforeEnd):u.actionStart=e,scheduler.destroyCalendar(),u.$apply()}})}function g(){var e=new Date(u.actionStart);e.setMinutes(parseInt(u.startMinutes)),e.setHours(parseInt(u.startHour)),e>=u.actionFinish?(alert(customLabels.startBeforeEnd),u.startMinutes=u.actionStart.getMinutes(),u.startHour=u.actionStart.getHours().toString()):u.actionStart=e}function v(){var e=new Date(u.actionFinish);e.setMinutes(parseInt(u.endMinutes)),e.setHours(parseInt(u.endHour)),e<=u.actionStart?(alert(customLabels.finishAfterStart),u.endMinutes=u.actionFinish.getMinutes().toString(),u.endHour=u.actionFinish.getHours().toString()):u.actionFinish=e}function f(){var e,t,i,n,s=void 0,r=u.actionStart;(s=u.actionFinish).setDate(s.getDate()+1),t=u.optimizeSelectedFilter,e=u.optimizeCalloutSelectedFilter,i=!u.optimizeOnlyUnscheduledServices,n={optimizeOnlyUnscheduledServices:u.optimizeOnlyUnscheduledServices,scheduleOnlyResourceFutureJobs:u.scheduleOnlyResourceFutureJobs,selectedPolicy:u.selectedPolicy,optimizeSelectedFilter:u.optimizeSelectedFilter,optimizeCalloutSelectedFilter:u.optimizeCalloutSelectedFilter},localStorage.setItem(sfdcUser+"_RSO",JSON.stringify(n)),l.setBulkActionRunning(),d.callRemoteAction(RemoteActions.runRDOptimization,u.resource.id,r,s,i,u.scheduleOnlyResourceFutureJobs,u.selectedPolicy.Id,t,e).then(function(e){e?d.callRemoteAction(RemoteActions.getRequestObject,e).then(function(e){e[fieldNames.Optimization_Request.Status__c]!=customLabels.failed?c.addNotification(customLabels.Optimization_Request_Sent,customLabels.Optimization_sent_details,function(e){c.openSObjectLink("../"+e)},e.Id):c.addNotification(customLabels.Optimization_Failed,customLabels.error_in_opt,function(e){c.openSObjectLink("../"+e)},e.Id)}):c.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.user_is_not_allowed_to_perform_action)}).catch(function(e){console.warn("runOptimization failed :("),console.log(e),c.addNotification(customLabels.Optimization_Failed,e.message)}).finally(function(){l.setBulkActionRunning(!1)}),u.closeLightbox()}return{open:function(e){(u=o.$new(!0)).$on("keypress",function(e,t){27==t.which&&u.$evalAsync(u.closeLightbox)}),u.resource=a.getResources()[e];var e=JSON.parse(localStorage.getItem(sfdcUser+"_RSO"))||{},t=l.selectedPolicyId;e.selectedPolicy&&(t=e.selectedPolicy.Id),u.actionStart=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),u.actionFinish=new Date(scheduler.getState().max_date.getFullYear(),scheduler.getState().max_date.getMonth(),scheduler.getState().max_date.getDate(),0,0,0),u.startHour="0",u.endHour="0",u.startMinutes="0",u.endMinutes="0",u.dateSelectFinishWidget=p,u.dateSelectStartWidget=h,u.validateDatesStart=g,u.validateDatesEnd=v,"all"===e.optimizeAllServices?e.optimizeOnlyUnscheduledServices=!1:"unscheduled"===e.optimizeAllServices&&(e.optimizeOnlyUnscheduledServices=!0),u.optimizeOnlyUnscheduledServices=e.optimizeOnlyUnscheduledServices||!1,u.runOptimizion=f,u.checkBoxFields=c.checkBoxFields(),u.optimizeSelectedFilter=e.optimizeSelectedFilter||Object.keys(u.checkBoxFields)[0],u.optimizeCalloutSelectedFilter=e.optimizeCalloutSelectedFilter||Object.keys(u.checkBoxFields)[0],u.scheduleOnlyResourceFutureJobs=null==e.scheduleOnlyResourceFutureJobs||e.scheduleOnlyResourceFutureJobs,u.policyOptions=l.policies;for(var i=0;i<l.policies.length;i++)if(l.policies[i].Id===t){u.selectedPolicy=l.policies[i];break}e='<div id="ResourceToOptimize">'+customLabels.OptimizeTheFollowingResourceDay.replace("$0",'<span class="rdoResourceName">{{resource.name}}</span>').replace("$1",'<button id="bulkStartOptimize" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartOptimize\')" ng-bind="actionStart | amDateFormat:\'ll\'"></button>').replace("$2",'<button id="bulkFinishOptimize" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishOptimize\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></button>')+"</div>",n=customLabels.OptimizeOnlySAsAssignedTo.replace("$0",'<span class="rdoResourceName" ng-class="{disabledonlyAssignTo: !scheduleOnlyResourceFutureJobs}">{{resource.name}}</span>');var n,s=angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer rso-lb" id="BulkActionsLightbox">\n\n                        <div class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                            <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            <h1 class="light-box-header">'+customLabels.RDOptimize+'</h1>\n                        </div>\n\n\n                        <div class="lightboxContentContainer">\n\n                            <div class="bulkOptimizeOptions">\n                                '+e+'\n                            </div>\n   \n                            <div class="bulkOptimizeOptionsContainer">\n                                <div class="bulkOptimizeOptions">\n                                    <div class="settingLabel">\n                                        '+customLabels.Only_optimize_unscheduled_appointments+"\n                                        <cs-tooltip>"+customLabels.Only_optimize_unscheduled_appointments_tooltip+'</cs-tooltip>\n                                    </div>\n\n                                    <div class="optimizationOptionValue">\n                                        <input ng-model="optimizeOnlyUnscheduledServices" type="checkbox" name="optimizeAllServices" id="optimizeAllServices" />\n                                    </div>\n                                </div>\n\n                                <div class="bulkOptimizeOptions">\n                                    <div class="settingLabel">\n                                        '+customLabels.SchedulingPolicyName+"\n                                        <cs-tooltip>"+customLabels.rso_scheduling_policy_tooltip+'</cs-tooltip>\n\n                                    </div>\n\n                                    <div class="optimizationOptionValue">\n                                        <select class="bulkStatusWidth RightArrowForSelect" ng-model="selectedPolicy" ng-change="changePolicy()" ng-options="policy.Name for policy in policyOptions">\n                                        </select>\n                                    </div>\n                                </div>\n\n                                <div class="bulkOptimizeOptions">\n                                    <div class="settingLabel">\n                                        '+customLabels.OptimizeFilterText+"\n                                        <cs-tooltip>"+customLabels.rso_filter_services_by_tooltip+'</cs-tooltip>\n\n                                    </div>\n\n                                    <div class="optimizationOptionValue">\n                                        <select ng-model="optimizeSelectedFilter" class="bulkStatusWidth RightArrowForSelect">\n                                            <option ng-repeat="(fieldName, fieldLbl) in checkBoxFields" value="{{fieldName}}" ng-bind="fieldLbl"></option>\n                                        </select>\n                                    </div>\n                                </div>\n\n                                <div class="bulkOptimizeOptions">\n                                    <div class="settingLabel">\n                                        '+customLabels.OptimizeKeepTheFollowingSAsScheduled+"\n                                        <cs-tooltip>"+customLabels.OptimizeKeepTheFollowingSAsScheduled_tooltip+'</cs-tooltip>\n                                    </div>\n\n                                    <div class="optimizationOptionValue">\n                                        <select ng-model="optimizeCalloutSelectedFilter" class="bulkStatusWidth RightArrowForSelect">\n                                            <option ng-repeat="(fieldName, fieldLbl) in checkBoxFields" value="{{fieldName}}" ng-bind="fieldLbl"></option>\n                                         </select>\n                                    </div>\n                                </div>\n\n                                <div class="bulkOptimizeOptions">\n                                    <div class="settingLabel" ng-class="{disabledonlyAssignTo: !scheduleOnlyResourceFutureJobs}">\n                                        '+n+"\n                                        <cs-tooltip>"+customLabels.OptimizeOnlySAsAssignedTo_tooltip+'</cs-tooltip>\n                                    </div>\n\n                                    <div class="optimizationOptionValue">\n                                        <input ng-model="scheduleOnlyResourceFutureJobs" type="checkbox" name="scheduleOnlyResourceFutureSa" id="scheduleOnlyResourceFutureSa" />\n                                    </div>\n                                </div>\n\n                            </div>\n\n                        </div>\n\n                        <div class="lightboxControllers">\n                            <button class="lightboxSaveButton" ng-click="runOptimizion()">'+customLabels.Optimize+"</button>\n                        </div>\n\n\n                    </div>\n                </div>\n            ");s.find("#BulkActionsLightbox").draggable({containment:"document",handle:"#UnschduleLightboxHeader"}),angular.element("body").append(s),u.closeLightbox=m,u.$on("$destroy",function(){return s.remove()}),r(s)(u),s.show(),l.setLightBoxStatus()}}}e.$inject=["$compile","$rootScope","ResourcesAndTerritoriesService","userSettingsManager","StateService","servicesService","utils","sfdcService"],angular.module("serviceExpert").factory("rdOptimizeLightboxService",e)}(),!function(){function e(i,n){return{register:function(e,t){i.register(e,t),n.register(e,t)},unRegister:function(e,t){i.unRegister(e,t),n.unRegister(e,t)}}}e.$inject=["DeltaService","StreamingAPIService"],angular.module("serviceExpert").factory("RegisterService",e)}(),angular.module("serviceExpert").factory("ResourceCapacitiesService",["ResourcesAndTerritoriesService","TimePhasedDataService","$rootScope","utils","StateService",function(c,d,e,u,m){var p={};return e.$on("gotNewTimePhasedObjects",function(e,t){if(m.areContractorsSupported()&&t.resourcesAndTerritories&&Object.keys(t.resourcesAndTerritories).length)for(var i=t.start,n=t.finish,s=new Date(i),r=null;s<n;){var o=u.formatDayToString(s);if(!p[o]){p[o]=!0,r=r||function(){for(var e=[],t=d.resourcesAndTerritories(),i=c.getCapacityBasedResources(),n=0;n<=i.length;n++){var s,r=i[n],o=t[r];for(s in o){var a=o[s];e.push(u.generateResourceId(r,a.serviceTerritory))}}return e}();var a=new Date(s);a.setDate(a.getDate()+1);for(var l=0;l<=r.length;l++)!function(e,t,i){if(e.getTime()!==t.getTime()){var n,s={};for(n in scheduler.matrix)s[n]=[i];scheduler.addMarkedTimespan({start_date:e,end_date:t,sections:s,css:"capacityPattern"})}}(new Date(s),new Date(a),r[l])}s.setDate(s.getDate()+1)}}),{reset:function(){p={}}}}]),angular.module("serviceExpert").factory("ResourceCrewsService",["ResourcesAndTerritoriesService","TimePhasedDataService","$rootScope","utils","StateService",function(e,d,t,M,u){var m={};function P(e,t,i,n,s,r){var o=i.territoriesByType[s];if(void 0!==o&&(showSecondarySTMs||"R"===s))for(var a=0;a<o.length;a++){var l,c,d=o[a],u=useLocationTimezone?d.operatingHours.TimeZone:userTimeZone,m=useLocationTimezone?(l=E(d.start,d.operatingHours.TimeZone,u),E(d.finish,d.operatingHours.TimeZone,u)):(l=d.start,d.finish),m=M.intersectDates({start:l,finish:m},{start:e,finish:t}).intersection;null!==m&&(c=E(i.member.startDate,"GMT",u),u=E(i.member.endDate,"GMT",u),null!==(m=M.intersectDates({start:m.start,finish:m.finish},{start:c,finish:u}).intersection)&&x(m.start,m.finish,d.sectionsToDraw,"crewMember",n,"crewLabelStyle",r))}}function x(e,t,i,n,s,r,o){o="background: "+(o=o||"#a99be8")+"90; box-shadow: 0 0 0 1px "+o;scheduler.addMarkedTimespan({start_date:e,end_date:t,sections:i.daily,css:n,html:'<div class="'+r+'" title="'+escapeHTML(s)+'" style="'+o+'">\n                            <svg aria-hidden="true" class="slds-icon relocationIcon">\n                                <use xlink:href='+lsdIcons.crewMember+'"></use>\n                            </svg>\n                            '+escapeHTML(s)+"\n                          </div>"}),scheduler.addMarkedTimespan({start_date:e,end_date:t,sections:i.monthly,html:'<div class="crewUtilizBox" title="'+escapeHTML(s)+'" style="'+o+'">\n                    <svg aria-hidden="true" class="slds-icon relocationIcon">\n                    <use xlink:href="'+lsdIcons.crewMember+'"></use>\n                    </svg></div>',css:"crewmember_monthly"})}function E(e,t,i){return M.convertDateBetweenTimeZones(e,t,i)}return t.$on("gotNewTimePhasedObjects",function(e,t){if(u.areCrewsSupported()&&t.serviceCrewMembers&&Object.keys(t.serviceCrewMembers).length)for(var i=t.start,n=t.finish,s=t,r=new Date(i),o=void 0;r<n;){var a=M.formatDayToString(r);if(!m[a]){void 0===o&&(o=function(e){var t,i={},n=d.resourcesAndTerritories();for(t in e){void 0===i[t]&&(i[t]={},i[t].territoriesByType={},i[t].member=e[t]);var s,r=n[e[t].serviceResource];for(s in r){var o=r[s],a=M.generateResourceId(e[t].serviceResource,o.serviceTerritory);void 0===i[t].territoriesByType[o.serviceTerritoryType]&&(i[t].territoriesByType[o.serviceTerritoryType]=[]),i[t].territoriesByType[o.serviceTerritoryType].push({start:o.effectiveStartDate,finish:o.effectiveEndDate,serviceTerritory:o.serviceTerritory,operatingHours:o.serviceTerritory__r.OperatingHours,type:o.serviceTerritoryType,id:o.id,section:a,sectionsToDraw:function(e){var t,i={monthly:{},daily:{}};for(t in scheduler.matrix)"MonthlyView"===t||"MTDView"===t||"LongView"===t?i.monthly[t]=[e]:i.daily[t]=[e];return i}(a)})}void 0!==i[t].territoriesByType.P&&i[t].territoriesByType.P.sort(M.sortByTime),void 0!==i[t].territoriesByType.R&&i[t].territoriesByType.R.sort(M.sortByTime),void 0!==i[t].territoriesByType.S&&i[t].territoriesByType.S.sort(M.sortByTime)}return i}(s.serviceCrewMembers)),m[a]=!0;var l,c=new Date(r);for(l in c.setDate(c.getDate()+1),o)!function(e,t,i){var n,s;if(e.getTime()!==t.getTime()){n=i.member.ganttLabel?i.member.ganttLabel.encodeHTML():customLabels.XCrewMember.replaceAll(i.member.serviceCrew__r.Name.encodeHTML()),s=i.member&&i.member.ganttColor||null,P(e,t,i,n,"S",s),P(e,t,i,n,"R",s);var r=e,o=t,a=i,l=n,c=s,d=a.territoriesByType.P,u=a.territoriesByType.R;if(void 0===u){var m=r;var p=o;var h=a;var g=l;var v=c;var f=h.territoriesByType.P;if(void 0!==f)for(var S=0;S<f.length;S++){var _=f[S],y=useLocationTimezone?_.operatingHours.TimeZone:userTimeZone,b=E(h.member.startDate,"GMT",y),y=E(h.member.endDate,"GMT",y),b=M.intersectDates({start:m,finish:p},{start:b,finish:y}).intersection;null===b||null!==(y=M.intersectDates({start:_.start,finish:_.finish},{start:b.start,finish:b.finish}).intersection)&&x(y.start,y.finish,_.sectionsToDraw,"crewMember",g,"crewLabelStyle",v)}}else if(void 0!==d)for(var w=0;w<d.length;w++){var T=!1,L=d[w],A=useLocationTimezone?L.operatingHours.TimeZone:userTimeZone,I=E(a.member.startDate,"GMT",A),C=E(a.member.endDate,"GMT",A),I=M.intersectDates({start:I,finish:C},{start:r,finish:o}).intersection;if(null!==I){var k=M.intersectDates({start:L.start,finish:L.finish},{start:I.start,finish:I.finish}).intersection;if(null!==k){for(var D=0;D<u.length;D++){var R=u[D],O=useLocationTimezone?R.operatingHours.TimeZone:userTimeZone,F=E(R.start,O,A),R=E(R.finish,O,A),O=M.intersectDates({start:F,finish:R},{start:r,finish:o}).intersection;null!==O&&null!==(F=M.intersectDates({start:O.start,finish:O.finish},{start:k.start,finish:k.finish}).intersection)&&(function(e,t,i,n,s){t.start.getTime()<e.start.getTime()&&x(t.start,e.start,i,"crewMember",n,"crewLabelStyle",s);e.finish.getTime()<t.finish.getTime()&&x(e.finish,t.finish,i,"crewMember",n,"crewLabelStyle",s)}(F,k,L.sectionsToDraw,l,c),T=!0)}T||null===k||x(k.start,k.finish,L.sectionsToDraw,"crewMember",l,"crewLabelStyle",c)}}}}}(new Date(r),new Date(c),o[l])}r.setDate(r.getDate()+1)}}),{reset:function(){m={}}}}]),angular.module("serviceExpert").factory("resourceFilterHelper",["$q","sfdcService","$sce","userSettingsManager",function(e,i,t,n){var s={sortBy:customLabels.name,asc:!0,showWorkingResource:!1,booleanFields:{},picklistField:"select_a_field",picklistOptions:[],picklistOptionsModel:[],picklistNullValues:!1,crewsOption:customLabels.showAll},r=JSON.parse(n.GetUserSettingsProperty("Resource_Filter__c"))||s,o=null,a=null,l={selectedPicklist:r.picklistField,resourceFilteringOptions:r.booleanFields,picklistOptionsModel:r.picklistOptionsModel,picklistOptions:r.picklistOptions,picklistNullValues:r.picklistNullValues,crewsSelectionOptions:{selectedPicklist:r.crewsOption,crewFilteringOptions:[customLabels.showAll,customLabels.hideCrewMembers,customLabels.showCrewsAndCrewMembers,customLabels.showOnlyCrews,customLabels.hideCrewsAndCrewMembers]}};function c(e){var t,i="",n="",s=customLabels.SelectAfieldToResourceFilter,r=(e&&(i="<b>"+customLabels.CurrentlyWorking+"</b>"),l.picklistOptions.map(function(e){return e&&e.encodeHTML()}));for(t in o)"BOOLEAN"===o[t][1]&&l.resourceFilteringOptions[o[t][2]]?""===i?i="<b>"+o[t][0].encodeHTML()+"</b>":i+=" "+customLabels.and+" <b>"+o[t][0].encodeHTML()+"</b>":"PICKLIST"===o[t][1]&&l.selectedPicklist===o[t][2]&&(0<(n=r.join("</b> "+customLabels.or+" <b>")).length&&(n="<b>"+o[t][0].encodeHTML()+"</b> is <b>"+n+"</b>"),l.picklistNullValues&&(""===n?n="<b>"+customLabels.None+"</b>":n+=" "+customLabels.or+" <b>"+customLabels.None+"</b>"));return""!==i&&""!==n?s=customLabels.Resources_That_Are_x_and_y.replaceAll(i,n):""===i&&""!==n?s=customLabels.Resources_That_Are_x.replaceAll(n):""!==i&&""==n&&(s=customLabels.Resources_That_Are_x.replaceAll(i)),s}return i.callRemoteAction(RemoteActions.getResourceFieldSetFields).then(function(e){for(var t in(o=e).Name=[customLabels.name,"STRING","Name"],o)"BOOLEAN"===o[t][1]&&(l.resourceFilteringOptions[t]=r.booleanFields[t]);monthlyViewSettings.isMonthlyAvailable&&(o.__Utilization__=[customLabels.AggregatedUtilization,"UTILIZATION","__Utilization__"])}).then(function(){var e,t=[];for(e in o)"PICKLIST"===o[e][1]&&t.push(e);i.callRemoteAction(RemoteActions.getResourcePicklistValues,t).then(function(e){a=e,$("#resourceExplainCrap").html(c(r.showWorkingResource))})}),{getResourceFieldset:function(){return o},getCrewFilteringOptions:function(){return l.crewsSelectionOptions.crewFilteringOptions},getPicklistNames:function(){return a},selectionInfo:l,updateSelectedPicklist:function(e,t){var i=l.picklistOptions.indexOf(e);-1===i?l.picklistOptions.push(e):l.picklistOptions.splice(i,1)},resetFilter:function(){for(var e in l.selectedPicklist="select_a_field",l.length=0,l.picklistOptions.length=0,l.picklistNullValues=!1,l.resourceFilteringOptions)l.resourceFilteringOptions[e]=!1},setAll:function(){for(var e in l.resourceFilteringOptions)l.resourceFilteringOptions[e]=!0},generateFilterExplanation:c,isResourceFilterApplied:function(){if(l.selectedPicklist&&(l.picklistOptions.length||l.picklistNullValues))return!0;for(var e in l.resourceFilteringOptions)if(l.resourceFilteringOptions[e])return!0;return!1},resourceFieldToSortyBy:r.sortBy,resourceCrewFilter:l.crewsSelectionOptions.selectedPicklist,resourceCrewDefaultFilter:customLabels.showAll,descending:r.asc,showWorkingResource:r.showWorkingResource}}]),!function(){function e(o,p,a,l,h,c,g,d,e,u,v,m,f,S){var _=null;function y(){_.killWatch&&_.killWatch(),c.setLightBoxStatus(!1),_.$destroy(),_=null}function b(e){if(e.ganttColor)return e.ganttColor;switch(e.statusCategory){case u.NONE:return"#a5e2d6";case u.SCHEDULED:return"#F9D058";case u.DISPATCHED:return"#8DD8FA";case u.IN_PROGRESS:return"#D68EF9";case u.COMPLETED:return"#95D055";case u.COULD_NOT_COMPLETE:return"#f58556";case u.CANCELED:return"#BEBCBA";default:return"#B7C9EA"}}function w(e){e!==_.selectedTab&&(_.selectedTab=e)}function T(e){_.currentlyShowingOnMap=e.id;e=new google.maps.LatLng(e.coords.latitude,e.coords.longitude);_.map.setCenter(e),_.map.setZoom(13)}function L(){_.bounds.isEmpty()||_.map.fitBounds(_.bounds),_.currentlyShowingOnMap=null}function A(){$("#mapCarouselWrapper").slideToggle("slow",function(){}),_.showSideRoute=!_.showSideRoute}function I(e){var t=Math.floor(e/60/60),e=Math.floor(e/60%60);return t+customLabels.kpi_h+" "+e+customLabels.kpi_m}function C(){return(_.isDaily?customLabels.KPIsAreCalculatedFrom:customLabels.KPIsAreCalculatedFromTo).replaceAll(moment(scheduler._min_date).format("ll"),moment(scheduler._max_date).format("ll"))}function k(e){return e?moment(e).format("LT"):null}function D(e,t){return""===e||""===t?"":customLabels.Between_x_and_y.replaceAll(moment(e).format("ll"),moment(t).format("ll"))}function R(e){_.resourceSLRPath={stroke:{weight:2,color:"#16325C"},path:[],geodesic:!0,toggle:!0},_.polyLinePath={path:[],geodesic:_.resourceSLRPath.geodesic,strokeColor:_.resourceSLRPath.stroke.color,strokeWeight:_.resourceSLRPath.stroke.weight,strokeOpacity:1},_.markersArray=[],_.bounds=new google.maps.LatLngBounds;var t=function(e){var t,i=null,n=_.resourceServicesDate,s=new Date(n),r=(s.setHours(24,0,0,0),g.resourcesAndTerritories());for(t in r){var o,a=r[t];for(o in a){var l=a[o];if("multi-route"==e)null==i&&(i={}),isIntersect(n,s,l.effectiveStartDate,l.effectiveEndDate)&&(i[t]=l);else if(-1<_.terMemberKey.indexOf(h.generateResourceId(l.serviceResource,l.serviceTerritory))&&isIntersect(n,s,l.effectiveStartDate,l.effectiveEndDate))return l}}return i}(),i=(_.resourceServices=function(e,t){var i=_.resourceServicesDate,n=new Date(i),s=(n.setHours(24,0,0,0),scheduler.getEvents(i,n));{var r;{if("multi-route"!=e||null==t)return r=s.filter(function(e){return-1<e.resourceId.indexOf(_.terMemberKey)&&e.latitude&&("service"===e.type||_.showAbsencesOnMap&&"na"===e.type)}).sort(function(e,t){return e.start.getTime()-t.start.getTime()});var o,a={};for(o in t)!function(t){r=s.filter(function(e){return-1<e.resourceId.indexOf(t)&&e.latitude&&("service"===e.type||_.showAbsencesOnMap&&"na"===e.type)}).sort(function(e,t){return e.start.getTime()-t.start.getTime()}),a[t]=r}(o);return a}}}(),{}),n=(t&&(t.latitude?i={latitude:t.latitude,longitude:t.longitude}:(n=p.territories()[t.serviceTerritory]).latitude&&(i={latitude:n.latitude,longitude:n.longitude})),null);i.latitude?(_.markersArray.push({id:t.serviceResource,type:"resource",coords:i,markerOptions:{icon:staticResources.homebase_png},resourceName:_.lightboxResource.name}),n=new google.maps.LatLng(i.latitude,i.longitude),_.polyLinePath.path.push(n),_.bounds.extend(n)):_.noHomeBase=!0;for(var s=0;s<_.resourceServices.length;s++){var r,o=_.resourceServices[s];o.latitude&&(_.showServices&&(r="service"===o.type?staticResources.service_png:staticResources.resource_absence_icon,r={id:o.id,type:o.type,coords:{latitude:o.latitude,longitude:o.longitude},markerOptions:{icon:r,labelContent:"<span>"+(s+1)+"</span>"+moment(o.start).format("LT"),labelClass:"ResourceMapServiceMarkerLabel",zIndex:200},item:o},_.markersArray.push(r)),r=new google.maps.LatLng(o.latitude,o.longitude),_.bounds.extend(r),_.resourceSLRPath.path.push({location:r,stopover:!0}),_.polyLinePath.path.push(r))}if(i.latitude&&_.polyLinePath.path.push(n),!e){if(_.showRoute)allowStreetLevelRouting&&0<_.resourceSLRPath.path.length?((i={})[((e={})[t.serviceResource]=t).serviceResource]=_.resourceServices,t={origin:n||_.resourceSLRPath.path[0].location,destination:n||_.resourceSLRPath.path[_.resourceSLRPath.path.length-1].location,waypoints:_.resourceSLRPath.path},_.calloutFailures=0,function n(d,u,h){_.O2Parameters.resourceMap=d;_.O2Parameters.resourceServicesMap=u;_.O2Parameters.googlePolylineProp=h;_.drivingProfile={image:"",type:"",tolls:"",hazmat:""};var e=[];var m=[];t();e.push({locations:m,overview:"full",vehicle:i()});e={routes:e};Visualforce.remoting.Manager.invokeAction(RemoteActions.getO2Polyline,JSON.stringify(e),moment(_.resourceServicesDate).format(),function(e,t){if(_.showRoute)if(200==t.statusCode&&"exception"!=t.type)if(null!=e.results){var i=e.results.results;if(null!=i){for(var n=0;n<_.O2PolyLineArray.length;n++)_.O2PolyLineArray[n].setMap(null);if(_.O2PolyLineArray=[],"Ok"==i[0].code)for(var s=0;s<i[0].routes.length;s++){var r=i[0].routes[s],o=[],r={overview_polyline:{points:r.geometry}};null!=google.maps.geometry?o.push.apply(o,_toConsumableArray(google.maps.geometry.encoding.decodePath(r.overview_polyline.points))):g();for(var a=0;a<o.length;a++)_.bounds.extend(o[a]);r=new google.maps.Polyline({path:o,strokeColor:"#0088FF",strokeOpacity:.55,strokeWeight:6,fillColor:"#0088FF",map:_.map});_.O2PolyLineArray.push(r);for(var l=0;l<_.O2PolyLineArray.length;l++)_.O2PolyLineArray[l].setMap(_.map);_.map.fitBounds(_.bounds);for(var c=0;c<e.travelProfiles.length;c++){var d=e.travelProfiles[c],u=d.transportType;"Car"==(_.drivingProfile.type=u)?_.drivingProfile.image=staticResources.car_svg:"Light Truck"==u?_.drivingProfile.image=staticResources.light_truck_svg:"Heavy Truck"==u?_.drivingProfile.image=staticResources.heavy_truck_svg:"Bicycle"==u?_.drivingProfile.image=staticResources.bicycle_svg:"Walking"==u&&(_.drivingProfile.image=staticResources.pedestrian_svg),1==d.canUseTollRoads?_.drivingProfile.tolls="Allowed":_.drivingProfile.tolls="Not Allowed",1==d.isTransportingHazmat?_.drivingProfile.hazmat="Allowed":_.drivingProfile.hazmat="Not Allowed"}}else{var m=null;"Ok"!=i[0].code&&(m=i[0].code),"NoRoute"==i[0].code?((p=null)!=e.travelProfiles[0]&&null!=e.travelProfiles[0].transportType&&(p=e.travelProfiles[0].transportType),g(m,i[0].code,p)):g(m)}}else{var p=null;null!=e.results.message&&(p=e.results.message),"Route request with unsupported region"==e.results.message?g(p,e.results.message):g(p)}}else null!=e.O2Disabled&&(1!=e.O2Disabled?((m=null)!=e.results.message&&(m=e.results.message),g(m)):F(h));else{p=null;null!=t.message&&(p=t.message),g(p)}});function g(e,t,i){null!=e&&console.log("ERROR -> "+e),_.calloutFailures++,1==_.calloutFailures?n(_.O2Parameters.resourceMap,_.O2Parameters.resourceServicesMap,_.O2Parameters.googlePolylineProp):null!=t?"Route request with unsupported region"===t?window.alert(customLabels.O2UnsupportedRegionMessage):"NoRoute"===t?(t=null!=i?i:"",window.alert(customLabels.O2LocationsIsNotAccessible+" "+t)):window.alert(customLabels.O2Failed):window.alert(e)}function t(){for(var e in u){var t,i=null,n=null,s=null,r=null;d[e].latitude?(i=d[e].latitude,n=d[e].longitude,s=d[e].latitude,r=d[e].longitude):(t=p.territories()[d[e].serviceTerritory]).latitude&&(i=t.latitude,n=t.longitude,s=t.latitude,r=t.longitude),null==i&&null==n&&(i=u[e][0].latitude,n=u[e][0].longitude),null==s&&null==r&&(s=u[e][u[e].length-1].latitude,r=u[e][u[e].length-1].longitude),c(i,n);for(var o=0;o<u[e].length;o++){var a=u[e][o].latitude,l=u[e][o].longitude;c(a,l)}c(s,r)}function c(e,t){m.push({lat:e,lng:t})}}function i(){for(var e in u)return{travel_profile:"car",vehicle_id:e}}}(e,i,t)):O();else{_.polyLineGoogleObj?_.polyLineGoogleObj.setMap(null):_.directionsDisplay&&_.directionsDisplay.setMap(null);for(var a=0;a<_.O2PolyLineArray.length;a++)_.O2PolyLineArray[a].setMap(null);_.O2PolyLineArray=[]}n=new google.maps.LatLng(37.794024,-122.394837);_.bounds.isEmpty()?_.map.setCenter(n):_.map.fitBounds(_.bounds)}var l,c=_.lightboxResource.id,d=v.lastKnownPositions();for(l in d)if(c===l){u=void 0;m=void 0;u=void 0;var u=d[l];var m=p.getResources()[u.id],u={id:u.id+"_position",markerOptions:{icon:staticResources.livepos_png},type:"lastKnownPosition",resourceId:u.id,coords:{latitude:u.latitude,longitude:u.longitude},item:angular.extend(angular.copy(u),{resourceName:m.name})};"lastKnownPosition"===u.type&&(window.customPermissions.Hide_Live_Locations_Resource_Map_Layer||isLastKnownFieldsNotAllowed)||_.markersArray.push(u)}}function O(){_.directionsDisplay&&(_.directionsDisplay.setMap(null),_.directionsDisplay=null),_.polyLineGoogleObj&&_.polyLineGoogleObj.setMap(null),_.polyLineGoogleObj=new google.maps.Polyline(_.polyLinePath),_.polyLineGoogleObj.setMap(_.map)}function F(e){_.drivingProfile.type="Car",_.drivingProfile.image=staticResources.car_svg,_.drivingProfile.tolls="Not Allowed",_.drivingProfile.hazmat="Not Allowed",(new google.maps.DirectionsService).route({origin:e.origin,destination:e.destination,waypoints:e.waypoints,travelMode:google.maps.TravelMode.DRIVING,avoidTolls:!0},function(e,t){t===google.maps.DirectionsStatus.OK?(_.polyLineGoogleObj&&(_.polyLineGoogleObj.setMap(null),_.polyLineGoogleObj=null),_.directionsDisplay||(_.directionsDisplay=new google.maps.DirectionsRenderer({suppressMarkers:!0})),_.directionsDisplay.setMap(_.map),_.directionsDisplay.setDirections(e)):(window.alert("Directions request failed due to "+t),O())})}function M(){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"resourceServicesDateStart",date:new Date(_.resourceServicesDate),navigation:!0,handler:function(e,t){_.$apply(function(){_.resourceServicesDate=e,_.generateMarkersAndRoute(),_.isLastKnownFieldsAllowedPermission()&&f.callRemoteAction(RemoteActions.getResourceActualRoute,_.lightboxResource.id,e).then(x)}),scheduler.destroyCalendar()}})}function P(e){_.resourceServicesDate.setDate(_.resourceServicesDate.getDate()+e),_.generateMarkersAndRoute(),_.isLastKnownFieldsAllowedPermission()&&f.callRemoteAction(RemoteActions.getResourceActualRoute,_.lightboxResource.id,_.resourceServicesDate).then(x)}function x(e){_.actualRoute&&(_.actualRoute.visible=!1,_.actualRoute.setMap(_.map));var t,i={},n=[];for(t in e.forEach(function(e){"LastKnownLatitude"!==e.Field&&"LastKnownLongitude"!==e.Field||(i[e.CreatedDate]=i[e.CreatedDate]||{},i[e.CreatedDate][-1<e.Field.indexOf("Long")?"lng":"lat"]=e.NewValue,i[e.CreatedDate].date=e.CreatedDate)}),i)i[t].lng&&i[t].lat&&n.push(i[t]);_.actualRoute=new google.maps.Polyline({path:n,geodesic:!0,strokeColor:"#ff73bf",strokeOpacity:1,strokeWeight:3}),_.isLastKnownFieldsAllowedPermission()&&_.showActual&&_.actualRoute.setMap(_.map)}function E(){_.isLastKnownFieldsAllowedPermission()&&_.actualRoute&&(_.actualRoute.visible=_.showActual,_.actualRoute.setMap(_.map))}function N(e){for(var t,i=scheduler.getEvents(scheduler.getState().min_date,scheduler.getState().max_date),n=[],s=[],r=0;r<i.length;r++)i[r].resource==e&&"contractorcapacity"==i[r].type&&("Week"==i[r].timePeriod&&n.push(i[r]),"Month"==i[r].timePeriod&&s.push(i[r]));_.donutCharts=(t={segmentShowStroke:!1,segmentStrokeColor:"#fff",segmentStrokeWidth:2,percentageInnerCutout:75,animation:!0,animationSteps:100,animationEasing:"easeOutSine",animateRotate:!0,animateScale:!1,showTooltips:!0},{labels:[customLabels.Hours_Used,customLabels.Hours_Available],weekly:{data:[],percentage:"",start:"",end:"",show:!1,options:t},monthly:{data:[],percentage:"",start:"",end:"",show:!1,options:t}}),setTimeout(function(){var e,t=n[0],i=s[0];t?((e=t.hoursPerTimePeriod-t.hoursInUse)<0&&(e=0),_.donutCharts.weekly.data=[t.hoursInUse,e],_.donutCharts.weekly.percentage=G(t.hoursInUse,t.hoursPerTimePeriod)+"%",_.donutCharts.weekly.start=t.start_date,_.donutCharts.weekly.end=t.end_date,_.donutCharts.weekly.show=!0):(_.donutCharts.weekly.data=[0,10],_.donutCharts.weekly.show=!1,_.donutCharts.weekly.options.showTooltips=!1,_.donutCharts.weekly.start=_.kpiStart,_.donutCharts.weekly.end=_.kpiEnd),i?((e=i.hoursPerTimePeriod-i.hoursInUse)<0&&(e=0),_.donutCharts.monthly.data=[i.hoursInUse,e],_.donutCharts.monthly.percentage=G(i.hoursInUse,i.hoursPerTimePeriod)+"%",_.donutCharts.monthly.start=i.start_date,_.donutCharts.monthly.end=i.end_date,_.donutCharts.monthly.show=!0):(_.donutCharts.monthly.data=[0,10],_.donutCharts.monthly.show=!1,_.donutCharts.monthly.options.showTooltips=!1,_.donutCharts.monthly.start=scheduler.getState().min_date,_.donutCharts.monthly.end=scheduler.getState().max_date)},1e3)}function G(e,t){return parseFloat((e/t*100).toFixed(2))}function B(){d(function(){_.actualRoute&&_.actualRoute.setMap(_.map)},500)}return{open:function(e,t){if(!_){(_=o.$new(!0)).lightboxResource=p.getResources()[e],_.terMemberKey=t||g.getResoruceGanttIdByDate(e,scheduler.getState().min_date),_.selectedTab="details";var t="vf079_ResourceCalendar?id=",i=(__gantt.communityNetworkId&&""!==__gantt.communityNetworkId&&fslNamespace&&""!==fslNamespace&&(t=fslNamespace+"__vf079_ResourceCalendar?id="),_.urls={related:a.trustAsResourceUrl(customResourceRelatedListLightboxPage+"?id="+e).toString(),chatter:a.trustAsResourceUrl(customResourceChatter+"?id="+e).toString(),details:a.trustAsResourceUrl(customResourceLightboxPage+"?id="+e).toString(),calendar:a.trustAsResourceUrl(t+e).toString()},_.urls.custom1=CustomResourceTab1?a.trustAsResourceUrl(CustomResourceTab1+"?id="+e).toString():null,_.urls.custom2=CustomResourceTab2?a.trustAsResourceUrl(CustomResourceTab2+"?id="+e).toString():null,_.changeTab=w,_.closeLightbox=y,_.chatterAvailable=fieldTrackingEnabled.resource,_.formatTravel=I,_.openConsoleTab=h.openConsoleTab,_.formatKpitText=C,_.formatDateToTime=k,_.formatCapacityKpitText=D,_.getContractorCapacityStatus=N,_.isMapEnabled=c.isMapEnabled(),_.contractorSupport=c.areContractorsSupported(),_.isDaily="ZoomLevel3"==scheduler._mode,_.actualRoute=null,_.showActual=!0,_.toggleShowRoute=E,_.toggleActualVisibilityWhenMapTabClicked=B,_.boundOnCaruselItem=T,_.showSideRoute=!0,_.zoomOutToFitAll=L,_.slideToggle=A,_.currentlyShowingOnMap=null,_.changeDate=P,_.getColorByStatus=b,_.showAbsencesOnMap=window.showAbsencesOnMap,_.hideActulRoute=window.customPermissions.Hide_Actual_Routes_in_Service_Resource_Map,_.O2PolyLineArray=[],_.calloutFailures=0,_.drivingProfile={image:"",type:"",tolls:"",hazmat:""},_.O2Parameters={resourceMap:null,resourceServicesMap:null,googlePolylineProp:null},_.hideActulRoute=window.customPermissions.Hide_Actual_Routes_in_Service_Resource_Map||isLastKnownFieldsNotAllowed,Chart.defaults.global.colours=["#16325c","#DCDCDC","#F7464A","#46BFBD","#FDB45C","#949FB1","#4D5360"],_.donutCharts=null,_.isLastKnownFieldsAllowedPermission=function(){return!(window.customPermissions.Hide_Actual_Routes_in_Service_Resource_Map||isLastKnownFieldsNotAllowed)},_.haveItemsToShowOnSideRoute=function(e){for(var t=0;t<e.length;t++)if("na"===e[t].type||"service"===e[t].type)return!0;return!1},_.isMapEnabled&&(_.getServiceInfoRowClass=h.getServiceInfoRowClass,_.firstMapShow=!0,_.showRoute=!0,_.showTrafficLayer=!1,_.showServices=!0,_.mapControl={},_.mapOptions={zoomControlOptions:{position:google.maps.ControlPosition.LEFT_BOTTOM},streetViewControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},mapTypeControlOptions:{position:google.maps.ControlPosition.BOTTOM_CENTER},fullscreenControlOptions:{position:google.maps.ControlPosition.LEFT_BOTTOM}},_.serviceInfoWindow={show:!1},_.livePosInfoWindow={show:!1},_.resourceInfoWindow={show:!1},_.absenceInfoWindow={show:!1},_.infoWindowOptions={service:{pixelOffset:new google.maps.Size(0,-38)},livePos:{pixelOffset:new google.maps.Size(0,-38)},resource:{pixelOffset:new google.maps.Size(0,-38)},absence:{pixelOffset:new google.maps.Size(0,-38)}},_.resourceServicesDate=scheduler.getState().min_date,_.markersArray=[],m.fieldsSetFields().then(function(e){_.serviceFields=e.MapInfo}),_.killWatch=_.$watch("selectedTab",function(e){"map"==e&&d(function(){var e,t;_.map=_.mapControl.getGMap(),google.maps.event.trigger(_.map,"resize"),_.firstMapShow&&(_.firstMapShow=!1,e=_.map.getStreetView(),t={fullscreenControl:!1,addressControlOptions:{position:google.maps.ControlPosition.BOTTOM_CENTER}},e.setOptions(t),_.firstMapShow=!1,_.generateMarkersAndRoute())},0)}),_.generateMarkersAndRoute=R,_.openDatePicker=M,_.routeToggled=function(){_.generateMarkersAndRoute();var e=_.showRoute?_.map:null;_.polyLineGoogleObj&&_.polyLineGoogleObj.setMap(e),_.directionsDisplay&&_.directionsDisplay.setMap(e)},_.markerClicked=function(e,t,i){var n=i.type;switch(_.serviceInfoWindow.show=!1,_.absenceInfoWindow.show=!1,_.livePosInfoWindow.show=!1,_.resourceInfoWindow.show=!1,_.currentMarker=i,n){case"service":_.serviceInfoWindow.show=!0;break;case"lastKnownPosition":_.livePosInfoWindow.show=!0;break;case"resource":_.resourceInfoWindow.show=!0;break;case"na":case"break":_.absenceInfoWindow.show=!0}d(function(){_.$apply(),h.setMapCloseButtonPosition()},0)},_.markerCloseClicked=function(){_.serviceInfoWindow.show=!1,_.livePosInfoWindow.show=!1,_.absenceInfoWindow={show:!1},_.resourceInfoWindow.show=!1,_.$apply()},_.openFieldSetLink=function(e,t){h.openLink(e,t)},_.openLink=function(e){h.openSObjectLink(e)}),e),n=scheduler.getEvents(scheduler.getState().min_date,scheduler.getState().max_date);_.resourceKpi={total:0,completed:0,violations:0,jeopardy:0,avgTravelTime:0,totalScheduledDuration:0};for(var s=0;s<n.length;s++)n[s].resource==i&&("na"===n[s].type&&(_.resourceKpi.avgTravelTime+=n[s].travelTo+n[s].travelFrom),"service"===n[s].type&&(_.resourceKpi.total++,n[s].statusCategory==u.COMPLETED&&_.resourceKpi.completed++,n[s].violations&&_.resourceKpi.violations++,n[s].jeopardy&&_.resourceKpi.jeopardy++,_.resourceKpi.avgTravelTime+=n[s].travelTo+n[s].travelFrom,n[s].start_date&&n[s].end_date&&(_.resourceKpi.totalScheduledDuration+=(n[s].finish-n[s].start)/1e3)));0<n.length&&0<_.resourceKpi.total?_.resourceKpi.avgTravelTime=Math.floor(_.resourceKpi.avgTravelTime/60/_.resourceKpi.total):_.resourceKpi.avgTravelTime=0,N(e);var r=angular.element('<div class="LightboxBlackContainer ng-cloack">\n                    <div class="LightboxContainer ng-cloak" id="ResourceLightbox">\n\n                        <div class="lightboxHeaderContainer" id="ResourceLightboxHeader">\n                            <svg fsl-key-press tabindex="0" ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            <img ng-show="lightboxResource.pictureLink" class="resourcePhotoLightbox" ng-src="{{ lightboxResource.pictureLink }}" alt="{{ lightboxResource.name }}" />\n                            <div ng-show="!lightboxResource.pictureLink" alt="{{ lightboxResource.name }}" class="ResourcePhotoIcon resourcePhotoLightbox"></div>\n\n                            <h1 class="lightboxHeader" id="resourceName" ng-bind="lightboxResource.name"></h1>\n                            <button fsl-tab-switch role="tab" ng-click="changeTab(\'details\')" ng-class="{lightboxSelectedTab: selectedTab == \'details\'}">\n                                '+customLabels.Details+'\n                            </button>\n\n                            <button fsl-tab-switch role="tab" ng-click="changeTab(\'relatedLists\')" ng-class="{lightboxSelectedTab: selectedTab == \'relatedLists\'}">\n                                '+customLabels.Related+'\n                            </button>\n\n                            <button ng-show="chatterAvailable" fsl-tab-switch role="tab" ng-click="changeTab(\'chatter\')" ng-class="{lightboxSelectedTab: selectedTab == \'chatter\'}">\n                                '+customLabels.Chatter+'\n                            </button>\n\n                            <button ng-if="isMapEnabled" fsl-tab-switch role="tab" ng-click="changeTab(\'map\'); " ng-class="{lightboxSelectedTab: selectedTab == \'map\'}">\n                                '+customLabels.Map+'\n                            </button>\n\n                            <button fsl-tab-switch role="tab" ng-click="changeTab(\'calendar\')" ng-class="{lightboxSelectedTab: selectedTab == \'calendar\'}">\n                                '+customLabels.Calendar+'\n                            </button>\n                            \n                            <button ng-show="urls.custom1" fsl-tab-switch role="tab" ng-click="changeTab(\'customTab1\')" ng-class="{lightboxSelectedTab: selectedTab == \'customTab1\'}">\n                                '+customLabels.CustomResourceTab1+'\n                            </button>\n                            \n                            <button ng-show="urls.custom2" fsl-tab-switch role="tab" ng-click="changeTab(\'customTab2\')" ng-class="{lightboxSelectedTab: selectedTab == \'customTab2\'}">\n                                '+customLabels.CustomResourceTab2+'\n                            </button>\n\n                            <div class="ExtendedForm">\n                                <a ng-click="openConsoleTab($event,lightboxResource.id)" target="_blank" href="../{{ lightboxResource.id }}" title="'+customLabels.ExtandedForm+'">\n                                    <svg aria-hidden="true" class="slds-icon openExternalIcon">\n                                        \u2028<use xlink:href="'+lsdIcons.external+'"></use>\n                                    \u2028</svg>\n                                </a>\n                            </div>\n                        </div>\n\n                        <section ng-if="isMapEnabled" id="resourceLightboxMap" ng-show ="selectedTab == \'map\'">\n                            <ui-gmap-google-map pan="false" control="mapControl" center="{latitude: 0 ,longitude: 0}" options="mapOptions" zoom="16" class="map-canvas">\n                                <ui-gmap-markers click="markerClicked" models="markersArray" idKey="id" coords="\'coords\'" options="\'markerOptions\'"">\n                                </ui-gmap-markers>\n\n                                <ui-gmap-window show="serviceInfoWindow.show" ng-show="currentMarket.type === \'service\'" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.service" >\n                                    <div class="googleMapInfoWindowService">\n                                        <img class="mapTooltipIcon" src="'+staticResources.wo_icon_png+'"/>\n                                        <h1 class="truncate mapTooltipTitle">{{currentMarker.item | displayFieldSetField : serviceFields[0] }}</h1>\n\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[1] || serviceFields[1]">{{serviceFields[1].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[1])" ng-class="getServiceInfoRowClass(serviceFields[1])">{{currentMarker.item | displayFieldSetField : serviceFields[1]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[2] || serviceFields[2]">{{serviceFields[2].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[2])" ng-class="getServiceInfoRowClass(serviceFields[2])">{{currentMarker.item | displayFieldSetField : serviceFields[2]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[3] || serviceFields[3]">{{serviceFields[3].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[3])" ng-class="getServiceInfoRowClass(serviceFields[3])">{{currentMarker.item | displayFieldSetField : serviceFields[3]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[4] || serviceFields[4]">{{serviceFields[4].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[4])" ng-class="getServiceInfoRowClass(serviceFields[4])">{{currentMarker.item | displayFieldSetField : serviceFields[4]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[5] || serviceFields[5]">{{serviceFields[5].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[5])" ng-class="getServiceInfoRowClass(serviceFields[5])">{{currentMarker.item | displayFieldSetField : serviceFields[5]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[6] || serviceFields[6]">{{serviceFields[6].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[6])" ng-class="getServiceInfoRowClass(serviceFields[6])">{{currentMarker.item | displayFieldSetField : serviceFields[6]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[7] || serviceFields[7]">{{serviceFields[7].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[7])" ng-class="getServiceInfoRowClass(serviceFields[7])">{{currentMarker.item | displayFieldSetField : serviceFields[7]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[8] || serviceFields[8]">{{serviceFields[8].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[8])" ng-class="getServiceInfoRowClass(serviceFields[8])">{{currentMarker.item | displayFieldSetField : serviceFields[8]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[9] || serviceFields[9]">{{serviceFields[9].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[9])" ng-class="getServiceInfoRowClass(serviceFields[9])">{{currentMarker.item | displayFieldSetField : serviceFields[9]}}</span></div>\n\n                                    </div>\n                                </ui-gmap-window>\n\n                                <ui-gmap-window show="resourceInfoWindow.show" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.resource">\n                                    <div class="googleMapInfoWindowHomebase">\n                                        <svg aria-hidden="true" class="slds-icon homebaseTooltipIcon">\n                                            \u2028<use xlink:href="'+lsdIcons.home+'"></use>\n                                        \u2028</svg>\n                                        <h1 class="truncate mapTooltipTitle"><span class="homebaseLabel">{{ "'+customLabels.homebase_of+'" | replaceLabels : currentMarker.resourceName }}</span></h1>\n                                        <div class="buttonOnMap"  ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.id)">'+customLabels.viewDetails+'</div>\n                                    </div>\n                                </ui-gmap-window>\n                                \n                                \n                                \n                                \n                                <ui-gmap-window show="absenceInfoWindow.show && showAbsencesOnMap" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.absence">\n                                    <div class="googleMapInfoWindowAbsence">\n                                        <svg aria-hidden="true" class="slds-icon absenceeTooltipIcon">\n                                            \u2028<use xlink:href="'+lsdIcons.absence+'"></use>\n                                        \u2028</svg>\n                                        <h1 class="truncate mapTooltipTitle"><span class="homebaseLabel">{{ $parent.$parent.currentMarker.item.name }}</span></h1>\n                                        <div>'+customLabels.Start_time+": {{ $parent.$parent.currentMarker.item.start | amDateFormat:'lll' }}</div>\n                                        <div>"+customLabels.Finish_time+": {{ $parent.$parent.currentMarker.item.end | amDateFormat:'lll' }}</div>\n                                        <div>"+customLabels.Reason+': {{ $parent.$parent.currentMarker.item.reason }}</div>\n                                        <div class="buttonOnMap"  ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.id)">'+customLabels.viewDetails+'</div>\n                                    </div>\n                                </ui-gmap-window>\n                                \n                               \n                                <ui-gmap-window show="livePosInfoWindow.show" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.livePos">\n                                    <div class="googleMapInfoWindowLivePos">\n                                        <svg aria-hidden="true" class="slds-icon livePosTooltipIcon">\n                                        \u2028\t<use xlink:href="'+lsdIcons.user+'"></use>\n                                    \u2028\t</svg>\n                                        <h1 class="truncate mapTooltipTitle" ng-bind="$parent.$parent.$parent.currentMarker.item.resourceName"></h1>\n                                        <div>'+customLabels.Last_seen+' {{ currentMarker.item.lastModifiedDate | amDateFormat:\'lll\' }}</div>\n                                        <div class="buttonOnMap"  ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.resourceId)">'+customLabels.viewDetails+'</div>\n                                    </div>\n                                </ui-gmap-window>\n\n                                <ui-gmap-layer type="TrafficLayer" show=\'showTrafficLayer\'></ui-gmap-layer>\n                                \n                            </ui-gmap-google-map>\n                            <div id="ResourceMapOptions">\n                                <div id="ResourceMapOptionsWrapper">\n                                    <input ng-model="$parent.showServices" ng-change="generateMarkersAndRoute(true)" type="checkbox" id="ResourceServicesFilter"></input>\n                                    <label for="ResourceServicesFilter">'+customLabels.Show_services_for+'</label>\n                                    <div class="resourceMapDateArrow" fsl-key-press tabindex="0" ng-click="changeDate(-1)">\n                                        <svg aria-hidden="true" class="slds-icon resourceMapChevronIcon">\n                                        \u2028   <use xlink:href="'+lsdIcons.chevronleft+'"></use>\n                                    \u2028   </svg>\n                                    </div>\n                                    <u id="resourceServicesDateStart" class="bulkDatePicker" fsl-key-press tabindex="0" ng-click ="openDatePicker()" >{{resourceServicesDate | amDateFormat:\'L\'}}</u>\n                                    <div class="resourceMapDateArrow" fsl-key-press tabindex="0" ng-click="changeDate(1)">\n                                        <svg aria-hidden="true" class="slds-icon resourceMapChevronIcon">\n                                        \u2028   <use xlink:href="'+lsdIcons.chevronright+'"></use>\n                                    \u2028   </svg>\n                                    </div>\n                                    <input ng-hide="lightboxResource.isCapacityBased && contractorSupport" ng-model="$parent.showRoute" ng-change="routeToggled()" type="checkbox" id="RouteFilter"></input>\n                                    <label class="truncate resource-map-option-label" ng-hide="lightboxResource.isCapacityBased && contractorSupport" for="RouteFilter">'+customLabels.Route+'</label>\n                                    <input ng-hide="hideActulRoute || (lightboxResource.isCapacityBased && contractorSupport)" ng-model="$parent.showActual" ng-change="toggleShowRoute()" type="checkbox" id="actualToggle"></input>\n                                    <label class="truncate resource-map-option-label" ng-hide="hideActulRoute || (lightboxResource.isCapacityBased && contractorSupport)" for="actualToggle">'+customLabels.ActualRoute+'</label>\n                                    <input ng-hide="lightboxResource.isCapacityBased && contractorSupport" ng-model="showTrafficLayer" type="checkbox" id="trafficToggle"></input>\n                                    <label class="truncate resource-map-option-label" ng-hide="lightboxResource.isCapacityBased && contractorSupport" for="trafficToggle">'+customLabels.Traffic+'</label>\n                                    <div fsl-key-press tabindex="0" class="truncate" id="toggleResourceMapServiceCarousel" ng-click="slideToggle()">\n                                        {{showSideRoute ? "'+customLabels.HideDetailedRoute+'" : "'+customLabels.ToggleDetailedRoute+'"}}\n                                    </div>\n                                </div>\n                            </div>\n                            <div id="ResourceMapCarousel" ng-show="resourceServices.length > 0">\n\n                                <div id="mapCarouselWrapper">\n                                    <div class="carouselArrow crouselLeft">\n                                        <svg aria-hidden="true" class="slds-icon arrowIcon">\u2028<use xlink:href="'+lsdIcons.chevronleft+'"></use>\u2028</svg>\n                                    </div>\n                                    <div class="carouselArrow crouselRight">\n                                        <svg aria-hidden="true" class="slds-icon arrowIcon">\u2028<use xlink:href="'+lsdIcons.chevronright+'"></use>\u2028</svg>                                \n                                    </div>\n                                    \n                                    \n                                    <div class="resource-map-no-route" ng-hide="haveItemsToShowOnSideRoute(markersArray)">\n                                        There are no services or absences to show\n                                    </div>\n\n                                    <div class="carouselItem" ng-if=" drivingProfile.type == \'\' && showRoute == true && calloutFailures != 2">\n                                        <img style="display: block; margin-left: auto; margin-right: auto; width: 20%; padding: 10px;" src="'+lsdIcons.spinnerGif+'" />\n                                    </div>\n                                    <div class="carouselItem" ng-if=" drivingProfile.type != \'\' && showRoute == true">\n                                        <span>\n                                            <div style="background-color: #8DB9F9; display: inline-flex; width: 32px; height: 32px;">\n                                                <object style="width: 75%; height: 75%; margin: auto;" data="{{drivingProfile.image}}"></object>\n                                            </div>\n                                        </span>\n                                        \x3c!-- <span>\n                                            <img style="max-height: 24px;" src="{{drivingProfile.image}}"/>\n                                        </span> --\x3e\n                                        <div style="display: inline-block;margin-left: 9px">\n                                            <span class="appointment-times">Travel Profile</span>\n                                            <span class="appointment-number">{{drivingProfile.type}}</span>\n                                        </div>\n                                        <div class="appointment-rows">\n                                            <div>'+customLabels.Use_Tollways+": {{drivingProfile.tolls}}</div>\n                                            <div>"+customLabels.Hazardous_Materials+': {{drivingProfile.hazmat}}</div>\n                                        </div>\n                                    </div>\n                                    <div ng-repeat="marker in markersArray" class="carouselItem" ng-if=" marker.type === \'na\' || marker.type == \'service\'">\n                                    \n                                        <div ng-if="marker.type === \'na\'">\n                                            <span class="numberingOnMapRouteSide numberingOnMapRouteSideNA" fsl-key-press tabindex="0" title="'+customLabels.CenterOnMapp+'" ng-click="boundOnCaruselItem(marker)">{{noHomeBase && $index+1 || $index}}</span>\n                                            <span class="appointment-times">{{formatDateToTime(marker.item.start)}} - {{formatDateToTime(marker.item.finish)}}</span>\n                                            <span class="appointment-number">{{marker.item.name}}</span>\n  \n                                            <div class="appointment-rows">\n                                                <div>'+customLabels.Start_time+": {{ marker.item.start | amDateFormat:'lll' }}</div>\n                                                <div>"+customLabels.Finish_time+": {{ marker.item.end | amDateFormat:'lll' }}</div>\n                                                <div>"+customLabels.Reason+': {{ marker.item.reason }}</div>\n                                            </div>\n                                        </div>\n                                    \n                                    \n                                        <div ng-if="marker.type == \'service\'">\n                                            <span class="numberingOnMapRouteSide" title="'+customLabels.CenterOnMapp+'" fsl-key-press tabindex="0" ng-click="boundOnCaruselItem(marker)" ng-style="{\'background-color\': getColorByStatus(marker.item)}">{{ noHomeBase && $index+1 || $index}}</span>\n                                            <span class="appointment-times">{{formatDateToTime(marker.item.start)}} - {{formatDateToTime(marker.item.finish)}}</span>\n                                            <span class="appointment-number">{{marker.item.AppointmentNumber}}</span>\n                                            \x3c!-- <div class="boundOnMarker globalBlueButton" ng-click="boundOnCaruselItem(marker)" ng-hide="currentlyShowingOnMap == marker.id">\n                                                 <svg aria-hidden="true" class="slds-icon boundIcon">\u2028<use xlink:href="'+lsdIcons.checkin+'"></use>\u2028</svg>                                            \n                                            </div>\n                                            <div class="boundOnMarker globalBlueButton" ng-click="zoomOutToFitAll()" ng-show="currentlyShowingOnMap == marker.id">\n                                                 <svg aria-hidden="true" class="slds-icon boundIcon">\u2028<use xlink:href="'+lsdIcons.location+'"></use>\u2028</svg>                                            \n                                            </div>--\x3e\n                                            <div class="appointment-rows">\n                                                <span ng-repeat="field in serviceFields" class="">\n                                                    <div ng-show="marker.item[field.JsAPIName]">{{field.Label}}: <span ng-click="openFieldSetLink(marker.item, field)" ng-class="getServiceInfoRowClass(field)">{{marker.item | displayFieldSetField : field}}</span></div>                                            \n                                                </span>\n                                            </div>\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </section>\n\n                        <div class="capacitiesDonuts" ng-show="selectedTab == \'details\' && lightboxResource.isCapacityBased && contractorSupport">\n                            <div id="weeklyCapacity">\n                                <div id="weeklyDonutPercentage" class="donutPercentage">\n                                    <div ng-show="donutCharts.weekly.show" ng-bind="donutCharts.weekly.percentage"></div>\n                                    <div class="noCapacity" ng-show="!donutCharts.weekly.show">'+customLabels.No_Weekly_Capacity+'</div>\n                                    <div class="capacityTimeFrameLabel truncate" ng-show="donutCharts.weekly.show" title="'+customLabels.Weekly_Capacity+'">'+customLabels.Weekly_Capacity+'</div>\n                                </div>\n                                <canvas id="weeklyDoughnutChart"\n                                        class="chart chart-doughnut"\n                                        chart-options="donutCharts.weekly.options"\n                                        chart-data="donutCharts.weekly.data"\n                                        chart-labels="donutCharts.labels">\n                                </canvas>\n                                <div class="capacityRange">{{formatCapacityKpitText(donutCharts.weekly.start, donutCharts.weekly.end)}}</div>\n                            </div>\n\n                            <div id="monthlyCapacity">\n                                <div id="monthlyDonutPercentage" class="donutPercentage">\n                                    <div ng-show="donutCharts.monthly.show" ng-bind="donutCharts.monthly.percentage"></div>\n                                    <div class="noCapacity" ng-show="!donutCharts.monthly.show">'+customLabels.No_Monthly_Capacity+'</div>\n                                    <div class="capacityTimeFrameLabel truncate" ng-show="donutCharts.monthly.show" title="'+customLabels.Monthly_Capacity+'">'+customLabels.Monthly_Capacity+'</div> \n                                </div>\n                                <canvas id="monthlyDoughnutChart"\n                                        class="chart chart-doughnut"\n                                        chart-options="donutCharts.monthly.options"\n                                        chart-data="donutCharts.monthly.data"\n                                        chart-labels="donutCharts.labels">\n                                </canvas>\n                                <div class="capacityRange">{{formatCapacityKpitText(donutCharts.monthly.start, donutCharts.monthly.end)}}</div>\n                            </div>\n                        </div>\n\n                        <div id="KPIforResource" ng-show="selectedTab == \'details\'" ng-class="{KPIforResourceWithCapacity: (lightboxResource.isCapacityBased && contractorSupport)}">\n                            <div class="kpiIndicator" ng-show="!lightboxResource.isCapacityBased || (lightboxResource.isCapacityBased && !contractorSupport)">\n                                <div class="kpiResourceValue" >\n                                    <svg aria-hidden="true" class="slds-icon kpiResourceIcon">\u2028<use xlink:href="'+lsdIcons.clock+'"></use>\u2028</svg>\n                                    {{ formatTravel(resourceKpi.totalScheduledDuration) }}\n                                </div>\n\n                                '+customLabels.Total_Scheduled+'\n                            </div>\n\n                            <div class="kpiIndicator" ng-show="isMapEnabled && (!lightboxResource.isCapacityBased || (lightboxResource.isCapacityBased && !contractorSupport))">\n                                <div class="kpiResourceValue">\n                                    <svg aria-hidden="true" class="slds-icon kpiResourceIconTravel"><use xlink:href="'+lsdIcons.car+'"></use>\u2028</svg>\n                                    {{ formatTravel(resourceKpi.avgTravelTime * 60) }}\n                                </div>\n\n                                '+customLabels.Average_Travel+'\n                            </div>\n\n                            <div class="kpiIndicator">\n                                <div class="kpiResourceValue">\n                                    <svg aria-hidden="true" class="slds-icon kpiResourceIcon">\u2028<use xlink:href="'+lsdIcons.violation+'"></use>\u2028</svg>\n                                    {{ resourceKpi.violations }}\n                                </div>\n\n                                '+customLabels.Violations+'\n                            </div>\n\n                            <div class="kpiIndicator">\n                                <div class="kpiResourceValue">\n                                    <svg aria-hidden="true" class="slds-icon kpiResourceIcon"><use xlink:href="'+lsdIcons.jeopardy+'"></use>\u2028</svg>\n                                    {{ resourceKpi.jeopardy }}\n                                </div>\n                                 '+customLabels.In_Jeopardy+'\n                            </div>\n\n                            <div class="kpiIndicator">\n                                <div class="kpiResourceValue">\n                                    <svg aria-hidden="true" class="slds-icon kpiResourceIcon">\u2028<use xlink:href="'+lsdIcons.completed+'"></use>\u2028</svg>\n                                    {{ resourceKpi.completed }}/{{ resourceKpi.total }}\n                                </div>\n\n                                '+customLabels.Completed+'\n                            </div>\n\n                            <div class="KpiRange">{{formatKpitText()}}</div>\n                        </div>\n\n                        <iframe onLoad="removeLightboxLoading()" ng-src="{{ urls.details }}" id="detailsIframeResource" ng-class="{detailsIframeResourceContractor: lightboxResource.isCapacityBased && contractorSupport}" ng-show="selectedTab == \'details\'"></iframe>\n                        <iframe onLoad="removeLightboxLoading()" ng-src="{{ urls.related }}" id="relatedListIframeResource" ng-show="selectedTab == \'relatedLists\'" ></iframe>\n                        <iframe onLoad="removeLightboxLoading()" ng-src="{{ urls.chatter }}" ng-if="chatterAvailable" id="chatterIframeResource" ng-show="selectedTab == \'chatter\'" ></iframe>\n                        <iframe onLoad="removeLightboxLoading()" ng-src="{{ urls.calendar }}" id="calendarIframeResource" ng-show="selectedTab == \'calendar\'" ></iframe>\n                        <iframe onLoad="removeLightboxLoading()" ng-if="urls.custom1" ng-show="selectedTab == \'customTab1\'" ng-src="{{ urls.custom1 }}" class="resourceLightboxIframe"></iframe>\n                        <iframe onLoad="removeLightboxLoading()" ng-if="urls.custom2" ng-show="selectedTab == \'customTab2\'" ng-src="{{ urls.custom2 }}" class="resourceLightboxIframe"></iframe>\n                        \n                        <div id="lightbox-loading-cover">\n                            <img src="'+lsdIcons.spinnerGif+'" />\n                            '+customLabels.loading+"\n                        </div>\n\n                    </div>\n                </div>");r.find("#ResourceLightbox").draggable({containment:"document",handle:"#ResourceLightboxHeader"}),angular.element("body").append(r),c.setLightBoxStatus(),_.$on("$destroy",function(){return r.remove()}),_.$on("keypress",function(e,t){27==t.which&&_.$evalAsync(_.closeLightbox)}),l(r)(_),h.safeApply(_),_.hideActulRoute||f.callRemoteAction(RemoteActions.getResourceActualRoute,_.lightboxResource.id,scheduler.getState().min_date).then(function(e){S.promise(1).then(function(){_.map=_.mapControl.getGMap(),x(e)})})}}}}e.$inject=["$rootScope","ResourcesAndTerritoriesService","$sce","$compile","utils","StateService","TimePhasedDataService","$timeout","SERVICE_STATUS","SERVICE_CATEGORY","LastKnownPositionService","FieldSetFieldsService","sfdcService","uiGmapIsReady"],angular.module("serviceExpert").factory("ResourceLightboxService",e)}(),!function(){function e(s,r,o,l,e,c,d,u,m,t,a){var p=null,h=[];function g(){p.$destroy()}function v(){e.open(p.resourceId,p.section)}function f(t){var e,i,n,s,r=void 0,r=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),o=d.selectedPolicyId,a={FillInSchedule:{FunctionName:c.runFillInSchedule,NotificationHeaderText:customLabels.x_request_sent.replaceAll(customLabels.Fill_in_Schedule),NotificationText:customLabels.RequestNotificationSent.replaceAll(customLabels.Fill_in_Schedule,p.menuResource.name.encodeHTML(),moment(r).format("L"))},FixOverlaps:{FunctionName:c.runFixOverlaps,NotificationHeaderText:customLabels.x_request_sent.replaceAll(customLabels.FixOverlaps),NotificationText:customLabels.RequestNotificationSent.replaceAll(customLabels.FixOverlaps,p.menuResource.name.encodeHTML(),moment(r).format("L"))}};useLocationTimezone&&(i=addDaysToDate(e=r,1),n=m.getIntersectingSrstOffset({start_date:e,end_date:i},p.resourceId),s=l.getUserOffset(e),l.getUserOffset(i),r.setMinutes(e.getMinutes()+s-n)),(0,a[t].FunctionName)(r,p.resourceId,o).then(function(e){e?(e[fieldNames.Optimization_Request.Status__c]!=customLabels.failed?l.addNotification(a[t].NotificationHeaderText,a[t].NotificationText,function(e){l.openSObjectLink("../"+e)},e.Id):l.addNotification(customLabels.Optimization_Failed,customLabels.error_in_opt,function(e){l.openSObjectLink("../"+e)},e.Id),u.updateOptimizationRequest(e)):l.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.user_is_not_allowed_to_perform_action)}).then(function(){}).catch(function(e){console.warn(t+" failed :("),console.log(e),l.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message)}).finally(function(){}),g()}function S(){var e,t=r.getResources(),i=m.currentCrewToShow,i={},n=m.crewToServiceCrewMembers()[p.menuResource.serviceCrew];for(e in i[p.resourceId]=p.menuResource,n)i[n[e].serviceResource]=t[n[e].serviceResource],void 0===i[n[e].serviceResource].members&&(i[n[e].serviceResource].members={}),i[n[e].serviceResource].members[e]=n[e];m.currentCrewToShow=i,s.currentCrewToShow=i,g(),s.$broadcast("moveToCrewView")}function _(){t.open(p.resourceId)}function y(t){var e,i,n,s=null,r=window.__lastResourceClicked.key.split("_")[1],o=m.resourcesAndTerritories()[p.resourceId];for(e in o)o[e].serviceTerritory===r&&(s=e);if(t.visualforce)return i=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),n=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear(),a.open(t.name,t.visualforce+"?id="+p.resourceId+"&stm="+s+"&start="+i+"&end="+n),void g();c.callRemoteAction(RemoteActions.runCustomResourceAction,t.className,p.resourceId,s,scheduler._min_date,scheduler._max_date).then(function(e){return l.addNotification(t.name,e,null,null)}).catch(function(e){return l.addNotification(t.name,e.message,null,null)}),g()}return l.customActionsPromise.then(function(){var e=l.getCustomActions("resource");h.push.apply(h,_toConsumableArray(e))}),{open:function(e,t,i){(p=s.$new(!0)).menuResource=r.getResources()[e],p.resourceId=e,p.section=t,p.openResourceLightbox=v,p.runDynamicGanttFunction=f,p.hasCustomPermission=l.hasCustomPermission,p.showCrew=S,p.openResourceDayOptimizationLightbox=_,p.isCrew=!1,p.customActions=h,p.runCustomResourceAction=y,void 0!==r.getCrewResources()[e]&&(p.isCrew=!0);var n=angular.element('\n                    <div id="resourceMenu" class="resourceMenuContainer">\n                        <div class="truncate resMenuSingleAction" ng-click="openResourceLightbox()" title="'+customLabels.Details+'">\n                            <div class="resource-icon-container">\n                                <svg aria-hidden="true" class="slds-icon resMenuSingleIcon">\n                                    <use xlink:href="'+lsdIcons.info+'"></use>\n                                \u2028</svg>\n                            </div>\n                            '+customLabels.Details+'</div>\n                        <div class="truncate resMenuSingleAction" ng-click="openResourceDayOptimizationLightbox()" ng-hide="menuResource.isCapacityBased || !hasCustomPermission(\'Resource_Schedule_Optimization\')" title="'+customLabels.RDOptimize+'">\n                            <div class="resource-icon-container">\n                                <svg aria-hidden="true" class="slds-icon resMenuSingleIcon">\n                                    <use xlink:href="'+lsdIcons.magicwand+'"></use>\n                                \u2028</svg>\n                            </div>\n                            '+customLabels.RDOptimize+'</div>\n                        <div class="truncate resMenuSingleAction" ng-click="runDynamicGanttFunction(\'FixOverlaps\')" ng-hide="menuResource.isCapacityBased || !hasCustomPermission(\'Fix_Overlaps\')" title="'+customLabels.FixOverlaps+'">\n                            <div class="resource-icon-container">\n                                <svg aria-hidden="true" class="slds-icon resMenuSingleIcon">\n                                    <use xlink:href="'+lsdIcons.crossfilter+'"></use>\n                                \u2028</svg>\n                            </div>\n                            '+customLabels.FixOverlaps+'</div>\n                        <div class="truncate resMenuSingleAction" ng-click="runDynamicGanttFunction(\'FillInSchedule\')" ng-hide="!hasCustomPermission(\'Fill_in\')" title="'+customLabels.Fill_in_Schedule+'">\n                            <div class="resource-icon-container">\n                                <svg aria-hidden="true" class="slds-icon resMenuSingleIcon">\n                                    <use xlink:href="'+lsdIcons.summarydetail+'"></use>\n                                \u2028</svg>\n                            </div>\n                            '+customLabels.Fill_in_Schedule+'\n                        </div>\n                        <div class="truncate resMenuSingleAction" ng-click="showCrew()" ng-show="isCrew" title="'+customLabels.showCrewAndHisMemebers+'">\n                            <div class="resource-icon-container">\n                                <svg aria-hidden="true" class="slds-icon crew-icon-menu">\n                                    <use xlink:href="'+lsdIcons.crew+'"></use>\n                                \u2028</svg>\n                            </div>\n                            '+customLabels.showCrew+'\n                        </div>                    \n                        \n                        <div ng-repeat="action in customActions" class="truncate resMenuSingleAction" ng-click="runCustomResourceAction(action)" title="{{action.name}}">\n                        \n                            <div class="resource-icon-container">\n                                <svg aria-hidden="true" class="slds-icon customResourceAction" ng-show="action.icon">\n                                    <use xlink:href="{{action.icon}}"></use>\n                                \u2028</svg>\n                            </div>\n                        \n                            {{action.name}}\n                        </div>\n                    </div>\n                '),e=(t=$($(i).closest(".resourceMenuBtn"))).offset(),i=$(window).width()-(e.left+t.outerWidth());angular.element("body").append(n),$(".resourceMenuContainer").css({top:e.top}),d.isRtlDirection()?$(".resourceMenuContainer").css({right:i}):$(".resourceMenuContainer").css({left:e.left}),p.$on("$destroy",function(){return n.remove()}),angular.element("body").on("mousedown",function(e){for(var t=["resMenuSingleAction"],i=0;i<t.length;i++)if(e.target.classList.contains(t[i])||e.target.parentNode&&e.target.parentNode.classList.contains(t[i]))return;g(),e.stopPropagation(),angular.element("body").off("mousedown")}),o(n)(p),l.safeApply(p)}}}e.$inject=["$rootScope","ResourcesAndTerritoriesService","$compile","utils","ResourceLightboxService","sfdcService","StateService","DeltaService","TimePhasedDataService","rdOptimizeLightboxService","GeneralLightbox"],angular.module("serviceExpert").factory("ResourceSmallMenu",e)}(),!function(){function e(s,e){var r={territories:s.defer(),resources:s.defer(),operatingHours:s.defer()},o={},a={},l={},c=[],d={},u={},m={};function t(){var i=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,n=s.defer();return e.GetResourcesAndTerritories().then(function(e){i&&i(),n.resolve();var t=e.withoutSharingTerritories.reduce(function(e,t){return e[t.Id]=t,e},{});e.territories.forEach(function(e){e.IsActive&&(o[e.Id]=new ServiceTerritory(e),o[e.Id].hasSharing=!t[e.Id]),a[e.Id]=new ServiceTerritory(e)}),e.resources.forEach(function(e){l[e.Id]=new ServiceResource(e),l[e.Id].isCapacityBased&&c.push(e.Id),l[e.Id].serviceCrew&&(u[e.Id]=e,m[l[e.Id].serviceCrew]=e)}),e.operatingHours.forEach(function(e){d[e.Id]=new OperatingHours(e)}),r.territories.resolve(o),r.resources.resolve(l),r.operatingHours.resolve(d),window.setSplashScreenTabDone("loading-territories")}).catch(function(e){n.reject(e),r.resources.reject(),r.territories.reject(),r.operatingHours.reject(),console.warn("GetResourcesAndTeritorries: unable to load resources, territories, or operating hours"),bootstrap.handleError(e)}),n.promise}return t(),{promises:{territories:function(){return r.territories.promise},resources:function(){return r.resources.promise},operatingHours:function(){return r.operatingHours.promise}},territories:function(){return o},allTerritories:a,getResources:function(){return l},operatingHours:d,getOperatingHours:function(){return d},getCapacityBasedResources:function(){return c},getCrewResources:function(){return u},getCrewToResources:function(){return m},contractorResources:function(){return c},crewResources:function(){return u},crewToResources:function(){return m},getResourceAndTerritories:t,getResourceAndTerritoriesFromJson:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,i=s.defer(),n=(scheduler.clearAll(),o={},a={},l={},c=[],d={},u={},m={},e&&e(),i.resolve(),[]);return t.Territories.forEach(function(e){o[e.Id]=new ServiceTerritoryOptiViewer(e),a[e.Id]=new ServiceTerritoryOptiViewer(e),n.push(e.OperatingHours)}),t.Resources.forEach(function(e){l[e.Id]=new ServiceResourceOptiViewer(e),e.ServiceTerritories.records.forEach(function(e){e.OperatingHours&&n.push(e.OperatingHours)}),l[e.Id].isCapacityBased&&c.push(e.Id),l[e.Id].serviceCrew&&(u[e.Id]=e,m[l[e.Id].serviceCrew]=e)}),n.forEach(function(e){d[e.Id]=new OperatingHoursOptiViewer(e,t.CalendarDays)}),r.territories.resolve(o),r.resources.resolve(l),r.operatingHours.resolve(d),i.promise},reset:function(){o={},l={},d={},c=[],u={},m={}}}}e.$inject=["$q","sfdcService"],angular.module("serviceExpert").factory("ResourcesAndTerritoriesService",e)}(),!function(){function e(i,n,s,o,a,l,c,d,u,m,p,h,e,g){var v=null;function f(){switch(v.selectedTab){case"account":return v.lightboxService.accountId||v.lightboxService.id;case"wo":return v.lightboxService.parentRecord||v.lightboxService.id;default:return v.lightboxService.id}}function S(e){return!("wo"!==e||"WorkOrder"!==v.lightboxService.parentRecordType||!fieldTrackingEnabled.workorder)||(!("wo"!==e||"WorkOrderLineItem"!==v.lightboxService.parentRecordType||!fieldTrackingEnabled.woli)||!("service"!==e||!fieldTrackingEnabled.service))}function _(e){return e===l.LINEITEM||e===l.WORKORDER}function y(){c.setLightBoxStatus(!1),v.killWatch&&v.killWatch(),v.$destroy()}function b(e){e!==v.selectedTab&&(v.selectedTab=e)}return{open:function(e){var r,t;(v=i.$new(!0)).lightboxService=n.serviceAppointments()[e],v.selectedTab="service",v.urls={service:s.trustAsResourceUrl(customLightboxPage+"?id="+e).toString()},v.lightboxService&&(v.lightboxService.accountId&&(v.urls.account=s.trustAsResourceUrl(customAccountLightbox+"?id="+v.lightboxService.accountId).toString()),v.urls.service_chatter=s.trustAsResourceUrl(customServiceChatterLightbox+"?id="+v.lightboxService.id).toString(),v.lightboxService.parentRecordType===l.WORKORDER?(v.urls.wo=s.trustAsResourceUrl(customWoLightbox+"?id="+v.lightboxService.parentRecord).toString(),v.urls.wo_chatter=s.trustAsResourceUrl(customWoChatterLightbox+"?id="+v.lightboxService.parentRecord).toString(),v.urls.related=s.trustAsResourceUrl(customWoRelatedLightbox+"?id="+v.lightboxService.parentRecord).toString(),(v.lightboxService.isBundle||v.lightboxService.isBundleMember)&&(v.urls.bundle=s.trustAsResourceUrl("vf0008_bundlerdetailslightbox?id="+v.lightboxService.id).toString())):v.lightboxService.parentRecordType===l.LINEITEM?(v.urls.wo=s.trustAsResourceUrl(customWoliLightbox+"?id="+v.lightboxService.parentRecord).toString(),v.urls.wo_chatter=s.trustAsResourceUrl(customWoliChatterLightbox+"?id="+v.lightboxService.parentRecord).toString(),v.urls.related=s.trustAsResourceUrl(customWoliRelatedLightbox+"?id="+v.lightboxService.parentRecord).toString()):v.lightboxService.parentRecordType===l.ACCOUNT?(v.urls.related=null,v.urls.account=s.trustAsResourceUrl(customAccountLightbox+"?id="+v.lightboxService.parentRecord).toString()):v.urls.related=null,v.urls.custom1=CustomServiceTab1?s.trustAsResourceUrl(CustomServiceTab1+"?id="+v.lightboxService.id).toString():null,v.urls.custom2=CustomServiceTab2?s.trustAsResourceUrl(CustomServiceTab2+"?id="+v.lightboxService.id).toString():null,v.changeTab=b,v.isChatterAvailable=S,v.closeLightbox=y,v.chatterAvailable=fieldTrackingEnabled.service,v.openConsoleTab=a.openConsoleTab,v.isMapEnabled=c.isMapEnabled(),v.selectedSubTabWo="details",v.selectedSubTabService="details",v.showWOTab=_,v.getIdOfObjectInActiveTab=f,v.isMapEnabled&&(v.serviceIcon=staticResources.wo_icon_png,v.resourceIcon=lsdIcons.user,v.lastSeenLabel=customLabels.Last_seen,v.getServiceInfoRowClass=a.getServiceInfoRowClass,v.currentMarker={},v.map=null,v.mapControl={zoom:19,center:{latitude:0,longitude:0}},v.allMarkersArray=[],v.mapOptions={zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},streetViewControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},mapTypeControlOptions:{position:google.maps.ControlPosition.RIGHT_TOP}},v.infoWindowOptions={service:{pixelOffset:new google.maps.Size(0,-38)},livePos:{pixelOffset:new google.maps.Size(0,-38)}},v.serviceInfoWindow={show:!1},v.livePosInfoWindow={show:!1},m.fieldsSetFields().then(function(e){v.serviceFields=e.MapInfo}),null!=v.lightboxService.latitude&&null!=v.lightboxService.longitude&&(r=u(function(){if(!v.mapControl||v.mapControl.getGMap){u.cancel(r),v.map=v.mapControl.getGMap();var e=staticResources.service_png;v.lightboxService.statusCategory==g.COMPLETED&&(e=staticResources.service_completed_png),v.allMarkersArray.push({id:v.lightboxService.id,icon:e,type:"service",coords:{latitude:v.lightboxService.latitude,longitude:v.lightboxService.longitude},item:v.lightboxService});var t,i=p.lastKnownPositions();for(t in i){n=void 0;s=void 0;n=void 0;var n=i[t];var s=h.getResources()[n.id],n={id:n.id+"_position",icon:staticResources.livepos_png,type:"lastKnownPosition",resourceId:n.id,coords:{latitude:n.latitude,longitude:n.longitude},item:angular.extend(angular.copy(n),{resourceName:s.name})};v.allMarkersArray.push(n)}e=new google.maps.LatLng(v.lightboxService.latitude,v.lightboxService.longitude);v.map.setCenter(e)}},500)),v.openLink=function(e,t){a.openLink(e,t)},v.markerCloseClicked=function(){v.serviceInfoWindow.show=!1,v.livePosInfoWindow.show=!1,v.$apply()},v.markerClicked=function(e,t,i){var n=i.type;switch(v.serviceInfoWindow.show=!1,v.livePosInfoWindow.show=!1,v.currentMarker=i,n){case"service":v.serviceInfoWindow.show=!0;break;case"lastKnownPosition":v.livePosInfoWindow.show=!0}d(function(){v.$apply(),a.setMapCloseButtonPosition()},0)},v.killWatch=v.$watch("selectedTab",function(e){"map"==e&&d(function(){google.maps.event.trigger(v.map,"resize")},0)})),v.$on("$destroy",function(){return t.remove()}),v.$on("keypress",function(e,t){27==t.which&&v.$evalAsync(v.closeLightbox)}),(t=angular.element('<div class="LightboxBlackContainer">\n                <div class="LightboxContainer" id="ServiceLightbox">\n\n                    <div class="lightboxHeaderContainer" id="ServiceLightboxHeader">\n\n                        <svg fsl-key-press tabindex="0" ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n\n                        <h1 class="lightboxHeader">{{lightboxService.name}}</h1>\n\n                        <button fsl-tab-switch role="tab" ng-click="changeTab(\'service\')" ng-class="{lightboxSelectedTab: selectedTab == \'service\'}">\n                            '+customLabels.Service+'\n                        </button>\n\n                        <button fsl-tab-switch role="tab" ng-show="urls.bundle" ng-click="changeTab(\'bundle\')" ng-class="{lightboxSelectedTab: selectedTab == \'bundle\'}">\n                            '+customLabels.Bundle+'\n                        </button>\n\n                        <button fsl-tab-switch role="tab" ng-if="lightboxService.parentRecord && showWOTab(lightboxService.parentRecordType)" ng-click="changeTab(\'wo\')" ng-class="{lightboxSelectedTab: selectedTab == \'wo\'}">\n                            <div ng-show="lightboxService.parentRecordType === \'WorkOrder\'">'+customLabels.WorkOrder+"</div>\n                            <div ng-show=\"lightboxService.parentRecordType === 'WorkOrderLineItem'\">"+customLabels.Woli+'</div>\n                        </button>\n\n                        <button fsl-tab-switch role="tab" ng-show="urls.related" ng-click="changeTab(\'relatedList\')" ng-class="{lightboxSelectedTab: selectedTab == \'relatedList\'}">\n                            '+customLabels.Related+'\n                        </button>\n\n                        <button fsl-tab-switch role="tab" ng-if="isMapEnabled" ng-show="lightboxService.latitude && lightboxService.longitude" ng-click="changeTab(\'map\')" ng-class="{lightboxSelectedTab: selectedTab == \'map\'}">\n                            '+customLabels.Map+'\n                        </button>\n\n                        <button fsl-tab-switch role="tab" ng-show="urls.account" ng-click="changeTab(\'account\')" ng-class="{lightboxSelectedTab: selectedTab == \'account\'}">\n                            '+customLabels.Account+'\n                        </button>\n                        \n                        <button fsl-tab-switch role="tab" ng-show="urls.custom1" ng-click="changeTab(\'customTab1\')" ng-class="{lightboxSelectedTab: selectedTab == \'customTab1\'}">\n                            '+customLabels.CustomServiceTab1+'\n                        </button>\n                        \n                        <button fsl-tab-switch role="tab" ng-show="urls.custom2" ng-click="changeTab(\'customTab2\')" ng-class="{lightboxSelectedTab: selectedTab == \'customTab2\'}">\n                            '+customLabels.CustomServiceTab2+'\n                        </button>\n\n                        <div class="ExtendedForm">\n                            <a ng-click="openConsoleTab($event,getIdOfObjectInActiveTab())" target="_blank" href="../{{ getIdOfObjectInActiveTab() }}" title="'+customLabels.ExtandedForm+'">\n                                <svg aria-hidden="true" class="slds-icon openExternalIcon">\n                                    \u2028<use xlink:href="'+lsdIcons.external+'"></use>\n                                \u2028</svg>\n                            </a>\n                        </div>\n\n                    </div>\n                   \n                    <div class="InnerWoTabs" ng-show="isChatterAvailable(\'service\') && selectedTab == \'service\'">\n                        <button class="InnerLightboxTab" fsl-tab-switch role="tab" ng-class="{\'selected\': selectedSubTabService == \'details\'}" ng-click="selectedSubTabService=\'details\'"}">'+customLabels.Details+'</button>\n                        <button class="InnerLightboxTab" fsl-tab-switch role="tab" ng-class="{\'selected\': selectedSubTabService == \'feed\'}" ng-click="selectedSubTabService=\'feed\'">'+customLabels.Feed+'</button>\n                        <div class="InnerLightboxHr"></div>\n                    </div>\n                    \n                    <div class="InnerWoTabs" ng-show="isChatterAvailable(\'wo\') && selectedTab == \'wo\'">\n                        <button class="InnerLightboxTab" fsl-tab-switch role="tab" ng-class="{\'selected\': selectedSubTabWo == \'details\'}" ng-click="selectedSubTabWo=\'details\'"}">'+customLabels.Details+'</button>\n                        <button class="InnerLightboxTab" fsl-tab-switch role="tab" ng-class="{\'selected\': selectedSubTabWo == \'feed\'}" ng-click="selectedSubTabWo=\'feed\'">'+customLabels.Feed+'</button>\n                        <div class="InnerLightboxHr"></div>\n                    </div>\n                    \n                    <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'wo\' && selectedSubTabWo == \'details\'" ng-class="{\'SubTabsIframe\' : isChatterAvailable(\'wo\')}" ng-if="lightboxService.parentRecord && showWOTab(lightboxService.parentRecordType)" ng-src="{{ urls.wo }}"></iframe>\n                    <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'wo\' && selectedSubTabWo == \'feed\'" ng-class="{\'SubTabsIframe\' : isChatterAvailable(\'wo\')}" ng-if="lightboxService.parentRecord && showWOTab(lightboxService.parentRecordType)" ng-src="{{ urls.wo_chatter }}"></iframe>\n                    \n                    <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'service\' && selectedSubTabService == \'details\'" ng-class="{\'SubTabsIframe\' : isChatterAvailable(\'service\')}"  ng-src="{{ urls.service }}"></iframe>\n                    <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'service\' && selectedSubTabService == \'feed\'" ng-class="{\'SubTabsIframe\' : isChatterAvailable(\'service\')}"  ng-src="{{ urls.service_chatter }}"></iframe>\n                    \n                    <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'relatedList\' && urls.related" ng-src="{{ urls.related }}"></iframe>  \n                    <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'account\' && urls.account" ng-src="{{ urls.account }}"></iframe>\n                    \n                    <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'bundle\' && urls.bundle" ng-src="{{ urls.bundle }}"></iframe>\n\n\n                    <iframe onLoad="removeLightboxLoading()" ng-if="urls.custom1" ng-show="selectedTab == \'customTab1\'" ng-src="{{ urls.custom1 }}"></iframe>\n                    <iframe onLoad="removeLightboxLoading()" ng-if="urls.custom2" ng-show="selectedTab == \'customTab2\'" ng-src="{{ urls.custom2 }}"></iframe>\n                    \n                    \n                    \n                    <div id="lightbox-loading-cover">\n                        <img src="'+lsdIcons.spinnerGif+'" />\n                        '+customLabels.loading+'\n                    </div>\n                    \n                 \n                    <section ng-if="isMapEnabled" id="serviceLightboxMap" ng-show ="selectedTab == \'map\'">\n                        <ui-gmap-google-map pan="false" control="mapControl" center="mapControl.center" options="mapOptions" zoom="mapControl.zoom" class="map-canvas">\n                            <ui-gmap-markers click="markerClicked" models="allMarkersArray" idKey="id" coords="\'coords\'" icon="\'icon\'">\n                            </ui-gmap-markers>\n\n                            <ui-gmap-window show="serviceInfoWindow.show" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.service" >\n                                    <div class="googleMapInfoWindowService">\n                                        <img class="mapTooltipIcon" ng-src="{{serviceIcon}}"/>\n                                        <h1 class="truncate mapTooltipTitle">{{currentMarker.item | displayFieldSetField : serviceFields[0] }}</h1>\n\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[1] || serviceFields[1]">{{serviceFields[1].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[1])" ng-class="getServiceInfoRowClass(serviceFields[1])">{{currentMarker.item | displayFieldSetField : serviceFields[1]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[2] || serviceFields[2]">{{serviceFields[2].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[2])" ng-class="getServiceInfoRowClass(serviceFields[2])">{{currentMarker.item | displayFieldSetField : serviceFields[2]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[3] || serviceFields[3]">{{serviceFields[3].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[3])" ng-class="getServiceInfoRowClass(serviceFields[3])">{{currentMarker.item | displayFieldSetField : serviceFields[3]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[4] || serviceFields[4]">{{serviceFields[4].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[4])" ng-class="getServiceInfoRowClass(serviceFields[4])">{{currentMarker.item | displayFieldSetField : serviceFields[4]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[5] || serviceFields[5]">{{serviceFields[5].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[5])" ng-class="getServiceInfoRowClass(serviceFields[5])">{{currentMarker.item | displayFieldSetField : serviceFields[5]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[6] || serviceFields[6]">{{serviceFields[6].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[6])" ng-class="getServiceInfoRowClass(serviceFields[6])">{{currentMarker.item | displayFieldSetField : serviceFields[6]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[7] || serviceFields[7]">{{serviceFields[7].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[7])" ng-class="getServiceInfoRowClass(serviceFields[7])">{{currentMarker.item | displayFieldSetField : serviceFields[7]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[8] || serviceFields[8]">{{serviceFields[8].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[8])" ng-class="getServiceInfoRowClass(serviceFields[8])">{{currentMarker.item | displayFieldSetField : serviceFields[8]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[9] || serviceFields[9]">{{serviceFields[9].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[9])" ng-class="getServiceInfoRowClass(serviceFields[9])">{{currentMarker.item | displayFieldSetField : serviceFields[9]}}</span></div>\n\n                                    </div>\n                            </ui-gmap-window>\n\n                            <ui-gmap-window show="livePosInfoWindow.show" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.livePos">\n                                <div class="googleMapInfoWindowLivePos">\n                                    <svg aria-hidden="true" class="slds-icon livePosTooltipIcon">\n                                    \u2028\t<use xlink:href="{{resourceIcon}}"></use>\n                                \u2028\t</svg>\n                                    <h1 class="truncate mapTooltipTitle" ng-bind="$parent.$parent.$parent.currentMarker.item.resourceName"></h1>\n                                    <div>{{lastSeenLabel}} {{ currentMarker.item.lastModifiedDate | amDateFormat:\'lll\' }}</div>\n                                </div>\n                            </ui-gmap-window>\n                        </ui-gmap-google-map>\n                    </section>\n\n                </div>\n            </div>')).find("#ServiceLightbox").draggable({containment:"document",handle:"#ServiceLightboxHeader"}),c.setLightBoxStatus(),o(t)(v),a.safeApply(v,function(){angular.element("body").append(t)}))}}}e.$inject=["$rootScope","TimePhasedDataService","$sce","$compile","utils","PARENT_RECORD_TYPE","StateService","$timeout","$interval","FieldSetFieldsService","LastKnownPositionService","ResourcesAndTerritoriesService","SERVICE_STATUS","SERVICE_CATEGORY"],angular.module("serviceExpert").factory("ServiceAppointmentLightboxService",e)}(),!function(){function e(r,e,i,t,n,s,o){var a={},l=e.filter,c=[],d={};function u(e,t,i,n){var s=n&&n[t.selectedFilter]&&n[t.selectedFilter].old;return useNewFilters&&!s?r("servicesListFilterNew")(e,t,i):r("servicesListFilter")(e,t,i,n)}function m(){for(var e in a)a[e]=!1}return n.register("services",function(e){e.deleted&&e.deleted.forEach(function(e){return delete a[e]})}),o.fieldsSetFields().then(function(e){c=e.ListColumns}),{SelectedServices:a,unselectAll:m,selectAll:function(){d=u(i.serviceAppointments(),l,c,s.getFilterMap());for(var e=0;e<d.length;e++)a[d[e].id]=!0},selectViolations:function(){m();var e=angular.copy(l);e.selectedFilter="Violating","Custom filter"==l.selectedFilter&&(e.endDate=l.advancedFilter.maxDate),d=u(i.serviceAppointments(),l,c,s.getFilterMap()),d=u(d,e,c,s.getFilterMap());for(var t=0;t<d.length;t++)d[t].violations&&(a[d[t].id]=!0)},selectInJeopardy:function(){m();var e=angular.copy(l);e.selectedFilter="inJeopardy","Custom filter"==l.selectedFilter&&(e.endDate=l.advancedFilter.maxDate),d=u(i.serviceAppointments(),l,c,s.getFilterMap()),d=u(d,e,c,s.getFilterMap());for(var t=0;t<d.length;t++)d[t].jeopardy&&(a[d[t].id]=!0)},selectUnscheduled:function(){m();var e=angular.copy(l);e.selectedFilter="Unscheduled","Custom filter"==l.selectedFilter&&(e.endDate=l.advancedFilter.maxDate),d=u(i.serviceAppointments(),l,c,s.getFilterMap()),d=u(d,e,c,s.getFilterMap());for(var t=0;t<d.length;t++)d[t].isScheduled&&!d[t].isScheduled()&&(a[d[t].id]=!0)},countSelectedServices:function(){var e,t=0;for(e in a)a[e]&&t++;return t},getSelected:function(){var e,t=[];for(e in a)a[e]&&t.push(e);return t}}}e.$inject=["$filter","servicesService","TimePhasedDataService","sfdcService","RegisterService","GanttFilterService","FieldSetFieldsService"],angular.module("serviceExpert").factory("ServiceSelectorService",e)}(),!function(){function e(e,i,d){var n=[],s={skills:e.defer()};return{getSkills:function(){return n},doesHaveSkills:function(e,t){for(var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null,s=d.getResources()[e],r=0,o=(t=Array.isArray(t)?t:[t]).length;r<o;r++){var a=s.skills[t[r]];if(!a)return!1;if(Array.isArray(a)){for(var l=!1,c=0;c<a.length;c++)i&&n&&isIntersect(i,n,a[c].effectiveStartDate,a[c].effectiveEndDate)&&(l=!0);if(!l)return!1}else if(i&&n&&!isIntersect(i,n,a.effectiveStartDate,a.effectiveEndDate))return!1}return!0},doesHaveSomeSkills:function(e,t){for(var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null,s=d.getResources()[e],r=0,o=(t=Array.isArray(t)?t:[t]).length;r<o;r++){var a=s.skills[t[r]];if(a){if(Array.isArray(a))for(var l=0;l<a.length;l++)if(i&&n&&isIntersect(i,n,a[l].effectiveStartDate,a[l].effectiveEndDate))return!0;if(i&&n&&isIntersect(i,n,s.skills[t[r]].effectiveStartDate,s.skills[t[r]].effectiveEndDate))return!0}}return!1},getSkillsFromSfdc:function(){var t=e.defer();return i.callRemoteAction(RemoteActions.getSkills).then(function(e){n=e,t.resolve(t),s.skills.resolve(n)}).catch(function(e){t.reject(t),s.skills.reject(e),console.log(e),console.warn("unable to get skill list")}),t.promise},promises:{skills:function(){return s.skills.promise}}}}e.$inject=["$q","sfdcService","ResourcesAndTerritoriesService"],angular.module("serviceExpert").factory("SkillsService",e)}(),!function(){function e(e,t,i){var n={},s=0,r=!1;if(i.GetUserSettingsProperty("Toggled_Territories__c"))try{var o,a=JSON.parse(i.GetUserSettingsProperty("Toggled_Territories__c"));for(o in a)n[o]=a[o]}catch(e){console.warn("could not parse JSON - Toggled_Territories__c")}var l={policies:e.defer()};var i=userLocale?userLocale.split("_")[0]:"en",c=[];var d=!1;t.callRemoteAction(RemoteActions.getPolicies).then(function(e){c.push.apply(c,_toConsumableArray(e)),0<c.length?l.policies.resolve(c):l.policies.reject("no policies found")}).catch(function(e){l.policies.reject(e)});var u=!1;var m=!1;function p(){return m}var h,g={minDate:null,maxDate:null};return document.addEventListener("mousemove",function(){return s=0}),window.Worker&&((h=new Worker(window.__gantt.InactivityMonitorWorker)).onmessage=function(e){(s+=10)>=window.__gantt.maxSecondsOfInactivity&&!r&&(r=!0,console.warn("Dispatcher Console: User is inactive, disconnecting."),m&&$.cometd.disconnect(),h.terminate())}),{isOptimizationEnabled:isOptimizationEnabled,lang:i,isOSX:function(){return-1!=window.navigator.userAgent.indexOf("Mac OS X")},isRtlDirection:function(){return"rtl"===document.querySelector("html").getAttribute("dir")},isInConsole:function(){return"undefined"!=typeof sforce?sforce.console.isInConsole():null},policies:c,selectedPolicyId:null,areContractorsSupported:function(){return contractorSupport},isMapEnabled:function(){return mapMode},setLightBoxStatus:function(){u=!(0<arguments.length&&void 0!==arguments[0])||arguments[0]},isLightboxOpened:function(){return u},setBulkActionRunning:function(){d=!(0<arguments.length&&void 0!==arguments[0])||arguments[0]},isBulkActionRunning:function(){return d},schedulingRunningFor:{},isScheduleRunning:!1,ganttOpenedTerritories:n,areCrewsSupported:function(){return!0},getStreamingActiveState:p,setStreamingActiveState:function(e){m=e},setDeltaDates:function(e,t){e=[moment(e),moment(t)],g.minDate&&(e.push(moment(g.minDate)),e.push(moment(g.maxDate))),g.minDate=moment.min(e).toDate(),g.maxDate=moment.max(e).toDate()},getDeltaDates:function(){return null!==g.minDate&&null!==g.maxDate?{minDate:g.minDate.getTime(),maxDate:g.maxDate.getTime()}:{minDate:null,maxDate:null}},isUserIdle:function(){return r},promises:{policies:function(){return l.policies.promise}}}}e.$inject=["$q","sfdcService","userSettingsManager"],angular.module("serviceExpert").factory("StateService",e)}(),!function(){function e(o,a,e,l,c,d,u){var m={services:[],absences:[],capacities:[],positions:[],optimizationRequests:[],rules:[]},p=!1,h=new Set,g=new Set,v=new Set,f=new Set,S=new Set,_=new Set,y=new Set,b=new Set,w=new Set,T=new Set;return{HandleNotification:function(e){if(p||(p=!0,setTimeout(function(){(e={}).deletedAbsencesArray=Array.from(h),e.updatedAbsencesArray=Array.from(g),e.deletedGanttServicesArray=Array.from(v),e.updatedGanttServicesArray=Array.from(f),e.deletedCapacitiesArray=Array.from(S),e.updatedCapacitiesArray=Array.from(_),e.resourcesIdsArray=Array.from(y),e.updatedAssignResourceArray=Array.from(b),e.updatedOptimizationRequestArray=Array.from(w),e.deletedTimeDependencyArray=Array.from(T);p=!1,h.clear(),g.clear(),v.clear(),f.clear(),S.clear(),_.clear(),y.clear(),b.clear(),w.clear(),T.clear();var t,i,e,n=[];{var s,r;0!=e.updatedOptimizationRequestArray.length&&n.push(function(e){var i=o.defer();return a.getOptimiztionRequestsUpdate(e).then(function(t){d.isOptimizationEnabled&&t&&0<t.length&&m.optimizationRequests.forEach(function(e){return e(t)}),i.resolve()}),i.promise}(e.updatedOptimizationRequestArray)),0!=e.updatedAssignResourceArray.length&&n.push(function(e){var n=o.defer();return a.getGanttServiceOnAssignedResourceUpdate(e).then(function(e){var t,i=[];e&&0<e.length&&(t={},0<e.length&&(t.updated=l.updateTimePhaseData(e,"service").services,i.push.apply(i,_toConsumableArray(u.getRelatedServices(u.getIdsOfSObjects(t.updated))))),t.updated&&m.services.forEach(function(e){return e(t)})),n.resolve(i)}),n.promise}(e.updatedAssignResourceArray)),0!=e.resourcesIdsArray.length&&n.push(function(e){var i=o.defer();return a.getLivePositionsStreaming(e).then(function(e){var t=c.updatePositions(e);t.isUpdated&&m.positions.forEach(function(e){return e(t.dic)}),i.resolve()}),i.promise}(e.resourcesIdsArray)),0!=e.updatedCapacitiesArray.length&&n.push(function(e){var i=o.defer();return a.getUpdatedResourceCapacities(e).then(function(e){var t;e&&0<e.length&&((t={}).updated=l.updateTimePhaseData(e,"capacity").capacities,t.updated&&m.capacities.forEach(function(e){return e(t)})),i.resolve()}),i.promise}(e.updatedCapacitiesArray)),0==e.updatedGanttServicesArray.length&&0==e.deletedTimeDependencyArray.length||n.push(function(e,t){var n=o.defer();return a.getUpdatedServices(e,t).then(function(e){var t,i=[];e&&0<e.length&&(t={},0<e.length&&(t.updated=l.updateTimePhaseData(e,"service").services,i.push.apply(i,_toConsumableArray(u.getRelatedServices(u.getIdsOfSObjects(t.updated))))),t.updated&&m.services.forEach(function(e){return e(t)})),n.resolve(i)}),n.promise}(e.updatedGanttServicesArray,e.deletedTimeDependencyArray)),0!=e.updatedAbsencesArray.length&&n.push(function(e){var n=o.defer();return a.getUpdatedAbsences(e).then(function(e){var t=[],i={};0<e.length&&(e=l.updateTimePhaseData(e,"na"),i.updated=e.absences,i.deleted=e.notApprovedAbsencesIds,e=i.updated.map(function(e){return e.resource}).join(","),t.push.apply(t,_toConsumableArray(u.getRelatedServices(u.getIdsOfSObjects(i.updated),e))),t.push.apply(t,_toConsumableArray(u.getRelatedServices(i.deleted))),(i.updated||i.deleted)&&m.absences.forEach(function(e){return e(i)})),n.resolve(t)}),n.promise}(e.updatedAbsencesArray)),0!=e.deletedAbsencesArray.length&&n.push(function(e){var n=o.defer();return a.getDeletedAbsences(e).then(function(e){var t=[],i={};0<e.length&&(i.deleted=l.deleteTimePhaseData(e,"na").absences,t.push.apply(t,_toConsumableArray(u.getRelatedServices(i.deleted))),(i.updated||i.deleted)&&m.absences.forEach(function(e){return e(i)})),n.resolve(t)}),n.promise}(e.deletedAbsencesArray)),0!=e.deletedGanttServicesArray.length&&(s=e.deletedGanttServicesArray,r=[],s&&0<s.length&&((t={}).deleted=l.deleteTimePhaseData(s,"service").services,r.push.apply(r,_toConsumableArray(u.getRelatedServices(t.deleted))),t.deleted&&m.services.forEach(function(e){return e(t)}),0<r.length&&m.rules.forEach(function(e){return e(r)})))}0!=e.deletedCapacitiesArray.length&&(s=e.deletedCapacitiesArray)&&0<s.length&&((i={}).deleted=l.deleteTimePhaseData(s,"capacity").capacities,i.deleted&&m.capacities.forEach(function(e){return e(i)}));0!=n.length&&o.all(n).then(function(e){e.forEach(function(e){var t;(t=e)&&0<t.length&&m.rules.forEach(function(e){return e(t,window.__gantt.checkRulesAfterDelta)})})})},0)),-1<e.channel.indexOf("AbsencesTopic"))try{return void("deleted"==e.data.event.type?h:g).add(e.data.sobject.Id)}catch(e){console.log("Streaming API failure : "+e)}if(-1<e.channel.indexOf("ServicesTopic"))try{return void("deleted"==e.data.event.type?v.add(e.data.sobject):f.add(e.data.sobject.Id))}catch(e){console.log("Streaming API failure : "+e)}if(-1<e.channel.indexOf("CapacitiesTopic"))try{return void("deleted"==e.data.event.type?S.add(e.data.sobject):_.add(e.data.sobject.Id))}catch(e){console.log("Streaming API failure : "+e)}if(-1<e.channel.indexOf("LivePositionsTopic"))try{return void y.add(e.data.sobject.Id)}catch(e){console.log("Streaming API failure : "+e)}if(-1<e.channel.indexOf("AssignedResourcesTopic"))try{return void b.add(e.data.sobject.Id)}catch(e){console.log("Streaming API failure : "+e)}if(-1<e.channel.indexOf("OptReqTopic"))try{return void w.add(e.data.sobject.Id)}catch(e){console.log("Streaming API failure : "+e)}if(-1<e.channel.indexOf("TimeDependencyTopic"))try{return void("deleted"==e.data.event.type?T.add(e.data.sobject.Id):(f.add(e.data.sobject[fieldNames.TimeDependency.ServiceAppointment1]),f.add(e.data.sobject[fieldNames.TimeDependency.ServiceAppointment2])))}catch(e){console.log("Streaming API failure : "+e)}},register:function(e,t){return m[e]&&m[e].push(t)},unRegister:function(e,t){m[e].splice(m[e].indexOf(t),1)}}}e.$inject=["$q","sfdcService","$interval","TimePhasedDataService","LastKnownPositionService","StateService","utils"],angular.module("serviceExpert").factory("StreamingAPIService",e)}(),!function(){function e(e,i,t,n,s){var r=["ServicesTopic","AbsencesTopic","AssignedResourcesTopic","LivePositionsTopic","CapacitiesTopic","OptReqTopic","TimeDependencyTopic"];function o(){$.cometd.addListener("/meta/handshake",function(e){if(e.successful){console.log("Handshake successful!");try{for(var t=0;t<r.length;t++)$.cometd.getExtension(r[t])||!function(e){var t="/topic/"+e,i=new cometdReplayExtension;i.setChannel(t),i.setReplay(-1),$.cometd.registerExtension(e,i)}(r[t]),$.cometd.subscribe("/topic/"+r[t],i.HandleNotification)}catch(e){console.log(e)}n.setStreamingActiveState(!0)}else n.setStreamingActiveState(!1),console.warn("Handshake! error: "+e.error)}),$.cometd.addListener("/meta/connect",function(e){e.successful?n.setStreamingActiveState(!0):(console.warn("disconnected! error: "+e.error),n.setStreamingActiveState(!1))}),t.connectToPush()}return{initStreaming:function(){try{1==n.getStreamingActiveState()?o():t.connectToPush()}catch(e){console.log(e)}}}}e.$inject=["$q","StreamingAPIService","MstResolver","StateService","DeltaService"],angular.module("serviceExpert").factory("StreamingClientResolverService",e)}(),!function(){function e(c,T,L,A,I){var C={initialPhasedData:c.defer(),initialStmsPhasedData:c.defer()},k={},D={},R={},O={},F={},M={},P={},x={},E={},N={},G={},t={},B={},d=!1,u=!0,H=!0,V=!0,n=!1;function s(t,i){var n=c.defer(),e=("LongView"!==scheduler._mode&&(t.setDate(t.getDate()-window.daysToLoadOnGanttInit),i.setDate(i.getDate()+window.daysToLoadOnGanttInit)),0===t.getMinutes()&&0===t.getHours()||(t.setHours(0),t.setMinutes(0)),0===i.getMinutes()&&0===i.getHours()||(i.setHours(0),i.setMinutes(0),i.setDate(i.getDate()+1)),"LongView"===scheduler._mode);if("LongView"!==scheduler._mode)for(var s=new Date(t);s<i;s.setDate(s.getDate()+1))if(!G[A.formatDayToString(s)]){e=!0;break}if(!e)return n.resolve(),n.promise;var r=c.defer(),o=c.defer(),a=[],l=c.defer();return u?L.callRemoteAction(RemoteActions.maximumRowsOnGanttReached,t,i,window.bootstrap.loadedUserSettings.locations).then(function(e){e?(d=!0,$("#FirstTimeLoading").remove(),I.get("LeftSideLocationFilteringService").open()):l.resolve(),window.splunkLoggingFinestFlagEnabled&&L.callRemoteAction(RemoteActions.sendDataToSplunk,"rowsOnGantt",t,i,window.bootstrap.loadedUserSettings.locations,null,null)}):l.resolve(),l.promise.then(function(){U(o,t,i,!1,!1,null,null,null),U(r,t,i,!0,!1,null,null,null,a),U(o,t,i,!1,!0,null,null,null),u?u=!1:L.callRemoteAction(RemoteActions.maximumRowsOnGanttReached,t,i,window.bootstrap.loadedUserSettings.locations).then(function(e){e&&A.addNotification(customLabels.MaxedRowsReachedOnGanttNotificationTitle,customLabels.MaxedRowsReachedOnGanttNotificationBody)})}),c.all([o.promise,r.promise]).then(function(e){0<Object.keys(a).length&&"Always"===window.__gantt.checkRulesMode&&T.$broadcast("timePhasedObjectsCheckRules",a),n.resolve(e)}),n.promise}function U(f,S,_,y,b,e,t,i,w){e=[S,_,y,b,e,t,i];"LongView"===scheduler._mode&&e.push(window.__currentViewOptions.minServiceDuration,window.__currentViewOptions.minNaDuration,window.__currentViewOptions.showMdt),L.GetTimePhasedObjects.apply(L,e).then(function(e){var t,i=f,n=y,s=b,r=S,o=_,a=w,l=I.get("monthlyViewHelperService"),c=I.get("GanttPalettesService"),d={resourcesAndTerritories:{},resourcesByPrimariesAndRelocations:{},resourceOperatingHours:{},serviceAppointments:{},resourceAbsences:{},resourceCapacities:{},resourcesAndShifts:{},serviceCrewMembers:{},operatingHoursAndHolidays:{},start:r,finish:o},u={};if("LongView"===scheduler._mode&&(n?(window.__gantt.reachedMaxNumberOfServicesInLongView=!!e.maxServicesInLongTermExceeded,window.splunkLoggingFinestFlagEnabled&&H&&(L.callRemoteAction(RemoteActions.sendDataToSplunk,"servicesInLongTermView",r,o,A.getFilteredLocations(),window.__currentViewOptions.minServiceDuration,window.__currentViewOptions.showMdt),H=!1)):s&&(window.__gantt.reachedMaxNumberOfAbsencesInLongView=!!e.maxAbsencesInLongTermExceeded,window.splunkLoggingFinestFlagEnabled&&V&&(L.callRemoteAction(RemoteActions.sendDataToSplunk,"absencesInLongTermView",r,o,A.getFilteredLocations(),window.__currentViewOptions.minNaDuration,null),V=!1)),updateViewDebounced()),"LongView"!==scheduler._mode)for(var m=new Date(r);m<o;m.setDate(m.getDate()+1))G[A.formatDayToString(m)]=!0;if(0===C.initialPhasedData.promise.$$state.status&&C.initialPhasedData.resolve(),e.resourcesAndTerritories.forEach(function(e){e=new ResourcesAndTerritories(e);k[e.serviceResource]=k[e.serviceResource]||{},k[e.serviceResource][e.id]=e,d.resourcesAndTerritories[e.serviceResource]=d.resourcesAndTerritories[e.serviceResource]||{},"S"!==(d.resourcesAndTerritories[e.serviceResource][e.id]=e).serviceTerritoryType&&(D[e.serviceResource]=D[e.serviceResource]||{},D[e.serviceResource][e.id]=e,d.resourcesByPrimariesAndRelocations[e.serviceResource]=d.resourcesByPrimariesAndRelocations[e.serviceResource]||{},d.resourcesByPrimariesAndRelocations[e.serviceResource][e.id]=e),"P"!==e.serviceTerritoryType&&(u[e.serviceResource]=u[e.serviceResource]||{},u[e.serviceResource][e.id]=e)}),0<Object.keys(u).length){var p,h,g={},v={};for(p in R)u[R[p].resource]&&0<Object.keys(u[R[p].resource]).length&&(g[p]=R[p]);for(h in O)u[O[h].resource]&&0<Object.keys(u[O[h].resource]).length&&(v[h]=O[h]);T.$broadcast("gotNewTimePhasedObjects",{start:r,finish:o,serviceAppointments:g,resourceAbsences:v})}e.shifts.forEach(function(e){var t=new Shift(e);M[e.ServiceResourceId]||(M[e.ServiceResourceId]={}),M[e.ServiceResourceId][A.formatDayToString(t.startTime)]||(M[e.ServiceResourceId][A.formatDayToString(t.startTime)]=[]),M[e.ServiceResourceId][A.formatDayToString(t.startTime)].push(t)}),e.holidays.forEach(function(e){var i=new Holiday(e);(e.OperatingHoursHolidays||[]).forEach(function(e){var t,e=e.OperatingHoursId;e&&(B[e]||(B[e]={}),t=A.formatDayToString(i.date),B[e][t]||(B[e][t]=[]),B[e][t].push(i))})}),e.services.forEach(function(e){var t=new GanttService(e);c.updateGanttServicePaletteColor(t),(!R[t.id]||R[t.id].isChanged(t)||R[t.id].isChainChanged(t)||R[t.id].isGotNewSTM(t))&&(R[e.Id]=t,d.serviceAppointments[e.Id]=t,a.push(t.id),(monthlyViewSettings.isMonthlyAvailable&&!scheduler._events[t.id]||scheduler._events[e.Id])&&l.updateMonthlyCapacity(t))}),e.resourceAbsences.forEach(function(e){O[e.Id]&&e.LastModifiedDate===O[e.Id].lastModifiedDate||(O[e.Id]=new ResourceAbsence(e),d.resourceAbsences[e.Id]=O[e.Id],l.updateMonthlyCapacity(O[e.Id]))}),e.resourceCapacities.forEach(function(e){F[e.Id]&&e.LastModifiedDate===F[e.Id].lastModifiedDate||(F[e.Id]=new ResourceCapacity(e),useLocationTimezone||z(F[e.Id]),d.resourceCapacities[e.Id]=F[e.Id])}),e.serviceCrewMembers.forEach(function(e){if(P[e.Id]=new ServiceCrewMember(e),x[P[e.Id].serviceResource]||(x[P[e.Id].serviceResource]={}),E[P[e.Id].serviceCrew]||(E[P[e.Id].serviceCrew]={}),E[P[e.Id].serviceCrew][e.Id]=P[e.Id],x[P[e.Id].serviceResource][e.Id]=P[e.Id],d.serviceCrewMembers[e.Id]=P[e.Id],T.crewViewActive){var t,i;for(i in N=T.currentCrewToShow)if(N[i].serviceCrew){t=N[i].serviceCrew;break}e.ServiceCrewId===t&&(N[e.ServiceResourceId]||(N[e.ServiceResourceId]=ResourcesAndTerritoriesService.getResources()[e.ServiceResourceId]),void 0===N[e.ServiceResourceId].members&&(N[e.ServiceResourceId].members={}),N[e.ServiceResourceId].members[e.Id]=P[e.Id])}}),T.$broadcast("gotNewTimePhasedObjects",d),n&&e.services.length===maxServicesToLoadEachBulkInGantt?(t=e.services[e.services.length-1].Id,U(i,r,o,n,s,t,null,null,a)):s&&e.resourceAbsences.length===maxAbsencesToLoadEachBulkInGantt?(t=e.resourceAbsences[e.resourceAbsences.length-1].Id,U(i,r,o,n,s,null,t,null)):!n&&!s&&e.shifts.length>=maxShiftsToLoadEachBulkInGantt?(t=e.shifts[e.shifts.length-1].Id,U(i,r,o,n,s,null,null,t)):!n&&!s&&e.shifts.length<maxShiftsToLoadEachBulkInGantt?T.$broadcast("gotNewTimePhasedSTMsAndShifts",d):i.resolve(),y||(window.setSplashScreenTabDone("loading-timephased"),C.initialStmsPhasedData.resolve())}).catch(function(e){var t;if(0===C.initialPhasedData.promise.$$state.status&&C.initialPhasedData.reject(e),console.warn("GetTimePhasedObjects: something went wrong "+e.message),A.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action),0===numberOfAllowedRecoveries)return console.log("maximum allowed times to recover reached"),void($("#loading-timephased")&&!n&&(e.message.startsWith("No such column")&&e.message.endsWith(". If you are attempting to use a custom field, be sure to append the '__c' after the custom field name. Please reference your WSDL or the describe call for the appropriate names.")?(t=e.message.split("'"),cantLoadGantt(customLabels.dispatcher_console_error_loading+'<div class="otherMessage">'+customLabels.Deleted_field_in_settings_crashes_the_gantt.replace("$0",t[1]).replace("$1",t[3])+"</div>")):bootstrap.handleError(e),n=!0));numberOfAllowedRecoveries--,y?(maxServicesToLoadEachBulkInGantt=Math.round(maxServicesToLoadEachBulkInGantt/2),console.log("%c getTimePhasedObjects - ENTERING RECOVERY MODE - NOW LOADING: "+maxServicesToLoadEachBulkInGantt+" SERVICES","background: #222; color: #bada55")):b?(maxAbsencesToLoadEachBulkInGantt=Math.round(maxAbsencesToLoadEachBulkInGantt/2),console.log("%c getTimePhasedObjects - ENTERING RECOVERY MODE - NOW LOADING: "+maxAbsencesToLoadEachBulkInGantt+" ABSENCES","background: #222; color: #bada55")):y||(maxShiftsToLoadEachBulkInGantt=Math.round(maxShiftsToLoadEachBulkInGantt/2),console.log("%c getTimePhasedObjects - ENTERING RECOVERY MODE - NOW LOADING: "+maxShiftsToLoadEachBulkInGantt+" SHIFTS","background: #222; color: #bada55")),s(S,_)})}function z(e){var t=A.getUserOffset(e.start_date),i=A.getUserOffset(e.end_date),n=r(e,e.resource);e.start_date=e.start_date.setMinutes(e.start_date.getMinutes()+t-n),e.end_date=e.end_date.setMinutes(e.end_date.getMinutes()+i-n)}function i(t,i){Object.keys(t).forEach(function(e){i&&e===i||delete t[e]})}function r(e,t){var i,n=k[t],s=null;for(i in n){var r=n[i];if(isIntersect(r.effectiveStartDate,r.effectiveEndDate,e.start_date,e.end_date)&&"R"===(s=r).serviceTerritoryType)break}t=s&&s.timezone?s.timezone:"GMT";return-moment.tz.zone(t).utcOffset(A.convertDtToMomentDt(e.start_date,t).valueOf())}return{resourcesAndTerritories:function(){return k},resourcesByPrimariesAndRelocations:function(){return D},serviceAppointments:function(){return R},resourceAbsences:function(){return O},resourceCapacities:function(){return F},resourceToServiceCrewMembers:function(){return x},resourcesAndShifts:function(){return M},crewToServiceCrewMembers:function(){return E},serviceCrewMembers:function(){return P},operatingHoursAndHolidays:function(){return B},getlongVistedDates:function(){return t},getGanttSectionsIdsByTerritory:function(e,t){var i,n={};for(i in k)for(var s in k[i]){s=k[i][s];e[s.serviceTerritory]&&s.effectiveStartDate<=t&&t<=s.effectiveEndDate&&(n[s.serviceTerritory]||(n[s.serviceTerritory]={tz:s.timezone,resources:{}}),n[s.serviceTerritory].resources[i]=!0)}return n},getRelevantSTMToGanttService:function(e){if(e.resourceId){var t,i=e.resourceId.split("_")[0],n=(e.resourceId.split("_")[1],k[i]);for(t in n){var s=n[t];if(isIntersect(s.effectiveStartDate,s.effectiveEndDate,e.start_date,e.end_date))return s}}return null},getTimePhasedObjects:s,updateTimePhaseData:function(e,i){var n=2<arguments.length&&void 0!==arguments[2]&&arguments[2],s=I.get("monthlyViewHelperService"),r=I.get("GanttPalettesService"),o={absences:[],notApprovedAbsencesIds:[],services:[],capacities:[]};return(e=Array.isArray(e)?e:[e]).forEach(function(e){if("na"===i){if(n||O[e.Id]&&e.LastModifiedDate===O[e.Id].lastModifiedDate)return;var t=new ResourceAbsence(e);window.isApprovedAbsencesSupported&&!t.approved&&"break"!==t.type?(O[e.Id]&&(O[e.Id].isDeleted=!0,s.updateMonthlyCapacity(O[e.Id]),delete O[e.Id]),o.notApprovedAbsencesIds.push(e.Id)):(O[e.Id]=t,o.absences.push(O[e.Id]),s.updateMonthlyCapacity(O[e.Id]))}if("service"===i&&(t=new GanttService(e),r.updateGanttServicePaletteColor(t),(n||!R[t.id]||R[t.id].isChanged(t)||R[t.id].isChainChanged(t))&&(R[e.Id]=t,o.services.push(t),scheduler._events[t.id]&&scheduler._events[t.id].violations&&t.isScheduled()&&(t.violations=scheduler._events[t.id].violations),(monthlyViewSettings.isMonthlyAvailable&&!scheduler._events[t.id]||scheduler._events[e.Id])&&s.updateMonthlyCapacity(t))),"capacity"===i){if(F[e.Id]&&e.LastModifiedDate===F[e.Id].lastModifiedDate)return;F[e.Id]=new ResourceCapacity(e),useLocationTimezone||z(F[e.Id]),o.capacities.push(F[e.Id])}"stm"===i&&(t=new ResourcesAndTerritories(e),k[t.serviceResource]=k[t.serviceResource]||{},"S"!==(k[t.serviceResource][t.id]=t).serviceTerritoryType&&(D[t.serviceResource]=D[t.serviceResource]||{},D[t.serviceResource][t.id]=t))}),T.$broadcast("updateTimePhaseData",o.services),o},deleteTimePhaseData:function(e,t){var i=I.get("monthlyViewHelperService"),n={absences:[],services:[],capacities:[]};return(e=Array.isArray(e)?e:[e]).forEach(function(e){"na"===t?(O[e.Id]&&(O[e.Id].isDeleted=!0),O[e.Id]&&i.updateMonthlyCapacity(O[e.Id]),delete O[e.Id],n.absences.push(e.Id)):"service"===t?(R[e.Id]&&(R[e.Id].isDeleted=!0),i.updateMonthlyCapacity(R[e.Id]),delete R[e.Id],n.services.push(e.Id)):"capacity"===t&&(delete F[e.Id],n.capacities.push(e.Id))}),T.$broadcast("deleteTimePhaseData",n.services),n},reset:function(e){i(k),i(D),i(R,e),i(O),i(F),i(P),i(M),i(N),i(x),i(E),i(G),i(t),i(B)},getResoruceGanttIdByDate:function(e,t){for(var i in k[e]){i=k[e][i];if(i.effectiveStartDate<=t&&t<=i.effectiveEndDate&&"R"===i.serviceTerritoryType)return A.generateResourceId(e,i.serviceTerritory)}var n,s=[];for(n in k[e]){var r=k[e][n];if(!showSecondarySTMs&&r.effectiveStartDate<=t&&t<=r.effectiveEndDate&&"P"===r.serviceTerritoryType)return A.generateResourceId(e,r.serviceTerritory);r.effectiveStartDate<=t&&t<=r.effectiveEndDate&&s.push(r.serviceTerritory)}return 0<s.length?A.generateResourceId(e,s):null},getResoruceGanttIdByDateAndTerritory:function(e,t,i){for(var n in k[e]){n=k[e][n];if(n.effectiveStartDate<=t&&t<=n.effectiveEndDate&&"R"===n.serviceTerritoryType)return A.generateResourceId(e,n.serviceTerritory)}var s,r=null,o=null;for(s in k[e]){var a=k[e][s];a.effectiveStartDate<=t&&t<=a.effectiveEndDate&&"P"===a.serviceTerritoryType&&(o=a.serviceTerritory),a.effectiveStartDate<=t&&t<=a.effectiveEndDate&&a.serviceTerritory===i&&(r=a.serviceTerritory)}return r?A.generateResourceId(e,r):A.generateResourceId(e,o)},getIntersectingSrstOffset:r,isTimephaseAvailable:function(e,t){var i,n=!1;for(i in k[e]){var s=k[e][i];isIntersect(t,t,s.effectiveStartDate,s.effectiveEndDate)&&(n=!0)}return n},isResourceRelocated:function(e,t){var i,n=e.split("_")[0],s=e.split("_")[1],r=k[n]||{};for(i in r){var o=r[i];if(o.serviceTerritory!==s&&"R"===o.serviceTerritoryType&&isIntersect(o.effectiveStartDate,o.effectiveEndDate,t,t))return!0}return!1},isResourceSecondary:function(e,t){var i,n=e.split("_")[0],s=e.split("_")[1],r=k[n]||{};for(i in r){var o=r[i];if(o.serviceTerritory===s&&"S"===o.serviceTerritoryType&&isIntersect(o.effectiveStartDate,o.effectiveEndDate,t,t))return!0}return!1},isResourceCrewMembers:function(e,t){var i,n=e.split("_")[0],s=(e.split("_")[1],x[n]||{});for(i in s){var r=s[i];if(isIntersect(r.startDate,r.endDate,t,t))return!0}return!1},isCrewViewActive:!1,currentCrewToShow:N,reachedMaxRows:function(){return d},resetReachedMaxRows:function(e){return d=!1},promises:{initialPhasedData:C.initialPhasedData.promise,initialStmsPhasedData:C.initialStmsPhasedData.promise},updateObjectsForOptimizationViewer:function(e){R=e.serviceAppointments,k=e.resourcesAndTerritories,O=e.resourceAbsences,M=e.resourcesAndShifts,P=e.serviceCrewMembers,E=e.crewToServiceCrewMembers,x=e.resourceToServiceCrewMembers},isOptimizationViewer:function(){return T.isOptimizationViewer},setResourceCapacityOffset:z}}e.$inject=["$q","$rootScope","sfdcService","utils","$injector","ResourcesAndTerritoriesService"],angular.module("serviceExpert").factory("TimePhasedDataService",e)}(),!function(){function e(p,h,g){var v={total:0,completed:0,violations:0,jeopardy:0,avgTravelTime:0,totalScheduledDuration:0};return{calculateKpis:function(){var e,t=scheduler.getEvents(scheduler.getState().min_date,scheduler.getState().max_date),i=0;for(e in v)v[e]=0;for(var n=g.GetUserSettingsProperty("locations"),s=0;s<t.length;s++){var r,o,a=t[s],l=!0;if(showSecondarySTMs&&-1<t[s].resourceId.indexOf(",")){for(var c=t[s].resourceId.split(","),d=null,u=0;u<c.length;u++){var m=c[u].split("_")[1];if(-1<n.indexOf(m)){d=m;break}}if(!d)continue}else if(-1===n.indexOf(t[s].resourceId.split("_")[1]))continue;"na"===a.type&&(v.avgTravelTime+=a.travelTo+a.travelFrom),"service"===a.type&&(p.areContractorsSupported()&&a.resourceContractor?l=!1:i++,v.total++,a.statusCategory===h.COMPLETED&&v.completed++,a.violations&&v.violations++,a.jeopardy&&v.jeopardy++,l&&(a.isMDT?(r=0,a.mdtTimes.travel.forEach(function(e){scheduler._min_date<=e.Start&&e.Finish<=scheduler._max_date&&(r+=e.Finish-e.Start)}),v.avgTravelTime+=r/1e3):v.avgTravelTime+=a.travelTo+a.travelFrom),a.isMDT?(o=0,a.mdtTimes.working.forEach(function(e){scheduler._min_date<=e.Start&&e.Finish<=scheduler._max_date&&(o+=e.Finish-e.Start)}),v.totalScheduledDuration+=o/1e3):v.totalScheduledDuration+=(a.finish-a.start)/1e3)}0<t.length&&0<v.total&&0<i?p.areContractorsSupported()?v.avgTravelTime=Math.floor(v.avgTravelTime/60/i):v.avgTravelTime=Math.floor(v.avgTravelTime/60/v.total):v.avgTravelTime=0},kpis:v}}e.$inject=["StateService","SERVICE_CATEGORY","userSettingsManager"],angular.module("serviceExpert").factory("kpiCalculationsService",e)}(),!function(){function e(u,i,t,n,l,s,a,e,r){var m={regular:0,overtime:0},p={},h={},g={services:!0,na:!0,travel:!0,breaks:!0,overtime:!0},c=r.isRtlDirection();if(e.GetUserSettingsProperty("Utilization_Properties__c")){var o,d=JSON.parse(e.GetUserSettingsProperty("Utilization_Properties__c"));for(o in d)g[o]=d[o]}function v(e){if(-1<e.resourceId.indexOf(","))for(var t=e.resourceId.split(","),i=0;i<t.length;i++)p[t[i]]=p[t[i]]||{};else p[e.resourceId]=p[e.resourceId]||{};var n={start:new Date(e.start_date),finish:new Date(e.start)},s={start:new Date(e.start),finish:new Date(e.finish)},r={start:new Date(e.finish),finish:new Date(e.end_date)};return{travelBeforeSum:e.isMDT?f(e.mdtTimes.travel):f(n.start,n.finish),scheduledObjectSum:e.isMDT?f(e.mdtTimes.working):f(s.start,s.finish),travelAfterSum:e.isMDT?{}:f(r.start,r.finish)}}function f(e,n){var s={};if(!n)return e.forEach(function(e){n=new Date(e.Finish);for(var t=new Date(e.Start);t<n;t=y(t)){var i=y(t),i=n<i?n:i;s[S(t)]?s[S(t)]+=Math.round((i.getTime()-t.getTime())/1e3/60):s[S(t)]=Math.round((i.getTime()-t.getTime())/1e3/60)}}),s;for(var t=new Date(e);t<n;t=y(t)){var i=y(t),i=n<i?n:i;s[S(t)]=Math.round((i.getTime()-t.getTime())/1e3/60)}return s}function S(e){return e.getDate()+"_"+e.getMonth()+"_"+e.getFullYear()}function y(e){return new Date(e.getFullYear(),e.getMonth(),e.getDate()+1,0,0,0,0)}function b(e,t,i,n,s){for(var r,o=!(4<arguments.length&&void 0!==s)||s,a=t.split(","),l=0;l<a.length;l++)for(var c in t=a[l],i)p[t]=p[t]||{},void 0===p[t][c]&&(p[t][c]=new w),o?(p[t][c][n]+=i[c],-1===p[t][c].events.indexOf(e)&&p[t][c].events.push(e)):(p[t][c][n]-=i[c],-1<(r=p[t][c].events.indexOf(e))&&p[t][c].events.splice(r,1))}function w(){this.break=0,this.na=0,this.service=0,this.travel=0,this.capacity=-1,this.overtime=0,this.events=[]}function T(e,t){for(var i=new w,n=S(t),s=i.capacity=0;s<e.length;s++){var r,o=null,a=e[s].key;contractorSupport&&e[s].contractor||l.isResourceRelocated(a,t)||l.isResourceCrewMembers(a,t)||l.isResourceSecondary(a,t)||(p[a]||(p[a]={}),(o=p[a][n]?p[a][n]:o)||(p[a][n]=new w,o=p[a][n]),o.capacity,r=m,u.resourceToWorkingDates[a]&&u.resourceToWorkingDates[a][n]&&(r=u.resourceToWorkingDates[a][n]),o&&(i.break+=o.break,i.na+=o.na>r.regular?r.regular:o.na,i.service+=o.service,i.travel+=o.travel,i.capacity+=-1<r.regular?r.regular:0,i.overtime+=r.overtime))}return i}function L(e){var t=e%60;return{hours:Math.floor(e/60),minutes:t=t<10?"0"+t:t}}function A(e){return e.hours+"h "+e.minutes+"m"}function I(e,t,i){var n,i=2<arguments.length&&void 0!==i?i:m;e.service&&(n=L(e.service),t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.clock+'"></use></svg>\n                        '+A(n)+"\n                        <div>"+customLabels.TotalScheduled+"</div>\n                    </div>"),e.travel&&(n=L(e.travel),t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon monthly_travel_icon"><use xlink:href="'+lsdIcons.travel+'"></use></svg>\n                        '+A(n)+"\n                        <div>"+customLabels.TotalTravel+"</div>\n                    </div>"),e.na&&(n=L(e.na),t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.na+'"></use></svg>\n                        '+A(n)+"\n                        <div>"+customLabels.TotalNAs+"</div>\n                    </div>"),e.break&&(n=L(e.break),t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon monthly_travel_icon"><use xlink:href="'+lsdIcons.coffee+'"></use></svg>\n                        '+A(n)+"\n                        <div>"+customLabels.TotalBreaks+"</div>\n                    </div>"),e.capacity,e.overtime;return i.regular&&(n=L(i.regular),t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.bucket+'"></use></svg>\n                        '+A(n)+"\n                        <div>"+customLabels.TotalCapacity+"</div>\n                    </div>"),i.overtime&&(e=L(i.overtime),t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon monthly_overtime_icon"><use xlink:href="'+lsdIcons.overtime+'"></use></svg>\n                        '+A(e)+"\n                        <div>"+customLabels.TotalOvertime+"</div>\n                    </div>"),t}return scheduler.attachEvent("onSchedulerReady",function(){scheduler.attachEvent("onXScaleClick",function(e,t,i){"MonthlyView"===scheduler._mode&&scheduler.setCurrentView(t,"ZoomLevel3")}),scheduler.templates.MonthlyView_scalex_class=function(e){return"monthlyXScale"},scheduler.templates.MonthlyView_cell_value=function(e,t){var i=t.key;if(!contractorSupport||!t.contractor){if(t.children)return l=T(t.children,e),h[t.key]||(h[t.key]={}),l=h[t.key][S(e)]=l,n=t.key,s=t.name,o=S(e),a=0,g.services&&(a+=l.service),g.breaks&&(a+=l.break),g.na&&(a+=l.na),g.travel&&(a+=l.travel),0<(c=g.overtime?l.capacity+l.overtime:l.capacity)?(a=a/c,a=Math.round(100*a),d="",d=a<=monthlyViewSettings.high?"style='box-shadow: inset 0 -2px 0 rgb(24, 165, 146)'":a>monthlyViewSettings.high&&a<=monthlyViewSettings.critical?"style='box-shadow: inset 0 -2px 0 #FFEB3B'":"style='box-shadow: inset 0 -2px 0 rgb(236, 95, 84)'",r="",l.travel/c>monthlyViewSettings.highTravel/100&&(r='<svg aria-hidden="true" class="tooMuchTravel slds-icon"><use xlink:href="'+lsdIcons.travel+'"></use></svg>'),"<div "+d+' onmouseout="removeMonthlyLocationTooltip()" onmouseover="createLocationMonthlyTooltip(event,\''+n+"', '"+s.encodeHTML()+"', '"+o+"')\">"+r+'<div class="monthlyViewHoursContainer">'+a+"%</div></div>"):"";if(p[i]&&p[t.key][S(e)]){var n,s,r,o,a,l=0,c=p[i][S(e)],d=m;if(u.resourceToWorkingDates[i]&&(d=u.resourceToWorkingDates[i][S(e)]||m),g.services&&(l+=c.service),g.breaks&&(l+=c.break),g.na&&(n=c.na,l+=n=c.na>d.regular?d.regular:n),g.travel&&(l+=c.travel),0===l);else return s=void 0,o=void 0,r=g.overtime?d.regular+d.overtime:d.regular,0<r?(o=Math.round(100*(o=l/r)),a="",c.travel/r>monthlyViewSettings.highTravel/100&&(a='<svg aria-hidden="true" class="tooMuchTravel slds-icon"><use xlink:href="'+lsdIcons.travel+'"></use></svg>'),s="",s=o<=monthlyViewSettings.high?"rgba(125, 195, 125, "+o/100+")":o>monthlyViewSettings.high&&o<=monthlyViewSettings.critical?"rgba(242, 207, 91, "+(.11+o/100*.65)+")":"rgba(239, 110, 100, "+(.11+o/100*.65)+")",'<div class="utilz-container" onclick="createMonthlyTooltip(event, \''+i+"', '"+S(e)+'\')" style="background: '+s+'">'+a+'<div class="monthlyViewHoursContainer">'+o+"%</div></div>"):(s="rgba(239, 110, 100, 1)",'<div class="utilz-container" onclick="createMonthlyTooltip(event, \''+i+"', '"+S(e)+'\')" style="background: '+s+'"><div class="monthlyViewHoursContainer"><i class="fa fa-ban"></i></div></div>')}}}}),window.createLocationMonthlyTooltip=function(e,t,i,n){$("#MonthlyLocationViewTooltip").remove(),$("#MonthlyViewTooltip").remove();var t=h[t][n],t=I(t,"",{regular:t.capacity,overtime:t.overtime}),n=n.split("_"),n=new Date(n[2],n[1],n[0],0,0,0,0),s=(n=moment(n).format("ll"),window.innerHeight),r=window.innerWidth,r=e.clientX+340<=r?e.clientX:e.clientX-340,i=($('<div id="MonthlyLocationViewTooltip">\n                    <h1>'+_.escape(i)+" - "+_.escape(n)+'</h1>\n                    <div id="CapacityIconsContainer">'+t+"</div>\n               </div>").css("left",r+"px").css("top",e.clientY+5+"px").appendTo("body"),$("#MonthlyViewTooltip")),n=i.height();n+e.clientY>s&&i.css("top",e.clientY-n-20+"px"),c&&$("#MonthlyLocationViewTooltip").addClass("rtlDirection")},window.removeMonthlyLocationTooltip=function(){$("#MonthlyLocationViewTooltip").remove()},window.createMonthlyTooltip=function(e,t,i){e.stopPropagation(),$("#MonthlyViewTooltip").remove(),$("#MonthlyLocationViewTooltip").remove();var n=a.getResources()[t.split("_")[0]].name,s=p[t][i],r=m,r=(t=I(s,"",r=u.resourceToWorkingDates[t]&&u.resourceToWorkingDates[t][i]?u.resourceToWorkingDates[t][i]:r),s.events.sort(function(e,t){return scheduler._events[e].start_date.getTime()>scheduler._events[t].start_date.getTime()?-1:scheduler._events[e].start_date.getTime()<scheduler._events[t].start_date.getTime()?1:0}).map(function(e){var t="",i="",n=(scheduler._events[e]&&"service"===scheduler._events[e].type?(t="__monthlyViewFunctions.service('"+e+"')",i="<div onclick=\"__monthlyViewFunctions.flag(event, '"+e+'\')" class="monthlyViewFlag truncate">'+(flaggedServices[e]?customLabels.Unflag:customLabels.Flag)+"</div>"):t="__monthlyViewFunctions.absence('"+e+"')"," "),s=(n=(n+=scheduler._events[e]&&scheduler._events[e].jeopardy?"monthlyView_JeopardyTooltip":"")+(scheduler._events[e]&&scheduler._events[e].violations&&!scheduler._events[e].jeopardy?"monthlyView_ViolationsTooltip":""),""),r=(scheduler._events[e]&&"break"!==scheduler._events[e].type&&(s=""+A(L(s=Math.floor((scheduler._events[e].travelTo+scheduler._events[e].travelFrom)/60))),s='<svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.travel+'"></use></svg> '+s),Math.floor((scheduler._events[e].finish-scheduler._events[e].start)/1e3/60)),r=""+A(L(r)),o=(r='<svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.clock+'"></use></svg> '+r,""===s?"mytooltip_breakfix":"");return'\n                        <div class="'+n+' monthlyView_TooltipEventRow" title="'+(n=scheduler._events[e],customLabels.Start+": "+moment(n.start).format("llll")+"\n"+customLabels.Finish+": "+moment(n.finish).format("llll"))+'">\n                            <div class="monthlyView_EventName" onclick="'+t+'">'+scheduler._events[e].name+'</div>\n                            <div class="monthlyView_EventDate"><span class="mytooltip_duration '+o+'">'+r+'</span><span class="mytooltip_travel">'+s+"</span>"+i+"</div>\n                        </div>"})),s=i.split("_"),s=new Date(s[2],s[1],s[0],0,0,0,0),i=(s=moment(s).format("ll"),window.innerHeight),o=window.innerWidth,o=e.clientX+340<=o?e.clientX:e.clientX-340,n=($('<div id="MonthlyViewTooltip">\n                    <h1>\n                        '+_.escape(n)+" - "+s+'\n                        <svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.close+'"></use></svg>\n                    </h1>\n                    <div id="CapacityIconsContainer">'+t+'</div>\n                    <div id="MonthlyTooltipListContainer">'+r.join("")+"</div>\n               </div>").css("left",o+"px").css("top",e.clientY+5+"px").appendTo("body"),$("#MonthlyViewTooltip")),s=n.height();s+e.clientY>i&&n.css("top",e.clientY-s-20+"px"),c&&$("#MonthlyViewTooltip").addClass("rtlDirection")},$("body").on("click",function(){$("#MonthlyViewTooltip").remove()}),window.__monthlyViewFunctions={service:function(e){n.open(e)},absence:function(e){t.open(e)},flag:function(e,t){e.currentTarget.innerHTML=e.currentTarget.innerHTML===customLabels.Flag?customLabels.Unflag:customLabels.Flag,e.stopPropagation(),i.$broadcast("flagService",t),i.$apply()}},{updateMonthlyCapacity:function(e){var t,i,n;e&&(e.setGanttResource(l.resourcesAndTerritories(),s.generateResourceId),n=scheduler._events[e.id],t=null,!e.resourceId&&!n||e.isMDT&&!e.mdtTimes||(n&&(i=v(n.eventBeforeDrag||n),n.eventBeforeDrag&&(n.eventBeforeDrag=null),"service"===e.type||"na"===e.type?(t=n.resourceName===e.resourceName?e.resourceId:n.resourceBeforeDrag||n.resourceId,n.resourceBeforeDrag=null):"break"===e.type&&(t=n.resourceId),b(n.id,t,i.travelBeforeSum,"travel",!1),b(n.id,t,i.scheduledObjectSum,n.type,!1),b(n.id,t,i.travelAfterSum,"travel",!1)),!e.resourceId||e.isDeleted||e.locationRemovedMe?e.locationRemovedMe&&(e.locationRemovedMe=!1):(n=v(e),b(e.id,e.resourceId,n.travelBeforeSum,"travel"),b(e.id,e.resourceId,n.scheduledObjectSum,e.type),b(e.id,e.resourceId,n.travelAfterSum,"travel"))))},capacityCalculationFields:g,workingTimesByLocation:h,calculateLocation:T,calculateLocationUtilization:function(e){var t=0;return g.services&&(t+=e.service),g.breaks&&(t+=e.break),g.na&&(t+=e.na),g.travel&&(t+=e.travel),0<(e=g.overtime?e.capacity+e.overtime:e.capacity)?(t=t/e,Math.round(100*t)):null},calculateDailyResourceCapacity:function(e,t){var i=new w,n=null,s=S(t),r=e.key;return i.capacity=0,contractorSupport&&e.contractor||l.isResourceRelocated(r,t)||l.isResourceCrewMembers(r,t)||l.isResourceSecondary(r,t)||(p[r]||(p[r]={}),(n=p[r][s]?p[r][s]:n)||(p[r][s]=new w,n=p[r][s]),e=m,u.resourceToWorkingDates[r]&&u.resourceToWorkingDates[r][s]&&(e=u.resourceToWorkingDates[r][s]),n&&(i.break+=n.break,i.na+=n.na>e.regular?e.regular:n.na,i.service+=n.service,i.travel+=n.travel,i.capacity+=-1<e.regular?e.regular:0,i.overtime+=e.overtime)),i},reset:function(){p={},h={}}}}e.$inject=["calendarsService","$rootScope","AbsenceLightboxService","ServiceAppointmentLightboxService","TimePhasedDataService","utils","ResourcesAndTerritoriesService","userSettingsManager","StateService"],angular.module("serviceExpert").factory("monthlyViewHelperService",e)}(),!function(){var c=7500;angular.module("MstResolver",[]).provider("MstResolver",function(){var l={fslOperationRemoteAction:null,getAsyncApexJobRemoteAction:null,apiVersion:"41.0",fieldNames:{Initiator:"Initiator__c",Request_Type:"Request_Type__c",ResultText:"ResultText__c"},autoConnect:!0};this.setConfig=function(e){return l=e},this.$get=function(e){var t=e,r=l,o={},i={},n=-1;function s(){$.cometd.addListener("/meta/handshake",function(e){var t;e.successful?(console.log("Handshake successful!"),null==$.cometd.getExtension("myReplayExtensionName")&&((t=new cometdReplayExtension).setChannel("/topic/MstCompletedChannel"),t.setReplay(n),$.cometd.registerExtension("myReplayExtensionName",t)),$.cometd.subscribe("/topic/MstCompletedChannel",a)):console.warn("Handshake! error: "+e.error)}),$.cometd.addListener("/meta/connect",function(e){e.successful||console.warn("disconnected! msg: "+e)});$.cometd.init({url:window.location.protocol+"//"+window.location.hostname+(null!=window.location.port?":"+window.location.port:"")+"/cometd/"+r.apiVersion+"/",requestHeaders:{Authorization:"OAuth "+sessionId}})}function a(e){var t;"deleted"!==e.data.event.type&&(console.info("message from stream, type: "+e.data.event.type+", replayId: "+e.data.event.replayId+", fslOp: "+e.data.sobject.Id),n=e.data.event.replayId,i[e.data.sobject.Id]=e,(t=o[e.data.sobject.Id])&&t.deferred.resolve(e))}try{r.autoConnect&&s()}catch(e){console.log(e)}return{getUpdates:function(e){o[e]={time:(new Date).getTime()-3e3,deferred:t.defer(),mstPromise:t.defer(),asyncMethodCheckerTimeout:null,gotReply:!1};var s=o[e];return o[e].deferred.promise.then(function(e){r.fslOperationRemoteAction&&Visualforce.remoting.Manager.invokeAction(r.fslOperationRemoteAction,s.time,e.data.sobject.Id,function(e,t){if(t.status&&!e.fslOperation.fslOperation[r.fieldNames.ResultText]){if(e.fslOperation.result&&(e.fslOperation.result=JSON.parse(e.fslOperation.result)),"Get Candidates"===e.fslOperation.fslOperation[r.fieldNames.Request_Type]){var i,n=e.fslOperation.result.ResourceIDToScheduleData;for(i in n)n[i].SchedulingOptions.forEach(function(e){for(var t in e.Interval.Start=moment(e.Interval.Start).valueOf(),e.Interval.Finish=moment(e.Interval.Finish).valueOf(),e.MSTOptions)e.MSTOptions[t].Interval.Start=moment(e.MSTOptions[t].Interval.Start).valueOf(),e.MSTOptions[t].Interval.Finish=moment(e.MSTOptions[t].Interval.Finish).valueOf()})}"Appointment Booking"===e.fslOperation.fslOperation[r.fieldNames.Request_Type]&&e.fslOperation.result.Slots.forEach(function(e){e.Interval.Start=moment(e.Interval.Start).valueOf(),e.Interval.Finish=moment(e.Interval.Finish).valueOf()}),s.mstPromise.resolve(e)}else e&&e.fslOperation&&e.fslOperation.fslOperation?s.mstPromise.reject(e.fslOperation.fslOperation[r.fieldNames.ResultText]):s.mstPromise.reject(t);s.gotReply=!0},{buffer:!1,escape:!1,timeout:12e4})}),i[e]&&(s.deferred.resolve(i[e]),delete i[e]),o[e].asyncMethodCheckerTimeout=setInterval(function(){var i,n;n=o[i=e],Visualforce.remoting.Manager.invokeAction(r.getAsyncApexJobRemoteAction,i,function(e,t){if(!e)return clearInterval(n.asyncMethodCheckerTimeout),void(t.status||(t.xhr&&"communication failure"===t.xhr.statusText?n.mstPromise.reject({message:t.message}):n.mstPromise.reject({message:customLabels.wentWrongContactSysAdmin}),console.log(t)));"Aborted"!==e.Status&&"Failed"!==e.Status||(n.gotReply||n.mstPromise.reject({message:e.ExtendedStatus}),clearInterval(n.asyncMethodCheckerTimeout)),"Completed"===e.Status&&(n.deferred.resolve({data:{sobject:{Id:i}}}),clearInterval(n.asyncMethodCheckerTimeout))})},c),o[e].mstPromise.promise},connectToPush:s,handleCometdConnection:a}},this.$get.$inject=["$q"]})}(),GanttService.prototype.setSchedulerProperties=function(){var e,t={schedStartTime:"start",schedEndTime:"finish",dueDate:"dueDate",earliestStartTime:"earlyStart",arrivalWindowStartTime:"appStart",arrivalWindowEndTime:"appEnd",actualStartTime:"actualStartTime",actualEndTime:"actualEndTime",ganttDisplay:"ganttDisplay"};for(e in t)this[t[e]]=__setTimeZoneOffsetToDateField(this[e]);this.type="service",this.travelTo=this.travelTimeTo?60*parseInt(this.travelTimeTo):0,this.travelFrom=this.travelTimeFrom?60*parseInt(this.travelTimeFrom):0,this.estDuration=this.estDuration?parseFloat(this.estDuration):null,this.text=this.ganttLabel?this.ganttLabel.encodeHTML():this.name},GanttService.prototype.setGanttResource=function(e,t){if(this.isScheduled()){var i,n=e[this.resource],s=[];for(i in this.resourceId=null,this.start_date=__setTimeZoneOffsetToDateField(this.schedStartTime),this.end_date=__setTimeZoneOffsetToDateField(this.schedEndTime),n){var r=n[i];"R"===r.serviceTerritoryType&&(isIntersectIncludeLimits(r.effectiveStartDate,r.effectiveEndDate,this.start_date,this.end_date)||!r.effectiveEndDate&&r.effectiveStartDate<this.end_date)&&s.push(r.serviceTerritory)}if(0===s.length)for(var o in n){o=n[o];isIntersectIncludeLimits(o.effectiveStartDate,o.effectiveEndDate,this.start_date,this.start_date)&&s.push(o.serviceTerritory)}else if(showSecondarySTMs)for(var a in n){a=n[a];"S"===a.serviceTerritoryType&&isIntersectIncludeLimits(a.effectiveStartDate,a.effectiveEndDate,this.start_date,this.end_date)&&s.push(a.serviceTerritory)}this.resourceId=t(this.resource,s),this.isScheduled()&&this.updateDatesBasedOnTravel()}},GanttService.prototype.updateDatesBasedOnTravel=function(){this.resourceId&&(this.travelFrom&&(this.travelFrom<=maxTravelTimeInSeconds||(this.hiddenTravelFrom={hiddenMinutes:this.end_date.getMinutes()+Math.floor(this.travelFrom/60),hiddenTravel:this.travelFrom},this.travelFrom=maxTravelTimeInSeconds),this.end_date.setMinutes(this.end_date.getMinutes()+Math.floor(this.travelFrom/60))),this.travelTo&&(this.travelTo<=maxTravelTimeInSeconds||(this.hiddenTravelTo={hiddenMinutes:this.start_date.getMinutes()-Math.floor(this.travelTo/60),hiddenTravel:this.travelTo},this.travelTo=maxTravelTimeInSeconds),this.start_date.setMinutes(this.start_date.getMinutes()-Math.floor(this.travelTo/60))))},GanttService.prototype.isScheduled=function(){return this.resource&&this.schedEndTime&&this.schedStartTime},GanttService.prototype.getGanttResource=function(e){return e&&getGanttResourceWithSecondaryStms(this),this.resourceId&&this.resourceId.substr(0,18)},GanttService.prototype.getGanttTerritory=function(){return this.resourceId&&this.resourceId.substr(19,37)},GanttService.prototype.isChanged=function(e){return this.AssignedResourceLastModifiedDate!=e.AssignedResourceLastModifiedDate||this.ServiceAppointmentLastModifiedDate!=e.ServiceAppointmentLastModifiedDate},GanttService.prototype.isGotNewSTM=function(e){return""===this.resourceId&&e.resource},GanttService.prototype.isChainChanged=function(e){return this.isServiceInChain!=e.isServiceInChain||this.relatedService1!=e.relatedService1||this.relatedService2!=e.relatedService2},GanttService.prototype.minPriority=1e6,GanttService.copy=function(e){var t=new GanttService(null,!0);return angular.merge(t,e),t},GanttService.prototype.calculateMdtTimes=function(e){try{this.mdtTimes=JSON.parse(e);var n=1e3*(new Date).getTimezoneOffset()*60,s={travel:[],working:[]};this.mdtTimes.forEach(function(e){var t=moment.tz(e.Start,userTimeZone),i=moment.tz(e.Finish,userTimeZone),t=new Date(t.valueOf()+60*t._offset*1e3+n),i=new Date(i.valueOf()+60*i._offset*1e3+n);e.Start=t,e.Finish=i,"OperationalSlot"===e.Type?s.working.push(e):"Travel"===e.Type&&s.travel.push(e)}),this.mdtTimes=s}catch(e){this.mdtTimes={travel:[],working:[]}}},window.Holiday=function(e){this.id=e.Id,this.holidayId=e.Id,this.name=e[fieldNames.Holiday.Name],this.description=e[fieldNames.Holiday.Description],this.activityDate=e[fieldNames.Holiday.ActivityDate],this.nextOccurrenceDate=e[fieldNames.Holiday.NextOccurrenceDate],this.isAllDay=e[fieldNames.Holiday.IsAllDay],this.isRecurrence=e[fieldNames.Holiday.IsRecurrence],this.startTimeInMinutes=e[fieldNames.Holiday.StartTimeInMinutes],this.endTimeInMinutes=e[fieldNames.Holiday.EndTimeInMinutes],this.recurrenceType=e[fieldNames.Holiday.RecurrenceType],this.recurrenceInterval=e[fieldNames.Holiday.RecurrenceInterval],this.recurrenceStartDate=e[fieldNames.Holiday.RecurrenceStartDate],this.recurrenceEndDateOnly=e[fieldNames.Holiday.RecurrenceEndDateOnly],this.recurrenceDayOfMonth=e[fieldNames.Holiday.RecurrenceDayOfMonth],this.recurrenceDayOfWeekMask=e[fieldNames.Holiday.RecurrenceDayOfWeekMask],this.recurrenceMonthOfYear=e[fieldNames.Holiday.RecurrenceMonthOfYear],this.isRecurrence?this.date=new Date(this.nextOccurrenceDate):(e=60*(new Date).getTimezoneOffset()*1e3,this.date=new Date(this.activityDate+e))},!function(e){var a={Sunday:0,Monday:1,Tuesday:2,Wednesday:3,Thursday:4,Friday:5,Saturday:6};e.TimeSlot=function(e){this.startHour=Math.floor(e[fieldNames.TimeSlot.StartTime]/1e3/60/60),this.startMinute=Math.ceil(e[fieldNames.TimeSlot.StartTime]/1e3/60/60%1*60),this.endHour=Math.floor(e[fieldNames.TimeSlot.EndTime]/1e3/60/60),this.endMinute=Math.ceil(e[fieldNames.TimeSlot.EndTime]/1e3/60/60%1*60),this.type=e[fieldNames.TimeSlot.Type],0==this.endHour&&(this.endHour=24)},e.TimeSlotOptiViewer=function(e){this.startHour=parseInt(e[fieldNames.TimeSlot.StartTime].split(":")[0]),this.startMinute=parseInt(e[fieldNames.TimeSlot.StartTime].split(":")[1]),this.endHour=parseInt(e[fieldNames.TimeSlot.EndTime].split(":")[0]),this.endMinute=parseInt(e[fieldNames.TimeSlot.EndTime].split(":")[1]),this.type=e[fieldNames.TimeSlot.Type],0==this.endHour&&(this.endHour=24)},e.OperatingHours=function(e){this.id=e.Id,this.name=e.Name,this.timezone=e[fieldNames.OperatingHours.Timezone],this.slots={};for(var t=(t=e[fieldNames.OperatingHours.Time_Slots__r])||[],i=0;i<t.length;i++){var n=t[i],s=n[fieldNames.TimeSlot.DayOfWeek],r=this.slots[s=a[s]];r||(this.slots[s]=r=[]),r.push(new TimeSlot(n))}},e.OperatingHoursOptiViewer=function(e,t){this.id=e.Id,this.name=e.Id,this.timezone=e[fieldNames.OperatingHours.Timezone],this.slots={};for(var i=(i=t)||[],n=0;n<i.length;n++){var s,r=i[n],o=r[fieldNames.TimeSlot.DayOfWeek],o=a[o];r.OperatingHoursId===this.id&&((s=this.slots[o])||(this.slots[o]=s=[]),s.push(new TimeSlotOptiViewer(r)))}}}(window),ResourceAbsence.prototype.setSchedulerProperties=function(){this.start=__setTimeZoneOffsetToDateField(this.start),this.finish=__setTimeZoneOffsetToDateField(this.end),this.end=__setTimeZoneOffsetToDateField(this.end)},ResourceAbsence.prototype.setGanttResource=function(e,t){var i=e[this.resource],n=[];if(this.resourceId=null,this.isScheduled()){this.start_date=this.start?new Date(this.start.getTime()):null,this.end_date=this.finish?new Date(this.finish.getTime()):null;var s,r=!1;for(s in i){var o=i[s],r=!1;"R"===o.serviceTerritoryType&&(isIntersect(o.effectiveStartDate,o.effectiveEndDate,this.start_date,this.end_date)||!o.effectiveEndDate&&o.effectiveStartDate<this.end_date)&&((this.end_date>o.effectiveEndDate&&this.start_date<o.effectiveEndDate||this.start_date<o.effectiveStartDate&&this.end_date>o.effectiveStartDate)&&(r=!0),n.includes(o.serviceTerritory)||n.push(o.serviceTerritory))}if(0===n.length||r)for(var a in i){a=i[a];!(isIntersect(a.effectiveStartDate,a.effectiveEndDate,this.start_date,this.end_date)||!a.effectiveEndDate&&a.effectiveStartDate<this.end_date)||n.includes(a.serviceTerritory)||n.push(a.serviceTerritory)}else if(showSecondarySTMs)for(var l in i){l=i[l];"S"!==l.serviceTerritoryType||!(isIntersect(l.effectiveStartDate,l.effectiveEndDate,this.start_date,this.end_date)||!l.effectiveEndDate&&l.effectiveStartDate<this.end_date)||n.includes(l.serviceTerritory)||n.push(l.serviceTerritory)}this.resourceId=t(this.resource,n),this.isScheduled()&&this.updateDatesBasedOnTravel()}},ResourceAbsence.prototype.updateDatesBasedOnTravel=function(){this.resourceId&&(this.travelFrom&&(this.travelFrom<=maxTravelTimeInSeconds||(this.hiddenTravelFrom={hiddenMinutes:this.end_date.getMinutes()+Math.floor(this.travelFrom/60),hiddenTravel:this.travelFrom},this.travelFrom=maxTravelTimeInSeconds),this.end_date.setMinutes(this.end_date.getMinutes()+Math.floor(this.travelFrom/60))),this.travelTo&&(this.travelTo<=maxTravelTimeInSeconds||(this.hiddenTravelTo={hiddenMinutes:this.start_date.getMinutes()-Math.floor(this.travelTo/60),hiddenTravel:this.travelTo},this.travelTo=maxTravelTimeInSeconds),this.start_date.setMinutes(this.start_date.getMinutes()-Math.floor(this.travelTo/60))))},ResourceAbsence.prototype.isScheduled=function(){return!!this.resource},ResourceAbsence.prototype.getGanttResource=function(){return this.resourceId&&this.resourceId.substr(0,18)},ResourceCapacity.prototype.setSchedulerProperties=function(){switch(this.start_date=__setTimeZoneOffsetToDateField(this.start),this.end_date=__setTimeZoneOffsetToDateField(this.end),this.timePeriod){case"Day":this.end_date=addDaysToDate(this.start_date,1);break;case"Week":this.end_date=addDaysToDate(this.start_date,7);break;case"Month":this.end_date=addDaysToDate(this.end_date,1)}0<this.hoursPerTimePeriod?this.text="<b>"+customLabels.booked.replaceAll(calcCapacityPercentage(this.hoursInUse,this.hoursPerTimePeriod)+"%")+"</b> (<b>"+customLabels.x_Hours_scheduled_out_of_y.replaceAll(this.hoursInUse,this.hoursPerTimePeriod)+"</b>)":0<this.workItemsPerTimePeriod&&(this.text="<b>"+customLabels.booked.replaceAll(calcCapacityPercentage(this.workItemsAllocated,this.workItemsPerTimePeriod)+"%")+"</b> (<b>"+customLabels.NumServicesScheduled.replaceAll(this.workItemsAllocated,this.workItemsPerTimePeriod)+"</b>)"),this.type="contractorcapacity"},ResourceCapacity.prototype.setGanttResource=function(e,t){var i,n=e[this.resource],s=[];for(i in n){var r=n[i];(isIntersect(r.effectiveStartDate,r.effectiveEndDate,this.start_date,this.end_date)||!r.effectiveEndDate&&r.effectiveStartDate<this.end_date)&&s.push(r.serviceTerritory)}this.resourceId=t(this.resource,s)},ResourceCapacity.prototype.isScheduled=function(){return!!this.resource},ResourceCapacity.prototype.getGanttResource=function(){return this.resourceId&&this.resourceId.substr(0,18)},!function(e){e.Shift=function(e){this.id=e.Id,this.name=window.isOptimizationViewer?e.Id:e[fieldNames.Shift.ShiftNumber],this.label=e[fieldNames.Shift.Label]||"",this.serviceResourceId=e[fieldNames.Shift.ServiceResourceId]||null,this.serviceTerritoryId=e[fieldNames.Shift.ServiceTerritoryId]||null,this.status=window.isOptimizationViewer?e[fieldNames.Shift.StatusCategory]:e[fieldNames.Shift.Status],this.statusCategory=e[fieldNames.Shift.StatusCategory],this.timeSlotType=e[fieldNames.Shift.TimeSlotType],this.startTime=e[fieldNames.Shift.StartTime],this.endTime=e[fieldNames.Shift.EndTime],this.backgroundColor=e[fieldNames.Shift.BackgroundColor],isHolidayEnabled&&(this.isHolidayShift=e.IsHolidayShift);var e=void 0,t=void 0;this.startTime&&(e=60*new Date(this.startTime).getTimezoneOffset()*1e3),this.endTime&&(t=60*new Date(this.endTime).getTimezoneOffset()*1e3),this.startTime=new Date(this.startTime+e),this.endTime=new Date(this.endTime+t)},e.ShiftSlot=function(e){this.startTime=e.startTime,this.endTime=e.endTime,this.type=e.timeSlotType}}(window);var bootstrap={};function setSplashScreenTabDone(e){var t;setSplashScreenTabDone.doneElements[e]||(t=$("#"+e))&&(t.addClass("loading-task-done"),setSplashScreenTabDone.doneElements[e]=!0)}function handleTabSettingAndRecordTypesPermissions(c){return new Promise(function(e,t){var i=JSON.parse(c.Admin.replace(/&quot;/g,'"')),n=JSON.parse(c.Agent.replace(/&quot;/g,'"')),s=JSON.parse(c.Guest.replace(/&quot;/g,'"')),r=JSON.parse(c.Community.replace(/&quot;/g,'"')),o=JSON.parse(c.CommunityDispatcher.replace(/&quot;/g,'"')),a=JSON.parse(c.Dispatcher.replace(/&quot;/g,'"')),l=JSON.parse(c.Resource.replace(/&quot;/g,'"'));Promise.all([createTabAndRecordTypePermission("FSL_Admin","Field Service Admin",i.tabSettings,i.recordTypeVisibilities,i.apexClasses),createTabAndRecordTypePermission("FSL_Agent","Field Service Agent",n.tabSettings,n.recordTypeVisibilities,n.apexClasses),createTabAndRecordTypePermission("FSL_Dispatcher","Field Service Dispatcher",a.tabSettings,a.recordTypeVisibilities,a.apexClasses),createTabAndRecordTypePermission("FSL_Community_Self_Service","Field Service Self Service",r.tabSettings,r.recordTypeVisibilities,r.apexClasses),createTabAndRecordTypePermission("FSL_Guest_User","Field Service Guest User",s.tabSettings,s.recordTypeVisibilities,s.apexClasses),createTabAndRecordTypePermission("FSL_Community_Dispatcher","Field Service Community Dispatcher",o.tabSettings,o.recordTypeVisibilities,o.apexClasses),createTabAndRecordTypePermission("FSL_Resource","Field Service Resource",l.tabSettings,l.recordTypeVisibilities,l.apexClasses)]).then(function(){e()},function(){e()})})}function createTabAndRecordTypePermission(a,l,c,d,u){new Promise(function(n,e){for(var t=window.location.origin,i='<soapenv:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:met="http://soap.sforce.com/2006/04/metadata"><soapenv:Header><met:SessionHeader><met:sessionId>'+sessionId+'</met:sessionId></met:SessionHeader></soapenv:Header><soapenv:Body><met:updateMetadata><met:metadata xsi:type="met:PermissionSet"><fullName>'+a+"_Permissions</fullName><label>"+l+" Permissions</label>",s=0;s<c.length;s++)i+="<tabSettings><tab>"+c[s].tab+"</tab><visibility>"+c[s].visibility+"</visibility></tabSettings>";for(var r=0;r<d.length;r++)i+="<recordTypeVisibilities><recordType>"+d[r].recordType+"</recordType><visible>"+d[r].visible+"</visible></recordTypeVisibilities>";for(var o=0;o<u.length;o++)i+="<classAccesses><apexClass>"+u[o].apexClass+"</apexClass><enabled>"+u[o].enabled+"</enabled></classAccesses>";i+="</met:metadata></met:updateMetadata></soapenv:Body></soapenv:Envelope>",window.$.ajax({url:t+"/services/Soap/m/38.0",type:"POST",dataType:"xml",data:i,beforeSend:function(e){e.setRequestHeader("Content-Type","text/xml"),e.setRequestHeader("SOAPAction",'""')}}).then(function(e,t,i){n()},function(e,t,i){console.log("Failed to update permissions on load of VF"),n()})})}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}bootstrap.loadUserSettings=function(){Visualforce.remoting.Manager.invokeAction(RemoteActions.getUserSettings,function(e,t){t.status?(setSplashScreenTabDone("loading-user-setttings"),bootstrap.loadedUserSettings=JSON.parse(e.userSettings),angular.bootstrap(document.getElementById("serviceExpertApp"),["serviceExpert"]),e.isUserSettingsExist||($("#loading-timephased").remove(),$("#loading-finishing").remove())):bootstrap.handleError(t)},{buffer:!1,escape:!1,timeout:12e4})},bootstrap.Start=function(){bootstrap.UpdatePermissionSets()},bootstrap.UpdatePermissionSets=function(){Visualforce.remoting.Manager.invokeAction(RemoteActions.updatePermissionSets,function(e,t){if(e)try{handleTabSettingAndRecordTypesPermissions(e).then(function(){setSplashScreenTabDone("loading-permissions"),bootstrap.loadUserSettings()})}catch(e){console.log(e),bootstrap.loadUserSettings()}else setSplashScreenTabDone("loading-permissions"),bootstrap.loadUserSettings()})},setSplashScreenTabDone.doneElements={},bootstrap.handleError=function(e){var t,i=!1;for(t in{no_dispatcher_license_found:!0,Apex_CPU_time_limit_exceeded:!0})customLabels[t]===e.message&&(i=!0);-1<e.message.toLowerCase().indexOf("dml")?cantLoadGantt(customLabels.no_dispatcher_permissions_found.replace("{0}",'<a href="vf066_settings#page=0&tab=1" target="_blank">').replace("{1}","</a>")):cantLoadGantt(i?e.message:customLabels.dispatcher_console_error_loading+'<div class="otherMessage">'+e.message+"</div>")},bootstrap.UpdatePermissionSetsBootstrap=function(i,n){Visualforce.remoting.Manager.invokeAction(sharedRemoteActions.updatePermissionSets,function(e,t){if(e)try{handleTabSettingAndRecordTypesPermissions(e).then(function(){setSplashScreenTabDone("loading-permissions"),angular.bootstrap(document.getElementById(i),[n])})}catch(e){console.log(e),angular.bootstrap(document.getElementById(i),[n])}else setSplashScreenTabDone("loading-permissions"),angular.bootstrap(document.getElementById(i),[n])})},moment.defineLocale("en_NZ",{months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),longDateFormat:{LT:"h:mm A",LTS:"h:mm:ss A",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"dddd, D MMMM YYYY LT"},calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},ordinalParse:/\d{1,2}(st|nd|rd|th)/,ordinal:function(e){var t=e%10;return e+(1==~~(e%100/10)?"th":1==t?"st":2==t?"nd":3==t?"rd":"th")},week:{dow:1,doy:4}});var globalStatuses={},globalCategories={},flaggedServices={},contextShown=!1,snapTo=!1,globalSelectedGanttServices={},capacityDurationFilter="Day",cachedDomElements={},violationDelimiter="&lt;br/&gt;",minHourToDisplay=0,maxHourToDisplay=24,includeWeekends=!1,gameOn=!1,ctrlPressed=!1,paletteViewActive=!1,showCandidates={on:!1,id:null},folderJustToggled=!1,fontColor="";function setHoursToDisplay(e,t,i){minHourToDisplay=e,maxHourToDisplay=t,includeWeekends=i}function updateTimesToSnapIn(){var e,t;void 0!==cachedDomElements&&void 0!==cachedDomElements.timesDragFix&&(t=null,0!==(e=cachedDomElements.timesDragFix.html()).indexOf(customLabels.SchedulingTimesGantSnap)||ctrlPressed?0!==e.indexOf(customLabels.SchedulingTimesGantSnap)&&ctrlPressed&&(t=customLabels.SchedulingTimesGantSnap+" "+e.substr(customLabels.SchedulingTimesGant.length,e.length),cachedDomElements.timesDragFix.html(t)):(t=customLabels.SchedulingTimesGant+" "+e.substr(customLabels.SchedulingTimesGantSnap.length,e.length),cachedDomElements.timesDragFix.html(t)))}function showTimesWhenDragging(e,t){cachedDomElements.timesDragFix=cachedDomElements.timesDragFix||$("#timesDragFix");var i,n=(t.start_date.getMinutes()+t.travelTo/60)%60,s=n%serviceJumpsOnGantt,n=serviceJumpsOnGantt-n%serviceJumpsOnGantt;scheduler.getState().drag_id!==t.id?scheduler.getState().drag_id||cachedDomElements.timesDragFix.hide():(i=t.finish-t.start,(e=new Date(e)).setSeconds(0),t.travelTo&&e.setSeconds(e.getSeconds()+t.travelTo),e=n<s?new Date(e.getTime()+60*n*1e3):new Date(e.getTime()-60*s*1e3),t=new Date(e.getTime()+i),n=moment(e).format("lll"),s=moment(t).format("lll"),i=customLabels.SchedulingTimesGant+"<br/>"+n+" - "+s,ctrlPressed&&(i=customLabels.SchedulingTimesGantSnap+"<br/>"+n+" - "+s),cachedDomElements.timesDragFix.html(i).show())}function generateBreakEventHtml(e,t,i){var n="",e=("ZoomLevel2"!=scheduler._mode&&"ZoomLevel3"!=scheduler._mode&&"ZoomLevel4"!=scheduler._mode&&(n='style="display:none;'),e.ganttLabel?'title="'+e.ganttLabel+'"':"");return i?'<div class="ServiceEvent" style="'+t+'" '+e+'>\n                    <div class="ServiceEventPadding">\n                        <img '+n+' src="'+lsdIcons.breakImg+'" class="breakIcon" draggable="false"/>     \n                    </div>\n                </div>':'<div class="ServiceEventPadding" style="'+t+'" '+e+">\n                <img "+n+' src="'+lsdIcons.breakImg+'" class="breakIcon" draggable="false"/>\n            </div>'}function generateCapacityHtml(e){var t="",i="fa-battery-empty",n=0;return 0<e.hoursPerTimePeriod?n=e.hoursInUse/e.hoursPerTimePeriod*100:0<e.workItemsPerTimePeriod&&(n=e.workItemsAllocated/e.workItemsPerTimePeriod*100),i=n<=25?"fa-battery-empty":n<=50?"fa-battery-quarter":n<=75?"fa-battery-half":n<=90?"fa-battery-three-quarters":"fa-battery-full",t+='<span class="contractorCapacityHoursUsed " style="width:calc('+(n=100<n?100:n)+'% - 5px);"></span>',e.text&&("ZoomLevel6"===scheduler._mode||"ZoomLevel7"===scheduler._mode?t+='<div class="ServiceEventPadding"><span class="Capacity_Label"><i class="fa '+i+'"></i>'+e.text.split(" ")[0]+"</span></div>":"MonthlyView"===scheduler._mode||"LongView"===scheduler._mode?t+='<div class="ServiceEventPadding"><span class="Capacity_Label Capacity_Label_LongView">'+e.text.split(" ")[0]+"</span></div>":t+='<div class="ServiceEventPadding"><span class="Capacity_Label"><i class="fa '+i+'"></i>'+e.text+"</span></div>"),t}function generateNAhtml(e,t,i){var n=void 0,e=e.ganttLabel||e.reason||"";return t.includes("color")&&(n="fill:#"+fontColor),i?'<div class="ServiceEvent" style="'+t+'">\n                    <div class="ServiceEventPadding">\n                        <svg aria-hidden="true" class="slds-icon naIcon" style="'+n+'">\n                            <use xlink:href="'+lsdIcons.na+'"></use>\n                        </svg>\n                        <span class="NA_Label" style="'+t+'">\n                            '+e.encodeHTML()+"\n                        </span>\n                    </div>\n                </div>":'<div class="ServiceEventPadding" style="'+t+'">\n                <svg aria-hidden="true" class="slds-icon naIcon" style="'+n+'">\n                    <use xlink:href="'+lsdIcons.na+'"></use>\n                </svg>\n                <span class="NA_Label" style="'+t+'">\n                    '+e.encodeHTML()+"\n                </span>\n            </div>"}function generateIconsHtmlForService(e){var t,i="";return e.violations&&(i="<div class='violationsOnService'><i class='fa fa-warning'></i></div>"),e.isBundleMember&&(i="<div class='violationsOnService'>"+e.RelatedBundle+"</div>"),e.jeopardy&&(i='<div class="jeopardyOnService"><img src="'+lsdIcons.jeopardyImg+'"></div>'),e.icons&&(t="",e.icons.forEach(function(e){t+='<div class="customIconOnService"><img src="'+e+'"></div>'}),i+=t),e.emergency&&(i+='<svg aria-hidden="true" class="slds-icon emergencyOnService"><use xlink:href="'+lsdIcons.emergency+'"></use></svg>'),e.pinned&&(i+='<svg aria-hidden="true" class="slds-icon onServiceIcon"><use xlink:href="'+lsdIcons.pin+'"></use></svg>'),e.isBundle&&(i+='<svg aria-hidden="true" class="slds-icon onServiceIcon"><use xlink:href="'+lsdIcons.bundleIcons+'#ad_set"></use></svg>'),flaggedServices[e.id]&&(i+='<svg aria-hidden="true" class="slds-icon onServiceIcon"><use xlink:href="'+lsdIcons.flag+'"></use></svg>'),(e.relatedFather||e.relatedTo||e.isServiceInChain)&&(i+='<svg aria-hidden="true" class="slds-icon onServiceIcon"><use xlink:href="'+lsdIcons.related+'"></use></svg>'),e.isMDT&&(i+='<svg aria-hidden="true" class="slds-icon onServiceIcon">\n                                <use xlink:href="'+lsdIcons.clock+'"></use>\n                            </svg>'+('<svg aria-hidden="true" class="slds-icon onServiceIcon forwardIcon">\n                                <use xlink:href="'+lsdIcons.forward+'"></use>\n                            </svg>')),i}function generateServiceColorAndFont(e,t){var i,n,s=t?"text-align:right;":"";return"na"===e.type&&e.ganttColor&&e.travelTo&&(s+="margin-right:-6px;"),!e.ganttPaletteColor&&!e.ganttColor||globalSelectedGanttServices[e.id]||(i=e.ganttColor,(i=paletteViewActive&&e.ganttPaletteColor?e.ganttPaletteColor.color:i)&&(n=generateGanttTextColor(i.substr(1,7)),s+="color:#"+(fontColor=n)+";background:"+i+";",!t||e.travelFrom||e.travelTo||(s+="position:relative;right:-6px;"))),"ZoomLevel3"!==scheduler._mode&&"ZoomLevel2"!==scheduler._mode&&(s+="font-size:10px;"),s}$(function(){$("body").keydown(function(e){ctrlPressed=e.ctrlKey,updateTimesToSnapIn()}).keyup(function(e){ctrlPressed=!1,updateTimesToSnapIn()})});var __lockedServicesIds={};function attchDatalessSchedulerEvents(){var p="rtl"===document.querySelector("html").getAttribute("dir"),t=(scheduler.date.ZoomLevel1_start=function(e){var t=scheduler.date.day_start(new Date(e));return t.setHours(e.getHours()),t},scheduler.date.ZoomLevel2_start=function(e){var t=scheduler.date.day_start(new Date(e));return t.setHours(e.getHours()),t},scheduler.templates.event_bar_text=function(e,t,i){var n=void 0,s=void 0,r=getMinAndMaxHoursToDisplay(),o=i.finish-i.start,a=new Date(e);if(a.setSeconds(0),i.travelTo&&a.setSeconds(a.getSeconds()+i.travelTo),o=new Date(a.getTime()+o),showTimesWhenDragging(e,i),"contractorcapacity"===i.type)return generateCapacityHtml(i);var l=generateIconsHtmlForService(i),c=generateServiceColorAndFont(i,p),d=!0,u=new Date(scheduler._min_date),m=new Date(scheduler._max_date);if(u.setHours(r.min),m.setHours(r.max),(d=isIntersect(a,o,u,m)||"ZoomLevel2"===scheduler._mode?d:!1)&&(i.travelTo||i.travelFrom))return n=getXPositionOfEvent({start_date:a,end_date:o},!1,scheduler.matrix[scheduler._mode]),c+="width:"+(s=(s=getXPositionOfEvent({start_date:a,end_date:o},!0,scheduler.matrix[scheduler._mode])-n+12)<=2?3:s)+"px;",i.travelTo&&((r=new Date(e)).setMinutes(r.getMinutes()+i.travelTo/60),u=getXPositionOfEvent({start_date:i.start_date,end_date:r},!1,scheduler.matrix[scheduler._mode]),m=getXPositionOfEvent({start_date:i.start_date,end_date:r},!0,scheduler.matrix[scheduler._mode]),c+=(p?"margin-right:":"margin-left:")+(m-u+7)+"px;"),"na"===i.type?generateNAhtml(i,c,!0):"break"===i.type?generateBreakEventHtml(i,c,!0):'<div class="ServiceEvent" territory_id="'+i.getGanttTerritory()+'" style="'+c+'");"><div class="ServiceEventPadding">'+l+i.text+"</div></div>";if("na"===i.type)return generateNAhtml(i,c,!1);if("break"===i.type)return generateBreakEventHtml(i,c,!1);a=l+i.text;return'<div class="ServiceEventPadding" style="'+c+'">'+(a=d||i.isDummy?a:"")+"</div>"},scheduler.templates.event_class=function(e,t,i){var n="";return"break"===i.type&&window.__servicesInFilter&&window.__servicesInFilter.applied?n="NA_Break service-faded":"break"===i.type&&(n="NA_Break "),i.showEventPopupEffect&&(n+=" ShowEventEffect "),window.__servicesInFilter&&window.__servicesInFilter.applied&&!window.__servicesInFilter[i.id]&&!i.isDummy&&(n+=" service-faded "),"na"===i.type&&(n+=" NA_Absence "),"na"===i.type&&i.ganttColor&&!i.travelTo&&(n+=" na_with_color_no_travel_to "),"na"===i.type&&i.ganttColor&&i.travelTo&&(n+=" na_with_color "),"contractorcapacity"===i.type?(n+=" eventContractorCapacity","LongView"!==scheduler._mode&&"MonthlyView"!==scheduler._mode||(n+=" eventContractorCapacity_LongView"),0<i.hoursPerTimePeriod?0<i.hoursInUse&&i.hoursInUse>i.hoursPerTimePeriod&&(n+=" overCapacityPattern"):0<i.workItemsPerTimePeriod&&0<i.workItemsAllocated&&i.workItemsAllocated>i.workItemsPerTimePeriod&&(n+=" overCapacityPattern"),showCandidates.on&&(n+=" fadedSlot")):("service"===i.type&&(n+=getClassByStatus(i.statusCategory),(i.isDummy||__lockedServicesIds[i.id])&&(n+=" savingDummyService ")),i.isMDT&&(n+=" mdtEvent"),showCandidates.on&&i.id!==showCandidates.id&&(n+=" fadedSlot"),i.hiddenTravelFrom&&(n+=" dhx_long_travel_from_time_background"),i.hiddenTravelTo&&(n+=" dhx_long_travel_to_time_background"),i.travelTo&&i.travelFrom?n+=" dhx_travelToFrom dhx_travel_time_background":i.travelTo&&!i.travelFrom?n+=" dhx_travelTo dhx_travel_time_background":!i.travelTo&&i.travelFrom?n+=" dhx_travelFrom dhx_travel_time_background":"na"===i.type?n+=" NA_Absence_NoTravel":n+=" dhx_noTravel","service"===i.type&&(globalSelectedGanttServices[i.id]&&(i.travelTo||i.travelFrom)?n+=" selectedEvent":globalSelectedGanttServices[i.id]?n+=" selectedEventNoTravel":i.id===scheduler._select_id&&(i.travelTo||i.travelFrom)?n+=" selectedEvent":i.id===scheduler._select_id&&(n+=" selectedEventNoTravel")),i.status&&(n+=" GanttCustomStatus_"+i.status.split(" ").join(""))),n},!(scheduler.templates.tooltip_text=function(e,t,i){if(contextShown)return!1;var n=void 0,s='<div class="tooltipBody">',r=getLocationdIdByResource(i.resourceId),e=utils.getLocationOffset(e,r)-utils.getUserOffset(e),o=new Date(i.start),a=0,l=0,c=new Date(i.finish);if(!r)return!1;if(o.setMinutes(o.getMinutes()+e),c.setMinutes(c.getMinutes()+e),"contractorcapacity"===i.type)return n="fa-battery-empty",0<i.hoursPerTimePeriod?(a=i.hoursInUse/i.hoursPerTimePeriod*100,l=Math.floor(i.hoursInUse/i.hoursPerTimePeriod*100*100)/100):0<i.workItemsPerTimePeriod&&(a=i.workItemsAllocated/i.workItemsPerTimePeriod*100,l=Math.floor(i.workItemsAllocated/i.workItemsPerTimePeriod*100*100)/100),s+='<div class="tooltipLine"><b style="font-size:15px"><i class="fa '+(n=a<=25?"fa-battery-empty":a<=50?"fa-battery-quarter":a<=75?"fa-battery-half":a<=90?"fa-battery-three-quarters":"fa-battery-full")+'"></i> '+i.resourceName.encodeHTML()+"</b> ("+l+"%)</div>",i.workItemsPerTimePeriod&&(s+='<div class="tooltipLine">'+customLabels.NumServicesScheduled.replaceAll(i.workItemsAllocated,i.workItemsPerTimePeriod)+"</div>"),i.hoursPerTimePeriod&&(s+='<div class="tooltipLine">'+customLabels.NumHoursScheduled.replace("{0}",i.hoursInUse).replace("{1}",i.hoursPerTimePeriod)+"</div>"),s=(s=(s=(s+='<div class="tooltipHR"></div>')+('<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Start+"</span> "+moment(i.start_date).format("llll")+"</div>"))+('<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Finish+"</span> "+moment(i.end_date).format("llll")+"</div>"))+('<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Duration_Type+"</span> "+i.timePeriod+"</div>"),0<i.workItemsAllocated&&(s+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.NumberOfServices+"</span> "+i.workItemsAllocated+"</div>"),s+="</div>";if("service"!==i.type)return n=absenceTypeIcon(i.type),i.ganttLabel?s+='<div class="tooltipLine"><b>'+n+'<span class="tooltipName">'+i.ganttLabel.encodeHTML()+"</span> </b> </div>":s+='<div class="tooltipLine"><b>'+n+'<span class="tooltipName">'+i.name+"</span> </b> </div>",s=(s=(s+='<div class="tooltipHR"></div>')+('<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Start+"</span> "+moment(i.start).format("llll")+"</div>"))+('<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Finish+"</span> "+moment(i.finish).format("llll")+"</div>"),e&&!useLocationTimezone&&(s=(s+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Resource_start+"</span> "+moment(o).format("llll")+"</div>")+'<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Resource_finish+"</span> "+moment(c).format("llll")+"</div>"),i.travelTo&&(s+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Travel_to+"</span> "+generateHoursMinutes(i.travelTo/60)+"</div>"),i.travelFrom&&(s+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Travel_from+"</span> "+generateHoursMinutes(i.travelFrom/60)+"</div>"),(i.reason||i.comment)&&(s+='<div class="tooltipHR"></div>'),i.reason&&(s+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Reason+"</span> "+i.reason.encodeHTML()+"</div>"),s+="</div>";var r="",a=i.ganttColor,l='<svg aria-hidden="true" class="slds-icon tooltipJeopardyIcon">\n                                <use xlink:href="'+lsdIcons.jeopardy+'"></use>\n                            </svg>',n='<svg aria-hidden="true" class="slds-icon tooltipMDTIcon">\n                                <use xlink:href="'+lsdIcons.clock+'"></use>\n                            </svg>',d='<svg aria-hidden="true" class="slds-icon tooltipMDTArrowIcon">\n                                <use xlink:href="'+lsdIcons.forward+'"></use>\n                            </svg>',u='<svg aria-hidden="true" class="slds-icon tooltipMDTArrowIcon">\n                                <use xlink:href="'+lsdIcons.emergency+'"></use>\n                            </svg>',m=((a=paletteViewActive&&i.ganttPaletteColor?i.ganttPaletteColor.color:a)&&(r='style="background:'+a+'"'),i.ganttLabel?s+='<div class="tooltipLine"><div '+r+' class="tooltipStatus '+getClassByStatus(i.statusCategory)+'"></div><b style="font-size:15px">'+i.name+" / "+i.ganttLabel.encodeHTML()+"</b> ("+statusTranslations[i.status]+")</div>":s+='<div class="tooltipLine"><div '+r+' class="tooltipStatus '+getClassByStatus(i.statusCategory)+'"></div><b style="font-size:15px">'+i.name+"</b> ("+statusTranslations[i.status]+")</div>",i.jeopardy&&i.jeopardyReason&&(s+='<div class="tooltipJeopardy">'+l+"<span>"+customLabels.JeopardyTooltip+" "+i.jeopardyReason.encodeHTML()+"</span></div>"),i.emergency?s+='<div class="tooltipJEmergency">'+u+"<span>"+customLabels.ScheduledWithEmergency+"</span></div>":i.jeopardy&&(s+='<div class="tooltipJeopardy">'+l+"<span>"+customLabels.JeopardyTooltipLong+"</span></div>"),i.pinned&&(s+='<div class="tooltipLine tooltipPinned"><i>'+customLabels.Pinned_Tooltip+"</i></div>"),(window.isOptimizationViewer?GanttServiceOptiViewer:GanttService).prototype.allFieldSets.GanttToolTip);if(m)for(var p=0;p<m.length;p++){var h=i[m[p].APIName];!(h=i.fields[m[p].APIName+"_Translated"]?i.fields[m[p].APIName+"_Translated"]:h)||"STRING"!==m[p].Type&&"TEXTAREA"!==m[p].Type&&"REFERENCE"!==m[p].Type&&"PICKLIST"!==m[p].Type||(h=h.encodeHTML()),"Status"===m[p].APIName?h=statusTranslations[i.status]:"DATETIME"===m[p].Type&&h?h=moment(h).format("llll"):"DATE"===m[p].Type&&h?h=moment(h).format("L"):"BOOLEAN"===m[p].Type&&(h=h?customLabels.True:customLabels.False),!h&&"BOOLEAN"!==m[p].Type||(s+='<div class="tooltipLine"><b>'+m[p].Label.encodeHTML()+": </b> "+h+"</div>")}if(s=(s=(s+='<div class="tooltipHR"></div>')+('<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Start+"</span> "+moment(i.start).format("llll")+"</div>"))+('<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Finish+"</span> "+moment(i.finish).format("llll")+"</div>"),!e&&!alwaysShowLocalTimeTooltip||useLocationTimezone||(s=(s+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Resource_start+"</span> "+moment(o).format("llll")+"</div>")+'<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Resource_finish+"</span> "+moment(c).format("llll")+"</div>"),i.hiddenTravelTo?s+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Travel_to+"</span> "+generateHoursMinutes(i.hiddenTravelTo.hiddenTravel/60)+"</div>":i.travelTo&&(s+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Travel_to+"</span> "+generateHoursMinutes(i.travelTo/60)+"</div>"),i.hiddenTravelFrom?s+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Travel_from+"</span> "+generateHoursMinutes(i.hiddenTravelFrom.hiddenTravel/60)+"</div>":i.travelFrom&&(s+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Travel_from+"</span> "+generateHoursMinutes(i.travelFrom/60)+"</div>"),i.tooltipText&&(s=(s+='<div class="tooltipHR"></div>')+'<div class="tooltipLine tooltipTitle">'+customLabels.Custom_Tooltip_Field+'</div><div class="tooltipLine">'+i.tooltipText.encodeHTML()+"</div>"),s+="</div>",(i.hiddenTravelTo||i.hiddenTravelFrom||i.isMDT)&&(s+='<div class="tooltipTravel">',(i.hiddenTravelTo||i.hiddenTravelFrom)&&(s=(s+='<div class="tooltipLine tooltipTitle"><i class="fa fa-car"></i>'+customLabels.Travel_time+"</div><div>")+customLabels.Travel_time_too_long.replace("{0}",maxTravelTimeInSeconds/60/60)+'<div class="travelExplain">'+customLabels.To_change_maximum_travel_hours+"</div></div>"),i.isMDT&&(s=(s+='<div class="tooltipLine tooltipTitle">'+n+d+customLabels.Multi_Day_Service+"</div><div>")+customLabels.This_service_spans_across_more_than_one_day+"</div>"),s+="</div>"),i.violations){for(var s=(s+='<div class="tooltipViolation">')+('<div class="tooltipLine tooltipTitle"><i class="fa fa-warning"></i>'+customLabels.Rule_violations_Tooltip+"</div><div>"),g=0;g<i.violations.length;g++)-1!=i.violations[g].ViolationString.indexOf(violationDelimiter)?s=(s=(s+=i.violations[g].RuleName+" - ")+i.violations[g].ViolationString.substring(0,i.violations[g].ViolationString.indexOf(violationDelimiter))+"<br/>")+i.violations[g].ViolationString.substring(i.violations[g].ViolationString.indexOf(violationDelimiter)+violationDelimiter.length)+"<br/>":s+=i.violations[g].RuleName+" - "+i.violations[g].ViolationString+"<br/>";s+="</div>"}return s}));function s(e){if(window.__currentViewOptions.highlightWeekeneds)return 6===(e=e.getDay())||0===e&&1===window.firstDayOfTheWeek||5===e&&0===window.firstDayOfTheWeek?"color-weekends-date":void 0}function i(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],i=[],n=s(e);return n&&i.push(n),(t&&hasHolidayInScaleX(e,1,"day")||hasHolidayInScaleX(e,scheduler.getView().x_step,scheduler.getView().x_unit))&&i.push("color-holiday-date"),i.join(" ")}function e(e){if(a(e))return!0;var t=getMinAndMaxHoursToDisplay();return!(e.getHours()>=t.min&&e.getHours()<t.max)}function a(e){if("ZoomLevel6"===scheduler._mode||"ZoomLevel7"===scheduler._mode||"MonthlyView"===scheduler._mode||"MTDView"===scheduler._mode||"LongView"===scheduler._mode){var t=0===firstDayOfTheWeek?6:0,i=0===firstDayOfTheWeek?5:6;if(!includeWeekends&&(e.getDay()===i||e.getDay()===t))return!0}return!1}function n(e,t){if(gameOn)return!1;var i=function(e){var t=getMinAndMaxHoursToDisplay();if(a(e.start_date)&&a(e.end_date)&&(n=e.start_date,(e.end_date.getTime()/1e3/60/60-n.getTime()/1e3/60/60)/24<5))return!1;var i=[];if("ZoomLevel2"===scheduler._mode)i.push({start:scheduler._min_date.getTime(),finish:scheduler._max_date.getTime()});else for(var n=scheduler._min_date.getTime(),s=scheduler._max_date.getTime(),r=n;r<s;r+=864e5){var o={start:r+1e3*t.min*60*60,finish:r+1e3*t.max*60*60};i.push(o)}return isMultipleIntersection({start:e.start_date.getTime(),finish:e.end_date.getTime()},i)}(t),n=!0;return contractorSupport&&(t.resourceContractor&&(n=!1),"contractorcapacity"===t.type&&t.timePeriod!=capacityDurationFilter&&(n=!1)),i&&n}return dhtmlxEvent(scheduler._obj,"mouseleave",function(e){scheduler.getState().drag_id&&(t=!0,scheduler._on_mouse_up(e),cachedDomElements.timesDragFix.hide(),window.getSelection().removeAllRanges())}),scheduler.attachEvent("onBeforeEventChanged",function(){return!t||(t=!1)}),scheduler._hover=null,scheduler.attachEvent("onMouseMove",function(e,t){var i,n;e?scheduler._events[e]&&(scheduler._events[e].relatedTo||scheduler._events[e].relatedFather)&&(n=null,0===(i=$(scheduler.getRenderedEvent(e)).find(".ServiceEvent")).length&&(i=$(scheduler.getRenderedEvent(e))),scheduler._events[e].relatedFather?0===(n=$(scheduler.getRenderedEvent(scheduler._events[e].relatedFather)).find(".ServiceEvent")).length&&(n=$(scheduler.getRenderedEvent(scheduler._events[e].relatedFather))):0===(n=$(scheduler.getRenderedEvent(scheduler._events[e].relatedTo)).find(".ServiceEvent")).length&&(n=$(scheduler.getRenderedEvent(scheduler._events[e].relatedTo))),scheduler._hover=e,i&&n&&($(i).hasClass("hoverRelated")||($(i).addClass("hoverRelated"),$(n).addClass("hoverRelated")))):scheduler._hover&&($(".dhx_cal_event_line, .ServiceEvent").removeClass("hoverRelated"),scheduler._hover=null)}),scheduler.templates.ZoomLevel2_scale_date=function(e){var t=e.getHours(),e=e.getMinutes()<10?formatNumberToLocaleString(0)+formatNumberToLocaleString(e.getMinutes()):formatNumberToLocaleString(e.getMinutes());return isAMPM?0===t?formatNumberToLocaleString(12)+":"+e+" AM":12===t?formatNumberToLocaleString(12)+":"+e+" PM":12<t?formatNumberToLocaleString(t-12)+":"+e+" PM":formatNumberToLocaleString(t)+":"+e+" AM":formatNumberToLocaleString(t)+":"+e},scheduler.templates.ZoomLevel3_scale_date=function(e){var t=e.getHours(),i=e.getMinutes()<10?formatNumberToLocaleString(0)+formatNumberToLocaleString(e.getMinutes()):formatNumberToLocaleString(e.getMinutes());return isAMPM?0===t?formatNumberToLocaleString(12)+" AM":12==t?formatNumberToLocaleString(12)+" PM":12<t?formatNumberToLocaleString(t-12)+" PM":formatNumberToLocaleString(t)+" AM":(e.getHours()<10?formatNumberToLocaleString(0)+formatNumberToLocaleString(e.getHours()):formatNumberToLocaleString(e.getHours()))+":"+i},scheduler.templates.ZoomLevel4_scale_date=scheduler.templates.ZoomLevel3_scale_date,scheduler.templates.ZoomLevel5_scale_date=scheduler.templates.ZoomLevel3_scale_date,scheduler.templates.ZoomLevel6_scale_date=scheduler.templates.ZoomLevel3_scale_date,scheduler.templates.ZoomLevel7_scale_date=scheduler.templates.ZoomLevel3_scale_date,scheduler.templates.ZoomLevel4_cell_class=function(e,t,i){var n="",t=(!i.children&&shouldSeparateCell(t)&&(n+="BorderForDayChange "),t.getDay());return!i.children&&window.__currentViewOptions.highlightWeekeneds&&(6===t||0===t&&1===window.firstDayOfTheWeek||5===t&&0===window.firstDayOfTheWeek)&&(n+=" color-weekends"),n},scheduler.templates.ZoomLevel2_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.templates.ZoomLevel3_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.templates.ZoomLevel5_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.templates.ZoomLevel6_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.templates.ZoomLevel7_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.templates.MTDView_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.templates.LongView_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.templates.ZoomLevel4_second_scalex_class=function(e){return i(e,!0)},scheduler.templates.ZoomLevel2_second_scalex_class=scheduler.templates.ZoomLevel4_second_scalex_class,scheduler.templates.ZoomLevel3_second_scalex_class=scheduler.templates.ZoomLevel4_second_scalex_class,scheduler.templates.ZoomLevel5_second_scalex_class=scheduler.templates.ZoomLevel4_second_scalex_class,scheduler.templates.ZoomLevel6_second_scalex_class=scheduler.templates.ZoomLevel4_second_scalex_class,scheduler.templates.ZoomLevel7_second_scalex_class=scheduler.templates.ZoomLevel4_second_scalex_class,scheduler.templates.ZoomLevel2_scalex_class=i,scheduler.templates.ZoomLevel3_scalex_class=scheduler.templates.ZoomLevel2_scalex_class,scheduler.templates.ZoomLevel4_scalex_class=scheduler.templates.ZoomLevel2_scalex_class,scheduler.templates.ZoomLevel5_scalex_class=scheduler.templates.ZoomLevel2_scalex_class,scheduler.templates.ZoomLevel6_scalex_class=scheduler.templates.ZoomLevel2_scalex_class,scheduler.templates.ZoomLevel7_scalex_class=scheduler.templates.ZoomLevel2_scalex_class,scheduler.templates.MTDView_scalex_class=s,scheduler.templates.LongView_scalex_class=scheduler.templates.MTDView_scalex_class,scheduler.templates.MonthlyView_scalex_class=scheduler.templates.MTDView_scalex_class,scheduler.filter_ZoomLevel1=n,scheduler.filter_ZoomLevel2=n,scheduler.filter_ZoomLevel3=n,scheduler.filter_ZoomLevel4=n,scheduler.filter_ZoomLevel5=n,scheduler.filter_ZoomLevel6=n,scheduler.filter_ZoomLevel7=n,scheduler.filter_LongView=function(e,t){if(t instanceof ResourceCapacity&&t.timePeriod===capacityDurationFilter)return!0;if((!(2<arguments.length&&void 0!==arguments[2])||arguments[2])&&contractorSupport&&t.resourceContractor)return!1;if(window.__gantt.shouldShowLongTermError())return!1;if("break"===t.type)return!1;var i,n=(t.finish-t.start)/1e3/60/60;return window.__currentViewOptions.showMdt?(i=0===window.mdtBooleanField.indexOf("FSL__")?window.mdtBooleanField.substr(5,window.mdtBooleanField.length-5):window.mdtBooleanField,"na"===t.type&&n>=window.__currentViewOptions.minNaDuration||"service"===t.type&&n>=window.__currentViewOptions.minServiceDuration&&t.fields[i]):"na"===t.type&&n>=window.__currentViewOptions.minNaDuration||"service"===t.type&&n>=window.__currentViewOptions.minServiceDuration},scheduler.filter_MonthlyView=function(e,t){return"contractorcapacity"===t.type&&t.timePeriod===capacityDurationFilter},scheduler.filter_MTDView=function(e,t){return"contractorcapacity"===t.type&&t.timePeriod===capacityDurationFilter||t.isMDT||"na"===t.type},scheduler.ignore_ZoomLevel3=e,scheduler.ignore_ZoomLevel4=e,scheduler.ignore_ZoomLevel5=e,scheduler.ignore_ZoomLevel6=e,scheduler.ignore_ZoomLevel7=e,scheduler.ignore_MonthlyView=a,scheduler.ignore_LongView=scheduler.ignore_MonthlyView,scheduler.ignore_MTDView=scheduler.ignore_MonthlyView,{isDateInsideWeekend:a}}function shouldSeparateCell(e){var t=getMinAndMaxHoursToDisplay();switch(scheduler._mode){case"ZoomLevel4":t.max-=2;break;case"ZoomLevel5":t.max-=4;break;case"ZoomLevel6":case"ZoomLevel7":t.max-=6}if("ZoomLevel2"===scheduler._mode&&23===e.getHours()&&30===e.getMinutes())return!0;if(e.getHours()===t.max){e=new Date(e);if(e.setHours(e.getHours()+24),e<=scheduler._max_date)return!0}return!1}function getXPositionOfEvent(e,t,i){var n=0,s=i._step,r=i.round_position,o=0,e=t?e.end_date:e.start_date,a=(e=e.valueOf()>scheduler._max_date.valueOf()?scheduler._max_date:e)-scheduler._min_date_timeline;if(0<a){var l=scheduler._get_date_index(i,e);scheduler._ignores[l]&&(r=!0);for(var c=0;c<l;c++)n+=scheduler._cols[c];var d=scheduler.date.add(scheduler._min_date_timeline,scheduler.matrix[scheduler._mode].x_step*l,scheduler.matrix[scheduler._mode].x_unit);r?+d<+e&&t&&(o=scheduler._cols[l]):(a=e-d,i.first_hour||i.last_hour?((a-=i._start_correction)<0&&(a=0),(o=Math.round(a/s))>scheduler._cols[l]&&(o=scheduler._cols[l])):o=Math.round(a/s))}return n+=t?0===a||r?o-14:o-12:o+1}function getResourceEventsIds(e,t,i){var n,s=[];for(n in scheduler._events)"service"==scheduler._events[n].type&&scheduler._events[n].start_date>=e&&scheduler._events[n].end_date<=t&&scheduler._events[n].resourceId==i&&(s.push(n),scheduler._events[n].relatedTo&&s.push(scheduler._events[n].relatedTo),scheduler._events[n].relatedFather&&s.push(scheduler._events[n].relatedFather));return s}function setCapacityFilter(e,t){contractorSupport&&(capacityDurationFilter=e,t&&scheduler._is_initialized()&&updateViewDebounced())}function cantLoadGantt(e){$(".keypressEvents")&&($(".bodyDiv").css("background","#fff"),$(".keypressEvents").remove(),$("#ErrorLoadingGantt").show()),$("#ErrorContainer").append(e),-1<e.toUpperCase().indexOf("CPU TIME")?($("#OpenTerritoryButton").show(),$("#OpenTerritoryMessage").show(),$("#OpenTerritoryButton").click(function(){__openLocationFilteringAndReload()})):($("#OpenTerritoryButton").hide(),$("#OpenTerritoryMessage").hide())}function getLocationdIdByResource(e){for(var t=scheduler.serverList("resources"),i=0;i<t.length;i++)for(var n=0;n<t[i].children.length;n++)if(e.split(",")[0]===t[i].children[n].key)return t[i].key;return null}function absenceTypeIcon(e){return"break"===e?'<svg aria-hidden="true" class="slds-icon tooltipBreakIcon">\n                    <use xlink:href="'+lsdIcons.break+'"></use>\n                </svg>':'<svg aria-hidden="true" class="slds-icon tooltipNAIcon">\n                <use xlink:href="'+lsdIcons.na+'"></use>\n            </svg>'}function getClassByStatus(e){switch(e){case globalCategories.NONE:return"eventStatusNew";case globalCategories.SCHEDULED:return"eventStatusAssigned";case globalCategories.DISPATCHED:return"eventStatusDispatched";case globalCategories.IN_PROGRESS:return"eventStatusTravel";case globalCategories.RUNNING_LONG:return"eventStatusOnSite";case globalCategories.COMPLETED:return"eventStatusCompleted";case globalCategories.MISSED:return"eventStatusIncomplete";case globalCategories.COULD_NOT_COMPLETE:return"eventStatusCouldntComplete";case globalCategories.CANCELED:return"eventStatusCancelled";default:return"eventCustomStatus"}}function getMinAndMaxHoursToDisplay(){var e=scheduler.getState().mode,t=minHourToDisplay,i=maxHourToDisplay,n=null;switch(e){case"ZoomLevel4":n=2;break;case"ZoomLevel5":n=4;break;case"ZoomLevel6":n=6;break;case"ZoomLevel7":n=12}return null!=n&&(t-=t%n,(e=n-i%n)!=n&&(i+=e)),{min:t,max:i}}function isIntersect(e,t,i,n){return e<n&&i<t}function isIntersectIncludeLimits(e,t,i,n){return e<=n&&i<=t}function isMultipleIntersection(e,t){for(var i=0;i<t.length;i++)if(isIntersect(e.start,e.finish,t[i].start,t[i].finish))return!0;return!1}function generateGanttTextColor(e){return parseInt("0x888888",16)<parseInt("0x"+e,16)?"000000":"ffffff"}function formatNumberToLocaleString(e){try{return e.toLocaleString(jsUserLocale)}catch(e){console.warn("Something wrong with your locale settings: "+jsUserLocale)}return e}function formatDateByLocaleWithDayOfTheWeek(e){var t=utils.formatDateWithDayOfWeek(e);if(t)return t;return-1!==["en_US"].indexOf(userLocale)?moment(e).format("ddd, MMM D YYYY"):moment(e).format("LL")}function generateHoursMinutes(e){if(e<60)return customLabels.MinutesGanttTooltip.replace("$0",e);var t=e%60,e=Math.floor(e/60);return customLabels.MinutesHoursGanttTooltip.replace("$0",e).replace("$1",t)}function removeLightboxLoading(){$("#lightbox-loading-cover").remove()}function __setTimeZoneOffsetToDateField(e){var t,i,n=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],s=arguments[2];return e||0===e?(t=60*new Date(e).getTimezoneOffset()*1e3,i=60*new Date(e+t).getTimezoneOffset()*1e3,new Date(e+t-(t!=i?t-i:0))):n?null:s?new Date(0):new Date(24e11)}function generateSecondScaleContent(e,t){var i=!(2<arguments.length&&void 0!==arguments[2])||arguments[2],n=e.toISOString(),t=t(e),e="<span>"+t+"</span>";return'<div class="second-scale-content slds">\n                '+(e=matchHolidays(n)?i?generateHolidayButton(n)+e:generateHolidayLink(n,t):e)+"\n            </div>"}function generateHolidayButton(e){return'<button class="slds-button slds-button__icon holiday-toggle holiday-button-icon" data-date="'+e+'" onClick="toggleHolidayPopover(event)">\n                <svg class="slds-button__icon holiday-icon" aria-hidden="true">\n                    <use xlink:href="'+lsdIcons.holiday+'"></use>\n                </svg>\n                <span class="slds-assistive-text">'+customLabels.HolidayOpenPopover+"</span>\n            </button>"}function generateHolidayLink(e,t){return'<a class="holiday-toggle" data-date="'+e+'" onClick="toggleHolidayPopover(event)">'+t+"</a>"}function generateHolidayPopover(e){var t=sortHolidays(e);return'<div aria-label="Holiday" class="slds holiday-popover-wrapper" data-date="'+e+'">\n                <div class="slds-popover slds-nubbin--top holiday-popover">\n                    <div class="holiday-scroll">\n                        <button class="slds-button slds-button__icon slds-float--right slds-popover__close holiday-popover-close" onClick="closeHolidayPopover(event)">\n                            <svg class="slds-button__icon" aria-hidden="true">\n                                <use xlink:href="'+lsdIcons.close+'"></use>\n                            </svg>\n                            <span class="slds-assistive-text">'+customLabels.HolidayClosePopover+"</span>\n                        </button>\n                        <div>\n                            "+generateHolidaySections(t)+"\n                        </div>\n                    <div>\n                </div>\n            </div>"}function generateHolidaySections(e){return e&&'<div class="holiday-sections">'+Object.values(e).map(function(e){return""+generateHolidaySection(e)}).join("")+"</div>"}function generateHolidaySection(e){var t=moment(e.date).format("dddd, LL"),i=(e.isAllDay||(t=moment(e.date).startOf("day").add(e.startTimeInMinutes,"minute").format("LLLL")+" - "+moment(e.date).startOf("day").add(e.endTimeInMinutes,"minute").format("LT")),Object.values(e.territories).map(function(e){return e.name}).sort().join(", "));return'<div class="holiday-section">\n                <header class="holiday-header">\n                    <div class="slds-media slds-media--small slds-media--center slds-has-flexi-truncate">\n                        <div class="slds-media__figure holiday-figure">\n                            <span class="slds-icon_container" title="holiday">\n                                <svg class="slds-icon slds-icon--small slds-icon-text-default" aria-hidden="true">\n                                    <use xlink:href="'+lsdIcons.holiday+'"></use>\n                                </svg>\n                                <span class="slds-assistive-text">holiday</span>\n                            </span>\n                        </div>\n                        <div class="slds-media__body">\n                            <h3 class="slds-text-body--regular"><strong>'+e.name+'</strong></h3>\n                        </div>\n                    </div>\n                    <div class="slds-text-body--small">'+t+'</div>\n                </header>\n                <div>\n                    <div class="slds-text-body--regular">'+customLabels.HolidayObservingTerritories+':</div>\n                    <div class="slds-text-body--regular">'+i+"</div>\n                </div>\n            </div>"}function matchHolidays(e){return(scheduler.serverList("holidays")[0]||{})[e]}function sortHolidays(e){e=Object.values(matchHolidays(e)||{});return e.sort(function(e,t){return Object.values(t.territories).length-Object.values(e.territories).length||e.name.localeCompare(t.name)}),e}function toggleHolidayPopover(e){var e=findOrCreateHolidayPopover($(e.target).closest(".holiday-toggle")),t=e.is(":visible");closeAllHolidayPopovers(),t||togglePopoverInstance(e)}function findOrCreateHolidayPopover(e){var t='.holiday-popover-wrapper[data-date="'+e.data("date")+'"]',i=$(t);i.length||($("body").append(generateHolidayPopover(e.data("date"))),i=$(t));return $(e).data("popper")||(t=Popper.createPopper(e[0],i[0],{modifiers:[{name:"offset",options:{offset:[0,15]}}]}),e.data("popper",t)),i}function closeHolidayPopover(e){togglePopoverInstance($(e.target).closest(".holiday-popover-wrapper"),!0)}function closeAllHolidayPopovers(){$(".holiday-popover-wrapper").each(function(e,t){return togglePopoverInstance($(t),!0)})}function togglePopoverInstance(e){1<arguments.length&&void 0!==arguments[1]&&arguments[1]||e.is(":visible")?e.hide():e.show();var t=e.data("date"),t=$(".holiday-toggle[data-date='"+t+"'").data("popper");t&&t.setOptions({modifiers:[].concat(_toConsumableArray(t.state.options.modifiers),[{name:"eventListeners",enabled:!e.is(":hidden")}])})}function removeAllHolidayPopovers(){var t=this;$(".holiday-toggle").each(function(){var e=$(t).data("popper");e&&(e.destroy(),$(t).removeData("popper"))}),$(".holiday-popover-wrapper").remove()}function hasHolidayInScaleX(i,e){var t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"minute",n=moment(i).startOf("day").toDate().toISOString(),s=moment(i).add(e,t).toDate();return((scheduler.serverList("holidays")[1]||{})[n]||[]).some(function(e){var t=e.start;return!(e.finish<=i||s<=t)})}$(function(){moment.locale(userLocale)}),$(function(){svg4everybody(),"function"==typeof srcUp&&$("body").css("margin","0")}),scheduler.attachEvent("onSchedulerReady",function(){function t(e){var t=e.getDay();return window.includeWeekends||(0!=window.firstDayOfTheWeek||5!==t&&6!==t)&&(1!=window.firstDayOfTheWeek||0!==t&&6!==t)?moment(e).format("ddd,  D"):""}scheduler.templates.ZoomLevel1_second_scale_date=function(e){return generateSecondScaleContent(e,formatDateByLocaleWithDayOfTheWeek)},scheduler.templates.MonthlyView_second_scale_date=function(e){return moment(e).format("MMM")},scheduler.templates.MTDView_second_scale_date=scheduler.templates.MonthlyView_second_scale_date,scheduler.templates.LongView_second_scale_date=scheduler.templates.MonthlyView_second_scale_date,scheduler.templates.ZoomLevel2_second_scale_date=scheduler.templates.ZoomLevel1_second_scale_date,scheduler.templates.ZoomLevel3_second_scale_date=scheduler.templates.ZoomLevel1_second_scale_date,scheduler.templates.ZoomLevel4_second_scale_date=scheduler.templates.ZoomLevel1_second_scale_date,scheduler.templates.ZoomLevel5_second_scale_date=scheduler.templates.ZoomLevel1_second_scale_date,scheduler.templates.ZoomLevel6_second_scale_date=function(e){return generateSecondScaleContent(e,t)},scheduler.templates.ZoomLevel7_second_scale_date=function(e){return generateSecondScaleContent(e,t,!1)},scheduler.templates.ZoomLevel2_date=function(e,t){return e.getDate()!==t.getDate()?formatDateByLocaleWithDayOfTheWeek(e)+" - "+formatDateByLocaleWithDayOfTheWeek(t):formatDateByLocaleWithDayOfTheWeek(e)},scheduler.templates.ZoomLevel3_date=function(e,t){return formatDateByLocaleWithDayOfTheWeek(e)},scheduler.templates.ZoomLevel4_date=function(e,t){t=new Date(t);return t.setDate(t.getDate()-1),formatDateByLocaleWithDayOfTheWeek(e)+" - "+formatDateByLocaleWithDayOfTheWeek(t)},scheduler.templates.ZoomLevel5_date=scheduler.templates.ZoomLevel4_date,scheduler.templates.ZoomLevel6_date=scheduler.templates.ZoomLevel4_date,scheduler.templates.ZoomLevel7_date=scheduler.templates.ZoomLevel4_date,scheduler.templates.MonthlyView_date=scheduler.templates.ZoomLevel4_date,scheduler.templates.MTDView_date=scheduler.templates.ZoomLevel4_date,scheduler.templates.LongView_date=scheduler.templates.ZoomLevel4_date}),$(function(){-1<window.navigator.userAgent.indexOf("Edge")&&(document.body.className+=" EdgeBrowser")}),$(function(){$(document).click(function(e){$(e.target).closest(".holiday-toggle, .holiday-popover-wrapper").length||closeAllHolidayPopovers()})});var optiViewerStatusCategories={},serviceStatusCategories={},BrickBreaker=($.fn.visible=function(e){var t=$(this),i=$(window),n=i.scrollTop(),i=n+i.height(),s=t.offset().top,t=s+t.height();return(!0===e?s:t)<=i&&n<=(!0===e?t:s)},{play:function(){var o=function(){for(var e={scheduled:"#F9D058",new:"#A5E2D6",dispatched:"#8DD8FA",inprogress:"#D68EF9",completed:"#95D055",incomplete:"#EA8288",default:"#B7C9EA"},t=[],i=scheduler.getEvents(scheduler.getState().min_date,scheduler.getState().max_date),n=0;n<i.length;n++){var s=i[n],r=void 0,o=void 0,a=$(scheduler.getRenderedEvent(s.id));a.visible()&&(o=$(a.children()[0]).width(),"service"==s.type?r=e[s.Status.toLowerCase().replace(" ","")]:"break"==s.type?(r="#5e698f",o=a.width()):"na"==s.type&&(r="#d7dfe7"),t.push({color:r,top:a.offset().top-264,left:a.offset().left-$("#LeftSideContainer").width()+8,width:o,height:scheduler.matrix.ZoomLevel3.event_dy-2,name:s.name,status:1}))}return t}();gameOn=!0,updateViewDebounced(),$("#GanttContainer").append('<div id="bricks-overlay" style="position:absolute; top:100px; z-index:100">\n                                            <canvas id="brick-canvas"></canvas>\n                                        </div>');var a=(e=$(".dhx_cal_data")).width(),e=e.height(),l=document.getElementById("brick-canvas"),c=(l.width=a,l.height=e,l.getContext("2d")),d=15,u=l.width/2,m=l.height-30,p=5,h=-5,g=15,v=95,f=($("body").width()-v)/2,S=0,_=3;function t(e){e=e.clientX-l.offsetLeft;0<e&&e<l.width&&(f=e-v/2)}function y(){gameOn=!1,document.removeEventListener("mousemove",t),updateViewDebounced(),$("#bricks-overlay").remove()}return 15<$(".item").length||$(".item").length,document.addEventListener("mousemove",t,!1),function e(){c.clearRect(0,0,l.width,l.height);for(var t,i,n,s,r=0;r<o.length;r++)0!=o[r].status&&(t=o[r].left,i=o[r].top,n=o[r].width,s=o[r].height,c.beginPath(),c.rect(t,i,n,s),c.fillStyle=o[r].color,c.fill(),40<=n&&(c.font="10px Salesforce Sans",c.fillStyle="#000",c.fillText(o[r].name,t+5,i+10)),c.closePath());if(c.beginPath(),c.arc(u,m,d,0,2*Math.PI),c.fillStyle="#0095DD",c.fill(),c.closePath(),c.beginPath(),c.rect(f,l.height-g,v,g),c.fillStyle="#0095DD",c.fill(),c.closePath(),function(){for(var e=0;e<o.length;e++){var t=o[e];if(1==t.status&&u>=t.left&&u<=t.left+t.width&&m>=t.top&&m<=t.top+t.height&&(h=-h,t.status=0,(S+=10)/10==o.length))return alert("You win, great... ¯\\_(ツ)_/¯. back to work"),y()}}(),c.font="16px Salesforce Sans",c.fillStyle="#0095DD",c.fillText("Score: "+S+", Lives: "+_,a/2,25),(u+p>l.width-d||u+p<d)&&(p=-p),m+h<d)h=-h;else if(m+h>l.height-d)if(f<u&&u<f+v)h=-h;else{if(!--_)return alert("GAME OVER - back to work"),void y();u=l.width/2,m=l.height-30,h=-(p=5),f=(l.width-v)/2}u+=p,m+=h,requestAnimationFrame(e)}(),"GAME ON!"}}),schedulerConfig=(setTimeout(function e(){postMessage(10),setTimeout(e,1e4)},1e4),function(){var e={dateTitleFormat:"%D, %F %d",dateFormat:"%g:%i%A",resourceCellSize:170,locationCellHeight:44,rowHeight:46,eventHeight:42,sort:t};function t(e,t){var i=new Date(e.start_date),n=new Date(e.end_date),s=new Date(t.start_date),r=new Date(t.end_date);return"na"===e.type&&"na"!==t.type?(r<i||n<s)&&+s<+i?1:-1:"na"===t.type&&"na"!==e.type?!(n<s||r<i)||+s<+i?1:-1:+s<+i?1:-1}return{timelineConfigs:e,configTimelines:function(){scheduler.createTimelineView({smart_rendering:!0,name:"ZoomLevel2",x_unit:"minute",x_date:e.dateFormat,x_step:30,x_size:16,x_start:0,x_length:6,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"day",x_date:e.dateTitleFormat},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort}),scheduler.createTimelineView({smart_rendering:!0,name:"ZoomLevel3",x_unit:"minute",x_date:e.dateFormat,x_step:60,x_size:24,x_start:0,x_length:24,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"day",x_date:e.dateTitleFormat},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort}),scheduler.createTimelineView({smart_rendering:!0,name:"ZoomLevel4",x_unit:"minute",x_date:e.dateFormat,x_step:120,x_size:24,x_start:0,x_length:12,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"day",x_date:e.dateTitleFormat},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort}),scheduler.createTimelineView({smart_rendering:!0,name:"ZoomLevel5",x_unit:"minute",x_date:e.dateFormat,x_step:240,x_size:18,x_start:0,x_length:6,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"day",x_date:e.dateTitleFormat},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort}),scheduler.createTimelineView({smart_rendering:!0,name:"ZoomLevel6",x_unit:"minute",x_date:e.dateFormat,x_step:360,x_size:28,x_start:0,x_length:4,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"day",x_date:e.dateTitleFormat},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort}),scheduler.createTimelineView({smart_rendering:!0,name:"ZoomLevel7",x_unit:"minute",x_date:e.dateFormat,x_step:720,x_size:28,x_start:0,x_length:2,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"day",x_date:e.dateTitleFormat},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort}),scheduler.createTimelineView({smart_rendering:!0,name:"MonthlyView",x_unit:"day",x_date:"%d",x_step:1,x_size:14,x_start:0,x_length:1,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"month",x_date:"%M"},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort}),scheduler.createTimelineView({smart_rendering:!0,name:"MTDView",x_unit:"day",x_date:"%d",x_step:1,x_size:35,x_start:0,x_length:1,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"month",x_date:"%M"},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort}),scheduler.createTimelineView({smart_rendering:!0,name:"LongView",x_unit:"day",x_date:"%d",x_step:1,x_size:20,x_start:0,x_length:7,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:e.resourceCellSize,second_scale:{x_unit:"month",x_date:"%M"},event_dy:e.eventHeight,dy:e.rowHeight,section_autoheight:!1,folder_dy:e.locationCellHeight,folder_events_available:!1,sort:e.sort})},setRowHeights:function(e,t){var i=32;switch(e){case"xsmall":i=27;break;case"small":i=32;break;case"normal":i=39;break;case"large":i=46;break;default:i=39}if(scheduler.matrix.ZoomLevel3.dy!==i){for(var n in scheduler.matrix)scheduler.matrix[n].dy=i,scheduler.matrix[n].event_dy=i-4,scheduler.matrix[n].folder_dy=i+2;t&&scheduler._is_initialized()&&scheduler.setCurrentView()}},setReadOnly:function(e){scheduler.config.readonly=e},setConfigurations:function(){var e="rtl"===document.querySelector("html").getAttribute("dir");scheduler.config.drag_resize=!1,scheduler.config.multisection=!0,scheduler.config.multisection_shift_all=!1,scheduler.config.limit_drag_out=!1,scheduler.config.dblclick_create=!1,scheduler.config.mark_now=!1,scheduler.config.time_step=1,scheduler.dhtmlXTooltip.config.className="dhtmlXTooltip tooltip expertTooltip",scheduler.dhtmlXTooltip.config.timeout_to_display=375,scheduler.dhtmlXTooltip.config.delta_x=10,scheduler.dhtmlXTooltip.config.delta_y=0,scheduler.config.minicalendar.mark_events=!1,scheduler.config.preserve_length=!1,scheduler.config.rtl=e,scheduler.config.touch=!1},sortEvents:t}}());function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}scheduler.attachEvent("onSchedulerReady",function(){scheduler.templates.calendar_month=function(t){if(-1!=["en_US","en_GB"].indexOf(userLocale))return moment(t).format("MMMM YYYY");if(-1!=userLocale.indexOf("iw"))try{return new Intl.DateTimeFormat("he",{month:"short",year:"numeric"}).format(t)}catch(e){return moment(t).format("LL")}return moment(t).format("LL")},scheduler.templates.calendar_date=function(e){return moment(e).format("DD")},scheduler.templates.calendar_scale_date=function(e){return moment(e).format("ddd")},scheduler.templates.calendar_time=function(e){return moment(e).format("l")}}),angular.module("serviceExpert").controller("ctrlGanttOptiViewer",["$scope","$rootScope","$q","BundleService","BundleActions","sfdcService","servicesService","utils","calendarsService","userSettingsManager","resourceFilterHelper","monthlyViewHelperService","ResourcesAndTerritoriesService","TimePhasedDataService","StateService","CapacityLightboxService","ResourceSmallMenu","AbsencesService","SkillsService","AbsenceLightboxService","ResourceLightboxService","ServiceAppointmentLightboxService","kpiCalculationsService","ResourceCapacitiesService","ResourceCrewsService","SERVICE_STATUS","SERVICE_CATEGORY","GetSlotsService","bulkScheduleService","GeneralLightbox","StreamingClientResolverService","StreamingAPIService","OptimizationRequestsService","GanttPalettesService",function(g,s,e,v,f,a,S,y,G,i,r,B,c,d,b,H,V,l,n,u,U,o,m,z,j,w,W,q,Z,p,K,Y,h,T){var L="",A="",I={},C=!0,k=new dhtmlXMenuObject({parent:"contextZone_A",context:!0}),D=new dhtmlXMenuObject({parent:"contextZone_A",context:!0});function t(){g.currentViewOptions.numOfMonths<=2?(scheduler.matrix.LongView.x_unit="day",scheduler.matrix.LongView.x_length=7,scheduler.matrix.LongView.x_size=30*g.currentViewOptions.numOfMonths):(scheduler.matrix.LongView.x_unit="week",scheduler.matrix.LongView.x_size=Math.ceil(4.5*g.currentViewOptions.numOfMonths),scheduler.matrix.LongView.x_length=1)}k.setOverflowHeight(15),D.setOverflowHeight(15),g.selectedGanttServices={},g.resourceFilterHelper=r,g.StateService=b,g.resources=[],g.searchEmployee="",g.resourceFieldToSortyBy="Name",g.successfullyScheduled=0,g.currentSchedulingIndex=0,g.timelineName="",g.nowTimespans=[],g.selectedSkills={},g.pinnedStatusesSF=CustomSettings.pinnedStatusesSF.split(","),g.hasCustomPermission=y.hasCustomPermission,g.crewViewActive=!1,g.crewsFilter=y.crewsFilter,g.useResourceSkillFilter=useResourceSkillFilter,g.numberOfDaysInUtilizationView=14,g.skillsLogicOperator=i.GetUserSettingsProperty("Skills_Logic_Operator__c")||"and",g.locations=i.GetUserSettingsProperty("locations")||[],g.isOptimizationViewer=!0,s.isOptimizationViewer=!0,g.editPalette=y.hasCustomPermission("Gantt_Palettes_Edit"),g.viewPalette=y.hasCustomPermission("Gantt_Palettes_View"),scheduler.attachEvent("onTemplatesReady",function(){scheduler.matrix.MonthlyView&&(scheduler.matrix.MonthlyView.x_size=i.GetUserSettingsProperty("DaysInUtilizationView__c")||14,g.numberOfDaysInUtilizationView=scheduler.matrix.MonthlyView.x_size),t()}),__gantt.ignoreReadonlyGantt226||window.customPermissions.Enable_Gantt_Locker?g.ganttLocked=i.GetUserSettingsProperty("Lock_Gantt__c")||!1:(g.ganttLocked=!0,scheduler.config.readonly=!0),scheduler.config.readonly=g.ganttLocked,g.currentViewOptions={highlightWeekeneds:i.GetUserSettingsProperty("Highlight_Weekeneds__c")||!1,minServiceDuration:void 0===i.GetUserSettingsProperty("Longterm_Min_Service_Duration__c")?8:i.GetUserSettingsProperty("Longterm_Min_Service_Duration__c"),minNaDuration:void 0===i.GetUserSettingsProperty("Longterm_Min_Absence_Duration__c")?8:i.GetUserSettingsProperty("Longterm_Min_Absence_Duration__c"),numOfMonths:i.GetUserSettingsProperty("Longterm_Num_Of_Months__c")||1,showMdt:i.GetUserSettingsProperty("Show_Only_MDT_In_Longterm__c")||!1},window.__currentViewOptions=g.currentViewOptions,g.saveMdtFilterSa=_.debounce(function(){i.SetUserSettingsProperty("Show_Only_MDT_In_Longterm__c",g.currentViewOptions.showMdt),"LongView"===scheduler._mode&&scheduler.setCurrentView(),"LongView"===scheduler._mode&&g.updateGanttDates()},400),g.saveHighlightWeekends=_.debounce(function(){i.SetUserSettingsProperty("Highlight_Weekeneds__c",g.currentViewOptions.highlightWeekeneds),updateViewDebounced()},400),g.saveMinimumLongtermServiceDuration=_.debounce(function(){i.SetUserSettingsProperty("Longterm_Min_Service_Duration__c",g.currentViewOptions.minServiceDuration),"LongView"===scheduler._mode&&scheduler.setCurrentView(),"LongView"===scheduler._mode&&g.updateGanttDates()},400),g.saveMinimumLongtermAbsenceDuration=_.debounce(function(){i.SetUserSettingsProperty("Longterm_Min_Absence_Duration__c",g.currentViewOptions.minNaDuration),"LongView"===scheduler._mode&&scheduler.setCurrentView(),"LongView"===scheduler._mode&&g.updateGanttDates()},400),g.handleLongTermViewSizeChange=_.debounce(function(){var e=i.GetUserSettingsProperty("Longterm_Num_Of_Months__c");g.currentViewOptions.numOfMonths||(g.currentViewOptions.numOfMonths=1),i.SetUserSettingsProperty("Longterm_Num_Of_Months__c",g.currentViewOptions.numOfMonths),t(),"LongView"===scheduler._mode&&scheduler.setCurrentView(),e<g.currentViewOptions.numOfMonths&&g.updateGanttDates()},200),g.shouldShowSkill=function(e,t){return e.toUpperCase().includes(t.toUpperCase())},g.saveUserPropSkillsLogic=function(){i.SetUserSettingsProperty("Skills_Logic_Operator__c",g.skillsLogicOperator)},g.paletteViewActive=!1,g.showPaletteView=function(){window.paletteViewActive=!0,g.paletteViewActive=!0,updateViewDebounced()},g.hidePaletteView=function(){window.paletteViewActive=!1,g.paletteViewActive=!1,updateViewDebounced()},g.$watch("StateService.isLoadingNewLocations",function(e,t){void 0!==t&&!1!==t||1!=e||(g.paletteViewActive=!1)}),s.statusTranslations=y.statusTranslations,s.$on("moveToCrewView",function(){s.crewViewActive=!0,g.crewViewActive=!0,d.isCrewViewActive=!0}),g.$watch("resourceFilterHelper",function(e,t){$("#resourceExplainCrap").html(g.resourceFilterHelper.generateFilterExplanation(g.resourceFilters.showWorkingResource)),angular.equals(e,t)||i.SetUserSettingsProperty("Resource_Filter__c",JSON.stringify({sortBy:g.resourceFilterHelper.resourceFieldToSortyBy,asc:g.resourceFilterHelper.descending,showWorkingResource:g.resourceFilters.showWorkingResource,booleanFields:g.resourceFilterHelper.selectionInfo.resourceFilteringOptions,picklistField:g.resourceFilterHelper.selectionInfo.selectedPicklist,picklistOptions:g.resourceFilterHelper.selectionInfo.picklistOptions,picklistOptionsModel:g.resourceFilterHelper.selectionInfo.picklistOptionsModel,picklistNullValues:g.resourceFilterHelper.selectionInfo.picklistNullValues,crewsOption:g.resourceFilterHelper.selectionInfo.crewsSelectionOptions.selectedPicklist}))},!0),g.absencesTypeLoaded=!1,g.defaultDragNa={selectedNaDuration:JSON.parse(i.GetUserSettingsProperty("Drag_Na_Duration__c"))||60,selectedNaType:i.GetUserSettingsProperty("Drag_Na_Type__c"),selectedNaLabel:i.GetUserSettingsProperty("Drag_Na_Label__c")},g.getEmployeeAbsenceTypes=function(){g.absencesTypeLoaded||l.getEmployeeAbsenceTypes().then(function(e){g.absencesTypeLoaded=!0,g.nonAvailabilityTypes=e,g.defaultDragNa.selectedNaType=i.GetUserSettingsProperty("Drag_Na_Type__c")||g.nonAvailabilityTypes[Object.keys(g.nonAvailabilityTypes)[0]]})},g.businessHoursRange={start:y.ganttSettings.startHour,end:y.ganttSettings.finishHour,includeWeekends:i.GetUserSettingsProperty("Include_Weekends__c")},g.resourceFilters={showWorkingResource:!!JSON.parse(i.GetUserSettingsProperty("Resource_Filter__c"))&&JSON.parse(i.GetUserSettingsProperty("Resource_Filter__c")).showWorkingResource,resourcesWorkingInRange:{}},g.isInConsole=b.isInConsole,g.openConsoleTab=y.openConsoleTab,g.capacityFields=B.capacityCalculationFields,Object.defineProperty(g.selectedGanttServices,"getSelected",{enumrable:!1,value:function(){var e,t=[];for(e in this)this[e]&&t.push(e);return t}}),g.isGanttFilterApplied=function(){return y.crewsFilter||g.skillsFilter||r.isResourceFilterApplied()||g.resourceFilters.showWorkingResource},cachedDomElements.timesDragFix||(cachedDomElements.timesDragFix=$("#timesDragFix"));var R=!0;function O(){var e;R?R=!1:(setHoursToDisplay(g.businessHoursRange.start,g.businessHoursRange.end,g.businessHoursRange.includeWeekends),scheduler.setCurrentView(),y.ganttSettings.startHour=g.businessHoursRange.start,y.ganttSettings.finishHour=g.businessHoursRange.end,(e={}).Gantt_View_Start_Hour__c=y.ganttSettings.startHour,e.Gantt_View_Finish_Hour__c=y.ganttSettings.finishHour,e.Include_Weekends__c=g.businessHoursRange.includeWeekends,i.SetUserSettingProperties(e))}function F(e,t){null!==(t=""===t?prompt(customLabels.msg_to_post_to_chatter,""):t)&&(""===t?alert(customLabels.no_empty_msg_to_chatter):(1===e.length&&(S.recentlyUsed[e[0]]=!0),S.postToChatter(e,t).then(function(e){})))}g.$watchCollection("businessHoursRange",O),c.promises.resources().then(function(){g.resources=c.getResources}),g.saveDragNaDefaults=function(e){switch(e){case"duration":i.SetUserSettingsProperty("Drag_Na_Duration__c",g.defaultDragNa.selectedNaDuration);break;case"type":i.SetUserSettingsProperty("Drag_Na_Type__c",g.defaultDragNa.selectedNaType);break;case"label":i.SetUserSettingsProperty("Drag_Na_Label__c",g.defaultDragNa.selectedNaLabel)}},g.getTimePhasedObjects=function(e){var t=scheduler.getState().min_date,i=scheduler.getState().max_date,n=864e5;return"LongView"===scheduler._mode&&(n*=scheduler.matrix.LongView.x_length),"left"===e?(t.setTime(t.getTime()-n),i.setTime(i.getTime()-n)):"right"===e&&(t.setTime(t.getTime()+n),i.setTime(i.getTime()+n)),d.getTimePhasedObjects(t,i).then(function(e){var t;s.$broadcast("ganttFinishedLoadingServices"),updateViewDebounced(),C&&("Always"!==window.__gantt.checkRulesMode&&m.calculateKpis(),C=!1,updateViewDebounced(),t=null,-1<document.URL.indexOf("service=")&&(t=document.URL.substr(document.URL.indexOf("service=")+8,18)),scheduler._events[t]?(scheduler._select_id=t,scheduler.select(t),setTimeout(function(){y.showOnGantt(t)},0)):t&&alert(customLabels.cant_display_service))})},g.updateGanttDates=function(e){var t=scheduler.getState().min_date,i=scheduler.getState().max_date,n=864e5;return"LongView"===scheduler._mode&&(n*=scheduler.matrix.LongView.x_length),"left"===e?(t.setTime(t.getTime()-n),i.setTime(i.getTime()-n)):"right"===e&&(t.setTime(t.getTime()+n),i.setTime(i.getTime()+n)),function(e){var t;s.$broadcast("ganttFinishedLoadingServices"),updateViewDebounced(),C&&("Always"!==window.__gantt.checkRulesMode&&m.calculateKpis(),C=!1,updateViewDebounced(),t=null,-1<document.URL.indexOf("service=")&&(t=document.URL.substr(document.URL.indexOf("service=")+8,18)),scheduler._events[t]?(scheduler._select_id=t,scheduler.select(t),setTimeout(function(){y.showOnGantt(t)},0)):t&&alert(customLabels.cant_display_service))}},g.changeDatesByArrows=function(e){updateViewDebounced(),g.updateGanttDates(e)},scheduler.attachEvent("onDblClick",function(e,t){y.safeApply(g,function(){"service"===scheduler.getEvent(e).type?(S.recentlyUsed[e]=!0,o.open(e)):("contractorcapacity"===scheduler.getEvent(e).type?H:u).open(e)})}),scheduler.attachEvent("onBeforeFolderToggle",function(e,t){return folderJustToggled=!0,y.safeApply(g,function(){b.ganttOpenedTerritories[e.key]=t,J()}),!0});var J=_.debounce(function(){i.SetUserSettingsProperty("Toggled_Territories__c",JSON.stringify(b.ganttOpenedTerritories))},800);function M(){for(var e in g.selectedGanttServices)delete g.selectedGanttServices[e]}scheduler.attachEvent("onBeforeViewChange",function(e,t,i,n){return"MonthlyView"===e&&"MonthlyView"!==i&&"__Utilization__"===r.resourceFieldToSortyBy&&(r.resourceFieldToSortyBy="Name"),!0}),scheduler.attachEvent("onViewChange",function(e,t){removeAllHolidayPopovers(),y.safeApply(g,function(){switch(scheduler._mode){case"ZoomLevel2":g.timelineName=customLabels.In_Day;break;case"ZoomLevel3":g.timelineName=customLabels.Daily;break;case"ZoomLevel4":g.timelineName=customLabels.X2_Days;break;case"ZoomLevel5":g.timelineName=customLabels.X3_Days;break;case"ZoomLevel6":g.timelineName=customLabels.Weekly;break;case"ZoomLevel7":g.timelineName=customLabels.TwoWeeks;break;case"MonthlyView":g.timelineName=customLabels.Utilization;break;case"MTDView":g.timelineName=customLabels.MDTVIEW;break;case"LongView":g.timelineName=customLabels.LongView}$("#MonthlyLocationViewTooltip").remove(),N(),updateViewDebounced(),scheduler._old.mode===e&&scheduler._old.date===t||m.calculateKpis()})}),scheduler.attachEvent("onBeforeDrag",function(e,t,i){if(!e||!scheduler._events[e].isDummy&&!window.__lockedServicesIds[e]){var n=void 0,i=i.ctrlKey||i.metaKey;if(!e||"create"===t){if(!i)for(n in g.selectedGanttServices)g.selectedGanttServices[n]=!1,scheduler.getRenderedEvent(n)&&scheduler.updateEvent(n);return!1}if(e&&"service"===scheduler.getEvent(e).type){if(i)return D.hide(),g.selectedGanttServices[e]?g.selectedGanttServices[e]=!1:g.selectedGanttServices[e]=!0,scheduler.updateEvent(e),!1;for(n in g.selectedGanttServices[e]=!0,g.selectedGanttServices)n!==e&&(g.selectedGanttServices[n]=!1,scheduler.getEvent(n)&&scheduler.getSection(scheduler.getEvent(n).resourceId)&&scheduler.updateEvent(n))}else if(!i&&1<=g.selectedGanttServices.getSelected().length)for(n in g.selectedGanttServices)g.selectedGanttServices[n]=!1,scheduler.getRenderedEvent(n)&&scheduler.updateEvent(n);if((window.__gantt.ignoreReadonlyGantt226||window.customPermissions.Enable_Drag_And_Drop||!scheduler._events[e])&&!("service"!==scheduler.getEvent(e).type&&"na"!==scheduler.getEvent(e).type||e&&"service"===scheduler.getEvent(e).type&&scheduler.getEvent(e).pinned&&preventUpdateOfPinned))return!0}}),g.$watchCollection("selectedGanttServices",function(e,t){globalSelectedGanttServices=g.selectedGanttServices}),g.jumpToDate=function(){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"JumpToDate",date:scheduler._date,navigation:!0,handler:function(e,t){scheduler.setCurrentView(e),scheduler.destroyCalendar(),g.changeDatesByArrows()}})};var P=new dhtmlXMenuObject({parent:"contextZone_A",context:!0});P.setOverflowHeight(15),P.addNewChild(P.topId,0,"details",y.getSVGIconHTML(lsdIcons.info)+customLabels.Details,!1),P.attachEvent("onClick",function(e,t,i){switch(e){case"details":y.safeApply(g,function(){u.open(A)});break;case"delete":y.safeApply(g,function(){confirm(customLabels.naDeleteConfirm)&&l.deleteAbsence(A).then(function(e){e?scheduler.deleteEvent(A):alert(customLabels.Failed_To_Delete_Break)})});break;default:if(0===e.indexOf("custom_")){var n=scheduler._events[A].type,s=parseInt(e.split("_")[1]),r=y.getCustomActions(n)[s];if(r.visualforce){var s=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),o=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear();p.open(r.name,r.visualforce+"?id="+A+"&type="+n+"&start="+s+"&end="+o);break}a.callRemoteAction(RemoteActions.runCustomAbsenceAction,r.className,A,n,scheduler._min_date,scheduler._max_date).then(function(e){e&&y.addNotification(r.name,e,null,null)}).catch(function(e){return y.addNotification(r.name,e.message,null,null)});break}}}),k.addNewChild(k.topId,0,"details",y.getSVGIconHTML(lsdIcons.info)+customLabels.Details,!1),k.addNewChild(k.topId,3,"reschedule",y.getSVGIconHTML(lsdIcons.calendar)+customLabels.Reschedule,!1),window.customPermissions.Enable_Check_Rules&&k.addNewChild(k.topId,12,"validate",y.getSVGIconHTML(lsdIcons.violation)+customLabels.check_rules_action_label,!1),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Get_Candidates||window.__gantt.ignoreReadonlyGantt226)&&k.addNewChild(k.topId,4,"candidates",y.getSVGIconHTML(lsdIcons.candidates)+customLabels.Get_Candidates,!1),k.addNewChild(k.topId,10,"reshuffle",y.getSVGIconHTML(lsdIcons.retweet)+customLabels.Reshuffle,!1),k.addNewChild(k.topId,11,"groupNearby",y.getSVGIconHTML(lsdIcons.groupNearby)+customLabels.GroupNearby,!1),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Change_Status||window.__gantt.ignoreReadonlyGantt226)&&k.addNewChild(k.topId,5,"status",y.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1),k.addNewChild(k.topId,6,"map",y.getSVGIconHTML(lsdIcons.world)+customLabels.Map,!1),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Unschedule||window.__gantt.ignoreReadonlyGantt226)&&k.addNewChild(k.topId,8,"unschedule",y.getSVGIconHTML(lsdIcons.na)+customLabels.Unschedule,!1),fieldTrackingEnabled.service&&(k.addNewChild(k.topId,7,"chatter",y.getSVGIconHTML(lsdIcons.chat)+customLabels.Chatter+"<i id='chatterArrowContext' class='fa fa-caret-right chatter-carret'></i>",!1),k.addNewChild("chatter",0,"chatter_welldone",y.getSVGIconHTML(lsdIcons.like)+customLabels.well_done,!1),k.addNewChild("chatter",1,"chatter_hurryup",y.getSVGIconHTML(lsdIcons.hurry)+customLabels.Hurry_up,!1),k.addNewChild("chatter",2,"chatter_requestupdate",y.getSVGIconHTML(lsdIcons.help)+customLabels.Request_update,!1),k.addNewChild("chatter",3,"chatter_custom",y.getSVGIconHTML(lsdIcons.threedots)+customLabels.Custom_message,!1)),y.customActionsPromise.then(function(){y.getCustomActions("gantt").forEach(function(e,t){e.icon?k.addNewChild(k.topId,12+t,"custom_"+t,y.getSVGIconHTML(e.icon)+e.name.encodeHTML(),!1):k.addNewChild(k.topId,12+t,"custom_"+t,e.name.encodeHTML(),!1)})}),v.isActive()&&y.hasCustomPermission("Bundle_Unbundle")&&(k.addNewChild(k.topId,41,"bundler",y.getSVGIconHTML(f.Bundle.icon)+f.Bundle.label,!1),k.addNewChild(k.topId,42,"unbundler",y.getSVGIconHTML(f.Unbundle.icon)+f.Unbundle.label,!1));var x={};function E(e){for(var t in g.selectedGanttServices)g.selectedGanttServices[t]&&(S.flagged[t]=e);updateViewDebounced()}function X(e){var e=0<arguments.length&&void 0!==e?e:1,t=Math.abs(scheduler._max_date.getTime()-scheduler._min_date.getTime()),t=Math.ceil(t/864e5)*e,e=new Date(scheduler._min_date);e.setDate(e.getDate()+t),scheduler.setCurrentView(e,scheduler._mode)}function N(){if(scheduler._is_initialized()&&g.datalessMethods){for(var e=0;e<g.nowTimespans.length;e++)scheduler.deleteMarkedTimespan(g.nowTimespans[e]);g.nowTimespans.length=0;for(var t=scheduler.serverList("resources"),i=getMinAndMaxHoursToDisplay(),n=0;n<t.length;n++){var s=new Date,s=new Date(s.valueOf()+6e4*s.getTimezoneOffset());if(useLocationTimezone?s.setMinutes(s.getMinutes()+y.getLocationOffset(s,t[n].key)):s=y.convertDateBetweenTimeZones(s,"GMT",userTimeZone),i.min<=s.getHours()&&s.getHours()<i.max&&!g.datalessMethods.isDateInsideWeekend(s)&&"MonthlyView"!==scheduler._mode){var r={};r[scheduler.getState().mode]=[];for(var o=0;o<t[n].children.length;o++)r[scheduler.getState().mode].push(t[n].children[o].key);g.nowTimespans.push(scheduler.addMarkedTimespan({start_date:s,end_date:scheduler.date.add(s,1,"minute"),css:"dhx_now_time dhx_matrix_now_time",sections:r}))}}}}scheduler.attachEvent("onContextMenu",function(e,t){if(scheduler.config.readonly)return!0;if(e&&"service"!==scheduler.getEvent(e).type&&"break"!==scheduler.getEvent(e).type&&"na"!==scheduler.getEvent(e).type)return!1;var i;if(v.isActive()&&(n=g.selectedGanttServices.getSelected(),i=[],n.map(function(e){i.push(scheduler._events[e])}),y.hasCustomPermission("Bulk_Bundle")&&(D.hideItem("bundler"),f.Bundle.canInvoke(i)&&D.showItem("bundler")),y.hasCustomPermission("Bulk_Unundle")&&(D.hideItem("unbundler"),f.Unbundle.canInvoke(i)&&D.showItem("unbundler"))),e){k.hide(),D.hide(),P.hide(),scheduler.dhtmlXTooltip.hide();var n=0,s=0;if(t.pageX||t.pageY?(n=t.pageX,s=t.pageY):(t.clientX||t.clientY)&&(n=t.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,s=t.clientY+document.body.scrollTop+document.documentElement.scrollTop),g.selectedGanttServices.getSelected().length<2){if("break"===scheduler._events[e].type)return P.removeItem("delete"),y.getCustomActions("na").forEach(function(e,t){P.removeItem("custom_"+t)}),y.getCustomActions("break").forEach(function(e,t){P.removeItem("custom_"+t)}),y.getCustomActions("break").forEach(function(e,t){P.addNewChild(k.topId,t+10,"custom_"+t,y.getSVGIconHTML(e.icon)+e.name.encodeHTML(),!1)}),P.showContextMenu(n,s),A=e,!1;if("na"===scheduler._events[e].type)return P.removeItem("delete"),P.addNewChild(P.topId,1,"delete",y.getSVGIconHTML(lsdIcons.delete)+customLabels.Delete,!1),y.getCustomActions("na").forEach(function(e,t){P.removeItem("custom_"+t)}),y.getCustomActions("break").forEach(function(e,t){P.removeItem("custom_"+t)}),y.getCustomActions("na").forEach(function(e,t){P.addNewChild(k.topId,12+t,"custom_"+t,y.getSVGIconHTML(e.icon)+e.name.encodeHTML(),!1)}),P.showContextMenu(n,s),A=e,!1;for(var r=e,o=!1,a=0;a<g.pinnedStatusesSF.length;a++)scheduler._events[r].status===g.pinnedStatusesSF[a]&&(o=!0);if(v.isActive()&&y.hasCustomPermission("Bundle_Unbundle")&&(f.Bundle.canInvoke([scheduler._events[r]])?k.showItem("bundler"):k.hideItem("bundler"),f.Unbundle.canInvoke([scheduler._events[r]])?k.showItem("unbundler"):k.hideItem("unbundler")),scheduler._events[r].pinned||o?(k.hideItem("reschedule"),k.hideItem("candidates"),k.hideItem("unschedule"),k.hideItem("status"),k.hideItem("reshuffle"),k.hideItem("groupNearby")):(k.showItem("reschedule"),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Get_Candidates||window.__gantt.ignoreReadonlyGantt226)&&k.showItem("candidates"),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Unschedule||window.__gantt.ignoreReadonlyGantt226)&&k.showItem("unschedule"),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Change_Status||window.__gantt.ignoreReadonlyGantt226)&&k.showItem("status"),k.showItem("reshuffle"),k.showItem("groupNearby")),scheduler._events[r].pinned?k.hideItem("status"):(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Change_Status||window.__gantt.ignoreReadonlyGantt226)&&k.showItem("status"),scheduler._events[r].latitude&&scheduler._events[r].longitude&&y.hasCustomPermission("Group_Nearby")?k.showItem("groupNearby"):k.hideItem("groupNearby"),y.hasCustomPermission("Schedule")?scheduler._events[r].relatedService1&&scheduler._events[r].isImmidietlyFollow?(k.hideItem("reschedule"),k.hideItem("candidates")):scheduler._events[r].isImmidietlyFollow||k.showItem("reschedule"):k.hideItem("reschedule"),y.hasCustomPermission("Reshuffle")?k.showItem("reshuffle"):k.hideItem("reshuffle"),k.removeItem("showRelated"),(scheduler._events[r].isServiceInChain||scheduler._events[r].relatedTo||scheduler._events[r].relatedFather)&&k.addNewChild(k.topId,5,"showRelated",y.getSVGIconHTML(lsdIcons.related)+customLabels.Show_related,!1),b.isMapEnabled()&&null!==scheduler._events[r].latitude?k.showItem("map"):k.hideItem("map"),k.removeItem("flag"),S.flagged[r]?k.addNewChild(k.topId,1,"flag","<span class='emptyFlag'>"+y.getSVGIconHTML(lsdIcons.flag)+"</span> "+customLabels.Unflag,!1):k.addNewChild(k.topId,1,"flag","<span class='fullFlag'>"+y.getSVGIconHTML(lsdIcons.flag)+"</span> "+customLabels.Flag,!1),k.removeItem("pin"),scheduler._events[r].pinned?(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Pin_Service||window.__gantt.ignoreReadonlyGantt226)&&k.addNewChild(k.topId,9,"pin","<span class='emptyFlag'>"+y.getSVGIconHTML(lsdIcons.unpin)+"</span> "+customLabels.Unpin,!1):(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Pin_Service||window.__gantt.ignoreReadonlyGantt226)&&k.addNewChild(k.topId,9,"pin","<span class='fullFlag'>"+y.getSVGIconHTML(lsdIcons.pin)+"</span> "+customLabels.Pin,!1),k.removeItem("consoleTab"),g.isInConsole()&&k.addNewChild(k.topId,1,"consoleTab",y.getSVGIconHTML(lsdIcons.external)+customLabels.Open_Tab,!1),!scheduler.getEvent(e).pinned){var l=scheduler.getEvent(e).status,c=void 0,d=0;if(_.isEmpty(y.statusFlow)){if(k.removeItem("status"),!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Change_Status||window.__gantt.ignoreReadonlyGantt226)for(var u in k.addNewChild(k.topId,5,"status",y.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1),y.statuses)c="ContextMenu_"+y.statusTranslations[y.statuses[u]].split(" ").join(""),k.addNewChild("status",d,"status_change_"+d,"<span class='StatusColorChanger "+c+" "+y.getCSSClassForContext(y.statusTranslations[y.statuses[u]],w)+"'></span>"+y.statusTranslations[y.statuses[u]],!1),x["status_change_"+d++]=y.statuses[u]}else if(y.statusFlow[l]&&0<y.statusFlow[l].length)for(k.removeItem("status"),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Change_Status||window.__gantt.ignoreReadonlyGantt226)&&k.addNewChild(k.topId,5,"status",y.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1),x={},d=0;d<y.statusFlow[l].length;d++)c="ContextMenu_"+y.statusFlow[l][d].split(" ").join(""),k.addNewChild("status",d,"status_change_"+d,"<span class='StatusColorChanger "+c+" "+y.getCSSClassForContext(y.statusFlow[l][d],w)+"'></span>"+y.statusTranslations[y.statusFlow[l][d]],!1),x["status_change_"+d]=y.statusFlow[l][d];else k.removeItem("status")}return k.showContextMenu(n,s),L=e,!1}if(D.removeItem("selectedNumber"),D.addNewChild(D.topId,0,"selectedNumber","<i class='fa fa-check-square-o'></i> "+customLabels.x_services_selected.replaceAll(g.selectedGanttServices.getSelected().length),!0),D.removeItem("status"),!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Change_Status||window.__gantt.ignoreReadonlyGantt226){D.addNewChild(D.topId,4,"status",y.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1),x={};var m,p=0;for(m in y.statuses){var h="ContextMenu_"+y.statusTranslations[y.statuses[m]].split(" ").join("");D.addNewChild("status",p,"status_change_"+p,"<span class='StatusColorChanger "+h+" "+y.getCSSClassForContext(y.statusTranslations[y.statuses[m]],w)+"'></span>"+y.statusTranslations[y.statuses[m]],!1),x["status_change_"+p++]=y.statuses[m]}}return D.showContextMenu(n,s),!1}return!(A=L="")}),k.attachEvent("onShow",function(e){contextShown=!0}),k.attachEvent("onHide",function(e){contextShown=!1}),P.attachEvent("onShow",function(e){contextShown=!0}),P.attachEvent("onHide",function(e){contextShown=!1}),k.attachEvent("onClick",function(s,e,t){g.$evalAsync(function(){switch(s){case"bundler":f.Bundle.invoke([scheduler._events[L]],b.selectedPolicyId).then(function(e){M()},function(e){});break;case"unbundler":f.Unbundle.invoke([scheduler._events[L]],b.selectedPolicyId).then(function(){M()},function(){M()});break;case"details":y.safeApply(g,function(){o.open(L)});break;case"consoleTab":g.openConsoleTab(null,L);break;case"flag":g.$evalAsync(function(){S.flagged[L]=!S.flagged[L],scheduler.updateEvent(L)});break;case"pin":S.changePin([scheduler._events[L].id],!scheduler._events[L].pinned).then(function(){return updateViewDebounced()});break;case"reschedule":g.$evalAsync(function(){S.autoScheduleService(L).then(function(e){0===e.services.length&&alert(customLabels.NoCandidates),S.drawServicesAndAbsences(e.services,e.absences)}).catch(function(e){var t=d.serviceAppointments()[L].name;y.addNotification(t+" - "+customLabels.Action_Could_Not_Be_Performed,e.message,function(){o.open(L)})})});break;case"reshuffle":g.$evalAsync(function(){a.callRemoteAction(RemoteActions.runReshuffle,L,b.selectedPolicyId).then(function(e){},function(e){y.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message)})});break;case"groupNearby":g.$evalAsync(function(){a.callRemoteAction(RemoteActions.runGroupNearby,L,b.selectedPolicyId).then(function(e){},function(e){y.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message)})});break;case"candidates":q.get(L);break;case"chatter_welldone":F([L],customLabels.Well_done_mate);break;case"chatter_hurryup":F([L],customLabels.hurry_up_with_this_service);break;case"chatter_requestupdate":F([L],customLabels.please_update_service);break;case"chatter_custom":F([L],"");break;case"unschedule":g.$evalAsync(function(){ee([L])});break;case"map":g.showOnMap(L);break;case"showRelated":if(usingNewMstModel||scheduler._events[L].isServiceInChain)return void p.open(customLabels.ComplexRelatedServicesForGanttLB+" "+scheduler._events[L].name,mstPage+"?ingantt=true&id="+L);if(scheduler._events[scheduler._events[L].relatedFather])return void y.showOnGantt(scheduler._events[L].relatedFather);if(scheduler._events[scheduler._events[L].relatedTo])return void y.showOnGantt(scheduler._events[L].relatedTo);scheduler._events[L].relatedFather?alert(customLabels.related_x_not_scheduled_no_display.replaceAll(d.serviceAppointments()[scheduler._events[L].relatedFather].name)):alert(customLabels.related_x_not_scheduled_no_display.replaceAll(d.serviceAppointments()[scheduler._events[L].relatedTo].name));break;case"validate":S.checkRules([L]).then(S.drawViolationsOnGantt);break;default:if(0===s.indexOf("custom_")){var e=parseInt(s.split("_")[1]),t=[L],i=y.getCustomActions("gantt")[e];if(i.visualforce){var e=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),n=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear();p.open(i.name,i.visualforce+"?id="+L+"&start="+e+"&end="+n);break}a.callRemoteAction(RemoteActions.runCustomServiceAction,i.className,t,scheduler._min_date,scheduler._max_date).then(function(e){e&&y.addNotification(i.name,e,null,null)}).catch(function(e){return y.addNotification(i.name,e.message,null,null)});break}g.$evalAsync(function(){te([L],x[s])})}})}),$(".dhtmlxMenu_dhx_skyblue_SubLevelArea_Polygon").mouseover(function(){scheduler.dhtmlXTooltip.hide()}),D.addNewChild(D.topId,1,"flag",y.getSVGIconHTML(lsdIcons.flag)+customLabels.Flag,!1),D.addNewChild(D.topId,2,"unflag","<span class='emptyFlag'>"+y.getSVGIconHTML(lsdIcons.flag)+"</span>"+customLabels.Unflag,!1),D.addNewChild(D.topId,3,"reschedule",y.getSVGIconHTML(lsdIcons.calendar)+customLabels.Reschedule,!1),window.customPermissions.Enable_Check_Rules&&D.addNewChild(D.topId,12,"validate",y.getSVGIconHTML(lsdIcons.violation)+customLabels.check_rules_action_label,!1),(!window.__gantt.ignoreReadonlyGantt226&&window.customPermissions.Show_Unschedule||window.__gantt.ignoreReadonlyGantt226)&&D.addNewChild(D.topId,5,"unschedule",y.getSVGIconHTML(lsdIcons.na)+customLabels.Unschedule,!1),(!window.customPermissions.ignoreReadonlyGantt226&&window.customPermissions.Show_Pin_Service||window.customPermissions.ignoreReadonlyGantt226)&&(D.addNewChild(D.topId,7,"pin",y.getSVGIconHTML(lsdIcons.pin)+customLabels.Pin,!1),D.addNewChild(D.topId,8,"unpin","<span class='emptyFlag'>"+y.getSVGIconHTML(lsdIcons.unpin)+"</span>"+customLabels.Unpin,!1)),y.customActionsPromise.then(function(){y.getCustomActions("gantt").forEach(function(e,t){e.icon?D.addNewChild(D.topId,t+12,"custom_"+t,y.getSVGIconHTML(e.icon)+e.name.encodeHTML(),!1):D.addNewChild(D.topId,t+12,"custom_"+t,e.name.encodeHTML(),!1)})}),v.isActive()&&(y.hasCustomPermission("Bulk_Bundle")&&D.addNewChild(D.topId,41,"bundler",y.getSVGIconHTML(f.Bundle.icon)+f.Bundle.label,!1),y.hasCustomPermission("Bulk_Unbundle")&&D.addNewChild(D.topId,42,"unbundler",y.getSVGIconHTML(f.Unbundle.icon)+f.Unbundle.label,!1)),D.attachEvent("onShow",function(e){contextShown=!0}),D.attachEvent("onHide",function(e){contextShown=!1}),D.attachEvent("onClick",function(s,e,t){g.$evalAsync(function(){switch(s){case"flag":y.safeApply(g,function(){E(!0)});break;case"unflag":y.safeApply(g,function(){E(!1)});break;case"bundler":var e=(g.selectedGanttServices.getSelected()||[]).map(function(e){return scheduler._events[e]});f.Bundle.invoke(e,b.selectedPolicyId).then(function(e){M()},function(e){});break;case"unbundler":e=(g.selectedGanttServices.getSelected()||[]).map(function(e){return scheduler._events[e]});f.Unbundle.invoke(e,b.selectedPolicyId).then(function(e){M()},function(e){});break;case"reschedule":Z.schedule(g.selectedGanttServices.getSelected());break;case"pin":S.changePin(g.selectedGanttServices.getSelected(),!0).then(function(){return updateViewDebounced()});break;case"unpin":S.changePin(g.selectedGanttServices.getSelected(),!1).then(function(){return updateViewDebounced()});break;case"unschedule":ee(g.selectedGanttServices.getSelected());break;case"validate":S.checkRules(g.selectedGanttServices.getSelected()).then(S.drawViolationsOnGantt);break;default:if(0===s.indexOf("custom_")){var e=parseInt(s.split("_")[1]),t=g.selectedGanttServices.getSelected(),i=y.getCustomActions("gantt")[e];if(i.visualforce){var e=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),n=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear();p.open(i.name,i.visualforce+"?services="+t.join(",")+"&start="+e+"&end="+n);break}a.callRemoteAction(RemoteActions.runCustomServiceAction,i.className,g.selectedGanttServices.getSelected(),scheduler._min_date,scheduler._max_date).then(function(e){e&&y.addNotification(i.name,e,null,null)}).catch(function(e){return y.addNotification(i.name,e.message,null,null)});break}te(g.selectedGanttServices.getSelected(),x[s])}})}),scheduler.config.readonly=!0,g.ganttLocked=scheduler.config.readonly,g.lockGanttToggle=function(){(window.__gantt.ignoreReadonlyGantt226||window.customPermissions.Enable_Gantt_Locker)&&(scheduler.config.readonly=!scheduler.config.readonly,g.ganttLocked=scheduler.config.readonly,i.SetUserSettingsProperty("Lock_Gantt__c",g.ganttLocked))},g.unSelecteAllSkills=function(){for(var e in g.selectedSkills)g.selectedSkills[e]=!1},g.selectAllSkills=function(){for(var e in g.selectedSkills)g.selectedSkills[e]=!0},g.getSkills=n.getSkills,scheduler.attachEvent("onYScaleClick",function(e,t,i){i.stopPropagation(),i.preventDefault(),window.__lastResourceClicked=t;for(var n=["resourceMenuBtn","resourceMenuIcon"],s=0;s<n.length;s++)if(i.target.classList&&i.target.classList.contains(n[s])||i.target.parentNode&&i.target.parentNode.classList.contains(n[s]))return void V.open(t.resourceId,t.key,i.target);t.children||U.open(t.resourceId,t.key)}),scheduler.attachEvent("onBeforeTooltip",function(e){return setTimeout(function(){var e=$(".dhtmlXTooltip");0!==e.length&&(e.position().top<0?e.css("height",e.height()+e.position().top-15+"px"):15<e.position().top&&e.css("height","initial"))},400),!0}),g.$on("keypress",function(e,t){if($("#MonthlyViewTooltip").remove(),!b.isLightboxOpened()&&!$("*:focus").is("textarea, input"))switch(t.which){case 13:""!==scheduler._select_id&&scheduler._select_id&&"service"===scheduler.getEvent(scheduler._select_id).type&&(S.recentlyUsed[scheduler._selected_id]=!0,o.open(scheduler._select_id));break;case 37:t.shiftKey?(X(-1),g.changeDatesByArrows()):$(".dhx_cal_prev_button").click();break;case 38:var i=$(".dhx_cal_data").scrollTop();$(".dhx_cal_data").scrollTop(i-30);break;case 39:t.shiftKey?(X(),g.changeDatesByArrows()):$(".dhx_cal_next_button").click();break;case 40:i=$(".dhx_cal_data").scrollTop(),$(".dhx_cal_data").scrollTop(i+30);break;case 87:""!==scheduler._select_id&&scheduler._select_id&&"service"===scheduler.getEvent(scheduler._select_id).type&&scheduler.getEvent(scheduler._select_id).parentRecord&&(g.isInConsole()?sforce.console.generateConsoleUrl(["/"+scheduler._events[scheduler._select_id].parentRecord],function(e){e.success?sforce.console.openConsoleUrl(null,e.consoleUrl,!0):y.openLightningPrimaryTab(scheduler._events[scheduler._select_id].parentRecord)}):window.open("../"+scheduler._events[scheduler._select_id].parentRecord));break;case 83:""!==scheduler._select_id&&scheduler._select_id&&"service"===scheduler.getEvent(scheduler._select_id).type&&!scheduler.getEvent(scheduler._select_id).isDummy&&(g.isInConsole()?sforce.console.generateConsoleUrl(["/"+scheduler._select_id],function(e){e.success?sforce.console.openConsoleUrl(null,e.consoleUrl,!0):y.openLightningPrimaryTab(scheduler._select_id)}):window.open("../"+scheduler._select_id));break;case 84:g.jumpToToday();break;case 70:1===g.selectedGanttServices.getSelected().length&&""!==scheduler._select_id&&scheduler._select_id&&"service"===scheduler.getEvent(scheduler._select_id).type&&(S.flagged[scheduler._select_id]?S.flagged[scheduler._select_id]=!1:S.flagged[scheduler._select_id]=!0,scheduler.updateEvent(scheduler._select_id));break;case 48:case 96:g.changeTimeline(0);break;case 49:case 97:g.changeTimeline(1);break;case 50:case 98:g.changeTimeline(2);break;case 51:case 99:g.changeTimeline(3);break;case 55:g.changeTimeline(7);break;case 77:y.hasCustomPermission("MDT_View")&&!y.hasCustomPermission("Longterm_View")&&g.changeTimeline(35);break;case 85:y.hasCustomPermission("Monthly_Utilization")&&monthlyViewSettings.isMonthlyAvailable&&g.changeTimeline(30);break;case 103:g.changeTimeline(7)}}),g.changeTimeline=function(e){var t=scheduler._min_date,i=scheduler._max_date,n=void 0;switch(e){case 0:if((n="ZoomLevel2")===scheduler._mode)return;g.timelineName=customLabels.In_Day;break;case 1:if((n="ZoomLevel3")===scheduler._mode)return;g.timelineName=customLabels.Daily;break;case 2:if((n="ZoomLevel4")===scheduler._mode)return;g.timelineName=customLabels.X2_Days;break;case 3:if((n="ZoomLevel5")===scheduler._mode)return;g.timelineName=customLabels.X3_Days;break;case 7:if((n="ZoomLevel6")===scheduler._mode)return;g.timelineName=customLabels.Weekly;break;case 14:if((n="ZoomLevel7")===scheduler._mode)return;g.timelineName=customLabels.TwoWeeks;break;case 30:if((n="MonthlyView")===scheduler._mode)return;g.timelineName=customLabels.Utilization;break;case 35:if((n="MTDView")===scheduler._mode)return;g.timelineName=customLabels.MDTVIEW;break;case 180:if((n="LongView")===scheduler._mode)return;g.timelineName=customLabels.LongView}scheduler.setCurrentView(t,n),g.changeDatesByArrows(i)},setInterval(N,6e5),g.jumpToToday=function(){var e=new Date;e.setHours(0),e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0),scheduler.setCurrentView(e),g.changeDatesByArrows()},s.$on("afterShowEvent",function(){setTimeout(function(){g.changeDatesByArrows(),N(),updateViewDebounced()},800)}),g.showOnMap=function(e){s.$broadcast("showServiceOnMap",e),y.safeApply(g)},scheduler.attachEvent("onBeforeEventChanged",function(e,t,i,n){var s=e.resourceId.split("_"),s=h.isTerritoryHasInDayOptimizationInProgress(e.start_date,e.end_date,s[1]);if(s){if(!1===confirm(customLabels.In_Day_Optimization_In_Progress_Confirm))return!1;"Rollback"===y.getSchedulingPolicyObject(s.policy)[fieldNames.SchedulingPolicy.Commit_Mode__c]&&h.updateProgressStatus(s.id,"Aborted")}var r,o,a;if(t.ctrlKey&&!e.isImmidietlyFollow&&S.handleSnap(e,t),e.resourceId===n.resourceId){if(s=e.start_date.getTime(),r=e.end_date.getTime(),o=n.start_date.getTime(),a=n.end_date.getTime(),Math.abs((s-o)/1e3/60)<minDragMinutes||Math.abs((r-a)/1e3/60)<minDragMinutes)return cachedDomElements.timesDragFix.hide(),!1}else if("na"===e.type)return!1;if(b.areContractorsSupported()&&"service"===e.type&&c.getResources()[e.getGanttResource()].isCapacityBased){for(var l in d.resourceCapacities()){l=d.resourceCapacities()[l];if(l.resource===c.getResources()[e.getGanttResource()].id&&(e.start.getTime()>=l.start_date.getTime()&&e.start.getTime()<=l.end_date.getTime()))return e.resourceBeforeDrag=n.resourceId,e.eventBeforeDrag=n,ie(e),!0}return cachedDomElements.timesDragFix.hide(),alert(customLabels.serviceCantBeAssignedWithoutCapacity),!1}return I=GanttService.copy(n),snapTo=t.ctrlKey,ie(e),e.resourceBeforeDrag=n.resourceId,e.eventBeforeDrag=n,!0}),g.updateMonthlyKpi=function(){"MonthlyView"===scheduler._mode&&updateViewDebounced(),Q()};var Q=_.debounce(function(){i.SetUserSettingsProperty("Utilization_Properties__c",JSON.stringify(g.capacityFields))},800);function ee(e){var t,i;confirm(customLabels.are_you_sure_unschedule)&&(t=[],i=[],e.forEach(function(e){i.push(d.serviceAppointments()[e]),t.push(d.serviceAppointments()[e].resource),S.recentlyUsed[e]=!0}),S.unscheduleServices(e,b.selectedPolicyId).then(function(e){M(),S.drawServicesAndAbsences(e.services,e.absences),m.calculateKpis()}).catch(function(e){y.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)}))}function te(e,t){var i,n;t===w.CANCELED&&!confirm(customLabels.AreYouSureYouWantToCancel)||(i=[],n=[],e.forEach(function(e){n.push(d.serviceAppointments()[e]),i.push(d.serviceAppointments()[e].resource),S.recentlyUsed[e]=!0}),S.changeStatus(e,t).then(function(e){M(),S.drawServicesAndAbsences(e.services)}).catch(function(e){y.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)}))}function ie(e){var t=(e.start_date.getMinutes()+e.travelTo/60)%60,i="na"===e.type?e.end-e.start:e.schedEndTime-e.schedStartTime,n=t%serviceJumpsOnGantt,t=serviceJumpsOnGantt-t%serviceJumpsOnGantt;0!=n&&(e.start_date=t<n?new Date(e.start_date.getTime()+60*t*1e3):new Date(e.start_date.getTime()-60*n*1e3),e.end_date=new Date(e.start_date.getTime()+i+1e3*e.travelFrom+1e3*e.travelTo),e.schedStartTime=e.start_date.getTime()+1e3*e.travelTo,e.schedEndTime=e.end_date.getTime()-1e3*e.travelFrom)}g.cancelCrewView=function(){s.crewViewActive=!1,g.crewViewActive=!1,d.isCrewViewActive=!1},s.$on("gotNewTimePhasedObjects",function(e,t){S.drawServicesAndAbsences(t.serviceAppointments,t.resourceAbsences,[],t.resourceCapacities)}),s.$on("timePhasedObjectsCheckRules",function(e,t){S.checkRules(t).then(S.drawViolationsOnGantt)}),scheduler.attachEvent("onEventChanged",function(e,t){"service"!==t.type&&"na"!==t.type||y.safeApply(g,function(){"na"===t.type?l.saveChangesToAbsence(I,t,b.selectedPolicyId).then(function(e){}).catch(function(e){console.warn("Couldn't update absence"),e[0].message?y.addNotification(customLabels.Action_Could_Not_Be_Performed,e[0].message):y.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.user_is_not_allowed_to_perform_action),scheduler.parse([e[1]],"json")}):S.saveChangesToServiceAppointment(I,t).then(function(e){scheduler._select_id=t.id}).catch(function(e){console.warn("Couldn't update service. "+e[2]),y.addNotification(customLabels.Action_Could_Not_Be_Performed,e[2]||e[0].message.substr(e[0].message.indexOf(",")+1)||customLabels.user_is_not_allowed_to_perform_action),scheduler.parse([e[1]],"json")})})}),g.$on("JumpToDate",function(e,t){scheduler.setCurrentView(t),g.changeDatesByArrows()}),g.$on("GotSlots",function(e,t){var i=getMinAndMaxHoursToDisplay();(t.minDateOfCandidate.getHours()<i.min||t.minDateOfCandidate.getHours()>=i.max)&&confirm(customLabels.confirmChangeBusinessHours)&&(t.minDateOfCandidate.getHours()<i.min?g.businessHoursRange.start=t.minDateOfCandidate.getHours():g.businessHoursRange.end=24,O())}),g.changeUtilizaionDays=function(e){-1===e&&1===g.numberOfDaysInUtilizationView||1===e&&30===g.numberOfDaysInUtilizationView||(g.numberOfDaysInUtilizationView+=e,g.daysInUtilizationChanged())},g.daysInUtilizationChanged=function(){scheduler.matrix.MonthlyView.x_size=g.numberOfDaysInUtilizationView,i.SetUserSettingsProperty("DaysInUtilizationView__c",g.numberOfDaysInUtilizationView),"MonthlyView"===scheduler._mode&&(scheduler.updateView(),g.updateGanttDates())},g.getRowSizeClass=function(){return y.ganttSettings.resourceRowHeight+"-css"},g.filterVisibility={hours:!0,resources:!1,skills:!1,utilization:!1,palettes:!1},g.needToLoadSkills=!0,g.needToLoadPalettes=!0,g.werePalettesLoaded=T.werePalettesLoaded,g.changeGanttFilterTab=function(e){for(var t in"skills"===e&&g.needToLoadSkills&&n.getSkillsFromSfdc().then(function(){return g.needToLoadSkills=!1}),"palettes"===e&&g.needToLoadPalettes&&!T.werePalettesLoaded()&&T.getGanttPalettes(!0).then(function(){return g.needToLoadPalettes=!1}),g.filterVisibility)g.filterVisibility[t]=t===e},scheduler.attachEvent("onAfterEventDisplay",function(e){setTimeout(function(){e.showEventPopupEffect=!1,m.calculateKpis(),s.$broadcast("afterShowEvent")},2500)}),g.updateWorkingReosourcesFilter=_.debounce(function(){g.resourceFilterHelper.showWorkingResource=g.resourceFilters.showWorkingResource},300),s.$on("flagService",function(e,t){S.flagged[t]?S.flagged[t]=!S.flagged[t]:S.flagged[t]=!0,scheduler.updateEvent(t)})}]),!function(){function e(){function e(i,s,r,e,o,a,l,t,n,c,d,u,m,p,h){i.bulkActionsOrder=bulkActionsOrder,i.customActions=[],i.isOptimizationLoaded=h.isOptimizationLoaded,i.isShowingOutputJson=h.isShowingOutputJson,i.actionNames={"Select Optimization Request":{name:"Select Optimization Request",nameLabel:"Select OR",icon:lsdIcons.calendar},"Show Optimization Results":{name:"Show Optimization Results",nameLabel:"Show Results",icon:lsdIcons.calendar},"Show Gantt Before Optimization":{name:"Show Gantt Before Optimization",nameLabel:"Show Before",icon:lsdIcons.calendar},Schedule:{name:"Schedule",nameLabel:customLabels.Schedule,icon:lsdIcons.calendar},Dispatch:{name:"Dispatch",nameLabel:customLabels.Dispatch,icon:lsdIcons.dispatch},Optimize:{name:"Optimize",nameLabel:customLabels.Optimize,icon:lsdIcons.magicwand},"Flag-Unflag":{name:"Flag-Unflag",nameLabel:customLabels.Flag_Unflag,icon:lsdIcons.flag},Unschedule:{name:"Unschedule",nameLabel:customLabels.Unschedule,icon:lsdIcons.na},"Check Rules":{name:"Check Rules",nameLabel:customLabels.check_rules_action_label,icon:lsdIcons.violation,isAvailable:function(){return window.customPermissions.Enable_Bulk_Check_Rules}},Bundle:{name:"Bundle",nameLabel:m.Bundle.label,icon:m.Bundle.icon,isAvailable:function(){return p.isActive()}},Unbundle:{name:"Unbundle",nameLabel:m.Unbundle.label,icon:m.Unbundle.icon,isAvailable:function(){return p.isActive()}}},r.customActionsPromise.then(function(){var e,t=r.getCustomActions("bulk");(e=i.customActions).push.apply(e,_toConsumableArray(t))}),i.runCustomServiceAction=function(i){var e,t,n=a.getSelected();i.visualforce?(e=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),t=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear(),1===n.length?d.open(i.name,i.visualforce+"?id="+n[0]+"&start="+e+"&end="+t):d.open(i.name,i.visualforce+"?services="+n.join(",")+"&start="+e+"&end="+t)):0!==n.length&&c.callRemoteAction(RemoteActions.runCustomServiceAction,i.className,n,scheduler._min_date,scheduler._max_date).then(function(t){c.callRemoteAction(RemoteActions.getServicesById,n).then(function(e){e=u.updateTimePhaseData(e,"service").services;s.drawServicesAndAbsences(e,[],[],[]),t&&r.addNotification(i.name,t,null,null)})}).catch(function(e){return r.addNotification(i.name,e.message,null,null)})},i.isActionAvailable=function(e){return!i.actionNames[e]||!i.actionNames[e].isAvailable||i.actionNames[e].isAvailable()},i.checkHasCustomPermission=function(e){return null==r.hasCustomPermission("Bulk_"+e)||r.hasCustomPermission("Bulk_"+e)},i.openBulkAction=function(e){switch(e){case"Select Optimization Request":h.open();break;case"Show Optimization Results":h.loadOptimizationResponseOutput();break;case"Show Gantt Before Optimization":h.loadOptimizationRequestInput(h.i_OptimizationRequestName());break;case"Unschedule":o.open();break;case"Optimize":l.open();break;case"Flag-Unflag":for(var t=a.getSelected(),i=0;i<t.length;i++)s.flagged[t[i]]=!s.flagged[t[i]];updateViewDebounced();break;case"Check Rules":var n=a.getSelected();0<n.length&&s.checkRules(n).then(s.drawViolationsOnGantt);break;case"Bundle":n=a.getSelected().map(function(e){return u.serviceAppointments()[e]});m.Bundle.invoke(n).then(function(){}).catch(function(e){});break;case"Unbundle":n=a.getSelected().map(function(e){return u.serviceAppointments()[e]});m.Unbundle.invoke(n).then(function(){}).catch(function(e){})}}}e.$inject=["$scope","servicesService","utils","bulkDispatchService","bulkUnscheduleService","ServiceSelectorService","optimizeLightboxService","bulkScheduleService","rdOptimizeLightboxService","sfdcService","GeneralLightbox","TimePhasedDataService","BundleActions","BundleService","LoadOptiViewerDataService"];return{restrict:"E",template:'<div id="quickActionsButtons">\n\t\t\t                    <div fsl-key-press tabindex="0" id="actionQuickFirst" \n                                    class="truncate quickActionBtn" \n                                    ng-click="openBulkAction(actionNames[\'Select Optimization Request\'].name)" \n                                    title="{{actionNames[\'Select Optimization Request\'].nameLabel}}">\n                                        {{actionNames[\'Select Optimization Request\'].nameLabel}}\n\t\t\t\t\t\t\t\t</div>\n                                <div fsl-key-press tabindex="0" id="actionQuickSecond" \n                                    class="truncate quickActionBtn"\n                                    ng-show="isOptimizationLoaded() && !isShowingOutputJson()" \n                                    ng-click="openBulkAction(actionNames[\'Show Optimization Results\'].name)" \n                                    title="{{actionNames[\'Show Optimization Results\'].nameLabel}}">\n                                        {{actionNames[\'Show Optimization Results\'].nameLabel}}\n\t\t\t\t\t\t\t\t</div>\n                                <div fsl-key-press tabindex="0" id="actionQuickSecond" \n                                    class="truncate quickActionBtn"\n                                    ng-show="isOptimizationLoaded() && isShowingOutputJson()"  \n                                    ng-click="openBulkAction(actionNames[\'Show Gantt Before Optimization\'].name)" \n                                    title="{{actionNames[\'Show Gantt Before Optimization\'].nameLabel}}">\n                                        {{actionNames[\'Show Gantt Before Optimization\'].nameLabel}}\n\t\t\t\t\t\t\t\t</div>\n\t                    </div>',scope:{},controller:e}}angular.module("serviceExpert").directive("bulkActionsButtonOptiViewer",e),e.$inject=[]}(),angular.module("serviceExpert").directive("dhxSchedulerOptiViewer",["$rootScope","$timeout","userSettingsManager","$q","sfdcService","ResourcesAndTerritoriesService","FieldSetFieldsService","TimePhasedDataService",function(c,d,u,m,e,p,h,g){return{restrict:"C",transclude:!0,template:'<div class="dhx_cal_navline" ng-transclude></div><div class="dhx_cal_header"></div><div class="dhx_cal_data"></div>',link:function(e,t,i){window.utils=angular.element("#serviceExpertApp").injector().get("utils");var n=_.debounce(function(e){scheduler.updateCollection("resources",e)},500),i=(e.$watch(i.resources,function(e){folderJustToggled?folderJustToggled=!1:n(e)},!0),t.addClass("dhx_cal_container"),schedulerConfig.configTimelines(),schedulerConfig.setConfigurations(),u.GetUserSettingsProperty("Gantt_View_Start_Hour__c")),s=u.GetUserSettingsProperty("Gantt_View_Finish_Hour__c"),r=u.GetUserSettingsProperty("Resource_Row_Height__c"),o=u.GetUserSettingsProperty("View_Capacity_Type__c"),a=u.GetUserSettingsProperty("Include_Weekends__c"),l=u.GetUserSettingsProperty("Load_On_Today__c");null!==r&&schedulerConfig.setRowHeights(r,!1),null!==o&&setCapacityFilter(o),null!==i&&null!==s&&setHoursToDisplay(i,s,a),c.policy=defaultPolicy,m.all([p.promises.territories(),p.promises.resources(),h.fieldsSetFields()]).then(function(){scheduler.init(t[0],new Date,"ZoomLevel3"),e.scheduler=scheduler,e.datalessMethods=attchDatalessSchedulerEvents(),d(function(){l&&scheduler.setCurrentView(new Date),$("#FirstTimeLoading").remove(),g.promises.initialStmsPhasedData.then(function(){$("#FirstTimeLoading").remove()}),e.getTimePhasedObjects().then(function(){}).catch(function(e){bootstrap.handleError(e)}),c.$broadcast("initCompleted")},20)}).catch(function(e){console.log("err:"+e)})}}}]);var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e)){var i=t,n=[],s=!0,t=!1,r=void 0;try{for(var o,a=e[Symbol.iterator]();!(s=(o=a.next()).done)&&(n.push(o.value),!i||n.length!==i);s=!0);}catch(e){t=!0,r=e}finally{try{!s&&a.return&&a.return()}finally{if(t)throw r}}return n}throw new TypeError("Invalid attempt to destructure non-iterable instance")};function GanttServiceOptiViewer(e,t){if(!t){for(var i in this.sfdcType="service",this.fields={},e.Fields)this.fields[i]=e.Fields[i];if(_.isEmpty(serviceStatusCategories))serviceStatuses;if(_.isEmpty(optiViewerStatusCategories))for(var n in serviceStatuses){var s=n;switch(n){case"COULD_NOT_COMPLETE":s="CannotComplete";break;case"IN_PROGRESS":s="InProgress";break;case"SCHEDULED":s="Scheduled";break;case"NONE":s="None";break;case"DISPATCHED":s="Dispatched";break;case"COMPLETED":s="Completed";break;case"CANCELED":s="Canceled"}optiViewerStatusCategories[serviceStatuses[n]]=s}this.id=e.Id||null,this.name=e.AppointmentNumber||e.Id||null,this.AssignedResourceLastModifiedDate=e.AssignedResourceLastModifiedDate||null,this.ServiceAppointmentLastModifiedDate=e.ServiceAppointmentLastModifiedDate||null,this.accountName=e["Account.Name"]||null,this.accountId=e.AccountId||null,this.latitude=e.Latitude||null,this.longitude=e.Longitude||null,this.arrivalWindowEndTime=e.ArrivalWindowEndTime||null,this.arrivalWindowStartTime=e.ArrivalWindowStartTime||null,this.dueDate=e.DueDate||null,this.ganttDisplay=e.Gantt_Display_Date__c||null,this.durationType=e.DurationType||null,this.earliestStartTime=e.EarliestStartTime||null,this.estDuration=e.Duration||null,this.travelTimeFrom=e.ServiceResources?e.ServiceResources.records[0].EstimatedTravelTimeFrom__c||e.ServiceResources.records[0].FSL__EstimatedTravelTimeFrom__c:null,this.travelTimeTo=e.ServiceResources?e.ServiceResources.records[0].EstimatedTravelTime:null,this.ganttLabel=e.GanttLabel__c||null,this.jeopardy=e.InJeopardy__c||null,this.jeopardyReason=e.jeopardyReasonTranslated||e.InJeopardyReason__c||null,this.parentRecord=e.ParentRecordId||null,this.parentRecordStatus=e.ParentRecordStatusCategory||null,this.parentRecordType=e.ParentRecordType||null,this.pinned=e.Pinned__c||!1,this.isBundleMember=e.IsBundleMember||!1,this.isBundle=e.IsBundle||!1,this.RelatedBundle=e.RelatedBundleId||!1,this.schedEndTime=e.SchedEndTime||null,this.schedStartTime=e.SchedStartTime||null,this.serviceTerritory=e.ServiceTerritory||null,this.serviceTerritoryName=e["ServiceTerritory.Name"]||null,this.status=e.Status||null,this.statusCategory=e.StatusCategory||window.optiViewerStatusCategories[e.Status]||null,this.subject=e.Subject||null,this.ganttColor=e.GanttColor__c||null,this.resource=e.ServiceResources?e.ServiceResources.records[0].ServiceResourceId:null,this.resourceName=e.ServiceResources?e.ServiceResources.records[0].ServiceResourceId:null,this.resourceContractor=e.ResourceContractor||null,this.isAssignToCrew=e.IsAssignToCrew||null,this.assignedResource=e.ServiceResources?e.ServiceResources.records[0].Id:null,this.violations=null,this.relatedTo=e.relatedTo||null,this.relatedFather=null,this.priority=this.minPriority,this.relatedFather=e.relatedFather,this.policyUsed=e.Scheduling_Policy_Used__c||null,this.scheduleMode=e.Schedule_Mode__c||null,this.emergency=e.Emergency__c||!1,this.isServiceInChain=(usingNewMstModel||e.IsInO2Territory)&&e.isServiceInChain,this.relatedService2=e.relatedService2||null,this.relatedService1=e.relatedService1||null,this.relationshipType=e.relationshipType||null,this.isImmidietlyFollow="Immediately Follow"===e.relationshipType,this.ganttPaletteColor=null,this.Use_Async_Logic=e.Use_Async_Logic__c||!1,this.icons=e.GanttIcon__c?e.GanttIcon__c.split(";"):null,this.totalModifiedTimes=this.ServiceAppointmentLastModifiedDate,this.fromGetCandidateFlow=!1,this.AssignedResourceLastModifiedDate&&(this.totalModifiedTimes+=this.AssignedResourceLastModifiedDate),this.icons&&(this.icons=this.icons.map(function(e){return window.encodeURI(e)}));var r,t="WorkOrder"==e.ParentRecordType?CustomSettings.woPriorityField:CustomSettings.woliPriorityField,t=(t&&e.ParentFields&&e.ParentFields[t]&&(this.priority=e.ParentFields[t]),fslNamespace?mdtBooleanField.replace(fslNamespace+"__",""):mdtBooleanField);for(r in this.isMDT=!!e[t],e.MDT_Operational_Time__c?this.calculateMdtTimes(e.MDT_Operational_Time__c):this.isMDT&&(this.mdtTimes={travel:[],working:[]}),this.parentFields={},e.ParentFields)this.parentFields[r]=e.ParentFields[r];this.setSchedulerProperties(),addFieldSetToServiceObject(GanttServiceOptiViewer.prototype.allFieldSetsSet,e,this),this.isMDT&&(this.travelTimeFrom=0,this.travelTimeTo=0)}}function getGanttResourceWithSecondaryStms(e){if(showSecondarySTMs){var t=e.resourceId.split(",");if(e.resourceBeforeDrag&&e.resourceBeforeDrag!=e.resourceId&&1<t.length)for(var i=0;i<t.length;i++)if(e.resourceBeforeDrag.split(",")[i]!=t[i]){e.resourceId=t[i];break}}}function addFieldSetToServiceObject(e,t,i){for(var n in e){var s=null;if((s=t[e[n].APIName])||0==s){switch(e[n].Type){case"DATE":case"DATETIME":s=__setTimeZoneOffsetToDateField(s),i[e[n].APIName]=s.getTime();break;case"REFERENCE":var r=e[n].JsAPIName.replace("__r","__c");i[r]=t[r]}i[e[n].APIName]=s}}}function ResourcesAndTerritoriesOptiViewer(e,t,i){function n(e,t){return e+60*(useLocationTimezone?-moment.tz.zone(t).utcOffset(utils.convertDtToMomentDt(new Date(e),t).valueOf()):utils.getUserOffset(new Date(e)))*1e3}this.id=t.Id,this.name=t.Id,this.effectiveEndDate=t.EffectiveEndDate?new Date(t.EffectiveEndDate).getTime():null,this.effectiveStartDate=t.EffectiveStartDate?new Date(t.EffectiveStartDate).getTime():null,this.latitude=t.Latitude||null,this.longitude=t.Longitude||null,this.serviceResource=e.Id,this.serviceResource__r={Id:e.Id,Name:e.Id,RelatedRecordId:e.RelatedRecordId,ResourceType:e.ResourceType},this.serviceTerritory=t.ServiceTerritoryId,this.serviceTerritory__r={Id:t.ServiceTerritoryId,OperatingHoursId:t.ServiceTerritory.OperatingHoursId,OperatingHours:{Id:t.ServiceTerritory.OperatingHoursId,TimeZone:i[t.ServiceTerritoryId]?i[t.ServiceTerritoryId].OperatingHours.TimeZone:null}},this.serviceTerritoryType=t.TerritoryType,this.operatingHours=t.OperatingHoursId||null,this.operatingHours__r=t.OperatingHoursId?{Id:t.OperatingHoursId,TimeZone:t.OperatingHours.TimeZone}:null,this.timezone=i[t.ServiceTerritoryId]?i[t.ServiceTerritoryId].OperatingHours.TimeZone:null,this.operatingHours__r&&this.operatingHours__r.TimeZone!==this.timezone&&console.warn("The Resource with STM - "+this.id+" has operating hours with different timezone!"),this.effectiveStartDate=this.effectiveStartDate?n(this.effectiveStartDate,this.timezone):null,this.effectiveEndDate=this.effectiveEndDate?n(this.effectiveEndDate,this.timezone):null,this.effectiveStartDate=__setTimeZoneOffsetToDateField(this.effectiveStartDate,!1,!0),this.effectiveEndDate=__setTimeZoneOffsetToDateField(this.effectiveEndDate,!1),this.IsCapacityBased=e.IsCapacityBased}function ServiceResourceOptiViewer(e){var t=this;this.id=e.Id,this.online=!1,this.isUndestaffOrOverStaff=!1,this.name=e.Id,this.isCapacityBased=e[fieldNames.ServiceResource.IsCapacityBased],this.description=e[fieldNames.ServiceResource.Description]||"",this.isOptimizationCapable=e[fieldNames.ServiceResource.IsOptimizationCapable],this.relatedRecord=e[fieldNames.ServiceResource.RelatedRecord],this.relatedRecord__r=e[fieldNames.ServiceResource.RelatedRecord__r],this.resourceType=e[fieldNames.ServiceResource.ResourceType],this.ganttLabel=e[fieldNames.ServiceResource.GanttLabel__c],this.lastKnownLongitude=e[fieldNames.ServiceResource.LastKnownLongitude],this.lastKnownLocationDate=e[fieldNames.ServiceResource.LastKnownLocationDate],this.lastKnownLatitude=e[fieldNames.ServiceResource.LastKnownLatitude],this.serviceCrew=e[fieldNames.ServiceResource.ServiceCrew],this.serviceCrew__r=e[fieldNames.ServiceResource.ServiceCrew__r],this.relatedRecord__r&&(this.pictureLink=this.relatedRecord__r.SmallPhotoUrl),this.onlineOffset=e[fieldNames.ServiceResource.Online_Offset__c]||orgOnlineOffset,this.pictureLink&&this.pictureLink.endsWith("profilephoto/005/T")&&(this.pictureLink=null),e[fieldNames.ServiceResource.PictureLink]&&(this.pictureLink=e[fieldNames.ServiceResource.PictureLink]),this.skills={},(this.sobject=e)[fieldNames.ServiceResource.Skills]&&e[fieldNames.ServiceResource.Skills].records.forEach(function(e){t.skills[e[fieldNames.ServiceResourceSkill.Skill]]?(Array.isArray(t.skills[e[fieldNames.ServiceResourceSkill.Skill]])||(t.skills[e[fieldNames.ServiceResourceSkill.Skill]]=[t.skills[e[fieldNames.ServiceResourceSkill.Skill]]]),t.skills[e[fieldNames.ServiceResourceSkill.Skill]].push(new ServiceResourceSkill(e))):t.skills[e[fieldNames.ServiceResourceSkill.Skill]]=new ServiceResourceSkill(e)})}function ServiceTerritoryOptiViewer(e){this.id=e.Id,this.name=e.Id,this.latitude=e[fieldNames.ServiceTerritory.Latitude],this.longitude=e[fieldNames.ServiceTerritory.Longitude],this.operatingHours=e[fieldNames.ServiceTerritory.OperatingHours],this.operatingHours__r=e[fieldNames.ServiceTerritory.OperatingHours__r],this.description=e[fieldNames.ServiceTerritory.Description],this.parentTerritory=e[fieldNames.ServiceTerritory.ParentTerritory__r]?e[fieldNames.ServiceTerritory.ParentTerritory]:void 0,this.isActive=e[fieldNames.ServiceTerritory.IsActive],e[fieldNames.ServiceTerritory.ParentTerritory__r]&&(this.parentTerritory=new ServiceTerritoryOptiViewer(e[fieldNames.ServiceTerritory.ParentTerritory__r]))}!function(){function e(i,o,a,e,n,l,x,s,c,d,u,m,p,h){var g=null,v={},f={},S={},_={},y={},b={},w=void 0,T=void 0,t=!1,L=!1,A={resourcesAndTerritories:v,resourcesByPrimariesAndRelocations:{},resourceOperatingHours:{},serviceAppointments:{},resourceAbsences:{},resourceCapacities:{},resourcesAndShifts:f,serviceCrewMembers:y,operatingHoursAndHolidays:{},start:{},finish:{},resourceToServiceCrewMembers:S,crewToServiceCrewMembers:_,currentCrewToShow:b},r=n.isRtlDirection();function I(){n.setLightBoxStatus(!1),g.$destroy()}function C(t,e){var i=void 0;switch(e){case"ServiceAppointment":i=["ArrivalWindowStartTime","ArrivalWindowEndTime","EarliestStartTime","DueDate","SchedStartTime","SchedEndTime","Gantt_Display_Date__c"];break;case"ResourceAbsence":i=["Start","End"];break;case"Shift":i=["StartTime","EndTime"];break;case"ServiceResourceCapacity":i=["EndDate","StartDate"];break;case"ServiceCrewMember":i=["StartDate","EndDate"];break;default:return}i.forEach(function(e){t[e]&&(t[e]=(e=t[e])?new Date(e).getTime():null)})}function k(e,t,i,n){if(!e||!t||!n)return i;i=D(e,t,n);return i?i.serviceTerritory__r.OperatingHours.TimeZone:null}function D(e,t,i){var n=void 0,s=!0,r=!1,o=void 0;try{for(var a,l=Object.entries(i)[Symbol.iterator]();!(s=(a=l.next()).done);s=!0){var c=_slicedToArray(a.value,2),d=(c[0],c[1]);isIntersect(R(e,d.timezone),R(t,d.timezone),d.effectiveStartDate,d.effectiveEndDate)&&(n=d)}}catch(e){r=!0,o=e}finally{try{!s&&l.return&&l.return()}finally{if(r)throw o}}return n}function R(e,t){return!e||useLocationTimezone&&!t?e:e+60*(useLocationTimezone?-moment.tz.zone(t).utcOffset(c.convertDtToMomentDt(new Date(e),t).valueOf()):c.getUserOffset(new Date(e)))*1e3}function O(t,e,i){var n=void 0;switch(e){case"ServiceAppointment":n=["ArrivalWindowStartTime","ArrivalWindowEndTime","EarliestStartTime","DueDate","SchedStartTime","SchedEndTime","Gantt_Display_Date__c"];break;case"ResourceAbsence":n=["Start","End"];break;case"Shift":n=["StartTime","EndTime"];break;case"ServiceResourceCapacity":n=["EndDate","StartDate"];break;default:return}n.forEach(function(e){t[e]&&(t[e]=R(t[e],i))})}function F(e){var t=v[e.ResourceId],e=D(e.Start,e.End,t);return e?e.serviceTerritory__r.OperatingHours.TimeZone:null}function M(e,t){e.RecordType=t?{DeveloperName:"Break"}:{DeveloperName:"Non_Availability"},O(e,"ResourceAbsence",F(e)),A.resourceAbsences[e.Id]=new ResourceAbsence(e)}function P(r){s.callRemoteAction(RemoteActions.LoadInputDataToOptimizationViewer,r).then(function(e){var t,n,i,s;g.Errors=[],w=r,T=e&&e.id,e&&e.Territories?(A={resourcesAndTerritories:v,resourcesByPrimariesAndRelocations:{},resourceOperatingHours:{},serviceAppointments:{},resourceAbsences:{},resourceCapacities:{},resourcesAndShifts:f,serviceCrewMembers:y,operatingHoursAndHolidays:{},start:{},finish:{},resourceToServiceCrewMembers:S,crewToServiceCrewMembers:_,currentCrewToShow:b},t=d.get("monthlyViewHelperService"),n={},e.Territories.forEach(function(e){n[e.Id]=e}),e.Resources&&e.Resources.forEach(function(i){v[i.Id]=v[i.Id]||{},i.ServiceTerritories.records.forEach(function(e){var t=new ResourcesAndTerritoriesOptiViewer(i,e,n);"S"!==(v[i.Id][e.Id]=t).serviceTerritoryType&&(A.resourcesByPrimariesAndRelocations[i.Id]=A.resourcesByPrimariesAndRelocations[i.Id]||{},A.resourcesByPrimariesAndRelocations[i.Id][e.Id]=t)}),i.ShiftServiceResources&&i.ShiftServiceResources.records.forEach(function(e){C(e,"Shift");O(e,"Shift",n[e.ServiceTerritoryId]||k(e.StartTime,e.EndTime,null,v[e.ServiceResourceId]));var t=new Shift(e);f[e.ServiceResourceId]||(f[e.ServiceResourceId]={}),f[e.ServiceResourceId][c.formatDayToString(t.startTime)]||(f[e.ServiceResourceId][c.formatDayToString(t.startTime)]=[]),f[e.ServiceResourceId][c.formatDayToString(t.startTime)].push(t)}),i.ServiceCrewMembers&&i.ServiceCrewMembers.records.forEach(function(e){if(C(e,"ServiceCrewMember"),y[e.Id]=new ServiceCrewMember(e),S[y[e.Id].serviceResource]||(S[y[e.Id].serviceResource]={}),_[y[e.Id].serviceCrew]||(_[y[e.Id].serviceCrew]={}),_[y[e.Id].serviceCrew][e.Id]=y[e.Id],S[y[e.Id].serviceResource][e.Id]=y[e.Id],o.crewViewActive){var t,i;for(i in b=o.currentCrewToShow)if(b[i].serviceCrew){t=b[i].serviceCrew;break}e.ServiceCrewId===t&&(b[e.ServiceResourceId]||(b[e.ServiceResourceId]=a.getResources()[e.ServiceResourceId]),void 0===b[e.ServiceResourceId].members&&(b[e.ServiceResourceId].members={}),b[e.ServiceResourceId].members[e.Id]=y[e.Id])}})}),e.Services&&e.Services.forEach(function(e){var t,i,n;C(e=e,"ServiceAppointment"),e.AppointmentNumber=e.Id,(n=!!e.ServiceResources&&e.ServiceResources.records)?(t=v[n[0].ServiceResourceId],i=!1,1<n.length&&n.forEach(function(e){"C"===e.ServiceResource.ResourceType&&(i=!0,t=v[e.ServiceResourceId])}),e.IsAssignToCrew=i,e.ResourceContractor=t&&t[Object.keys(t)[0]].IsCapacityBased,O(e,"ServiceAppointment",k(e.SchedStartTime,e.SchedEndTime,e.ServiceTerritory?e.ServiceTerritory.OperatingHours.TimeZone:null,t))):e.ServiceTerritory?O(e,"ServiceAppointment",e.ServiceTerritory.OperatingHours.TimeZone):O(e,"ServiceAppointment",null),A.serviceAppointments[e.Id]=new GanttServiceOptiViewer(e)}),e.Breaks&&e.Breaks.forEach(function(e){C(e,"ResourceAbsence"),M(e,!0)}),e.NonAvailabilities&&e.NonAvailabilities.forEach(function(e){C(e,"ResourceAbsence"),M(e,!1)}),e.Capacities&&e.Capacities.forEach(function(e){C(e,"ServiceResourceCapacity"),A.resourceCapacities[e.Id]=new ResourceCapacity(e)}),i=new Date(e.start),s=new Date(e.finish),A.start=new Date(i.getFullYear(),i.getMonth(),i.getDate()-1,0,0),A.finish=new Date(s.getFullYear(),s.getMonth(),s.getDate()+1,23,59),l.updateObjectsForOptimizationViewer(A),a.getResourceAndTerritoriesFromJson(e,function(){t.reset(),a.reset(),scheduler._events={},scheduler.deleteMarkedTimespan(),u.reset(),m.reset(),p.reset(),h.reset()})):g.Errors.push("no data!")}).then(function(){0<g.Errors.length||o.$broadcast("gotNewTimePhasedSTMsAndShifts",A)}).then(function(){0<g.Errors.length||o.$broadcast("gotNewTimePhasedObjects",A)}).then(function(){var e;0<g.Errors.length||(e=A.start,e=new Date(e.getFullYear(),e.getMonth(),e.getDate()+1,0,0),scheduler.setCurrentView(e),L=!(t=!0))}).then(function(){0==g.Errors.length&&I()})}return{open:function(){(g=o.$new(!0)).$on("keypress",function(e,t){27==t.which&&g.$evalAsync(g.closeLightbox)}),g.loadOptimizationRequestInput=P,g.selectedOptimizationRequest="",g.currentResults=[];var e=angular.element('\n            <div class="LightboxBlackContainer">\n                <div class="LightboxContainer" id="BulkActionsLightbox" ng-class="{\'rtlDirection\': '+r+' }" >\n\n                    <div class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                        <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox" id="CloseDispatchLightbox" fsl-key-press tabindex="0">\n                            <use xlink:href="'+lsdIcons.close+'"></use>\n                        </svg>\n                        <h1 class="light-box-header">Load New Optimization Request</h1>\n                    </div>\n\n                    <div>\n\n                        <div class="lightboxContentContainer">\n\n                            <p>Select Optimization Request to load</p>\n\n                            \n                            <div>\n                                \x3c!-- <label for="searchOptReqs">Search for Optimization Request to view </label> --\x3e\n                                <input class="OptiViewerSearch" type="text" placeholder="Search Optimiztion Request..." \n                                    ng-model="selectedOptimizationRequest"\n                                    ng-model-options="{debounce: 300}"\n                                    ng-change="ShowAllRelevantOptimizationRequests(selectedOptimizationRequest)"\n                                    name="searchOptReqs" \n                                    id="searchOptReqs" \n                                    ng-focus = "SearchBoxInFocus = true"\n                                    ng-blur = "loseFocusWithDelay()"/> \n                            </div>\n                            <div>\n                                <div class="OptiViewerListDiv" style="box-shadow: 0 2px 3px 0 rgb(0 0 0 / 16%);" ng-if="currentResults.length != 0 && SearchBoxInFocus">\n                                    <ul class="list-unstyled-optiViewer" role="presentation">\n                                        <li role="presentation" class="optiviewer-listbox__item" ng-repeat="optimization in currentResults" ng-click="updateSearchText(optimization.Name)">\n                                            <div onmouseover="this.style.backgroundColor = \'#f3f3f3\'" onmouseout="this.style.backgroundColor = \'#ffffff\'">\n                                                \n                                                    <svg class="slds-icon-optiViewer">\n                                                        <use class="slds-icon-use-optiViewer" xlink:href="'+lsdIcons.optimizationRequests+'"></use>\n                                                    </svg>\n                                            \n                                                <span>\n                                                        {{optimization.Name}}\n                                                        </br> \n                                                        {{optimization.Status__c || optimization.FSL__Status__c}} • {{optimization.Type__c || optimization.FSL__Type__c}}\n                                                </span>\n                                            </div>\n                                        </li>\n                                    </ul>\n                                </div>\n                                <div ng-if="Errors.length > 0 && (currentResults.length == 0 || !SearchBoxInFocus)">\n                                    <p class="optiViewerErrorMessage">This Optimization Request has no saved data. </br>\n                                        In order to save optimization data please login to the org via License Management App and open the Custom Settings --\x3e Field Service Optimization Settings (Manage button) --\x3e Edit button next to the relevant Optimization type --\x3e tick the checkbox "Save Optimization Data After OAAS Finish".</br>\n                                        Now when your optimization finishes, its data would be saved as an attachment on the related Optimization Data Object. </br>\n                                        <b>If this is a customer\'s org remember to turn this setting back off when you done working.</b> \n\n                                    </p>\n                                </div>\n                            </div>\n                        </div>\n\n                        <div class="lightboxControllers">\n                            <button class="lightboxSaveButton" ng-click="loadOptimizationRequestInput(selectedOptimizationRequest)">Load</button>\n                        </div>\n\n                    </div>\n                </div>\n\n            </div>\n            '),t=(e.find("#BulkActionsLightbox").draggable({containment:"document",handle:"#UnschduleLightboxHeader"}),angular.element("body").append(e),g.closeLightbox=I,g.$on("$destroy",function(){return e.remove()}),i(e)(g),e.show(),n.setLightBoxStatus(),g.ShowAllRelevantOptimizationRequests=function(e){s.callRemoteAction(RemoteActions.ShowAllRelevantOptimizationRequests,e).then(function(e){e&&(g.currentResults=e,g.Errors=[])})},g.ShowAllRelevantOptimizationRequests("last 20"),g.updateSearchText=function(e){g.selectedOptimizationRequest=e,g.currentResults=[]},d.get("$timeout"));g.loseFocusWithDelay=function(){t(function(){g.SearchBoxInFocus=!1},200)},g.SearchBoxInFocus=!1,g.Errors=[]},isOptimizationLoaded:function(){return t},isShowingOutputJson:function(){return L},loadOptimizationResponseOutput:function(){s.callRemoteAction(RemoteActions.LoadOutputDataToOptimizationViewer,w).then(function(e){var t;e&&0!=e.length?(t=1,e.forEach(function(e){e.Services&&e.Services.forEach(function(e){var t=A.serviceAppointments[e.Id].ServiceTerritory?A.serviceAppointments[e.Id].ServiceTerritory.OperatingHours.TimeZone:null;A.serviceAppointments[e.Id].schedEndTime=R(e.SchedEndTime,t),A.serviceAppointments[e.Id].schedStartTime=R(e.SchedStartTime,t),A.serviceAppointments[e.Id].setSchedulerPropertiesAfterOutputJson("service")}),e.AssignedResourcesToCreate&&e.AssignedResourcesToCreate.forEach(function(e){A.serviceAppointments[e.ServiceAppointmentId].resource=e.ServiceResourceId,A.serviceAppointments[e.ServiceAppointmentId].resourceName=e.ServiceResourceId,A.serviceAppointments[e.ServiceAppointmentId].assignedResource="Created By Optimizer",A.serviceAppointments[e.ServiceAppointmentId].travelTimeFrom=e.EstimatedTravelTimeFrom__c||e.FSL__EstimatedTravelTimeFrom__c,A.serviceAppointments[e.ServiceAppointmentId].travelTimeTo=e.EstimatedTravelTime,A.serviceAppointments[e.ServiceAppointmentId].status=serviceStatuses.SCHEDULED,A.serviceAppointments[e.ServiceAppointmentId].statusCategory="Scheduled",A.serviceAppointments[e.ServiceAppointmentId].setSchedulerPropertiesAfterOutputJson("assignedResource")}),e.AssignedResourcesToUpdate&&e.AssignedResourcesToUpdate.forEach(function(e){A.serviceAppointments[e.ServiceAppointmentId].resource=e.ServiceResourceId,A.serviceAppointments[e.ServiceAppointmentId].resourceName=e.ServiceResourceId,A.serviceAppointments[e.ServiceAppointmentId].assignedResource="Updated By Optimizer",A.serviceAppointments[e.ServiceAppointmentId].travelTimeFrom=e.EstimatedTravelTimeFrom__c||e.FSL__EstimatedTravelTimeFrom__c,A.serviceAppointments[e.ServiceAppointmentId].travelTimeTo=e.EstimatedTravelTime,A.serviceAppointments[e.ServiceAppointmentId].setSchedulerPropertiesAfterOutputJson("assignedResource")}),e.AssignedResourcesToDelete&&e.AssignedResourcesToDelete.forEach(function(e){A.serviceAppointments[e.ServiceAppointmentId].resource=null,A.serviceAppointments[e.ServiceAppointmentId].schedEndTime=null,A.serviceAppointments[e.ServiceAppointmentId].schedStartTime=null,A.serviceAppointments[e.ServiceAppointmentId].resourceName=null,A.serviceAppointments[e.ServiceAppointmentId].assignedResource="Deleted By Optimizer",A.serviceAppointments[e.ServiceAppointmentId].travelTimeFrom=null,A.serviceAppointments[e.ServiceAppointmentId].travelTimeTo=null,A.serviceAppointments[e.ServiceAppointmentId].status=serviceStatuses.NONE,A.serviceAppointments[e.ServiceAppointmentId].statusCategory="None",A.serviceAppointments[e.ServiceAppointmentId].setSchedulerPropertiesAfterOutputJson("assignedResource")}),e.Absences&&e.Absences.forEach(function(e){O(e,"ResourceAbsence",F(e)),A.resourceAbsences[e.Id].start=e.Start,A.resourceAbsences[e.Id].end=e.End,A.resourceAbsences[e.Id].travelTo=e.EstTravelTime__c?60*e.EstTravelTime__c:0,A.resourceAbsences[e.Id].travelFrom=e.EstTravelTimeFrom__c?60*e.EstTravelTimeFrom__c:0,A.resourceAbsences[e.Id].setSchedulerProperties()}),e.BreaksToDelete&&e.BreaksToDelete.forEach(function(e){scheduler.deleteEvent(A.resourceAbsences[e.Id].id),delete A.resourceAbsences[e.Id]}),e.BreaksToCreate&&e.BreaksToCreate.forEach(function(e){e.Id=t,M(e,!0),t++})}),l.updateObjectsForOptimizationViewer(A),o.$broadcast("gotNewTimePhasedObjects",A),e=A.start,e=new Date(e.getFullYear(),e.getMonth(),e.getDate()+1,0,0),scheduler.setCurrentView(e),L=!0):c.addNotification("No Output Data!","There is no data for the optimization response. </br> It might be that this optimization request has failed.",function(){c.openSObjectLink(T)})})},loadOptimizationRequestInput:P,i_OptimizationRequestName:function(){return w}}}e.$inject=["$compile","$rootScope","ResourcesAndTerritoriesService","userSettingsManager","StateService","TimePhasedDataService","SERVICE_STATUS","sfdcService","utils","$injector","calendarsService","ResourceCrewsService","ResourceCapacitiesService","HolidayService"],angular.module("serviceExpert").factory("LoadOptiViewerDataService",e)}(),GanttServiceOptiViewer.prototype.setSchedulerProperties=function(){var e,t={schedStartTime:"start",schedEndTime:"finish",dueDate:"dueDate",earliestStartTime:"earlyStart",arrivalWindowStartTime:"appStart",arrivalWindowEndTime:"appEnd",actualStartTime:"actualStartTime",actualEndTime:"actualEndTime",ganttDisplay:"ganttDisplay"};for(e in t)this[t[e]]=__setTimeZoneOffsetToDateField(this[e]);this.type="service",this.travelTo=this.travelTimeTo?60*parseInt(this.travelTimeTo):0,this.travelFrom=this.travelTimeFrom?60*parseInt(this.travelTimeFrom):0,this.estDuration=this.estDuration?parseFloat(this.estDuration):null,this.text=this.ganttLabel?this.ganttLabel.encodeHTML():this.name},GanttServiceOptiViewer.prototype.setSchedulerPropertiesAfterOutputJson=function(e){if("service"===e){var t,i={schedStartTime:"start",schedEndTime:"finish"};for(t in i)this[i[t]]=__setTimeZoneOffsetToDateField(this[t])}else"assignedResource"===e&&(this.travelTo=this.travelTimeTo?60*parseInt(this.travelTimeTo):0,this.travelFrom=this.travelTimeFrom?60*parseInt(this.travelTimeFrom):0)},GanttServiceOptiViewer.prototype.setGanttResource=function(e,t){if(this.isScheduled()){var i,n=e[this.resource],s=[];for(i in this.resourceId=null,this.start_date=__setTimeZoneOffsetToDateField(this.schedStartTime),this.end_date=__setTimeZoneOffsetToDateField(this.schedEndTime),n){var r=n[i];"R"===r.serviceTerritoryType&&(isIntersectIncludeLimits(r.effectiveStartDate,r.effectiveEndDate,this.start_date,this.end_date)||!r.effectiveEndDate&&r.effectiveStartDate<this.end_date)&&s.push(r.serviceTerritory)}if(0===s.length)for(var o in n){o=n[o];isIntersectIncludeLimits(o.effectiveStartDate,o.effectiveEndDate,this.start_date,this.start_date)&&s.push(o.serviceTerritory)}else if(showSecondarySTMs)for(var a in n){a=n[a];"S"===a.serviceTerritoryType&&isIntersectIncludeLimits(a.effectiveStartDate,a.effectiveEndDate,this.start_date,this.end_date)&&s.push(a.serviceTerritory)}this.resourceId=t(this.resource,s),this.isScheduled()&&this.updateDatesBasedOnTravel()}},GanttServiceOptiViewer.prototype.updateDatesBasedOnTravel=function(){this.resourceId&&(this.travelFrom&&(this.travelFrom<=maxTravelTimeInSeconds||(this.hiddenTravelFrom={hiddenMinutes:this.end_date.getMinutes()+Math.floor(this.travelFrom/60),hiddenTravel:this.travelFrom},this.travelFrom=maxTravelTimeInSeconds),this.end_date.setMinutes(this.end_date.getMinutes()+Math.floor(this.travelFrom/60))),this.travelTo&&(this.travelTo<=maxTravelTimeInSeconds||(this.hiddenTravelTo={hiddenMinutes:this.start_date.getMinutes()-Math.floor(this.travelTo/60),hiddenTravel:this.travelTo},this.travelTo=maxTravelTimeInSeconds),this.start_date.setMinutes(this.start_date.getMinutes()-Math.floor(this.travelTo/60))))},GanttServiceOptiViewer.prototype.isScheduled=function(){return this.resource&&this.schedEndTime&&this.schedStartTime},GanttServiceOptiViewer.prototype.getGanttResource=function(e){return e&&getGanttResourceWithSecondaryStms(this),this.resourceId&&this.resourceId.substr(0,18)},GanttServiceOptiViewer.prototype.getGanttTerritory=function(){return this.resourceId&&this.resourceId.substr(19,37)},GanttServiceOptiViewer.prototype.isChanged=function(e){return this.AssignedResourceLastModifiedDate!=e.AssignedResourceLastModifiedDate||this.ServiceAppointmentLastModifiedDate!=e.ServiceAppointmentLastModifiedDate},GanttServiceOptiViewer.prototype.isGotNewSTM=function(e){return""===this.resourceId&&e.resource},GanttServiceOptiViewer.prototype.isChainChanged=function(e){return this.isServiceInChain!=e.isServiceInChain||this.relatedService1!=e.relatedService1||this.relatedService2!=e.relatedService2},GanttServiceOptiViewer.prototype.minPriority=1e6,GanttServiceOptiViewer.copy=function(e){var t=new GanttServiceOptiViewer(null,!0);return angular.merge(t,e),t},GanttServiceOptiViewer.prototype.calculateMdtTimes=function(e){try{this.mdtTimes=JSON.parse(e);var n=1e3*(new Date).getTimezoneOffset()*60,s={travel:[],working:[]};this.mdtTimes.forEach(function(e){var t=moment.tz(e.Start,userTimeZone),i=moment.tz(e.Finish,userTimeZone),t=new Date(t.valueOf()+60*t._offset*1e3+n),i=new Date(i.valueOf()+60*i._offset*1e3+n);e.Start=t,e.Finish=i,"OperationalSlot"===e.Type?s.working.push(e):"Travel"===e.Type&&s.travel.push(e)}),this.mdtTimes=s}catch(e){this.mdtTimes={travel:[],working:[]}}};